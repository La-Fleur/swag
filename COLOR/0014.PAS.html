<html>
<head><title> "Palette Control #3" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COLOR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0014.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Unit </b></font>Palette<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Type
  </b></font>PalType     <font color="#000080">=  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">768</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>FadePal     <font color="#000080">:  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">768</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Real<font color="#000080">;
  </font>Fadeend<font color="#000080">,
  </font>FadeStep<font color="#000080">,
  </font>FadeCount<font color="#000080">,
  </font>FadeStart   <font color="#000080">:  </font>Byte<font color="#000080">;
  </font>FadeToPal   <font color="#000080">:  ^</font>PalType<font color="#000080">;
  </font>DoneFade    <font color="#000080">:  </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>GetPCXPalettePas <font color="#000080">(</font>PCXBuf<font color="#000080">,</font>P<font color="#000080">:</font>Pointer<font color="#000080">;</font>PalOffset<font color="#000080">:</font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>GetPCXPaletteAsm <font color="#000080">(</font>PCXBuf<font color="#000080">,</font>P<font color="#000080">:</font>Pointer<font color="#000080">;</font>PalOffset<font color="#000080">:</font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>WritePalettePas  <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>WritePaletteAsm  <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>ReadPalettePas   <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>ReadPaletteAsm   <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>SetupFade        <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">;</font>Step<font color="#000080">:</font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>FadePalette<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>Oreo             <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Integer<font color="#000080">);

</font><font color="#FF0000"><b>Implementation

Procedure </b></font>CLI<font color="#000080">; </font><font color="#FF0000"><b>Inline </b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>STI<font color="#000080">; </font><font color="#FF0000"><b>Inline </b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>SetupFade <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">;</font>Step<font color="#000080">:</font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>CurPal           <font color="#000080">:  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>ToPal            <font color="#000080">:  ^</font>PalType<font color="#000080">;
  </font>I<font color="#000080">,</font>PalOfs<font color="#000080">,
  </font>NumColors        <font color="#000080">:  </font>Word<font color="#000080">;
  </font>RealStep<font color="#000080">,
  </font>RealToColor<font color="#000080">,
  </font>RealCurColor     <font color="#000080">:  </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ToPal <font color="#000080">:= </font>Ptr <font color="#000080">(</font>Seg<font color="#000080">(</font>P<font color="#000080">^),</font>Ofs<font color="#000080">(</font>P<font color="#000080">^));
  </font>ReadPaletteAsm <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,@</font>CurPal<font color="#000080">);
  </font>PalOfs <font color="#000080">:= </font>Start <font color="#000080">* </font><font color="#800000">3</font><font color="#000080">;
  </font>NumColors <font color="#000080">:= (</font>Finish <font color="#000080">- </font>Start <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">) * </font><font color="#800000">3</font><font color="#000080">;

  </font>RealStep <font color="#000080">:= </font>Step<font color="#000080">;

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumColors<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
    </b></font>RealCurColor <font color="#000080">:= </font>CurPal <font color="#000080">[</font>PalOfs<font color="#000080">+</font>I<font color="#000080">];
    </font>RealToColor  <font color="#000080">:=  </font>ToPal<font color="#000080">^[</font>PalOfs<font color="#000080">+</font>I<font color="#000080">];
    </font>FadePal <font color="#000080">[</font>PalOfs<font color="#000080">+</font>I<font color="#000080">] := (</font>RealCurColor <font color="#000080">- </font>RealToColor<font color="#000080">) / </font>RealStep<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>FadeStep  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>FadeCount <font color="#000080">:= </font>Step<font color="#000080">;
  </font>FadeStart <font color="#000080">:= </font>Start<font color="#000080">;
  </font>Fadeend   <font color="#000080">:= </font>Finish<font color="#000080">;
  </font>FadeToPal <font color="#000080">:= </font>P<font color="#000080">;
  </font>DoneFade  <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FadePalette<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">,
  </font>PalOfs<font color="#000080">,
  </font>NumColors   <font color="#000080">:  </font>Word<font color="#000080">;
  </font>CurPal      <font color="#000080">:  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>Fact<font color="#000080">,
  </font>RealToColor <font color="#000080">:  </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Inc <font color="#000080">(</font>FadeStep<font color="#000080">);
  </font>Fact <font color="#000080">:= </font>FadeCount <font color="#000080">- </font>FadeStep<font color="#000080">;
  </font>NumColors <font color="#000080">:= (</font>Fadeend <font color="#000080">- </font>FadeStart <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">) * </font><font color="#800000">3</font><font color="#000080">;
  </font>ReadPaletteAsm <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,@</font>CurPal<font color="#000080">);
  </font>PalOfs <font color="#000080">:= </font>FadeStart <font color="#000080">* </font><font color="#800000">3</font><font color="#000080">;

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumColors <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
    </b></font>RealToColor <font color="#000080">:= </font>FadeToPal<font color="#000080">^[</font>PalOfs<font color="#000080">+</font>I<font color="#000080">];
    </font>CurPal<font color="#000080">[</font>PalOfs<font color="#000080">+</font>I<font color="#000080">] := </font>Round <font color="#000080">(</font>RealToColor <font color="#000080">+ </font>Fact <font color="#000080">* </font>FadePal<font color="#000080">[</font>PalOfs<font color="#000080">+</font>I<font color="#000080">]);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>WritePaletteAsm <font color="#000080">(</font>FadeStart<font color="#000080">,</font>Fadeend<font color="#000080">,@</font>CurPal<font color="#000080">);
  </font>DoneFade <font color="#000080">:= </font>FadeStep <font color="#000080">= </font>FadeCount<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Oreo <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">,</font>PalOfs    <font color="#000080">:  </font>Word<font color="#000080">;
  </font>CurPal      <font color="#000080">:  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>Red<font color="#000080">,
  </font>Blue<font color="#000080">,
  </font>Green       <font color="#000080">:  </font>Real<font color="#000080">;
  </font>Gray        <font color="#000080">:  </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ReadPaletteAsm <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,@</font>CurPal<font color="#000080">);

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font>Start <font color="#FF0000"><b>to </b></font>Finish <font color="#FF0000"><b>do begin
    </b></font>PalOfs <font color="#000080">:= </font>I <font color="#000080">* </font><font color="#800000">3</font><font color="#000080">;
    </font>Red   <font color="#000080">:= </font>CurPal<font color="#000080">[</font>PalOfs <font color="#000080">+ </font><font color="#800000">0</font><font color="#000080">];
    </font>Green <font color="#000080">:= </font>CurPal<font color="#000080">[</font>PalOfs <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">];
    </font>Blue  <font color="#000080">:= </font>CurPal<font color="#000080">[</font>PalOfs <font color="#000080">+ </font><font color="#800000">2</font><font color="#000080">];

    </font>Gray <font color="#000080">:= </font>Round <font color="#000080">((</font><font color="#800000">0.30 </font><font color="#000080">* </font>Red<font color="#000080">) + (</font><font color="#800000">0.59 </font><font color="#000080">* </font>Green<font color="#000080">) + (</font><font color="#800000">0.11 </font><font color="#000080">* </font>Blue<font color="#000080">));

    </font>CurPal<font color="#000080">[</font>PalOfs <font color="#000080">+ </font><font color="#800000">0</font><font color="#000080">] := </font>Gray<font color="#000080">;
    </font>CurPal<font color="#000080">[</font>PalOfs <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">] := </font>Gray<font color="#000080">;
    </font>CurPal<font color="#000080">[</font>PalOfs <font color="#000080">+ </font><font color="#800000">2</font><font color="#000080">] := </font>Gray<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>WritePaletteAsm <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">,@</font>CurPal<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>GetPCXPalettePas <font color="#000080">(</font>PCXBuf<font color="#000080">,</font>P<font color="#000080">:</font>Pointer<font color="#000080">;</font>PalOffset<font color="#000080">:</font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>I      <font color="#000080">:  </font>Word<font color="#000080">;
  </font>InByte <font color="#000080">:  </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>PCXBuf <font color="#000080">:= </font>Ptr <font color="#000080">(</font>Seg<font color="#000080">(</font>PCXBuf<font color="#000080">^),</font>Ofs<font color="#000080">(</font>PCXBuf<font color="#000080">^)+</font>PalOffset<font color="#000080">);
  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">767 </font><font color="#FF0000"><b>do begin
    </b></font>InByte <font color="#000080">:= </font>Mem <font color="#000080">[</font>Seg<font color="#000080">(</font>PCXBuf<font color="#000080">^):</font>Ofs<font color="#000080">(</font>PCXBuf<font color="#000080">^)+</font>I<font color="#000080">];
    </font>InByte <font color="#000080">:= </font>InByte <font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
    </font>Mem <font color="#000080">[</font>Seg<font color="#000080">(</font>P<font color="#000080">^):</font>Ofs<font color="#000080">(</font>P<font color="#000080">^)+</font>I<font color="#000080">] := </font>InByte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>WritePalettePas <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">,
  </font>NumColors   <font color="#000080">:  </font>Word<font color="#000080">;
  </font>InByte      <font color="#000080">:  </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>P <font color="#000080">:= </font>Ptr <font color="#000080">(</font>Seg<font color="#000080">(</font>P<font color="#000080">^),</font>Ofs<font color="#000080">(</font>P<font color="#000080">^)+</font>Start<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">);
  </font>NumColors <font color="#000080">:= (</font>Finish <font color="#000080">- </font>Start <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">) * </font><font color="#800000">3</font><font color="#000080">;

  </font>CLI<font color="#000080">;

  </font>Port <font color="#000080">[</font><font color="#800000">$03C8</font><font color="#000080">] := </font>Start<font color="#000080">;

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumColors <font color="#FF0000"><b>do begin
    </b></font>InByte <font color="#000080">:= </font>Mem <font color="#000080">[</font>Seg<font color="#000080">(</font>P<font color="#000080">^):</font>Ofs<font color="#000080">(</font>P<font color="#000080">^)+</font>I<font color="#000080">];
    </font>Port <font color="#000080">[</font><font color="#800000">$03C9</font><font color="#000080">] := </font>InByte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>STI<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ReadPalettePas <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">,
  </font>NumColors   <font color="#000080">:  </font>Word<font color="#000080">;
  </font>InByte      <font color="#000080">:  </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>P <font color="#000080">:= </font>Ptr <font color="#000080">(</font>Seg<font color="#000080">(</font>P<font color="#000080">^),</font>Ofs<font color="#000080">(</font>P<font color="#000080">^)+</font>Start<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">);
  </font>NumColors <font color="#000080">:= (</font>Finish <font color="#000080">- </font>Start <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">) * </font><font color="#800000">3</font><font color="#000080">;

  </font>CLI<font color="#000080">;

  </font>Port <font color="#000080">[</font><font color="#800000">$03C7</font><font color="#000080">] := </font>Start<font color="#000080">;

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumColors <font color="#FF0000"><b>do begin
    </b></font>InByte <font color="#000080">:= </font>Port <font color="#000080">[</font><font color="#800000">$03C9</font><font color="#000080">];
    </font>Mem <font color="#000080">[</font>Seg<font color="#000080">(</font>P<font color="#000080">^):</font>Ofs<font color="#000080">(</font>P<font color="#000080">^)+</font>I<font color="#000080">] := </font>InByte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>STI<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>GetPCXPaletteAsm <font color="#000080">(</font>PCXBuf<font color="#000080">,</font>P<font color="#000080">:</font>Pointer<font color="#000080">;</font>PalOffset<font color="#000080">:</font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push ds

    lds  si,PCXBuf
    mov  ax,PalOffset
    add  si,ax

    les  di,P

    mov  cx,768
  @@1:
    lodsb
    shr  al,1
    shr  al,1
    stosb
    loop @@1

    pop  ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>WritePaletteAsm <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push ds

    lds  si,P

    cld

    xor  bh,bh               </font><font color="#008000"><i>{ P^ points to the beginning of the palette }
    </i></font><font color="#FF00FF">mov  bl,Start            </font><font color="#008000"><i>{ data.  Since we can specify the Start and }
    </i></font><font color="#FF00FF">xor  ax,ax               </font><font color="#008000"><i>{ Finish color nums, we have to point our }
    </i></font><font color="#FF00FF">mov  al,Start            </font><font color="#008000"><i>{ Pointer to the Start color.  There are 3 }
    </i></font><font color="#FF00FF">shl  ax,1                </font><font color="#008000"><i>{ Bytes per color, so the Start color is: }
    </i></font><font color="#FF00FF">add  ax,bx               </font><font color="#008000"><i>{   Palette Ofs = @P + Start * 3 }
    </i></font><font color="#FF00FF">add  si,ax               </font><font color="#008000"><i>{ ds:si -&gt; offset in color data }

    </i></font><font color="#FF00FF">xor  ch,ch               </font><font color="#008000"><i>{ Next, we have to determine how many colors}
    </i></font><font color="#FF00FF">mov  cl,Finish           </font><font color="#008000"><i>{ we will be updating.  This simply is: }
    </i></font><font color="#FF00FF">sub  cl,Start            </font><font color="#008000"><i>{    NumColors = Finish - Start + 1 }
    </i></font><font color="#FF00FF">inc  cx

</font><font color="#008000"><i>(*
    push      es
    push      dx
    push      ax

    xor       ax,ax                    { get address of status register }
    mov       es,ax                    {   from segment 0 }
    mov       dx,3BAh                  { assume monochrome addressing }
    test      Byte ptr es:[487h],2     { is mono display attached? }
    jnz       @@11                     { yes, address is OK }
    mov       dx,3DAh                  { no, must set color addressing }
  @@11:
    in        al,dx                    { read in status }
    jmp       @@21
  @@21:
    test      al,08h                   { is retrace on&gt; (if ON, bit = 1) }
    jz        @@13                     { no, go wait For start }
  @@12:
                                       { yes, wait For it to go off }
    in        al,dx
    jmp       @@22
  @@22:
    test      al,08h                   { is retrace off? }
    jnz       @@12                     { no, keep waiting }
  @@13:
    in        al,dx
    jmp       @@23
  @@23:
    test      al,08h                   { is retrace on? }
    jz        @@13                     { no, keep on waiting }

    pop       ax
    pop       dx
    pop       es               *)

    </i></font><font color="#FF00FF">mov  al,Start            </font><font color="#008000"><i>{ We are going to bypass the BIOS routines }
    </i></font><font color="#FF00FF">mov  dx,03C8h            </font><font color="#008000"><i>{ to update the palette Registers.  For the }
    </i></font><font color="#FF00FF">out  dx,al               </font><font color="#008000"><i>{ smoothest fades, there is no substitute }

    </i></font><font color="#FF00FF">cli                      </font><font color="#008000"><i>{ turn off interrupts temporarily }
    </i></font><font color="#FF00FF">inc  dx

  @@1:
    lodsb                    </font><font color="#008000"><i>{ Get the red color Byte }
    </i></font><font color="#FF00FF">jmp  @@2                 </font><font color="#008000"><i>{ Delay For a few clock cycles }
  </i></font><font color="#FF00FF">@@2:
    out  dx,al               </font><font color="#008000"><i>{ Write the red register directly }

    </i></font><font color="#FF00FF">lodsb                    </font><font color="#008000"><i>{ Get the green color Byte }
    </i></font><font color="#FF00FF">jmp  @@3                 </font><font color="#008000"><i>{ Delay For a few clock cycles }
  </i></font><font color="#FF00FF">@@3:
    out  dx,al               </font><font color="#008000"><i>{ Write the green register directly }

    </i></font><font color="#FF00FF">lodsb                    </font><font color="#008000"><i>{ Get the blue color Byte }
    </i></font><font color="#FF00FF">jmp  @@4                 </font><font color="#008000"><i>{ Delay For a few clock cycles }
  </i></font><font color="#FF00FF">@@4:
    out  dx,al               </font><font color="#008000"><i>{ Write the blue register directly }

    </i></font><font color="#FF00FF">loop @@1

    sti                      </font><font color="#008000"><i>{ turn interrupts back on }
    </i></font><font color="#FF00FF">pop  ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ReadPaletteAsm <font color="#000080">(</font>Start<font color="#000080">,</font>Finish<font color="#000080">:</font>Byte<font color="#000080">;</font>P<font color="#000080">:</font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">les  di,P

    cld

    xor  bh,bh               </font><font color="#008000"><i>{ P^ points to the beginning of the palette }
    </i></font><font color="#FF00FF">mov  bl,Start            </font><font color="#008000"><i>{ buffer.  We have to calculate where in the}
    </i></font><font color="#FF00FF">xor  ax,ax               </font><font color="#008000"><i>{ buffer we need to start at.  Because each  }
    </i></font><font color="#FF00FF">mov  al,Start            </font><font color="#008000"><i>{ color has three Bytes associated With it }
    </i></font><font color="#FF00FF">shl  ax,1                </font><font color="#008000"><i>{ the starting ofs is:            }
    </i></font><font color="#FF00FF">add  ax,bx               </font><font color="#008000"><i>{   Palette Ofs = @P + Start * 3  }
    </i></font><font color="#FF00FF">add  si,ax               </font><font color="#008000"><i>{ es:di -&gt; offset in color data   }

    </i></font><font color="#FF00FF">xor  ch,ch               </font><font color="#008000"><i>{ Next, we have to determine how many   colors}
    </i></font><font color="#FF00FF">mov  cl,Finish           </font><font color="#008000"><i>{ we will be reading.  This simply is:  }
    </i></font><font color="#FF00FF">sub  cl,Start            </font><font color="#008000"><i>{    NumColors = Finish - Start + 1     }
    </i></font><font color="#FF00FF">inc  cx

    mov  al,Start            </font><font color="#008000"><i>{ We are going to bypass the BIOS routines }
    </i></font><font color="#FF00FF">mov  dx,03C7h            </font><font color="#008000"><i>{ to read in from the palette Registers.   }
    </i></font><font color="#FF00FF">out  dx,al               </font><font color="#008000"><i>{ This is the fastest method to do this.   }
    </i></font><font color="#FF00FF">mov  dx,03C9h

    cli                      </font><font color="#008000"><i>{ turn off interrupts temporarily          }

  </i></font><font color="#FF00FF">@@1:
    in   al,dx               </font><font color="#008000"><i>{ Read in the red color Byte               }
    </i></font><font color="#FF00FF">jmp  @@2                 </font><font color="#008000"><i>{ Delay For a few clock cycles             }
  </i></font><font color="#FF00FF">@@2:
    stosb                    </font><font color="#008000"><i>{ Store the Byte in the buffer             }

    </i></font><font color="#FF00FF">in   al,dx               </font><font color="#008000"><i>{ Read in the green color Byte             }
    </i></font><font color="#FF00FF">jmp  @@3                 </font><font color="#008000"><i>{ Delay For a few clock cycles             }
  </i></font><font color="#FF00FF">@@3:
    stosb                    </font><font color="#008000"><i>{ Store the Byte in the buffer             }

    </i></font><font color="#FF00FF">in   al,dx               </font><font color="#008000"><i>{ Read in the blue color Byte              }
    </i></font><font color="#FF00FF">jmp  @@4                 </font><font color="#008000"><i>{ Delay For a few clock cycles             }
  </i></font><font color="#FF00FF">@@4:
    stosb                    </font><font color="#008000"><i>{ Store the Byte in the buffer             }
    </i></font><font color="#FF00FF">loop @@1

    sti                      </font><font color="#008000"><i>{ turn interrupts back on                  }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font><font color="#008000"><i>{

**********************************************
Here's the testing Program
**********************************************
}
</i></font><font color="#FF0000"><b>Program </b></font>MCGATest<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Crt<font color="#000080">,</font>Dos<font color="#000080">,</font>MCGALib<font color="#000080">,</font>Palette<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Stop<font color="#000080">,
  </font>Start       <font color="#000080">:  </font>LongInt<font color="#000080">;
  </font>Regs        <font color="#000080">:  </font>Registers<font color="#000080">;
  </font>PicBuf<font color="#000080">,
  </font>StorageBuf  <font color="#000080">:  </font>Pointer<font color="#000080">;
  </font>FileLength  <font color="#000080">:  </font>Word<font color="#000080">;
  </font>Pal<font color="#000080">,
  </font>BlackPal    <font color="#000080">:  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">768</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>NumTimes    <font color="#000080">= </font><font color="#800000">100</font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>LoadBuffer <font color="#000080">(</font>S<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">;</font>Buf<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>F           <font color="#000080">:  </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>BlocksRead  <font color="#000080">:  </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign <font color="#000080">(</font>F<font color="#000080">,</font>S<font color="#000080">);
  </font>Reset <font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>BlockRead <font color="#000080">(</font>F<font color="#000080">,</font>Buf<font color="#000080">^,</font><font color="#800000">65000</font><font color="#000080">,</font>FileLength<font color="#000080">);
  </font>Close <font color="#000080">(</font>F<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Pause<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Ch     <font color="#000080">:  </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  Repeat Until </b></font>KeyPressed<font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font>KeyPressed <font color="#FF0000"><b>do </b></font>Ch <font color="#000080">:= </font>ReadKey<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Control<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>SetGraphMode <font color="#000080">(</font><font color="#800000">$13</font><font color="#000080">);

  </font>LoadBuffer <font color="#000080">(</font><font color="#800000">'E:\NAVAJO.PCX'</font><font color="#000080">,</font>PicBuf<font color="#000080">);

  </font>GetPCXPaletteAsm <font color="#000080">(</font>PicBuf<font color="#000080">,@</font>Pal<font color="#000080">,</font>FileLength<font color="#000080">-</font><font color="#800000">768</font><font color="#000080">);
  </font>WritePalettePas <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,@</font>Pal<font color="#000080">);
  </font>DisplayPCX <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>PicBuf<font color="#000080">);

  </font>FillChar <font color="#000080">(</font>BlackPal<font color="#000080">,</font>SizeOf<font color="#000080">(</font>BlackPal<font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
  </font>Pause<font color="#000080">;

  </font>SetupFade <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,@</font>BlackPal<font color="#000080">,</font><font color="#800000">20</font><font color="#000080">);
  </font><font color="#FF0000"><b>Repeat </b></font>FadePalette <font color="#FF0000"><b>Until </b></font>DoneFade<font color="#000080">;
  </font>Pause<font color="#000080">;

  </font>SetupFade <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,@</font>Pal<font color="#000080">,</font><font color="#800000">20</font><font color="#000080">);
  </font><font color="#FF0000"><b>Repeat </b></font>FadePalette <font color="#FF0000"><b>Until </b></font>DoneFade<font color="#000080">;
  </font>Pause<font color="#000080">;

  </font>Oreo <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">);
  </font>Pause<font color="#000080">;

  </font>SetupFade <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,@</font>Pal<font color="#000080">,</font><font color="#800000">20</font><font color="#000080">);
  </font><font color="#FF0000"><b>Repeat </b></font>FadePalette <font color="#FF0000"><b>Until </b></font>DoneFade<font color="#000080">;
  </font>Pause<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Init<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetMem <font color="#000080">(</font>PicBuf<font color="#000080">,</font><font color="#800000">65500</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Init<font color="#000080">;
  </font>Control<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COLOR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0014.PAS">Original</a><b>]</b></p></body>
</html>
