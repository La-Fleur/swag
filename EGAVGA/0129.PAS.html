<html>
<head><title> "Text Font Routines" by OLAF BARTELT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0129.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>UNIT </b></font>video<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

USES </b></font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>TYPE </b></font>fontSize <font color="#000080">= (</font>font8<font color="#000080">,</font>font14<font color="#000080">,</font>font16<font color="#000080">, </font>unknownFontSize<font color="#000080">);
     </font>adapterType <font color="#000080">= (</font>none<font color="#000080">,</font>mda<font color="#000080">,</font>cga<font color="#000080">,</font>egaMono<font color="#000080">,</font>egaColor<font color="#000080">,</font>vgaMono<font color="#000080">,
                   </font>vgaColor<font color="#000080">,</font>mcgaMono<font color="#000080">,</font>mcgaColor<font color="#000080">);

</font><font color="#FF0000"><b>VAR  </b></font>textBufferOrigin  <font color="#000080">: </font>pointer<font color="#000080">; </font><font color="#008000"><i>{pointer to text buffer}
     </i></font>textBufferSeg     <font color="#000080">: </font>word<font color="#000080">;
     </font>textBufferSize    <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{size in bytes of...}
     </i></font>visibleX<font color="#000080">,</font>visibleY <font color="#000080">: </font>byte<font color="#000080">;
     </font>fontLines         <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>queryAdapterType <font color="#000080">: </font>adapterType<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>fontCode<font color="#000080">(</font>h <font color="#000080">: </font>byte<font color="#000080">) : </font>fontSize<font color="#000080">; </font><font color="#008000"><i>{convert from byte to enum}
</i></font><font color="#FF0000"><b>function </b></font>getFontSize <font color="#000080">: </font>fontSize<font color="#000080">; </font><font color="#008000"><i>{normal 25 lines,ega 25 lines,vga 25 lines}
</i></font><font color="#FF0000"><b>function </b></font>fontHeight<font color="#000080">(</font>f <font color="#000080">: </font>fontSize<font color="#000080">) : </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>getTextBufferStats<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>BX       <font color="#000080">: </font>byte<font color="#000080">; </font><font color="#008000"><i>{visible x dimentions}
                             </i></font><font color="#FF0000"><b>var </b></font>BY       <font color="#000080">: </font>byte<font color="#000080">; </font><font color="#008000"><i>{visible y dimentions}
                             </i></font><font color="#FF0000"><b>var </b></font>buffSize <font color="#000080">: </font>word <font color="#008000"><i>{refresh buffer size}
                            </i></font><font color="#000080">);
</font><font color="#FF0000"><b>const </b></font>maxX                <font color="#000080">: </font>integer <font color="#000080">= </font><font color="#800000">79</font><font color="#000080">;
      </font>maxY                <font color="#000080">: </font>integer <font color="#000080">= </font><font color="#800000">24</font><font color="#000080">;

</font><font color="#FF0000"><b>IMPLEMENTATION

</b></font><font color="#008000"><i>(******************************************************************************
*                              queryAdapterType                              *
******************************************************************************)
</i></font><font color="#FF0000"><b>function </b></font>queryAdapterType <font color="#000080">: </font>adapterType<font color="#000080">;

</font><font color="#FF0000"><b>var         </b></font>regs <font color="#000080">: </font>Registers<font color="#000080">;
           </font>code <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
        </b></font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$1a</font><font color="#000080">; </font><font color="#008000"><i>{vga identify}
        </i></font>regs<font color="#000080">.</font>al <font color="#000080">:= </font><font color="#800000">$0</font><font color="#000080">;  </font><font color="#008000"><i>{clear}
        </i></font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>regs<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>regs<font color="#000080">.</font>al <font color="#000080">= </font><font color="#800000">$1a </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ is this a bug ???? }
        </i></font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{ps/2 bios search for ..}
                </i></font><font color="#FF0000"><b>case </b></font>regs<font color="#000080">.</font>bl <font color="#FF0000"><b>of </b></font><font color="#008000"><i>{code back in here}
                        </i></font><font color="#800000">$00 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>none<font color="#000080">;
                        </font><font color="#800000">$01 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>mda<font color="#000080">;
                        </font><font color="#800000">$02 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>cga<font color="#000080">;
                        </font><font color="#800000">$04 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>egaColor<font color="#000080">;
                        </font><font color="#800000">$05 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>egaMono<font color="#000080">;
                        </font><font color="#800000">$07 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>vgaMono<font color="#000080">;
                        </font><font color="#800000">$08 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>vgaColor<font color="#000080">;
                        </font><font color="#800000">$0A</font><font color="#000080">,</font><font color="#800000">$0C </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>mcgaColor<font color="#000080">;
                        </font><font color="#800000">$0B </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>mcgaMono<font color="#000080">;
                        </font><font color="#FF0000"><b>else </b></font>queryAdapterType <font color="#000080">:= </font>cga<font color="#000080">;
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{case}
        </i></font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ps/2 search}
        </i></font><font color="#FF0000"><b>else
        begin </b></font><font color="#008000"><i>{look for ega bios}
                </i></font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$12</font><font color="#000080">;
                </font>regs<font color="#000080">.</font>bx <font color="#000080">:= </font><font color="#800000">$10</font><font color="#000080">; </font><font color="#008000"><i>{bl=$10 retrn ega info if ega}
                </i></font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>regs<font color="#000080">);
                </font><font color="#FF0000"><b>if </b></font>regs<font color="#000080">.</font>bx <font color="#000080">&lt;&gt; </font><font color="#800000">$10 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{bx unchanged mean no ega}
                </i></font><font color="#FF0000"><b>begin
                        </b></font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$12</font><font color="#000080">; </font><font color="#008000"><i>{ega call again}
                        </i></font>regs<font color="#000080">.</font>bl <font color="#000080">:= </font><font color="#800000">$10</font><font color="#000080">; </font><font color="#008000"><i>{recheck}
                        </i></font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>regs<font color="#000080">);
                        </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>regs<font color="#000080">.</font>bh <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
                                </b></font>queryAdapterType <font color="#000080">:= </font>egaColor
                        <font color="#FF0000"><b>else
                                </b></font>queryAdapterType <font color="#000080">:= </font>egaMono<font color="#000080">;
                </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ega identification}
        </i></font><font color="#FF0000"><b>else </b></font><font color="#008000"><i>{mda or cga}
        </i></font><font color="#FF0000"><b>begin
                </b></font>intr<font color="#000080">(</font><font color="#800000">$11</font><font color="#000080">,</font>regs<font color="#000080">); </font><font color="#008000"><i>{get eqpt.}
                </i></font>code <font color="#000080">:= (</font>regs<font color="#000080">.</font>al <font color="#FF0000"><b>and </b></font><font color="#800000">$30</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;
                </font><font color="#FF0000"><b>case </b></font>code <font color="#FF0000"><b>of
                        </b></font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">2 </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>cga<font color="#000080">;
                        </font><font color="#800000">3   </font><font color="#000080">: </font>queryAdapterType <font color="#000080">:= </font>mda<font color="#000080">;
                        </font><font color="#FF0000"><b>else </b></font>queryAdapterType <font color="#000080">:= </font>none<font color="#000080">;
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{case}
        </i></font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{mda, cga}
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{quertAdapterType}

(******************************************************************************
*                             getTextBufferStats                              *
* return bx = #of columns, by = #of rows, buffSize = #of bytes in buffer      *
******************************************************************************)
</i></font><font color="#FF0000"><b>procedure </b></font>getTextBufferStats<font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>screenLineMatrix <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>adapterType<font color="#000080">,</font>fontSize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer <font color="#000080">=
        ( (</font><font color="#800000">25</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{none adapter}</i></font><font color="#000080">, (-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{mda}</i></font><font color="#000080">,
          (</font><font color="#800000">25</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{cga}</i></font><font color="#000080">,(</font><font color="#800000">43</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{egaMono}</i></font><font color="#000080">, (</font><font color="#800000">43</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{egaColor}</i></font><font color="#000080">,
          (</font><font color="#800000">50</font><font color="#000080">,</font><font color="#800000">28</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{vgaMono}</i></font><font color="#000080">, (</font><font color="#800000">50</font><font color="#000080">,</font><font color="#800000">28</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{vgaColor}</i></font><font color="#000080">,
          (-</font><font color="#800000">1</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{mcgaMono}</i></font><font color="#000080">, (-</font><font color="#800000">1</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{mcgaColor} </i></font><font color="#000080">);
</font><font color="#008000"><i>{this matrix is saved in font8,font14,font16 sequence in rows of matrix}
</i></font><font color="#FF0000"><b>var
        </b></font>regs<font color="#000080">:</font>registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
        </b></font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$0f</font><font color="#000080">; </font><font color="#008000"><i>{get current video mode}
        </i></font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>regs<font color="#000080">);
        </font>bx <font color="#000080">:= </font>regs<font color="#000080">.</font>ah<font color="#000080">; </font><font color="#008000"><i>{# of chars in a line, row}
        </i></font>by <font color="#000080">:= </font>screenLineMatrix<font color="#000080">[</font>queryAdapterType<font color="#000080">, </font>getFontSize<font color="#000080">];
        </font><font color="#FF0000"><b>if </b></font>by <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{legal height}
                </i></font>buffSize <font color="#000080">:= </font>bx <font color="#000080">* </font><font color="#800000">2 </font><font color="#000080">* </font>by
        <font color="#FF0000"><b>else
                </b></font>buffSize <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{getTextBufferStats}

(******************************************************************************
*                                 getFontSize                                 *
******************************************************************************)
</i></font><font color="#FF0000"><b>function </b></font>getFontSize <font color="#000080">: </font>fontSize<font color="#000080">;
</font><font color="#FF0000"><b>var
        </b></font>regs  <font color="#000080">: </font>registers<font color="#000080">;
   </font>fs    <font color="#000080">: </font>fontSize<font color="#000080">;
   </font>at    <font color="#000080">: </font>adapterType<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>at <font color="#000080">:= </font>queryAdapterType<font color="#000080">;
        </font><font color="#FF0000"><b>case </b></font>at <font color="#FF0000"><b>of
                </b></font>cga                 <font color="#000080">: </font>fs <font color="#000080">:= </font>font8<font color="#000080">;
                </font>mda                 <font color="#000080">: </font>fs <font color="#000080">:= </font>font14<font color="#000080">;
                </font>mcgaMono<font color="#000080">,
                </font>mcgaColor        <font color="#000080">: </font>fs<font color="#000080">:= </font>font16<font color="#000080">;
                </font>egaMono<font color="#000080">,
                </font>egaColor<font color="#000080">,
                </font>vgaMono<font color="#000080">,
                </font>vgaColor        <font color="#000080">: </font><font color="#FF0000"><b>begin
                                        with </b></font>regs <font color="#FF0000"><b>do begin
               </b></font><font color="#008000"><i>(* check this interrupt call, there might be some bug,
                  either in the call conventions, or in the 3300A
                  bios. *)
                                                </i></font>ah <font color="#000080">:= </font><font color="#800000">$11</font><font color="#000080">; </font><font color="#008000"><i>{egavga call}
                                                </i></font>al <font color="#000080">:= </font><font color="#800000">$30</font><font color="#000080">;
</font><font color="#008000"><i>(*                                                bl := $0;   *)
                                                </i></font>bh <font color="#000080">:= </font><font color="#800000">$0</font><font color="#000080">;
                                        </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{with}
                                        </i></font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>regs<font color="#000080">);
                                        </font>fs <font color="#000080">:= </font>fontCode<font color="#000080">(</font>regs<font color="#000080">.</font>cl<font color="#000080">);
               </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>fs <font color="#000080">= </font>unknownFontSize<font color="#000080">) </font><font color="#FF0000"><b>then
                  </b></font>fs <font color="#000080">:= </font>font16<font color="#000080">; </font><font color="#008000"><i>{ assume a work around in 330A screen}
                                </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ega vga}
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{case}
   </i></font>getFontSize <font color="#000080">:= </font>fs<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{getFontSize}

(******************************************************************************
*                                  fontCode                                   *
* Convert from byte size to a fontSize type                                                                                 *
******************************************************************************)
</i></font><font color="#FF0000"><b>function </b></font>fontCode<font color="#000080">;
</font><font color="#FF0000"><b>begin
        case </b></font>h <font color="#FF0000"><b>of
                 </b></font><font color="#800000">8 </font><font color="#000080">: </font>fontCode <font color="#000080">:= </font>font8<font color="#000080">;
                </font><font color="#800000">14 </font><font color="#000080">: </font>fontCode <font color="#000080">:= </font>font14<font color="#000080">;
                </font><font color="#800000">16 </font><font color="#000080">: </font>fontCode <font color="#000080">:= </font>font16<font color="#000080">;
      </font><font color="#FF0000"><b>else </b></font>fontCode <font color="#000080">:= </font>unknownFontSize<font color="#000080">; </font><font color="#008000"><i>{ unKnown, assume 8 }
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{case}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{fontCode}

(******************************************************************************
*                                 fontHeight                                 *
******************************************************************************)
</i></font><font color="#FF0000"><b>function </b></font>fontHeight<font color="#000080">(</font>f <font color="#000080">: </font>fontSize<font color="#000080">) : </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
        case </b></font>f <font color="#FF0000"><b>of
                </b></font>font8  <font color="#000080">: </font>fontHeight <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
                </font>font14 <font color="#000080">: </font>fontHeight <font color="#000080">:= </font><font color="#800000">14</font><font color="#000080">;
                </font>font16 <font color="#000080">: </font>fontHeight <font color="#000080">:= </font><font color="#800000">16</font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{case}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{fontHeight}

</i></font><font color="#FF0000"><b>begin
   </b></font>getTextBufferStats<font color="#000080">(</font>visibleX<font color="#000080">, </font>visibleY<font color="#000080">, </font>textBufferSize<font color="#000080">);
   </font>maxX <font color="#000080">:= </font>visibleX <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
   </font>maxY <font color="#000080">:= </font>visibleY <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
   </font>fontLines <font color="#000080">:= </font>fontHeight<font color="#000080">(</font>getFontSize<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0129.PAS">Original</a><b>]</b></p></body>
</html>
