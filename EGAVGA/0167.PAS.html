<html>
<head><title> "New Optimized UModeQ Unit" by ANTONIO SANCHEZ</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0167.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
&gt;    how ever i know that the ET3000 use diference ways to get your
&gt; modes so this mite be your trouble..
no, it can't, cause the mode is actually set and works, but some single lines
(!) just don't work (and they change if I run the program twice or more) - so
this screen is 256 lines high, and for example lines 3, 180, 185 and 200 are
let's say gray - any idea why?  (the amount of lines and which lines seem to be
totally random)

(* Original code by Bas van Gaalen.         *)
(* Modified for no vertical overscan        *)
(* and converted to unit by Antonio Sanchez *)
}
</i></font><font color="#FF0000"><b>unit </b></font>umodeq<font color="#000080">;

</font><font color="#FF0000"><b>interface
type
  </b></font>twrec<font color="#000080">=</font><font color="#FF0000"><b>record </b></font>reg<font color="#000080">:</font>word<font color="#000080">; </font>func<font color="#000080">,</font>data<font color="#000080">:</font>byte<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>twarr<font color="#000080">=</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">24</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>twrec<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>vidseg<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">$a000</font><font color="#000080">;

  </font>tweak<font color="#000080">:</font>twarr<font color="#000080">=(
    (</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$00</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$5f</font><font color="#000080">), </font><font color="#008000"><i>{ hor. total }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$01</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$3f</font><font color="#000080">), </font><font color="#008000"><i>{ hor. display enable end }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$02</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$40</font><font color="#000080">), </font><font color="#008000"><i>{ blank start }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$03</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$82</font><font color="#000080">), </font><font color="#008000"><i>{ blank end }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$04</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$4e</font><font color="#000080">), </font><font color="#008000"><i>{ retrace start }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$05</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$9a</font><font color="#000080">), </font><font color="#008000"><i>{ retrace end }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$06</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$23</font><font color="#000080">), </font><font color="#008000"><i>{ vertical total }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$07</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$b2</font><font color="#000080">), </font><font color="#008000"><i>{ overflow register }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$08</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$00</font><font color="#000080">), </font><font color="#008000"><i>{ preset row scan }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$09</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$61</font><font color="#000080">), </font><font color="#008000"><i>{ max scan line/char heigth }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$10</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$0a</font><font color="#000080">), </font><font color="#008000"><i>{ ver. retrace start }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$11</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$ac</font><font color="#000080">), </font><font color="#008000"><i>{ ver. retrace end }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$12</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$ff</font><font color="#000080">), </font><font color="#008000"><i>{ ver. display enable end }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$13</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$20</font><font color="#000080">), </font><font color="#008000"><i>{ offset/logical width }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$14</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$40</font><font color="#000080">), </font><font color="#008000"><i>{ underlinde location }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$15</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$07</font><font color="#000080">), </font><font color="#008000"><i>{ ver. blank start }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$16</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$17</font><font color="#000080">), </font><font color="#008000"><i>{ ver. blank end }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03d4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$17</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$a3</font><font color="#000080">), </font><font color="#008000"><i>{ mode control }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03c4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$01</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$01</font><font color="#000080">), </font><font color="#008000"><i>{ clock mode register }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03c4</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$04</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$0e</font><font color="#000080">), </font><font color="#008000"><i>{ memory mode register }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03ce</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$05</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$40</font><font color="#000080">), </font><font color="#008000"><i>{ mode register }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03ce</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$06</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$05</font><font color="#000080">), </font><font color="#008000"><i>{ misc. register }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$03c0</font><font color="#000080">; </font>func<font color="#000080">:</font><font color="#800000">$10</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$41</font><font color="#000080">), </font><font color="#008000"><i>{ mode control }
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$3c2</font><font color="#000080">;  </font>func<font color="#000080">:</font><font color="#800000">$0</font><font color="#000080">;  </font>data<font color="#000080">:</font><font color="#800000">$e3</font><font color="#000080">), </font><font color="#008000"><i>(* newly added *)
    </i></font><font color="#000080">(</font>reg<font color="#000080">:</font><font color="#800000">$3c0</font><font color="#000080">;  </font>func<font color="#000080">:</font><font color="#800000">$13</font><font color="#000080">; </font>data<font color="#000080">:</font><font color="#800000">$0</font><font color="#000080">)); </font><font color="#008000"><i>(* newly added *)

</i></font><font color="#FF0000"><b>procedure </b></font>setpal<font color="#000080">(</font>col<font color="#000080">,</font>r<font color="#000080">,</font>g<font color="#000080">,</font>b <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>initvga<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>inittxt<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>openregs<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>closeregs<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>setmodeq<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>putpixel<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>fillscreen<font color="#000080">;

</font><font color="#FF0000"><b>implementation

procedure </b></font>setpal<font color="#000080">(</font>col<font color="#000080">,</font>r<font color="#000080">,</font>g<font color="#000080">,</font>b <font color="#000080">: </font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx,03c8h; mov al,col; out dx,al; inc dx; mov al,r; out dx,al
  mov al,g; out dx,al; mov al,b; out dx,al; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>initvga<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax,13h; int 10h; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>inittxt<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax,3; int 10h; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>openregs<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx,03d4h; mov al,11h; out dx,al; inc dx; in al,dx; and al,7fh
  mov ah,al; mov al,11h; dec dx; out dx,ax; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>closeregs<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx,03d4h; mov al,11h; out dx,al; inc dx; in al,dx; or al,80h
  mov ah,al; mov al,11h; dec dx; out dx,ax; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setmodeq<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>i<font color="#000080">:</font>byte<font color="#000080">;
    </font>dummy <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>initvga<font color="#000080">;
  </font>openregs<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">24 </font><font color="#FF0000"><b>do
    with </b></font>tweak<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>do
    begin
      IF </b></font>reg<font color="#000080">=</font><font color="#800000">$3c0
      </font><font color="#FF0000"><b>then begin
            </b></font>dummy<font color="#000080">:=</font>port<font color="#000080">[</font><font color="#800000">$3da</font><font color="#000080">];     </font><font color="#008000"><i>{ reset read/write flip-flop }
            </i></font>port<font color="#000080">[</font><font color="#800000">$3c0</font><font color="#000080">]:= </font>func <font color="#FF0000"><b>or </b></font><font color="#800000">$20</font><font color="#000080">; </font><font color="#008000"><i>{ ensure vga output is enabled }
            </i></font>port<font color="#000080">[</font><font color="#800000">$3c0</font><font color="#000080">]:= </font>data<font color="#000080">;
           </font><font color="#FF0000"><b>end
      else if </b></font><font color="#000080">(</font>reg<font color="#000080">=</font><font color="#800000">$3c2</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>reg<font color="#000080">=</font><font color="#800000">$3c3</font><font color="#000080">)
       </font><font color="#FF0000"><b>then </b></font>port<font color="#000080">[</font>reg<font color="#000080">]:=</font>data   <font color="#008000"><i>{  directly to the port  }
      </i></font><font color="#FF0000"><b>else begin
            </b></font>port<font color="#000080">[</font>reg<font color="#000080">]:=</font>func<font color="#000080">;  </font><font color="#008000"><i>{  index to port  }
            </i></font>port<font color="#000080">[</font>reg<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]:=</font>data<font color="#000080">;</font><font color="#008000"><i>{  value to port+1  }
           </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>closeregs<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>putpixel<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov es,vidseg
  mov bh,[y]
  mov bl,[x]
  mov al,[c]
  mov [es:bx],al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>fillscreen<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov es,vidseg
  xor cx,cx
 @loop:
  mov di,cx
  mov al,cl
  add al,ch
  mov [es:di],al
  inc cx
  jnz @loop
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
well, I have no simple example for that unit now, but for example just fill the
screen each line with a different color, and you'll see...  (BTW, works on a
ET4000 and on my new Cirrus Logic-based card...)
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0167.PAS">Original</a><b>]</b></p></body>
</html>
