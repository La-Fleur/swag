<html>
<head><title> "Run Length TGA Viewer" by PAT O'MALLEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0261.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{ ---RLTGA.PAS--- The Run-Length Encoded Targa (type 9) viewer for DOS ---}
{ ===Coded by Patrick O'Malley===                                         }
{ ---Is this OK for SWAG?---                                              }
{ ===Please mention me if you use this proggy in one of your proggys===   }
{ ---Sorry about the lack of comments. I did add _some_ tho ;)---         }
{ ---My InterNet E-Mail address is: d005530c@dcfreenet.seflin.lib.fl.us---}

{ Just a small note about the strange stuff at the end of the proggy:
  That virtual screen that is written to is used to flip the TGA around.
  These TGAs are encoded bottom-up. Since I can't read the file from
  bottom up, I must flip the file around after it has been read. }

{$X+}
</i></font><font color="#FF0000"><b>Program </b></font>Read_Encoded_TGA<font color="#000080">;
</font><font color="#FF0000"><b>Uses </b></font>Crt<font color="#000080">;
</font><font color="#FF0000"><b>Type </b></font>TGAHeader <font color="#000080">= </font><font color="#FF0000"><b>record
                   </b></font>IDFieldLength <font color="#000080">: </font>Byte<font color="#000080">;
                   </font>ColorMapType <font color="#000080">: </font>Byte<font color="#000080">;
                   </font>ImageType <font color="#000080">: </font>Byte<font color="#000080">;
                   </font>CMapOrigin <font color="#000080">: </font>Integer<font color="#000080">;
                   </font>CMapLength <font color="#000080">: </font>Integer<font color="#000080">;
                   </font>CMapSize <font color="#000080">: </font>Byte<font color="#000080">;
                   </font>XOrigin <font color="#000080">: </font>Integer<font color="#000080">;
                   </font>YOrigin <font color="#000080">: </font>Integer<font color="#000080">;
                   </font>Width <font color="#000080">: </font>Integer<font color="#000080">;
                   </font>Height <font color="#000080">: </font>Integer<font color="#000080">;
                   </font>ImagePixSize <font color="#000080">: </font>Byte<font color="#000080">;
                   </font>ImageDescriptor <font color="#000080">: </font>Byte<font color="#000080">;
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>ImageIDFieldType <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">256</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;

</font><font color="#FF0000"><b>Const </b></font>VGA <font color="#000080">= </font><font color="#800000">$A000</font><font color="#000080">;

</font><font color="#FF0000"><b>Var </b></font>Header <font color="#000080">: </font>TGAHeader<font color="#000080">;
    </font>ImageIDField <font color="#000080">: </font>ImageIDFieldType<font color="#000080">;
    </font>TGA <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
    </font>TGAName <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font>VGAScreen <font color="#000080">: </font>Pointer<font color="#000080">;
    </font>VGASeg <font color="#000080">: </font>Word<font color="#000080">;
    </font>Pal <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>Counter<font color="#000080">,</font>Count <font color="#000080">: </font>Word<font color="#000080">;
    </font>Temp <font color="#000080">: </font>Byte<font color="#000080">;
    </font>PixelCount <font color="#000080">: </font>Word<font color="#000080">;
    </font>Rep <font color="#000080">: </font>Byte<font color="#000080">;
    </font>NewByte <font color="#000080">: </font>Byte<font color="#000080">;
    </font>MaxPix <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetColor<font color="#000080">(</font>Col<font color="#000080">, </font>R<font color="#000080">, </font>G<font color="#000080">, </font>B <font color="#000080">: </font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Begin
   Asm
      </b></font><font color="#FF00FF">mov   dx, 3c8h
      mov   al, [Col]
      out   dx, al
      inc   dx
      mov   al, [R]
      out   dx, al
      mov   al, [G]
      out   dx, al
      mov   al, [B]
      out   dx, al
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{SetColor}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetMcga<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   Asm
      </b></font><font color="#FF00FF">mov   ax, 0013h
      int   10h
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;  </font><font color="#008000"><i>{SetMCGA}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetText<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   Asm
      </b></font><font color="#FF00FF">mov   ax, 0003h
      int   10h
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{SetText}

</i></font><font color="#FF0000"><b>Procedure </b></font>Error<font color="#000080">(</font>Str <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>Begin
  </b></font>writeln<font color="#000080">(</font>Str<font color="#000080">);
  </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>TGAName <font color="#000080">:= </font>Paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>TGAName <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font>Error<font color="#000080">(</font><font color="#800000">'Enter filename on Command Line.'</font><font color="#000080">);
  </font><font color="#008000"><i>{$I-}
  </i></font>Assign<font color="#000080">(</font>TGA<font color="#000080">,</font>TGAName<font color="#000080">);
  </font>Reset<font color="#000080">(</font>TGA<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Error<font color="#000080">(</font><font color="#800000">'File not found!'</font><font color="#000080">);
  </font><font color="#008000"><i>{$I+}
  </i></font>BlockRead<font color="#000080">(</font>TGA<font color="#000080">,</font>Header<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Header<font color="#000080">));
  </font><font color="#008000"><i>{This next part checks for an image ID field (header.IDFieldLength &gt; 0)
   then, if one is found, reads it into ImageIDField. Should be less than
   256 bytes (let's hope). It is usually omitted (header.IDFieldLength=0).}
  </i></font><font color="#FF0000"><b>If </b></font>Header<font color="#000080">.</font>IDFieldLength <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>BlockRead<font color="#000080">(</font>TGA<font color="#000080">,</font>ImageIDField<font color="#000080">,</font>Header<font color="#000080">.</font>IDFieldLength<font color="#000080">);
  </font><font color="#008000"><i>{Make sure that it is an encoded type 9 TGA}
  </i></font><font color="#FF0000"><b>If </b></font>Header<font color="#000080">.</font>ImageType <font color="#000080">&lt;&gt; </font><font color="#800000">9 </font><font color="#FF0000"><b>then Begin
    </b></font>Close<font color="#000080">(</font>TGA<font color="#000080">);
    </font>Error<font color="#000080">(</font><font color="#800000">'Not a color-mapped type-9 Targa!'</font><font color="#000080">);
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>SetMCGA<font color="#000080">;
  </font><font color="#008000"><i>{Read colors}
  </i></font><font color="#FF0000"><b>For </b></font>Counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Header<font color="#000080">.</font>CMapLength<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
    For </b></font>Count <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">2 </font><font color="#FF0000"><b>do Begin
      </b></font>BlockRead<font color="#000080">(</font>TGA<font color="#000080">,</font>Temp<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>Pal<font color="#000080">[</font>Counter<font color="#000080">,</font>Count<font color="#000080">] := </font>Temp <font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#008000"><i>{Set colors}
  </i></font><font color="#FF0000"><b>For </b></font>Counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
    </b></font>SetColor<font color="#000080">(</font>Counter<font color="#000080">,</font>Pal<font color="#000080">[</font>Counter<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">],</font>Pal<font color="#000080">[</font>Counter<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">],</font>Pal<font color="#000080">[</font>Counter<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">]);
  </font><font color="#008000"><i>{Read image stuff!}
  </i></font>MaxPix <font color="#000080">:= (</font>Header<font color="#000080">.</font>Height<font color="#000080">*</font>Header<font color="#000080">.</font>Width<font color="#000080">);
  </font>PixelCount <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>GetMem<font color="#000080">(</font>VGAScreen<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);
  </font>VGASeg <font color="#000080">:= </font>Seg<font color="#000080">(</font>VGAScreen<font color="#000080">^);
  </font>FillChar<font color="#000080">(</font>Mem<font color="#000080">[</font>VGASeg<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">],</font><font color="#800000">64000</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>Repeat
    </b></font>BlockRead<font color="#000080">(</font>TGA<font color="#000080">,</font>Temp<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>Temp <font color="#FF0000"><b>shr </b></font><font color="#800000">7 </font><font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>then begin
      </b></font>BlockRead<font color="#000080">(</font>TGA<font color="#000080">,</font>NewByte<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>Rep <font color="#000080">:= </font>Temp <font color="#FF0000"><b>AND </b></font><font color="#800000">127</font><font color="#000080">;
      </font><font color="#FF0000"><b>For </b></font>Count <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>rep<font color="#000080">+</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
        </b></font>Mem<font color="#000080">[</font>VGASeg<font color="#000080">:</font>PixelCount<font color="#000080">] := </font>NewByte<font color="#000080">;
        </font>Inc<font color="#000080">(</font>PixelCount<font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end
    else
    Begin
      </b></font>Rep <font color="#000080">:= </font>Temp <font color="#FF0000"><b>AND </b></font><font color="#800000">127</font><font color="#000080">;
      </font><font color="#FF0000"><b>For </b></font>Count <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Rep<font color="#000080">+</font><font color="#800000">1 </font><font color="#FF0000"><b>do Begin
        </b></font>BlockRead<font color="#000080">(</font>TGA<font color="#000080">,</font>NewByte<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
        </font>Mem<font color="#000080">[</font>VGASeg<font color="#000080">:</font>PixelCount<font color="#000080">] := </font>NewByte<font color="#000080">;
        </font>Inc<font color="#000080">(</font>PixelCount<font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Until </b></font>PixelCount <font color="#000080">= </font>MaxPix<font color="#000080">;
  </font><font color="#008000"><i>{Flip the screen onto the display}
  </i></font><font color="#FF0000"><b>For </b></font>Count <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Header<font color="#000080">.</font>Width<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do  </b></font><font color="#008000"><i>{x}
    </i></font><font color="#FF0000"><b>For </b></font>Counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Header<font color="#000080">.</font>Height<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do </b></font><font color="#008000"><i>{y}
      </i></font>Mem<font color="#000080">[</font>VGA<font color="#000080">:</font>Counter<font color="#000080">*</font><font color="#800000">320</font><font color="#000080">+</font>Count<font color="#000080">] :=
</font>Mem<font color="#000080">[</font>VGASeg<font color="#000080">:((</font>Header<font color="#000080">.</font>Height<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)-</font>Counter<font color="#000080">)*</font>Header<font color="#000080">.</font>Width<font color="#000080">+</font>Count<font color="#000080">];  </font>Readkey<font color="#000080">;
  </font>Close<font color="#000080">(</font>TGA<font color="#000080">);
  </font>Freemem<font color="#000080">(</font>VGAScreen<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);
  </font>SetText<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0261.PAS">Original</a><b>]</b></p></body>
</html>
