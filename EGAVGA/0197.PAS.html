<html>
<head><title> "Triple Buffering" by MARCIN BORKOWSKI</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0197.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;&gt;&gt; If you wait for the retrace each time, you won't
&gt;&gt;&gt; flicker, but you will limit the speed to the
&gt;&gt;&gt; retrace speed (about 68-70) frames a second.  If
&gt;&gt;&gt; you wanted to truly find the speed, do it without
&gt;&gt;&gt; the retrace wait, and you may get much faster.  You may
&gt;&gt;&gt; already know this, in which case I am just
&gt;&gt;&gt; wasting space...

&gt;&gt; And if you use a tripple buffering you will get no flicker and
&gt;&gt; the maximu speed.

&gt; What the heck is triple buffering?

You are using THREE different screens (no problem in x-mode). One (A) is
displayed, second (B) is waiting, third (C) is being drawn. After third C is
ready B is being displayed and A is being drawn. No flickering, no waiting, no
problem...

&gt;&gt;&gt; By the way, as a general note, I have found that
&gt;&gt;&gt; the single palette entry change also waits for the
&gt;&gt;&gt; retrace.  So if you put that in a program, it will
&gt;&gt;&gt; severely limit the speed (voice of experience).

&gt;&gt; Waits? Only if you are using BIOS for it.
&gt; I am talking about the BIOS op.  Doing it directly takes
&gt; more info than I have.

OK, so take a look - and learn ;-)
}

{$A+,B-,D+,E+,F-,G+,I-,L+,N-,O-,P-,Q-,R-,S-,T-,V+,X+,Y+}
{$M 16384,0,655360}

</i></font><font color="#FF0000"><b>uses </b></font>crt<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>i       <font color="#000080">: </font>integer<font color="#000080">;
  </font>licznik <font color="#000080">: </font>byte<font color="#000080">;
  </font>paleta  <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>screen  <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63999</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte <font color="#FF0000"><b>absolute </b></font><font color="#800000">$A000</font><font color="#000080">:</font><font color="#800000">0</font><font color="#000080">;

</font><font color="#008000"><i>{ This is necessaery for drawing plasma. Don't mind. It is the same piece of
code I use in voxel space code posted here for several times, not necessarilly
by me. }

</i></font><font color="#FF0000"><b>function </b></font>ncol<font color="#000080">(</font>mc<font color="#000080">,</font>n<font color="#000080">,</font>dvd <font color="#000080">: </font>integer<font color="#000080">): </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>loc <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>loc<font color="#000080">:=(</font>mc<font color="#000080">+</font>n<font color="#000080">-</font>random<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>n<font color="#000080">)) </font><font color="#FF0000"><b>div </b></font>dvd<font color="#000080">;
  </font>ncol<font color="#000080">:=</font>loc<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>loc<font color="#000080">&gt;</font><font color="#800000">250 </font><font color="#FF0000"><b>then </b></font>ncol<font color="#000080">:=</font><font color="#800000">250</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>loc<font color="#000080">&lt;</font><font color="#800000">5 </font><font color="#FF0000"><b>then </b></font>ncol<font color="#000080">:=</font><font color="#800000">5
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>plasma<font color="#000080">(</font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2 <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>xn<font color="#000080">,</font>yn<font color="#000080">,</font>dxy<font color="#000080">,</font>p1<font color="#000080">,</font>p2<font color="#000080">,</font>p3<font color="#000080">,</font>p4 <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>x2<font color="#000080">-</font>x1<font color="#000080">&lt;</font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>y2<font color="#000080">-</font>y1<font color="#000080">&lt;</font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>EXIT<font color="#000080">;
  </font>p1<font color="#000080">:=</font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y1<font color="#000080">+</font>x1<font color="#000080">];
  </font>p2<font color="#000080">:=</font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y2<font color="#000080">+</font>x1<font color="#000080">];
  </font>p3<font color="#000080">:=</font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y1<font color="#000080">+</font>x2<font color="#000080">];
  </font>p4<font color="#000080">:=</font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y2<font color="#000080">+</font>x2<font color="#000080">];
  </font>xn<font color="#000080">:=(</font>x2<font color="#000080">+</font>x1<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">;
  </font>yn<font color="#000080">:=(</font>y2<font color="#000080">+</font>y1<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">;
  </font>dxy<font color="#000080">:=</font><font color="#800000">5</font><font color="#000080">*(</font>x2<font color="#000080">-</font>x1<font color="#000080">+</font>y2<font color="#000080">-</font>y1<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">3</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y1<font color="#000080">+</font>xn<font color="#000080">]=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y1<font color="#000080">+</font>xn<font color="#000080">]:=</font>ncol<font color="#000080">(</font>p1<font color="#000080">+</font>p3<font color="#000080">,</font>dxy<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>yn<font color="#000080">+</font>x1<font color="#000080">]=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>yn<font color="#000080">+</font>x1<font color="#000080">]:=</font>ncol<font color="#000080">(</font>p1<font color="#000080">+</font>p2<font color="#000080">,</font>dxy<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>yn<font color="#000080">+</font>x2<font color="#000080">]=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>yn<font color="#000080">+</font>x2<font color="#000080">]:=</font>ncol<font color="#000080">(</font>p3<font color="#000080">+</font>p4<font color="#000080">,</font>dxy<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y2<font color="#000080">+</font>xn<font color="#000080">]=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>y2<font color="#000080">+</font>xn<font color="#000080">]:=</font>ncol<font color="#000080">(</font>p2<font color="#000080">+</font>p4<font color="#000080">,</font>dxy<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font>screen<font color="#000080">[</font><font color="#800000">320</font><font color="#000080">*</font>yn<font color="#000080">+</font>xn<font color="#000080">]:=</font>ncol<font color="#000080">(</font>p1<font color="#000080">+</font>p2<font color="#000080">+</font>p3<font color="#000080">+</font>p4<font color="#000080">,</font>dxy<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
  </font>plasma<font color="#000080">(</font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>xn<font color="#000080">,</font>yn<font color="#000080">);
  </font>plasma<font color="#000080">(</font>xn<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>yn<font color="#000080">);
  </font>plasma<font color="#000080">(</font>x1<font color="#000080">,</font>yn<font color="#000080">,</font>xn<font color="#000080">,</font>y2<font color="#000080">);
  </font>plasma<font color="#000080">(</font>xn<font color="#000080">,</font>yn<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">mov  ax,13h
    int  10h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Generating palette RGBs }
  </i></font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">170 </font><font color="#FF0000"><b>do </b></font>paleta<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">*</font>i<font color="#000080">]:=</font>round<font color="#000080">(</font><font color="#800000">63</font><font color="#000080">*</font>sin<font color="#000080">(</font>i<font color="#000080">/</font><font color="#800000">170</font><font color="#000080">*</font>pi<font color="#000080">));
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">170 </font><font color="#FF0000"><b>do </b></font>paleta<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">*</font>i<font color="#000080">+</font><font color="#800000">256</font><font color="#000080">]:=</font>round<font color="#000080">(</font><font color="#800000">63</font><font color="#000080">*</font>sin<font color="#000080">(</font>i<font color="#000080">/</font><font color="#800000">170</font><font color="#000080">*</font>pi<font color="#000080">));
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">170 </font><font color="#FF0000"><b>do </b></font>paleta<font color="#000080">[(</font><font color="#800000">3</font><font color="#000080">*</font>i<font color="#000080">+</font><font color="#800000">512</font><font color="#000080">) </font><font color="#FF0000"><b>mod </b></font><font color="#800000">768</font><font color="#000080">]:=</font>round<font color="#000080">(</font><font color="#800000">63</font><font color="#000080">*</font>sin<font color="#000080">(</font>i<font color="#000080">/</font><font color="#800000">170</font><font color="#000080">*</font>pi<font color="#000080">));
  </font>plasma<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">319</font><font color="#000080">,</font><font color="#800000">199</font><font color="#000080">);
</font><font color="#008000"><i>{ Licznik - it means 'counter' in Polish.  }
  </i></font>licznik<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat
</b></font><font color="#008000"><i>{ Wait for retrace. }
    </i></font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>port<font color="#000080">[</font><font color="#800000">$03DA</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">8</font><font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>port<font color="#000080">[</font><font color="#800000">$03DA</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">8</font><font color="#000080">)=</font><font color="#800000">8</font><font color="#000080">;
</font><font color="#008000"><i>{ Changing palette - we start with color number licznik }
    </i></font>port<font color="#000080">[</font><font color="#800000">$3C8</font><font color="#000080">]:=</font>licznik<font color="#000080">;
</font><font color="#008000"><i>{ Three outsb are copying whole RGB to VGA register. After those three
instructions value in port $3C8 is incremented. Here I'm redefining whole
palette, but there is no problem in changing only one color. }
    </i></font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov  si,offset paleta
      mov  cx,768
      mov  dx,$3C9
      rep outsb
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>inc<font color="#000080">(</font>licznik<font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov  ax,3h
    int  10h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0197.PAS">Original</a><b>]</b></p></body>
</html>
