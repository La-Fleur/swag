<html>
<head><title> "GIF Viewer up to 640x480x256" by MIKA STENBERG</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0208.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Could someone maybe tell me how to display
&gt; a 640X480X256 .gif?  Thanks a bunch...

     Here's some Gif routines i found... Have fun!
}

{**************************************************************
**                   GIFVIEW  Version 1.0                    **
**         Made by: Lars Fastrup Nielsen, March 1991         **
**                                                           **
**                Please distribute freely.                  **
**************************************************************}
{$A+,B-,D-,E-,F-,I-,L-,N-,O-,R-,S-,V+}
{$M 16384,0,655360}
</i></font><font color="#FF0000"><b>program </b></font>GifView<font color="#000080">;

</font><font color="#008000"><i>{Includes for external .OBJ files.}
{$L nlzw}
{$L readrast}

</i></font><font color="#FF0000"><b>uses
  </b></font>crt<font color="#000080">, </font>dos<font color="#000080">, </font>CrtModes<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>Select320x200x256 <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;          </font><font color="#008000"><i>{Videomode supported by BIOS.}
  </i></font>Select320x400x256 <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;          </font><font color="#008000"><i>{Videochip is reprogrammed.}
  </i></font>Select360x480x256 <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;          </font><font color="#008000"><i>{Videochip is reprogrammed.}
  </i></font>Select640x480x256 <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;          </font><font color="#008000"><i>{Simulated videomode.}
  </i></font>Select512x480x256 <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">;          </font><font color="#008000"><i>{Simulated videomode.}

  </i></font>BufferSize        <font color="#000080">= </font><font color="#800000">64000</font><font color="#000080">;      </font><font color="#008000"><i>{Size of GIFStuff and Raster array.}

  {MaxCode values for differing code sizes}
  </i></font>MaxCodes<font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Word <font color="#000080">= (</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">16</font><font color="#000080">,</font><font color="#800000">$20</font><font color="#000080">,</font><font color="#800000">$40</font><font color="#000080">,</font><font color="#800000">$80</font><font color="#000080">,</font><font color="#800000">$100</font><font color="#000080">,</font><font color="#800000">$200</font><font color="#000080">,</font><font color="#800000">$400</font><font color="#000080">,</font><font color="#800000">$800</font><font color="#000080">);

  </font><font color="#008000"><i>{Saves computing these values, Pascal having no exponentiation}
  </i></font>PowersOf2<font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">=(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">16</font><font color="#000080">,</font><font color="#800000">32</font><font color="#000080">,</font><font color="#800000">64</font><font color="#000080">,</font><font color="#800000">128</font><font color="#000080">,</font><font color="#800000">256</font><font color="#000080">);

</font><font color="#FF0000"><b>type
  </b></font>PaletteType  <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
  </font>BufferArray  <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>BufferSize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>BufferP      <font color="#000080">= ^</font>BufferArray<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>GIFFile  <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;      </font><font color="#008000"><i>{GIF input file.}
  </i></font>GIFStuff <font color="#000080">: </font>BufferP<font color="#000080">;   </font><font color="#008000"><i>{Raw data, read directly from file.}
  </i></font>Raster   <font color="#000080">: </font>BufferP<font color="#000080">;   </font><font color="#008000"><i>{Unblocked rasterdata ready to decode.}

  {Info read form GIF header.}
  </i></font>RasterWidth<font color="#000080">,     </font><font color="#008000"><i>{X-coordinate resolution. (eks. 320,360,640,800 or 1024)}
  </i></font>RasterHeight<font color="#000080">,    </font><font color="#008000"><i>{Y-coordinate resolution. (eks. 200,400,480,600 or 768)}
  </i></font>ImageLeft<font color="#000080">,       </font><font color="#008000"><i>{Image offset from the left.}
  </i></font>ImageTop<font color="#000080">,        </font><font color="#008000"><i>{Image offset from the top.}
  </i></font>ImageWidth<font color="#000080">,      </font><font color="#008000"><i>{Width of picture in pixels. (Often equal to RasterWidth)}
  </i></font>ImageHeight<font color="#000080">,     </font><font color="#008000"><i>{Height of picture in pixels. (Often equal to RasterHeight)}
  </i></font>ColorMapSize<font color="#000080">,    </font><font color="#008000"><i>{Number of colors in picture. Used when reading colormap.}

  </i></font>Freecode<font color="#000080">,        </font><font color="#008000"><i>{Next free code, used by decompressor.}
  </i></font>Clearcode<font color="#000080">,       </font><font color="#008000"><i>{GIF clear code.}
  </i></font>Bitmask<font color="#000080">,         </font><font color="#008000"><i>{Used during read from compressed file.}
  </i></font>Maxcode<font color="#000080">,         </font><font color="#008000"><i>{Decompressor limiting value for current code size.}
  </i></font>FirstFree<font color="#000080">,       </font><font color="#008000"><i>{First free code, generated per GIF spec.}
  </i></font>Codesize<font color="#000080">,        </font><font color="#008000"><i>{Size of code, computed from GIF header.}
  </i></font>Readmask<font color="#000080">,        </font><font color="#008000"><i>{Code AND mask for current code size.}
  </i></font>EOFCode<font color="#000080">,         </font><font color="#008000"><i>{GIF end-of-information code.}
  </i></font>GIFPtr<font color="#000080">,          </font><font color="#008000"><i>{Index pointer for GIFStuff ARRAY.}
  </i></font>RasterPtr<font color="#000080">,       </font><font color="#008000"><i>{Index pointer for Raster ARRAY.}
  </i></font>BufSize<font color="#000080">,         </font><font color="#008000"><i>{Size of GIFStuff and Raster ARRAY.}
  </i></font>Work             <font color="#008000"><i>{Utility}
  </i></font><font color="#000080">: </font>word<font color="#000080">;

  </font>BitsPerPixel<font color="#000080">,    </font><font color="#008000"><i>{Bits per pixel, read from GIF header.}
  </i></font>Resolution<font color="#000080">,      </font><font color="#008000"><i>{Resolution, read from GIF header.}
  </i></font>Background<font color="#000080">,      </font><font color="#008000"><i>{Background color, read from GIF header.}
  </i></font>InitCodeSize<font color="#000080">,    </font><font color="#008000"><i>{Starting code size, used during Clear.}
  </i></font>BlockPtr<font color="#000080">,        </font><font color="#008000"><i>{Index pointer for a block in GIFStuff ARRAY.}
  </i></font>BlockSize<font color="#000080">,       </font><font color="#008000"><i>{Size of current block in GIFStuff ARRAY.}
  </i></font>SelectMode       <font color="#008000"><i>{Video mode.}
  </i></font><font color="#000080">: </font>byte<font color="#000080">;

  </font>key <font color="#000080">: </font>char<font color="#000080">;      </font><font color="#008000"><i>{Keyboard input.}

  </i></font>ZeroBitOffset    <font color="#008000"><i>{Used when calling ReadRaster the first time.}
  </i></font><font color="#000080">: </font>longint<font color="#000080">;

  </font>ColorMap<font color="#000080">,        </font><font color="#008000"><i>{True if colormap present.}
  </i></font>Interlace<font color="#000080">,       </font><font color="#008000"><i>{True if interlaced image.}
  </i></font>Clear<font color="#000080">,           </font><font color="#008000"><i>{True during clear.}
  </i></font>First
  <font color="#000080">: </font>boolean<font color="#000080">;

  </font><font color="#008000"><i>{The global colormap read from the GIF header.}
  </i></font>Red<font color="#000080">,</font>Green<font color="#000080">,</font>Blue <font color="#000080">: </font>PaletteType<font color="#000080">;      </font><font color="#008000"><i>{Original colormap read from GIF header.}
  </i></font>R<font color="#000080">,</font>G<font color="#000080">,</font>B          <font color="#000080">: </font>PaletteType<font color="#000080">;    </font><font color="#008000"><i>{Real colors calculated by CalcRealColors.}

  </i></font>Search         <font color="#000080">: </font>searchrec<font color="#000080">;

</font><font color="#008000"><i>{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>nlzw<font color="#000080">; </font><font color="#FF0000"><b>external</b></font><font color="#000080">;
</font><font color="#008000"><i>{Decompress and show picture.}

</i></font><font color="#FF0000"><b>procedure </b></font>unblockraster<font color="#000080">; </font><font color="#FF0000"><b>external</b></font><font color="#000080">;
</font><font color="#008000"><i>{Unblock Rasterdata from GIFStuff to Raster.}

{****************************************************************************}

</i></font><font color="#FF0000"><b>function </b></font>DetermineVideoMode <font color="#000080">(</font>Width<font color="#000080">,</font>Height <font color="#000080">: </font>word<font color="#000080">) : </font>byte<font color="#000080">;
</font><font color="#008000"><i>{Determine which videomode to display picture in.}

</i></font><font color="#FF0000"><b>var
  </b></font>Mode <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>mode <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                 </font><font color="#008000"><i>{No videomode selected.}

  </i></font><font color="#FF0000"><b>if </b></font>Width <font color="#000080">&lt;= </font><font color="#800000">640 </font><font color="#FF0000"><b>then
  begin
    if </b></font>Height <font color="#000080">&lt;= </font><font color="#800000">480 </font><font color="#FF0000"><b>then </b></font>Mode <font color="#000080">:= </font>Select640x480x256<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Width <font color="#000080">&lt;= </font><font color="#800000">512 </font><font color="#FF0000"><b>then
  begin
    if </b></font>Height <font color="#000080">&lt;= </font><font color="#800000">480 </font><font color="#FF0000"><b>then </b></font>Mode <font color="#000080">:= </font>Select512x480x256<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Width <font color="#000080">&lt;= </font><font color="#800000">360 </font><font color="#FF0000"><b>then
  begin
    if </b></font>Height <font color="#000080">&lt;= </font><font color="#800000">480 </font><font color="#FF0000"><b>then </b></font>Mode <font color="#000080">:= </font>Select360x480x256<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Width <font color="#000080">&lt;= </font><font color="#800000">320 </font><font color="#FF0000"><b>then
  begin
    if </b></font>Height <font color="#000080">&lt;= </font><font color="#800000">400 </font><font color="#FF0000"><b>then </b></font>Mode <font color="#000080">:= </font>Select320x400x256<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Height <font color="#000080">&lt;= </font><font color="#800000">200 </font><font color="#FF0000"><b>then </b></font>Mode <font color="#000080">:= </font>Select320x200x256<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>DetermineVideoMode <font color="#000080">:= </font>mode<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{DetermineVideoMode}

{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>Terminate <font color="#000080">(</font>errormsg <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>textmode<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
  </font>writeln <font color="#000080">(</font>errormsg<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>GIFStuff <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>freemem <font color="#000080">(</font>GIFStuff<font color="#000080">,</font>BufSize<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Raster <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>freemem <font color="#000080">(</font>Raster<font color="#000080">,</font>BufSize<font color="#000080">);
  </font>halt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Terminate}

{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>AllocMem <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>P<font color="#000080">:</font>BufferP<font color="#000080">);
</font><font color="#008000"><i>{Allocate memory for GIFStuff- or RasterArray.}

</i></font><font color="#FF0000"><b>begin
  If </b></font>BufSize <font color="#000080">&gt; </font>MaxAvail <font color="#FF0000"><b>then
  begin
    </b></font>textmode <font color="#000080">(</font><font color="#800000">15</font><font color="#000080">);
    </font>Terminate <font color="#000080">(</font><font color="#800000">'Out of memory!'</font><font color="#000080">);
  </font><font color="#FF0000"><b>end else
    </b></font>getmem <font color="#000080">(</font>P<font color="#000080">,</font>BufSize<font color="#000080">);                     </font><font color="#008000"><i>{Allocate memory.}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{AllocMem}

{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>ReadMore<font color="#000080">;
</font><font color="#008000"><i>{Read more data from GIFFile into GIFStuff array.}

</i></font><font color="#FF0000"><b>var
  </b></font>BytesRead  <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>GIFPtr <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                              </font><font color="#008000"><i>{Point on first byte in GIFStuff.}
  </i></font>blockread<font color="#000080">(</font>GIFFile<font color="#000080">,</font>GIFStuff<font color="#000080">^,</font>BufSize<font color="#000080">,</font>BytesRead<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN </b></font>Terminate <font color="#000080">(</font><font color="#800000">'Error reading from file'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ReadMore}

{****************************************************************************}

</i></font><font color="#FF0000"><b>function </b></font>GetByte <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#008000"><i>{Get next byte from GIFStuff array. Call Readmore if end of GIFStuff.}

</i></font><font color="#FF0000"><b>begin
  </b></font>GetByte <font color="#000080">:= </font>GIFStuff<font color="#000080">^[</font>GIFPtr<font color="#000080">];
  </font>GIFPtr  <font color="#000080">:= </font>succ<font color="#000080">(</font>GIFPtr<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>GIFPtr <font color="#000080">= </font>BufSize <font color="#FF0000"><b>then </b></font>ReadMore<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{GetByte}

{****************************************************************************}

</i></font><font color="#FF0000"><b>function </b></font>GetWord <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#008000"><i>{Get a word from GIFStuff array. Read low byte first, and then highbyte.}

</i></font><font color="#FF0000"><b>var
  </b></font>low<font color="#000080">,</font>high <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>low  <font color="#000080">:= </font>GetByte<font color="#000080">;
  </font>high <font color="#000080">:= </font>GetByte<font color="#000080">;
  </font>GetWord <font color="#000080">:= </font>high<font color="#000080">*</font><font color="#800000">256</font><font color="#000080">+</font>low<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{GetWord}

{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>ReadRaster <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>BitOffset <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#008000"><i>{When unblocking Rasterdata, &quot;ReadRaster&quot; prepares RasterArray and RasterPtr}
{before &quot;UnblockRaster&quot; is called.}

</i></font><font color="#FF0000"><b>var
  </b></font>ByteOffset <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>ByteOffset <font color="#000080">:= </font>BitOffset <font color="#FF0000"><b>div </b></font><font color="#800000">8</font><font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>ByteOffset <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>BlockSize <font color="#000080">:= </font>GetByte<font color="#000080">;
    </font>BlockPtr  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>RasterPtr <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end else
  begin
    </b></font><font color="#008000"><i>{Move the last bytes in RasterArray to the start of RasterArray.}
    {This must be done because readcode who calls this procedure, does}
    {not always read to the end of RasterArray. Also remember to set}
    {RasterPtr to number of bytes moved, so they are not overwritten}
    {when unblocking new rasterdata from GIFStuff.}
    </i></font>move<font color="#000080">(</font>Raster<font color="#000080">^[</font>ByteOffset<font color="#000080">],</font>Raster<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">],</font>BufSize<font color="#000080">-</font>ByteOffset<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
    </font>BitOffset <font color="#000080">:= </font>BitOffset <font color="#FF0000"><b>mod </b></font><font color="#800000">8</font><font color="#000080">;        </font><font color="#008000"><i>{If BitOffset was odd to ByteOffset.}
    </i></font>RasterPtr <font color="#000080">:= </font>BufSize<font color="#000080">-</font>ByteOffset<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>UnblockRaster<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ReadRaster}

{****************************************************************************}

</i></font><font color="#FF0000"><b>function </b></font>ValidGIFFile <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{Check if file really is a GIFfile. This is done by checking if the}
{first 6 bytes of the GIFfile matches the string: 'GIF87a'.}

</i></font><font color="#FF0000"><b>var
  </b></font>idstring <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">6</font><font color="#000080">];
  </font>cnt      <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>idstring <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>cnt <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">6 </font><font color="#FF0000"><b>do
    </b></font>idstring <font color="#000080">:= </font>idstring <font color="#000080">+ </font>chr<font color="#000080">(</font>GetByte<font color="#000080">);
  </font>ValidGIFFile <font color="#000080">:= </font>idstring <font color="#000080">= </font><font color="#800000">'GIF87a'</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ValidGIFFile}

{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>CalcRealColors <font color="#000080">(</font>Colors <font color="#000080">: </font>word<font color="#000080">; </font>Intensity <font color="#000080">: </font>byte<font color="#000080">;
                          </font><font color="#FF0000"><b>var </b></font>R<font color="#000080">,</font>G<font color="#000080">,</font>B <font color="#000080">: </font>PaletteType<font color="#000080">);
</font><font color="#008000"><i>{Colors from global colormap can't be used directly in the video DAC, }
{therefore new values are computed here.}

</i></font><font color="#FF0000"><b>var
  </b></font>Cnt <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  for </b></font>Cnt <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Colors<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
  begin
    </b></font>R<font color="#000080">[</font>Cnt<font color="#000080">] := </font>round <font color="#000080">(</font>Intensity<font color="#000080">*(</font>Red<font color="#000080">[</font>Cnt<font color="#000080">] / </font><font color="#800000">255</font><font color="#000080">));
    </font>G<font color="#000080">[</font>Cnt<font color="#000080">] := </font>round <font color="#000080">(</font>Intensity<font color="#000080">*(</font>Green<font color="#000080">[</font>Cnt<font color="#000080">] / </font><font color="#800000">255</font><font color="#000080">));
    </font>B<font color="#000080">[</font>Cnt<font color="#000080">] := </font>round <font color="#000080">(</font>Intensity<font color="#000080">*(</font>Blue<font color="#000080">[</font>Cnt<font color="#000080">] / </font><font color="#800000">255</font><font color="#000080">));
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{CalcRealColors}

{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>ReprogramDAC <font color="#000080">(</font>Colors <font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>R<font color="#000080">,</font>G<font color="#000080">,</font>B <font color="#000080">: </font>PaletteType<font color="#000080">);
</font><font color="#008000"><i>{Sets the colorpalette in the video DAC.}

</i></font><font color="#FF0000"><b>var
  </b></font>Cnt <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>port<font color="#000080">[</font><font color="#800000">$03c4</font><font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;                   </font><font color="#008000"><i>{Select Clocking Mode Register.}
  </i></font>port<font color="#000080">[</font><font color="#800000">$03c5</font><font color="#000080">] := </font>port<font color="#000080">[</font><font color="#800000">$03c5</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">32</font><font color="#000080">;   </font><font color="#008000"><i>{Turn Screen Off. (Prevent snow)}

  </i></font>port<font color="#000080">[</font><font color="#800000">$03c8</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;                   </font><font color="#008000"><i>{Color register 0 of 256.}
  </i></font><font color="#FF0000"><b>inline </b></font><font color="#000080">(</font><font color="#800000">$fa</font><font color="#000080">);                       </font><font color="#008000"><i>{cli, CLear Interrupts.}
  </i></font><font color="#FF0000"><b>for </b></font>Cnt <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Colors<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
  begin
    </b></font>port<font color="#000080">[</font><font color="#800000">$03c9</font><font color="#000080">] := </font>R<font color="#000080">[</font>cnt<font color="#000080">];
    </font>port<font color="#000080">[</font><font color="#800000">$03c9</font><font color="#000080">] := </font>G<font color="#000080">[</font>cnt<font color="#000080">];
    </font>port<font color="#000080">[</font><font color="#800000">$03c9</font><font color="#000080">] := </font>B<font color="#000080">[</font>cnt<font color="#000080">];
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>inline </b></font><font color="#000080">(</font><font color="#800000">$fb</font><font color="#000080">);                       </font><font color="#008000"><i>{sti, SeT Interrupts.}

  </i></font>port<font color="#000080">[</font><font color="#800000">$03c4</font><font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;                   </font><font color="#008000"><i>{Select Clocking Mode Register.}
  </i></font>port<font color="#000080">[</font><font color="#800000">$03c5</font><font color="#000080">] := </font>port<font color="#000080">[</font><font color="#800000">$03c5</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">223</font><font color="#000080">; </font><font color="#008000"><i>{Turn Screen On.}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ReprogramDAC}

{****************************************************************************}

</i></font><font color="#FF0000"><b>procedure </b></font>DoClear<font color="#000080">;
</font><font color="#008000"><i>{This procedure is called by NLZW when a clearcode is picked up.}

</i></font><font color="#FF0000"><b>begin
  </b></font>CodeSize <font color="#000080">:= </font>InitCodeSize<font color="#000080">;
  </font>MaxCode  <font color="#000080">:= </font>MaxCodes <font color="#000080">[</font>CodeSize<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">];
  </font>FreeCode <font color="#000080">:= </font>FirstFree<font color="#000080">;
  </font>ReadMask <font color="#000080">:= (</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>CodeSize<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{DoClear}

{****************************************************************************}

</i></font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{ main program }
  </i></font>BufSize  <font color="#000080">:= </font>BufferSize<font color="#000080">;
  </font>GIFStuff <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>Raster   <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>First    <font color="#000080">:= </font>true<font color="#000080">;

  </font>writeln <font color="#000080">(</font><font color="#800000">'GifView V1.0, by Lars Fastrup Nielsen, March 1991'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>paramcount <font color="#000080">&lt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then
    </b></font>Terminate <font color="#000080">(</font><font color="#800000">'USAGE: &lt;filename.gif&gt;  *,? wildcards ok!'</font><font color="#000080">);

  </font>AllocMem <font color="#000080">(</font>GIFStuff<font color="#000080">);
  </font>AllocMem <font color="#000080">(</font>Raster<font color="#000080">);

  </font>findfirst <font color="#000080">(</font>PARAMSTR<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">),</font>anyfile<font color="#000080">,</font>Search<font color="#000080">);
  </font><font color="#FF0000"><b>while </b></font>doserror <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    </b></font>assign <font color="#000080">(</font>GIFFile<font color="#000080">,</font>Search<font color="#000080">.</font>name<font color="#000080">);
    </font>reset <font color="#000080">(</font>GIFFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Terminate <font color="#000080">(</font><font color="#800000">'Error opening GIF-file!!'</font><font color="#000080">);
    </font>ReadMore<font color="#000080">;
    </font><font color="#FF0000"><b>if NOT </b></font>ValidGIFFile <font color="#FF0000"><b>then </b></font>Terminate <font color="#000080">(</font><font color="#800000">'Not a GIF-file!!'</font><font color="#000080">);

    </font>RasterWidth  <font color="#000080">:= </font>GetWord<font color="#000080">;
    </font>RasterHeight <font color="#000080">:= </font>GetWord<font color="#000080">;

    </font><font color="#008000"><i>{Get the packed byte immediately following and decode it. JG}
    </i></font>Work <font color="#000080">:= </font>GetByte<font color="#000080">;
    </font>ColorMap <font color="#000080">:= (</font>Work <font color="#FF0000"><b>AND </b></font><font color="#800000">$80</font><font color="#000080">) = </font><font color="#800000">$80</font><font color="#000080">;
    </font>Resolution <font color="#000080">:= (</font>Work <font color="#FF0000"><b>and </b></font><font color="#800000">$70 </font><font color="#FF0000"><b>shr </b></font><font color="#800000">5</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
    </font>BitsPerPixel <font color="#000080">:= (</font>Work <font color="#FF0000"><b>and </b></font><font color="#800000">7</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
    </font>BitMask <font color="#000080">:= (</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>BitsPerPixel<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">;
    </font>Background <font color="#000080">:= </font>GetByte<font color="#000080">;
    </font>Work <font color="#000080">:= </font>GetByte<font color="#000080">;        </font><font color="#008000"><i>{ Skip '0' }

    {Determine number of colors in picture.}
    </i></font>ColorMapSize <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>BitsPerPixel<font color="#000080">;

    </font><font color="#008000"><i>{Read global colormap if one present.}
    </i></font><font color="#FF0000"><b>if </b></font>ColorMap <font color="#FF0000"><b>then
    begin
      for </b></font>Work <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>ColorMapSize<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
      begin
        </b></font>Red<font color="#000080">[</font>Work<font color="#000080">]   := </font>GetByte<font color="#000080">;
        </font>Green<font color="#000080">[</font>Work<font color="#000080">] := </font>GetByte<font color="#000080">;
        </font>Blue<font color="#000080">[</font>Work<font color="#000080">]  := </font>GetByte<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>CalcRealColors <font color="#000080">(</font>ColorMapSize<font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,</font>R<font color="#000080">,</font>G<font color="#000080">,</font>B<font color="#000080">);
    </font><font color="#FF0000"><b>end else
      </b></font>Terminate <font color="#000080">(</font><font color="#800000">'I can only process GIF pictures with global colormap'</font><font color="#000080">);

    </font><font color="#FF0000"><b>if </b></font>chr<font color="#000080">(</font>GetByte<font color="#000080">) &lt;&gt; </font><font color="#800000">',' </font><font color="#FF0000"><b>then </b></font>Terminate <font color="#000080">(</font><font color="#800000">'Bad image separator!'</font><font color="#000080">);

    </font><font color="#008000"><i>{Now read the values from the image descriptor. JG}
    </i></font>ImageLeft   <font color="#000080">:= </font>GetWord<font color="#000080">;       </font><font color="#008000"><i>{Left offset, ignored by this program.}
    </i></font>ImageTop    <font color="#000080">:= </font>GetWord<font color="#000080">;       </font><font color="#008000"><i>{Top offset, also ignored here.}
    </i></font>ImageWidth  <font color="#000080">:= </font>GetWord<font color="#000080">;       </font><font color="#008000"><i>{The actual width of picture. Used by NLZW.}
    </i></font>ImageHeight <font color="#000080">:= </font>GetWord<font color="#000080">;       </font><font color="#008000"><i>{The actual height of picture. Ignored.}
    </i></font>Work <font color="#000080">:= </font>GetByte<font color="#000080">;

    </font><font color="#008000"><i>{Determine wether picture is interlaced or not.}
    </i></font>Interlace <font color="#000080">:= (</font>Work <font color="#FF0000"><b>and </b></font><font color="#800000">$40</font><font color="#000080">) = </font><font color="#800000">$40</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Interlace <font color="#FF0000"><b>then
      </b></font>Terminate <font color="#000080">(</font><font color="#800000">'Displaying interlaced pictures not supported yet!'</font><font color="#000080">);

    </font><font color="#008000"><i>{Start reading the raster data. First we get the intial code size. JG}
    </i></font>CodeSize <font color="#000080">:= </font>GetByte<font color="#000080">;

    </font><font color="#008000"><i>{Compute decompressor constant values based on the codesize. JG}
    </i></font>ClearCode <font color="#000080">:= </font>PowersOf2<font color="#000080">[</font>CodeSize<font color="#000080">];
    </font>EOFCode <font color="#000080">:= </font>ClearCode<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
    </font>FirstFree <font color="#000080">:= </font>ClearCode<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">;
    </font>FreeCode <font color="#000080">:= </font>FirstFree<font color="#000080">;

    </font><font color="#008000"><i>{The GIF spec has it that the code size used to compute the above values}
    {is the code size given in the file, but the code size used in}
    {compression/decompression is the code size given in the file plus one. JG}
    </i></font>CodeSize <font color="#000080">:= </font>succ<font color="#000080">(</font>CodeSize<font color="#000080">);
    </font>InitCodeSize <font color="#000080">:= </font>CodeSize<font color="#000080">;
    </font>MaxCode <font color="#000080">:= </font>MaxCodes<font color="#000080">[</font>CodeSize<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">];
    </font>ReadMask <font color="#000080">:= (</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>CodeSize<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">;

    </font><font color="#008000"><i>{I don't know why i can't call ReadRaster(0) but the compiler wont}
    {accept that. So it was nessesary to create the ZeroBitOffset variable.}
    {It is only a dummy variable and is only used here.}
    </i></font>ZeroBitOffset <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>ReadRaster <font color="#000080">(</font>ZeroBitOffset<font color="#000080">);   

    </font><font color="#FF0000"><b>if not </b></font>First <font color="#FF0000"><b>then </b></font>delay <font color="#000080">(</font><font color="#800000">7000</font><font color="#000080">);
    </font>First <font color="#000080">:= </font>false<font color="#000080">;

    </font>SelectMode <font color="#000080">:= </font>DetermineVideoMode<font color="#000080">(</font>RasterWidth<font color="#000080">,</font>RasterHeight<font color="#000080">);
    </font><font color="#FF0000"><b>case </b></font>SelectMode <font color="#FF0000"><b>of
      </b></font>Select320x200x256 <font color="#000080">: </font>SetMode<font color="#000080">(</font>mode320x200x256<font color="#000080">);
      </font>Select320x400x256 <font color="#000080">: </font>SetMode<font color="#000080">(</font>mode320x400x256<font color="#000080">);
      </font>Select360x480x256 <font color="#000080">: </font>SetMode<font color="#000080">(</font>mode360x480x256<font color="#000080">);
      </font>Select512x480x256 <font color="#000080">: </font>SetMode<font color="#000080">(</font>mode360x480x256<font color="#000080">);
      </font>Select640x480x256 <font color="#000080">: </font>SetMode<font color="#000080">(</font>mode360x480x256<font color="#000080">);
    </font><font color="#FF0000"><b>else
      </b></font>Terminate <font color="#000080">(</font><font color="#800000">'Picture does not fit on any modes!'</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>ReprogramDAC <font color="#000080">(</font>ColorMapSize<font color="#000080">,</font>R<font color="#000080">,</font>G<font color="#000080">,</font>B<font color="#000080">);      </font><font color="#008000"><i>{Set the color palette.}

    </i></font>Clear <font color="#000080">:= </font>false<font color="#000080">;
    </font>nlzw<font color="#000080">;

    </font>close<font color="#000080">(</font>GIFFile<font color="#000080">);
    </font>findnext <font color="#000080">(</font>Search<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ while }

  </i></font>sound <font color="#000080">(</font><font color="#800000">1800</font><font color="#000080">); </font>delay <font color="#000080">(</font><font color="#800000">40</font><font color="#000080">);
  </font>sound <font color="#000080">(</font><font color="#800000">1500</font><font color="#000080">); </font>delay <font color="#000080">(</font><font color="#800000">40</font><font color="#000080">);
  </font>nosound<font color="#000080">;

  </font><font color="#FF0000"><b>repeat until </b></font>readkey<font color="#000080">=</font><font color="#800000">#13</font><font color="#000080">;

  </font>textmode <font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
  </font>freemem <font color="#000080">(</font>GIFStuff<font color="#000080">,</font>BufSize<font color="#000080">);
  </font>freemem <font color="#000080">(</font>Raster<font color="#000080">,</font>BufSize<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0208.PAS">Original</a><b>]</b></p></body>
</html>
