<html>
<head><title> "Full featured VESA Unit" by LIONEL CORDESSES</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0277.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ see the demo at the end of this unit }
(*
*****************************************************************************

  Copyright (C) 1995 Lionel CORDESSES

  This source is a part of a program that  allows you to read and display
a color or a black and  white  JPEG picture . I wrote the  full source in
order to understand how  it  works . Some  parts  are  translated  from C
language to Pascal (the reverse DCT for instance ).
	I used many sources of informations:
        - &quot;The JPEG Still Picture Compression Standart&quot; by G.K.Wallace,
        - C sources and doc from the Independent JPEG Group's software,
        - C sources and doc from  the Portable  Video Research Group (PVRG)
	code,
        - the FAQ about JPEG,
        - &quot;JPEG Compression&quot; by C.Cavigioli (ANALOG DEVICE application note
        AN-336B )
	- and many others ...

    You  can use , modified and distribute this source as long as credit is
given.

*****************************************************************************
*)

{
****************************************************************************

      Here is an other VESA unit !!!!!!

      It is based on various sources ( DVPEG,John Bridges VGAKIT,
    SWAG an many others ).
      You can use,modified an distribute this source as long as credit
    is given.


    Supported modes:
      - 256 colors
      - 32768 colors
      - 16 millions colors


    The demo program for this unit is DemoVesa.

                                              Lionel Cordesses
                                              From FRANCE.
                                              June 1995

****************************************************************************
}
</i></font><font color="#FF0000"><b>unit </b></font>usvesa3<font color="#000080">;
</font><font color="#FF0000"><b>interface

uses </b></font>dos<font color="#000080">,</font>crt<font color="#000080">;


</font><font color="#FF0000"><b>var

  </b></font>use_16<font color="#000080">,</font>use_32<font color="#000080">:</font>boolean<font color="#000080">;
  </font>x_size<font color="#000080">:</font>word<font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>write_fast_16<font color="#000080">(</font>x1<font color="#000080">,</font>y<font color="#000080">,</font>x2<font color="#000080">,</font>indice<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>rouge<font color="#000080">,</font>vert<font color="#000080">,</font>bleu<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>get_time<font color="#000080">:</font>longint<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>write_fast<font color="#000080">(</font>x1<font color="#000080">,</font>y<font color="#000080">,</font>x2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>entree<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>getpix_16<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>rouge<font color="#000080">,</font>vert<font color="#000080">,</font>bleu<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>find_black<font color="#000080">(</font>max_color<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>black<font color="#000080">,</font>white<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>setmode<font color="#000080">(</font>mode<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">;  </font><font color="#008000"><i>{ return 0 if bad, 1 if OK }
</i></font><font color="#FF0000"><b>Procedure </b></font>setpix<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>col<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>setpix_16<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font>rouge<font color="#000080">,</font>vert<font color="#000080">,</font>bleu<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>getpix<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>wrtxt<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font>txt<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">);</font><font color="#008000"><i>{write TXT to pos (X,Y)}

</i></font><font color="#FF0000"><b>Function </b></font>write_fast_16_BRG<font color="#000080">(</font>x1<font color="#000080">,</font>y<font color="#000080">,</font>x2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>image<font color="#000080">):</font>boolean<font color="#000080">;





</font><font color="#FF0000"><b>implementation


var
  </b></font>reg<font color="#000080">:</font>registers<font color="#000080">;
  </font>vgran<font color="#000080">,</font>curbank<font color="#000080">:</font>word<font color="#000080">;
  </font>add_bank<font color="#000080">:</font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;
  </font>tps1<font color="#000080">,</font>tps2<font color="#000080">:</font>longint<font color="#000080">;
  </font>heure<font color="#000080">,</font>minute<font color="#000080">,</font>seconde<font color="#000080">,</font>sec100<font color="#000080">:</font>word<font color="#000080">;

  </font>bytes<font color="#000080">:</font>word<font color="#000080">;





</font><font color="#008000"><i>{$ifdef msdos}
</i></font><font color="#FF0000"><b>Procedure </b></font>setbank<font color="#000080">(</font>bank<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>banque<font color="#000080">:</font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>banque<font color="#000080">:=</font>bank<font color="#000080">*</font>longint<font color="#000080">(</font><font color="#800000">64</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>vgran<font color="#000080">;
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov bx, 0
      mov dx, banque
      call  [add_bank]
      mov bx, 1
      mov dx, banque
      call  [add_bank]

    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>curbank<font color="#000080">:=</font>bank<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$else}

</i></font><font color="#FF0000"><b>Procedure </b></font>setbank<font color="#000080">(</font>bank<font color="#000080">:</font>byte<font color="#008000"><i>{word}</i></font><font color="#000080">);</font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>banque<font color="#000080">:</font>word<font color="#000080">;

  </font><font color="#FF0000"><b>begin
             </b></font>reg<font color="#000080">.</font>ax<font color="#000080">:=</font><font color="#800000">$4f05</font><font color="#000080">;
             </font>reg<font color="#000080">.</font>bx<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
             </font>reg<font color="#000080">.</font>dx<font color="#000080">:=</font>bank<font color="#000080">*</font>longint<font color="#000080">(</font><font color="#800000">64</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>vgran<font color="#000080">;

             </font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>reg<font color="#000080">);
             </font>reg<font color="#000080">.</font>ax<font color="#000080">:=</font><font color="#800000">$4f05</font><font color="#000080">;
             </font>reg<font color="#000080">.</font>bx<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
             </font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>reg<font color="#000080">);

  </font>curbank<font color="#000080">:=</font>bank<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$endif}



</i></font><font color="#FF0000"><b>Function </b></font>setvesa<font color="#000080">(</font>mode<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">;

  </font><font color="#FF0000"><b>begin
    asm
     </b></font><font color="#FF00FF">mov ax,4F02h
     mov bx,mode
     int 10h
     sub ax,004Fh
     mov @RESULT,al
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#008000"><i>{$ifdef msdos}
</i></font><font color="#FF0000"><b>Function </b></font>setmode<font color="#000080">(</font>mode<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">;  </font><font color="#008000"><i>{ 0 if bad,1 if OK}
</i></font><font color="#FF0000"><b>type </b></font>type_vesarec<font color="#000080">=</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">555</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
     </font>ves_ptr<font color="#000080">=^</font>type_vesarec<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>long<font color="#000080">=</font><font color="#FF0000"><b>record
         </b></font>lo<font color="#000080">,</font>hi<font color="#000080">:</font>word<font color="#000080">;
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>pro<font color="#000080">:</font>byte<font color="#000080">;
    </font>vesarec<font color="#000080">:</font>ves_ptr<font color="#000080">;

    </font>vesa_info<font color="#000080">:</font><font color="#FF0000"><b>record
      </b></font>debut<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
      </font>granularite<font color="#000080">:</font>word<font color="#000080">;
      </font>winsize<font color="#000080">,
      </font>winaseg<font color="#000080">,
      </font>winbseg<font color="#000080">:</font>word<font color="#000080">;
      </font>add_proc<font color="#000080">:</font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;
      </font>bytes<font color="#000080">:</font>word<font color="#000080">;
      </font>width<font color="#000080">,
      </font>height<font color="#000080">:</font>word<font color="#000080">;
      </font>char_width<font color="#000080">,
      </font>char_high<font color="#000080">,
      </font>planes<font color="#000080">,
      </font>bits_per_pixel<font color="#000080">:</font>byte<font color="#000080">;
      </font>reste<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">250</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


  </font><font color="#FF0000"><b>begin
    </b></font>setmode<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
    </font>getmem<font color="#000080">(</font>vesarec<font color="#000080">,</font><font color="#800000">556</font><font color="#000080">);
    </font>pro<font color="#000080">:=</font>setvesa<font color="#000080">(</font>mode<font color="#000080">);
    </font>fillchar<font color="#000080">(</font>vesarec<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">],</font><font color="#800000">256</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">); </font><font color="#008000"><i>{ set all to zero  }

      </i></font>reg<font color="#000080">.</font>ax<font color="#000080">:=</font><font color="#800000">$4f01</font><font color="#000080">;
      </font>reg<font color="#000080">.</font>cx<font color="#000080">:=</font>mode<font color="#000080">;
      </font>reg<font color="#000080">.</font>es<font color="#000080">:=</font>long<font color="#000080">(</font>vesarec<font color="#000080">).</font>hi<font color="#000080">;
      </font>reg<font color="#000080">.</font>di<font color="#000080">:=</font>long<font color="#000080">(</font>vesarec<font color="#000080">).</font>lo<font color="#000080">;

      </font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>reg<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>reg<font color="#000080">.</font>ah<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
        begin
          </b></font>setmode<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
          </font>pro<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
        </font><font color="#FF0000"><b>end
      else
        begin
          </b></font>setmode<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
          </font>pro<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>move<font color="#000080">(</font>vesarec<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">],</font>vesa_info<font color="#000080">.</font>debut<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">],</font><font color="#800000">256</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>reg<font color="#000080">.</font>al<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
        begin
          </b></font>setmode<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
          </font>pro<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>vgran<font color="#000080">:=</font>vesa_info<font color="#000080">.</font>granularite<font color="#000080">;
      </font><font color="#008000"><i>{ nb pixel per lines }
      </i></font><font color="#FF0000"><b>if </b></font>pro<font color="#000080">=</font><font color="#800000">1 </font><font color="#FF0000"><b>then
        </b></font>x_size<font color="#000080">:=</font>vesa_info<font color="#000080">.</font>bytes <font color="#000080">;
      </font>add_bank<font color="#000080">:=</font>vesa_info<font color="#000080">.</font>add_proc<font color="#000080">;        </font><font color="#008000"><i>{ change bank far ptr }
{      x_size:=vesa_info.bytes;}

    </i></font>freemem<font color="#000080">(</font>vesarec<font color="#000080">,</font><font color="#800000">556</font><font color="#000080">);

    </font>use_16<font color="#000080">:=</font>false<font color="#000080">;
    </font>use_32<font color="#000080">:=</font>false<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>mode<font color="#000080">=</font><font color="#800000">$112 </font><font color="#FF0000"><b>then </b></font>use_16<font color="#000080">:=</font>true<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>mode<font color="#000080">=</font><font color="#800000">$110 </font><font color="#FF0000"><b>then </b></font>use_32<font color="#000080">:=</font>true<font color="#000080">;




  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{$endif}

</i></font><font color="#FF0000"><b>Procedure </b></font>setpix<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>col<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var  </b></font>decalage<font color="#000080">:</font>word<font color="#000080">;
      </font><font color="#FF0000"><b>asm
</b></font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,x
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax,y</font>	<font color="#008000"><i>{removed all range checking on x,y for speed}
</i></font>	<font color="#FF00FF">mul</font>	<font color="#FF00FF">x_size</font>	<font color="#008000"><i>{640 bytes wide in most cases}
</i></font>	<font color="#FF00FF">add</font>	<font color="#FF00FF">bx,ax
</font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">dx,0
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax, dx</font>	<font color="#008000"><i>{ what a $#%%# stupid microprocessor}
</i></font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">ax, 0

        </font><font color="#008000"><i>{mov provi,al}   { bank  }
        </i></font><font color="#FF00FF">mov decalage,bx
        cmp ax,curbank
        jz @nonew
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{ here ax = bank }
        </i></font><font color="#FF00FF">@nonew:

          mov bx,col
          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov [es:di],bl
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>getpix_16<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>rouge<font color="#000080">,</font>vert<font color="#000080">,</font>bleu<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>l<font color="#000080">:</font>longint<font color="#000080">;
    </font>provi<font color="#000080">:</font>byte<font color="#000080">;
    </font>couleur<font color="#000080">,</font>decalage<font color="#000080">:</font>word<font color="#000080">;

      </font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov al,use_16
        cmp al,0
        je @v32000

</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,x
        mov ax,bx
        shl bx,1
        add bx,ax       </font><font color="#008000"><i>{ x*3 }
</i></font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax,y</font>	<font color="#008000"><i>{removed all range checking on x,y for speed}
        </i></font><font color="#FF00FF">shl ax,1
        add ax,y        </font><font color="#008000"><i>{ y*3 }
</i></font>	<font color="#FF00FF">mul</font>	<font color="#FF00FF">x_size</font>	<font color="#008000"><i>{640 bytes wide in most cases}
</i></font>	<font color="#FF00FF">add</font>	<font color="#FF00FF">bx,ax
</font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">dx,0
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax, dx</font>	<font color="#008000"><i>{ what a $#%%# stupid microprocessor}
</i></font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">ax, 0

        mov provi,al   </font><font color="#008000"><i>{ bank  }
        </i></font><font color="#FF00FF">mov decalage,bx
        cmp ax,curbank
        jz @nonewa
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{ here ax= bank }
        </i></font><font color="#FF00FF">@nonewa:

          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov bl,[es:di]
          les di,bleu
          mov byte ptr [es:di],bl

        add decalage,1
        mov ah,0
        mov al,provi
        adc ax,0
        mov provi,al
        cmp ax,curbank
        jz @nonew1
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{  ax = bank }
        </i></font><font color="#FF00FF">@nonew1:

          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov bl,[es:di]
          les di,vert
          mov byte ptr [es:di],bl

        add decalage,1
        mov ah,0
        mov al,provi
        adc ax,0
        cmp ax,curbank
        jz @nonew2
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{  ax= bank }
        </i></font><font color="#FF00FF">@nonew2:

          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov bl,[es:di]
          les di,rouge
          mov byte ptr [es:di],bl

          jmp @fin

      @v32000:
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,x
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax,y</font>	<font color="#008000"><i>{removed all range checking on x,y for speed}
</i></font>	<font color="#FF00FF">mul</font>	<font color="#FF00FF">x_size</font>	<font color="#008000"><i>{640 bytes wide in most cases}
</i></font>	<font color="#FF00FF">add</font>	<font color="#FF00FF">bx,ax
</font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">dx,0
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax, dx</font>	<font color="#008000"><i>{ what a $#%%# stupid microprocessor}
</i></font>	<font color="#FF00FF">shl</font>	<font color="#FF00FF">ax, 1
</font>	<font color="#FF00FF">shl</font>	<font color="#FF00FF">bx, 1
</font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">ax, 0   </font><font color="#008000"><i>{ pour untiliser un eventuel carry
                          positionne par precedent ADD }

        </i></font><font color="#FF00FF">mov provi,al   </font><font color="#008000"><i>{ bank  }
        </i></font><font color="#FF00FF">mov decalage,bx
        cmp ax,curbank
        je @nonew
</font><font color="#008000"><i>{        mov ah,0}
        </i></font><font color="#FF00FF">push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{  ax = bank }
        </i></font><font color="#FF00FF">@nonew:


        mov ax,sega000
        mov es,ax
        mov di,decalage
        mov bx,[es:di]
        mov al,bl
        and al,31
        shl al,3
        les di,bleu
        mov byte ptr [es:di],al
        shr bx,5
        mov al,bl
        and al,31
        shl al,3
        les di,vert
        mov byte ptr [es:di],al
        shr bx,5
        mov al,bl
        and al,31
        shl al,3
        les di,rouge
        mov byte ptr [es:di],al

        @fin:
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>Procedure </b></font>setpix_16<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font>rouge<font color="#000080">,</font>vert<font color="#000080">,</font>bleu<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>l<font color="#000080">:</font>longint<font color="#000080">;
    </font>provi<font color="#000080">:</font>byte<font color="#000080">;
    </font>couleur<font color="#000080">,</font>decalage<font color="#000080">:</font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    if </b></font>use_16<font color="#000080">=</font>true <font color="#FF0000"><b>then
      asm

</b></font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,x
        mov ax,bx
        shl bx,1
        add bx,ax       </font><font color="#008000"><i>{ x*3 }
</i></font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax,y</font>	<font color="#008000"><i>{removed all range checking on x,y for speed}
{        shl ax,1
        add ax,y}        { y }
</i></font>	<font color="#FF00FF">mul</font>	<font color="#FF00FF">x_size</font>	<font color="#008000"><i>{640 bytes wide in most cases}
</i></font>	<font color="#FF00FF">add</font>	<font color="#FF00FF">bx,ax
</font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">dx,0
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax, dx</font>	<font color="#008000"><i>{ what a $#%%# stupid microprocessor}
</i></font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">ax, 0

        mov provi,al   </font><font color="#008000"><i>{ bank  }
        </i></font><font color="#FF00FF">mov decalage,bx
        cmp ax,curbank
        jz @nonew
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{ ax= bank }
        </i></font><font color="#FF00FF">@nonew:

          mov bl,bleu
          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov [es:di],bl

        add decalage,1
        mov ah,0
        mov al,provi
        adc ax,0
        mov provi,al
        cmp ax,curbank
        jz @nonew1
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{  ax= bank }
        </i></font><font color="#FF00FF">@nonew1:

          mov bl,vert
          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov [es:di],bl

        add decalage,1
        mov ah,0
        mov al,provi
        adc ax,0
        cmp ax,curbank
        jz @nonew2
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{ ax= bank }
        </i></font><font color="#FF00FF">@nonew2:

          mov bl,rouge
          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov [es:di],bl


      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>use_32<font color="#000080">=</font>true <font color="#FF0000"><b>then
      asm
</b></font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,x
        shl     bx,1
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax,y</font>	<font color="#008000"><i>{removed all range checking on x,y for speed}
</i></font>	<font color="#FF00FF">mul</font>	<font color="#FF00FF">x_size</font>	<font color="#008000"><i>{640 bytes wide in most cases}
</i></font>	<font color="#FF00FF">add</font>	<font color="#FF00FF">bx,ax
</font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">dx,0
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax, dx</font>	<font color="#008000"><i>{ what a $#%%# stupid microprocessor}
{	shl	ax, 1
	shl	bx, 1}
</i></font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">ax, 0   </font><font color="#008000"><i>{ pour untiliser un eventuel carry
                          positionne par precedent ADD }

        </i></font><font color="#FF00FF">mov provi,al   </font><font color="#008000"><i>{ bank  }
        </i></font><font color="#FF00FF">mov decalage,bx
        cmp ax,curbank
        je @nonew
</font><font color="#008000"><i>{        mov ah,0}
        </i></font><font color="#FF00FF">push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{  ax= bank }
        </i></font><font color="#FF00FF">@nonew:


        mov al,rouge
        shr al,3
        mov ah,0
        shl ax,10
        mov bl,vert
        shr bl,3
        mov bh,0
        shl bx,5
        add ax,bx
        mov bl,bleu
        shr bl,3
        mov bh,0
        add bx,ax
        mov ax,sega000
        mov es,ax
        mov di,decalage
        mov [es:di],bx
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Move16<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Source<font color="#000080">,</font>Dest<font color="#000080">;</font>Count<font color="#000080">:</font>Word<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">PUSH DS
  LDS SI,SOURCE
  LES DI,DEST
  MOV AX,COUNT
  MOV CX,AX
  SHR CX,1
  REP MOVSW
  TEST AX,1
  JZ @</font><font color="#FF0000"><b>end
  </b></font>MOVSB
<font color="#000080">@</font><font color="#FF0000"><b>end</b></font><font color="#000080">:</font>POP DS
<font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>write_fast<font color="#000080">(</font>x1<font color="#000080">,</font>y<font color="#000080">,</font>x2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>entree<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>coord1<font color="#000080">,</font>coord2<font color="#000080">:</font>longint<font color="#000080">;
    </font>couleur<font color="#000080">:</font>byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>write_fast<font color="#000080">:=</font>false<font color="#000080">;
    </font>coord1<font color="#000080">:=</font>longint<font color="#000080">(</font>y<font color="#000080">)*</font>longint<font color="#000080">(</font>x_size<font color="#000080">)+</font>x1<font color="#000080">;
    </font>coord2<font color="#000080">:=</font>coord1<font color="#000080">+</font>longint<font color="#000080">((</font>x2<font color="#000080">-</font>x1<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)&lt;&gt; </font>curbank <font color="#FF0000"><b>then  </b></font>setbank<font color="#000080">(</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)=(</font>coord2 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
         </b></font>move16<font color="#000080">(</font>entree<font color="#000080">,</font>mem<font color="#000080">[</font>sega000<font color="#000080">:(</font>coord1 <font color="#FF0000"><b>mod </b></font><font color="#800000">65536</font><font color="#000080">)],(</font>x2<font color="#000080">-</font>x1<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">));
         </font>write_fast<font color="#000080">:=</font>true<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>get_time<font color="#000080">:</font>longint<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>heure<font color="#000080">,</font>minute<font color="#000080">,</font>seconde<font color="#000080">,</font>sec100<font color="#000080">:</font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>gettime<font color="#000080">(</font>heure<font color="#000080">,</font>minute<font color="#000080">,</font>seconde<font color="#000080">,</font>sec100<font color="#000080">);
    </font>get_time<font color="#000080">:=</font>heure<font color="#000080">*</font><font color="#800000">3600</font><font color="#000080">*</font><font color="#800000">100</font><font color="#000080">+</font>minute<font color="#000080">*</font><font color="#800000">60</font><font color="#000080">*</font><font color="#800000">100</font><font color="#000080">+</font>seconde<font color="#000080">*</font><font color="#800000">100</font><font color="#000080">+</font>sec100<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;




</font><font color="#FF0000"><b>Procedure </b></font>find_black<font color="#000080">(</font>max_color<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>black<font color="#000080">,</font>white<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>luminance<font color="#000080">,</font>n<font color="#000080">:</font>byte<font color="#000080">;
    </font>reg<font color="#000080">:</font>registers<font color="#000080">;
    </font>table<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>i<font color="#000080">,</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;

  </font><font color="#FF0000"><b>begin
       with </b></font>reg <font color="#FF0000"><b>do
         begin
           </b></font>ah<font color="#000080">:=</font><font color="#800000">$10</font><font color="#000080">;
           </font>al<font color="#000080">:=</font><font color="#800000">$17</font><font color="#000080">;
           </font>bx<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
           </font>cx<font color="#000080">:=</font>max_color<font color="#000080">;
           </font>es<font color="#000080">:=</font>seg<font color="#000080">(</font>table<font color="#000080">);
           </font>dx<font color="#000080">:=</font>ofs<font color="#000080">(</font>table<font color="#000080">);
           </font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>reg<font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>i<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>white<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>black<font color="#000080">:=</font><font color="#800000">255</font><font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>n<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>max_color<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
      begin
        </b></font>luminance<font color="#000080">:=</font>round<font color="#000080">(((</font><font color="#800000">0.59</font><font color="#000080">*</font>table<font color="#000080">[</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">])+(</font><font color="#800000">0.3</font><font color="#000080">*</font>table<font color="#000080">[</font>i<font color="#000080">])+
        (</font><font color="#800000">0.11</font><font color="#000080">*</font>table<font color="#000080">[</font>i<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">])));
        </font><font color="#FF0000"><b>if </b></font>luminance<font color="#000080">&gt;</font>white <font color="#FF0000"><b>then
          begin
            </b></font>white<font color="#000080">:=</font>luminance<font color="#000080">;
            </font>x<font color="#000080">:=</font>n<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>if </b></font>luminance<font color="#000080">&lt;</font>black <font color="#FF0000"><b>then
          begin
            </b></font>black<font color="#000080">:=</font>luminance<font color="#000080">;
            </font>y<font color="#000080">:=</font>n<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>inc<font color="#000080">(</font>i<font color="#000080">,</font><font color="#800000">3</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>i<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>black<font color="#000080">:=</font>y<font color="#000080">;
    </font>white<font color="#000080">:=</font>x<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>wrtxt<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font>txt<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">);</font><font color="#008000"><i>{write TXT to pos (X,Y)}
</i></font><font color="#FF0000"><b>type
  </b></font>pchar<font color="#000080">=</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>char<font color="#000080">] </font><font color="#FF0000"><b>of array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>p<font color="#000080">:^</font>pchar<font color="#000080">;
  </font>c<font color="#000080">:</font>char<font color="#000080">;
  </font>i<font color="#000080">,</font>j<font color="#000080">,</font>z<font color="#000080">,</font>b<font color="#000080">:</font>integer<font color="#000080">;
  </font>noir<font color="#000080">,</font>blanc<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>reg<font color="#000080">.</font>ax<font color="#000080">:=</font><font color="#800000">$1130</font><font color="#000080">;
  </font>reg<font color="#000080">.</font>bh<font color="#000080">:=</font><font color="#800000">6</font><font color="#000080">;
  </font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>reg<font color="#000080">);
  </font>p<font color="#000080">:=</font>ptr<font color="#000080">(</font>reg<font color="#000080">.</font>es<font color="#000080">,</font>reg<font color="#000080">.</font>bp<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>use_16<font color="#000080">=</font>false<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>use_32<font color="#000080">=</font>false<font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font>find_black<font color="#000080">(</font><font color="#800000">256</font><font color="#000080">,</font>noir<font color="#000080">,</font>blanc<font color="#000080">)
  </font><font color="#FF0000"><b>else
    begin
      </b></font>noir<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font>blanc<font color="#000080">:=</font><font color="#800000">255</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>for </b></font>z<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>txt<font color="#000080">) </font><font color="#FF0000"><b>do
      begin
        </b></font>c<font color="#000080">:=</font>txt<font color="#000080">[</font>z<font color="#000080">];
        </font><font color="#FF0000"><b>for </b></font>j<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">15 </font><font color="#FF0000"><b>do
        begin
          </b></font>b<font color="#000080">:=</font>p<font color="#000080">^[</font>c<font color="#000080">][</font>j<font color="#000080">];
          </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font>x<font color="#000080">+</font><font color="#800000">7 </font><font color="#FF0000"><b>downto </b></font>x <font color="#FF0000"><b>do
          begin
            if </b></font><font color="#000080">(</font>use_16<font color="#000080">=</font>false<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>use_32<font color="#000080">=</font>false<font color="#000080">)  </font><font color="#FF0000"><b>then
              begin
                if </b></font>odd<font color="#000080">(</font>b<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>setpix<font color="#000080">(</font>i<font color="#000080">,</font>y<font color="#000080">+</font>j<font color="#000080">,</font>blanc<font color="#000080">)
                          </font><font color="#FF0000"><b>else </b></font>setpix<font color="#000080">(</font>i<font color="#000080">,</font>y<font color="#000080">+</font>j<font color="#000080">,</font>noir<font color="#000080">);
              </font><font color="#FF0000"><b>end
            else
              begin
                if </b></font>odd<font color="#000080">(</font>b<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>setpix_16<font color="#000080">(</font>i<font color="#000080">,</font>y<font color="#000080">+</font>j<font color="#000080">,</font>blanc<font color="#000080">,</font>blanc<font color="#000080">,</font>blanc<font color="#000080">)
                          </font><font color="#FF0000"><b>else </b></font>setpix_16<font color="#000080">(</font>i<font color="#000080">,</font>y<font color="#000080">+</font>j<font color="#000080">,</font>noir<font color="#000080">,</font>noir<font color="#000080">,</font>noir<font color="#000080">);
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

            </font>b<font color="#000080">:=</font>b <font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>inc<font color="#000080">(</font>x<font color="#000080">,</font><font color="#800000">8</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>getpix<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var  </b></font>decalage<font color="#000080">:</font>word<font color="#000080">;
      </font><font color="#FF0000"><b>asm
</b></font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,x
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax,y</font>	<font color="#008000"><i>{removed all range checking on x,y for speed}
</i></font>	<font color="#FF00FF">mul</font>	<font color="#FF00FF">x_size</font>	<font color="#008000"><i>{640 bytes wide in most cases}
</i></font>	<font color="#FF00FF">add</font>	<font color="#FF00FF">bx,ax
</font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">dx,0
</font>	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax, dx</font>	<font color="#008000"><i>{ what a $#%%# stupid microprocessor}
</i></font>	<font color="#FF00FF">adc</font>	<font color="#FF00FF">ax, 0

        </font><font color="#008000"><i>{mov provi,al}   { bank  }
        </i></font><font color="#FF00FF">mov decalage,bx
        cmp ax,curbank
        jz @nonew
        mov ah,0
        push cs
        push ax
        call  far ptr setbank   </font><font color="#008000"><i>{ ax= bank }
        </i></font><font color="#FF00FF">@nonew:

          mov ax,sega000
          mov es,ax
          mov di,decalage
          mov al,[es:di]
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>write_fast_16<font color="#000080">(</font>x1<font color="#000080">,</font>y<font color="#000080">,</font>x2<font color="#000080">,</font>indice<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>rouge<font color="#000080">,</font>vert<font color="#000080">,</font>bleu<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>coord1<font color="#000080">,</font>coord2<font color="#000080">:</font>longint<font color="#000080">;
    </font>couleur<font color="#000080">:</font>byte<font color="#000080">;
    </font>i<font color="#000080">,</font>from<font color="#000080">,</font>i_mem<font color="#000080">,</font>x_pixel<font color="#000080">:</font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>write_fast_16<font color="#000080">:=</font>false<font color="#000080">;
    </font>coord1<font color="#000080">:=</font>longint<font color="#000080">(</font>y<font color="#000080">)*</font>longint<font color="#000080">(</font>x_size<font color="#000080">)+</font>longint<font color="#000080">(</font>x1<font color="#000080">)*</font><font color="#800000">3</font><font color="#000080">;  </font><font color="#008000"><i>{R+V+B=3 bytes  }
    </i></font>coord2<font color="#000080">:=</font>coord1<font color="#000080">+</font>longint<font color="#000080">((</font>x2<font color="#000080">-</font>x1<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">3</font><font color="#000080">;
    </font><font color="#008000"><i>(* is the first point in current bank ????  *)
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)&lt;&gt; </font>curbank <font color="#FF0000"><b>then  </b></font>setbank<font color="#000080">(</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">);
    </font><font color="#008000"><i>(* if the first and the last points are in the same 64k bank        *)
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">((</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)=(</font>coord2 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>use_16<font color="#000080">=</font>true<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
         </b></font>i<font color="#000080">:=</font>indice<font color="#000080">;
         </font>i_mem<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
         </font>from<font color="#000080">:=(</font>coord1 <font color="#FF0000"><b>mod </b></font><font color="#800000">65536</font><font color="#000080">);
</font><font color="#008000"><i>{         x_pixel:=(x2-x1+1);}
         </i></font>x_pixel<font color="#000080">:=(</font>x2<font color="#000080">-</font>x1<font color="#000080">);
         </font><font color="#FF0000"><b>asm
           </b></font><font color="#FF00FF">push ds

           les di,bleu
           add di,i
           mov si,from
           mov cx,x_pixel
           mov ax,sega000
           mov ds,ax
         @@xloop_b:
             mov al,[es:di]
             mov [ds:si],al
             inc di
             add si,3
             dec cx
             jnz @@xloop_b

           pop ds
           mov si,from
           inc si
           mov cx,x_pixel
           push ds
           les di,vert
           add di,i
           mov ax,sega000
           mov ds,ax
         @@xloop_g:
             mov al,[es:di]
             mov [ds:si],al
             inc di
             add si,3
             dec cx
             jnz @@xloop_g

           pop ds
           mov si,from
           inc si
           inc si
           mov cx,x_pixel
           push ds
           les di,rouge
           add di,i
           mov ax,sega000
           mov ds,ax
         @@xloop_r:
             mov al,[es:di]
             mov [ds:si],al
             inc di
             add si,3
             dec cx
             jnz @@xloop_r

           pop ds
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>write_fast_16<font color="#000080">:=</font>true<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;




</font><font color="#FF0000"><b>Function </b></font>write_fast_16_BRG<font color="#000080">(</font>x1<font color="#000080">,</font>y<font color="#000080">,</font>x2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>image<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>coord1<font color="#000080">,</font>coord2<font color="#000080">:</font>longint<font color="#000080">;
    </font>couleur<font color="#000080">:</font>byte<font color="#000080">;
    </font>i<font color="#000080">,</font>from<font color="#000080">,</font>x_pixel<font color="#000080">:</font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>write_fast_16_BRG<font color="#000080">:=</font>false<font color="#000080">;
    </font>coord1<font color="#000080">:=(</font>longint<font color="#000080">(</font>y<font color="#000080">)*</font>longint<font color="#000080">(</font>x_size<font color="#000080">)+</font>longint<font color="#000080">(</font>x1<font color="#000080">))*</font><font color="#800000">1</font><font color="#000080">;
    </font>coord2<font color="#000080">:=</font>coord1<font color="#000080">+</font>longint<font color="#000080">((</font>x2<font color="#000080">-</font>x1<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">3</font><font color="#000080">;
    </font><font color="#008000"><i>(* is the first point in current bank ????  *)
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)&lt;&gt; </font>curbank <font color="#FF0000"><b>then  </b></font>setbank<font color="#000080">(</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">);
    </font><font color="#008000"><i>(* if the first and the last points are in the same 64k bank        *)
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">((</font>coord1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)=(</font>coord2 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>use_16<font color="#000080">=</font>true<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
         </b></font>from<font color="#000080">:=(</font>coord1 <font color="#FF0000"><b>mod </b></font><font color="#800000">65536</font><font color="#000080">);
         </font>x_pixel<font color="#000080">:=(</font>x2<font color="#000080">-</font>x1<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">3 </font><font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">;
         </font><font color="#FF0000"><b>asm
            </b></font><font color="#FF00FF">push ds
            mov cx,x_pixel
            mov di,from
            mov es,SegA000
            lds si,image
            cld
</font><font color="#008000"><i>{          @boucle:
            mov ax,[ds:si]
            mov [es:di],ax
            add si,2
            add di,2
            dec cx
            jnz @boucle}
{            rep movsw}
            </i></font><font color="#FF00FF">db      0f3h, 066h, 0a5h  </font><font color="#008000"><i>{ rep movsd }
            </i></font><font color="#FF00FF">pop ds
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>write_fast_16_BRG<font color="#000080">:=</font>true<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ --------------------------   DEMO PROGRAM  ------------------------ }
(*
*****************************************************************************

  Copyright (C) 1995 Lionel CORDESSES

  This source is a part of a program that  allows you to read and display
a color or a black and  white  JPEG picture . I wrote the  full source in
order to understand how  it  works . Some  parts  are  translated  from C
language to Pascal (the reverse DCT for instance ).
	I used many sources of informations:
        - &quot;The JPEG Still Picture Compression Standart&quot; by G.K.Wallace,
        - C sources and doc from the Independent JPEG Group's software,
        - C sources and doc from  the Portable  Video Research Group (PVRG)
	code,
        - the FAQ about JPEG,
        - &quot;JPEG Compression&quot; by C.Cavigioli (ANALOG DEVICE application note
        AN-336B )
	- and many others ...

    You  can use , modified and distribute this source as long as credit is
given.

*****************************************************************************
*)

{
*****************************************************************************

    Sample program for the unit Usvesa3.

    Only 2 mode tested here:
      - 256 colors
      - 16 millions colors

    You can change the
       &quot;n:=setmode($112);&quot; and write :
       &quot;n:=setmode($110);&quot; .
    I am sure that you will see the difference between 32768 an 16 millions
  colors !!!

                                           Lionel Cordesses
                                           From FRANCE.
                                           June 1995
*****************************************************************************
}

</i></font><font color="#FF0000"><b>program </b></font>VesaDemo<font color="#000080">;

</font><font color="#008000"><i>{$f+}

</i></font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">,</font>crt<font color="#000080">,</font>usvesa3<font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>n<font color="#000080">:</font>byte<font color="#000080">;
    </font>x<font color="#000080">,</font>y<font color="#000080">,</font>i<font color="#000080">:</font>word<font color="#000080">;
    </font>ch<font color="#000080">:</font>char<font color="#000080">;
    </font>funckey<font color="#000080">:</font>boolean<font color="#000080">;
    </font>code<font color="#000080">:</font>byte<font color="#000080">;
    </font>tps1<font color="#000080">,</font>tps2<font color="#000080">:</font>longint<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>touche<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>funckey<font color="#000080">:</font>boolean<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>code<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>ch<font color="#000080">:</font>char<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    while </b></font>keypressed <font color="#FF0000"><b>do
      </b></font>ch<font color="#000080">:=</font>readkey<font color="#000080">;
    </font><font color="#FF0000"><b>repeat
    until not </b></font>keypressed<font color="#000080">;
    </font>ch<font color="#000080">:=</font>readkey<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>ch<font color="#000080">&lt;&gt;</font><font color="#800000">#0 </font><font color="#FF0000"><b>then </b></font>funckey<font color="#000080">:=</font>false
    <font color="#FF0000"><b>else
      begin
        </b></font>funckey<font color="#000080">:=</font>true<font color="#000080">;
        </font>ch<font color="#000080">:=</font>readkey<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>code<font color="#000080">:=</font>ord<font color="#000080">(</font>ch<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>procedure </b></font>test_256<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>clrscr<font color="#000080">;
    </font>writeln<font color="#000080">(</font><font color="#800000">'Testing VESA mode 640x480 256 colors'</font><font color="#000080">);
    </font>writeln<font color="#000080">(</font><font color="#800000">'Press a key ...'</font><font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>touche<font color="#000080">(</font>funckey<font color="#000080">,</font>code<font color="#000080">)
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>code<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>funckey<font color="#000080">=</font>true<font color="#000080">);
    </font>n<font color="#000080">:=</font>setmode<font color="#000080">(</font><font color="#800000">$101</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>n<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        </b></font>textmode<font color="#000080">(</font>co80<font color="#000080">);
        </font>writeln<font color="#000080">(</font><font color="#800000">'WARNING:no VESA driver or unsupported mode !!! '</font><font color="#000080">);
        </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>x<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
      for </b></font>y<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
        </b></font>setpix<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>x<font color="#000080">);
    </font>wrtxt<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">'Mode VESA 101h OK : Press a key to quit ...'</font><font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>touche<font color="#000080">(</font>funckey<font color="#000080">,</font>code<font color="#000080">)
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>code<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>funckey<font color="#000080">=</font>true<font color="#000080">);
    </font>textmode<font color="#000080">(</font>co80<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>test_32<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>clrscr<font color="#000080">;
    </font>writeln<font color="#000080">(</font><font color="#800000">'Testing VESA mode 640x480 32768  colors'</font><font color="#000080">);
    </font>writeln<font color="#000080">(</font><font color="#800000">'Press a key ...'</font><font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>touche<font color="#000080">(</font>funckey<font color="#000080">,</font>code<font color="#000080">)
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>code<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>funckey<font color="#000080">=</font>true<font color="#000080">);
    </font>n<font color="#000080">:=</font>setmode<font color="#000080">(</font><font color="#800000">$110</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>n<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        </b></font>textmode<font color="#000080">(</font>co80<font color="#000080">);
        </font>writeln<font color="#000080">(</font><font color="#800000">'WARNING:no VESA driver or unsupported mode !!! '</font><font color="#000080">);
        </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>tps1<font color="#000080">:=</font>get_time<font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>y<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
      for </b></font>x<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
        </b></font>setpix_16<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>x<font color="#000080">,</font>y<font color="#000080">,</font><font color="#800000">255</font><font color="#000080">-</font>x<font color="#000080">);
    </font>tps2<font color="#000080">:=</font>get_time<font color="#000080">;
    </font>wrtxt<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">'Mode VESA 110h OK : Press a key to quit ...'</font><font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>touche<font color="#000080">(</font>funckey<font color="#000080">,</font>code<font color="#000080">)
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>code<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>funckey<font color="#000080">=</font>true<font color="#000080">);
    </font>textmode<font color="#000080">(</font>co80<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>test_16<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>clrscr<font color="#000080">;
    </font>writeln<font color="#000080">(</font><font color="#800000">'Testing VESA mode 640x480 16 millions  colors'</font><font color="#000080">);
    </font>writeln<font color="#000080">(</font><font color="#800000">'Press a key ...'</font><font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>touche<font color="#000080">(</font>funckey<font color="#000080">,</font>code<font color="#000080">)
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>code<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>funckey<font color="#000080">=</font>true<font color="#000080">);
    </font>n<font color="#000080">:=</font>setmode<font color="#000080">(</font><font color="#800000">$112</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>n<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        </b></font>textmode<font color="#000080">(</font>co80<font color="#000080">);
        </font>writeln<font color="#000080">(</font><font color="#800000">'WARNING:no VESA driver or unsupported mode !!! '</font><font color="#000080">);
        </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>tps1<font color="#000080">:=</font>get_time<font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>y<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
      for </b></font>x<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
        </b></font>setpix_16<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>x<font color="#000080">,</font>y<font color="#000080">,</font><font color="#800000">255</font><font color="#000080">-</font>x<font color="#000080">);
    </font>tps2<font color="#000080">:=</font>get_time<font color="#000080">;
    </font>wrtxt<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">'Mode VESA 112h OK : Press a key to quit ...'</font><font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>touche<font color="#000080">(</font>funckey<font color="#000080">,</font>code<font color="#000080">)
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>code<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>funckey<font color="#000080">=</font>true<font color="#000080">);
    </font>textmode<font color="#000080">(</font>co80<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin
  </b></font>test_256<font color="#000080">;
  </font>test_32<font color="#000080">;
  </font>test_16<font color="#000080">;
  </font>textmode<font color="#000080">(</font>co80<font color="#000080">);
  </font>writeln<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'VESATST.EXE (C) 1995 Lionel Cordesses '</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0277.PAS">Original</a><b>]</b></p></body>
</html>
