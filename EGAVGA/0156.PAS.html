<html>
<head><title> "VGA Fonts for DPMI and REAL" by CHRIS LAUTENBACH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0156.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
    With all the tonnes of absolutely NO help that the Pascal conferences
    provided me &lt;in one day&gt; I've managed to hack my VGA Font loading code
    to work properly in p-mode.

    It's quite a trick getting the DPMI servers to allocate memory under
    the one meg mark, but it is possible if you write a couple of routines
    like the ones below (or golly-gee, use those! :) ..

    Oh yeah - one other tip.  Those of you who use OpCrt, TpCrt, or maybe
    even plain CRT.  The ScreenHeight function will not return the correct
    value after a font change (if the change is a new line mode) unless you
    call ReInitCRT.

    Here's the code:
}
</i></font><font color="#FF0000"><b>Unit </b></font>LF<font color="#000080">;

</font><font color="#008000"><i>{$IFDEF Windows}
  </i></font>This will <font color="#FF0000"><b>not </b></font>work <font color="#FF0000"><b>with </b></font>Windows<font color="#000080">!
</font><font color="#008000"><i>{$ENDIF}

{ Text-mode font routines                                                    }
{ (c)1994 Chris Lautenbach                                                   }
{                                                                            }
{ Date         Revision     Description                                      }
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }
{ Sep 07 94         1.0     Wrote real mode routines                         }
{ Sep 09 94         1.1     Added protected mode versions                    }

{ Notes:                                                                     }

{ It is important to note, that under protected mode, the normal VGA BIOS    }
{ extensions could not access the memory procured by GetMem().  This is why  }
{ the SimulateRealModeInt() and XGlobalDosAlloc() routines were needed.      }
{ XGlobalDosAlloc() allocates memory under the 1mb mark that the VGA BIOS is }
{ capable of accessing, and thereby allows font loads in p-mode.             }

{ Any size/line font may be used.  This is because I used subfunction $11    }
{ instead of $10.  $11 will calculate the scanlines/etc required for the     }
{ font you are loading by dividing the number of characters by the fonts     }
{ total size (as does LoadFont(), so that we may properly allocate memory).  }
{ I've tested 25, 33, 50, and 66 line mode fonts with it and they all work   }
{ fine.  Make sure the font you are loading is _pure_ binary, and does not   }
{ contain header information for some sort of font editing/loading program.  }

{ The calls to LoadFont() are identical in p-mode to real mode, so you won't }
{ need to do any code changes should you decide to switch between the modes  }
{ later on.  Nor is any special setup necessary.  Just USE it, and load      }
{ fonts, that's it! :)                                                       }

{ Restrictions:                                                              }

{ Don't you dare use this code for profit without proclaiming my name in a   }
{ prominent place in your program!  :) (Oh, and it don't work under Windoze  }
{ but I'm sure you knew that...)                                             }

</i></font><font color="#FF0000"><b>INTERFACE

</b></font><font color="#008000"><i>{$IFDEF DPMI}
</i></font><font color="#FF0000"><b>Uses </b></font>WinApi<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>function </b></font>LoadFont<font color="#000080">(</font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ Loads a 255-character font from FileName to font 0 and sets it on }

</i></font><font color="#FF0000"><b>procedure </b></font>NormalFont<font color="#000080">;
</font><font color="#008000"><i>{ Returns the system to the normal system 8x16 character font }
{ !! This routine works fine under p-mode without modifications since it }
{    does no memory allocation of any kind. }

</i></font><font color="#FF0000"><b>IMPLEMENTATION

</b></font><font color="#008000"><i>{$IFDEF DPMI}
</i></font><font color="#FF0000"><b>Type </b></font>LongRec <font color="#000080">= </font><font color="#FF0000"><b>record
       </b></font>Selector<font color="#000080">, </font>Segment <font color="#000080">: </font>word<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font>DoubleWord <font color="#000080">= </font><font color="#FF0000"><b>record
       </b></font>Lo<font color="#000080">, </font>Hi <font color="#000080">: </font>word<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font>QuadrupleByte <font color="#000080">= </font><font color="#FF0000"><b>record
       </b></font>Lo<font color="#000080">, </font>Hi<font color="#000080">, </font>sLo<font color="#000080">, </font>sHi <font color="#000080">: </font>byte<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font>TDPMIRegisters <font color="#000080">= </font><font color="#FF0000"><b>record
       </b></font>EDI<font color="#000080">, </font>ESI<font color="#000080">, </font>EBP<font color="#000080">, </font>Reserved<font color="#000080">, </font>EBX<font color="#000080">, </font>EDX<font color="#000080">, </font>ECX<font color="#000080">, </font>EAX <font color="#000080">: </font>longint<font color="#000080">;
       </font>Flags<font color="#000080">, </font>ES<font color="#000080">, </font>DS<font color="#000080">, </font>FS<font color="#000080">, </font>GS<font color="#000080">, </font>IP<font color="#000080">, </font>CS<font color="#000080">, </font>SP<font color="#000080">, </font>SS <font color="#000080">: </font>word<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>XGlobalDosAlloc<font color="#000080">(</font>Size <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>P <font color="#000080">: </font>Pointer<font color="#000080">) : </font>word<font color="#000080">;
  </font><font color="#008000"><i>{ Allocates memory in an area that DOS can access properly }
  </i></font><font color="#FF0000"><b>var </b></font>Long <font color="#000080">: </font>longint<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Long <font color="#000080">:= </font>GlobalDosAlloc<font color="#000080">(</font>Size<font color="#000080">);
    </font>P <font color="#000080">:= </font>Ptr<font color="#000080">(</font>LongRec<font color="#000080">(</font>Long<font color="#000080">).</font>Selector<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
    </font>XGlobalDosAlloc <font color="#000080">:= </font>LongRec<font color="#000080">(</font>Long<font color="#000080">).</font>Segment<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

... </font>Viper<font color="#000080">: </font>The offline mail reader <font color="#FF0000"><b>for </b></font>the best <font color="#FF0000"><b>of </b></font>us<font color="#000080">.
</font>___ Viper v2<font color="#000080">.</font><font color="#800000">0 </font><font color="#000080">[</font><font color="#800000">0004</font><font color="#000080">] * </font>Multi<font color="#000080">-</font>part <font color="#FF0000"><b>message</b></font><font color="#000080">, </font><font color="#800000">1 </font><font color="#FF0000"><b>of </b></font><font color="#800000">3 </font><font color="#000080">*
---
 &thorn; </font>RoseMail <font color="#800000">2.55</font><font color="#000080">&aacute;: </font>NANet <font color="#000080">- </font>Toronto Twilight <font color="#000080">(</font><font color="#800000">416</font><font color="#000080">)</font><font color="#800000">663</font><font color="#000080">-</font><font color="#800000">1103 </font><font color="#000080">- </font><font color="#800000">7 </font>Nodes
                                       
<font color="#008000"><i>{SWAG=???.SWG,CHRIS LAUTENBACH,VGA Fonts, they work[2/3]}

  </i></font><font color="#FF0000"><b>function </b></font>SimulateRealModeInt<font color="#000080">(</font>IntNo <font color="#000080">: </font>word<font color="#000080">;
                               </font><font color="#FF0000"><b>var </b></font>Regs <font color="#000080">: </font>TDPMIRegisters<font color="#000080">) : </font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ Simulates a real mode interrupt }
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">PUSH BP                                          </font><font color="#008000"><i>{ Save BP, just in case }
    </i></font><font color="#FF00FF">MOV BX,IntNo                         </font><font color="#008000"><i>{ Move the Interrupt number into BX }
    </i></font><font color="#FF00FF">XOR CX,CX                                                     </font><font color="#008000"><i>{ Clear CX }
    </i></font><font color="#FF00FF">LES DI,Regs                              </font><font color="#008000"><i>{ Load the registers into ES:DI }
    </i></font><font color="#FF00FF">MOV AX,$300                                </font><font color="#008000"><i>{ Set function number to 300h }
    </i></font><font color="#FF00FF">INT $31                             </font><font color="#008000"><i>{ Call Interrupt 31h - DPMI Services }
    </i></font><font color="#FF00FF">JC @Exit                                         </font><font color="#008000"><i>{ Jump to exit on carry }
    </i></font><font color="#FF00FF">XOR AX,AX                                                     </font><font color="#008000"><i>{ Clear AX }
    </i></font><font color="#FF00FF">@Exit:                                                      </font><font color="#008000"><i>{ Exit label }
    </i></font><font color="#FF00FF">POP BP                                                      </font><font color="#008000"><i>{ Restore BP }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>LoadFont<font color="#000080">(</font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;
  </font><font color="#008000"><i>{ Loads a 255-character font from FileName to font 0 and sets it on }
  </i></font><font color="#FF0000"><b>var </b></font>FontFile <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
      </font>Font<font color="#000080">, </font>Tmp <font color="#000080">: </font>pointer<font color="#000080">;
      </font>S<font color="#000080">, </font>O<font color="#000080">, </font>FontSize<font color="#000080">, </font>RMSeg<font color="#000080">, </font>DPSel <font color="#000080">: </font>word<font color="#000080">;
      </font>BPC <font color="#000080">: </font>byte<font color="#000080">;
      </font>Regs <font color="#000080">: </font>TDPMIRegisters<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{$I-}
    </i></font>Assign<font color="#000080">(</font>FontFile<font color="#000080">, </font>FileName<font color="#000080">);                              </font><font color="#008000"><i>{ Open the file }
    </i></font>Reset<font color="#000080">(</font>FontFile<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);                                           </font><font color="#008000"><i>{ Reset it }
    {$I+}
    </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then                  </b></font><font color="#008000"><i>{ File opening was unsuccessful }
    </i></font><font color="#FF0000"><b>begin
      </b></font>LoadFont <font color="#000080">:= </font>FALSE<font color="#000080">;                                      </font><font color="#008000"><i>{ Return FALSE }
      </i></font>Exit<font color="#000080">;                                               </font><font color="#008000"><i>{ Return to caller }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>FontSize <font color="#000080">:= </font>FileSize<font color="#000080">(</font>FontFile<font color="#000080">);                      </font><font color="#008000"><i>{ Get the font size }
    </i></font>FillChar<font color="#000080">(</font>Regs<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Regs<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);             </font><font color="#008000"><i>{ Clear the DPMI registers }
    </i></font>Regs<font color="#000080">.</font>ES <font color="#000080">:= </font>XGlobalDosAlloc<font color="#000080">(</font>FontSize<font color="#000080">, </font>Font<font color="#000080">);            </font><font color="#008000"><i>{ Allocate memory }
    </i></font>BlockRead<font color="#000080">(</font>FontFile<font color="#000080">, </font>Font<font color="#000080">^, </font>FontSize<font color="#000080">);                    </font><font color="#008000"><i>{ Load the font }
    </i></font>BPC <font color="#000080">:= </font>FontSize <font color="#FF0000"><b>DIV </b></font><font color="#800000">256</font><font color="#000080">;                 </font><font color="#008000"><i>{ Calculate bytes per character }
    </i></font>Close<font color="#000080">(</font>FontFile<font color="#000080">);                                   </font><font color="#008000"><i>{ Close the font file }
    </i></font>DoubleWord<font color="#000080">(</font>Regs<font color="#000080">.</font>EBP<font color="#000080">).</font>Hi <font color="#000080">:= </font>Regs<font color="#000080">.</font>ES<font color="#000080">;       </font><font color="#008000"><i>{ Load font address into ES:BP }
    </i></font>QuadrupleByte<font color="#000080">(</font>Regs<font color="#000080">.</font>EAX<font color="#000080">).</font>Hi <font color="#000080">:= </font><font color="#800000">$11</font><font color="#000080">;                    </font><font color="#008000"><i>{ Set function $11 }
    </i></font>QuadrupleByte<font color="#000080">(</font>Regs<font color="#000080">.</font>EAX<font color="#000080">).</font>Lo <font color="#000080">:= </font><font color="#800000">$10</font><font color="#000080">;                </font><font color="#008000"><i>{ Set sub-function $10 }
    </i></font>QuadrupleByte<font color="#000080">(</font>Regs<font color="#000080">.</font>EBX<font color="#000080">).</font>Hi <font color="#000080">:= </font>BPC<font color="#000080">;        </font><font color="#008000"><i>{ Set # of bytes per character }
    </i></font>QuadrupleByte<font color="#000080">(</font>Regs<font color="#000080">.</font>EBX<font color="#000080">).</font>Lo <font color="#000080">:= </font><font color="#800000">$00</font><font color="#000080">;                </font><font color="#008000"><i>{ Set font number to 0 }
    </i></font>DoubleWord<font color="#000080">(</font>Regs<font color="#000080">.</font>ECX<font color="#000080">).</font>Lo <font color="#000080">:= </font><font color="#800000">$FF</font><font color="#000080">;               </font><font color="#008000"><i>{ # of chars to load = 256 }
    </i></font>DoubleWord<font color="#000080">(</font>Regs<font color="#000080">.</font>EDX<font color="#000080">).</font>Lo <font color="#000080">:= </font><font color="#800000">$0</font><font color="#000080">;                     </font><font color="#008000"><i>{ Set start char to 0 }
    </i></font>SimulateRealModeInt<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">, </font>Regs<font color="#000080">);                     </font><font color="#008000"><i>{ Call the interrupt }
    </i></font>GlobalDosFree<font color="#000080">(</font>LongRec<font color="#000080">(</font>Font<font color="#000080">).</font>Selector<font color="#000080">);              </font><font color="#008000"><i>{ Free up the memory }
    </i></font>LoadFont <font color="#000080">:= </font>TRUE<font color="#000080">;                   </font><font color="#008000"><i>{ Return TRUE - function successful! }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

{$IFDEF MSDOS}
  </i></font><font color="#FF0000"><b>function </b></font>LoadFont<font color="#000080">(</font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;
  </font><font color="#008000"><i>{ Loads a 255-character font from FileName to font 0 and sets it on }
  </i></font><font color="#FF0000"><b>var </b></font>FontFile <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
      </font>Font<font color="#000080">, </font>Tmp <font color="#000080">: </font>pointer<font color="#000080">;
      </font>S<font color="#000080">, </font>O<font color="#000080">, </font>FontSize<font color="#000080">, </font>RMSeg<font color="#000080">, </font>DPSel <font color="#000080">: </font>word<font color="#000080">;
      </font>BPC <font color="#000080">: </font>byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{$I-}
    </i></font>Assign<font color="#000080">(</font>FontFile<font color="#000080">, </font>FileName<font color="#000080">);                              </font><font color="#008000"><i>{ Open the file }
    </i></font>Reset<font color="#000080">(</font>FontFile<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);                                           </font><font color="#008000"><i>{ Reset it }
    {$I+}
    </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then                  </b></font><font color="#008000"><i>{ File opening was unsuccessful }
    </i></font><font color="#FF0000"><b>begin
      </b></font>LoadFont <font color="#000080">:= </font>FALSE<font color="#000080">;                                      </font><font color="#008000"><i>{ Return FALSE }
      </i></font>Exit<font color="#000080">;                                               </font><font color="#008000"><i>{ Return to caller }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>FontSize <font color="#000080">:= </font>FileSize<font color="#000080">(</font>FontFile<font color="#000080">);                      </font><font color="#008000"><i>{ Get the font size }
    </i></font>GetMem<font color="#000080">(</font>Font<font color="#000080">, </font>FontSize<font color="#000080">);                       </font><font color="#008000"><i>{ Allocate memory for font }
    </i></font>BlockRead<font color="#000080">(</font>FontFile<font color="#000080">, </font>Font<font color="#000080">^, </font>FontSize<font color="#000080">);                    </font><font color="#008000"><i>{ Load the font }
    </i></font>BPC <font color="#000080">:= </font>FontSize <font color="#FF0000"><b>DIV </b></font><font color="#800000">256</font><font color="#000080">;                 </font><font color="#008000"><i>{ Calculate bytes per character }
    </i></font>Close<font color="#000080">(</font>FontFile<font color="#000080">);                                   </font><font color="#008000"><i>{ Close the font file }
    </i></font>S <font color="#000080">:= </font>Seg<font color="#000080">(</font>Font<font color="#000080">^);                                   </font><font color="#008000"><i>{ Get segment of font }
    </i></font>O <font color="#000080">:= </font>Ofs<font color="#000080">(</font>Font<font color="#000080">^);                                    </font><font color="#008000"><i>{ Get offset of font }
    </i></font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">PUSH BP                                                      </font><font color="#008000"><i>{ Save BP }
      </i></font><font color="#FF00FF">MOV AL,$10                                      </font><font color="#008000"><i>{ Set sub-function $10 }
      </i></font><font color="#FF00FF">MOV AH,$11                                          </font><font color="#008000"><i>{ Set function $11 }
      </i></font><font color="#FF00FF">MOV BH,BPC                              </font><font color="#008000"><i>{ Set # of bytes per character }
      </i></font><font color="#FF00FF">MOV BL,$00                                        </font><font color="#008000"><i>{ Set font # to load }
      </i></font><font color="#FF00FF">MOV CX,$FF                                    </font><font color="#008000"><i>{ Set # of chars to load }
      </i></font><font color="#FF00FF">MOV DX,$0                           </font><font color="#008000"><i>{ Set start of load to character 0 }
      </i></font><font color="#FF00FF">MOV ES,S                                </font><font color="#008000"><i>{ Load segment of font to load }
      </i></font><font color="#FF00FF">MOV BP,O                                 </font><font color="#008000"><i>{ Load offset of font to load }
      </i></font><font color="#FF00FF">INT $10                                      </font><font color="#008000"><i>{ Call BIOS Interrupt 10h }
      </i></font><font color="#FF00FF">POP BP                                                    </font><font color="#008000"><i>{ Restore BP }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>FreeMem<font color="#000080">(</font>Font<font color="#000080">, </font>FontSize<font color="#000080">);                      </font><font color="#008000"><i>{ Release allocated memory }
    </i></font>LoadFont <font color="#000080">:= </font>TRUE<font color="#000080">;                   </font><font color="#008000"><i>{ Return TRUE - function successful! }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

  </i></font><font color="#FF0000"><b>procedure </b></font>NormalFont<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ Returns the system to the normal system 8x16 character font }
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">MOV AL,$04                                        </font><font color="#008000"><i>{ Set sub-function 04h }
    </i></font><font color="#FF00FF">MOV AH,$11                                            </font><font color="#008000"><i>{ Set function 11h }
    </i></font><font color="#FF00FF">MOV BL,$00                           </font><font color="#008000"><i>{ Select font 0 as the one to reset }
    </i></font><font color="#FF00FF">INT $10                                        </font><font color="#008000"><i>{ Call BIOS Interrupt 10h }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0156.PAS">Original</a><b>]</b></p></body>
</html>
