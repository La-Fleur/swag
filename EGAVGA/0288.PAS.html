<html>
<head><title> "Fast implementation of digit plotting on" by YUVAL MELAMED</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0288.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
  Written by Yuval Melamed &lt;melamed@star.net.il&gt;, 25-Oct-1997.

  This is a very fast implementation of digit plotting on mode 13h.
  Infact, I could have made the array to include not only digits, but
  the whole ASCII table. The reason I didn't do that, is none but lack
  of time. I just showed you the basics, now go on and develope !

  One of the great things in this implementation, is the ability to use
  different colors, unlike standard bitmaps used in most games and stuff.

  As I always like to do, I have optimized this to work with 386+
  proccessors. I cannot believe someone still has his XT, right? :)
*)

</i></font><font color="#FF0000"><b>var
  </b></font>X<font color="#000080">, </font>Y <font color="#000080">: </font>Word<font color="#000080">;
  </font>Color<font color="#000080">,
  </font>Time <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Count <font color="#000080">: </font>Longint<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font><font color="#008000"><i>(* The bitmap of the digits, $FF represent pixel: *)
  </i></font>DigitMap <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">5</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Longint <font color="#000080">=
    ((</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">),  </font><font color="#008000"><i>{0}
     </i></font><font color="#000080">(</font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">),  </font><font color="#008000"><i>{1}
     </i></font><font color="#000080">(</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$0000FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">),  </font><font color="#008000"><i>{2}
     </i></font><font color="#000080">(</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">),  </font><font color="#008000"><i>{3}
     </i></font><font color="#000080">(</font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">),  </font><font color="#008000"><i>{4}
     </i></font><font color="#000080">(</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$0000FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">),  </font><font color="#008000"><i>{5}
     </i></font><font color="#000080">(</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$0000FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">),  </font><font color="#008000"><i>{6}
     </i></font><font color="#000080">(</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">),  </font><font color="#008000"><i>{7}
     </i></font><font color="#000080">(</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">),  </font><font color="#008000"><i>{8}
     </i></font><font color="#000080">(</font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF00FF00</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">, </font><font color="#800000">$FF000000</font><font color="#000080">, </font><font color="#800000">$FFFFFF00</font><font color="#000080">)); </font><font color="#008000"><i>{9}

(* 386-optimized procedure to draw a digit on global X,Y, using the
   global Color. The only parameter to this procedure is the digit
   itself, in order to avoid confusions.                            *)
</i></font><font color="#FF0000"><b>procedure </b></font>PutDigit<font color="#000080">(</font>Digit <font color="#000080">: </font>Byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,0A000h </font><font color="#008000"><i>{the video segment}
  </i></font><font color="#FF00FF">mov es,ax

  mov ax,Y  </font><font color="#008000"><i>{get Y}
  </i></font><font color="#FF00FF">mov di,ax </font><font color="#008000"><i>{copy Y}
  </i></font><font color="#FF00FF">shl ax,6  </font><font color="#008000"><i>{Y * 64}
  </i></font><font color="#FF00FF">shl di,8  </font><font color="#008000"><i>{Y * 256}
  </i></font><font color="#FF00FF">add di,ax </font><font color="#008000"><i>{Y * 64 + Y * 256 = Y * 320}
  </i></font><font color="#FF00FF">add di,X  </font><font color="#008000"><i>{Y * 320 + X = offset of (X,Y) in video segment}

  </i></font><font color="#FF00FF">lea bx,DigitMap </font><font color="#008000"><i>{get offset of digit's bitmap}
  </i></font><font color="#FF00FF">mov al,20       </font><font color="#008000"><i>{20 = SizeOf(Longint) * 5 = bytes in digit}
  </i></font><font color="#FF00FF">mul Digit       </font><font color="#008000"><i>{calculate offset of the digit's pixels}
  </i></font><font color="#FF00FF">add bx,ax       </font><font color="#008000"><i>{add offset to BX}

  </i></font><font color="#FF00FF">mov cl,Color
  mov ch,cl
  db 66h; shl cx,16
  mov cl,Color
  mov ch,cl         </font><font color="#008000"><i>{all bytes of ECX now contain the color value}

  </i></font><font color="#FF00FF">db 66h; mov ax,cx          </font><font color="#008000"><i>(* mov eax,ecx                              *)
  </i></font><font color="#FF00FF">db 66h; and ax,[bx]        </font><font color="#008000"><i>(* and eax,[bx]         {mask digit's line} *)
  </i></font><font color="#FF00FF">dw 6626h; mov [di],ax      </font><font color="#008000"><i>(* mov es:[di],eax      {draw digit's line} *)
  </i></font><font color="#FF00FF">db 66h; mov ax,cx          </font><font color="#008000"><i>(* mov eax,ecx                              *)
  </i></font><font color="#FF00FF">db 66h; and ax,[bx+4]      </font><font color="#008000"><i>(* and eax,[bx+4]                           *)
  </i></font><font color="#FF00FF">dw 6626h; mov [di+320],ax  </font><font color="#008000"><i>(* mov es:[di+320],eax  {draw 2nd line}     *)
  </i></font><font color="#FF00FF">db 66h; mov ax,cx          </font><font color="#008000"><i>(* mov eax,ecx                              *)
  </i></font><font color="#FF00FF">db 66h; and ax,[bx+8]      </font><font color="#008000"><i>(* and eax,[bx+8]                           *)
  </i></font><font color="#FF00FF">dw 6626h; mov [di+640],ax  </font><font color="#008000"><i>(* mov es:[di+640],eax  {draw 3rd line}     *)
  </i></font><font color="#FF00FF">db 66h; mov ax,cx          </font><font color="#008000"><i>(* mov eax,ecx                              *)
  </i></font><font color="#FF00FF">db 66h; and ax,[bx+12]     </font><font color="#008000"><i>(* and eax,[bx+12]                          *)
  </i></font><font color="#FF00FF">dw 6626h; mov [di+960],ax  </font><font color="#008000"><i>(* mov es:[di+960],eax  {draw 4th line}     *)
  </i></font><font color="#FF00FF">db 66h; mov ax,cx          </font><font color="#008000"><i>(* mov eax,ecx                              *)
  </i></font><font color="#FF00FF">db 66h; and ax,[bx+16]     </font><font color="#008000"><i>(* and eax,[bx+16]                          *)
  </i></font><font color="#FF00FF">dw 6626h; mov [di+1280],ax </font><font color="#008000"><i>(* mov es:[di+1280],eax {draw 5th line}     *)
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>MemW<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$001A</font><font color="#000080">] := </font>MemW<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$001C</font><font color="#000080">];
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax,13h
    int 10h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Randomize<font color="#000080">;
  </font>X <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Y <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Color <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Time <font color="#000080">:= </font>Mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">];
  </font><font color="#FF0000"><b>while </b></font>Mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">] = </font>Time <font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font>Time <font color="#000080">:= </font>Mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">];
  </font><font color="#FF0000"><b>while </b></font>Mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">] = </font>Time <font color="#FF0000"><b>do begin
    </b></font>PutDigit<font color="#000080">(</font>Random<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">));
    </font>Inc<font color="#000080">(</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Count <font color="#000080">:= </font>Trunc<font color="#000080">(</font>Count <font color="#000080">* </font><font color="#800000">18.217</font><font color="#000080">);
  </font>Color <font color="#000080">:= </font><font color="#800000">15</font><font color="#000080">;
  </font>X <font color="#000080">:= (</font>Trunc<font color="#000080">(</font>Ln<font color="#000080">(</font>Count<font color="#000080">) / </font>Ln<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">)) + </font><font color="#800000">1</font><font color="#000080">) * </font><font color="#800000">4</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>PutDigit<font color="#000080">(</font>Count <font color="#FF0000"><b>mod </b></font><font color="#800000">10</font><font color="#000080">);
    </font>Count <font color="#000080">:= </font>Count <font color="#FF0000"><b>div </b></font><font color="#800000">10</font><font color="#000080">;
    </font>Dec<font color="#000080">(</font>X<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>Count <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>Writeln<font color="#000080">;
  </font>Writeln<font color="#000080">(</font><font color="#800000">' Random digits per second'</font><font color="#000080">);
  </font>Writeln<font color="#000080">(</font><font color="#800000">' (inside loop)'</font><font color="#000080">);
  </font><font color="#FF0000"><b>while </b></font>MemW<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$001A</font><font color="#000080">] = </font>MemW<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$001C</font><font color="#000080">] </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax,3h
    int 10h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0288.PAS">Original</a><b>]</b></p></body>
</html>
