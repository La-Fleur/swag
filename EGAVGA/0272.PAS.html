<html>
<head><title> "Vesa Driver Interface" by PEA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0272.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>UNIT </b></font>VESAdrv<font color="#000080">;
</font><font color="#FF0000"><b>INTERFACE
const </b></font>ProgName   <font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">80</font><font color="#000080">] = </font><font color="#800000">'VESA driver interface by P&icirc;'#$0D#$0A'$'</font><font color="#000080">;
</font>	  ProgVersion<font color="#000080">:</font>word <font color="#000080">= </font><font color="#800000">$0102</font><font color="#000080">;  </font><font color="#008000"><i>{ programmed for VESA version 1.2 }
</i></font>	  MaxVertical <font color="#000080">=      </font><font color="#800000">480</font><font color="#000080">*</font><font color="#800000">2</font><font color="#000080">;       </font><font color="#008000"><i>{ max. vertical lines you need }
</i></font>									  <font color="#008000"><i>{ double if 2 pages required }

</i></font>	  VesaSign   <font color="#000080">:</font>longint <font color="#000080">= </font><font color="#800000">$41534556</font><font color="#000080">; </font><font color="#008000"><i>{ = 'VESA' }
</i></font>	  StatusOk   <font color="#000080">:</font>WORD    <font color="#000080">= </font><font color="#800000">$004f</font><font color="#000080">;     </font><font color="#008000"><i>{ default ok response after int 10 }
</i></font>											  <font color="#008000"><i>{.........!.........!.........!}
</i></font>	  VesaErrors <font color="#000080">:</font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">5</font><font color="#000080">] </font><font color="#FF0000"><b>OF STRING</b></font><font color="#000080">[</font><font color="#800000">30</font><font color="#000080">] =(</font><font color="#800000">'Vesa init ok.                 '</font><font color="#000080">,
</font>											  <font color="#800000">'?Error getting vesainfo.      '</font><font color="#000080">,
</font>											  <font color="#800000">'?Vesa not detected.           '</font><font color="#000080">,
</font>											  <font color="#800000">'?Vesa not detected.           '</font><font color="#000080">,
</font>											  <font color="#800000">'?Error getting vesamodeinfo.  '</font><font color="#000080">,
</font>											  <font color="#800000">'?Error opening vesamode.      '</font><font color="#000080">);
</font>	  MaxBanks <font color="#000080">= </font><font color="#800000">256</font><font color="#000080">;    </font><font color="#008000"><i>{ maximum bank switch }

</i></font><font color="#FF0000"><b>type
 </b></font>TVerticalPosInfo <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>MaxVertical<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>OF RECORD </b></font><font color="#008000"><i>{ extra help for finding}
</i></font>							 Address <font color="#000080">:</font>Word<font color="#000080">;             </font><font color="#008000"><i>{ memory addres }
</i></font>							 Bank<font color="#000080">:</font>Byte<font color="#000080">;             </font><font color="#008000"><i>{ memory bank }
</i></font>							 reserved<font color="#000080">:</font>byte<font color="#000080">;
</font>							 <font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font>TVesaInfoBlock <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>		VESASignature      <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#008000"><i>{'VESA' check as number}
</i></font>		VESAVersion        <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ version hi.lo }
</i></font>		OEMStringPtr       <font color="#000080">: </font>pointer<font color="#000080">; </font><font color="#008000"><i>{ pointer to OEM string }
</i></font>		Capabilities       <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#008000"><i>{ Capabilities field }
</i></font>		VideoModePtr       <font color="#000080">: </font>pointer<font color="#000080">; </font><font color="#008000"><i>{ pointer to supported modes }
</i></font>		TotalMemory        <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ x64k available memory }
</i></font>		reserved           <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">236</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">; </font><font color="#008000"><i>{unused yet}
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font>TVesaModeInfoBlock <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>		ModeAttributes     <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ mode attributes                    }
</i></font>		WinAAttributes     <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ window A attributes                }
</i></font>		WinBAttributes     <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ window B attributes                }
</i></font>		WinGranularity     <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ window granularity                 }
</i></font>		WinSize            <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ window size                        }
</i></font>		WinASegment        <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ window A start segment             }
</i></font>		WinBSegment        <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ window B start segment             }
</i></font>		WinFuncPtr         <font color="#000080">: </font>pointer<font color="#000080">; </font><font color="#008000"><i>{ pointer to windor function         }
</i></font>		BytesPerScanLine   <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ bytes per scan line                }
</i></font>		XResolution        <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ horizontal resolution              }
</i></font>		YResolution        <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ vertical resolution                }
</i></font>		XCharSize          <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ character cell width               }
</i></font>		YCharSize          <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ character cell height              }
</i></font>		NumberOfPlanes     <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ number of memory planes            }
</i></font>		BitsPerPixel       <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ bits per pixel                     }
</i></font>		NumberOfBanks      <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ number of banks                    }
</i></font>		MemoryModel        <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ memory model type                  }
</i></font>		BankSize           <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ bank size in kb                    }
</i></font>		NumberOfImagePages <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ number of images                   }
</i></font>		Reserved           <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ reserved for page function         }
</i></font>		RedMaskSize        <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ size of direct color red mask      }
</i></font>		RedFieldPosition   <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ bit position of LSB of red mask    }
</i></font>		GreenMaskSize      <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ size of direct color green mask    }
</i></font>		GreenFieldPosition <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ bit position of LSB of green mask  }
</i></font>		BlueMaskSize       <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ size of direct color blue mask     }
</i></font>		BlueFieldPosition  <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ bit position of LSB of blue mask   }
</i></font>		RsvdMaskSize       <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ size of direct color reserved mask }
</i></font>		DirectColorModeInfo<font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{ Direct Color mode attributes       }
</i></font>		Reserved2          <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">216</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">; </font><font color="#008000"><i>{ remainder            }
</i></font>	   <font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>InitVesaMode<font color="#000080">(</font>RequestMode<font color="#000080">:</font>word<font color="#000080">;</font>ClearScreen<font color="#000080">:</font>BOOLEAN<font color="#000080">):</font>word<font color="#000080">;
  </font><font color="#FF0000"><b>procedure </b></font>PutPixel<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">:</font>Integer<font color="#000080">; </font>C<font color="#000080">:</font>Word<font color="#000080">);
  </font><font color="#FF0000"><b>procedure </b></font>DrawBitMap<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">, </font>XS<font color="#000080">,</font>YS<font color="#000080">:</font>Integer<font color="#000080">;</font>ImageData<font color="#000080">:</font>Pointer<font color="#000080">);
  </font><font color="#FF0000"><b>procedure </b></font>Draw0BitMap<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">, </font>XS<font color="#000080">,</font>YS<font color="#000080">:</font>Integer<font color="#000080">;</font>ImageData<font color="#000080">:</font>Pointer<font color="#000080">);
  </font><font color="#FF0000"><b>procedure </b></font>SetDisplayStart<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">:</font>Word<font color="#000080">);
  </font><font color="#FF0000"><b>procedure </b></font>CloseVesaMode<font color="#000080">;

</font><font color="#FF0000"><b>var
 </b></font>VesaInfo       <font color="#000080">: </font>TVesaInfoBlock<font color="#000080">;     </font><font color="#008000"><i>{ get your own info here }
 </i></font>VesaModeInfo   <font color="#000080">: </font>TVesaModeInfoBlock<font color="#000080">; </font><font color="#008000"><i>{ get your own info here }
 </i></font>VerticalPosInfo<font color="#000080">: </font>TVerticalPosInfo<font color="#000080">;   </font><font color="#008000"><i>{ get your own info here }
 </i></font>BankTable      <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>MaxBanks<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Word<font color="#000080">;

 </font>CurrentBank<font color="#000080">,
 </font>WritePage<font color="#000080">,
 </font>VisualPage       <font color="#000080">: </font>word<font color="#000080">;
 </font>WinSizeBytes     <font color="#000080">: </font>word<font color="#000080">;  </font><font color="#008000"><i>{ winsize in bytes..   0 = 64k }

</i></font><font color="#FF0000"><b>IMPLEMENTATION
</b></font><font color="#008000"><i>{==== initialize video mode ====}
</i></font><font color="#FF0000"><b>function </b></font>InitVesaMode<font color="#000080">(</font>RequestMode<font color="#000080">:</font>word<font color="#000080">;</font>ClearScreen<font color="#000080">:</font>BOOLEAN<font color="#000080">):</font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">xor  si,si        </font><font color="#008000"><i>{ Error step value }
   </i></font><font color="#FF00FF">inc  si           </font><font color="#008000"><i>{ start with one }

   </i></font><font color="#FF00FF">mov  ax,ds
   mov  es,ax
   mov  ax,$4f00;    </font><font color="#008000"><i>{ return SuperVGA information }
   </i></font><font color="#FF00FF">mov  di, OFFSET VesaInfo; </font><font color="#008000"><i>{ into buffer VesaInfo }
   </i></font><font color="#FF00FF">int  $10;

   cmp  ax,StatusOk; </font><font color="#008000"><i>{ Status okay ? }
{1}   </i></font><font color="#FF00FF">jnz @ErrorInit;    </font><font color="#008000"><i>{ no, then halt init }

   </i></font><font color="#FF00FF">inc  si            </font><font color="#008000"><i>{ next check }
   </i></font><font color="#FF00FF">mov  ax, WORD PTR VesaInfo.VESASignature;  </font><font color="#008000"><i>{ check first two chars }
   </i></font><font color="#FF00FF">cmp  ax, WORD PTR VesaSign
</font><font color="#008000"><i>{2}   </i></font><font color="#FF00FF">jnz @ErrorInit

   inc  si            </font><font color="#008000"><i>{ next check }
   </i></font><font color="#FF00FF">mov  ax, WORD PTR VesaInfo.VESASignature+2;  </font><font color="#008000"><i>{ check next two chars }
   </i></font><font color="#FF00FF">cmp  ax, WORD PTR VesaSign+2
</font><font color="#008000"><i>{3}   </i></font><font color="#FF00FF">jnz @ErrorInit

   </font><font color="#008000"><i>{ primary test for VESA done, try to get videomode info }
   </i></font><font color="#FF00FF">inc  si            </font><font color="#008000"><i>{ next check }
   </i></font><font color="#FF00FF">mov  ax, $4f01               </font><font color="#008000"><i>{ return videomode information }
   </i></font><font color="#FF00FF">mov  cx, RequestMode         </font><font color="#008000"><i>{ requested mode }
   </i></font><font color="#FF00FF">mov  di, OFFSET VesaModeInfo </font><font color="#008000"><i>{ into buffer VesaModeInfo }
   </i></font><font color="#FF00FF">int  $10;

   cmp  ax, StatusOk;           </font><font color="#008000"><i>{ did this work out good? }
{4}   </i></font><font color="#FF00FF">jnz @ErrorInit

   </font><font color="#008000"><i>{ start opening videomode }
   </i></font><font color="#FF00FF">inc  si            </font><font color="#008000"><i>{ next check }
   </i></font><font color="#FF00FF">mov  ax, $4f02;
   mov  bh, ClearScreen;        </font><font color="#008000"><i>{ must clear screen }
   </i></font><font color="#FF00FF">xor  bh, $01;                </font><font color="#008000"><i>{ invert bit }
   </i></font><font color="#FF00FF">shl  bh, 7;                  </font><font color="#008000"><i>{ move bit to d15 }
   </i></font><font color="#FF00FF">xor  bl, bl;                 </font><font color="#008000"><i>{ clear lower byte }
   </i></font><font color="#FF00FF">or   bx, RequestMode;        </font><font color="#008000"><i>{ combine with videomode }
   </i></font><font color="#FF00FF">int  $10;

   cmp  ax, StatusOk            </font><font color="#008000"><i>{ did this work out good? }
{5}   </i></font><font color="#FF00FF">jnz @ErrorInit

   </font><font color="#008000"><i>{ build vertical pos info block }
   </i></font><font color="#FF00FF">inc  si               </font><font color="#008000"><i>{ next check }
   </i></font><font color="#FF00FF">mov  cx, MaxVertical  </font><font color="#008000"><i>{ how many times }
   </i></font><font color="#FF00FF">mov  di, OFFSET VerticalPosInfo;

   xor  bx, bx;                 </font><font color="#008000"><i>{ startbank=0 }
   </i></font><font color="#FF00FF">xor  ax, ax;                 </font><font color="#008000"><i>{ address  =0 }
   </i></font><font color="#FF00FF">mov  dx, WORD PTR VesaModeInfo.WinSize;
   mov  WinSizeBytes, dx
   xchg dl, dh                  </font><font color="#008000"><i>{ multiply this with 1024 }
   </i></font><font color="#FF00FF">shl  dh, 2
</font><font color="#008000"><i>(*    mov  dx, $1000 *)

   { set info }
</i></font><font color="#FF00FF">@VPosLoop:
   mov  ds:[di+0],ax            </font><font color="#008000"><i>{ place addres in vpos infoblock}
   </i></font><font color="#FF00FF">mov  ds:[di+2],bl            </font><font color="#008000"><i>{ place bank in vpos infoblock }
   </i></font><font color="#FF00FF">mov  ds:[di+3],bh            </font><font color="#008000"><i>{ place bank in vpos infoblock }

   </i></font><font color="#FF00FF">add  di,4                    </font><font color="#008000"><i>{ add to next pos. in array}
   </i></font><font color="#FF00FF">add  ax, WORD PTR VesaModeInfo.XResolution </font><font color="#008000"><i>{ increment address}
   </i></font><font color="#FF00FF">jc   @IncBank                </font><font color="#008000"><i>{ in case 64k buffer carry is gen. here! }

   </i></font><font color="#FF00FF">cmp  ax, dx                  </font><font color="#008000"><i>{ check if bank is passed}
   </i></font><font color="#FF00FF">jb  @DoLoop;

   sub  ax, dx                  </font><font color="#008000"><i>{ decrement ax with size to start again 4k-buf}
</i></font><font color="#FF00FF">@IncBank:
   inc  bx;

@DoLoop:
   Loop @VPosLoop;

   </font><font color="#008000"><i>{ built bankswitchtable }

   </i></font><font color="#FF00FF">mov  di, OFFSET BankTable
   xor  bx, bx        </font><font color="#008000"><i>{ start at bank 0 }

</i></font><font color="#FF00FF">@BankLoop:
   mov   ax,bx        </font><font color="#008000"><i>{ get banknr }

   </i></font><font color="#FF00FF">mov   cx, 64
   mul   cx
</font>	<font color="#FF00FF">mov   cx, WORD PTR VesaModeInfo.WinGranularity
   jcxz    @@be
   div   cx
@@be:
   mov   ds:[di],ax   </font><font color="#008000"><i>{ save value }
   </i></font><font color="#FF00FF">inc   di
   inc   di

   inc   bx
   cmp   bx,MaxBanks
   jb    @BankLoop

   </font><font color="#008000"><i>{ buffer has been built for easy use! }
   </i></font><font color="#FF00FF">XOR  CX,CX
   mov  CurrentBank, CX   </font><font color="#008000"><i>{ clear current bank to 0 first time}
   </i></font><font color="#FF00FF">mov  WritePage,   CX   </font><font color="#008000"><i>{ write to page 0 }
   </i></font><font color="#FF00FF">mov  VisualPage,  CX   </font><font color="#008000"><i>{ visual page = 0 }
   </i></font><font color="#FF00FF">xor  bx,bx;            </font><font color="#008000"><i>{ perpare for int.}
   </i></font><font color="#FF00FF">mov  dx,cx;            </font><font color="#008000"><i>{ get banknr from cx }
   </i></font><font color="#FF00FF">mov  ax,$4f05;         </font><font color="#008000"><i>{ irq init }
   </i></font><font color="#FF00FF">int $10;

</font><font color="#008000"><i>(*    jmp  @okinit; *)

{ all ok part }
</i></font><font color="#FF00FF">@OkInit:
   XOR  AX,AX
@ErrorInit:
@</font><font color="#FF0000"><b>End</b></font><font color="#000080">:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{====}
</i></font><font color="#FF0000"><b>procedure </b></font>PutPixel<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">:</font>Integer<font color="#000080">; </font>C<font color="#000080">:</font>Word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font>		 <font color="#FF00FF">mov     ax,Y
</font>		 <font color="#FF00FF">add     ax,WritePage

</font>		 <font color="#FF00FF">mov     di,X
</font>		 <font color="#FF00FF">mov     dx,VesaModeInfo.BytesPerScanLine
</font>		 <font color="#FF00FF">mul     dx
</font>		 <font color="#FF00FF">add     di,ax
</font>		 <font color="#FF00FF">adc     dx,0
</font>		 <font color="#FF00FF">cmp     dx,CurrentBank         </font><font color="#008000"><i>{ out of current window boundary? }
</i></font>		 <font color="#FF00FF">je      @@1                    </font><font color="#008000"><i>{ no }
{==== bankswitch ====}
</i></font>	   <font color="#FF00FF">MOV     BX,DX
</font>		 <font color="#FF00FF">MOV     CurrentBank,BX

</font>	   <font color="#FF00FF">ADD     BX, BX
</font>	   <font color="#FF00FF">ADD     BX, OFFSET BankTable
</font>	   <font color="#FF00FF">mov     DX, DS:[BX]
</font>	   <font color="#FF00FF">mov     AX, $4F05
</font>	   <font color="#FF00FF">xor     BX, BX
</font>	   <font color="#FF00FF">int     10h
@@1:
</font>	   <font color="#FF00FF">mov     AX ,c
</font>	   <font color="#FF00FF">mov     es,SegA000
</font>	   <font color="#FF00FF">mov     es:[di], al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>(*asm
	mov  ax,y
	add  ax,WritePage
	shl  ax,2
	mov  si, OFFSET VerticalPosInfo
   add  si, ax

   mov  ax, ds:[si] { get address }
   mov  es,SegA000  { get video segment }
   mov  di,ax       { get video address }

   mov  ax, ds:[si+2] { get bank }
   add  di,x          { add x coordinate to address }
   adc  ax,0          { perhaps bank add }

   cmp  ax, CurrentBank;  { check if bank is same }
   jz @PutPix;            { bank is already ok! }

   mov  CurrentBank,ax;   { set new bank }
   xor  bx,bx;            { perpare for int.}
	mov  dx,ax;            { get banknr from ax }
   mov  ax,$4f05;         { irq init }
   int $10;

@PutPix:
   mov  ax,C;             { get color}
   mov  es:[di],ax;       { finally put the pixel}
   end;
*)

</i></font><font color="#FF0000"><b>procedure </b></font>SetBank<font color="#000080">; </font><font color="#FF0000"><b>near</b></font><font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ IN: BX = Which bank }
</i></font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">ADD  BX, BX
   ADD  BX, OFFSET BankTable
   mov  DX, DS:[BX]
   mov  AX, $4F05
   xor  BX, BX
   int  10h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>DrawBitMap<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">, </font>XS<font color="#000080">,</font>YS<font color="#000080">:</font>Integer<font color="#000080">;</font>ImageData<font color="#000080">:</font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	SaveDS<font color="#000080">, </font>MemInc<font color="#000080">,</font>CurBank <font color="#000080">: </font>word<font color="#000080">;
</font>	Count<font color="#000080">,</font>BPLine<font color="#000080">, </font>WinGran <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font>		 <font color="#FF00FF">cld
</font>		 <font color="#FF00FF">mov     SaveDS,ds
</font>		 <font color="#FF00FF">mov     ax,CurrentBank
</font>		 <font color="#FF00FF">mov     CurBank,ax
</font>	   <font color="#FF00FF">mov     ax,VesaModeInfo.WinGranularity
</font>	   <font color="#FF00FF">mov     WinGran,ax
</font>		 <font color="#FF00FF">mov     ax,Y
</font>		 <font color="#FF00FF">add     ax,WritePage

</font>		 <font color="#FF00FF">mov     di,X
</font>		 <font color="#FF00FF">mov     dx,VesaModeInfo.BytesPerScanLine
</font>		 <font color="#FF00FF">mul     dx
</font>		 <font color="#FF00FF">add     di,ax
</font>		 <font color="#FF00FF">adc     dx,0
</font>		 <font color="#FF00FF">cmp     dx,CurBank            </font><font color="#008000"><i>{ out of current window boundary? }
</i></font>		 <font color="#FF00FF">je      @@1                    </font><font color="#008000"><i>{ no }
{==== bankswitch ====}
</i></font>	   <font color="#FF00FF">MOV     BX,DX
</font>		 <font color="#FF00FF">MOV     CurBank,BX

</font>	   <font color="#FF00FF">ADD     BX, BX
</font>	   <font color="#FF00FF">ADD     BX, OFFSET BankTable
</font>	   <font color="#FF00FF">mov     DX, DS:[BX]
</font>	   <font color="#FF00FF">mov     AX, $4F05
</font>	   <font color="#FF00FF">xor     BX, BX
</font>	   <font color="#FF00FF">int     10h

@@1:   mov     bx,VesaModeInfo.BytesPerScanLine
</font><font color="#008000"><i>{ move from buffer to video memory }
</i></font>		 <font color="#FF00FF">mov     es,SegA000
</font>		 <font color="#FF00FF">lds     si, ImageData
</font>		 <font color="#FF00FF">mov     cx, XS
</font>		 <font color="#FF00FF">mov     BPLine,cx
</font>		 <font color="#FF00FF">sub     bx,cx
</font>		 <font color="#FF00FF">mov     MemInc,bx
</font>		 <font color="#FF00FF">mov     ax, YS
</font>		 <font color="#FF00FF">mov     Count,ax

</font>	   <font color="#008000"><i>{ check if switch is necessary, for one line! }
</i></font><font color="#FF00FF">@@2:   mov     ax,di
</font>	   <font color="#FF00FF">add     ax,CX  </font><font color="#008000"><i>{ BPLine }
</i></font>	   <font color="#FF00FF">jnc     @one_row  </font><font color="#008000"><i>{ no carry so one full row }

</i></font>	   <font color="#008000"><i>{ check what's before }
</i></font>	   <font color="#FF00FF">xor     cx,cx
</font>	   <font color="#FF00FF">sub     cx,di

</font>	   <font color="#FF00FF">shr     cx,1         </font><font color="#008000"><i>{ copy partially line directly }
</i></font>	   <font color="#FF00FF">rep     movsw
</font>	   <font color="#FF00FF">jnc     @pfini       </font><font color="#008000"><i>{ ready with one partial line }
</i></font>	   <font color="#FF00FF">movsb                </font><font color="#008000"><i>{ just one byte with copy , no rep is slow start }

</i></font><font color="#FF00FF">@pfini:
</font>	   <font color="#FF00FF">push    ax           </font><font color="#008000"><i>{ save rest for later }
</i></font>	   <font color="#FF00FF">inc     CurBank

</font><font color="#008000"><i>{==== bankswitch ====}
</i></font>	   <font color="#FF00FF">mov     ax,CurBank
</font>	   <font color="#FF00FF">mov     cx, 64
</font>	   <font color="#FF00FF">mul     cx
</font>		<font color="#FF00FF">mov     cx, WinGran
</font><font color="#008000"><i>(*        or      cx,cx *)
</i></font>	   <font color="#FF00FF">jcxz      @@e2
</font>	   <font color="#FF00FF">div     cx
</font>		<font color="#FF00FF">mov     dx, ax
</font>	   <font color="#FF00FF">mov     ax, $4F05
</font>	   <font color="#FF00FF">xor     bx, bx
</font>	   <font color="#FF00FF">int     10h
@@e2:

</font>	   <font color="#FF00FF">pop     ax
@@2_1: </font><font color="#008000"><i>{ switch done, do other half }
</i></font>	   <font color="#FF00FF">mov     cx,ax

@One_Row:
</font>	   <font color="#FF00FF">shr     cx,1         </font><font color="#008000"><i>{ copy partially line directly, part 2 after switch }
</i></font>	   <font color="#FF00FF">rep     movsw
</font>	   <font color="#FF00FF">jnc     @fini       </font><font color="#008000"><i>{ ready with one partial line }
</i></font>	   <font color="#FF00FF">movsb                </font><font color="#008000"><i>{ just one byte with copy , no rep is slow start }

</i></font><font color="#FF00FF">@fini:  </font><font color="#008000"><i>{ Finished, add for next line }
</i></font>	   <font color="#FF00FF">add     di,MemInc
</font>	   <font color="#FF00FF">jc      @@2_2sw
</font>	   <font color="#FF00FF">mov     cx,BPLine
</font>	   <font color="#FF00FF">dec     Count
</font>	   <font color="#FF00FF">jnz     @@2
</font>	   <font color="#FF00FF">jmp     @@EndDrw
@@2_2sw:
</font>	   <font color="#FF00FF">inc     CurBank

</font><font color="#008000"><i>{==== bankswitch ====}
</i></font>	   <font color="#FF00FF">mov     ax, CurBank
</font>	   <font color="#FF00FF">mov     cx, 64
</font>	   <font color="#FF00FF">mul     cx
</font>		<font color="#FF00FF">mov     cx, WinGran
</font><font color="#008000"><i>(*        or      cx,cx *)
</i></font>	   <font color="#FF00FF">jcxz      @@e3
</font>	   <font color="#FF00FF">div     cx
</font>		<font color="#FF00FF">mov     dx, ax
</font>	   <font color="#FF00FF">mov     ax, $4F05
</font>	   <font color="#FF00FF">xor     bx, bx
</font>	   <font color="#FF00FF">int     10h
@@e3:

</font>	   <font color="#FF00FF">mov     cx,BPLine
</font>	   <font color="#FF00FF">dec     Count
</font>	   <font color="#FF00FF">jnz     @@2

@@EndDrw:
</font>	   <font color="#FF00FF">mov     ds,SaveDS
</font>	   <font color="#FF00FF">mov     ax,CurBank
</font>	   <font color="#FF00FF">mov     CurrentBank,ax
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Draw0BitMap<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">, </font>XS<font color="#000080">,</font>YS<font color="#000080">:</font>Integer<font color="#000080">;</font>ImageData<font color="#000080">:</font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	SaveDS <font color="#000080">: </font>word<font color="#000080">;
</font>	MemInc <font color="#000080">: </font>word<font color="#000080">;
</font>	OldBank<font color="#000080">,</font>CurBank <font color="#000080">: </font>word<font color="#000080">;
</font>	Count<font color="#000080">,</font>BPLine <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font>		 <font color="#FF00FF">cld
</font>		 <font color="#FF00FF">mov     SaveDS,ds
</font>		 <font color="#FF00FF">mov     ax,CurrentBank
</font>		 <font color="#FF00FF">mov     CurBank,ax
</font>		 <font color="#FF00FF">mov     ax,Y
</font>		 <font color="#FF00FF">add     ax,WritePage

</font>		 <font color="#FF00FF">mov     di,X
</font>		 <font color="#FF00FF">mov     dx,VesaModeInfo.BytesPerScanLine
</font>		 <font color="#FF00FF">mul     dx
</font>		 <font color="#FF00FF">add     di,ax
</font>		 <font color="#FF00FF">adc     dx,0
</font>		 <font color="#FF00FF">cmp     dx,CurBank            </font><font color="#008000"><i>{ out of current window boundary? }
</i></font>		 <font color="#FF00FF">je      @@1                    </font><font color="#008000"><i>{ no }
</i></font>		 <font color="#FF00FF">mov     CurBank,dx
</font>	   <font color="#FF00FF">mov     bx,dx
</font>		 <font color="#FF00FF">call    SetBank               </font><font color="#008000"><i>{ move memory window to new position }

</i></font><font color="#FF00FF">@@1:   mov     bx,VesaModeInfo.BytesPerScanLine
</font><font color="#008000"><i>{ move from buffer to video memory }
</i></font>		 <font color="#FF00FF">mov     es,SegA000
</font>		 <font color="#FF00FF">lds     si, ImageData
</font>		 <font color="#FF00FF">mov     cx, XS
</font>		 <font color="#FF00FF">mov     BPLine,cx
</font>		 <font color="#FF00FF">sub     bx,cx
</font>		 <font color="#FF00FF">mov     MemInc,bx
</font>		 <font color="#FF00FF">mov     ax, YS
</font>		 <font color="#FF00FF">mov     Count,ax

</font>	   <font color="#008000"><i>{ check if switch is necessary, for one line! }
</i></font><font color="#FF00FF">@@2:   mov     ax,di
</font>	   <font color="#FF00FF">add     ax,CX   </font><font color="#008000"><i>{BPLine}
</i></font>	   <font color="#FF00FF">jnc     @One_row  </font><font color="#008000"><i>{ no carry so one full row }

</i></font><font color="#FF00FF">@no_one_row:   </font><font color="#008000"><i>{ there is a switch now in this line }
</i></font>	   <font color="#008000"><i>{ check what's before }
</i></font>	   <font color="#FF00FF">push    ax           </font><font color="#008000"><i>{ save rest for later }
</i></font>	   <font color="#FF00FF">xor     cx,cx
</font>	   <font color="#FF00FF">sub     cx,di
</font>	   <font color="#FF00FF">jcxz    @pfini

</font>	   <font color="#FF00FF">xor     ah,ah
@part1opnieuw:
</font>	   <font color="#FF00FF">lodsb
</font>	   <font color="#FF00FF">cmp     al,ah
</font>	   <font color="#FF00FF">jz      @part1zero    </font><font color="#008000"><i>{ a zero value, so don't put this}
</i></font>	   <font color="#FF00FF">mov     es:[di],al
@part1zero:
</font>	   <font color="#FF00FF">inc     di
</font>	   <font color="#FF00FF">dec     cx
</font>	   <font color="#FF00FF">jnz     @part1opnieuw

@pfini:
</font>	   <font color="#FF00FF">inc     CurBank
</font>	   <font color="#FF00FF">push    ds
</font>	   <font color="#FF00FF">mov     bx,CurBank
</font>	   <font color="#FF00FF">mov     ds,SaveDs
</font>	   <font color="#FF00FF">call    SetBank
</font>	   <font color="#FF00FF">pop     ds

@@2_1: </font><font color="#008000"><i>{ switch done, do other half }
</i></font>	   <font color="#FF00FF">pop     cx
</font>	   <font color="#FF00FF">jcxz    @fini
@One_row:
</font>	   <font color="#FF00FF">xor     ah,ah
@part2opnieuw:
</font>	   <font color="#FF00FF">lodsb
</font>	   <font color="#FF00FF">cmp     al,ah
</font>	   <font color="#FF00FF">jz      @part2zero    </font><font color="#008000"><i>{ a zero value, so don't put this}
</i></font>	   <font color="#FF00FF">mov     es:[di],al
@part2zero:
</font>	   <font color="#FF00FF">inc     di
</font>	   <font color="#FF00FF">dec     cx
</font>	   <font color="#FF00FF">jnz     @part2opnieuw

@fini:  </font><font color="#008000"><i>{ Finished, add for next line }
</i></font>	   <font color="#FF00FF">add     di,MemInc
</font>	   <font color="#FF00FF">jc      @@2_2sw
</font>	   <font color="#FF00FF">mov     cx,BPLine
</font>	   <font color="#FF00FF">dec     Count
</font>	   <font color="#FF00FF">jnz     @@2
</font>	   <font color="#FF00FF">jmp     @@EndDrw
@@2_2sw:
</font>	   <font color="#FF00FF">inc     CurBank

</font>	   <font color="#FF00FF">push    ds
</font>	   <font color="#FF00FF">mov     bx,CurBank
</font>	   <font color="#FF00FF">mov     ds,SaveDs
</font>	   <font color="#FF00FF">call    SetBank

</font>	   <font color="#FF00FF">pop     ds
</font>	   <font color="#FF00FF">mov     cx,BPLine
</font>	   <font color="#FF00FF">dec     Count
</font>	   <font color="#FF00FF">jnz     @@2

@@EndDrw:
</font>	   <font color="#FF00FF">mov     ds,SaveDS
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{====}
</i></font><font color="#FF0000"><b>procedure </b></font>SetDisplayStart<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">:</font>Word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov  ax,$4f07;
   xor  bx,bx
   mov  cx,x
   mov  dx,y
   int  $10;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{===}
</i></font><font color="#FF0000"><b>procedure </b></font>CloseVesaMode<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov  ax,$4f03;   </font><font color="#008000"><i>{ standard way of reseting videocard }
   </i></font><font color="#FF00FF">int  $10;
   mov  ax,$0003;   </font><font color="#008000"><i>{ standard way of reseting videocard }
   </i></font><font color="#FF00FF">int  $10;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin

end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0272.PAS">Original</a><b>]</b></p></body>
</html>
