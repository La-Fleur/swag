<html>
<head><title> "EGA/VGA Mode unit" by ANTON ZHUCHKOV</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0285.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>VVGA<font color="#000080">;
</font><font color="#008000"><i>{$F+,O+}
</i></font><font color="#FF0000"><b>interface

type
  </b></font>VColor <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>R<font color="#000080">,</font>G<font color="#000080">,</font>B<font color="#000080">: </font>byte<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetVGAMode<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>SetTxtMode<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>SetOneColor<font color="#000080">(</font>C<font color="#000080">,</font>R<font color="#000080">,</font>G<font color="#000080">,</font>B<font color="#000080">: </font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>SetColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ColTabl<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>GetColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ColTabl<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>SmoothDecreaseColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>SmoothSetColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>Palette<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>KillColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>VGAPresent <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>implementation

procedure </b></font>SetVGAMode<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov AX,0013H
  int 10H
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetTxtMode<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov AX,0003H
  int 10H
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetOneColor<font color="#000080">(</font>C<font color="#000080">,</font>R<font color="#000080">,</font>G<font color="#000080">,</font>B<font color="#000080">: </font>Byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov AX, 1017H
  mov BL, C
  xor BH, BH
  mov DH, R
  mov CH, G
  mov CL, B
  int 10h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ColTabl<font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">cli
    push ds
    push es
    xor ax, ax
    mov es, ax
    mov dx, es:[463h]
    add dx, 6
    in al, dx
    nop
    nop
    test al, 08h
    jz @@WaitOn
@@WaitOff:
    in al, dx
    nop
    nop
    test al, 08h
    jnz @@WaitOff
@@WaitOn:
    in al, dx
    nop
    nop
    test al, 08h
    jz @@WaitOn
    mov dx, 3C8h
    mov ax, CFirst
    out dx, al
    nop
    nop
    lds si, ColTabl
    mov ax, Count
    mov cx, 3
    mul cx
    mov cx, ax
    mov dx, 3C9h
    cld
@@ReadReg:
    lodsb
    out dx, al
    nop
    nop
    loop @@ReadReg
    pop es
    pop ds
    sti
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>KillColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">cli
    push ds
    push es
    xor ax, ax
    mov es, ax
    mov dx, es:[463h]
    add dx, 6
    in al, dx
    nop
    nop
    test al, 08h
    jz @@WaitOn
@@WaitOff:
    in al, dx
    nop
    nop
    test al, 08h
    jnz @@WaitOff
@@WaitOn:
    in al, dx
    nop
    nop
    test al, 08h
    jz @@WaitOn
    mov dx, 3C8h
    mov ax, CFirst
    out dx, al
    nop
    nop
    mov ax, Count
    mov cx, 3
    mul cx
    mov cx, ax
    mov dx, 3C9h
    cld
    mov al, 0
@@ReadReg:
    out dx, al
    nop
    nop
    loop @@ReadReg
    pop es
    pop ds
    sti
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ColTabl<font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">cli
    push ds
    push es
    xor ax, ax
    mov es, ax
    mov dx, es:[463h]
    add dx, 6
    in al, dx
    nop
    nop
    test al, 08h
    jz @@WaitOn
@@WaitOff:
    in al, dx
    nop
    nop
    test al, 08h
    jnz @@WaitOff
@@WaitOn:
    in al, dx
    nop
    nop
    test al, 08h
    jz @@WaitOn
    mov dx, 3C7h
    mov ax, CFirst
    out dx, al
    nop
    nop
    les di, ColTabl
    mov ax, Count
    mov cx, 3
    mul cx
    mov cx, ax
    mov dx, 3C9h
    cld
@@ReadReg:
    in al, dx
    stosb
    nop
    nop
    loop @@ReadReg
    pop es
    pop ds
    sti
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SmoothDecreaseColors<font color="#000080">(</font>CFirst<font color="#000080">: </font>Word<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>ColTabl<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>VColor<font color="#000080">;
  </font>NPort  <font color="#000080">: </font>Word<font color="#000080">;
  </font>PTable <font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetColors<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">256</font><font color="#000080">, </font>ColTabl<font color="#000080">);
  </font>PTable <font color="#000080">:= </font>Addr<font color="#000080">(</font>ColTabl<font color="#000080">);
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">cli
    push ds
    push es
    xor ax, ax
    mov es, ax
    mov dx, es:[463h]
    add dx, 6
    mov NPort, dx
    pop es
    mov cx, 63
    mov bl, 1
@@NextStep:
    cmp bl, 0
    je @@</font><font color="#FF0000"><b>End
    </b></font>dec bl
    push cx
    mov dx<font color="#000080">, </font>NPort
    <font color="#FF0000"><b>in </b></font>al<font color="#000080">, </font>dx
    nop
    nop
    test al<font color="#000080">, </font><font color="#800000">08</font>h
    jz <font color="#000080">@@</font>WaitOn
<font color="#000080">@@</font>WaitOff<font color="#000080">:
    </font><font color="#FF0000"><b>in </b></font>al<font color="#000080">, </font>dx
    nop
    nop
    test al<font color="#000080">, </font><font color="#800000">08</font>h
    jnz <font color="#000080">@@</font>WaitOff
<font color="#000080">@@</font>WaitOn<font color="#000080">:
    </font><font color="#FF0000"><b>in </b></font>al<font color="#000080">, </font>dx
    nop
    nop
    test al<font color="#000080">, </font><font color="#800000">08</font>h
    jz <font color="#000080">@@</font>WaitOn
    mov dx<font color="#000080">, </font><font color="#800000">3</font>C8h
    mov ax<font color="#000080">, </font>CFirst
    <font color="#FF0000"><b>out </b></font>dx<font color="#000080">, </font>al
    nop
    nop
    lds si<font color="#000080">, </font>PTable
    mov cx<font color="#000080">, </font><font color="#800000">3
    </font>mov ax<font color="#000080">, </font>Count
    mul cx
    mov cx<font color="#000080">, </font>ax
    mov dx<font color="#000080">, </font><font color="#800000">3</font>C9h
    cld
<font color="#000080">@@</font>WriteReg<font color="#000080">:
    </font>cmp ds<font color="#000080">:[</font>si<font color="#000080">].</font>Byte<font color="#000080">, </font><font color="#800000">0
    </font>je <font color="#000080">@@</font>NotDec
    dec ds<font color="#000080">:[</font>si<font color="#000080">].</font>Byte
    mov bl<font color="#000080">, </font><font color="#800000">1
</font><font color="#000080">@@</font>NotDec<font color="#000080">:
    </font>lodsb
    <font color="#FF0000"><b>out </b></font>dx<font color="#000080">, </font>al
    loop <font color="#000080">@@</font>WriteReg
    pop cx
    loop <font color="#000080">@@</font>NextStep
<font color="#000080">@@</font><font color="#FF0000"><b>End</b></font><font color="#000080">:
    </font>pop ds
    sti
  <font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SmoothSetColors<font color="#000080">(</font>CFirst<font color="#000080">, </font>Count<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Palette<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>ColTabl<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>VColor<font color="#000080">;
  </font>NPort  <font color="#000080">: </font>Word<font color="#000080">;
  </font>PTable <font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>GetColors<font color="#000080">(</font>CFirst<font color="#000080">,</font>Count<font color="#000080">, </font>ColTabl<font color="#000080">);
  </font>PTable <font color="#000080">:= </font>Addr<font color="#000080">(</font>ColTabl<font color="#000080">);
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">cli
    push ds
    push es
    xor ax, ax
    mov es, ax
    mov dx, es:[463h]
    add dx, 6
    mov NPort, dx
    pop es
    mov cx, 63
    mov bl, 1
@@NextStep:
    cmp bl, 0
    je @@</font><font color="#FF0000"><b>End
    </b></font>dec bl
    push cx
    mov dx<font color="#000080">, </font>NPort
    <font color="#FF0000"><b>in </b></font>al<font color="#000080">, </font>dx
    nop
    nop
    test al<font color="#000080">, </font><font color="#800000">08</font>h
    jz <font color="#000080">@@</font>WaitOn
<font color="#000080">@@</font>WaitOff<font color="#000080">:
    </font><font color="#FF0000"><b>in </b></font>al<font color="#000080">, </font>dx
    nop
    nop
    test al<font color="#000080">, </font><font color="#800000">08</font>h
    jnz <font color="#000080">@@</font>WaitOff
<font color="#000080">@@</font>WaitOn<font color="#000080">:
    </font><font color="#FF0000"><b>in </b></font>al<font color="#000080">, </font>dx
    nop
    nop
    test al<font color="#000080">, </font><font color="#800000">08</font>h
    jz <font color="#000080">@@</font>WaitOn
    mov dx<font color="#000080">, </font><font color="#800000">3</font>C8h
    mov ax<font color="#000080">, </font>CFirst
    <font color="#FF0000"><b>out </b></font>dx<font color="#000080">, </font>al
    nop
    nop
    lds si<font color="#000080">, </font>PTable
    les di<font color="#000080">, </font>Palette
    mov cx<font color="#000080">, </font><font color="#800000">3
    </font>mov ax<font color="#000080">, </font>Count
    mul cx
    mov cx<font color="#000080">, </font>ax
    mov dx<font color="#000080">, </font><font color="#800000">3</font>C9h
    cld
<font color="#000080">@@</font>WriteReg<font color="#000080">:
    </font>mov al<font color="#000080">, </font>es<font color="#000080">:[</font>di<font color="#000080">].</font>Byte
    cmp ds<font color="#000080">:[</font>si<font color="#000080">].</font>Byte<font color="#000080">, </font>al
    je <font color="#000080">@@</font>NotChange
    jb <font color="#000080">@@</font>Increase
    dec ds<font color="#000080">:[</font>si<font color="#000080">].</font>Byte
    jmp <font color="#000080">@@</font>IsChanged
<font color="#000080">@@</font>Increase<font color="#000080">:
    </font>inc ds<font color="#000080">:[</font>si<font color="#000080">].</font>Byte
<font color="#000080">@@</font>IsChanged<font color="#000080">:
    </font>mov bl<font color="#000080">, </font><font color="#800000">1
</font><font color="#000080">@@</font>NotChange<font color="#000080">:
    </font>inc di
    lodsb
    <font color="#FF0000"><b>out </b></font>dx<font color="#000080">, </font>al
    loop <font color="#000080">@@</font>WriteReg
    pop cx
    loop <font color="#000080">@@</font>NextStep
<font color="#000080">@@</font><font color="#FF0000"><b>End</b></font><font color="#000080">:
    </font>pop ds
    sti
  <font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{$IFNDEF DPMI}
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax, 1200h
    mov bl, 32h
    int 10h
    cmp al, 12h
    je @@VGA
    mov al, 0
    jmp @@ThatsAll
@@VGA:
    mov al, 1
@@ThatsAll:
    mov VGAPresent, al
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{$ENDIF}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0285.PAS">Original</a><b>]</b></p></body>
</html>
