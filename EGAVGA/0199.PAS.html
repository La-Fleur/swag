<html>
<head><title> "VESA Bank Switching in 640x480x256" by MARNIX TIMMERMANS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0199.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I don't think I need two seperate read and write-windows. With one
&gt; write-window I could still write to off-screen memory while the
&gt; display start is determing what is visible on the screen?
&gt; With one window, you can only access off-screen memory which is within
&gt; the bounds of the window granularity.  A typical example is a 64k
&gt; granularity and the bank set to have a window at the top of screen,
&gt; then you can't put data off-screen or at the bottom of a high
&gt; resolution screen without switching banks.  I don't understand how you
&gt; could write to off-screen memory outside the window (if that is what
&gt; you intend).

I know I can't do that, never mind about the rest. At the moment I'm
working on some scrolling in xmode 320x200 resolution. Things are going
pretty good so far, and I'm planning to port it to the vesa 640x480
resolution later. For my algorithm I would have to set the virtual
screen size to approx. 1300 pixels wide. That could result in as much as
480 / (64k / 1300) = 10 bank-switches per frame. (That's 700
bank-switches per second in a worst case situation)

I did some simple testing:
}

</i></font><font color="#FF0000"><b>program </b></font>TestBank<font color="#000080">;

</font><font color="#FF0000"><b>uses
  </b></font>Dos<font color="#000080">, </font>crt<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>gran <font color="#000080">= </font><font color="#800000">64</font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>clock <font color="#000080">: </font>longint <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0</font><font color="#000080">:</font><font color="#800000">$046c</font><font color="#000080">;
  </font>counter<font color="#000080">, </font>ticks <font color="#000080">: </font>longint<font color="#000080">;
  </font>rp <font color="#000080">: </font>registers<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>vio<font color="#000080">(</font>ax<font color="#000080">:</font>word<font color="#000080">);         </font><font color="#008000"><i>{INT 10h reg ax=AX. other reg. set from RP
                                 on return rp.ax=reg AX}
</i></font><font color="#FF0000"><b>begin
  </b></font>rp<font color="#000080">.</font>ax<font color="#000080">:=</font>ax<font color="#000080">;
  </font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>rp<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>viop<font color="#000080">(</font>ax<font color="#000080">,</font>bx<font color="#000080">,</font>cx<font color="#000080">,</font>dx<font color="#000080">:</font>word<font color="#000080">;</font>p<font color="#000080">:</font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>begin                            </b></font><font color="#008000"><i>{INT 10h reg AX-DX, ES:DI = p}
  </i></font>rp<font color="#000080">.</font>ax<font color="#000080">:=</font>ax<font color="#000080">;
  </font>rp<font color="#000080">.</font>bx<font color="#000080">:=</font>bx<font color="#000080">;
  </font>rp<font color="#000080">.</font>cx<font color="#000080">:=</font>cx<font color="#000080">;
  </font>rp<font color="#000080">.</font>dx<font color="#000080">:=</font>dx<font color="#000080">;
  </font>rp<font color="#000080">.</font>di<font color="#000080">:=</font>ofs<font color="#000080">(</font>p<font color="#000080">^);
  </font>rp<font color="#000080">.</font>es<font color="#000080">:=</font>seg<font color="#000080">(</font>p<font color="#000080">^);
  </font>intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>rp<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetBank<font color="#000080">( </font>bank <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>rp<font color="#000080">.</font>bx<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>bank<font color="#000080">:=</font>bank<font color="#000080">*</font>longint<font color="#000080">(</font><font color="#800000">64</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>gran<font color="#000080">;
  </font>rp<font color="#000080">.</font>dx<font color="#000080">:=</font>bank<font color="#000080">;
  </font>vio<font color="#000080">(</font><font color="#800000">$4f05</font><font color="#000080">);
  </font>rp<font color="#000080">.</font>bx<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
  </font>rp<font color="#000080">.</font>dx<font color="#000080">:=</font>bank<font color="#000080">;
  </font>vio<font color="#000080">(</font><font color="#800000">$4f05</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>viop<font color="#000080">(</font><font color="#800000">$4f02</font><font color="#000080">, </font><font color="#800000">$101</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">); </font><font color="#008000"><i>{ 640x480x256 }

  </i></font><font color="#FF0000"><b>for </b></font>counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">15 </font><font color="#FF0000"><b>do
  begin
    </b></font>setbank<font color="#000080">( </font>counter<font color="#000080">);
    </font>fillchar<font color="#000080">( </font>mem<font color="#000080">[</font><font color="#800000">$a000</font><font color="#000080">:</font><font color="#800000">0</font><font color="#000080">], </font><font color="#800000">65535</font><font color="#000080">, </font>counter<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>counter <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>ticks <font color="#000080">:= </font>clock<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>setbank<font color="#000080">( </font>counter <font color="#FF0000"><b>mod </b></font><font color="#800000">16</font><font color="#000080">);
    </font>inc<font color="#000080">( </font>counter<font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>clock <font color="#000080">= </font>ticks<font color="#000080">+</font><font color="#800000">90</font><font color="#000080">;

  </font>viop<font color="#000080">(</font><font color="#800000">$4f02</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">);

  </font>writeln<font color="#000080">(</font>counter <font color="#FF0000"><b>div </b></font><font color="#800000">5</font><font color="#000080">, </font><font color="#800000">' bank-switches/sec.'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'= '</font><font color="#000080">, </font><font color="#800000">5000</font><font color="#000080">/</font>counter <font color="#000080">: </font><font color="#800000">6 </font><font color="#000080">: </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">' msec / switch'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
and I get 0.0642 msec/switch with TLIVESA
and 0.0622 msec/switch with Univesa 3.2 (both vesa 1.2)

I think that's fast enough not to make me worry too much. That is,
unless you know of some cards that do bank-switching extremely slow.

&gt; VGA/VESA modes.  Scrolls and VESA text modes were added.  The approach
&gt; I've used is to tailor multiple versions for each drawing routine.  The
&gt; VGI library assigns the correct procedures whenever the video mode has
&gt; changed.  That way, there is a polymorphic mechanism of switching
&gt; drivers but without any execution speed penalties.  This allows me to
&gt; be able to plug-n-play drivers during testing.

All sounds good to me. I would like to see a demo and/or the interface
section of some units!
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0199.PAS">Original</a><b>]</b></p></body>
</html>
