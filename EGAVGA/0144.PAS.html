<html>
<head><title> "Checksums" by JOSE CAMPIONE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0144.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;  Checksums are not too secure. CRCs are better. In case a word
&gt;  checksum is enough for you...

&gt; I'm still not for sure on what this program is suppose to do for me.
&gt; What ever you are talking about above? I have no idea. Well
&gt; I hope to hear from you again, and maybe you can explain on what this
&gt; can do for me and how to use it in my program.

Ok. I hope the following examples will make things more clear
to you. Here are two programs. The first one (checksum.pas)
reads a word checksum stored in offset 12h of its own EXE
header. Then it calculates the checksum of its own compiled
code. If both values are the same it prints 'Yes!' else it
prints 'No!'. The second program (writecsum.pas) is a
&quot;utility&quot; that calculates the checksum word for the compiled
code of program checksum.exe and writes it to its header at
offset 12h. For your benefit, both programs use only Pascal
code. For obvious reason the checksum calculation skips the
header itself.

   1) Compile both programs into exe files.
   2) Run checksum.exe (it will respond 'No!' because its header
      does not contain the correct checksum).
   3) Run writecsum.exe (this will write the correct checksum into
      the header of checksum.exe)
   4) Run checksum.exe (it will respond 'Yes!')
   5) If the code of checksum.exe is messed in a way that
      its checksum is changed it will again respond 'No!'

{-------------------------------------------------}
{ This program prints 'Yes!' only if the checksum }
{ word stored in offset 12h of the EXE header is  }
{ the same as the one calculated by the program   }
{ on its own compiled code past the EXE header... }
{ -Jose- (1:163/513.3)                            }
{-------------------------------------------------}
</i></font><font color="#FF0000"><b>program </b></font>checksum<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>arr256 <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>f <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>numread <font color="#000080">: </font>word<font color="#000080">;
  </font>block   <font color="#000080">: </font>arr256<font color="#000080">;
  </font>csum    <font color="#000080">: </font>word<font color="#000080">;
  </font>headercsum <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>cmem<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>block<font color="#000080">:</font>arr256<font color="#000080">; </font>siz<font color="#000080">:</font>word<font color="#000080">): </font>word<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>r <font color="#000080">: </font>registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>r<font color="#000080">.</font>ax<font color="#000080">:= </font><font color="#800000">$121C</font><font color="#000080">;
  </font>r<font color="#000080">.</font>ds<font color="#000080">:= </font>seg<font color="#000080">(</font>block<font color="#000080">);
  </font>r<font color="#000080">.</font>si<font color="#000080">:= </font>ofs<font color="#000080">(</font>block<font color="#000080">);
  </font>r<font color="#000080">.</font>cx<font color="#000080">:= </font>siz<font color="#000080">;
  </font>r<font color="#000080">.</font>dx<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Intr<font color="#000080">(</font><font color="#800000">$2F</font><font color="#000080">,</font>r<font color="#000080">);
  </font>cmem<font color="#000080">:= </font>r<font color="#000080">.</font>dx<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>lo<font color="#000080">(</font>dosversion<font color="#000080">) &lt; </font><font color="#800000">3 </font><font color="#FF0000"><b>then begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Dos must be 3+...'</font><font color="#000080">);
    </font>halt<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>assign<font color="#000080">(</font>f<font color="#000080">,</font>paramstr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">));
  </font>reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">$12</font><font color="#000080">);  </font><font color="#008000"><i>{seek checksum word in exe header}
  </i></font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>headercsum<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font>seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">$1B</font><font color="#000080">);  </font><font color="#008000"><i>{skip exe header...}
  </i></font>csum<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat        </b></font><font color="#008000"><i>{calculate checksum word}
    </i></font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>block<font color="#000080">,</font>sizeof<font color="#000080">(</font>block<font color="#000080">),</font>numread<font color="#000080">);
    </font>inc<font color="#000080">(</font>csum<font color="#000080">,</font>cmem<font color="#000080">(</font>block<font color="#000080">,</font>numread<font color="#000080">));
  </font><font color="#FF0000"><b>until </b></font>eof<font color="#000080">(</font>f<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>numread <font color="#000080">&lt; </font>sizeof<font color="#000080">(</font>block<font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font>headercsum <font color="#000080">= </font>csum <font color="#FF0000"><b>then
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Yes! ('</font><font color="#000080">,</font>csum<font color="#000080">,</font><font color="#800000">')'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'No!'</font><font color="#000080">);
    </font>writeln<font color="#000080">(</font>headercsum<font color="#000080">);
    </font>writeln<font color="#000080">(</font>csum<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{-----------------------------------------------}
{ This program writes the checksum word of      }
{ checksum.exe in offset $12 of the EXE header  }
{ of the same program -Jose- (1:163/513.3)      }
{-----------------------------------------------}
</i></font><font color="#FF0000"><b>program </b></font>writcsum<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>DOS<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>arr256 <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>f <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>csum    <font color="#000080">: </font>word<font color="#000080">;
  </font>block   <font color="#000080">: </font>arr256<font color="#000080">;
  </font>numread <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>cmem<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>block<font color="#000080">:</font>arr256<font color="#000080">; </font>siz<font color="#000080">:</font>word<font color="#000080">): </font>word<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>r <font color="#000080">: </font>registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>r<font color="#000080">.</font>ax<font color="#000080">:= </font><font color="#800000">$121C</font><font color="#000080">;
  </font>r<font color="#000080">.</font>ds<font color="#000080">:= </font>seg<font color="#000080">(</font>block<font color="#000080">);
  </font>r<font color="#000080">.</font>si<font color="#000080">:= </font>ofs<font color="#000080">(</font>block<font color="#000080">);
  </font>r<font color="#000080">.</font>cx<font color="#000080">:= </font>siz<font color="#000080">;
  </font>r<font color="#000080">.</font>dx<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Intr<font color="#000080">(</font><font color="#800000">$2F</font><font color="#000080">,</font>r<font color="#000080">);
  </font>cmem<font color="#000080">:= </font>r<font color="#000080">.</font>dx<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>lo<font color="#000080">(</font>dosversion<font color="#000080">) &lt; </font><font color="#800000">3 </font><font color="#FF0000"><b>then begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Dos must be 3+...'</font><font color="#000080">);
    </font>halt<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>assign<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">'checksum.exe'</font><font color="#000080">);
  </font><font color="#008000"><i>{$I-} </i></font>reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>if </b></font>ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Cannot find file checksum.exe'</font><font color="#000080">);
    </font>halt<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">$1B</font><font color="#000080">); </font><font color="#008000"><i>{skip header...}
  </i></font>csum<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat       </b></font><font color="#008000"><i>{calculate checksum word}
    </i></font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>block<font color="#000080">,</font>sizeof<font color="#000080">(</font>block<font color="#000080">),</font>numread<font color="#000080">);
    </font>inc<font color="#000080">(</font>csum<font color="#000080">,</font>cmem<font color="#000080">(</font>block<font color="#000080">,</font>numread<font color="#000080">));
  </font><font color="#FF0000"><b>until </b></font>eof<font color="#000080">(</font>f<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>numread <font color="#000080">&lt; </font>sizeof<font color="#000080">(</font>block<font color="#000080">));
  </font>seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">$12</font><font color="#000080">); </font><font color="#008000"><i>{seek checksum word in exe header}
  </i></font>blockwrite<font color="#000080">(</font>f<font color="#000080">,</font>csum<font color="#000080">,</font>sizeof<font color="#000080">(</font>csum<font color="#000080">));
  </font>close<font color="#000080">(</font>f<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EGAVGA SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0144.PAS">Original</a><b>]</b></p></body>
</html>
