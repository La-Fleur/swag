<html>
<head><title> "ANSI File Dump" by ERIK ANDERSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ANSI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
ML&gt;p.p.s  I also need a routine (preferably in Turbo Pascal 7 ASM) that saves t
ML&gt;       content of the current screen in an ANSI file on the disk.  I saw one
ML&gt;       a while ago in SWAG, but I can't seem to find it now (I'm a dist site
ML&gt;       but still can't find it).

Also, since I didn't have anything better to do, I sat down and did a
version of your screen-&gt;ANSI.  It's rather primitive... it does a 80x24
dump with auto-EOLn seensing, does no CRLF if the line is 80 chars long
(relies on screen wrap) and no macroing. If you want to, you can add
macroing, which replaces a number of spaces with a single ANSI 'set
cursor' command. Well, here goes...

=================================================================== }

  </i></font><font color="#FF0000"><b>Procedure </b></font>Xlate<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>OutFile <font color="#000080">: </font>text<font color="#000080">); </font><font color="#008000"><i>{by Erik Anderson}
  {The screen is basically an array of elements, each element containing one
   a one-byte character and a one-byte color attribute}
  </i></font><font color="#FF0000"><b>const
    </b></font>NUMROWS <font color="#000080">= </font><font color="#800000">25</font><font color="#000080">;
    </font>NUMCOLS <font color="#000080">= </font><font color="#800000">80</font><font color="#000080">;
  </font><font color="#FF0000"><b>type
    </b></font>ElementType <font color="#000080">= </font><font color="#FF0000"><b>record
                    </b></font>ch   <font color="#000080">: </font>char<font color="#000080">;
                    </font>Attr <font color="#000080">: </font>byte<font color="#000080">;
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>ScreenType <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>NUMROWS<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">..</font>NUMCOLS<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>ElementType<font color="#000080">;

  </font><font color="#008000"><i>{The Attribute is structured as follows:
    bit 0: foreground blue element
    bit 1:     &quot;      green element
    bit 2:     &quot;      red element
    bit 3: high intensity flag
    bit 4: background blue element
    bit 5:     &quot;      green element
    bit 6:     &quot;      red element
    bit 7: flash flag

  The following constant masks help the program acess different parts
  of the attribute}
  </i></font><font color="#FF0000"><b>const
    </b></font>TextMask <font color="#000080">= </font><font color="#800000">$07</font><font color="#000080">; </font><font color="#008000"><i>{0000 0111}
    </i></font>BoldMask <font color="#000080">= </font><font color="#800000">$08</font><font color="#000080">; </font><font color="#008000"><i>{0000 1000}
    </i></font>BackMask <font color="#000080">= </font><font color="#800000">$70</font><font color="#000080">; </font><font color="#008000"><i>{0111 0000}
    </i></font>FlshMask <font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">; </font><font color="#008000"><i>{1000 0000}
    </i></font>BackShft <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;

    </font>ESC <font color="#000080">= </font><font color="#800000">#$1B</font><font color="#000080">;

  </font><font color="#008000"><i>{ANSI colors are not the same as IBM colors... this table fixes the
   discrepancy:}
    </i></font>ANSIcolors <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte <font color="#000080">= (</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">6</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">5</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">7</font><font color="#000080">);

    </font><font color="#008000"><i>{This procedure sends the new attribute to the ANSI dump file}
    </i></font><font color="#FF0000"><b>Procedure </b></font>ChangeAttr<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Outfile <font color="#000080">: </font>text<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>OldAtr <font color="#000080">: </font>byte<font color="#000080">; </font>NewAtr <font color="#000080">: </font>byte<font color="#000080">);
    </font><font color="#FF0000"><b>var
      </b></font>Connect <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]; </font><font color="#008000"><i>{Is a seperator needed?}
    </i></font><font color="#FF0000"><b>begin
      </b></font>Connect <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font>write<font color="#000080">(</font>Outfile<font color="#000080">, </font>ESC<font color="#000080">, </font><font color="#800000">'['</font><font color="#000080">); </font><font color="#008000"><i>{Begin sequence}
      </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>OldAtr <font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>BoldMask<font color="#000080">+</font>FlshMask<font color="#000080">)) &lt;&gt;     </font><font color="#008000"><i>{Output flash &amp; blink}
         </i></font><font color="#000080">(</font>NewAtr <font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>BoldMask<font color="#000080">+</font>FlshMask<font color="#000080">)) </font><font color="#FF0000"><b>then begin
        </b></font>write<font color="#000080">(</font>Outfile<font color="#000080">, </font><font color="#800000">'0'</font><font color="#000080">);
        </font><font color="#FF0000"><b>If </b></font>NewAtr <font color="#FF0000"><b>AND </b></font>BoldMask <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>write<font color="#000080">(</font>Outfile<font color="#000080">, </font><font color="#800000">';1'</font><font color="#000080">);
        </font><font color="#FF0000"><b>If </b></font>NewAtr <font color="#FF0000"><b>AND </b></font>FlshMask <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>write<font color="#000080">(</font>Outfile<font color="#000080">, </font><font color="#800000">';5'</font><font color="#000080">);
        </font>OldAtr <font color="#000080">:= </font><font color="#800000">$FF</font><font color="#000080">; </font>Connect <font color="#000080">:= </font><font color="#800000">';'</font><font color="#000080">;   </font><font color="#008000"><i>{Force other attr's to print}
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>If </b></font>OldAtr <font color="#FF0000"><b>AND </b></font>BackMask <font color="#000080">&lt;&gt; </font>NewAtr <font color="#FF0000"><b>AND </b></font>BackMask <font color="#FF0000"><b>then begin
        </b></font>write<font color="#000080">(</font>OutFile<font color="#000080">, </font>Connect<font color="#000080">,
              </font>ANSIcolors<font color="#000080">[(</font>NewAtr <font color="#FF0000"><b>AND </b></font>BackMask<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font>BackShft<font color="#000080">] + </font><font color="#800000">40</font><font color="#000080">);
        </font>Connect <font color="#000080">:= </font><font color="#800000">';'</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>If </b></font>OldAtr <font color="#FF0000"><b>AND </b></font>TextMask <font color="#000080">&lt;&gt; </font>NewAtr <font color="#FF0000"><b>AND </b></font>TextMask <font color="#FF0000"><b>then begin
        </b></font>write<font color="#000080">(</font>OutFile<font color="#000080">, </font>Connect<font color="#000080">,
              </font>ANSIcolors<font color="#000080">[</font>NewAtr <font color="#FF0000"><b>AND </b></font>TextMask<font color="#000080">] + </font><font color="#800000">30</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>write<font color="#000080">(</font>outfile<font color="#000080">, </font><font color="#800000">'m'</font><font color="#000080">); </font><font color="#008000"><i>{Terminate sequence}
      </i></font>OldAtr <font color="#000080">:= </font>NewAtr<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Does this character need a changing of the attribute?  If it is a space,
     then only the background color matters}

    </i></font><font color="#FF0000"><b>Function </b></font>AttrChanged<font color="#000080">(</font>Attr <font color="#000080">: </font>byte<font color="#000080">; </font>ThisEl <font color="#000080">: </font>ElementType<font color="#000080">) : </font>boolean<font color="#000080">;
    </font><font color="#FF0000"><b>var
      </b></font>Result <font color="#000080">: </font>boolean<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      </b></font>Result <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font>ThisEl<font color="#000080">.</font>ch <font color="#000080">= </font><font color="#800000">' ' </font><font color="#FF0000"><b>then begin
        If </b></font>ThisEl<font color="#000080">.</font>Attr <font color="#FF0000"><b>AND </b></font>BackMask <font color="#000080">&lt;&gt; </font>Attr <font color="#FF0000"><b>AND </b></font>BackMask <font color="#FF0000"><b>then
          </b></font>Result <font color="#000080">:= </font>TRUE<font color="#000080">;
      </font><font color="#FF0000"><b>end else begin
        If </b></font>ThisEl<font color="#000080">.</font>Attr <font color="#000080">&lt;&gt; </font>Attr <font color="#FF0000"><b>then </b></font>Result <font color="#000080">:= </font>TRUE<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>AttrChanged <font color="#000080">:= </font>Result<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>var
    </b></font>Screen   <font color="#000080">: </font>ScreenType <font color="#FF0000"><b>absolute </b></font><font color="#800000">$b800</font><font color="#000080">:</font><font color="#800000">0000</font><font color="#000080">;
    </font>ThisAttr<font color="#000080">, </font>TestAttr <font color="#000080">: </font>byte<font color="#000080">;
    </font>LoopRow<font color="#000080">, </font>LoopCol<font color="#000080">, </font>LineLen <font color="#000080">: </font>integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{Xlate}
    </i></font>ThisAttr <font color="#000080">:= </font><font color="#800000">$FF</font><font color="#000080">; </font><font color="#008000"><i>{Force attribute to be set}
    </i></font><font color="#FF0000"><b>For </b></font>LoopRow <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>NUMROWS <font color="#FF0000"><b>do begin

      </b></font>LineLen <font color="#000080">:= </font>NUMCOLS<font color="#000080">;   </font><font color="#008000"><i>{Find length of line}
      </i></font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>LineLen <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Screen<font color="#000080">[</font>LoopRow<font color="#000080">, </font>LineLen<font color="#000080">].</font>ch <font color="#000080">= </font><font color="#800000">' '</font><font color="#000080">)
            </font><font color="#FF0000"><b>and not </b></font>AttrChanged<font color="#000080">(</font><font color="#800000">$00</font><font color="#000080">, </font>Screen<font color="#000080">[</font>LoopRow<font color="#000080">, </font>LineLen<font color="#000080">])
        </font><font color="#FF0000"><b>do </b></font>Dec<font color="#000080">(</font>LineLen<font color="#000080">);

      </font><font color="#FF0000"><b>For </b></font>LoopCol <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>LineLen <font color="#FF0000"><b>do begin </b></font><font color="#008000"><i>{Send stream to file}
        </i></font><font color="#FF0000"><b>If </b></font>AttrChanged<font color="#000080">(</font>ThisAttr<font color="#000080">, </font>Screen<font color="#000080">[</font>LoopRow<font color="#000080">, </font>LoopCol<font color="#000080">])
          </font><font color="#FF0000"><b>then </b></font>ChangeAttr<font color="#000080">(</font>Outfile<font color="#000080">, </font>ThisAttr<font color="#000080">, </font>Screen<font color="#000080">[</font>LoopRow<font color="#000080">, </font>LoopCol<font color="#000080">].</font>Attr<font color="#000080">);
        </font>write<font color="#000080">(</font>Outfile<font color="#000080">, </font>Screen<font color="#000080">[</font>LoopRow<font color="#000080">, </font>LoopCol<font color="#000080">].</font>ch<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>LineLen <font color="#000080">&lt; </font><font color="#800000">80 </font><font color="#FF0000"><b>then </b></font>writeln<font color="#000080">(</font>OutFile<font color="#000080">); </font><font color="#008000"><i>{else wraparound occurs}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Xlate}

</i></font><font color="#FF0000"><b>var
  </b></font>OutFile <font color="#000080">: </font>text<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>OutFile<font color="#000080">, </font><font color="#800000">'dump.scn'</font><font color="#000080">);
  </font>Rewrite<font color="#000080">(</font>OutFile<font color="#000080">);
  </font>Xlate<font color="#000080">(</font>OUtFile<font color="#000080">);
  </font>Close<font color="#000080">(</font>OUtFile<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ANSI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p></body>
</html>
