<html>
<head><title> "Double and Triple Buffering" by MARCIN BORKOWSKI</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0174.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;&gt; You are using THREE different screens (no problem in x-mode).
&gt;&gt; One (A) is displayed, second (B) is waiting, third (C) is
&gt;&gt; being drawn. After third C is ready B is being displayed
&gt;&gt; and A is being drawn. No flickering, no waiting, no
&gt;&gt; problem...

&gt; That makes sense.  Is there anyway to hook an interrupt
&gt; to the vertical retrace to keep it automatic?

Yes, and no - it depends on VGA card. In theory it should be able to generate
IRQ 2 on retrace, but in fact one nevr now what's going on in a particular
computer. Sometimes it can be changed by a jumper on a VGA card, sometimes
not...

&gt; (By the way, it still would be limited to the Vert retrace because you
&gt; can't change from a to b until there is a Retrace, so you would just
&gt; allow more variety in speed of drawing screens with triple buffering
&gt; (ie. you can draw one fast and one really slow (alternating) if the total
&gt; of both is less than two vertical retraces)).

One program is worth a thousand words ;-)
}

</i></font><font color="#FF0000"><b>program </b></font>buffexm<font color="#000080">;

</font><font color="#008000"><i>{ Example of a double and tripple buffering in video memory.
  (c) by Borek (Marcin Borkowski), 2:480/25. Program is
  slow because of primitive drawbox procedure, but precisely
  shows how to use dbl and trpl buffering to achieve perfect,
  non-flickering screen displays. }

</i></font><font color="#FF0000"><b>uses </b></font>crt<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>speed <font color="#000080">= </font><font color="#800000">40</font><font color="#000080">; </font><font color="#008000"><i>{ Speed of a program - lover values, faster action.
                As effect depends on your computer speed, try to
                experiment with this value. }

</i></font><font color="#FF0000"><b>var
  </b></font>scrofs<font color="#000080">,</font>time <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Enter4PlaneMode<font color="#000080">; </font><font color="#008000"><i>{ so called x-mode }
</i></font><font color="#FF0000"><b>begin
  </b></font>Port<font color="#000080">[</font><font color="#800000">$3CE</font><font color="#000080">]:=</font><font color="#800000">5</font><font color="#000080">;   </font>Port<font color="#000080">[</font><font color="#800000">$3CF</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$3CF</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$FB</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$3CE</font><font color="#000080">]:=</font><font color="#800000">6</font><font color="#000080">;   </font>Port<font color="#000080">[</font><font color="#800000">$3CF</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$3CF</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$FD</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$3C4</font><font color="#000080">]:=</font><font color="#800000">4</font><font color="#000080">;   </font>Port<font color="#000080">[</font><font color="#800000">$3C5</font><font color="#000080">]:=(</font>Port<font color="#000080">[</font><font color="#800000">$3C5</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$F7</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#800000">4</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$3D4</font><font color="#000080">]:=</font><font color="#800000">$14</font><font color="#000080">; </font>Port<font color="#000080">[</font><font color="#800000">$3D5</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$3D5</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$BF</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$3D4</font><font color="#000080">]:=</font><font color="#800000">$17</font><font color="#000080">; </font>Port<font color="#000080">[</font><font color="#800000">$3D5</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$3D5</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$40</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetStartAddress<font color="#000080">(</font>w <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ Sets start address of displayed video memory. }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$3D4</font><font color="#000080">]:=</font><font color="#800000">$0C</font><font color="#000080">; </font>Port<font color="#000080">[</font><font color="#800000">$3D5</font><font color="#000080">]:=</font>Hi<font color="#000080">(</font>w<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$3D4</font><font color="#000080">]:=</font><font color="#800000">$0D</font><font color="#000080">; </font>Port<font color="#000080">[</font><font color="#800000">$3D5</font><font color="#000080">]:=</font>Lo<font color="#000080">(</font>w<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>WaitForRetrace<font color="#000080">;
</font><font color="#FF0000"><b>begin
  repeat until </b></font><font color="#000080">(</font>port<font color="#000080">[</font><font color="#800000">$03DA</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">8</font><font color="#000080">)=</font><font color="#800000">8</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>port<font color="#000080">[</font><font color="#800000">$03DA</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">8</font><font color="#000080">)=</font><font color="#800000">0
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>clrscreen<font color="#000080">(</font>a <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ Fills all bitplanes at once with zeros, but only in
  a part of video memory. }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$3C4</font><font color="#000080">]:=</font><font color="#800000">2</font><font color="#000080">;  </font>Port<font color="#000080">[</font><font color="#800000">$3C5</font><font color="#000080">]:=</font><font color="#800000">$0F</font><font color="#000080">;
  </font>fillchar<font color="#000080">(</font>mem<font color="#000080">[</font><font color="#800000">$A000</font><font color="#000080">:</font>a<font color="#000080">],</font><font color="#800000">16384</font><font color="#000080">,</font><font color="#800000">#0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>drawbox<font color="#000080">(</font>x<font color="#000080">,</font>y <font color="#000080">: </font>word<font color="#000080">;</font>c <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">,</font>j<font color="#000080">,</font>a <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ Port writes are used to define which bitplane is used. }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$3C4</font><font color="#000080">]:=</font><font color="#800000">2</font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font>x <font color="#FF0000"><b>to </b></font>x<font color="#000080">+</font><font color="#800000">10 </font><font color="#FF0000"><b>do
  begin
    </b></font>Port<font color="#000080">[</font><font color="#800000">$3C5</font><font color="#000080">]:=</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font><font color="#000080">(</font>i <font color="#FF0000"><b>and </b></font><font color="#800000">3</font><font color="#000080">);
    </font>a<font color="#000080">:=</font>scrofs<font color="#000080">+</font>i <font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">+</font><font color="#800000">80</font><font color="#000080">*</font>y<font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>j<font color="#000080">:=</font>y <font color="#FF0000"><b>to </b></font>y<font color="#000080">+</font><font color="#800000">10 </font><font color="#FF0000"><b>do
    begin
      </b></font>mem<font color="#000080">[</font><font color="#800000">$A000</font><font color="#000080">:</font>a<font color="#000080">]:=</font>c<font color="#000080">;
      </font>inc<font color="#000080">(</font>a<font color="#000080">,</font><font color="#800000">80</font><font color="#000080">)
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>animate1<font color="#000080">;
</font><font color="#008000"><i>{ No buffering example. }
</i></font><font color="#FF0000"><b>var
  </b></font>x<font color="#000080">,</font>y <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  repeat
    </b></font>clrscreen<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
    </font>drawbox<font color="#000080">(</font>round<font color="#000080">(</font><font color="#800000">150</font><font color="#000080">+</font><font color="#800000">60</font><font color="#000080">*</font>cos<font color="#000080">(</font>time<font color="#000080">/</font>speed<font color="#000080">)),
            </font>round<font color="#000080">(</font><font color="#800000">90</font><font color="#000080">+</font><font color="#800000">60</font><font color="#000080">*</font>sin<font color="#000080">(</font>time<font color="#000080">/</font>speed<font color="#000080">)),</font><font color="#800000">7</font><font color="#000080">);
</font><font color="#008000"><i>{   WaitForRetrace;  Try with and without. Effect depends }
    </i></font>inc<font color="#000080">(</font>time<font color="#000080">)       </font><font color="#008000"><i>{ on your computer speed. }
  </i></font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>animate2<font color="#000080">;
</font><font color="#008000"><i>{ Double buffering example. There are two virtual screens -
  one at $A000:0, second at $A000:$4000 }
</i></font><font color="#FF0000"><b>var
  </b></font>x<font color="#000080">,</font>y  <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  repeat
    </b></font>clrscreen<font color="#000080">(</font>scrofs<font color="#000080">);
    </font>drawbox<font color="#000080">(</font>round<font color="#000080">(</font><font color="#800000">150</font><font color="#000080">+</font><font color="#800000">60</font><font color="#000080">*</font>cos<font color="#000080">(</font>time<font color="#000080">/</font>speed<font color="#000080">)),
            </font>round<font color="#000080">(</font><font color="#800000">90</font><font color="#000080">+</font><font color="#800000">60</font><font color="#000080">*</font>sin<font color="#000080">(</font>time<font color="#000080">/</font>speed<font color="#000080">)),</font><font color="#800000">15</font><font color="#000080">);
    </font>inc<font color="#000080">(</font>time<font color="#000080">);
    </font>setstartaddress<font color="#000080">(</font>scrofs<font color="#000080">);
    </font>WaitForRetrace<font color="#000080">; </font><font color="#008000"><i>{ Screen is flickering without this. }
    </i></font>scrofs<font color="#000080">:=</font><font color="#800000">$4000</font><font color="#000080">-</font>scrofs<font color="#000080">;
  </font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>animate3<font color="#000080">;
</font><font color="#008000"><i>{ Triple buffering example. In fact there are four virtual screens,
  at $A000:0, $A000:$4000, $A000:$8000 and at $A000:$C000, but if you
  use three screens the effect will remain the same.
  No waiting for retrace, no flickering. Speed of rectangle moves
  depends _only_ on a computer speed. You may add WaitForRetrace to
  allow synchronization. }
</i></font><font color="#FF0000"><b>var
  </b></font>x<font color="#000080">,</font>y  <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  repeat
    </b></font>clrscreen<font color="#000080">(</font>scrofs<font color="#000080">);
    </font>drawbox<font color="#000080">(</font>round<font color="#000080">(</font><font color="#800000">150</font><font color="#000080">+</font><font color="#800000">60</font><font color="#000080">*</font>cos<font color="#000080">(</font>time<font color="#000080">/</font>speed<font color="#000080">)),
            </font>round<font color="#000080">(</font><font color="#800000">90</font><font color="#000080">+</font><font color="#800000">60</font><font color="#000080">*</font>sin<font color="#000080">(</font>time<font color="#000080">/</font>speed<font color="#000080">)),</font><font color="#800000">13</font><font color="#000080">);
    </font>inc<font color="#000080">(</font>time<font color="#000080">);
    </font>setstartaddress<font color="#000080">(</font>scrofs<font color="#000080">);
    </font>inc<font color="#000080">(</font>scrofs<font color="#000080">,</font><font color="#800000">$4000</font><font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  asm </b></font><font color="#FF00FF">mov ax,13h; int 10h </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>enter4planemode<font color="#000080">;
  </font>time<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>animate1<font color="#000080">; </font>readkey<font color="#000080">; </font><font color="#008000"><i>{ Fast, but always flickers }
  </i></font>animate2<font color="#000080">; </font>readkey<font color="#000080">; </font><font color="#008000"><i>{ No flickering but slow - must wait for retrace }
  </i></font>animate3<font color="#000080">; </font>readkey<font color="#000080">; </font><font color="#008000"><i>{ Same speed as in animate1, no flickering }
  </i></font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax,03h; int 10h </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0174.PAS">Original</a><b>]</b></p></body>
</html>
