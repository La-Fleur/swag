<html>
<head><title> "PCX *IN* Pascal!" by RICKY BOOTH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0088.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>

<font color="#000000"> <font color="#000080">&gt; </font>Does anyone have a <font color="#FF0000"><b>program </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>necessarily source<font color="#000080">) </font>that will
 <font color="#000080">&gt; </font>take a full
 <font color="#000080">&gt; </font>screen GIF <font color="#FF0000"><b>or </b></font>PCX <font color="#FF0000"><b>or </b></font>whatever graphic format <font color="#FF0000"><b>and </b></font>convert it into
 <font color="#000080">&gt; </font>something I can load <font color="#FF0000"><b>in Pascal</b></font><font color="#000080">?  </font><font color="#FF0000"><b>Or </b></font>even a graphic editor that

You can load a <font color="#000080">.</font>PCX <font color="#FF0000"><b>in pascal</b></font><font color="#000080">! </font>No conversion needed<font color="#000080">. </font>Here <font color="#FF0000"><b>is </b></font>some source<font color="#000080">.

</font><font color="#008000"><i>{ MCGA PCX decode by Bas van Gaalen, Holland, PD }
{ Modified to use virtual screen/pointers by Ricky Booth, USA, PD }


{$M 65520, 4096, 655360}
{$I-}

</i></font><font color="#FF0000"><b>program </b></font>pcx_view<font color="#000080">;

</font><font color="#FF0000"><b>uses
  </b></font>crt<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>pcxheader <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>manufacturer<font color="#000080">,</font>version<font color="#000080">,</font>encoding<font color="#000080">,</font>bits_per_pixel <font color="#000080">: </font>byte<font color="#000080">;
    </font>xmin<font color="#000080">,</font>ymin<font color="#000080">,</font>xmax<font color="#000080">,</font>ymax<font color="#000080">,</font>hres<font color="#000080">,</font>vres <font color="#000080">: </font>word<font color="#000080">;
    </font>palette <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">47</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>reserved <font color="#000080">: </font>byte<font color="#000080">;
    </font>color_planes <font color="#000080">: </font>byte<font color="#000080">;
    </font>bytes_per_line <font color="#000080">: </font>word<font color="#000080">;
    </font>palette_type <font color="#000080">: </font>word<font color="#000080">;
    </font>filler <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">57</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>pcxfile <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>header <font color="#000080">: </font>pcxheader<font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>procedure </b></font>error<font color="#000080">(</font>errstr <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>writeln<font color="#000080">(</font>errstr<font color="#000080">);
  </font>halt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>function </b></font>validpcx <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>seek<font color="#000080">(</font>pcxfile<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font>blockread<font color="#000080">(</font>pcxfile<font color="#000080">,</font>header<font color="#000080">,</font>sizeof<font color="#000080">(</font>header<font color="#000080">));
  </font><font color="#FF0000"><b>with </b></font>header <font color="#FF0000"><b>do </b></font>validpcx <font color="#000080">:= (</font>manufacturer <font color="#000080">= </font><font color="#800000">10</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>version <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">) </font><font color="#FF0000"><b>and
    </b></font><font color="#000080">(</font>bits_per_pixel <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>color_planes <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>function </b></font>validpal <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>v <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>seek<font color="#000080">(</font>pcxfile<font color="#000080">,</font>filesize<font color="#000080">(</font>pcxfile<font color="#000080">)-</font><font color="#800000">769</font><font color="#000080">);
  </font>blockread<font color="#000080">(</font>pcxfile<font color="#000080">,</font>v<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>validpal <font color="#000080">:= </font>v <font color="#000080">= </font><font color="#800000">$0c</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>procedure </b></font>setvideo<font color="#000080">(</font>md <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,md
  int 10h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>CONST </b></font>VGA <font color="#000080">= </font><font color="#800000">$a000</font><font color="#000080">;  </font><font color="#008000"><i>(* This sets the constant VGA to the segment of the
                       VGA screen.                                      *)

</i></font><font color="#FF0000"><b>Type Virtual </b></font><font color="#000080">= </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">64000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;  </font><font color="#008000"><i>{ The size of our Virtual Screen }
     </i></font>VirtPtr <font color="#000080">= ^</font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;                  </font><font color="#008000"><i>{ Pointer to the virtual screen }

</i></font><font color="#FF0000"><b>VAR </b></font>Virscr <font color="#000080">: </font>VirtPtr<font color="#000080">;                     </font><font color="#008000"><i>{ Our first Virtual screen }
    </i></font>Vaddr  <font color="#000080">: </font>word<font color="#000080">;                        </font><font color="#008000"><i>{ The segment of our virtual screen}

</i></font><font color="#FF0000"><b>procedure </b></font>setpal<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>pal <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>seek<font color="#000080">(</font>pcxfile<font color="#000080">,</font>filesize<font color="#000080">(</font>pcxfile<font color="#000080">)-</font><font color="#800000">768</font><font color="#000080">);
  </font>blockread<font color="#000080">(</font>pcxfile<font color="#000080">,</font>pal<font color="#000080">,</font><font color="#800000">768</font><font color="#000080">);
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">cld
    xor di,di
    xor bx,bx
   @L1:
    mov dx,03c8h
    mov ax,bx
    out dx,al
    inc dx
    mov cx,3
   @L2:
    mov al,byte ptr pal[di]
    shr al,1
    shr al,1
    out dx,al
    inc di
    loop @L2
    inc bx
    cmp bx,256
    jne @L1
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetUpVirtual<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>GetMem <font color="#000080">(</font>VirScr<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);
  </font>vaddr <font color="#000080">:= </font>seg <font color="#000080">(</font>virscr<font color="#000080">^);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>unpack<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>gofs<font color="#000080">,</font>j <font color="#000080">: </font>word<font color="#000080">; </font>i<font color="#000080">,</font>k<font color="#000080">,</font>v<font color="#000080">,</font>loop <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>seek<font color="#000080">(</font>pcxfile<font color="#000080">,</font><font color="#800000">128</font><font color="#000080">);
  </font>gofs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>header<font color="#000080">.</font>ymax<font color="#000080">-</font>header<font color="#000080">.</font>ymin<font color="#000080">+</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
    </b></font>j <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font>j <font color="#000080">&lt; </font>header<font color="#000080">.</font>bytes_per_line <font color="#FF0000"><b>do begin
      </b></font>blockread<font color="#000080">(</font>pcxfile<font color="#000080">,</font>v<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>v <font color="#FF0000"><b>and </b></font><font color="#800000">192</font><font color="#000080">) = </font><font color="#800000">192 </font><font color="#FF0000"><b>then begin
        </b></font>loop <font color="#000080">:= </font>v <font color="#FF0000"><b>and </b></font><font color="#800000">63</font><font color="#000080">;
        </font>inc<font color="#000080">(</font>j<font color="#000080">,</font>loop<font color="#000080">);
        </font>blockread<font color="#000080">(</font>pcxfile<font color="#000080">,</font>v<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
        </font><font color="#FF0000"><b>for </b></font>k <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>loop <font color="#FF0000"><b>do begin
          </b></font>Mem<font color="#000080">[</font>Vaddr<font color="#000080">:</font>gofs<font color="#000080">] := </font>v<font color="#000080">;
          </font>inc<font color="#000080">(</font>gofs<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end
      else begin
        </b></font>Mem<font color="#000080">[</font>Vaddr<font color="#000080">:</font>gofs<font color="#000080">] := </font>v<font color="#000080">;
        </font>inc<font color="#000080">(</font>gofs<font color="#000080">);
        </font>inc<font color="#000080">(</font>j<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>WaitRetrace<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label
  </b></font>l1<font color="#000080">, </font>l2<font color="#000080">;
</font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov dx,3DAh
l1:
    in al,dx
    and al,08h
    jnz l1
l2:
    in al,dx
    and al,08h
    jz  l2
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>begin
  </b></font>SetUpVirtual<font color="#000080">; </font><font color="#008000"><i>(*initilizes the pointers*)
  </i></font><font color="#FF0000"><b>if </b></font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) = </font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font>error<font color="#000080">(</font><font color="#800000">'Enter filename on commandline.'</font><font color="#000080">);
  </font>assign<font color="#000080">(</font>pcxfile<font color="#000080">,</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
  </font>reset<font color="#000080">(</font>pcxfile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>error<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)+</font><font color="#800000">' not found.'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if not </b></font>validpcx <font color="#FF0000"><b>then </b></font>error<font color="#000080">(</font><font color="#800000">'Not a 256 color PCX file.'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if not </b></font>validpal <font color="#FF0000"><b>then </b></font>error<font color="#000080">(</font><font color="#800000">'Palette corrupt.'</font><font color="#000080">);
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Decoding Image...'</font><font color="#000080">);
  </font>Unpack<font color="#000080">;
  </font>Setvideo<font color="#000080">(</font><font color="#800000">$13</font><font color="#000080">);
  </font>Setpal<font color="#000080">;
  </font>Move<font color="#000080">(</font>Virscr<font color="#000080">^,</font>MEM<font color="#000080">[</font>VGA<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">],</font><font color="#800000">64000</font><font color="#000080">); </font><font color="#008000"><i>(*Stick the virtual page to the vga mem*)
  </i></font><font color="#FF0000"><b>repeat until </b></font>keypressed<font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font>keypressed <font color="#FF0000"><b>do </b></font>readln<font color="#000080">;
  </font>setvideo<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">);
  </font>close<font color="#000080">(</font>pcxfile<font color="#000080">);
  </font>FreeMem <font color="#000080">(</font>VirScr<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">); </font><font color="#008000"><i>(*Free up virtual memory*)
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0088.PAS">Original</a><b>]</b></p></body>
</html>
