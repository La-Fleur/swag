<html>
<head><title> "Fast PUTIMAGE" by PETR SULLA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0236.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>fastputimage<font color="#000080">;

</font><font color="#008000"><i>{
 *******************************************************
 *                *VERY* FAST PUTIMAGE                 *
 *******************************************************
 *                (C) Petr Sulla 1996                  *
 *             E-mail: xsulla@fi.muni.cz               *
 *******************************************************
 *  Public domain, use at your own risk. Enjoy it !!!  *
 *******************************************************


 Hi all ! I was just in need of a *REALLY* fast putimage but I couldn't
 find it anywhere. So I sat down for a couple of hours and here it is !
 The FASTEST putimage I've ever seen.

 The x-position must be a multiplicate of 8 due to the VGA/EGA
 memory organisation. (will be automatically rounded)

 The image should not exceed the screen size (this case is not tested
 and could cause strange results...

 The image structure is *not* compatible with the Borland's one.
 Old images can be easily converted by displaying them and then
 saving them using this new getimage.

 It could be possibly even faster - some code optimization could help.
 I find it fast enough as it is now, anyway ;-)

 An example follows.
 }

</i></font><font color="#FF0000"><b>interface

</b></font><font color="#008000"><i>{$g+}

</i></font><font color="#FF0000"><b>function </b></font>myimagesize<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>x0<font color="#000080">,</font>y0<font color="#000080">:</font>word<font color="#000080">):</font>word<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>mygetimage<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>x0<font color="#000080">,</font>y0<font color="#000080">:</font>word<font color="#000080">;</font>p<font color="#000080">:</font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>myputimage<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font>p<font color="#000080">:</font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>waitretrace<font color="#000080">;

</font><font color="#FF0000"><b>implementation

function </b></font>myimagesize<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>x0<font color="#000080">,</font>y0<font color="#000080">:</font>word<font color="#000080">):</font>word<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>dummy<font color="#000080">:</font>longint<font color="#000080">;
    </font>sx<font color="#000080">,</font>sy<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>sx<font color="#000080">:=</font>succ<font color="#000080">(</font>abs<font color="#000080">(</font>x0<font color="#000080">-</font>x<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">8</font><font color="#000080">);
  </font>sy<font color="#000080">:=</font>succ<font color="#000080">(</font>abs<font color="#000080">(</font>y0<font color="#000080">-</font>y<font color="#000080">));
  </font>dummy<font color="#000080">:=</font>sx<font color="#000080">*</font>sy<font color="#000080">*</font><font color="#800000">4</font><font color="#000080">+</font><font color="#800000">10</font><font color="#000080">;        </font><font color="#008000"><i>{*4 because of 4 bitplanes}
  </i></font><font color="#FF0000"><b>if </b></font>dummy<font color="#000080">&lt;</font><font color="#800000">65520 </font><font color="#FF0000"><b>then
    </b></font>myimagesize<font color="#000080">:=</font>dummy
  <font color="#FF0000"><b>else
    </b></font>myimagesize<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>mygetimage<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>x0<font color="#000080">,</font>y0<font color="#000080">:</font>word<font color="#000080">;</font>p<font color="#000080">:</font>pointer<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>m<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">sti
    push es
    push ds
    cld                              </font><font color="#008000"><i>{rep adds}
    </i></font><font color="#FF00FF">les di,[p]                       </font><font color="#008000"><i>{x0 &lt;- width, y0 &lt;- height, write to buffer}
    </i></font><font color="#FF00FF">mov ax,x0
    sub ax,x
    shr ax,3                         </font><font color="#008000"><i>{x0:=x0 div 8}
    </i></font><font color="#FF00FF">mov x0,ax
    mov es:[di],ax
    inc x0
    mov ax,y0
    sub ax,y
    mov y0,ax
    mov es:[di+2],ax
    inc y0
    add di,4                         </font><font color="#008000"><i>{es:di &lt;- pointer to data}
    </i></font><font color="#FF00FF">shr x,3                          </font><font color="#008000"><i>{x:=x div 8}
    </i></font><font color="#FF00FF">mov bx,y                         </font><font color="#008000"><i>{m:=y*80+x - offset in vram}
    </i></font><font color="#FF00FF">mov cx,bx
    shl bx,4
    shl cx,6
    add bx,cx
    add bx,x
    mov m,bx
    mov ax,0a000h                    </font><font color="#008000"><i>{ds:si &lt;- beginning of vram}
    </i></font><font color="#FF00FF">mov ds,ax
    mov bx,y0                        </font><font color="#008000"><i>{bx - lines counter}
    </i></font><font color="#FF00FF">mov dx,03ceh                     </font><font color="#008000"><i>{dx - port address}
    </i></font><font color="#FF00FF">mov al,4
    out dx,al
    inc dx
@@1:
    mov ah,4                         </font><font color="#008000"><i>{ah - 3=1.bit plane, 2=2.bitpl.,1=3.bitpl.,0=4.bitpl.}
</i></font><font color="#FF00FF">@@2:
    mov al,ah
    dec al
    out dx,al                        </font><font color="#008000"><i>{send number of bitplane to the graphic card}
    </i></font><font color="#FF00FF">mov si,m                         </font><font color="#008000"><i>{offset in videoram}
    </i></font><font color="#FF00FF">mov cx,x0                        </font><font color="#008000"><i>{image width to counter}
    </i></font><font color="#FF00FF">rep movsb                        </font><font color="#008000"><i>{send  cx bytes from DS:SI(vram) to ES:DI(image)}
    </i></font><font color="#FF00FF">dec ah                           </font><font color="#008000"><i>{decrement al - next bitplane}
    </i></font><font color="#FF00FF">jnz @@2                          </font><font color="#008000"><i>{is zero ? - no=next bitplane}
    </i></font><font color="#FF00FF">add m,80                         </font><font color="#008000"><i>{next line in vram}
    </i></font><font color="#FF00FF">dec bx                           </font><font color="#008000"><i>{decrement lines counter}
    </i></font><font color="#FF00FF">jnz @@1                          </font><font color="#008000"><i>{last line  ? no=next line}
    </i></font><font color="#FF00FF">dec dx                           </font><font color="#008000"><i>{set graphic card back to std. modus}
    </i></font><font color="#FF00FF">mov al,3
    out dx,al
    inc dx
    xor al,al
    out dx,al
    pop ds
    pop es
    cli
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>myputimage<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font>p<font color="#000080">:</font>pointer<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>sx<font color="#000080">,</font>sy<font color="#000080">,</font>m<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">sti
    push es
    push ds
    cld                              </font><font color="#008000"><i>{rep adds}
    </i></font><font color="#FF00FF">shr x,3                          </font><font color="#008000"><i>{x:=x div 8}
    </i></font><font color="#FF00FF">mov bx,y                         </font><font color="#008000"><i>{m:=y*80+x - offset in vram}
    </i></font><font color="#FF00FF">mov cx,bx
    shl bx,4
    shl cx,6
    add bx,cx
    add bx,x
    mov m,bx
    lds si,[p]                       </font><font color="#008000"><i>{sx &lt;- width, sy &lt;- height}
    </i></font><font color="#FF00FF">mov ax,word ptr ds:[si]
    inc ax
    mov sx,ax
    mov ax,word ptr ds:[si+2]
    inc ax
    mov sy,ax
    add si,4                         </font><font color="#008000"><i>{ds:si &lt;- pointer to data}
    </i></font><font color="#FF00FF">mov ax,0a000h                    </font><font color="#008000"><i>{es:di &lt;- beginning of vram}
    </i></font><font color="#FF00FF">mov es,ax
    mov bx,sy                        </font><font color="#008000"><i>{bx - lines counter}
    </i></font><font color="#FF00FF">mov dx,03c4h                     </font><font color="#008000"><i>{dx - port address}
    </i></font><font color="#FF00FF">mov al,2
    out dx,al
    inc dx
@@1:
    mov al,8                         </font><font color="#008000"><i>{al - 8=1.bit plane, 4=2.bitpl.,2=3.bpl.,1=4.bpl.}
</i></font><font color="#FF00FF">@@2:
    out dx,al                        </font><font color="#008000"><i>{send bitplane number to the graphic card}
    </i></font><font color="#FF00FF">mov di,m                         </font><font color="#008000"><i>{offset in videoram}
    </i></font><font color="#FF00FF">mov cx,sx                        </font><font color="#008000"><i>{image width to counter}
    </i></font><font color="#FF00FF">rep movsb                        </font><font color="#008000"><i>{send cx bytes from DS:SI(image) to ES:DI(vram)}
    </i></font><font color="#FF00FF">shr al,1                         </font><font color="#008000"><i>{divide al by 2 - next bitplane of 4}
    </i></font><font color="#FF00FF">jnz @@2                          </font><font color="#008000"><i>{is zero ? - no=next bitplane}
    </i></font><font color="#FF00FF">add m,80                         </font><font color="#008000"><i>{next line in vram}
    </i></font><font color="#FF00FF">dec bx                           </font><font color="#008000"><i>{decrement lines counter}
    </i></font><font color="#FF00FF">jnz @@1                          </font><font color="#008000"><i>{last line ? no=next line}
    </i></font><font color="#FF00FF">dec dx                           </font><font color="#008000"><i>{set graphic card back to std. modus}
    </i></font><font color="#FF00FF">mov al,2
    out dx,al
    inc dx
    mov al,15
    out dx,al
    pop ds
    pop es
    cli
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>waitretrace<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;    </font><font color="#008000"><i>{can be handy for smooth animation}
</i></font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov dx,$3da
@1:     in al,dx
        test al,8
        jz @1
@2:     in al,dx
        test al,8
        jnz @2
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{------------- 8&lt; ------ Cut here ---------- 8&lt; ----------------------}

{
 *******************************************************
 *                FAST PUTIMAGE EXAMPLE                *
 *******************************************************
 *                 (C) Petr Sulla 1996                 *
 *              E-mail: xsulla@fi.muni.cz              *
 *******************************************************
 *    Public domain, use at your own risk. Enjoy !!!   *
 *******************************************************
 }

</i></font><font color="#FF0000"><b>uses </b></font>crt<font color="#000080">,</font>graph<font color="#000080">,</font>fastputimage<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>gd<font color="#000080">,</font>gm<font color="#000080">:</font>integer<font color="#000080">;
    </font>p<font color="#000080">,</font>q<font color="#000080">:</font>pointer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>garbage<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>i<font color="#000080">,</font>j<font color="#000080">,</font>k<font color="#000080">:</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">80 </font><font color="#FF0000"><b>do
    begin
      </b></font>j<font color="#000080">:=</font>random<font color="#000080">(</font><font color="#800000">15</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
      </font>setcolor<font color="#000080">(</font>j<font color="#000080">);
      </font>setfillstyle<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>j<font color="#000080">);
      </font>j<font color="#000080">:=</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">);
      </font>k<font color="#000080">:=</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">);
      </font><font color="#FF0000"><b>case </b></font>random<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>of
       </b></font><font color="#800000">0</font><font color="#000080">:</font>rectangle<font color="#000080">(</font>j<font color="#000080">,</font>k<font color="#000080">,</font>j<font color="#000080">+</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">),</font>k<font color="#000080">+</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">));
       </font><font color="#800000">1</font><font color="#000080">:</font>bar<font color="#000080">(</font>j<font color="#000080">,</font>k<font color="#000080">,</font>j<font color="#000080">+</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">),</font>k<font color="#000080">+</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">));
       </font><font color="#800000">2</font><font color="#000080">:</font>circle<font color="#000080">(</font>j<font color="#000080">,</font>k<font color="#000080">,</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">));
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>gd<font color="#000080">:=</font>detect<font color="#000080">;
  </font>initgraph<font color="#000080">(</font>gd<font color="#000080">,</font>gm<font color="#000080">,</font><font color="#800000">''</font><font color="#000080">);  </font><font color="#008000"><i>{&lt;- insert path to your egavga.bgi here}

  </i></font>getmem<font color="#000080">(</font>p<font color="#000080">,</font>myimagesize<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">343</font><font color="#000080">));  </font><font color="#008000"><i>{get some memory for the two test images}
  </i></font>getmem<font color="#000080">(</font>q<font color="#000080">,</font>myimagesize<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">343</font><font color="#000080">));

  </font>randomize<font color="#000080">;

  </font>setfillstyle<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">);
  </font>bar<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>getmaxx<font color="#000080">,</font>getmaxy<font color="#000080">);
  </font>garbage<font color="#000080">;                             </font><font color="#008000"><i>{generate some garbage on screen}
  </i></font>mygetimage<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">343</font><font color="#000080">,</font>p<font color="#000080">);           </font><font color="#008000"><i>{and make it to an image ;-) }

  </i></font><font color="#FF0000"><b>repeat until </b></font>keypressed<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>keypressed <font color="#FF0000"><b>do </b></font>readkey<font color="#000080">;
  </font>cleardevice<font color="#000080">;

  </font>setfillstyle<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">13</font><font color="#000080">);                  </font><font color="#008000"><i>{and the same once more with}
  </i></font>bar<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>getmaxx<font color="#000080">,</font>getmaxy<font color="#000080">);            </font><font color="#008000"><i>{another background color}
  </i></font>garbage<font color="#000080">;
  </font>mygetimage<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">343</font><font color="#000080">,</font>q<font color="#000080">);

  </font><font color="#FF0000"><b>repeat until </b></font>keypressed<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>keypressed <font color="#FF0000"><b>do </b></font>readkey<font color="#000080">;
  </font>cleardevice<font color="#000080">;

  </font><font color="#FF0000"><b>repeat
    </b></font>myputimage<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">330</font><font color="#000080">),</font>random<font color="#000080">(</font><font color="#800000">135</font><font color="#000080">),</font>p<font color="#000080">);   </font><font color="#008000"><i>{display both images in a loop}
    </i></font>myputimage<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">330</font><font color="#000080">),</font>random<font color="#000080">(</font><font color="#800000">135</font><font color="#000080">),</font>q<font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>keypressed <font color="#FF0000"><b>do </b></font>readkey<font color="#000080">;

  </font>freemem<font color="#000080">(</font>p<font color="#000080">,</font>myimagesize<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">343</font><font color="#000080">));       </font><font color="#008000"><i>{free the memory occupied by the images}
  </i></font>freemem<font color="#000080">(</font>q<font color="#000080">,</font>myimagesize<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">300</font><font color="#000080">,</font><font color="#800000">343</font><font color="#000080">));

  </font>closegraph<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0236.PAS">Original</a><b>]</b></p></body>
</html>
