<html>
<head><title> "Mode-X one row pixel move" by JONAS MAEBE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0211.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
A couple of months ago, I posted an unfinished procedure to move a row of
pixels one pixel to the left and asked for help. Didn't get any response
(pretty normal, since it's really a lot of work to figure out someone else's
assembler code :), but in the meantime I've been able to finish it. Don't know
whether there's still anybody out there who can use it (the original
requester, Fabian Thylman(n?), seems to have left Fidonet), but here it is
anyway...
}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>MoveRow1PixelLeft<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">, </font>length<font color="#000080">: </font>WORD<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>tempbuf<font color="#000080">);
</font><font color="#008000"><i>{For Mode-X, 320*200*4. Moves length pixels at (x,y) one position to the
left.}{Tempbuf should be an array of byte/char, with size = length div 4.
}{Public domain by Jonas Maebe (2:292/624.7). SWAG, you can include this if
}{you guys feel like it :)
}</i></font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>VAR </b></font>sisav<font color="#000080">, </font>disav<font color="#000080">: </font>word<font color="#000080">;
    </font>planecount<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>ASM
   </b></font><font color="#FF00FF">cld
   push ds
   mov ax, $a000
   mov di, x
   mov ds, ax           </font><font color="#008000"><i>{ds = videosegment}
   </i></font><font color="#FF00FF">mov bx, di           </font><font color="#008000"><i>{bx = di = x}
   </i></font><font color="#FF00FF">mov ax, y
   shr di, 2
   shl ax, 5
   add di, ax
   shl ax, 2
   add di, ax           </font><font color="#008000"><i>{di = y * 160 + x div 4}
   </i></font><font color="#FF00FF">mov si, di           </font><font color="#008000"><i>{source = destination = (x,y)}
   </i></font><font color="#FF00FF">and bl, 11b
   mov bh, bl           </font><font color="#008000"><i>{bh holds value for read plane}
   </i></font><font color="#FF00FF">dec bl               </font><font color="#008000"><i>{write plane points to previous plane}
   </i></font><font color="#FF00FF">cmp bl, $ff          </font><font color="#008000"><i>{bl = -1?}
   </i></font><font color="#FF00FF">jne @bl_ok
   mov bl, 3            </font><font color="#008000"><i>{set bl so it points to plane four (write plane)}
   </i></font><font color="#FF00FF">dec di               </font><font color="#008000"><i>{and di to point to the previous memlocation}
  </i></font><font color="#FF00FF">@bl_ok:
   mov cl, bl
   mov bl, 1
   shl bl, cl           </font><font color="#008000"><i>{bl holds value to set the write plane}
   </i></font><font color="#FF00FF">mov cx, length       </font><font color="#008000"><i>{cx holds the length of the row that has to be}
                        {moved}
   </i></font><font color="#FF00FF">mov sisav, si
   mov disav, di        </font><font color="#008000"><i>{save si and di for later}
   </i></font><font color="#FF00FF">mov planecount, 3    </font><font color="#008000"><i>{and initialize the plane counter}
   </i></font><font color="#FF00FF">mov dx, grac
   mov ah, bl           </font><font color="#008000"><i>{set read plane to value of writeplane, first save}
   </i></font><font color="#FF00FF">dec ah               </font><font color="#008000"><i>{all pixels that'll be overwritten by the first move}
   </i></font><font color="#FF00FF">jns @ok
   xor ah, ah           </font><font color="#008000"><i>{the next few adjustments are still a mystery to me}
  </i></font><font color="#FF00FF">@ok:                  </font><font color="#008000"><i>{and I've have found them out by trial and error.}
   </i></font><font color="#FF00FF">cmp ah, 3            </font><font color="#008000"><i>{If anyone can explain *WHY* the read plane has to}
   </i></font><font color="#FF00FF">jne @ok2             </font><font color="#008000"><i>{set this way, please do tell me...}
   </i></font><font color="#FF00FF">dec ah
  @ok2:
   mov al, 4
   out dx, ax
   mov si, di
   sub cx, 3
   inc si
   les di, tempbuf
   shr cx, 3
   jnc @even
   movsb
  @even:                </font><font color="#008000"><i>{all pixels that are to be overwritten are saved in}
   </i></font><font color="#FF00FF">rep movsw            </font><font color="#008000"><i>{tempbuf}
   </i></font><font color="#FF00FF">mov si, sisav
   mov di, disav
   mov ax, $a000
   mov cx, length
   mov es, ax
  @newplane:
   mov dx, grac
   mov ah, bh
   mov al, 4
   out dx, ax           </font><font color="#008000"><i>{select read plane}
  </i></font><font color="#FF00FF">@writeplane:
   mov dx, sequ
   mov ah, bl
   mov al, 2
   out dx, ax           </font><font color="#008000"><i>{select write plane}
   </i></font><font color="#FF00FF">shr cx, 3            </font><font color="#008000"><i>{shr 2 because there are 4 planes + shr 1 because}
   </i></font><font color="#FF00FF">jnc @counter_even    </font><font color="#008000"><i>{we're doing movsw's, only the last shifted-out}
   </i></font><font color="#FF00FF">movsb                </font><font color="#008000"><i>{bit is kept in the carry flag}
  </i></font><font color="#FF00FF">@counter_even:
   rep movsw            </font><font color="#008000"><i>{move pixels}
   </i></font><font color="#FF00FF">cmp planecount, 0
   je @</font><font color="#FF0000"><b>end
   </b></font>mov cx<font color="#000080">, </font>length       <font color="#008000"><i>{reload the counter}
   </i></font>mov si<font color="#000080">, </font>sisav        <font color="#008000"><i>{restore si}
   </i></font>dec cx               <font color="#008000"><i>{decrease the length by one; because we move on to}
                        {the next pixel, the length of the row becomes one}
                        {less}
   </i></font>mov di<font color="#000080">, </font>disav        <font color="#008000"><i>{restore di}
   </i></font>mov length<font color="#000080">, </font>cx       <font color="#008000"><i>{and save the length}
   </i></font>inc bh               <font color="#008000"><i>{increase the read plane}
   </i></font>cmp bh<font color="#000080">, </font><font color="#800000">4            </font><font color="#008000"><i>{if it's four, wrap around since there are only 4}
                        {planes to read from (and with 4 it would point to 5)}
   </i></font>jne <font color="#000080">@</font>noreset_bh
   mov bh<font color="#000080">, </font><font color="#800000">0            </font><font color="#008000"><i>{reset bh}
   </i></font>inc si               <font color="#008000"><i>{next pixel because we reset bh}
   </i></font>mov sisav<font color="#000080">, </font>si        <font color="#008000"><i>{plane zero}
  </i></font><font color="#000080">@</font>noreset_bh<font color="#000080">:
   </font>cmp bl<font color="#000080">, </font><font color="#800000">1000</font>b        <font color="#008000"><i>{test if it points to the 4th plane}
   </i></font>je <font color="#000080">@</font>reset_bl
   add bl<font color="#000080">, </font>bl           <font color="#008000"><i>{increase write plane (same as shl bl, 1)}
   </i></font>dec planecount
   jnz <font color="#000080">@</font>newplane        <font color="#008000"><i>{planecounter 0 -&gt; finish him! :)}
   </i></font>lds si<font color="#000080">, </font>tempbuf
   jmp <font color="#000080">@</font>writeplane        <font color="#008000"><i>{it doesn't -&gt; don't reset}
  </i></font><font color="#000080">@</font>reset_bl<font color="#000080">:
   </font>mov bl<font color="#000080">, </font><font color="#800000">1            </font><font color="#008000"><i>{select plane 0}
   </i></font>inc di               <font color="#008000"><i>{and point to the next pixel, same reason as with}
   </i></font>mov disav<font color="#000080">, </font>di        <font color="#008000"><i>{read plane}
   </i></font>dec planecount
   jnz <font color="#000080">@</font>newplane        <font color="#008000"><i>{planecounter 0 -&gt; finish him! :)}
   </i></font>lds si<font color="#000080">, </font>tempbuf
   jmp <font color="#000080">@</font>writeplane
  <font color="#000080">@</font><font color="#FF0000"><b>end</b></font><font color="#000080">:
   </font>mov ah<font color="#000080">, </font><font color="#800000">1
   </font>mov cl<font color="#000080">, </font>bh
   <font color="#FF0000"><b>shl </b></font>ah<font color="#000080">, </font>cl
   mov al<font color="#000080">, </font><font color="#800000">2            </font><font color="#008000"><i>{let the write plane point to the last pixel}
   </i></font><font color="#FF0000"><b>out </b></font>dx<font color="#000080">, </font>ax           <font color="#008000"><i>{we've read (write plane = read plane)}
   </i></font>mov si<font color="#000080">, </font>sisav
   mov cx<font color="#000080">, </font>length
   <font color="#FF0000"><b>shr </b></font>cx<font color="#000080">, </font><font color="#800000">2
   </font>jnc <font color="#000080">@</font>even2
   inc si
  <font color="#000080">@</font>even2<font color="#000080">:
   </font>add si<font color="#000080">, </font>cx
   <font color="#FF0000"><b>xor </b></font>bl<font color="#000080">, </font>bl
   mov es<font color="#000080">:[</font>si<font color="#000080">], </font>bl      <font color="#008000"><i>{and zero the last pixel (erase it)}
   </i></font>pop ds               <font color="#008000"><i>{restore data segment}
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0211.PAS">Original</a><b>]</b></p></body>
</html>
