<html>
<head><title> "Fast Pcx-Routines" by CARLOS SANCHEZ GARCIA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0223.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
    This is my unit for fast PCX 320x200 show, as its almost in ASM its really
fast. It has only a handicap: as you must load the entire file in memory
before you show it, the file size could not be greater than 64K:

    Sorry if I left some spanish comment.

=== Cut === }

</i></font><font color="#FF0000"><b>UNIT </b></font>FASTPCX<font color="#000080">;

</font><font color="#008000"><i>{$G+}
{$s-}
{$r-}
{$i-}
{$x+}
{$O+}

(* Requires 286+ *)

</i></font><font color="#FF0000"><b>INTERFACE
</b></font><font color="#008000"><i>(*

PROCEDURE UNPACKPCX(Setpal:Boolean; True if you want the palette to be set
                     VAR FTE,DST;  FTE -&gt; where the file is loaded
                                   DST -&gt; whre to put it, usually Mem[$a000:0]
                      VAR Paleta   You got the palette here,allways  );
   Restricctions:

   - The file must be 320x200 exactly, no bigger, no smaller.
   - It must be a 256 colors PCX.
   - No more than 64K.

 Example:

             .....

  VAR P:Pointer;
      F:FILE;
      Paleta:ARRAY[0..767] OF Byte;
  BEGIN
   Assign(F,'PRUEBA.PCX');
   GetMem(P,65000);
   Reset(F,1);
   BlockRead(F,P^,FileSize(F);
   Close(F);
   ASM          { Cambio modo de video }
    MOV AX,$13
    INT $10
   END;
   UNPACKPCX(TRUE,P^,Mem[$a000:0],Paleta);
   { Desempaqueto PCX en P^ a RAM de video y cambio su paleta }
   REPEAT UNTIL Keypressed;
   FreeMem(P,65535);
                      ....

  *)

</i></font><font color="#FF0000"><b>IMPLEMENTATION


PROCEDURE </b></font>UNPACKPCX<font color="#000080">(</font>PonerPaleta<font color="#000080">:</font>Boolean<font color="#000080">;</font><font color="#FF0000"><b>VAR </b></font>FTE<font color="#000080">,</font>DST<font color="#000080">;</font><font color="#FF0000"><b>VAR </b></font>Paleta<font color="#000080">);  </font><font color="#008000"><i>(*Debe ser
un 320x200x256*) </i></font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;</font><font color="#FF0000"><b>ASM
 </b></font><font color="#FF00FF">PUSH DS        </font><font color="#008000"><i>(* preservo Data Segment *)
 </i></font><font color="#FF00FF">CLD            </font><font color="#008000"><i>(* borro indicador de direcci&cent;n *)
 </i></font><font color="#FF00FF">XOR CX,CX      </font><font color="#008000"><i>(* CX=0, para que en toda la rutina CH est‚ siempre a 0, tal
*)                (* que CX sea siempre igual a CL *)
 </i></font><font color="#FF00FF">LDS SI,[FTE]   </font><font color="#008000"><i>(* DS:SI --&gt; FTE *)
 </i></font><font color="#FF00FF">ADD SI,128     </font><font color="#008000"><i>(* Salto cabecera *)
 </i></font><font color="#FF00FF">LES DI,[DST]   </font><font color="#008000"><i>(* ES:DI -- DST *)
 </i></font><font color="#FF00FF">MOV DX,64000   </font><font color="#008000"><i>(* Tengo que leer 64000 bytes *)
</i></font><font color="#FF00FF">@BUCLE:
 MOV CL,DS:[SI] </font><font color="#008000"><i>(* Tomo valor *)
 </i></font><font color="#FF00FF">AND CL,0C0h
 CMP CL,0C0h    </font><font color="#008000"><i>(* &gt;=192 *)
 </i></font><font color="#FF00FF">JZ @COMPRESSED </font><font color="#008000"><i>(* si es as&iexcl; valor comprimido *)
 </i></font><font color="#FF00FF">MOVSB          </font><font color="#008000"><i>(* en caso contrario copio fuente en destino *)
 </i></font><font color="#FF00FF">DEC DX         </font><font color="#008000"><i>(* decremento DX pues falta uno menos *)
 </i></font><font color="#FF00FF">JMP @NEXT      </font><font color="#008000"><i>(* salto a siguiente *)
</i></font><font color="#FF00FF">@COMPRESSED:
 MOV CL,DS:[SI] </font><font color="#008000"><i>(* Recupero valor (el AND lo machac&cent;)  *)
 </i></font><font color="#FF00FF">AND CL,03Fh    </font><font color="#008000"><i>(* resto 192 *)
 </i></font><font color="#FF00FF">SUB DX,CX      </font><font color="#008000"><i>(* quito tantos puntos como contiene CL *)
 </i></font><font color="#FF00FF">INC SI         </font><font color="#008000"><i>(* paso a siguiente valor *)
 </i></font><font color="#FF00FF">LODSB          </font><font color="#008000"><i>(* lo cargo *)
 </i></font><font color="#FF00FF">REP STOSB      </font><font color="#008000"><i>(* y lo vuelco CX veces *)
</i></font><font color="#FF00FF">@NEXT:
 OR DX,DX       </font><font color="#008000"><i>(* comparo DX con cero *)
 </i></font><font color="#FF00FF">JNZ @BUCLE     </font><font color="#008000"><i>(* y si no lo es paso a bucle *)


</i></font><font color="#FF00FF">@PALET:
 INC SI         </font><font color="#008000"><i>(* SALTO valor 12, que precede a paleta *)


 </i></font><font color="#FF00FF">MOV CX,768        </font><font color="#008000"><i>(* 768= 256*3 *)
 </i></font><font color="#FF00FF">LES DI,[Paleta]   </font><font color="#008000"><i>(* ES:DI --&gt; Paleta *)
 </i></font><font color="#FF00FF">REP MOVSB         </font><font color="#008000"><i>(* copio paleta en &quot;Paleta&quot; *)

 </i></font><font color="#FF00FF">MOV CX,768
 LDS SI,[Paleta]
@LOOP:
 MOV AL,DS:[SI]
 SHR AL,2
 MOV DS:[SI],AL
 INC SI
 LOOP @LOOP;          </font><font color="#008000"><i>(* La divido por 4 , en el fichero PCX los valores de
                         paleta est n multiplicados por 4 *)


 </i></font><font color="#FF00FF">MOV AL,PonerPaleta  </font><font color="#008000"><i>(* Compruebo si he de mostrarla *)
 </i></font><font color="#FF00FF">OR AL,AL            </font><font color="#008000"><i>(* 0=FALSE, otro valor =TRUE    *)
 </i></font><font color="#FF00FF">JZ @FIN             </font><font color="#008000"><i>(* En caso contario salto a FIN *)

 </i></font><font color="#FF00FF">MOV   DX,3DAh   </font><font color="#008000"><i>(* Espero retrazado *)
</i></font><font color="#FF00FF">@Espera1:
 IN    AL,DX
 AND   AL,08h
 JNZ   @Espera1
@Espera2:
 IN    AL,DX
 AND   AL,08h
 JZ    @Espera2

 MOV DX,3C8h    </font><font color="#008000"><i>(* Y la muestro *)
 </i></font><font color="#FF00FF">XOR AL,AL
 OUT DX,AL
 INC DX
 MOV CX,768
 SUB SI,CX
 REP OUTSB

 </font><font color="#008000"><i>(* Si se quiere evitar la niebla en modelos lentos como
    286 o 386sx 16Mhz conviene que la paleta en lugar de
    ponerse de golpe se ponga por partes, esperando un
    retrazado cada parte *)

</i></font><font color="#FF00FF">@FIN:
 POP DS  </font><font color="#008000"><i>(* recupero DS *)
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0223.PAS">Original</a><b>]</b></p></body>
</html>
