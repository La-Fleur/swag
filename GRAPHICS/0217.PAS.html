<html>
<head><title> "Nice Graphics Unit" by SUNE MARCHER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0217.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>gru<font color="#000080">; </font><font color="#008000"><i>{ GRaphic Unit. }
{$g+}

</i></font><font color="#FF0000"><b>INTERFACE

type
  </b></font>palrec<font color="#000080">=</font><font color="#FF0000"><b>record
           </b></font>r<font color="#000080">,</font>g<font color="#000080">,</font>b<font color="#000080">:</font>byte<font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>paltype<font color="#000080">=</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>palrec<font color="#000080">;
  </font>palptr<font color="#000080">=^</font>paltype<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>vidseg<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">$a000</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>plot<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>plot2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>setmode<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>mode<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>flip386<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>a<font color="#000080">,</font>b<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>clear386<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>flip286<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>a<font color="#000080">,</font>b<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>clear286<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>flip<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>a<font color="#000080">,</font>b<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>clear<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>vret<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>hline<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>x2<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>hline2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>x2<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>vline<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y1<font color="#000080">,</font>y2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>vline2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y1<font color="#000080">,</font>y2<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>line<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>line2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>function  </b></font>getpix<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>function  </b></font>getpix2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>function  </b></font>rad<font color="#000080">(</font>theta<font color="#000080">:</font>real<font color="#000080">):</font>real<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>setpal<font color="#000080">(</font>c<font color="#000080">,</font>r<font color="#000080">,</font>g<font color="#000080">,</font>b<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>getvgapal<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>pal<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>setvgapal<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>pal<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>smooth<font color="#000080">(</font>where<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>smooth1<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>smooth2<font color="#000080">(</font>where<font color="#000080">,</font>size<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>drawsprite<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>w<font color="#000080">,</font>h<font color="#000080">,</font>c<font color="#000080">:</font>byte<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>sprite<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>fadefrompaltopal<font color="#000080">(</font>oldpal<font color="#000080">,</font>newpal<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>ffblack<font color="#000080">(</font>palin<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>f2black<font color="#000080">(</font>palin<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>scanlines<font color="#000080">(</font>numl<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>combine<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>in1<font color="#000080">,</font>in2<font color="#000080">,</font><font color="#FF0000"><b>out</b></font><font color="#000080">,</font>eline<font color="#000080">:</font>word<font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>clipon<font color="#000080">:</font>boolean<font color="#000080">;
  </font>cx1<font color="#000080">,</font>cx2<font color="#000080">,</font>cy1<font color="#000080">,</font>cy2<font color="#000080">:</font>word<font color="#000080">;

</font><font color="#FF0000"><b>IMPLEMENTATION

var
  </b></font>scrofs<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">199</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">; </font><font color="#008000"><i>{ Holding screen offsets. }
  </i></font>blackp<font color="#000080">:</font>paltype<font color="#000080">;
  </font>whitep<font color="#000080">:</font>paltype<font color="#000080">;
  </font>tempal<font color="#000080">:</font>paltype<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>plot<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">cmp clipon,0
  je @@sc
  mov ax,[x]
  cmp ax,cx1
  jb @@exit
  cmp ax,cx2
  ja @@exit
  mov ax,[y]
  cmp ax,cy1
  jb @@exit
  cmp ax,cy2
  ja @@exit
  @@sc: </font><font color="#008000"><i>{ SkipCheck :-) }
  </i></font><font color="#FF00FF">mov es,sega000
  mov bx,[y]
  shl bx,1
  mov di,word ptr[scrofs+bx]
  add di,[x]
  mov al,[c]
  mov es:[di],al
@@exit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>plot2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">cmp clipon,0
  je @@sc
  mov ax,[x]
  cmp ax,cx1
  jb @@exit
  cmp ax,cx2
  ja @@exit
  mov ax,[y]
  cmp ax,cy1
  jb @@exit
  cmp ax,cy2
  ja @@exit
  @@sc: </font><font color="#008000"><i>{ SkipCheck :-) }
  </i></font><font color="#FF00FF">mov ax,where
  mov es,ax
  mov bx,[y]
  shl bx,1
  mov di,word ptr[scrofs+bx]
  add di,[x]
  mov al,[c]
  mov es:[di],al
@@exit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setmode<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>mode<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,mode
  int 10h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>flip386<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>a<font color="#000080">,</font>b<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  mov ds,a
  mov es,b
  xor si,si
  xor di,di
  mov cx,16000
  db 66h; rep movsw
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>clear386<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov es,where
  xor ax,ax
  xor di,di
  mov al,[c]
  mov ah,al
  db 66h; shr ax,16
  mov al,[c]
  mov ah,al
  mov cx,16000
  db 66h; rep stosw
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>flip286<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>a<font color="#000080">,</font>b<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  mov ds,a
  mov es,b
  xor si,si
  xor di,di
  mov cx,32000
  rep movsw
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>clear286<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov es,where
  xor ax,ax
  xor di,di
  mov al,[c]
  mov ah,al
  mov cx,32000
  rep stosw
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>flip<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>a<font color="#000080">,</font>b<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  mov ds,a
  mov es,b
  xor si,si
  xor di,di
  mov cx,64000
  rep movsb
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>clear<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov es,where
  xor ax,ax
  xor di,di
  mov al,[c]
  mov cx,64000
  rep stosb
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>vret<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov dx,3dah;
@vert1: in al,dx
        test al,8
        jz @vert1
@vert2: in al,dx
        test al,8
        jnz @vert2
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>hline<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>x2<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">cld
  mov es,sega000
  mov ax,[x1]
  mov cx,[x2]
  sub cx,ax
  mov di,[y]
  mov bx,di
  shl di,8
  shl bx,6
  add di,bx
  add di,ax
  mov al,[c]
  mov ah,al
  shr cx,1
  rep stosw
  adc cx,cx
  rep stosb
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>hline2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>x2<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">cld
  mov ax,where
  mov es,ax
  mov ax,[x1]
  mov cx,[x2]
  sub cx,ax
  mov di,[y]
  mov bx,di
  shl di,8
  shl bx,6
  add di,bx
  add di,ax
  mov al,[c]
  mov ah,al
  shr cx,1
  rep stosw
  adc cx,cx
  rep stosb
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>vline<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y1<font color="#000080">,</font>y2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov es,sega000
  mov ax,[y1]
  mov bx,ax
  shl ax,8
  shl bx,6
  add ax,bx
  mov di,ax
  mov ax,[y2]
  mov bx,ax
  shl ax,8
  shl bx,6
  add bx,ax
  mov al,[c]
  mov cx,[x]
  add di,cx
  add bx,cx

  @@loop1:
    mov es:[di],al
    add di,320
    cmp di,bx
    jne @@loop1
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>vline2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y1<font color="#000080">,</font>y2<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,where
  mov es,ax
  mov ax,[y1]
  mov bx,ax
  shl ax,8
  shl bx,6
  add ax,bx
  mov di,ax
  mov ax,[y2]
  mov bx,ax
  shl ax,8
  shl bx,6
  add bx,ax
  mov al,[c]
  mov cx,[x]
  add di,cx
  add bx,cx

  @@loop1:
    mov es:[di],al
    add di,320
    cmp di,bx
    jne @@loop1
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>line<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>dex<font color="#000080">,</font>dey<font color="#000080">,</font>incf<font color="#000080">:</font>Integer<font color="#000080">;
  </font>offset<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,[x2]
  sub ax,[x1]
  jnc @@dont1
  neg ax
@@dont1:
  mov [dex],ax
  mov ax,[y2]
  sub ax,[y1]
  jnc @@dont2
  neg ax
@@dont2:
  mov [dey],ax
  cmp ax,[dex]
  jbe @@otherline
  mov  ax,[y1]
  cmp  ax,[y2]
  jbe  @@dontswap1
  mov  bx,[y2]
  mov  [y1],bx
  mov  [y2],ax
  mov  ax,[x1]
  mov  bx,[x2]
  mov  [x1],bx
  mov  [x2],ax
@@dontswap1:
  mov [incf],1
  mov ax,[x1]
  cmp ax,[x2]
  jbe @@skipnegate1
  neg [incf]
@@skipnegate1:
  mov di,[y1]
  mov bx,di
  shl di,8
  shl bx,6
  add di,bx
  add di,[x1]
  mov bx,[dey]
  mov cx,bx
  mov ax,$a000
  mov es,ax
  mov dl,[c]
  mov si,[dex]
@@drawloop1:
  mov es:[di],dl
  add di,320
  sub bx,si
  jnc @@goon1
  add bx,[dey]
  add di,[incf]
@@goon1:
  loop @@drawloop1
  jmp  @@exitline
@@otherline:
  mov ax,[x1]
  cmp ax,[x2]
  jbe @@dontswap2
  mov bx,[x2]
  mov [x1],bx
  mov [x2],ax
  mov ax,[y1]
  mov bx,[y2]
  mov [y1],bx
  mov [y2],ax
@@dontswap2:
  mov [incf],320
  mov ax,[y1]
  cmp ax,[y2]
  jbe @@skipnegate2
  neg [incf]
@@skipnegate2:
  mov di,[y1]
  mov bx,di
  shl di,8
  shl bx,6
  add di,bx
  add di,[x1]
  mov bx,[dex]
  mov cx,bx
  mov ax,$a000
  mov es,ax
  mov dl,[c]
  mov si,[dey]
@@drawloop2:
  mov es:[di],dl
  inc di
  sub bx,si
  jnc @@goon2
  add bx,[dex]
  add di,[incf]
@@goon2:
  loop @@drawloop2
@@exitline:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>line2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>c<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>dex<font color="#000080">,</font>dey<font color="#000080">,</font>incf<font color="#000080">:</font>Integer<font color="#000080">;
  </font>offset<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,[x2]
  sub ax,[x1]
  jnc @@dont1
  neg ax
@@dont1:
  mov [dex],ax
  mov ax,[y2]
  sub ax,[y1]
  jnc @@dont2
  neg ax
@@dont2:
  mov [dey],ax
  cmp ax,[dex]
  jbe @@otherline
  mov  ax,[y1]
  cmp  ax,[y2]
  jbe  @@DontSwap1
  mov  bx,[y2]
  mov  [y1],bx
  mov  [y2],ax
  mov  ax,[x1]
  mov  bx,[x2]
  mov  [x1],bx
  mov  [x2],ax
@@dontswap1:
  mov [incf],1
  mov ax,[x1]
  cmp ax,[x2]
  jbe @@skipnegate1
  neg [incf]
@@skipnegate1:
  mov di,[y1]
  mov bx,di
  shl di,8
  shl bx,6
  add di,bx
  add di,[x1]
  mov bx,[dey]
  mov cx,bx
  mov ax,where
  mov es,ax
  mov dl,[c]
  mov si,[dex]
@@drawloop1:
  mov es:[di],dl
  add di,320
  sub bx,si
  jnc @@goon1
  add bx,[dey]
  add di,[incf]
@@goon1:
  loop @@drawloop1
  jmp  @@exitline
@@otherline:
  mov ax,[x1]
  cmp ax,[x2]
  jbe @@dontswap2
  mov bx,[x2]
  mov [x1],bx
  mov [x2],ax
  mov ax,[y1]
  mov bx,[y2]
  mov [y1],bx
  mov [y2],ax
@@dontswap2:
  mov [incf],320
  mov ax,[y1]
  cmp ax,[y2]
  jbe @@skipnegate2
  neg [incf]
@@skipnegate2:
  mov di,[y1]
  mov bx,di
  shl di,8
  shl bx,6
  add di,bx
  add di,[x1]
  mov bx,[dex]
  mov cx,bx
  mov ax,where
  mov es,ax
  mov dl,[c]
  mov si,[dey]
@@drawloop2:
  mov es:[di],dl
  inc di
  sub bx,si
  jnc @@goon2
  add bx,[dex]
  add di,[incf]
@@goon2:
  loop @@drawloop2
@@exitline:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>getpix<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">cmp clipon,0
  je @@sc
  mov ax,[x]
  cmp ax,cx1
  jb @@exit
  cmp ax,cx2
  ja @@exit
  mov ax,[y]
  cmp ax,cy1
  jb @@exit
  cmp ax,cy2
  ja @@exit
  @@sc: </font><font color="#008000"><i>{ SkipCheck :-) }
  </i></font><font color="#FF00FF">mov es,sega000
  mov bx,[y]
  shl bx,1
  mov di,word ptr[scrofs+bx]
  add di,[x]
  mov al,es:[di]
@@exit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>getpix2<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">):</font>byte<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">cmp clipon,0
  je @@sc
  mov ax,[x]
  cmp ax,cx1
  jb @@exit
  cmp ax,cx2
  ja @@exit
  mov ax,[y]
  cmp ax,cy1
  jb @@exit
  cmp ax,cy2
  ja @@exit
  @@sc: </font><font color="#008000"><i>{ SkipCheck :-) }
  </i></font><font color="#FF00FF">mov ax,where
  mov es,ax
  mov bx,[y]
  shl bx,1
  mov di,word ptr[scrofs+bx]
  add di,[x]
  mov al,es:[di]
@@exit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>rad<font color="#000080">(</font>theta<font color="#000080">:</font>real<font color="#000080">):</font>real<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>rad<font color="#000080">:=</font>theta<font color="#000080">*</font>pi<font color="#000080">/</font><font color="#800000">180</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setpal<font color="#000080">(</font>c<font color="#000080">,</font>r<font color="#000080">,</font>g<font color="#000080">,</font>b<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx,3c8h
  mov al,[c]
  out dx,al
  inc dx
  mov al,[r]
  out dx,al
  mov al,[g]
  out dx,al
  mov al,[b]
  out dx,al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>getvgapal<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>pal<font color="#000080">:</font>paltype<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  xor ax,ax
  mov cx,0300h
  les di,pal
  mov dx,03c7h
  out dx,al
  inc dx
  inc dx
  cld
  rep insb
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setvgapal<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>pal<font color="#000080">:</font>paltype<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  xor ax,ax
  mov cx,0300h/2
  lds si,pal
  mov dx,03c8h
  out dx,al
  inc dx
  mov bx,dx
  cld
  mov dx,03dah
  @vsync0:
    in al,dx
    test al,8
  jz @vsync0
  mov dx,bx
  rep outsb
  mov bx,dx
  mov dx,03dah
  @vsync1:
    in al,dx
    test al,8
  jz @vsync1
  mov dx,bx
  mov cx,0300h/2
  rep outsb
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>smooth<font color="#000080">(</font>where<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,where
  mov es,ax
  xor di,di
  mov cx,64000-320
  xor bh,bh
  @@loop:
    xor ax,ax
    mov al,es:[di]
    mov bl,es:[di+320] ;add ax,bx
    mov bl,es:[di+1]   ;add ax,bx
    mov bl,es:[di+321] ;add ax,bx
    shr ax,2
    mov es:[di],al
    inc di
    loop @@loop
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>smooth1<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,where
  mov es,ax
  mov di,[y]
  mov bx,di
  shl di,8
  shl bx,6
  add di,bx
  add di,[x]
  xor bh,bh
  xor ax,ax
  mov al,es:[di]
  mov bl,es:[di+320] ;add ax,bx
  mov bl,es:[di+1]   ;add ax,bx
  mov bl,es:[di+321] ;add ax,bx
  shr ax,2
  mov es:[di],al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>smooth2<font color="#000080">(</font>where<font color="#000080">,</font>size<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,where
  mov es,ax
  xor di,di
  mov cx,size
  xor bh,bh
  @@loop:
    xor ax,ax
    mov al,es:[di]
    mov bl,es:[di+320] ;add ax,bx
    mov bl,es:[di+1]   ;add ax,bx
    mov bl,es:[di+321] ;add ax,bx
    shr ax,2
    mov es:[di],al
    inc di
    loop @@loop
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>drawsprite<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>x<font color="#000080">,</font>y<font color="#000080">,</font>where<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>const </b></font>w<font color="#000080">,</font>h<font color="#000080">,</font>c<font color="#000080">:</font>byte<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>sprite<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  lds si,[sprite]
  mov ax,where
  mov es,ax
  cld
  mov ax,[y]
  shl ax,6
  mov di,ax
  shl ax,2
  add di,ax
  add di,[x]
  mov bh,[h]
  mov cx,320
  sub cl,[w]
  sbb ch,0
 @l:
  mov bl,[w]
 @l2:
  lodsb
  cmp al,[c]
  je @s
  mov dl,[es:di]
  add dl,al
  mov es:[di],dl
 @s:
  inc di
  dec bl
  jnz @l2
  add di,cx
  dec bh
  jnz @l
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>fadefrompaltopal<font color="#000080">(</font>oldpal<font color="#000080">,</font>newpal<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>dac<font color="#000080">,</font>c<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>c<font color="#000080">:=</font><font color="#800000">32 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    for </b></font>dac<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
    begin
      </b></font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>r<font color="#000080">:=((</font>oldpal<font color="#000080">[</font>dac<font color="#000080">].</font>r<font color="#000080">*</font>c<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">)+((</font>newpal<font color="#000080">[</font>dac<font color="#000080">].</font>r<font color="#000080">*(</font><font color="#800000">32</font><font color="#000080">-</font>c<font color="#000080">))</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">);
      </font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>g<font color="#000080">:=((</font>oldpal<font color="#000080">[</font>dac<font color="#000080">].</font>g<font color="#000080">*</font>c<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">)+((</font>newpal<font color="#000080">[</font>dac<font color="#000080">].</font>g<font color="#000080">*(</font><font color="#800000">32</font><font color="#000080">-</font>c<font color="#000080">))</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">);
      </font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>b<font color="#000080">:=((</font>oldpal<font color="#000080">[</font>dac<font color="#000080">].</font>b<font color="#000080">*</font>c<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">)+((</font>newpal<font color="#000080">[</font>dac<font color="#000080">].</font>b<font color="#000080">*(</font><font color="#800000">32</font><font color="#000080">-</font>c<font color="#000080">))</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>setvgapal<font color="#000080">(</font>tempal<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>ffblack<font color="#000080">(</font>palin<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>dac<font color="#000080">,</font>i<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">32 </font><font color="#FF0000"><b>do
  begin
    for </b></font>dac<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
    begin
      </b></font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>r<font color="#000080">:=(</font>palin<font color="#000080">[</font>dac<font color="#000080">].</font>r<font color="#000080">*</font>i<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">;
      </font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>g<font color="#000080">:=(</font>palin<font color="#000080">[</font>dac<font color="#000080">].</font>g<font color="#000080">*</font>i<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">;
      </font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>b<font color="#000080">:=(</font>palin<font color="#000080">[</font>dac<font color="#000080">].</font>b<font color="#000080">*</font>i<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>setvgapal<font color="#000080">(</font>tempal<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>f2black<font color="#000080">(</font>palin<font color="#000080">:</font>paltype<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>dac<font color="#000080">,</font>i<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>i<font color="#000080">:=</font><font color="#800000">32 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    for </b></font>dac<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
    begin
      </b></font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>r<font color="#000080">:=(</font>palin<font color="#000080">[</font>dac<font color="#000080">].</font>r<font color="#000080">*</font>i<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">;
      </font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>g<font color="#000080">:=(</font>palin<font color="#000080">[</font>dac<font color="#000080">].</font>g<font color="#000080">*</font>i<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">;
      </font>tempal<font color="#000080">[</font>dac<font color="#000080">].</font>b<font color="#000080">:=(</font>palin<font color="#000080">[</font>dac<font color="#000080">].</font>b<font color="#000080">*</font>i<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">32</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>setvgapal<font color="#000080">(</font>tempal<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>scanlines<font color="#000080">(</font>numl<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx, 3d4h
  mov al, 9
  out dx, al
  inc dx
  in al, dx
  and al, 0E0h
  add ax, numl
  out dx, al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>combine<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>in1<font color="#000080">,</font>in2<font color="#000080">,</font><font color="#FF0000"><b>out</b></font><font color="#000080">,</font>eline<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  mov ax,out; mov es,ax; xor di,di
  cld
  mov cx,[eline]
  mov bx,cx
  shl cx,8
  shl bx,6
  add cx,bx
  mov bx,cx
  shr cx,2
  mov ax,in1; mov ds,ax; xor si,si
  db 66h; rep movsw; adc cx,cx; rep movsw
  mov ax,in2; mov ds,ax; mov si,bx
  mov cx,64000
  sub cx,bx
  shr cx,2
  db 66h; rep movsw; adc cx,cx; rep movsw
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>count<font color="#000080">:</font>word<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>clipon<font color="#000080">:=</font>false<font color="#000080">;
  </font>cx1<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>cx2<font color="#000080">:=</font><font color="#800000">319</font><font color="#000080">; </font>cy1<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>cy2<font color="#000080">:=</font><font color="#800000">199</font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>count<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">199 </font><font color="#FF0000"><b>do </b></font>scrofs<font color="#000080">[</font>count<font color="#000080">]:=</font>count<font color="#000080">*</font><font color="#800000">320</font><font color="#000080">; </font><font color="#008000"><i>{ Set up the offsets. }
  </i></font><font color="#FF0000"><b>for </b></font>count<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
  begin
    </b></font>blackp<font color="#000080">[</font>count<font color="#000080">].</font>r<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>blackp<font color="#000080">[</font>count<font color="#000080">].</font>g<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>blackp<font color="#000080">[</font>count<font color="#000080">].</font>b<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>whitep<font color="#000080">[</font>count<font color="#000080">].</font>r<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">;
    </font>whitep<font color="#000080">[</font>count<font color="#000080">].</font>g<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">;
    </font>whitep<font color="#000080">[</font>count<font color="#000080">].</font>b<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0217.PAS">Original</a><b>]</b></p></body>
</html>
