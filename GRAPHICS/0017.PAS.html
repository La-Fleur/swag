<html>
<head><title> "Simple coppering routine" by SEAN PALMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0017.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
SEAN PALMER

&gt;Okay, I've got this small problem porting one of my assembler routines
&gt;into pascal.  It's a simple coppering routine (multiple setting of the
&gt;same palette register for trippy effects :), and i can't seem to use it
&gt;in my code..  I'll post the code here now (it's fairly short), and if
&gt;someone could help me out here, i'd be most grateful - since my
&gt;assembler/pascal stuff isn't too great..

I imported it, but couldn't get it to work (several problems in the
source) and in the process of getting it to work (for one thing I didn't
know what it was supposed to accomplish in the first place) I added a
few things to it and this probably isn't what you wanted it to look like
but it wouldn't be hard to do now that it's in TP-acceptable form.

I also added one other small palette flipper that's kind of neat.
}

{$G+}
</i></font><font color="#FF0000"><b>uses
  </b></font>crt<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>copperBars<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>colors<font color="#000080">; </font>lines <font color="#000080">: </font>word<font color="#000080">; </font>regNum<font color="#000080">, </font>count <font color="#000080">: </font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>c2 <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#008000"><i>{
  okay, Colors is a pointer to the variable array of
  colours to use (6bit rgb values to pump to the dac)
  Lines is the number of scanlines on the screen (for syncing)
  RegNum is the colour register (DAC) to use.
  valid values are 0-255. that should explain that one.
  Count is the number of cycles updates to do before it exits.
}
  </i></font><font color="#FF00FF">push ds

  mov  ah, [RegNum]
  mov  dx, $3DA   </font><font color="#008000"><i>{vga status port}
  </i></font><font color="#FF00FF">mov  bl, $C8    </font><font color="#008000"><i>{reg for DAC}
  </i></font><font color="#FF00FF">cli
  cld

 @V1:
  in   al, dx
  test al, 8
  jz   @V1 </font><font color="#008000"><i>{vertical retrace}
 </i></font><font color="#FF00FF">@V2:
  in   al, dx
  test al, 8
  jnz  @V2

  mov  c2, 1
  mov  di, [lines]

 @UPDATER:
  mov  bh, c2
  inc  c2
  lds  si, [colors]
                </font><font color="#008000"><i>{now,just do it.}
 </i></font><font color="#FF00FF">@NIKE:
  mov  cx, 3
  mov  dl, $DA

 @H1:
  in   al, dx
  and  al, 1
  jz   @H1  </font><font color="#008000"><i>{horizontal retrace}

  </i></font><font color="#FF00FF">mov  al, ah  </font><font color="#008000"><i>{color}
  </i></font><font color="#FF00FF">mov  dl, bl
  out  dx, al
  inc  dx
  rep  outsb              </font><font color="#008000"><i>{186 instruction...}

  </i></font><font color="#FF00FF">mov  dl, $DA
 @H2:
  in   al, dx
  and  al, 1
  jnz  @H2;

  dec  di
  jz   @X
  dec  bh
  jnz  @NIKE
  jmp  @UPDATER
 @X:
  dec  count
  jnz  @V1
  sti                    </font><font color="#008000"><i>{enable interrupts}
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>freakout0<font color="#000080">(</font>lines <font color="#000080">: </font>word<font color="#000080">; </font>count <font color="#000080">: </font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx, $3DA   </font><font color="#008000"><i>{vga status port}
  </i></font><font color="#FF00FF">cli
  cld

 @V1:
  </font><font color="#008000"><i>(* in   al, dx
     test al, 8
     jz   @V1 {vertical retrace}
  @V2:
     in   al, dx
     test al, 8
     jnz  @V2
  *)

  </i></font><font color="#FF00FF">mov di,[lines]

 @L:
  mov  dl, $C8
  mov  al, 0  </font><font color="#008000"><i>{color}
  </i></font><font color="#FF00FF">out  dx, al
  inc  dx
  mov  al, bh
  out  dx, al
  add  al, 20
  out  dx, al
  out  dx, al
  add  bh, 17
  mov  dl, $DA
  in   al, dx
  test al, 1
  jz   @L;  </font><font color="#008000"><i>{until horizontal retrace}

  </i></font><font color="#FF00FF">dec  di
  jnz  @L

  mov  dl, $DA
  dec  count
  jnz  @V1
  sti                    </font><font color="#008000"><i>{enable interrupts}
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
 </b></font>pal <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3 </font><font color="#000080">* </font><font color="#800000">28 </font><font color="#000080">- </font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte <font color="#000080">=
   (</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">,
    </font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">,
    </font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">12</font><font color="#000080">,</font><font color="#800000">12</font><font color="#000080">,
    </font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">16</font><font color="#000080">,</font><font color="#800000">16</font><font color="#000080">,
    </font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">20</font><font color="#000080">,</font><font color="#800000">20</font><font color="#000080">,
    </font><font color="#800000">12</font><font color="#000080">,</font><font color="#800000">24</font><font color="#000080">,</font><font color="#800000">24</font><font color="#000080">,
    </font><font color="#800000">14</font><font color="#000080">,</font><font color="#800000">28</font><font color="#000080">,</font><font color="#800000">28</font><font color="#000080">,
    </font><font color="#800000">16</font><font color="#000080">,</font><font color="#800000">32</font><font color="#000080">,</font><font color="#800000">32</font><font color="#000080">,
    </font><font color="#800000">18</font><font color="#000080">,</font><font color="#800000">36</font><font color="#000080">,</font><font color="#800000">36</font><font color="#000080">,
    </font><font color="#800000">20</font><font color="#000080">,</font><font color="#800000">40</font><font color="#000080">,</font><font color="#800000">40</font><font color="#000080">,
    </font><font color="#800000">22</font><font color="#000080">,</font><font color="#800000">44</font><font color="#000080">,</font><font color="#800000">44</font><font color="#000080">,
    </font><font color="#800000">24</font><font color="#000080">,</font><font color="#800000">48</font><font color="#000080">,</font><font color="#800000">48</font><font color="#000080">,
    </font><font color="#800000">26</font><font color="#000080">,</font><font color="#800000">52</font><font color="#000080">,</font><font color="#800000">52</font><font color="#000080">,
    </font><font color="#800000">26</font><font color="#000080">,</font><font color="#800000">52</font><font color="#000080">,</font><font color="#800000">52</font><font color="#000080">,
    </font><font color="#800000">28</font><font color="#000080">,</font><font color="#800000">56</font><font color="#000080">,</font><font color="#800000">56</font><font color="#000080">,
    </font><font color="#800000">28</font><font color="#000080">,</font><font color="#800000">56</font><font color="#000080">,</font><font color="#800000">56</font><font color="#000080">,
    </font><font color="#800000">30</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,
    </font><font color="#800000">30</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,
    </font><font color="#800000">30</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,
    </font><font color="#800000">33</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,
    </font><font color="#800000">33</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,
    </font><font color="#800000">33</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,
    </font><font color="#800000">33</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,
    </font><font color="#800000">33</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">,
    </font><font color="#800000">30</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,
    </font><font color="#800000">28</font><font color="#000080">,</font><font color="#800000">56</font><font color="#000080">,</font><font color="#800000">56</font><font color="#000080">,
    </font><font color="#800000">26</font><font color="#000080">,</font><font color="#800000">52</font><font color="#000080">,</font><font color="#800000">52</font><font color="#000080">,
    </font><font color="#800000">24</font><font color="#000080">,</font><font color="#800000">48</font><font color="#000080">,</font><font color="#800000">48</font><font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">mov ax, $13
    int $10
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">50 </font><font color="#FF0000"><b>to </b></font><font color="#800000">149 </font><font color="#FF0000"><b>do
    </b></font>fillchar<font color="#000080">(</font>mem<font color="#000080">[</font><font color="#800000">$A000 </font><font color="#000080">: </font>i <font color="#000080">* </font><font color="#800000">320 </font><font color="#000080">+ </font><font color="#800000">50</font><font color="#000080">], </font><font color="#800000">220</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);

  </font><font color="#FF0000"><b>repeat
    </b></font>copperBars<font color="#000080">(</font>pal<font color="#000080">, </font><font color="#800000">398</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">8</font><font color="#000080">);  </font><font color="#008000"><i>{398 because of scan doubling}
  </i></font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
  </font>readkey<font color="#000080">;

  </font><font color="#FF0000"><b>repeat
    </b></font>freakout0<font color="#000080">(</font><font color="#800000">398</font><font color="#000080">, </font><font color="#800000">8</font><font color="#000080">);  </font><font color="#008000"><i>{398 because of scan doubling}
  </i></font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
  </font>readkey<font color="#000080">;

  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax, 3
    int $10
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0017.PAS">Original</a><b>]</b></p></body>
</html>
