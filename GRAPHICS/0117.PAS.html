<html>
<head><title> "Pcx Bitmap Rotating" by ANDREW EIGUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0117.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ ROTATE.PAS }

{
  Rotating textured surface.
  Coded by Mike Shirobokov(MSH) aka Mad Max / Queue members.
  You can do anything with this code until this comments
  remain unchanged.

  Bugs corrected by Alex Grischenko
}

{$G+,A-,V-,X+}
{$M 16384,0,16384}

</i></font><font color="#FF0000"><b>uses </b></font>Crt<font color="#000080">, </font>Objects<font color="#000080">, </font>Memory<font color="#000080">, </font>VgaGraph<font color="#000080">;  </font><font color="#008000"><i>{ unit code at the end of program }

</i></font><font color="#FF0000"><b>const
</b></font><font color="#008000"><i>{ Try to play with this constants }
  </i></font>RotateSteps  <font color="#000080">= </font><font color="#008000"><i>{64*5}</i></font><font color="#800000">65</font><font color="#000080">*</font><font color="#800000">10</font><font color="#000080">;
  </font>AngleStep    <font color="#000080">= </font><font color="#008000"><i>{3}</i></font><font color="#800000">1</font><font color="#000080">;
  </font>MoveStep     <font color="#000080">= </font><font color="#008000"><i>{10}</i></font><font color="#800000">1</font><font color="#000080">;
  </font>ScaleStep    <font color="#000080">: </font>Real <font color="#000080">=  </font><font color="#800000">0.02</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TBPoint <font color="#000080">= </font><font color="#FF0000"><b>record </b></font>X<font color="#000080">,</font>Y<font color="#000080">: </font><font color="#008000"><i>{ Byte} </i></font>Integer<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>TPointArray <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[ </font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">500 </font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>TBPoint<font color="#000080">;

  </font>TRotateApp <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TGraphApplication<font color="#000080">)
    </font>StartTime<font color="#000080">,
    </font>FramesNumber<font color="#000080">:</font>LongInt<font color="#000080">;
    </font><font color="#008000"><i>{Texture: TImage;}
    </i></font>X<font color="#000080">,</font>Y    <font color="#000080">: </font>Integer<font color="#000080">;
    </font>WSX<font color="#000080">,</font>WSY<font color="#000080">: </font>Integer<font color="#000080">;
    </font>WSXR<font color="#000080">,
    </font>WSYR   <font color="#000080">: </font>Real<font color="#000080">;
    </font>Angle  <font color="#000080">: </font>Integer<font color="#000080">;
    </font>Size   <font color="#000080">: </font>TPoint<font color="#000080">;
    </font>CurPage<font color="#000080">: </font>Integer<font color="#000080">;
    </font>Texture<font color="#000080">: </font>TImage<font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Run<font color="#000080">;      </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">;    </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Draw<font color="#000080">;     </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>FlipPage<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Rotate<font color="#000080">( </font>AngleStep<font color="#000080">: </font>Integer <font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Move<font color="#000080">( </font>DeltaX<font color="#000080">, </font>DeltaY<font color="#000080">: </font>Integer <font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Scale<font color="#000080">( </font>Factor<font color="#000080">: </font>Real <font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Update<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Pal<font color="#000080">:  </font>TRGBPalette<font color="#000080">;
  </font>Time<font color="#000080">:  </font>LongInt <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0</font><font color="#000080">:</font><font color="#800000">$46C</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRotateApp<font color="#000080">.</font>FlipPage<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CurPage <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">-</font>CurPage<font color="#000080">;
  </font>ShowPage<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">-</font>CurPage<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>constructor </b></font>TRotateApp<font color="#000080">.</font>Init<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">, </font>J<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not inherited </b></font>Init<font color="#000080">(</font>True<font color="#000080">) </font><font color="#FF0000"><b>or not </b></font>Texture<font color="#000080">.</font>Load<font color="#000080">( </font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) ) </font><font color="#FF0000"><b>then </b></font>Fail<font color="#000080">;
  </font>SetPalette<font color="#000080">( </font>Texture<font color="#000080">.</font>Palette <font color="#000080">);
  </font>X <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Y <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>WSX <font color="#000080">:= </font><font color="#800000">240</font><font color="#000080">;
  </font>WSY <font color="#000080">:= </font><font color="#800000">360</font><font color="#000080">;
  </font>WSXR <font color="#000080">:= </font>WSX<font color="#000080">;
  </font>WSYR <font color="#000080">:= </font>WSY<font color="#000080">;
  </font>Angle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Size<font color="#000080">.</font>X <font color="#000080">:= </font>HRes <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
  </font>Size<font color="#000080">.</font>Y <font color="#000080">:= </font>VRes <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
  </font>FramesNumber <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>StartTime <font color="#000080">:= </font>Time<font color="#000080">;  </font><font color="#008000"><i>{     asm mov ax,13h; int 10h; end;}
  </i></font>system<font color="#000080">.</font>move <font color="#000080">(</font>Texture<font color="#000080">.</font>Data<font color="#000080">^,</font>Screen<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);
    </font>SetPalette<font color="#000080">( </font>Texture<font color="#000080">.</font>Palette <font color="#000080">);
</font><font color="#008000"><i>{  readkey;}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRotateApp<font color="#000080">.</font>Rotate<font color="#000080">( </font>AngleStep<font color="#000080">: </font>Integer <font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>Inc<font color="#000080">( </font>Angle<font color="#000080">, </font>AngleStep <font color="#000080">);
  </font>Angle <font color="#000080">:= </font>Angle <font color="#FF0000"><b>mod </b></font>RotateSteps<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRotateApp<font color="#000080">.</font>Move<font color="#000080">( </font>DeltaX<font color="#000080">, </font>DeltaY<font color="#000080">: </font>Integer <font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>Inc<font color="#000080">( </font>X<font color="#000080">, </font>DeltaX <font color="#000080">);
  </font>Inc<font color="#000080">( </font>Y<font color="#000080">, </font>DeltaY <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRotateApp<font color="#000080">.</font>Scale<font color="#000080">( </font>Factor<font color="#000080">: </font>Real <font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>WSXR <font color="#000080">:= </font>WSXR<font color="#000080">*</font>Factor<font color="#000080">;
  </font>WSX <font color="#000080">:= </font>Round<font color="#000080">(</font>WSXR<font color="#000080">);
  </font>WSYR <font color="#000080">:= </font>WSYR<font color="#000080">*</font>Factor<font color="#000080">;
  </font>WSY <font color="#000080">:= </font>Round<font color="#000080">(</font>WSYR<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRotateApp<font color="#000080">.</font>Update<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Move<font color="#000080">( </font>MoveStep<font color="#000080">, </font>MoveStep <font color="#000080">);
  </font>Rotate<font color="#000080">(</font>AngleStep<font color="#000080">);
  </font>Scale<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">+</font>ScaleStep<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>WSY <font color="#000080">&gt;= </font><font color="#800000">2000</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>WSY<font color="#000080">&lt;=</font><font color="#800000">100</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>ScaleStep <font color="#000080">:= -</font>ScaleStep<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRotateApp<font color="#000080">.</font>Draw<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>I <font color="#000080">:  </font>Integer<font color="#000080">;
  </font>Border<font color="#000080">,
  </font>LineBuf<font color="#000080">: </font>TPointArray<font color="#000080">;
  </font>BorderLen<font color="#000080">: </font>Integer<font color="#000080">;
  </font>X1RN<font color="#000080">,</font>X1LN<font color="#000080">,
  </font>Y1RN<font color="#000080">,</font>Y1LN<font color="#000080">,
  </font>X2RN<font color="#000080">,</font>X2LN<font color="#000080">,
  </font>Y2RN<font color="#000080">,</font>Y2LN<font color="#000080">,
  </font>X1R<font color="#000080">,</font>X1L<font color="#000080">,
  </font>Y1R<font color="#000080">,</font>Y1L<font color="#000080">,
  </font>X2R<font color="#000080">,</font>X2L<font color="#000080">,
  </font>Y2R<font color="#000080">,</font>Y2L<font color="#000080">,
  </font>XL<font color="#000080">,</font>YL<font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#008000"><i>{ This function can be heavly optimized but I'm too lazy to do absoletely
  meaningless things :-) }
</i></font><font color="#FF0000"><b>function </b></font>BuildLine<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">: </font>TPointArray<font color="#000080">; </font>X1<font color="#000080">,</font>Y1<font color="#000080">, </font>X2<font color="#000080">,</font>Y2<font color="#000080">: </font>Integer<font color="#000080">;
      </font>Len<font color="#000080">: </font>Integer <font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">: </font>Word<font color="#000080">;
  </font>XStep<font color="#000080">,
  </font>YStep<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XStep <font color="#000080">:= (</font>LongInt<font color="#000080">(</font>X2<font color="#000080">-</font>X1<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>Len<font color="#000080">;
  </font>YStep <font color="#000080">:= (</font>LongInt<font color="#000080">(</font>Y2<font color="#000080">-</font>Y1<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>Len<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Len <font color="#FF0000"><b>do
  begin
    </b></font>Buffer<font color="#000080">[</font>I<font color="#000080">].</font>X <font color="#000080">:= </font>Integer<font color="#000080">( ((</font>XStep<font color="#000080">*</font>I<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">) - ((</font>XStep<font color="#000080">*(</font>I<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">) );
    </font>Buffer<font color="#000080">[</font>I<font color="#000080">].</font>Y <font color="#000080">:= </font>Integer<font color="#000080">( ((</font>YStep<font color="#000080">*</font>I<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">) - ((</font>YStep<font color="#000080">*(</font>I<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">) );
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>DrawPicLine<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">; </font>BitPlane<font color="#000080">: </font>Integer<font color="#000080">;
        </font>StartX<font color="#000080">, </font>StartY<font color="#000080">: </font>Integer<font color="#000080">; </font>Len<font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>LineBuf <font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>PD <font color="#000080">:  </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>PD <font color="#000080">:= </font>Texture<font color="#000080">.</font>Data<font color="#000080">;           </font><font color="#008000"><i>{ pointer to unpacked screen image }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$3C4</font><font color="#000080">] := </font><font color="#800000">2</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>BitPlane <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>Port<font color="#000080">[</font><font color="#800000">$3C5</font><font color="#000080">] := </font><font color="#800000">3
  </font><font color="#FF0000"><b>else
    </b></font>Port<font color="#000080">[</font><font color="#800000">$3C5</font><font color="#000080">] := </font><font color="#800000">12</font><font color="#000080">;

  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push  ds
    mov   bx,[StartX]             </font><font color="#008000"><i>{ bx = StartX }
    </i></font><font color="#FF00FF">mov   dx,[StartY]             </font><font color="#008000"><i>{ dx = StartY }
    </i></font><font color="#FF00FF">les   di,Buffer               </font><font color="#008000"><i>{ ES:DI = @Screen }
    </i></font><font color="#FF00FF">add   di,VPageLen/2-Hres/4    </font><font color="#008000"><i>{ calc target page }
    </i></font><font color="#FF00FF">mov   cx,Len                  </font><font color="#008000"><i>{ Drawing buffer length }
    </i></font><font color="#FF00FF">lds   si,PD                   </font><font color="#008000"><i>{ DS:SI = pointer to data }
    </i></font><font color="#FF00FF">push  bp                      </font><font color="#008000"><i>{ store BP }
    </i></font><font color="#FF00FF">mov   bp,word ptr LineBuf     </font><font color="#008000"><i>{ BP = offset LineBuf }
    </i></font><font color="#FF00FF">cld
@loop:
      PUSH DX
      MOV  AX,320
      MUL  DX                     </font><font color="#008000"><i>{ AX = StartY*320 }
      </i></font><font color="#FF00FF">POP  DX

      PUSH BX
      ADD  BX,AX
      mov  al,[bx+SI]
      POP  BX

      stosb
      sub  di,HRes/4+1</font><font color="#008000"><i>{ add di,hres-1}
      </i></font><font color="#FF00FF">add  BX,[bp]
      ADD  bp,2
      add  DX,[bp]
      ADD  bp,2

</font><font color="#008000"><i>{      CMP  BX,320
      JB   @@1
      XOR  BX,BX
@@1:  CMP  DX,200
      JB   @@2
      XOR  DX,DX
@@2:}
      </i></font><font color="#FF00FF">loop @loop

      pop bp
      pop ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin

</b></font><font color="#008000"><i>{ Just imagine what can be if the next 8 lines would be more complex.
  I'm working around it. }
{
     (X1L,Y1L)        (X2R,Y1R)
        +---------------+
        |               |
        |               |
        |               |
        +---------------+
     (X2L,Y2L)        (X2R,Y2R)

     (X1LN,Y1LN)        (X2RN,Y1RN)
        +---------------+
        |               |
        |               |
        |               |
        +---------------+
     (X2LN,Y2LN)        (X2RN,Y2RN)

}
  </i></font>X1L <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Y1L <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>X2L <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Y2L <font color="#000080">:= </font>WSY<font color="#000080">;
  </font>X1R <font color="#000080">:= </font>WSX<font color="#000080">;
  </font>Y1R <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>X2R <font color="#000080">:= </font>WSX<font color="#000080">;
  </font>Y2R <font color="#000080">:= </font>WSY<font color="#000080">;
</font><font color="#008000"><i>{ I call Cos and Sin instead of using tables!? Yeah, I do. So what?
  See comments near BuildLine ;-) }
{  I just rotate the rectangle corners, but why I do no more? }
  </i></font>X1RN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>X1R<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)+</font>Y1R<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );
  </font>Y1RN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>Y1R<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)-</font>X1R<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );
  </font>X1LN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>X1L<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)+</font>Y1L<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );
  </font>Y1LN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>Y1L<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)-</font>X1L<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );
  </font>X2RN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>X2R<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)+</font>Y2R<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );
  </font>Y2RN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>Y2R<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)-</font>X2R<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );
  </font>X2LN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>X2L<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)+</font>Y2L<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );
  </font>Y2LN <font color="#000080">:= </font>Round<font color="#000080">(
(</font>Y2L<font color="#000080">*</font>Cos<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)-</font>X2L<font color="#000080">*</font>Sin<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">/</font>RotateSteps<font color="#000080">*</font>Angle<font color="#000080">)) );

  </font>XL <font color="#000080">:= </font>X<font color="#000080">+</font>X1LN<font color="#000080">;
  </font>YL <font color="#000080">:= </font>Y<font color="#000080">+</font>Y1LN<font color="#000080">;

  </font>BuildLine<font color="#000080">( </font>Border<font color="#000080">, </font>XL<font color="#000080">,</font>YL<font color="#000080">, </font>X<font color="#000080">+</font>X2LN<font color="#000080">,</font>Y<font color="#000080">+</font>Y2LN<font color="#000080">, </font>Size<font color="#000080">.</font>X <font color="#000080">);
  </font>BuildLine<font color="#000080">( </font>LineBuf<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>X1RN<font color="#000080">-</font>X1LN<font color="#000080">, </font>Y1RN<font color="#000080">-</font>Y1LN<font color="#000080">, </font>Size<font color="#000080">.</font>Y <font color="#000080">);

</font><font color="#008000"><i>{
  The only thing that can be optimized is the loop below. I think it should
  be completely in asm.
}
  </i></font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Size<font color="#000080">.</font>X <font color="#FF0000"><b>do
  begin
   </b></font>DrawPicLine<font color="#000080">( </font>PBuffer<font color="#000080">(@</font>Screen<font color="#000080">)^[</font>CurPage<font color="#000080">*</font>VPageLen<font color="#000080">+(</font>I<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">],
   (</font>I<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#008000"><i>{mod 2} </i></font><font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">, </font>XL<font color="#000080">, </font>YL<font color="#000080">, </font>Size<font color="#000080">.</font>Y<font color="#000080">, </font>LineBuf <font color="#000080">);
</font><font color="#008000"><i>{
    Inc( XL, Border[I].X );
    Inc( YL, Border[I].Y );
}
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov   di,I
    shl   di,2
    mov   ax,word ptr border[di]-4
    add   XL,ax
    mov   ax,word ptr Border[di]-4+2
    add   YL,ax
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRotateApp<font color="#000080">.</font>Run<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>C<font color="#000080">:  </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  repeat
    if </b></font>KeyPressed <font color="#FF0000"><b>then
    begin
      </b></font>C <font color="#000080">:= </font>ReadKey<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>C <font color="#000080">= </font><font color="#800000">#0 </font><font color="#FF0000"><b>then </b></font>C <font color="#000080">:= </font>ReadKey<font color="#000080">;
      </font><font color="#FF0000"><b>case </b></font>C <font color="#FF0000"><b>of
 </b></font><font color="#800000">#72</font><font color="#000080">: </font>Move<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,-</font><font color="#800000">10</font><font color="#000080">);
 </font><font color="#800000">#80</font><font color="#000080">: </font>Move<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,-</font><font color="#800000">10</font><font color="#000080">);
 </font><font color="#800000">#75</font><font color="#000080">: </font>Move<font color="#000080">(-</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
 </font><font color="#800000">#77</font><font color="#000080">: </font>Move<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
 </font><font color="#800000">#81</font><font color="#000080">: </font>Rotate<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
 </font><font color="#800000">#79</font><font color="#000080">: </font>Rotate<font color="#000080">(-</font><font color="#800000">1</font><font color="#000080">);
 </font><font color="#800000">'+'</font><font color="#000080">: </font>Scale<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">+</font>ScaleStep<font color="#000080">);
 </font><font color="#800000">'-'</font><font color="#000080">: </font>Scale<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">-</font>ScaleStep<font color="#000080">);
 </font><font color="#800000">#27</font><font color="#000080">: </font>Exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Draw<font color="#000080">;
</font><font color="#008000"><i>{ You can comment out the line below and do all transformation yourself }
   </i></font>Update<font color="#000080">;
   </font>FlipPage<font color="#000080">;
   </font>Inc<font color="#000080">( </font>FramesNumber <font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>TRotateApp<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  inherited </b></font>Done<font color="#000080">;
  </font>WriteLn<font color="#000080">( </font><font color="#800000">'Frames per second = '</font><font color="#000080">,
    (</font>FramesNumber <font color="#000080">/ ((</font>Time<font color="#000080">-</font>StartTime<font color="#000080">)*</font><font color="#800000">0.055</font><font color="#000080">) ):</font><font color="#800000">5</font><font color="#000080">:</font><font color="#800000">2 </font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>RotateApp<font color="#000080">: </font>TRotateApp<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not </b></font>RotateApp<font color="#000080">.</font>Init <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font>RotateApp<font color="#000080">.</font>Run<font color="#000080">;
  </font>RotateApp<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{---------------------   UNIT CODE NEEDED HERE -------------------- }

{
  VGA graphics unit.
  Coded by Mike Shirobokov(MSH) aka Mad Max / Queue members.

  This this the very small part of my gfx unit. I leave only functions used
  by RotateApp.

  Bugs corrected by Alex Grischenko
}

</i></font><font color="#FF0000"><b>unit </b></font>VGAGraph<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses </b></font>Objects<font color="#000080">, </font>Memory<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>HRes  <font color="#000080">= </font><font color="#800000">360</font><font color="#000080">;
  </font>VRes  <font color="#000080">= </font><font color="#800000">320</font><font color="#000080">;
  </font>VPageLen <font color="#000080">= </font>HRes<font color="#000080">*</font>VRes <font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">;

</font><font color="#008000"><i>{  HRes = 320; VRes=200; Vpagelen=0;}

</i></font><font color="#FF0000"><b>type
  </b></font>PBuffer <font color="#000080">= ^</font>TBuffer<font color="#000080">;
  </font>TBuffer <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[ </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">65534 </font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>PScreenBuffer <font color="#000080">= ^</font>TScreenBuffer<font color="#000080">;
  </font>TScreenBuffer <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[ </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">199</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">319 </font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>TRGBPalette <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[ </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255 </font><font color="#000080">] </font><font color="#FF0000"><b>of record </b></font>R<font color="#000080">,</font>G<font color="#000080">,</font>B<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PImage <font color="#000080">= ^</font>TImage<font color="#000080">;
  </font>TImage <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">( </font>TObject <font color="#000080">)
    </font>Size<font color="#000080">: </font>TPoint<font color="#000080">;
    </font>Palette<font color="#000080">: </font>TRGBPalette<font color="#000080">;
    </font>Data<font color="#000080">: </font>PBuffer<font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Load<font color="#000080">( </font>Name<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
</font><font color="#008000"><i>{   This procedures are now killed. If you need them just write me or see
    old mail from me.
    procedure Show( Origin: TPoint; var Buffer );
    procedure ShowRect( Origin: TPoint; NewSize: TPoint; var Buffer ); }
    </i></font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PGraphApplication <font color="#000080">= ^</font>TGraphApplication<font color="#000080">;
  </font>TGraphApplication <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">( </font>TObject <font color="#000080">)
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">( </font>ModeX <font color="#000080">: </font>Boolean <font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Run<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Screen<font color="#000080">: </font>TScreenBuffer <font color="#FF0000"><b>absolute </b></font><font color="#800000">$A000</font><font color="#000080">:</font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>SetPalette<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>Pal<font color="#000080">: </font>TRGBPalette <font color="#000080">);
  </font><font color="#FF0000"><b>procedure </b></font>Set360x240Mode<font color="#000080">;
  </font><font color="#FF0000"><b>procedure </b></font>ShowPage<font color="#000080">( </font>Page<font color="#000080">: </font>Integer <font color="#000080">);

</font><font color="#FF0000"><b>implementation

uses </b></font>PCX<font color="#000080">;

</font><font color="#FF0000"><b>constructor </b></font>TImage<font color="#000080">.</font>Load<font color="#000080">( </font>Name<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>S<font color="#000080">: </font>TDosStream<font color="#000080">;
  </font>I<font color="#000080">: </font>Integer<font color="#000080">;
  </font>P<font color="#000080">: </font>OldPCXPicture<font color="#000080">;
  </font>Len<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  inherited </b></font>Init<font color="#000080">;
  </font>P<font color="#000080">.</font>Init<font color="#000080">( </font>Name <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>P<font color="#000080">.</font>Status <font color="#000080">&lt;&gt; </font>pcxOK <font color="#FF0000"><b>then
  begin
    </b></font>P<font color="#000080">.</font>Done<font color="#000080">;
    </font>Fail<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Size<font color="#000080">.</font>X <font color="#000080">:= </font>P<font color="#000080">.</font>H<font color="#000080">.</font>XMax <font color="#000080">- </font>P<font color="#000080">.</font>H<font color="#000080">.</font>XMin <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>Size<font color="#000080">.</font>Y <font color="#000080">:= </font>P<font color="#000080">.</font>H<font color="#000080">.</font>YMax <font color="#000080">- </font>P<font color="#000080">.</font>H<font color="#000080">.</font>YMin <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
</font><font color="#008000"><i>{
  I use DOS memory allocation 'cuz GetMem can't allocate 64K
  Even thru DPMI.  :-(
  GetMem( Data, Word(Size.X) * Size.Y );
}
  </i></font>Len <font color="#000080">:= </font>Word<font color="#000080">((</font>LongInt<font color="#000080">(</font>Size<font color="#000080">.</font>X<font color="#000080">)*</font>Size<font color="#000080">.</font>Y<font color="#000080">+</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">16</font><font color="#000080">);
  </font>LEN<font color="#000080">:=</font><font color="#800000">65536 </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">16</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ah,48h
    mov bx,Len
    int 21h
    jnc @mem_ok
    xor ax,ax
@mem_ok:
    mov word ptr es:[di].Data+2,ax
    xor ax,ax
    mov word ptr es:[di].Data,ax
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>Data <font color="#000080">= </font><font color="#FF0000"><b>nil then
  begin
    </b></font>P<font color="#000080">.</font>Done<font color="#000080">;
    </font>Fail<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>fillchar<font color="#000080">(</font>Data<font color="#000080">^,</font>len<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);

  </font>Move<font color="#000080">( </font>P<font color="#000080">.</font>Pal<font color="#000080">, </font>Palette<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Palette<font color="#000080">) );
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
  begin
    </b></font>Palette<font color="#000080">[</font>I<font color="#000080">].</font>R <font color="#000080">:= </font>Palette<font color="#000080">[</font>I<font color="#000080">].</font>R <font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
    </font>Palette<font color="#000080">[</font>I<font color="#000080">].</font>G <font color="#000080">:= </font>Palette<font color="#000080">[</font>I<font color="#000080">].</font>G <font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
    </font>Palette<font color="#000080">[</font>I<font color="#000080">].</font>B <font color="#000080">:= </font>Palette<font color="#000080">[</font>I<font color="#000080">].</font>B <font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Size<font color="#000080">.</font>Y<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
    </b></font>P<font color="#000080">.</font>ReadLine<font color="#000080">( </font>Data<font color="#000080">^[ </font>Word<font color="#000080">(</font>Size<font color="#000080">.</font>X<font color="#000080">)*</font>I <font color="#000080">] );
  </font>P<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>TImage<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{
  FreeMem( Data, Word(Size.X)*Size.Y );
}
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ah,49h
    mov ax,word ptr es:[di].Data+2
    mov es,ax
    int 21h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>constructor </b></font>TGraphApplication<font color="#000080">.</font>Init<font color="#000080">( </font>ModeX <font color="#000080">: </font>Boolean <font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>Set360x240Mode
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TGraphApplication<font color="#000080">.</font>Run<font color="#000080">;
</font><font color="#FF0000"><b>begin
  Abstract</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>TGraphApplication<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">mov ax,3h
    int 10h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetPalette<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>Pal<font color="#000080">: </font>TRGBPalette <font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>I <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
  begin
    </b></font>Port<font color="#000080">[</font><font color="#800000">$3C8</font><font color="#000080">] := </font>I<font color="#000080">;
    </font>Port<font color="#000080">[</font><font color="#800000">$3C9</font><font color="#000080">] := </font>Pal<font color="#000080">[</font>I<font color="#000080">].</font>R<font color="#000080">;
    </font>Port<font color="#000080">[</font><font color="#800000">$3C9</font><font color="#000080">] := </font>Pal<font color="#000080">[</font>I<font color="#000080">].</font>G<font color="#000080">;
    </font>Port<font color="#000080">[</font><font color="#800000">$3C9</font><font color="#000080">] := </font>Pal<font color="#000080">[</font>I<font color="#000080">].</font>B<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{  Modified from public-domain mode set code by John Bridges. }

</i></font><font color="#FF0000"><b>const
 </b></font>SC_INDEX  <font color="#000080">= </font><font color="#800000">$03c4</font><font color="#000080">;   </font><font color="#008000"><i>{Sequence Controller Index}
 </i></font>CRTC_INDEX <font color="#000080">= </font><font color="#800000">$03d4</font><font color="#000080">;   </font><font color="#008000"><i>{CRT Controller Index}
 </i></font>MISC_OUTPUT  <font color="#000080">= </font><font color="#800000">$03c2</font><font color="#000080">;   </font><font color="#008000"><i>{Miscellaneous Output register}

{ Index/data pairs for CRT Controller registers that differ between
  mode 13h and mode X. }

</i></font>CRT_PARM_LENGTH <font color="#000080">= </font><font color="#800000">17</font><font color="#000080">;
</font>CRTParms <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>CRT_PARM_LENGTH<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Word <font color="#000080">= (

 </font><font color="#800000">$6B00</font><font color="#000080">,  </font><font color="#008000"><i>{ Horz total }
 </i></font><font color="#800000">$5901</font><font color="#000080">,  </font><font color="#008000"><i>{ Horz Displayed }
 </i></font><font color="#800000">$5A02</font><font color="#000080">,  </font><font color="#008000"><i>{ Start Horz Blanking }
 </i></font><font color="#800000">$8E03</font><font color="#000080">,  </font><font color="#008000"><i>{ End Horz Blanking }
 </i></font><font color="#800000">$5E04</font><font color="#000080">,  </font><font color="#008000"><i>{ Start H Sync }
 </i></font><font color="#800000">$8A05</font><font color="#000080">,  </font><font color="#008000"><i>{ End H Sync }
 </i></font><font color="#800000">$0d06</font><font color="#000080">,  </font><font color="#008000"><i>{vertical total}
 </i></font><font color="#800000">$3e07</font><font color="#000080">,  </font><font color="#008000"><i>{overflow (bit 8 of vertical counts)}
 </i></font><font color="#800000">$ea10</font><font color="#000080">,  </font><font color="#008000"><i>{v sync start}
 </i></font><font color="#800000">$8c11</font><font color="#000080">,  </font><font color="#008000"><i>{v sync end and protect cr0-cr7}
 </i></font><font color="#800000">$df12</font><font color="#000080">,  </font><font color="#008000"><i>{vertical displayed}
 </i></font><font color="#800000">$e715</font><font color="#000080">,  </font><font color="#008000"><i>{v blank start}
 </i></font><font color="#800000">$0616</font><font color="#000080">,  </font><font color="#008000"><i>{v blank end}
 </i></font><font color="#800000">$4209</font><font color="#000080">,  </font><font color="#008000"><i>{cell height (2 to double-scan)}
 </i></font><font color="#800000">$0014</font><font color="#000080">,  </font><font color="#008000"><i>{turn off dword mode}
 </i></font><font color="#800000">$e317</font><font color="#000080">,  </font><font color="#008000"><i>{turn on byte mode}
 </i></font><font color="#800000">$2D13 </font><font color="#008000"><i>{90 bytes per line}
</i></font><font color="#000080">);

</font><font color="#FF0000"><b>procedure </b></font>Set360x240Mode<font color="#000080">;
</font><font color="#FF0000"><b>begin
 asm
 </b></font><font color="#FF00FF">mov     ax,13h  </font><font color="#008000"><i>{let the BIOS set standard 256-color}
 </i></font><font color="#FF00FF">int     10h     </font><font color="#008000"><i>{mode (320x200 linear)}

 </i></font><font color="#FF00FF">mov     dx,SC_INDEX
 mov     ax,0604h
 out     dx,ax   </font><font color="#008000"><i>{disable chain4 mode}
 </i></font><font color="#FF00FF">mov     ax,0100h
 out     dx,ax   </font><font color="#008000"><i>{synchronous reset while switching clocks}

 </i></font><font color="#FF00FF">mov     dx,MISC_OUTPUT
 mov     al,0E7h
 out     dx,al   </font><font color="#008000"><i>{select 28 MHz dot clock &amp; 60 Hz scanning rate}

 </i></font><font color="#FF00FF">mov     dx,SC_INDEX
 mov     ax,0300h
 out     dx,ax   </font><font color="#008000"><i>{undo reset (restart sequencer)}

 </i></font><font color="#FF00FF">mov     dx,CRTC_INDEX </font><font color="#008000"><i>{reprogram the CRT Controller}
 </i></font><font color="#FF00FF">mov     al,11h  </font><font color="#008000"><i>{VSync End reg contains register write}
 </i></font><font color="#FF00FF">out     dx,al   </font><font color="#008000"><i>{protect bit}
 </i></font><font color="#FF00FF">inc     dx      </font><font color="#008000"><i>{CRT Controller Data register}
 </i></font><font color="#FF00FF">in      al,dx   </font><font color="#008000"><i>{get current VSync End register setting}
 </i></font><font color="#FF00FF">and     al,7fh  </font><font color="#008000"><i>{remove write protect on various}
 </i></font><font color="#FF00FF">out     dx,al   </font><font color="#008000"><i>{CRTC registers}
 </i></font><font color="#FF00FF">dec     dx      </font><font color="#008000"><i>{CRT Controller Index}
 </i></font><font color="#FF00FF">cld
 mov     si,offset CRTParms </font><font color="#008000"><i>{point to CRT parameter table}
 </i></font><font color="#FF00FF">mov     cx,CRT_PARM_LENGTH </font><font color="#008000"><i>{# of table entries}
</i></font><font color="#FF00FF">@SetCRTParmsLoop:
 lodsw           </font><font color="#008000"><i>{get the next CRT Index/Data pair}
 </i></font><font color="#FF00FF">out     dx,ax   </font><font color="#008000"><i>{set the next CRT Index/Data pair}
 </i></font><font color="#FF00FF">push cx
 mov cx,1000
@loop: loop @loop
 pop cx
 loop    @SetCRTParmsLoop

 mov     dx,SC_INDEX
 mov     ax,0f02h
 out     dx,ax   </font><font color="#008000"><i>{enable writes to all four planes}
 </i></font><font color="#FF00FF">mov     ax,$A000</font><font color="#008000"><i>{now clear all display memory, 8 pixels}
 </i></font><font color="#FF00FF">mov     es,ax         </font><font color="#008000"><i>{at a time}
 </i></font><font color="#FF00FF">sub     di,di   </font><font color="#008000"><i>{point ES:DI to display memory}
 </i></font><font color="#FF00FF">sub     ax,ax   </font><font color="#008000"><i>{clear to zero-value pixels}
 </i></font><font color="#FF00FF">mov     cx,VRes*HRes/4/2 </font><font color="#008000"><i>{# of words in display memory}
 </i></font><font color="#FF00FF">rep     stosw   </font><font color="#008000"><i>{clear all of display memory}
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>ShowPage<font color="#000080">( </font>Page<font color="#000080">: </font>Integer <font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm
      </b></font><font color="#FF00FF">mov ax,VPageLen
      mul word ptr Page
      mov bx,ax

      mov dx,3d4h
      mov al,0ch
      mov ah,bh
      out dx,ax
      mov dx,3d4h
      mov al,0dh
      mov ah,bl
      out dx,ax
</font><font color="#008000"><i>{ Uncomment this waiting for retrace if you see flickering }
{
      mov dx,3dah
 @@1: in al,dx
      test al,00001000b
      jz @@1
 @@2: in   al,dx
      test al,00001000b
      jnz  @@2
}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font><font color="#008000"><i>{ --------------------------  UNIT CODE NEEDED HERE -------------}

{
  256 color PCX bitmaps handling unit.
  NewPCXPicture object are removed to reduce traffic. If you
  need it just contact me or dig in old mail from me.
  Coded by Mike Shirobokov(MSH) aka Mad Max / Queue Members.
  Free sourceware.
}

</i></font><font color="#FF0000"><b>unit </b></font>PCX<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses </b></font>Objects<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TRGBPalette <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[ </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255 </font><font color="#000080">] </font><font color="#FF0000"><b>of record </b></font>R<font color="#000080">,</font>G<font color="#000080">,</font>B<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PCXHeader <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>Creator<font color="#000080">,
    </font>Version<font color="#000080">,
    </font>Encoding<font color="#000080">,
    </font>Bits<font color="#000080">: </font>Byte<font color="#000080">;
    </font>XMin<font color="#000080">,
    </font>YMin<font color="#000080">,
    </font>XMax<font color="#000080">,
    </font>YMax<font color="#000080">,
    </font>HRes<font color="#000080">,
    </font>VRes<font color="#000080">: </font>Integer<font color="#000080">;
    </font>Palette<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[ </font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">48 </font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
    </font>VMode<font color="#000080">,
    </font>Planes<font color="#000080">: </font>Byte<font color="#000080">;
    </font>BytesPerLine<font color="#000080">,
    </font>PaletteInfo<font color="#000080">,
    </font>SHRes<font color="#000080">,
    </font>SVRes<font color="#000080">: </font>Word<font color="#000080">;
    </font>Dummy<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">53</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>pcxOK   <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>pcxInvalidType <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>pcxNoFile  <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>OldPCXPicture <font color="#000080">= </font><font color="#FF0000"><b>object
    </b></font>H<font color="#000080">:  </font>PCXHeader<font color="#000080">;
    </font>S<font color="#000080">:  </font>TBufStream<font color="#000080">;
    </font>Pal<font color="#000080">: </font>TRGBPalette<font color="#000080">;
    </font>Status<font color="#000080">: </font>Integer<font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">( </font>AFileName<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>ReadLine<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>Buffer <font color="#000080">);
    </font><font color="#FF0000"><b>function </b></font>ErrorText<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{
  NewPCXPicture = object
    H:  PCXHeader;
    S:  TBufStream;
    Pal: TRGBPalette;
    constructor Init( AFileName: String; HSize: Integer );
    procedure WriteLine( var Buffer );
    destructor Done;
  end;
}
</i></font><font color="#FF0000"><b>implementation

type
  </b></font>GetByteFunc <font color="#000080">= </font><font color="#FF0000"><b>function</b></font><font color="#000080">: </font>Byte<font color="#000080">;
  </font>ByteArr <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">65534</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>PByte  <font color="#000080">= ^</font>ByteArr<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>UnpackString<font color="#000080">( </font>GetByte<font color="#000080">: </font>GetByteFunc<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Dest<font color="#000080">; </font>Size<font color="#000080">: </font>Integer <font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>DestPtr<font color="#000080">: </font>PByte<font color="#000080">;
  </font>Count<font color="#000080">: </font>Integer<font color="#000080">;
  </font>B<font color="#000080">:  </font>Byte<font color="#000080">;
  </font>I<font color="#000080">:  </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DestPtr <font color="#000080">:= @</font>Dest<font color="#000080">;
  </font>Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>Count <font color="#000080">&lt; </font>Size <font color="#FF0000"><b>do
  begin
    </b></font>B <font color="#000080">:= </font>GetByte<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>B <font color="#000080">&lt; </font><font color="#800000">$C0 </font><font color="#FF0000"><b>then
    begin
      </b></font>DestPtr<font color="#000080">^[</font>Count<font color="#000080">] := </font>B<font color="#000080">;
      </font>Inc<font color="#000080">(</font>Count<font color="#000080">);
    </font><font color="#FF0000"><b>end
    else
    begin
      </b></font>DestPtr<font color="#000080">^[</font>Count<font color="#000080">] := </font>GetByte<font color="#000080">;
      </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>B<font color="#000080">-</font><font color="#800000">$C1 </font><font color="#FF0000"><b>do
 </b></font>DestPtr<font color="#000080">^[</font>Count<font color="#000080">+</font>I<font color="#000080">] := </font>DestPtr<font color="#000080">^[</font>Count<font color="#000080">];
      </font>Inc<font color="#000080">( </font>Count<font color="#000080">, </font>I<font color="#000080">+</font><font color="#800000">1 </font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>constructor </b></font>OldPCXPicture<font color="#000080">.</font>Init<font color="#000080">( </font>AFileName<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>S<font color="#000080">.</font>Init<font color="#000080">( </font>AFileName<font color="#000080">, </font>stOpenRead<font color="#000080">, </font><font color="#800000">2048 </font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>S<font color="#000080">.</font>Status <font color="#000080">&lt;&gt; </font>stOk <font color="#FF0000"><b>then
  begin
    </b></font>Status <font color="#000080">:= </font>pcxNoFile<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>S<font color="#000080">.</font>Read<font color="#000080">( </font>H<font color="#000080">, </font>SizeOf<font color="#000080">(</font>H<font color="#000080">) );
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>H<font color="#000080">.</font>Planes <font color="#000080">&lt;&gt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>H<font color="#000080">.</font>Encoding <font color="#000080">&lt;&gt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>H<font color="#000080">.</font>Bits <font color="#000080">&lt;&gt; </font><font color="#800000">8 </font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>Status <font color="#000080">:= </font>pcxInvalidType<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>S<font color="#000080">.</font>Seek<font color="#000080">( </font>S<font color="#000080">.</font>GetSize <font color="#000080">- </font>SizeOf<font color="#000080">(</font>Pal<font color="#000080">) );
  </font>S<font color="#000080">.</font>Read<font color="#000080">( </font>Pal<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Pal<font color="#000080">) );
  </font>S<font color="#000080">.</font>Seek<font color="#000080">( </font>SizeOf<font color="#000080">(</font>H<font color="#000080">) );
  </font>Status <font color="#000080">:= </font>pcxOK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>__GetS__<font color="#000080">: </font>PStream<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Get<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>B<font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>__GetS__<font color="#000080">^.</font>Read<font color="#000080">( </font>B<font color="#000080">, </font><font color="#800000">1 </font><font color="#000080">);
  </font>Get <font color="#000080">:= </font>B<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>OldPCXPicture<font color="#000080">.</font>ReadLine<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>Buffer <font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>__GetS__ <font color="#000080">:= @</font>S<font color="#000080">;
  </font>UnpackString<font color="#000080">( </font>Get<font color="#000080">, </font>Buffer<font color="#000080">, </font>H<font color="#000080">.</font>BytesPerLine <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>OldPCXPicture<font color="#000080">.</font>ErrorText<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  case </b></font>Status <font color="#FF0000"><b>of
    </b></font>pcxOK<font color="#000080">:
      </font>ErrorText <font color="#000080">:= </font><font color="#800000">'No errors'</font><font color="#000080">;
    </font>pcxNoFile<font color="#000080">:
      </font>ErrorText <font color="#000080">:= </font><font color="#800000">'Can''t open file'</font><font color="#000080">;
    </font>pcxInvalidType<font color="#000080">:
      </font>ErrorText <font color="#000080">:= </font><font color="#800000">'Only 8 bit PCXs are supported'</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>OldPCXPicture<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>S<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0117.PAS">Original</a><b>]</b></p></body>
</html>
