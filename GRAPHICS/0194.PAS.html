<html>
<head><title> "FLI Format & Source" by TOMASZ FORMANOWSKI</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0194.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>unit </b></font>fli<font color="#000080">;
</font><font color="#FF0000"><b>interface
uses </b></font>crt<font color="#000080">;
</font><font color="#FF0000"><b>type
</b></font>fliheader<font color="#000080">=</font><font color="#FF0000"><b>record
</b></font>size <font color="#000080">: </font>longint<font color="#000080">;
</font>htype<font color="#000080">:</font>word<font color="#000080">;
</font>framecount<font color="#000080">:</font>word<font color="#000080">;
</font>width<font color="#000080">:</font>word<font color="#000080">;
</font>height<font color="#000080">:</font>word<font color="#000080">;
</font>bitsperpixel<font color="#000080">:</font>word<font color="#000080">;
</font>flags<font color="#000080">:</font>integer<font color="#000080">;
</font>speed<font color="#000080">:</font>integer<font color="#000080">;
</font>nexthead<font color="#000080">:</font>longint<font color="#000080">;
</font>framesintable<font color="#000080">:</font>longint<font color="#000080">;
</font>hfile<font color="#000080">:</font>integer<font color="#000080">;
</font>hframe1offset<font color="#000080">:</font>longint<font color="#000080">;
</font>strokes<font color="#000080">:</font>longint<font color="#000080">;
</font>session<font color="#000080">:</font>longint<font color="#000080">;
</font>reserved<font color="#000080">:</font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">88</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>frameheader<font color="#000080">=</font><font color="#FF0000"><b>record
</b></font>size <font color="#000080">:</font>longint<font color="#000080">;
</font>ftype<font color="#000080">:</font>word<font color="#000080">;
</font>chunks<font color="#000080">:</font>word<font color="#000080">;
</font>expand<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>chunkheader<font color="#000080">=</font><font color="#FF0000"><b>record
</b></font>size <font color="#000080">: </font>longint<font color="#000080">;
</font>id<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>buffer<font color="#000080">=</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">65535</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font>rgb<font color="#000080">=</font><font color="#FF0000"><b>record
</b></font>r<font color="#000080">,</font>g<font color="#000080">,</font>b <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>paltype<font color="#000080">=</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>rgb<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>buf<font color="#000080">:^</font>buffer<font color="#000080">;
</font>pal1<font color="#000080">:^</font>paltype<font color="#000080">;
</font>h<font color="#000080">:</font>fliheader<font color="#000080">;
</font>fh<font color="#000080">:</font>frameheader<font color="#000080">;
</font>ch<font color="#000080">:</font>chunkheader<font color="#000080">;
</font>i<font color="#000080">,</font>j <font color="#000080">: </font>word<font color="#000080">;
</font>speed <font color="#000080">: </font>word<font color="#000080">;
</font>f<font color="#000080">:</font><font color="#FF0000"><b>file</b></font><font color="#000080">;
</font>fname<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font>firstframe <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>fliplay<font color="#000080">(</font>s<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font>pauza<font color="#000080">:</font>integer<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>decodefli_black<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_color<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>setgraphmode<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>settextmode<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>waitforscreen<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_lc<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>waiting<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_brun<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_copy<font color="#000080">;
</font><font color="#FF0000"><b>implementation
function </b></font>setgraphmode<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">mov ax,0013h
int 10h
mov ah,0fh
int 10h
xor ah,ah
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>settextmode<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">mov ax,0003h
int 10h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>waitforscreen<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">mov dx,3dah
@wait1:
in al,dx
test al,8
jnz @wait1
@wait2:
in al,dx
test al,8
jnz @wait2
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>waiting<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">mov cx,speed
jcxz @</font><font color="#FF0000"><b>end
</b></font>dec cx
<font color="#000080">@</font>wait<font color="#000080">:
</font>call waitforscreen
loop <font color="#000080">@</font>wait
<font color="#000080">@</font><font color="#FF0000"><b>end</b></font><font color="#000080">:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_color<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">les ax,pal1
mov bx,es
mov dx,ax
and ax,15
mov di,ax
shr dx,4
add bx,dx
mov ax,bx
push ds
lds ax,buf
mov bx,ds
mov dx,ax
and ax,15
mov si,ax
shr dx,4
add bx,dx
mov ds,bx
cld
lodsw
mov bx,ax
test bx,bx
jmp @endu
@u:
lodsb
add di,ax
add di,ax
add di,ax
lodsb
or al,al
jnz @u2
mov ax,256
@u2:
mov cx,ax
add cx,ax
add cx,ax
rep movsb
dec bx
@endu:
jnz @u
sub di,768
mov si,di
push es
pop ds
mov cx,256
mov bl,0
@setpal:
mov dx,3c8h
mov al,bl
out dx,al
inc dx
lodsb
out dx,al
lodsb
out dx,al
lodsb
out dx,al
inc bl
loop @setpal
pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_black<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">mov cx,32000
mov ax,0a000h
mov es,ax
xor ax,ax
mov di,ax
rep stosw
call waiting
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_brun<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>linecount<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">call waitforscreen
mov linecount,200
mov ax,0a000h
mov es,ax
xor di,di
push ds
lds ax,buf
mov bx,ds
mov dx,ax
and ax,15
mov si,ax
shr dx,4
add bx,dx
mov ds,bx
cld
mov dx,di
xor ah,ah
@linelp:
mov di,dx
lodsb
mov bl,al
test bl,bl
jmp @endulcloop
@ulcloop:
lodsb
test al,al
js @ucopy
mov cx,ax
lodsb
rep stosb
dec bl
jnz @ulcloop
jmp @ulcout
@ucopy:
neg al
mov cx,ax
rep movsb
dec bl
@endulcloop:
jnz @ulcloop
@ulcout:
add dx,320
dec linecount
jnz @linelp
pop ds
call waiting
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_lc<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>linecount<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">call waitforscreen
mov ax,0a000h
mov es,ax
xor di,di
push ds
lds ax,buf
mov bx,ds
mov dx,ax
and ax,15
mov si,ax
shr dx,4
add bx,dx
mov ds,bx
cld
lodsw
mov dx,320
mul dx
add di,ax
lodsw
mov linecount,ax
mov dx,di
xor ah,ah
@linelp:
mov di,dx
lodsb
mov bl,al
test bl,bl
jmp @endulcloop
@ulcloop:
lodsb
add di,ax
lodsb
test al,al
js @ulcrun
mov cx,ax
rep movsb
dec bl
jnz @ulcloop
jmp @ulcout
@ulcrun:
neg al
mov cx,ax
lodsb
rep stosb
dec bl
@endulcloop:
jnz @ulcloop
@ulcout:
add dx,320
dec linecount
jnz @linelp
pop ds
call waiting
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>decodefli_copy<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">call waitforscreen
mov ax,0a000h
mov es,ax
xor di,di
push ds
lds ax,buf
mov bx,ds
mov dx,ax
add ax,15
mov si,ax
shr dx,4
add bx,dx
mov ds,bx
mov cx,32000
rep movsw
pop ds
call waiting
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>fliplay<font color="#000080">(</font>s<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font>pauza<font color="#000080">:</font>integer<font color="#000080">);
</font><font color="#FF0000"><b>label </b></font>daley<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>fname<font color="#000080">:=</font>s<font color="#000080">;
</font><font color="#FF0000"><b>if </b></font>fname<font color="#000080">=</font><font color="#800000">'' </font><font color="#FF0000"><b>then begin
</b></font>writeln <font color="#000080">(</font><font color="#800000">'Uzycie:fli &lt;plik[.fli]&gt;'</font><font color="#000080">);</font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>if </b></font>pos<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">,</font>fname<font color="#000080">)=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>fname<font color="#000080">:=</font>fname<font color="#000080">+</font><font color="#800000">'.fli'</font><font color="#000080">;
</font>assign <font color="#000080">(</font>f<font color="#000080">,</font>fname<font color="#000080">);
</font><font color="#008000"><i>{$I-}
</i></font>reset <font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);</font><font color="#008000"><i>{$i+}
{$I-}
</i></font>blockread <font color="#000080">(</font>f<font color="#000080">,</font>h<font color="#000080">,</font>sizeof<font color="#000080">(</font>h<font color="#000080">));</font><font color="#008000"><i>{$I+}
</i></font><font color="#FF0000"><b>if </b></font>setgraphmode<font color="#000080">&lt;&gt;</font><font color="#800000">$13 </font><font color="#FF0000"><b>then begin </b></font>writeln <font color="#000080">(</font><font color="#800000">'VGA REQUIRED'</font><font color="#000080">);</font>halt<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>new<font color="#000080">(</font>buf<font color="#000080">);</font>new<font color="#000080">(</font>pal1<font color="#000080">);
</font>speed<font color="#000080">:=</font>h<font color="#000080">.</font>speed<font color="#000080">;
</font>firstframe<font color="#000080">:=</font>filepos<font color="#000080">(</font>f<font color="#000080">);
</font><font color="#FF0000"><b>while </b></font><font color="#800000">1</font><font color="#000080">=</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>h<font color="#000080">.</font>framecount <font color="#FF0000"><b>do begin
</b></font><font color="#008000"><i>{$i-}</i></font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>fh<font color="#000080">,</font>sizeof<font color="#000080">(</font>fh<font color="#000080">));</font><font color="#008000"><i>{$i+}
</i></font><font color="#FF0000"><b>if </b></font>fh<font color="#000080">.</font>ftype<font color="#000080">&lt;&gt;</font><font color="#800000">$f1fa </font><font color="#FF0000"><b>then begin </b></font>writeln <font color="#000080">(</font><font color="#800000">'Nieznany typ animacji!'</font><font color="#000080">);
</font>close<font color="#000080">(</font>f<font color="#000080">);</font>halt<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">);</font><font color="#FF0000"><b>end</b></font><font color="#000080">;</font><font color="#FF0000"><b>if </b></font>fh<font color="#000080">.</font>chunks<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
for </b></font>j<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>fh<font color="#000080">.</font>chunks <font color="#FF0000"><b>do begin
</b></font><font color="#008000"><i>{$i-} </i></font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>ch<font color="#000080">,</font>sizeof<font color="#000080">(</font>ch<font color="#000080">));</font><font color="#008000"><i>{$i+}
{$i-} </i></font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>buf<font color="#000080">^,</font>ch<font color="#000080">.</font>size<font color="#000080">-</font>sizeof<font color="#000080">(</font>ch<font color="#000080">));</font><font color="#008000"><i>{$i+}

</i></font>delay <font color="#000080">(</font>pauza<font color="#000080">);
</font><font color="#FF0000"><b>case </b></font>ch<font color="#000080">.</font>id <font color="#FF0000"><b>of
</b></font><font color="#800000">11 </font><font color="#000080">: </font>decodefli_color<font color="#000080">;
</font><font color="#800000">12 </font><font color="#000080">: </font>decodefli_lc<font color="#000080">;
</font><font color="#800000">13 </font><font color="#000080">: </font>decodefli_black<font color="#000080">;
</font><font color="#800000">15 </font><font color="#000080">: </font>decodefli_brun<font color="#000080">;
</font><font color="#800000">16 </font><font color="#000080">: </font>decodefli_copy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end else </b></font>waiting<font color="#000080">;
</font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">]&lt;</font><font color="#800000">$80</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
</b></font>close <font color="#000080">(</font>f<font color="#000080">);
</font>dispose<font color="#000080">(</font>pal1<font color="#000080">);</font>dispose<font color="#000080">(</font>buf<font color="#000080">);
</font>settextmode<font color="#000080">;
</font>exit<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>daley<font color="#000080">:
</font>seek <font color="#000080">(</font>f<font color="#000080">,</font>firstframe<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0194.PAS">Original</a><b>]</b></p></body>
</html>
