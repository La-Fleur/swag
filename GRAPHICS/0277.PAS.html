<html>
<head><title> "Fast Phong Shading" by TOM HAMMERSLEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0277.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000"> Fast Phong Shading<font color="#000080">, </font>Theory <font color="#FF0000"><b>and </b></font>Practive
 Introduction

<font color="#000080">&lt;</font>I<font color="#000080">&gt; </font>Fast phong shading <font color="#FF0000"><b>is </b></font>always a goal <font color="#FF0000"><b>of </b></font>anyone writing a <font color="#800000">3</font>D engine<font color="#000080">.
</font>Despite some <font color="#FF0000"><b>of </b></font>its failings<font color="#000080">, </font>Phong shading <font color="#FF0000"><b>is </b></font>still common <font color="#FF0000"><b>in </b></font><font color="#800000">3</font>D systems<font color="#000080">,
</font><font color="#FF0000"><b>and </b></font>people are always looking <font color="#FF0000"><b>for </b></font>faster <font color="#FF0000"><b>and </b></font>easier ways <font color="#FF0000"><b>to </b></font>approximate it<font color="#000080">.
</font><font color="#FF0000"><b>In </b></font>this page<font color="#000080">, </font>I<font color="#800000">'ll discuss firstly &lt;I&gt; real &lt;/I&gt; phong shading, then some of
</font>the approximations <font color="#FF0000"><b>of </b></font>it<font color="#000080">. </font>I<font color="#800000">'ll also explain why the document OTMPHONG.DOC
</font><font color="#FF0000"><b>is </b></font>utter nonsense<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>should be avoided at all costs<font color="#000080">.

 </font>Real <font color="#000080">&lt;/</font>I<font color="#000080">&gt; </font>phong shading
<font color="#000080">&lt;</font>P<font color="#000080">&gt; </font>Real phong shading <font color="#FF0000"><b>is </b></font>done by interpolating the vertex normals across the
surface <font color="#FF0000"><b>of </b></font>a polygon<font color="#000080">, </font><font color="#FF0000"><b>or </b></font>triangle<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>illuminating the pixel at each point<font color="#000080">,
</font>usually using the phong lighting model<font color="#000080">. </font>At each pixel<font color="#000080">, </font>you need <font color="#FF0000"><b>to
</b></font>re<font color="#000080">-</font>normalize the normal vector<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>also calculate the reflection vector<font color="#000080">.
</font>The reflection vector <font color="#FF0000"><b>is </b></font>calculated by<font color="#000080">:

</font>R <font color="#000080">= </font><font color="#800000">2.0</font><font color="#000080">*(</font>N<font color="#000080">.</font>L<font color="#000080">)*</font>N <font color="#000080">- </font>L

I found this vector also needs <font color="#FF0000"><b>to </b></font>be normalized<font color="#000080">. </font><font color="#FF0000"><b>Then</b></font><font color="#000080">, </font>we feed these vectors
into the illumination equation <font color="#FF0000"><b>for </b></font>the phong lighting model<font color="#000080">, </font>which <font color="#FF0000"><b>is

</b></font>I <font color="#000080">= </font>Ia<font color="#000080">*</font>ka<font color="#000080">*</font>Oda <font color="#000080">+ </font>fatt<font color="#000080">*</font>Ip<font color="#000080">[</font>kd<font color="#000080">*</font>Od<font color="#000080">(</font>N<font color="#000080">.</font>L<font color="#000080">) + </font>ks<font color="#000080">(</font>R<font color="#000080">.</font>V<font color="#000080">)^</font>n<font color="#000080">]

</font>Here<font color="#000080">, </font>the variables are<font color="#000080">:
</font>Ia <font color="#FF0000"><b>is </b></font>the ambient intensity
ka <font color="#FF0000"><b>is </b></font>the ambient co<font color="#000080">-</font>efficient
Oda <font color="#FF0000"><b>is </b></font>the colour <font color="#FF0000"><b>for </b></font>the ambient
fatt <font color="#FF0000"><b>is </b></font>the atmospheric attenuation factor<font color="#000080">, </font>ie depth shading
Ip <font color="#FF0000"><b>is </b></font>the intensity <font color="#FF0000"><b>of </b></font>the point light source
kd <font color="#FF0000"><b>is </b></font>the diffuse co<font color="#000080">-</font>efficient
Od <font color="#FF0000"><b>is </b></font>the objects colour
ks <font color="#FF0000"><b>is </b></font>the specular co<font color="#000080">-</font>efficient
n <font color="#FF0000"><b>is </b></font>the objects shinyness
N <font color="#FF0000"><b>is </b></font>the normal vector
L <font color="#FF0000"><b>is </b></font>the lighting vector
R <font color="#FF0000"><b>is </b></font>the reflection vector
V <font color="#FF0000"><b>is </b></font>the viewing vector



<font color="#FF0000"><b>To do </b></font>multiple light sources<font color="#000080">, </font>you sum the term
fatt<font color="#000080">*</font>Ip<font color="#000080">[</font>kd<font color="#000080">*</font>Od<font color="#000080">(</font>N<font color="#000080">.</font>L<font color="#000080">) + </font>ks<font color="#000080">(</font>R<font color="#000080">.</font>V<font color="#000080">)^</font>n<font color="#000080">] </font><font color="#FF0000"><b>for </b></font>each light source<font color="#000080">. </font>Also<font color="#000080">,
</font>you need <font color="#FF0000"><b>to repeat </b></font>this equation <font color="#FF0000"><b>for </b></font>each colour band you are interested <font color="#FF0000"><b>in</b></font><font color="#000080">.

</font>Such shading <font color="#FF0000"><b>is </b></font>incredibly expensive<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>cannot be done <font color="#FF0000"><b>in </b></font>realtime <font color="#FF0000"><b>on
</b></font>common hardware<font color="#000080">. </font>So<font color="#000080">, </font>people have been looking into optimizations <font color="#FF0000"><b>and
</b></font>approximations <font color="#FF0000"><b>of </b></font>this <font color="#FF0000"><b>for </b></font>a long time<font color="#000080">.



</font>Angular Interpolation

One idea <font color="#FF0000"><b>is to </b></font>avoid the expensive dot<font color="#000080">-</font>product <font color="#FF0000"><b>and </b></font>normalization operations
by interpolating the angles<font color="#000080">. </font>This sounds good <font color="#FF0000"><b>in </b></font>theory<font color="#000080">, </font>but has a couple <font color="#FF0000"><b>of
</b></font>problems<font color="#000080">:

</font>Choosing a <font color="#FF0000"><b>function to do </b></font>the interpolation
Perspective problems

<font color="#FF0000"><b>In </b></font>the <font color="#FF0000"><b>file </b></font>OTMPHONG<font color="#000080">.</font>DOC<font color="#000080">, </font>the idea was <font color="#FF0000"><b>to </b></font>interpolate the angle<font color="#000080">, </font><font color="#FF0000"><b>or </b></font>cosine <font color="#FF0000"><b>of
</b></font>the angle <font color="#000080">(</font>I can<font color="#800000">'t remember which) across the surface of the polygon. This
</font>doesn<font color="#800000">'t work, because:

</font>Cosine <font color="#FF0000"><b>is NOT </b></font>linear
Using linear interpolation you cannot get a value outside <font color="#FF0000"><b>of </b></font>your start
value<font color="#000080">, </font><font color="#FF0000"><b>and end </b></font>value<font color="#000080">. </font>So no highlight <font color="#FF0000"><b>is </b></font>possible<font color="#000080">.

</font>OTMPHONG<font color="#000080">.</font>DOC just re<font color="#000080">-</font>invented Gouraud shading<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>tried <font color="#FF0000"><b>to </b></font>turn it into
Phong shading<font color="#000080">. </font>It doesn<font color="#800000">'t really work very well. Yes, I have tried it, I'</font>ve
tried a great deal <font color="#FF0000"><b>of </b></font>methods <font color="#FF0000"><b>of </b></font>implementing it<font color="#000080">, </font>but it just doesn<font color="#800000">'t work!

</font>Another way I<font color="#800000">'ve heard of is using a Taylor series approximation.
</font>Admittedly<font color="#000080">, </font>I haven<font color="#800000">'t tried this yet; from what I gather, the idea here is to
</font>use a polynomial <font color="#FF0000"><b>to </b></font>approximate the cosine<font color="#000080">. </font>People have used this <font color="#FF0000"><b>in </b></font>the past
<font color="#FF0000"><b>to </b></font>generate sin tables<font color="#000080">, </font><font color="#FF0000"><b>in </b></font><font color="#800000">4</font>k intros <font color="#FF0000"><b>and </b></font>what have you<font color="#000080">, </font>so it should be
possible<font color="#000080">. </font>Again<font color="#000080">, </font>I haven<font color="#800000">'t tried it yet, if I ever do, I'</font>ll tell you what I
find<font color="#000080">.

</font>A halfway<font color="#000080">-</font>house <font color="#FF0000"><b>is </b></font>the highlight test<font color="#000080">. </font>Here<font color="#000080">, </font>a polygon <font color="#FF0000"><b>is </b></font>tested<font color="#000080">, </font><font color="#FF0000"><b>to
</b></font>see <font color="#FF0000"><b>if </b></font>the highlight falls <font color="#FF0000"><b>on </b></font>the polygon<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>it doesn<font color="#800000">'t, then you just use
</font>plain gouraud shading<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>it does<font color="#000080">, </font>you use your phong shader<font color="#000080">. </font>The test follows<font color="#000080">:

</font><font color="#FF0000"><b>For </b></font>any vertex<font color="#000080">, </font><font color="#FF0000"><b>is </b></font>N<font color="#000080">*</font>H <font color="#000080">&gt;= </font>t <font color="#000080">(</font>threshold<font color="#000080">) ? </font><font color="#FF0000"><b>If </b></font>so<font color="#000080">, </font>highlight <font color="#000080">= </font>TRUE
<font color="#FF0000"><b>For </b></font>any edge<font color="#000080">, </font><font color="#FF0000"><b>is </b></font>N<font color="#000080">*</font>H <font color="#000080">&gt;= </font>t at any point <font color="#FF0000"><b>on </b></font>that edge<font color="#000080">? </font><font color="#FF0000"><b>If </b></font>so<font color="#000080">, </font>highlight <font color="#000080">= </font>TRUE
<font color="#FF0000"><b>For </b></font>all edge<font color="#000080">, </font>does N<font color="#000080">*</font>H exhibit a maximum<font color="#000080">? </font><font color="#FF0000"><b>If </b></font>so<font color="#000080">, </font>highlight <font color="#000080">= </font>TRUE
<font color="#FF0000"><b>If </b></font>none <font color="#FF0000"><b>of </b></font>the above conditions<font color="#000080">, </font>highlight <font color="#000080">= </font>FALSE

H <font color="#FF0000"><b>is </b></font>the halfway vector<font color="#000080">, (</font>L <font color="#000080">+ </font>V<font color="#000080">) / </font><font color="#800000">2. </font>I found this algorithmn <font color="#FF0000"><b>in </b></font>the book
<font color="#000080">&quot;</font><font color="#800000">3</font>D Computer Graphics<font color="#000080">&quot; </font>by Alan Watt<font color="#000080">. </font>I have yet <font color="#FF0000"><b>to try </b></font>this one<font color="#000080">, </font>but it
sounds workable<font color="#000080">. </font>The only problem might be slight discontinuities <font color="#FF0000"><b>in </b></font>the
shading<font color="#000080">. </font>Again<font color="#000080">, </font>this <font color="#FF0000"><b>is </b></font>guesswork<font color="#000080">, </font>you<font color="#800000">'d have to implement it to see.

</font>The Fake Method

Now I<font color="#800000">'ll describe a method that is a bit odd, yet works very well in
</font>practice<font color="#000080">. </font>Its the method most demos use <font color="#FF0000"><b>to do </b></font>their <font color="#800000">'phong' </font>shading<font color="#000080">, </font><font color="#FF0000"><b>and is
</b></font>very fast<font color="#000080">.

</font>First<font color="#000080">, </font>we need <font color="#FF0000"><b>to </b></font>generate a <font color="#800000">'highlight map'</font><font color="#000080">. </font>This <font color="#FF0000"><b>is </b></font>a texture<font color="#000080">, </font>which
consists <font color="#FF0000"><b>of </b></font>concentric circles<font color="#000080">, </font>the brightest <font color="#FF0000"><b>in </b></font>the middle<font color="#000080">, </font>decreasing <font color="#FF0000"><b>in
</b></font>brightness <font color="#FF0000"><b>as </b></font>they go outwards<font color="#000080">. </font>So it looks like a highlight<font color="#000080">. </font>This <font color="#FF0000"><b>is </b></font>easy
enough <font color="#FF0000"><b>to </b></font>generate<font color="#000080">, </font>a simple way being <font color="#FF0000"><b>to </b></font>take the distance from the centre<font color="#000080">,
</font><font color="#FF0000"><b>and </b></font>get it into the range <font color="#800000">0</font><font color="#000080">..</font><font color="#800000">256. </font>Also<font color="#000080">, </font>this map should be <font color="#800000">256</font>x256<font color="#000080">, </font><font color="#FF0000"><b>for
</b></font>efficiency reasons<font color="#000080">.

</font>Now we need <font color="#FF0000"><b>to </b></font>map the highlight onto the <font color="#FF0000"><b>object</b></font><font color="#000080">. </font>Again<font color="#000080">, </font>this <font color="#FF0000"><b>is </b></font>easy <font color="#FF0000"><b>to do</b></font><font color="#000080">.
</font>Take your vertex normal X value<font color="#000080">, </font>multiply it by <font color="#800000">128</font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>add <font color="#800000">127 </font><font color="#FF0000"><b>to </b></font>it<font color="#000080">. </font><font color="#FF0000"><b>Do
</b></font>the same <font color="#FF0000"><b>for </b></font>Y<font color="#000080">. </font>Call these values P<font color="#000080">, </font>Q <font color="#000080">(</font>save confusion <font color="#FF0000"><b>with </b></font>U<font color="#000080">,</font>V <font color="#000080">- </font>texture
co<font color="#000080">-</font>ords<font color="#000080">). </font>These are our texture co<font color="#000080">-</font>ordinates<font color="#000080">! </font>Now simply map the texture <font color="#FF0000"><b>to
</b></font>the <font color="#FF0000"><b>object</b></font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>hey presto<font color="#000080">, </font>one nicely shaded <font color="#FF0000"><b>object</b></font><font color="#000080">. </font><font color="#FF0000"><b>As </b></font>you rotate the
<font color="#FF0000"><b>object</b></font><font color="#000080">, </font>the highlights will also move<font color="#000080">. </font>Its a very handy algorithmn I think<font color="#000080">,
</font><font color="#FF0000"><b>if </b></font>a little odd<font color="#000080">. </font>Its based <font color="#FF0000"><b>on </b></font>a trick called environment mapping<font color="#000080">, </font>which you
will find described elsewhere <font color="#FF0000"><b>in </b></font>these pages<font color="#000080">. </font>You<font color="#800000">'ll also notice that if you
</font>go behind your <font color="#FF0000"><b>object</b></font><font color="#000080">, </font>the lighting <font color="#FF0000"><b>is </b></font>the same<font color="#000080">. </font>Another problem <font color="#FF0000"><b>with </b></font>the
algorithm<font color="#000080">. </font>Take <font color="#FF0000"><b>is </b></font>an extra light source <font color="#FF0000"><b>for </b></font>free<font color="#000080">. </font>Also<font color="#000080">, </font><font color="#FF0000"><b>as </b></font>this method <font color="#FF0000"><b>is
</b></font>based <font color="#FF0000"><b>on </b></font>environment mapping<font color="#000080">, </font>its only correct <font color="#FF0000"><b>for </b></font>parallel projection<font color="#000080">.
</font>But don<font color="#800000">'t let that spoil your fun!

</font>Extending this <font color="#FF0000"><b>to </b></font>multiple light sources shouldn<font color="#800000">'t be too hard. For 2 light
</font>sources<font color="#000080">, </font>you would have <font color="#800000">2 </font>maps<font color="#000080">, </font>each having values <font color="#FF0000"><b>in </b></font>the range <font color="#800000">0</font><font color="#000080">..</font><font color="#800000">128. </font>You
would <font color="#FF0000"><b>then </b></font>add them together<font color="#000080">, </font><font color="#FF0000"><b>to </b></font>get a colour value<font color="#000080">. </font>Moving the light source
around involves changing the P <font color="#FF0000"><b>and </b></font>Q values<font color="#000080">; </font>using the normals sort <font color="#FF0000"><b>of </b></font>works<font color="#000080">,
</font>but after about <font color="#800000">90 </font>degrees<font color="#000080">, </font>weird things start <font color="#FF0000"><b>to </b></font>happen<font color="#000080">.

</font>Also one other thought<font color="#000080">. </font>The phong map <font color="#FF0000"><b>is </b></font>basically a bunch <font color="#FF0000"><b>of
</b></font>circles<font color="#000080">:

</font>So<font color="#000080">, </font>it <font color="#FF0000"><b>is </b></font>symmetrical about the centre<font color="#000080">. </font>Why <font color="#FF0000"><b>not </b></font>just use one quadrant
<font color="#FF0000"><b>of </b></font>the map<font color="#000080">, </font><font color="#FF0000"><b>then </b></font>use sign <font color="#FF0000"><b>and </b></font>quadrant information <font color="#FF0000"><b>to </b></font>convert the u<font color="#000080">,</font>v
co<font color="#000080">-</font>ordinates<font color="#000080">? </font>Would say some memory<font color="#000080">... </font>Like so<font color="#000080">:

</font>Well<font color="#000080">, </font>I hope I helped <font color="#FF0000"><b>to </b></font>demistify Phong shading<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>disprove some <font color="#FF0000"><b>of </b></font>the
myths surrounding the subject<font color="#000080">. </font>So please<font color="#000080">, </font>don<font color="#800000">'t come onto #coders, asking
</font>how <font color="#FF0000"><b>to </b></font>implement phong shading<font color="#000080">, </font><font color="#FF0000"><b>or </b></font>asking about that gibberish otmphong<font color="#000080">.</font>doc
<font color="#FF0000"><b>file</b></font><font color="#000080">, </font>you have all the information you need right here<font color="#000080">.

</font>Tom Hammersley<font color="#000080">, &lt;</font>A HREF<font color="#000080">=&quot;</font>mailto<font color="#000080">:</font>tomh<font color="#000080">@</font>globalnet<font color="#000080">.</font>co<font color="#000080">.</font>uk<font color="#000080">&quot;&gt; </font>tomh<font color="#000080">@</font>globalnet<font color="#000080">.</font>co<font color="#000080">.</font>uk<font color="#000080">&lt;/</font>A<font color="#000080">&gt;

</font>Please don<font color="#800000">'t call the fake phong shading method phong shading. It gets
</font>us all confused<font color="#000080">. </font>Can someone please think up a good name <font color="#FF0000"><b>for </b></font>that method<font color="#000080">,
</font><font color="#FF0000"><b>and </b></font>use that instead<font color="#000080">? </font>After all<font color="#000080">, </font>fools gold <font color="#FF0000"><b>is not </b></font>gold<font color="#000080">, </font>no matter how much
it glitters




</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0277.PAS">Original</a><b>]</b></p></body>
</html>
