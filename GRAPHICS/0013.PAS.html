<html>
<head><title> "Bit Map scaler" by SEAN PALMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
SEAN PALMER

Well, I got a wild hair up my butt and decided to convert that
bitmap scaler I posted into an inline assembler procedure (mostly)
It's now quite a bit faster...

by Sean Palmer
public domain
}

{bitmaps are limited to 256x256 (duh)}

</i></font><font color="#FF0000"><b>type
  </b></font>fixed <font color="#000080">= </font><font color="#FF0000"><b>record
    case </b></font>boolean <font color="#FF0000"><b>of
      </b></font>true  <font color="#000080">: (</font>w <font color="#000080">: </font>longint<font color="#000080">);
      </font>false <font color="#000080">: (</font>f<font color="#000080">, </font>i <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>bmp <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte <font color="#000080">=
    ((</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">),
     (</font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">4</font><font color="#000080">),
     (</font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">5</font><font color="#000080">),
     (</font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">5</font><font color="#000080">, </font><font color="#800000">6</font><font color="#000080">));
</font><font color="#FF0000"><b>var
  </b></font>bmp2 <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>i<font color="#000080">, </font>j <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>scaleBitmap<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>bitmap<font color="#000080">; </font>x<font color="#000080">, </font>y <font color="#000080">: </font>byte<font color="#000080">; </font>x1<font color="#000080">, </font>y1<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>s<font color="#000080">, </font>w<font color="#000080">, </font>h    <font color="#000080">: </font>word<font color="#000080">;  </font><font color="#008000"><i>{xSkip,width,height}
  </i></font>sx<font color="#000080">, </font>sy<font color="#000080">, </font>cy <font color="#000080">: </font>fixed<font color="#000080">; </font><font color="#008000"><i>{xinc, yinc, ySrcPos}
</i></font><font color="#FF0000"><b>begin
  </b></font>w    <font color="#000080">:= </font>x2 <font color="#000080">- </font>x1 <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>h    <font color="#000080">:= </font>y2 <font color="#000080">- </font>y1 <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>sx<font color="#000080">.</font>w <font color="#000080">:= </font>x <font color="#000080">* </font><font color="#800000">$10000 </font><font color="#FF0000"><b>div </b></font>w<font color="#000080">;
  </font>sy<font color="#000080">.</font>w <font color="#000080">:= </font>y <font color="#000080">* </font><font color="#800000">$10000 </font><font color="#FF0000"><b>div </b></font>h<font color="#000080">;
  </font>s    <font color="#000080">:= </font><font color="#800000">320</font><font color="#000080">-</font>w<font color="#000080">;
  </font>cy<font color="#000080">.</font>w <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push ds
    mov  ds, word ptr bitmap+2;
    mov  ax, $A000
    mov  es, ax  </font><font color="#008000"><i>{setup screen seg}
    </i></font><font color="#FF00FF">cld
    mov  ax, 320
    mul  y1
    add  ax, x1
    mov  di, ax </font><font color="#008000"><i>{calc screen adr}
   </i></font><font color="#FF00FF">@L2:
    mov  ax, cy.i
    mul  x
    mov  bx, ax
    add  bx, word ptr bitmap </font><font color="#008000"><i>{offset}
    </i></font><font color="#FF00FF">mov  cx, w
    mov  si, 0     </font><font color="#008000"><i>{fraction of src adr (bx.si)}
    </i></font><font color="#FF00FF">mov  dx, sx.f
   @L:
    mov  al, [bx]
    stosb
    add  si, dx
    adc  bx, sx.i    </font><font color="#008000"><i>{if carry or sx.i&lt;&gt;0, new source pixel}
    </i></font><font color="#FF00FF">loop @L
    add  di, s     </font><font color="#008000"><i>{skip to next screen row}
    </i></font><font color="#FF00FF">mov  ax, sy.f
    mov  bx, sy.i
    add  cy.f, ax
    adc  cy.i, bx
    dec  word ptr h
    jnz  @L2
    pop  ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">63 </font><font color="#FF0000"><b>do   </b></font><font color="#008000"><i>{init bmp2}
    </i></font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">63 </font><font color="#FF0000"><b>do
      </b></font>bmp2<font color="#000080">[</font>j<font color="#000080">, </font>i<font color="#000080">] := </font>j <font color="#000080">+ (</font>i <font color="#FF0000"><b>xor </b></font><font color="#800000">$19</font><font color="#000080">) + </font><font color="#800000">32</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax, $13
    int $10
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{init vga mode 13h}
  </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">2 </font><font color="#FF0000"><b>to </b></font><font color="#800000">99 </font><font color="#FF0000"><b>do                 </b></font><font color="#008000"><i>{test bmp}
    </i></font>scaleBitMap<font color="#000080">(</font>bmp<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>i <font color="#000080">* </font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">1</font><font color="#000080">, </font>i <font color="#000080">* </font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">99 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">2 </font><font color="#FF0000"><b>do
    </b></font>scaleBitMap<font color="#000080">(</font>bmp<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>i <font color="#000080">* </font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">197</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">66 </font><font color="#FF0000"><b>do                 </b></font><font color="#008000"><i>{test bmp2}
    </i></font>scaleBitMap<font color="#000080">(</font>bmp2<font color="#000080">, </font><font color="#800000">64</font><font color="#000080">, </font><font color="#800000">64</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>i <font color="#000080">* </font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">1</font><font color="#000080">, </font>i <font color="#000080">* </font><font color="#800000">3 </font><font color="#000080">- </font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">66 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do
    </b></font>scaleBitMap<font color="#000080">(</font>bmp2<font color="#000080">, </font><font color="#800000">64</font><font color="#000080">, </font><font color="#800000">64</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>i <font color="#000080">* </font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">1</font><font color="#000080">, </font>i <font color="#000080">* </font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">1 </font><font color="#000080">+ </font><font color="#800000">66</font><font color="#000080">);
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax, $3
    int $10
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;      </font><font color="#008000"><i>{restore text mode}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p></body>
</html>
