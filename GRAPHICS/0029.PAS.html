<html>
<head><title> "TWEAKED! Graph unit" by SEAN PALMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0029.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$A-,B-,D+,E-,F-,G+,I-,L+,N-,O-,R-,S-,V-,X+} {TP 6.0 &amp; 286 required!}
</i></font><font color="#FF0000"><b>Unit </b></font>x320x240<font color="#000080">;

</font><font color="#008000"><i>{
 Sean Palmer, 1993
 released to the Public Domain
 in tweaked modes, each latch/bit plane contains the entire 8-bit pixel.
 the sequencer map mask determines which plane (pixel) to update, and, when
 reading, the read map select reg determines which plane (pixel) to read.
 almost exactly opposite from regular vga 16-color modes which is why I never
 could get my routines to work For BOTH modes. 8)

  # = source screen pixel
  Normal 16-color         Tweaked 256-color

      Bit Mask                Bit Mask
      76543210                33333333
 Map  76543210           Map  22222222
 Mask 76543210           Mask 11111111
      76543210                00000000

  Functional equivalents
      Bit Mask        =       Seq Map Mask
      Seq Map Mask    =       Bit Mask
}


</i></font><font color="#FF0000"><b>Interface

Var
  </b></font>color <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Const
 </b></font>xRes    <font color="#000080">= </font><font color="#800000">320</font><font color="#000080">;
 </font>yRes    <font color="#000080">= </font><font color="#800000">240</font><font color="#000080">;   </font><font color="#008000"><i>{displayed screen size}
 </i></font>xMax    <font color="#000080">= </font>xRes <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
 </font>yMax    <font color="#000080">= </font>yRes <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
 </font>xMid    <font color="#000080">= </font>xMax <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
 </font>yMid    <font color="#000080">= </font>yMax <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
 </font>vxRes   <font color="#000080">= </font><font color="#800000">512</font><font color="#000080">;
 </font>vyRes   <font color="#000080">= </font><font color="#800000">$40000 </font><font color="#FF0000"><b>div </b></font>vxRes<font color="#000080">; </font><font color="#008000"><i>{virtual screen size}
 </i></font>nColors <font color="#000080">= </font><font color="#800000">256</font><font color="#000080">;
 </font>tsx <font color="#000080">: </font>Byte <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;
 </font>tsy <font color="#000080">: </font>Byte <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;  </font><font color="#008000"><i>{tile size}


</i></font><font color="#FF0000"><b>Procedure </b></font>plot<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>scrn<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">) : </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>hLin<font color="#000080">(</font>x<font color="#000080">, </font>x2<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>vLin<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>y2 <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>rect<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>pane<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>Integer<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>line<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>oval<font color="#000080">(</font>xc<font color="#000080">, </font>yc<font color="#000080">, </font>a<font color="#000080">, </font>b <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>disk<font color="#000080">(</font>xc<font color="#000080">, </font>yc<font color="#000080">, </font>a<font color="#000080">, </font>b <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>fill<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>putTile<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">; </font>p <font color="#000080">: </font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>overTile<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">; </font>p <font color="#000080">: </font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>putChar<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">; </font>p <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>setColor<font color="#000080">(</font>color<font color="#000080">, </font>r<font color="#000080">, </font>g<font color="#000080">, </font>b <font color="#000080">: </font>Byte<font color="#000080">);
</font><font color="#008000"><i>{rgb vals are from 0-63}
</i></font><font color="#FF0000"><b>Function  </b></font>getColor<font color="#000080">(</font>color <font color="#000080">: </font>Byte<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#008000"><i>{returns $00rrggbb format}
</i></font><font color="#FF0000"><b>Procedure </b></font>setPalette<font color="#000080">(</font>color <font color="#000080">: </font>Byte<font color="#000080">; </font>num <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>rgb<font color="#000080">);
</font><font color="#008000"><i>{rgb is list of 3-Byte rgb vals}
</i></font><font color="#FF0000"><b>Procedure </b></font>getPalette<font color="#000080">(</font>color <font color="#000080">: </font>Byte<font color="#000080">; </font>num <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>rgb<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>clearGraph<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>setWriteMode<font color="#000080">(</font>f <font color="#000080">: </font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>waitRetrace<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>setWindow<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">);

</font><font color="#008000"><i>{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}

</i></font><font color="#FF0000"><b>Implementation

Const
  </b></font>vSeg     <font color="#000080">= </font><font color="#800000">$A000</font><font color="#000080">;        </font><font color="#008000"><i>{video segment}
  </i></font>vxBytes  <font color="#000080">= </font>vxRes <font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">;  </font><font color="#008000"><i>{Bytes per virtual scan line}
  </i></font>seqPort  <font color="#000080">= </font><font color="#800000">$3C4</font><font color="#000080">;   </font><font color="#008000"><i>{Sequencer}
  </i></font>gcPort   <font color="#000080">= </font><font color="#800000">$3CE</font><font color="#000080">;    </font><font color="#008000"><i>{Graphics Controller}
  </i></font>attrPort <font color="#000080">= </font><font color="#800000">$3C0</font><font color="#000080">;   </font><font color="#008000"><i>{attribute Controller}

  </i></font>tableReadIndex    <font color="#000080">= </font><font color="#800000">$3C7</font><font color="#000080">;
  </font>tableWriteIndex   <font color="#000080">= </font><font color="#800000">$3C8</font><font color="#000080">;
  </font>tableDataRegister <font color="#000080">= </font><font color="#800000">$3C9</font><font color="#000080">;

  </font>CrtcRegLen   <font color="#000080">= </font><font color="#800000">10</font><font color="#000080">;
  </font>CrtcRegTable <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>CrtcRegLen<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Word <font color="#000080">=
    (</font><font color="#800000">$0D06</font><font color="#000080">, </font><font color="#800000">$3E07</font><font color="#000080">, </font><font color="#800000">$4109</font><font color="#000080">, </font><font color="#800000">$EA10</font><font color="#000080">, </font><font color="#800000">$AC11</font><font color="#000080">, </font><font color="#800000">$DF12</font><font color="#000080">, </font><font color="#800000">$0014</font><font color="#000080">, </font><font color="#800000">$E715</font><font color="#000080">, </font><font color="#800000">$0616</font><font color="#000080">, </font><font color="#800000">$E317</font><font color="#000080">);



</font><font color="#FF0000"><b>Var
  </b></font>CrtcPort   <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Crt controller}
  </i></font>oldMode    <font color="#000080">: </font>Byte<font color="#000080">;
  </font>ExitSave   <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>input1Port <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Crtc Input Status Reg #1=CrtcPort+6}
  </i></font>fillVal    <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Type
 </b></font>tRGB <font color="#000080">= </font><font color="#FF0000"><b>Record
   </b></font>r<font color="#000080">, </font>g<font color="#000080">, </font>b <font color="#000080">: </font>Byte<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}

</i></font><font color="#FF0000"><b>Procedure </b></font>clearGraph<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov ax, vSeg
  mov es, ax
  mov dx, seqPort
  mov ax, $0F02
  out dx, ax </font><font color="#008000"><i>{enable whole map mask}
  </i></font><font color="#FF00FF">xor di, di
  mov cx, $8000 </font><font color="#008000"><i>{screen size in Words}
  </i></font><font color="#FF00FF">cld
  mov al, color
  mov ah, al
  repz stosw </font><font color="#008000"><i>{clear screen}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>setWriteMode<font color="#000080">(</font>f <font color="#000080">: </font>Byte<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm </b></font><font color="#008000"><i>{copy/and/or/xor modes}
  </i></font><font color="#FF00FF">mov ah, f
  shl ah, 3
  mov al, 3
  mov dx, gcPort
  out dx, ax </font><font color="#008000"><i>{Function select reg}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>waitRetrace<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov  dx, CrtcPort
  add  dx, 6 </font><font color="#008000"><i>{find Crt status reg (input port #1)}
 </i></font><font color="#FF00FF">@L1:
  in   al, dx
  test al, 8
  jnz  @L1;  </font><font color="#008000"><i>{wait For no v retrace}
 </i></font><font color="#FF00FF">@L2:
  in   al, dx
  test al, 8
  jz   @L2 </font><font color="#008000"><i>{wait For v retrace}
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{
 Since a virtual screen can be larger than the actual screen, scrolling is
 possible.  This routine sets the upper left corner of the screen to the
 specified pixel. Make sure 0 &lt;= x &lt;= vxRes - xRes, 0 &lt;= y &lt;= vyRes - yRes
}
</i></font><font color="#FF0000"><b>Procedure </b></font>setWindow<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov  ax, vxBytes
  mul  y
  mov  bx, x
  mov  cl, bl
  shr  bx, 2
  add  bx, ax     </font><font color="#008000"><i>{bx=Ofs of upper left corner}
  </i></font><font color="#FF00FF">mov  dx, input1Port
 @L:
  in   al, dx
  test al, 8
  jnz  @L  </font><font color="#008000"><i>{wait For no v retrace}
  </i></font><font color="#FF00FF">sub  dx, 6  </font><font color="#008000"><i>{CrtC port}
  </i></font><font color="#FF00FF">mov  al, $D
  mov  ah, bl
  cli </font><font color="#008000"><i>{these values are sampled at start of retrace}
  </i></font><font color="#FF00FF">out  dx, ax  </font><font color="#008000"><i>{lo Byte of display start addr}
  </i></font><font color="#FF00FF">dec  al
  mov  ah, bh
  out  dx, ax    </font><font color="#008000"><i>{hi Byte}
  </i></font><font color="#FF00FF">sti
  add  dx, 6
 @L2:
  in   al, dx
  test al, 8
  jz   @L2  </font><font color="#008000"><i>{wait For v retrace}
  {this also resets Attrib flip/flop}
  </i></font><font color="#FF00FF">mov  dx, attrPort
  mov  al, $33
  out  dx, al   </font><font color="#008000"><i>{Select Pixel Pan Register}
  </i></font><font color="#FF00FF">and  cl, 3
  mov  al, cl
  shl  al, 1
  out  dx, al   </font><font color="#008000"><i>{Shift is For 256 Color Mode}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}

</i></font><font color="#FF0000"><b>Procedure </b></font>plot<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov   ax, vSeg
  mov   es, ax
  mov   di, x
  mov   cx, di
  shr   di, 2
  mov   ax, vxBytes
  mul   y
  add   di, ax
  mov   ax, $0102
  and   cl, 3
  shl   ah, cl
  mov   dx, seqPort
  out   dx, ax </font><font color="#008000"><i>{set bit mask}
  </i></font><font color="#FF00FF">mov   al, color
  stosb
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>scrn<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">) : </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov ax, vSeg
  mov es, ax
  mov di, x
  mov cx, di
  shr di, 2
  mov ax, vxBytes
  mul y
  add di, ax
  and cl, 3
  mov ah, cl
  mov al, 4
  mov dx, gcPort
  out dx, ax      </font><font color="#008000"><i>{Read Map Select register}
  </i></font><font color="#FF00FF">mov al, es:[di]  </font><font color="#008000"><i>{get the whole plane}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>hLin<font color="#000080">(</font>x<font color="#000080">, </font>x2<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov   ax, vSeg
  mov   es, ax
  cld
  mov   ax, vxBytes
  mul   y
  mov   di, ax </font><font color="#008000"><i>{base of scan line}
  </i></font><font color="#FF00FF">mov   bx, x
  mov   cl, bl
  shr   bx, 2
  mov   dx, x2
  mov   ch, dl
  shr   dx, 2
  and   cx, $0303
  sub   dx, bx     </font><font color="#008000"><i>{width in Bytes}
  </i></font><font color="#FF00FF">add   di, bx     </font><font color="#008000"><i>{offset into video buffer}
  </i></font><font color="#FF00FF">mov   ax, $FF02
  shl   ah, cl
  and   ah, $0F </font><font color="#008000"><i>{left edge mask}
  </i></font><font color="#FF00FF">mov   cl, ch
  mov   bh, $F1
  rol   bh, cl
  and   bh, $0F </font><font color="#008000"><i>{right edge mask}
  </i></font><font color="#FF00FF">mov   cx, dx
  or    cx, cx
  jnz   @LEFT
  and   ah, bh                  </font><font color="#008000"><i>{combine left &amp; right bitmasks}
 </i></font><font color="#FF00FF">@LEFT:
  mov   dx, seqPort
  out   dx, ax
  inc   dx
  mov   al, color
  stosb
  jcxz  @EXIT
  dec   cx
  jcxz  @RIGHT
  mov   al, $0F
  out   dx, al     </font><font color="#008000"><i>{skipped if cx=0,1}
  </i></font><font color="#FF00FF">mov   al, color
  repz  stosb   </font><font color="#008000"><i>{fill middle Bytes}
 </i></font><font color="#FF00FF">@RIGHT:
  mov   al, bh
  out   dx, al       </font><font color="#008000"><i>{skipped if cx=0}
  </i></font><font color="#FF00FF">mov   al, color
  stosb
 @EXIT:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>vLin<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>y2 <font color="#000080">: </font>Integer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov ax, vSeg
  mov es, ax
  cld
  mov di, x
  mov cx, di
  shr di, 2
  mov ax, vxBytes
  mul y
  add di, ax
  mov ax, $102
  and cl, 3
  shl ah, cl
  mov dx, seqPort
  out dx, ax
  mov cx, y2
  sub cx, y
  inc cx
  mov al, color
 @DOLINE:
  mov bl, es:[di]
  stosb
  add di, vxBytes-1
  loop @DOLINE
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>rect<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>i <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>hlin<font color="#000080">(</font>x<font color="#000080">, </font>pred<font color="#000080">(</font>x2<font color="#000080">), </font>y<font color="#000080">);
  </font>hlin<font color="#000080">(</font>succ<font color="#000080">(</font>x<font color="#000080">), </font>x2<font color="#000080">, </font>y2<font color="#000080">);
  </font>vlin<font color="#000080">(</font>x<font color="#000080">, </font>succ<font color="#000080">(</font>y<font color="#000080">), </font>y2<font color="#000080">);
  </font>vlin<font color="#000080">(</font>x2<font color="#000080">, </font>y<font color="#000080">, </font>pred<font color="#000080">(</font>y2<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>pane<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>i <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  For </b></font>i <font color="#000080">:= </font>y2 <font color="#FF0000"><b>downto </b></font>y <font color="#FF0000"><b>do
    </b></font>hlin<font color="#000080">(</font>x<font color="#000080">, </font>x2<font color="#000080">, </font>i<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>line<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>x2<font color="#000080">, </font>y2<font color="#000080">:</font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>d<font color="#000080">, </font>dx<font color="#000080">, </font>dy<font color="#000080">,
  </font>ai<font color="#000080">, </font>bi<font color="#000080">, </font>xi<font color="#000080">, </font>yi <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if</b></font><font color="#000080">(</font>x <font color="#000080">&lt; </font>x2<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>xi <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font>dx <font color="#000080">:= </font>x2 <font color="#000080">- </font>x<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else
  begin
    </b></font>xi <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
    </font>dx <font color="#000080">:= </font>x <font color="#000080">- </font>x2<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>y <font color="#000080">&lt; </font>y2<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>yi <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font>dy <font color="#000080">:= </font>y2 <font color="#000080">- </font>y<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else
  begin
    </b></font>yi <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
    </font>dy <font color="#000080">:= </font>y <font color="#000080">- </font>y2<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>plot<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>dx <font color="#000080">&gt; </font>dy <font color="#FF0000"><b>then
  begin
    </b></font>ai <font color="#000080">:= (</font>dy <font color="#000080">- </font>dx<font color="#000080">) * </font><font color="#800000">2</font><font color="#000080">;
    </font>bi <font color="#000080">:= </font>dy <font color="#000080">* </font><font color="#800000">2</font><font color="#000080">;
    </font>d  <font color="#000080">:= </font>bi <font color="#000080">- </font>dx<font color="#000080">;
    </font><font color="#FF0000"><b>Repeat
      if </b></font><font color="#000080">(</font>d <font color="#000080">&gt;= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>inc<font color="#000080">(</font>y<font color="#000080">, </font>yi<font color="#000080">);
        </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>ai<font color="#000080">);
      </font><font color="#FF0000"><b>end
      else
        </b></font>inc<font color="#000080">(</font>d<font color="#000080">, </font>bi<font color="#000080">);
      </font>inc<font color="#000080">(</font>x<font color="#000080">, </font>xi<font color="#000080">);
      </font>plot<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">);
    </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>x <font color="#000080">= </font>x2<font color="#000080">);
  </font><font color="#FF0000"><b>end
  else
  begin
    </b></font>ai <font color="#000080">:= (</font>dx <font color="#000080">- </font>dy<font color="#000080">) * </font><font color="#800000">2</font><font color="#000080">;
    </font>bi <font color="#000080">:= </font>dx <font color="#000080">* </font><font color="#800000">2</font><font color="#000080">;
    </font>d  <font color="#000080">:= </font>bi <font color="#000080">- </font>dy<font color="#000080">;
    </font><font color="#FF0000"><b>Repeat
      if </b></font><font color="#000080">(</font>d <font color="#000080">&gt;= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>inc<font color="#000080">(</font>x<font color="#000080">, </font>xi<font color="#000080">);
        </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>ai<font color="#000080">);
      </font><font color="#FF0000"><b>end
      else
        </b></font>inc<font color="#000080">(</font>d<font color="#000080">, </font>bi<font color="#000080">);
      </font>inc<font color="#000080">(</font>y<font color="#000080">, </font>yi<font color="#000080">);
      </font>plot<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">);
    </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>y <font color="#000080">= </font>y2<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>oval<font color="#000080">(</font>xc<font color="#000080">, </font>yc<font color="#000080">, </font>a<font color="#000080">, </font>b <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>x<font color="#000080">, </font>y      <font color="#000080">: </font>Integer<font color="#000080">;
  </font>aa<font color="#000080">, </font>aa2<font color="#000080">,
  </font>bb<font color="#000080">, </font>bb2<font color="#000080">,
  </font>d<font color="#000080">, </font>dx<font color="#000080">, </font>dy <font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>x <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>y <font color="#000080">:= </font>b<font color="#000080">;
  </font>aa <font color="#000080">:= </font>LongInt<font color="#000080">(</font>a<font color="#000080">) * </font>a<font color="#000080">;
  </font>aa2 <font color="#000080">:= </font><font color="#800000">2 </font><font color="#000080">* </font>aa<font color="#000080">;
  </font>bb <font color="#000080">:= </font>LongInt<font color="#000080">(</font>b<font color="#000080">) * </font>b<font color="#000080">;
  </font>bb2 <font color="#000080">:= </font><font color="#800000">2 </font><font color="#000080">* </font>bb<font color="#000080">;
  </font>d <font color="#000080">:= </font>bb <font color="#000080">- </font>aa <font color="#000080">* </font>b <font color="#000080">+ </font>aa <font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">;
  </font>dx <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>dy <font color="#000080">:= </font>aa2 <font color="#000080">* </font>b<font color="#000080">;
  </font>plot<font color="#000080">(</font>xc<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">);
  </font>plot<font color="#000080">(</font>xc<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
  </font>plot<font color="#000080">(</font>xc <font color="#000080">- </font>a<font color="#000080">, </font>yc<font color="#000080">);
  </font>plot<font color="#000080">(</font>xc <font color="#000080">+ </font>a<font color="#000080">, </font>yc<font color="#000080">);
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>dx <font color="#000080">&lt; </font>dy<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    if</b></font><font color="#000080">(</font>d <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>dec<font color="#000080">(</font>y<font color="#000080">);
      </font>dec<font color="#000080">(</font>dy<font color="#000080">, </font>aa2<font color="#000080">);
      </font>dec<font color="#000080">(</font>d<font color="#000080">, </font>dy<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>inc<font color="#000080">(</font>x<font color="#000080">);
    </font>inc<font color="#000080">(</font>dx<font color="#000080">, </font>bb2<font color="#000080">);
    </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>bb <font color="#000080">+ </font>dx<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">+ </font>x<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">- </font>x<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">+ </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">- </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>inc<font color="#000080">(</font>d<font color="#000080">, (</font><font color="#800000">3 </font><font color="#000080">* (</font>aa <font color="#000080">- </font>bb<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2 </font><font color="#000080">- (</font>dx <font color="#000080">+ </font>dy<font color="#000080">)) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">);

  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>y <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    if </b></font><font color="#000080">(</font>d <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>inc<font color="#000080">(</font>x<font color="#000080">);
      </font>inc<font color="#000080">(</font>dx<font color="#000080">, </font>bb2<font color="#000080">);
      </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>bb <font color="#000080">+ </font>dx<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>dec<font color="#000080">(</font>y<font color="#000080">);
    </font>dec<font color="#000080">(</font>dy<font color="#000080">, </font>aa2<font color="#000080">);
    </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>aa <font color="#000080">- </font>dy<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">+ </font>x<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">- </font>x<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">+ </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">);
    </font>plot<font color="#000080">(</font>xc <font color="#000080">- </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>disk<font color="#000080">(</font>xc<font color="#000080">, </font>yc<font color="#000080">, </font>a<font color="#000080">, </font>b<font color="#000080">:</font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>x<font color="#000080">, </font>y      <font color="#000080">: </font>Integer<font color="#000080">;
  </font>aa<font color="#000080">, </font>aa2<font color="#000080">,
  </font>bb<font color="#000080">, </font>bb2<font color="#000080">,
  </font>d<font color="#000080">, </font>dx<font color="#000080">, </font>dy <font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>x   <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>y   <font color="#000080">:= </font>b<font color="#000080">;
  </font>aa  <font color="#000080">:= </font>LongInt<font color="#000080">(</font>a<font color="#000080">) * </font>a<font color="#000080">;
  </font>aa2 <font color="#000080">:= </font><font color="#800000">2 </font><font color="#000080">* </font>aa<font color="#000080">;
  </font>bb  <font color="#000080">:= </font>LongInt<font color="#000080">(</font>b<font color="#000080">) * </font>b<font color="#000080">;
  </font>bb2 <font color="#000080">:= </font><font color="#800000">2 </font><font color="#000080">* </font>bb<font color="#000080">;
  </font>d   <font color="#000080">:= </font>bb <font color="#000080">- </font>aa <font color="#000080">* </font>b <font color="#000080">+ </font>aa <font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">;
  </font>dx  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>dy  <font color="#000080">:= </font>aa2 <font color="#000080">* </font>b<font color="#000080">;

  </font>vLin<font color="#000080">(</font>xc<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);

  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>dx <font color="#000080">&lt; </font>dy<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    if </b></font><font color="#000080">(</font>d <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>dec<font color="#000080">(</font>y<font color="#000080">);
      </font>dec<font color="#000080">(</font>dy<font color="#000080">, </font>aa2<font color="#000080">);
      </font>dec<font color="#000080">(</font>d<font color="#000080">, </font>dy<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>inc<font color="#000080">(</font>x<font color="#000080">);
    </font>inc<font color="#000080">(</font>dx<font color="#000080">, </font>bb2<font color="#000080">);
    </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>bb <font color="#000080">+ </font>dx<font color="#000080">);
    </font>vLin<font color="#000080">(</font>xc <font color="#000080">- </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
    </font>vLin<font color="#000080">(</font>xc <font color="#000080">+ </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>inc<font color="#000080">(</font>d<font color="#000080">, (</font><font color="#800000">3 </font><font color="#000080">* (</font>aa <font color="#000080">- </font>bb<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2 </font><font color="#000080">- (</font>dx <font color="#000080">+ </font>dy<font color="#000080">)) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">);

  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>y <font color="#000080">&gt;= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    if </b></font><font color="#000080">(</font>d <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>inc<font color="#000080">(</font>x<font color="#000080">);
      </font>inc<font color="#000080">(</font>dx<font color="#000080">, </font>bb2<font color="#000080">);
      </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>bb <font color="#000080">+ </font>dx<font color="#000080">);
      </font>vLin<font color="#000080">(</font>xc <font color="#000080">- </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
      </font>vLin<font color="#000080">(</font>xc <font color="#000080">+ </font>x<font color="#000080">, </font>yc <font color="#000080">- </font>y<font color="#000080">, </font>yc <font color="#000080">+ </font>y<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>dec<font color="#000080">(</font>y<font color="#000080">);
    </font>dec<font color="#000080">(</font>dy<font color="#000080">, </font>aa2<font color="#000080">);
    </font>inc<font color="#000080">(</font>d<font color="#000080">, </font>aa <font color="#000080">- </font>dy<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{This routine only called by fill}
</i></font><font color="#FF0000"><b>Function </b></font>lineFill<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>d<font color="#000080">, </font>prevXL<font color="#000080">, </font>prevXR <font color="#000080">: </font>Integer<font color="#000080">) : </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>xl<font color="#000080">, </font>xr<font color="#000080">, </font>i <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Label
  </b></font>_1<font color="#000080">, </font>_2<font color="#000080">, </font>_3<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>xl <font color="#000080">:= </font>x<font color="#000080">;
  </font>xr <font color="#000080">:= </font>x<font color="#000080">;

  </font><font color="#FF0000"><b>Repeat
    </b></font>dec<font color="#000080">(</font>xl<font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>scrn<font color="#000080">(</font>xl<font color="#000080">, </font>y<font color="#000080">) &lt;&gt; </font>fillVal<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>xl <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">);

  </font>inc<font color="#000080">(</font>xl<font color="#000080">);

  </font><font color="#FF0000"><b>Repeat
    </b></font>inc<font color="#000080">(</font>xr<font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>scrn<font color="#000080">(</font>xr<font color="#000080">, </font>y<font color="#000080">) &lt;&gt; </font>fillVal<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>xr <font color="#000080">&gt; </font>xMax<font color="#000080">);

  </font>dec<font color="#000080">(</font>xr<font color="#000080">);
  </font>hLin<font color="#000080">(</font>xl<font color="#000080">, </font>xr<font color="#000080">, </font>y<font color="#000080">);
  </font>inc<font color="#000080">(</font>y<font color="#000080">, </font>d<font color="#000080">);

  </font><font color="#FF0000"><b>if </b></font>Word<font color="#000080">(</font>y<font color="#000080">) &lt;= </font>yMax <font color="#FF0000"><b>then
  For </b></font>x <font color="#000080">:= </font>xl <font color="#FF0000"><b>to </b></font>xr <font color="#FF0000"><b>do
    if </b></font><font color="#000080">(</font>scrn<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">) = </font>fillVal<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>x <font color="#000080">:= </font>lineFill<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>d<font color="#000080">, </font>xl<font color="#000080">, </font>xr<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Word<font color="#000080">(</font>x<font color="#000080">) &gt; </font>xr <font color="#FF0000"><b>then
        Goto </b></font>_1<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>_1 <font color="#000080">:

  </font>dec<font color="#000080">(</font>y<font color="#000080">, </font>d <font color="#000080">+ </font>d<font color="#000080">);
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">neg d;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Word<font color="#000080">(</font>y<font color="#000080">) &lt;= </font>yMax <font color="#FF0000"><b>then
  begin
  For </b></font>x <font color="#000080">:= </font>xl <font color="#FF0000"><b>to </b></font>prevXL <font color="#FF0000"><b>do
    if </b></font><font color="#000080">(</font>scrn<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">) = </font>fillVal<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>i <font color="#000080">:= </font>lineFill<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>d<font color="#000080">, </font>xl<font color="#000080">, </font>xr<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Word<font color="#000080">(</font>x<font color="#000080">) &gt; </font>prevXL <font color="#FF0000"><b>then
        Goto </b></font>_2<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>_2 <font color="#000080">:

    </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font>prevXR <font color="#FF0000"><b>to </b></font>xr <font color="#FF0000"><b>do
      if </b></font><font color="#000080">(</font>scrn<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">) = </font>fillVal<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>i <font color="#000080">:= </font>lineFill<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font>d<font color="#000080">, </font>xl<font color="#000080">, </font>xr<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>Word<font color="#000080">(</font>x<font color="#000080">) &gt; </font>xr <font color="#FF0000"><b>then
          Goto </b></font>_3<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>_3 <font color="#000080">:

      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>lineFill <font color="#000080">:= </font>xr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>fill<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>fillVal <font color="#000080">:= </font>scrn<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>fillVal <font color="#000080">&lt;&gt; </font>color <font color="#FF0000"><b>then
    </b></font>lineFill<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>x<font color="#000080">, </font>x<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}

</i></font><font color="#FF0000"><b>Procedure </b></font>putTile<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">; </font>p <font color="#000080">: </font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">push  ds
  lds   si, p
  mov   ax, vSeg
  mov   es, ax
  mov   di, x
  mov   cx, di
  shr   di, 2
  mov   ax, vxBytes
  mul   y
  add   di, ax
  mov   ax, $102
  and   cl, 3
  shl   ah, cl      </font><font color="#008000"><i>{make bit mask}
  </i></font><font color="#FF00FF">mov   dx, seqPort
  mov   bh, tsy
 @DOLINE:
  mov   cl, tsx
  xor   ch, ch
  push  ax
  push  di    </font><font color="#008000"><i>{save starting bit mask}
 </i></font><font color="#FF00FF">@LOOP:
  </font><font color="#008000"><i>{mov al, 2}
  </i></font><font color="#FF00FF">out   dx, ax
  shl   ah, 1       </font><font color="#008000"><i>{give it some time to respond}
  </i></font><font color="#FF00FF">mov   bl, es:[di]
  movsb
  dec   di
  test  ah, $10
  jz    @SAMEByte
  mov   ah, 1
  inc   di
 @SAMEByte:
  loop  @LOOP
  pop   di
  add   di, vxBytes
  pop   ax </font><font color="#008000"><i>{start of next line}
  </i></font><font color="#FF00FF">dec   bh
  jnz   @DOLINE
  pop   ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>overTile<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">; </font>p <font color="#000080">: </font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">push  ds
  lds   si, p
  mov   ax, vSeg
  mov   es, ax
  mov   di, x
  mov   cx, di
  shr   di, 2
  mov   ax, vxBytes
  mul   y
  add   di, ax
  mov   ax, $102
  and   cl, 3
  shl   ah, cl      </font><font color="#008000"><i>{make bit mask}
  </i></font><font color="#FF00FF">mov   bh, tsy
  mov   dx, seqPort
 @DOLINE:
  mov   ch, tsx
  push  ax
  push  di    </font><font color="#008000"><i>{save starting bit mask}
 </i></font><font color="#FF00FF">@LOOP:
  mov   al, 2
  mov   dx, seqPort
  out   dx, ax
  shl   ah, 1
  xchg  ah, cl
  mov   al, 4
  mov   dl, gcPort and $FF
  out   dx, ax
  xchg  ah, cl
  inc   cl
  and   cl, 3
  lodsb
  or    al, al
  jz    @SKIP
  mov   bl, es:[di]
  cmp   bl, $C0
  jae   @SKIP
  stosb
  dec   di
 @SKIP:
  test  ah, $10
  jz    @SAMEByte
  mov   ah, 1
  inc   di
 @SAMEByte:
  dec   ch
  jnz   @LOOP
  pop   di
  add   di, vxBytes
  pop   ax </font><font color="#008000"><i>{start of next line}
  </i></font><font color="#FF00FF">dec   bh
  jnz   @DOLINE
  pop   ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{won't handle Chars wider than 1 Byte}
</i></font><font color="#FF0000"><b>Procedure </b></font>putChar<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>Integer<font color="#000080">; </font>p <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov   si, p  </font><font color="#008000"><i>{offset of Char in DS}
  </i></font><font color="#FF00FF">mov   ax, vSeg
  mov   es, ax
  mov   di, x
  mov   cx, di
  shr   di, 2
  mov   ax, vxBytes
  mul   y
  add   di, ax
  mov   ax, $0102
  and   cl, 3
  shl   ah, cl      </font><font color="#008000"><i>{make bit mask}
  </i></font><font color="#FF00FF">mov   dx, seqPort
  mov   cl, tsy
  xor   ch, ch
 @DOLINE:
  mov   bl, [si]
  inc   si
  push  ax
  push  di    </font><font color="#008000"><i>{save starting bit mask}
 </i></font><font color="#FF00FF">@LOOP:
  mov   al, 2
  out   dx, ax
  shl   ah, 1
  shl   bl, 1
  jnc   @SKIP
  mov   al, color
  mov   es:[di], al
 @SKIP:
  test  ah, $10
  jz    @SAMEByte
  mov   ah, 1
  inc   di
 @SAMEByte:
  or    bl, bl
  jnz   @LOOP
  pop   di
  add   di, vxBytes
  pop   ax </font><font color="#008000"><i>{start of next line}
  </i></font><font color="#FF00FF">loop  @DOLINE
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}

</i></font><font color="#FF0000"><b>Procedure </b></font>setColor<font color="#000080">(</font>color<font color="#000080">, </font>r<font color="#000080">, </font>g<font color="#000080">, </font>b <font color="#000080">: </font>Byte<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm </b></font><font color="#008000"><i>{set DAC color}
  </i></font><font color="#FF00FF">mov  dx, tableWriteIndex
  mov  al, color
  out  dx, al
  inc  dx
  mov  al, r
  out  dx, al
  mov  al, g
  out  dx, al
  mov  al, b
  out  dx, al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Write index now points to next color}

</i></font><font color="#FF0000"><b>Function </b></font>getColor<font color="#000080">(</font>color <font color="#000080">: </font>Byte<font color="#000080">) : </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm </b></font><font color="#008000"><i>{get DAC color}
  </i></font><font color="#FF00FF">mov  dx, tableReadIndex
  mov  al, color
  out  dx, al
  add  dx, 2
  cld
  xor  bh, bh
  in   al, dx
  mov  bl, al
  in   al, dx
  mov  ah, al
  in   al, dx
  mov  dx, bx
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{read index now points to next color}

</i></font><font color="#FF0000"><b>Procedure </b></font>setPalette<font color="#000080">(</font>color <font color="#000080">: </font>Byte<font color="#000080">; </font>num <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>rgb<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov   cx, num
  jcxz  @X
  mov   ax, cx
  shl   cx, 1
  add   cx, ax </font><font color="#008000"><i>{mul by 3}
  </i></font><font color="#FF00FF">push  ds
  lds   si, rgb
  cld
  mov   dx, tableWriteIndex
  mov   al, color
  out   dx, al
  inc   dx
 @L:
  lodsb
  out   dx, al
  loop  @L
  pop   ds
 @X:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>getPalette<font color="#000080">(</font>color <font color="#000080">: </font>Byte<font color="#000080">; </font>num <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>rgb<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov   cx, num
  jcxz  @X
  mov   ax, cx
  shl   cx, 1
  add   cx, ax </font><font color="#008000"><i>{mul by 3}
  </i></font><font color="#FF00FF">les   di, rgb
  cld
  mov   dx, tableReadIndex
  mov   al, color
  out   dx, al
  add   dx, 2
 @L:
  in    al, dx
  stosb
  loop  @L
 @X:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}

</i></font><font color="#FF0000"><b>Function </b></font>vgaPresent <font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov ah, $F
  int $10
  mov oldMode, al  </font><font color="#008000"><i>{ save old Gr mode}
  </i></font><font color="#FF00FF">mov ax, $1A00
  int $10          </font><font color="#008000"><i>{ check For VGA}
  </i></font><font color="#FF00FF">cmp al, $1A
  jne @ERR         </font><font color="#008000"><i>{ no VGA Bios}
  </i></font><font color="#FF00FF">cmp bl, 7
  jb @ERR          </font><font color="#008000"><i>{ is VGA or better?}
  </i></font><font color="#FF00FF">cmp bl, $FF
  jnz @OK
 @ERR:
  xor al, al
  jmp @EXIT
 @OK:
  mov al, 1
 @EXIT:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Graphbegin<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>p     <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>tRGB<font color="#000080">;
  </font>i<font color="#000080">, </font>j<font color="#000080">,
  </font>k<font color="#000080">, </font>l  <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  Asm
    </b></font><font color="#FF00FF">mov ax, $0013
    int $10
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{set BIOS mode}

  </i></font>l <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">5 </font><font color="#FF0000"><b>do
    For </b></font>j <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">5 </font><font color="#FF0000"><b>do
      For </b></font>k <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">5 </font><font color="#FF0000"><b>do
      With </b></font>p<font color="#000080">[</font>l<font color="#000080">] </font><font color="#FF0000"><b>do
      begin
        </b></font>r <font color="#000080">:= (</font>i <font color="#000080">* </font><font color="#800000">63</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">5</font><font color="#000080">;
        </font>g <font color="#000080">:= (</font>j <font color="#000080">* </font><font color="#800000">63</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">5</font><font color="#000080">;
        </font>b <font color="#000080">:= (</font>k <font color="#000080">* </font><font color="#800000">63</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">5</font><font color="#000080">;
        </font>inc<font color="#000080">(</font>l<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>For </b></font>i <font color="#000080">:= </font><font color="#800000">216 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
  With </b></font>p<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>do
  begin
    </b></font>l <font color="#000080">:= ((</font>i <font color="#000080">- </font><font color="#800000">216</font><font color="#000080">) * </font><font color="#800000">63</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">39</font><font color="#000080">;
    </font>r <font color="#000080">:= </font>l<font color="#000080">;
    </font>g <font color="#000080">:= </font>l<font color="#000080">;
    </font>b <font color="#000080">:= </font>l<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>setpalette<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">256</font><font color="#000080">, </font>p<font color="#000080">);
  </font>color <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">mov  dx, seqPort
   mov  ax, $0604
   out  dx, ax            </font><font color="#008000"><i>{ disable chain 4}
   </i></font><font color="#FF00FF">mov  ax, $0100
   out  dx, ax            </font><font color="#008000"><i>{ synchronous reset asserted}
   </i></font><font color="#FF00FF">dec  dx
   dec  dx
   mov  al, $E3
   out  dx, al            </font><font color="#008000"><i>{ misc output port at $3C2}
                          { use 25mHz dot clock,  480 lines}
   </i></font><font color="#FF00FF">inc  dx
   inc  dx
   mov  ax, $0300
   out  dx, ax            </font><font color="#008000"><i>{ restart sequencer}
   </i></font><font color="#FF00FF">mov  dx, CrtcPort
   mov  al, $11
   out  dx, al            </font><font color="#008000"><i>{ select cr11}
   </i></font><font color="#FF00FF">inc  dx
   in   al, dx
   and  al, $7F
   out  dx, al
   dec  dx                </font><font color="#008000"><i>{ remove Write protect from cr0-cr7}
   </i></font><font color="#FF00FF">mov  si, offset CrtcRegTable
   mov  cx, CrtcRegLen
   repz outsw             </font><font color="#008000"><i>{ set Crtc data}
   </i></font><font color="#FF00FF">mov  ax, vxBytes
   shr  ax, 1             </font><font color="#008000"><i>{ Words per scan line}
   </i></font><font color="#FF00FF">mov  ah, al
   mov  al, $13
   out  dx, ax            </font><font color="#008000"><i>{ set CrtC offset reg}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>clearGraph<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Graphend<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ExitProc <font color="#000080">:= </font>exitSave<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov al, oldMode
    mov ah, 0
    int $10
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>CrtcPort   <font color="#000080">:= </font>memw<font color="#000080">[</font><font color="#800000">$40 </font><font color="#000080">: </font><font color="#800000">$63</font><font color="#000080">];
  </font>input1Port <font color="#000080">:= </font>CrtcPort <font color="#000080">+ </font><font color="#800000">6</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>vgaPresent <font color="#FF0000"><b>then
  begin
    </b></font>ExitSave <font color="#000080">:= </font>exitProc<font color="#000080">;
    </font>ExitProc <font color="#000080">:= @</font>Graphend<font color="#000080">;
    </font>Graphbegin<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else
  begin
    </b></font>Writeln<font color="#000080">(^</font>G <font color="#000080">+ </font><font color="#800000">'VGA required.'</font><font color="#000080">);
    </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0029.PAS">Original</a><b>]</b></p></body>
</html>
