<html>
<head><title> "Palette Maniputlation" by DAVID DAHL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0057.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$G+}  { Enable 286 Instructions }
</i></font><font color="#FF0000"><b>Unit </b></font>Palette<font color="#000080">;

</font><font color="#008000"><i>{ Programmed By David Dahl }

(* PUBLIC DOMAIN *)

</i></font><font color="#FF0000"><b>Interface

  Type </b></font>PaletteRec  <font color="#000080">= </font><font color="#FF0000"><b>Record
                           </b></font>Red<font color="#000080">,
                           </font>Green<font color="#000080">,
                           </font>Blue  <font color="#000080">: </font>Byte<font color="#000080">;
                     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
       </font>PaletteType <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>PaletteRec<font color="#000080">;
       </font>PalettePtr  <font color="#000080">= ^</font>PaletteType<font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>SetPalette        <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>PalBuf <font color="#000080">: </font>PaletteType<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>GetPalette        <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>PalBuf <font color="#000080">: </font>PaletteType<font color="#000080">);

  </font><font color="#FF0000"><b>Procedure </b></font>BlackPalette<font color="#000080">;
  </font><font color="#FF0000"><b>Procedure </b></font>FadeInFromBlack   <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Palin <font color="#000080">: </font>PaletteType<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>FadeInFromBlackQ  <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Palin     <font color="#000080">: </font>PaletteType<font color="#000080">;
                                   </font>Intensity <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>FadeOutToBlack    <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Palin <font color="#000080">: </font>PaletteType<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>FadeFromPalToPal  <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>OldPal<font color="#000080">, </font>NewPal <font color="#000080">: </font>PaletteType<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>FadeFromPalToPalQ <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>OldPal<font color="#000080">, </font>NewPal <font color="#000080">: </font>PaletteType<font color="#000080">;
                                   </font>Color          <font color="#000080">: </font>Word<font color="#000080">);


  </font><font color="#FF0000"><b>Var </b></font>BlackP  <font color="#000080">: </font>PaletteType<font color="#000080">;
      </font>WhiteP  <font color="#000080">: </font>PaletteType<font color="#000080">;

      </font>TempPal <font color="#000080">: </font>PaletteType<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

</b></font><font color="#008000"><i>{-[ Set Value Of All DAC Registers ]--------------------------------------}
</i></font><font color="#FF0000"><b>Procedure </b></font>SetPalette <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>PalBuf <font color="#000080">: </font>PaletteType<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">PUSH DS

    XOR AX, AX       </font><font color="#008000"><i>{ Palette Start = 0 }
    </i></font><font color="#FF00FF">MOV CX, 0300h / 2
    LDS SI, PalBuf   </font><font color="#008000"><i>{ Load DS:SI With Address Of PalBuf (For OUTSB) }

    </i></font><font color="#FF00FF">MOV DX, 03C8h    </font><font color="#008000"><i>{ Tell VGA Card What DAC Color To Start With }
    </i></font><font color="#FF00FF">OUT DX, AL

    INC DX           </font><font color="#008000"><i>{ Set DX To Equal DAC Data Port }
    </i></font><font color="#FF00FF">MOV BX, DX
    CLD

    </font><font color="#008000"><i>{ Wait For V-sync }
    </i></font><font color="#FF00FF">MOV DX, 03DAh
    @VSYNC0:
      IN   AL, DX
      TEST AL, 8
    JZ @VSYNC0

    MOV DX, BX
    REP
       OUTSB

    MOV BX, DX

    </font><font color="#008000"><i>{ Wait For V-sync }
    </i></font><font color="#FF00FF">MOV DX, 03DAh
    @VSYNC1:
      IN   AL, DX
      TEST AL, 8
    JZ @VSYNC1

    MOV DX, BX
    MOV CX, 0300h / 2
    REP
       OUTSB

    POP DS
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{-[ Get Value Of All DAC Registers ]--------------------------------------}
</i></font><font color="#FF0000"><b>Procedure </b></font>GetPalette <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>PalBuf <font color="#000080">: </font>PaletteType<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">PUSH DS

    XOR AX, AX       </font><font color="#008000"><i>{ Palette Start = 0 }
    </i></font><font color="#FF00FF">MOV CX, 0300h
    LES DI, PalBuf   </font><font color="#008000"><i>{ Load ES:DI With Address Of PalBuf (For INSB) }

    </i></font><font color="#FF00FF">MOV DX, 03C7h    </font><font color="#008000"><i>{ Tell VGA Card What DAC Color To Start With }
    </i></font><font color="#FF00FF">OUT DX, AL

    INC DX           </font><font color="#008000"><i>{ Set DX To Equal DAC Data Port }
    </i></font><font color="#FF00FF">INC DX
    CLD

    REP
       INSB

    POP DS
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>BlackPalette<font color="#000080">;
</font><font color="#FF0000"><b>Begin
     </b></font>SetPalette <font color="#000080">(</font>BlackP<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FadeInFromBlack <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Palin <font color="#000080">: </font>PaletteType<font color="#000080">);
</font><font color="#FF0000"><b>Var </b></font>DAC<font color="#000080">,
    </font>Intensity <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
     For </b></font>Intensity <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">32 </font><font color="#FF0000"><b>do
     Begin
       For </b></font>DAC <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
       Begin
          </b></font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
       </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

       </font>SetPalette <font color="#000080">(</font>TempPal<font color="#000080">);
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FadeInFromBlackQ <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Palin     <font color="#000080">: </font>PaletteType<font color="#000080">;
                                </font>Intensity <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Const </b></font>DAC <font color="#000080">: </font>Word <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>Begin
     For </b></font>DAC <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
     Begin
          </b></font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

     </font>SetPalette <font color="#000080">(</font>TempPal<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FadeOutToBlack <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Palin <font color="#000080">: </font>PaletteType<font color="#000080">);
</font><font color="#FF0000"><b>Var </b></font>DAC<font color="#000080">,
    </font>Intensity <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
     For </b></font>Intensity <font color="#000080">:= </font><font color="#800000">32 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
     Begin
       For </b></font>DAC <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
       Begin
          </b></font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">:= (</font>Palin<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">* </font>Intensity<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">;
       </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

       </font>SetPalette <font color="#000080">(</font>TempPal<font color="#000080">);
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>FadeFromPalToPal <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>OldPal<font color="#000080">, </font>NewPal <font color="#000080">: </font>PaletteType<font color="#000080">);
</font><font color="#FF0000"><b>Var </b></font>DAC<font color="#000080">,
    </font>Color <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
     For </b></font>Color <font color="#000080">:= </font><font color="#800000">32 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
     Begin
       For </b></font>DAC <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
       Begin
          </b></font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">:= ((</font>OldPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">* </font>Color<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">) +
                                ((</font>NewPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">* (</font><font color="#800000">32 </font><font color="#000080">- </font>Color<font color="#000080">)) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">);
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">:= ((</font>OldPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">* </font>Color<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">) +
                                ((</font>NewPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">* (</font><font color="#800000">32 </font><font color="#000080">- </font>Color<font color="#000080">)) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">);
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">:= ((</font>OldPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">* </font>Color<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">) +
                                ((</font>NewPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">* (</font><font color="#800000">32 </font><font color="#000080">- </font>Color<font color="#000080">)) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">);
       </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

       </font>SetPalette <font color="#000080">(</font>TempPal<font color="#000080">);
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FadeFromPalToPalQ <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>OldPal<font color="#000080">, </font>NewPal <font color="#000080">: </font>PaletteType<font color="#000080">;
                                 </font>Color          <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Const </b></font>DAC <font color="#000080">: </font>Word <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>Begin
     For </b></font>DAC <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
     Begin
          </b></font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">:= ((</font>OldPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">* (</font><font color="#800000">32 </font><font color="#000080">- </font>Color<font color="#000080">)) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">)+
                                ((</font>NewPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Red   <font color="#000080">* </font>Color<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">);
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">:= ((</font>OldPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">* (</font><font color="#800000">32 </font><font color="#000080">- </font>Color<font color="#000080">)) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">)+
                                ((</font>NewPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Green <font color="#000080">* </font>Color<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">);
          </font>TempPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">:= ((</font>OldPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">* (</font><font color="#800000">32 </font><font color="#000080">- </font>Color<font color="#000080">)) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">)+
                                ((</font>NewPal<font color="#000080">[</font>DAC<font color="#000080">].</font>Blue  <font color="#000080">* </font>Color<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font><font color="#800000">32</font><font color="#000080">);
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

     </font>SetPalette <font color="#000080">(</font>TempPal<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var </b></font>Counter <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
     For </b></font>Counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
     Begin
          </b></font>BlackP<font color="#000080">[</font>Counter<font color="#000080">].</font>Red   <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font>BlackP<font color="#000080">[</font>Counter<font color="#000080">].</font>Green <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font>BlackP<font color="#000080">[</font>Counter<font color="#000080">].</font>Blue  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>For </b></font>Counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
     Begin
          </b></font>WhiteP<font color="#000080">[</font>Counter<font color="#000080">].</font>Red   <font color="#000080">:= </font><font color="#800000">63</font><font color="#000080">;
          </font>WhiteP<font color="#000080">[</font>Counter<font color="#000080">].</font>Green <font color="#000080">:= </font><font color="#800000">63</font><font color="#000080">;
          </font>WhiteP<font color="#000080">[</font>Counter<font color="#000080">].</font>Blue  <font color="#000080">:= </font><font color="#800000">63</font><font color="#000080">;
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0057.PAS">Original</a><b>]</b></p></body>
</html>
