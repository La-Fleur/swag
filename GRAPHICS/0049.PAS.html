<html>
<head><title> "GIF Code" by THORSTEN BARTH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0049.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Does anyone have ANY source, on how to display a gif in VGA mode

It's as bad as ... but it works.

--- VGA gif loader part 1 of 3 ---
}

{$X+}

</i></font><font color="#FF0000"><b>Uses </b></font>Graph<font color="#000080">,</font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Gd<font color="#000080">,</font>Gm<font color="#000080">: </font>Integer<font color="#000080">;
  </font>Datei<font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>palette<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>buffer<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1279</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>prefix<font color="#000080">,</font>tail<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4095</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>WORD<font color="#000080">;
  </font>keller<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">640</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>LoadGif<font color="#000080">(</font>N<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>VersX<font color="#000080">,</font>VersY<font color="#000080">: </font>Word<font color="#000080">): </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetChar<font color="#000080">: </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>Var </b></font>C<font color="#000080">: </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>BlockRead<font color="#000080">(</font>Datei<font color="#000080">,</font>C<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>GetChar<font color="#000080">:=</font>C<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetByte<font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Var </b></font>B<font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>BlockRead<font color="#000080">(</font>Datei<font color="#000080">,</font>B<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>GetByte<font color="#000080">:=</font>B<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetWord<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var </b></font>W<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>BlockRead<font color="#000080">(</font>Datei<font color="#000080">,</font>W<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font>Getword<font color="#000080">:=</font>W<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AGetBytes<font color="#000080">(</font>Anz<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Begin
  </b></font>BlockRead<font color="#000080">(</font>Datei<font color="#000080">,</font>Buffer<font color="#000080">,</font>Anz<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>lokal_farbtafel<font color="#000080">: </font>Integer<font color="#000080">;
  </font>mask<font color="#000080">,</font>restbytes<font color="#000080">,</font>pp<font color="#000080">,</font>lbyte<font color="#000080">,</font>blocklen<font color="#000080">,</font>code<font color="#000080">,</font>oldcode<font color="#000080">,</font>sonderfall<font color="#000080">,
  </font>incode<font color="#000080">,</font>freepos<font color="#000080">,</font>kanz<font color="#000080">,</font>pass<font color="#000080">,</font>clearcode<font color="#000080">,</font>eofcode<font color="#000080">,</font>maxcode<font color="#000080">,</font>infobyte<font color="#000080">,
  </font>globalfarbtafel<font color="#000080">,</font>backcolor<font color="#000080">,</font>interlace<font color="#000080">,</font>bilddef<font color="#000080">,</font>abslinks<font color="#000080">,</font>absoben<font color="#000080">: </font>word<font color="#000080">;
  </font>bits<font color="#000080">,</font>restbits<font color="#000080">,</font>codesize<font color="#000080">: </font>Byte<font color="#000080">;
  </font>rot<font color="#000080">,</font>gruen<font color="#000080">,</font>blau<font color="#000080">,</font>by<font color="#000080">,</font>bpp<font color="#000080">: </font>Byte<font color="#000080">;
  </font>z<font color="#000080">,</font>i<font color="#000080">,</font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">: </font>integer<font color="#000080">;
  </font>bem<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">6</font><font color="#000080">];
  </font>farben<font color="#000080">: </font>integer<font color="#000080">;
  </font>x<font color="#000080">,</font>y<font color="#000080">,</font>xa<font color="#000080">,</font>ya<font color="#000080">,</font>dy<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>loadgif<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>Assign<font color="#000080">(</font>Datei<font color="#000080">,</font>N<font color="#000080">);
  </font>reset<font color="#000080">(</font>Datei<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ioresult<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then begin </b></font>loadgif<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">; </font>exit<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>bem<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">6 </font><font color="#FF0000"><b>do </b></font>bem<font color="#000080">:=</font>bem<font color="#000080">+</font>getchar<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>copy<font color="#000080">(</font>bem<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">3</font><font color="#000080">)&lt;&gt;</font><font color="#800000">'GIF' </font><font color="#FF0000"><b>then begin </b></font>loadgif<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">; </font>exit<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>x2<font color="#000080">:=</font>getword<font color="#000080">;
  </font>y2<font color="#000080">:=</font>getword<font color="#000080">;
  </font>infobyte<font color="#000080">:=</font>getbyte<font color="#000080">;
  </font>globalfarbtafel<font color="#000080">:=</font>infobyte <font color="#FF0000"><b>and </b></font><font color="#800000">128</font><font color="#000080">;
  </font>bpp<font color="#000080">:=(</font>infobyte <font color="#FF0000"><b>and </b></font><font color="#800000">7</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
  </font>farben<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>bpp<font color="#000080">;
  </font>backcolor<font color="#000080">:=</font>getbyte<font color="#000080">;
  </font>by<font color="#000080">:=</font>getbyte<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>globalfarbtafel<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#000080">(</font><font color="#800000">3</font><font color="#000080">*</font>farben<font color="#000080">)-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
      </b></font>palette<font color="#000080">[</font>i<font color="#000080">]:=</font>getbyte <font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
  </font>bilddef<font color="#000080">:=</font>getbyte<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>bilddef<font color="#000080">=</font><font color="#800000">$21 </font><font color="#FF0000"><b>do begin
    </b></font>by<font color="#000080">:=</font>getbyte<font color="#000080">; </font>z<font color="#000080">:=</font>getbyte<font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>z <font color="#FF0000"><b>do </b></font>by<font color="#000080">:=</font>getbyte<font color="#000080">;
    </font>by<font color="#000080">:=</font>getbyte<font color="#000080">;
    </font>bilddef<font color="#000080">:=</font>getbyte<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


  </font><font color="#FF0000"><b>if </b></font>bilddef<font color="#000080">&lt;&gt;</font><font color="#800000">$2c </font><font color="#FF0000"><b>then begin </b></font>loadgif<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">; </font>exit<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>abslinks<font color="#000080">:=</font>getword<font color="#000080">+</font>VersX<font color="#000080">;
  </font>absoben<font color="#000080">:=</font>getword<font color="#000080">+</font>VersY<font color="#000080">;
  </font>x2<font color="#000080">:=</font>getword<font color="#000080">;
  </font>y2<font color="#000080">:=</font>getword<font color="#000080">;
  </font>by<font color="#000080">:=</font>getbyte<font color="#000080">;
  </font>lokal_farbtafel<font color="#000080">:=</font>by <font color="#FF0000"><b>and </b></font><font color="#800000">128</font><font color="#000080">;
  </font>interlace<font color="#000080">:=</font>by <font color="#FF0000"><b>and </b></font><font color="#800000">64</font><font color="#000080">;
  </font>by<font color="#000080">:=</font>getbyte<font color="#000080">;
  </font>x1<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>y1<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>xa<font color="#000080">:=</font>x2<font color="#000080">; </font>Ya<font color="#000080">:=</font>Y2<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>farben<font color="#000080">&lt;</font><font color="#800000">16 </font><font color="#FF0000"><b>then begin </b></font>loadgif<font color="#000080">:=</font><font color="#800000">4</font><font color="#000080">; </font>exit<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>lokal_farbtafel<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">3</font><font color="#000080">*</font>Farben<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
      </b></font>palette<font color="#000080">[</font>I<font color="#000080">]:=</font>getbyte <font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax,$1012
    push ds
    pop es
    xor bx,bx
    mov cx,256
    lea dx,palette
    int $10
    mov pass,0
    MOV CL,bpp
    MOV AX,1
    SHL AX,CL
    MOV clearcode,AX
    INC AX
    MOV eofcode,AX
    INC AX
    MOV freepos,AX
    MOV AL,bpp
    MOV AH,0
    INC AX
    MOV codesize,AL
    MOV CX,AX
    MOV AX,1
    SHL AX,CL
    DEC AX
    MOV maxcode,AX
    MOV kanz,0
    MOV dy,8
    MOV restbits,0
    MOV restbytes,0
    MOV x,0
    MOV y,0
@gif0: CALL FAR PTR @getgifbyte
    CMP AX,eofcode
    je @ende1
@gif1: CMP AX,clearcode
    je @reset1
@gif3: MOV AX,code
    MOV incode,AX
    CMP ax,freepos
    jb @gif4
    MOV AX,oldcode
    MOV code,AX
    MOV BX,kanz
    MOV CX,sonderfall
    SHL BX,1
    MOV [OFFSET keller+BX],CX
    INC kanz
@gif4: CMP AX,clearcode
    JB @gif6
@gif5: MOV BX,code
    SHL BX,1
    PUSH BX
    MOV AX,[Offset tail+BX]
    MOV BX,kanz
    SHL BX,1
    MOV [OFFSET keller+BX],AX
    INC kanz
    POP BX
    MOV AX,[Offset prefix+BX]
    MOV code,AX
    CMP AX,clearcode
    ja @gif5
@gif6: MOV BX,kanz
    SHL BX,1
    MOV [Offset keller+BX],AX
    MOV sonderfall,AX
    INC kanz
@gif7: MOV AX,[Offset keller+BX]
    CALL FAR PTR @pixel
    CMP BX,0
    JE @gif8
    DEC BX
    DEC BX
    JMP @gif7

@gif8: MOV kanz,0
    MOV BX,freepos
    SHL BX,1
    MOV AX,oldcode
    MOV [Offset prefix+BX],AX
    MOV AX,code
    MOV [Offset tail+BX],AX
    MOV AX,incode
    MOV oldcode,AX
    INC freepos
    MOV AX,freepos
    CMP AX,maxcode
    JBE @gif2
    CMP codesize,12
    JAE @gif2
    INC codesize
    MOV CL,codesize
    MOV AX,1
    SHL AX,CL
    DEC AX
    MOV maxcode,AX
@gif2: JMP @gif0
@ende1: JMP @ende
@reset1: MOV AL,bpp
    MOV AH,0
    INC AX
    MOV codesize,AL
    MOV CX,AX
    MOV AX,1
    SHL AX,CL
    DEC AX
    MOV maxcode,AX
    MOV AX,clearcode
    ADD AX,2
    MOV freepos,AX
    CALL FAR PTR @getgifbyte
    MOV sonderfall,AX
    MOV oldcode,AX
    CALL FAR PTR @pixel
    JMP @gif2
@getgifbyte: MOV DI,0
    MOV mask,1
    MOV bits,0
@g1: MOV AL,bits
    CMP AL,codesize
    JAE @g0
    CMP restbits,0
    JA @g2
    CMP restbytes,0
    JNE @l2
    PUSH DI
    CALL Getbyte
    POP DI
    MOV blocklen,AX
    MOV restbytes,AX
    PUSH DI
    PUSH AX
    CALL AGetbytes
    POP DI
    MOV pp,0
@l2: MOV BX,pp
    MOV AL,[BX+Offset Buffer]
    XOR AH,AH
    INC pp
    DEC restbytes
    MOV lbyte,AX
    MOV restbits,8
@g2: SHR lbyte,1
    JNC @nocarry
    OR DI,mask
@nocarry: INC bits
    DEC restbits
    SHL mask,1
    JMP @g1
@g0:MOV bits,0
    MOV code,DI
    MOV AX,DI
    RETF
@pixel:
    PUSH BX
    MOV BX,x
    ADD BX,abslinks
    PUSH BX
    MOV BX,y
    ADD BX,absoben
    PUSH BX
    PUSH AX
    CALL Putpixel
    POP BX
    INC x
    MOV AX,x
    CMP AX,x2
    JB @s0
    MOV x,0
    CMP interlace,0
    JNE @s1
    INC y
    JMP @s0
@s1: MOV AX,dy
    ADD y,AX
    MOV AX,y
    CMP AX,y2
    JB @s0
    INC pass
    CMP pass,1
    JNE @s3
    JMP @s2
@s3: SHR dy,1
@s2: MOV AX,DY
    SHR AX,1
    MOV Y,AX
@s0: RETF
@ende:
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>Close<font color="#000080">(</font>Datei<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin

end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0049.PAS">Original</a><b>]</b></p></body>
</html>
