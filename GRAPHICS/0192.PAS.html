<html>
<head><title> "A Putpixel Benchmark" by ANDREAS JUNG</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0192.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; It seems that the location of the routine in the program also affects
&gt; its performance.  The one closest to the main procedure always seems to
&gt; win. This probably has to do something with caching...

No, I have made many tests ( 3 hours spending on it ) and my results are :
First : The Procedure relative to the main programm has NO affect one the
preformance ( atleast with small programms ).
My System look like this :
        486 DX 50 with 256 kb Cache
        ISA ET4000 W32 VGA-Card
        16 MB RAM

&gt; These numbers are too small to compare, try setting N to 50, and
&gt; swap the position of the routines sometimes. You'll get many different
&gt; results.

Sorry, but when I was testing the routines I had set N to 1000 !!! That
should be big enough.. Well since Jannie Hanekom wrote me a message, I made
again some test and these are my results :

 ( numbers have no meaning, higher is better ,  N = 1000 )
 pix1 :   59,68 M  ( Mem in Pascal )
 pix2 :  158,00 M  ( with lookup table, old proc )
 pix3 :  170,35 M  ( without lookup table )
 pix4 :  186,37 M  ( with lookup table, NEW proc )
 pix5 :  153,31 M  ( with lookup table, optimized by Jannie Hankom
                     trying to reduce penalty cycles, while Memory access )
 pix6 :  213,57 M  ( with lookup table, from Jannie Hanekom,
                     optimized by me )
     { M = Million }


{$A+,B-,D+,E+,F-,G+,I+,L+,N-,O-,P-,Q+,R+,S+,T-,V+,X+,Y+}
{$M 16384,0,655360}

</i></font><font color="#FF0000"><b>const </b></font>N <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>lut <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">199</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>call<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">; </font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>begin end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>pix1<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">; </font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>begin </b></font>mem<font color="#000080">[</font><font color="#800000">$A000</font><font color="#000080">:</font>x<font color="#000080">+</font>y<font color="#000080">*</font><font color="#800000">320</font><font color="#000080">] := </font>c <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>pix2<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">; </font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,0A000h
 mov es,ax
 mov bx,y
 add bx,bx
 mov si,x
 mov bx,word ptr lut[bx]
 mov al,c
 mov es:[bx+si],al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>pix3<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">; </font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,0A000h
 mov es,ax
 mov ah,byte ptr y
 mov bx,x
 add bx,ax
 shr ax,2
 add bx,ax
 mov al,c
 mov es:[bx],al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>pix4<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">:</font>word<font color="#000080">; </font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ code from  Andreas Jung  }
</i></font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,0A000h
 mov es,ax
 mov bx,y
 add bx,bx
 mov si,x
 mov bx,word ptr lut[bx]
 mov al,c
 add bx,si
 mov es:[bx],al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>Pix5<font color="#000080">(</font>X<font color="#000080">, </font>Y <font color="#000080">: </font>Word<font color="#000080">;  </font>C <font color="#000080">: </font>Byte<font color="#000080">);  </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ code from  Jannie Hanekom  }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov  bx, Y
  add  bx, bx
  mov  es, SegA000
  mov  bx, word ptr lut[bx]  </font><font color="#008000"><i>{ Note:  BX not changed within 2 cycles }
  </i></font><font color="#FF00FF">add  bx, X
  mov  al, C
  mov  byte ptr es:[bx], al  </font><font color="#008000"><i>{ Again 1 cycle before memory move }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>Pix6<font color="#000080">(</font>X<font color="#000080">, </font>Y <font color="#000080">: </font>Word<font color="#000080">;  </font>C <font color="#000080">: </font>Byte<font color="#000080">);  </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ code from  Jannie Hanekom  }
{ optimized by  Andreas Jung }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov  bx, Y
  add  bx, bx
  mov  ax, 0A000h
  mov  es, ax
  mov  bx, word ptr lut[bx]  </font><font color="#008000"><i>{ Note:  BX not changed within 2 cycles }
  </i></font><font color="#FF00FF">mov  cx, x
  add  bx, cx
  mov  al, C
  mov  byte ptr es:[bx], al  </font><font color="#008000"><i>{ Again 1 cycle before memory move }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>time<font color="#000080">:</font>longint <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0</font><font color="#000080">:</font><font color="#800000">$46c</font><font color="#000080">; </font>t<font color="#000080">,</font>c<font color="#000080">,</font>p1<font color="#000080">,</font>p2<font color="#000080">,</font>p3<font color="#000080">,</font>p4<font color="#000080">:</font>longint<font color="#000080">; </font>i<font color="#000080">:</font>word<font color="#000080">;

</font><font color="#FF0000"><b>begin
 </b></font>write<font color="#000080">(</font><font color="#800000">'Filling Look-Up Table'</font><font color="#000080">);
 </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">199 </font><font color="#FF0000"><b>do </b></font>lut<font color="#000080">[</font>i<font color="#000080">] := </font>i<font color="#000080">*</font><font color="#800000">320</font><font color="#000080">;

 </font>write<font color="#000080">(</font><font color="#800000">#13#10'Timing Procedure Call'</font><font color="#000080">);
 </font>randseed <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>c <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>t <font color="#000080">:= </font>time<font color="#000080">; </font><font color="#FF0000"><b>while </b></font>t <font color="#000080">= </font>time <font color="#FF0000"><b>do</b></font><font color="#000080">; </font>inc<font color="#000080">(</font>t<font color="#000080">,</font>N<font color="#000080">);
 </font><font color="#FF0000"><b>repeat </b></font>call<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">320</font><font color="#000080">),</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">),</font>random<font color="#000080">(</font><font color="#800000">256</font><font color="#000080">)); </font>inc<font color="#000080">(</font>c<font color="#000080">)
 </font><font color="#FF0000"><b>until </b></font>time <font color="#000080">= </font>t<font color="#000080">;

 </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax,13h; int 10h </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font>randseed <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>p1 <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>t <font color="#000080">:= </font>time<font color="#000080">; </font><font color="#FF0000"><b>while </b></font>t <font color="#000080">= </font>time <font color="#FF0000"><b>do</b></font><font color="#000080">; </font>inc<font color="#000080">(</font>t<font color="#000080">,</font>N<font color="#000080">);
 </font><font color="#FF0000"><b>repeat </b></font>pix1<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">320</font><font color="#000080">),</font>random<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">),</font>random<font color="#000080">(</font><font color="#800000">256</font><font color="#000080">)); </font>inc<font color="#000080">(</font>p1<font color="#000080">)
 </font><font color="#FF0000"><b>until </b></font>time <font color="#000080">= </font>t<font color="#000080">;


 </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax,03h; int 10h </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font>writeln<font color="#000080">(</font><font color="#800000">'1 : '</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">/(</font><font color="#800000">1</font><font color="#000080">/</font>p1<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">/</font>c<font color="#000080">):</font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">0</font><font color="#000080">);

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font>Jannie Hanekom said correctly<font color="#000080">, </font><font color="#FF0000"><b>if </b></font>a <font color="#FF0000"><b>register is </b></font>changed one cycle befor a
memory move <font color="#FF0000"><b>is </b></font>made <font color="#FF0000"><b>with </b></font>this <font color="#FF0000"><b>register</b></font><font color="#000080">, </font>the processor will make one penalty
cycle <font color="#FF0000"><b>to </b></font>calculate the adress<font color="#000080">. </font>So you must always <font color="#FF0000"><b>try to do </b></font>such a thing <font color="#000080">:

  </font>add  bx<font color="#000080">, </font>cx                   <font color="#008000"><i>{ calc offset to pixel in Mem }
  </i></font>mov  al<font color="#000080">, </font>C                    <font color="#008000"><i>{ do some thing else, so the processor can
                                  calc the offset in Mem }
  </i></font>mov  byte ptr es<font color="#000080">:[</font>bx<font color="#000080">], </font>al     <font color="#008000"><i>{ Now you wont get a penalty cycle, because
                                  you have changed bx 2 cycles befor the
                                  Mem move !! }

</i></font><font color="#FF0000"><b>If </b></font>you would use this code<font color="#000080">, </font>you WOULD get a penalty cycle <font color="#000080">:
  </font>mov  al<font color="#000080">, </font>C
  add  bx<font color="#000080">, </font>cx
  mov  byte ptr es<font color="#000080">:[</font>bx<font color="#000080">], </font>al
Because you have changed the bx one cycle befor the mem move<font color="#000080">..

</font>It would be very interessting <font color="#FF0000"><b>to </b></font>know which results you get <font color="#FF0000"><b>on </b></font>your
computer<font color="#000080">, </font>because pix6 <font color="#FF0000"><b>is </b></font>now the FASTEST routine <font color="#FF0000"><b>to </b></font>put a pixel <font color="#FF0000"><b>in
</b></font><font color="#800000">320</font>x200x256 <font color="#000080">!! </font><font color="#FF0000"><b>Try </b></font>these thing <font color="#FF0000"><b>with </b></font>N <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">, </font>so you wont get much
diffrents between two tests<font color="#000080">..

</font>BTW<font color="#000080">, </font><font color="#FF0000"><b>if </b></font>you have found any faster routines<font color="#000080">, </font>let me know <font color="#000080">!!!! </font>I<font color="#800000">'m realy
</font>interessted <font color="#FF0000"><b>in </b></font>this <font color="#000080">!!

</font>Greetings<font color="#000080">,
            </font>Andreas<font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0192.PAS">Original</a><b>]</b></p></body>
</html>
