<html>
<head><title> "X3dunit" by LUIS MEZQUITA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0132.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>x3dunit2<font color="#000080">;

</font><font color="#008000"><i>{ mode-x 3D unit - xhlin-procedure by Sean Palmer }
{ Optimized by Luis Mezquita Raya                 }

{$g+}

</i></font><font color="#FF0000"><b>interface

const </b></font>vidseg<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">$a000</font><font color="#000080">;
      </font>divd<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">128</font><font color="#000080">;
      </font>dist<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">200</font><font color="#000080">;
      </font>minx<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
      </font>maxx<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">319</font><font color="#000080">;
      </font>border<font color="#000080">:</font>boolean<font color="#000080">=</font>false<font color="#000080">;

</font><font color="#FF0000"><b>var   </b></font>ctab<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>byte<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
      </font>stab<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>byte<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
      </font>address<font color="#000080">:</font>word<font color="#000080">;
      </font>triangles<font color="#000080">:</font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>setborder<font color="#000080">(</font>col<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>setpal<font color="#000080">(</font>c<font color="#000080">,</font>r<font color="#000080">,</font>g<font color="#000080">,</font>b<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>retrace<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>setmodex<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>setaddress<font color="#000080">(</font>ad<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>cls<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>polygon<font color="#000080">(</font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">,</font>x3<font color="#000080">,</font>y3<font color="#000080">,</font>x4<font color="#000080">,</font>y4<font color="#000080">:</font>integer<font color="#000080">; </font>c<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>cosinus<font color="#000080">(</font>i<font color="#000080">:</font>byte<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>sinus<font color="#000080">(</font>i<font color="#000080">:</font>byte<font color="#000080">):</font>integer<font color="#000080">;

</font><font color="#FF0000"><b>implementation

var   </b></font>xpos<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">199</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>setborder<font color="#000080">(</font>col<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">xor ch,ch
        mov cl,border
        jcxz @out
        mov dx,3dah
        in al,dx
        mov dx,3c0h
        mov al,11h+32
        out dx,al
        mov al,col
        out dx,al
@out:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>setpal<font color="#000080">(</font>c<font color="#000080">,</font>r<font color="#000080">,</font>g<font color="#000080">,</font>b<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov dx,3c8h
        mov al,[c]
        out dx,al
        inc dx
        mov al,[r]
        out dx,al
        mov al,[g]
        out dx,al
        mov al,[b]
        out dx,al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>retrace<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov dx,3dah;
@vert1: in al,dx
        test al,8
        jz @vert1
@vert2: in al,dx
        test al,8
        jnz @vert2
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>setmodex<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov ax,13h
        int 10h
        mov dx,3c4h
        mov ax,0604h
        out dx,ax
        mov ax,0f02h
        out dx,ax
        mov cx,320*200
        mov es,vidseg
        xor ax,ax
        mov di,ax
        rep stosw
        mov dx,3d4h
        mov ax,0014h
        out dx,ax
        mov ax,0e317h
        out dx,ax
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>setaddress<font color="#000080">(</font>ad<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov dx,3d4h
        mov al,0ch
        mov ah,[byte(ad)+1]
        out dx,ax
        mov al,0dh
        mov ah,[byte(ad)]
        out dx,ax
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>cls<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov es,vidseg
        mov di,address
        mov cx,8000
        mov dx,3c4h
        mov ax,0f02h
        out dx,ax
        xor ax,ax
        rep stosw
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$f-}

</i></font><font color="#FF0000"><b>Procedure </b></font>polygon<font color="#000080">(</font>x1<font color="#000080">,</font>y1<font color="#000080">,</font>x2<font color="#000080">,</font>y2<font color="#000080">,</font>x3<font color="#000080">,</font>y3<font color="#000080">,</font>x4<font color="#000080">,</font>y4<font color="#000080">:</font>integer<font color="#000080">; </font>c<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>mny<font color="#000080">,</font>mxy<font color="#000080">,</font>y<font color="#000080">,</font>m<font color="#000080">,</font>mult<font color="#000080">,</font>divi<font color="#000080">,</font>top<font color="#000080">,</font>s<font color="#000080">,
    </font>stb<font color="#000080">,</font>px1<font color="#000080">,</font>py1<font color="#000080">,</font>px2<font color="#000080">,</font>py2<font color="#000080">:</font>integer<font color="#000080">;
    </font>dir<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>asm                                     </b></font><font color="#008000"><i>{ Procedure Polygon }
        </i></font><font color="#FF00FF">mov ax,y1                       </font><font color="#008000"><i>{ Determine lowest &amp; highest points }
        </i></font><font color="#FF00FF">mov cx,ax
        mov bx,y2

        cmp ax,bx                       </font><font color="#008000"><i>{ if mny&gt;y2 ==&gt; mny:=y2 }
        </i></font><font color="#FF00FF">jl @p2
        mov ax,bx

@p2:    cmp cx,bx                       </font><font color="#008000"><i>{ if mxy&lt;y2 ==&gt; mxy:=y2 }
        </i></font><font color="#FF00FF">jg @p3
        mov cx,bx

@p3:    mov bx,y3
        cmp ax,bx                       </font><font color="#008000"><i>{ if mny&gt;y3 ==&gt; mny:=y3 }
        </i></font><font color="#FF00FF">jl @p3M
        mov ax,bx

@p3M:   cmp cx,bx                       </font><font color="#008000"><i>{ if mxy&lt;y3 ==&gt; mxy:=y3 }
        </i></font><font color="#FF00FF">jg @p4
        mov cx,bx

@p4:    mov bx,y4
        cmp ax,bx                       </font><font color="#008000"><i>{ if mny&gt;y4 ==&gt; mny:=y4 }
        </i></font><font color="#FF00FF">jl @p4M
        mov ax,bx

@p4M:   cmp cx,bx                       </font><font color="#008000"><i>{ if mxy&lt;y4 ==&gt; mxy:=y4 }
        </i></font><font color="#FF00FF">jg @vert
        mov cx,bx

@vert:  cmp ax,0                        </font><font color="#008000"><i>{ Vertical range checking }
        </i></font><font color="#FF00FF">jge @minin                      </font><font color="#008000"><i>{ if mny&lt;0 ==&gt; mny:=0 }
        </i></font><font color="#FF00FF">xor ax,ax
@minin: cmp cx,200                      </font><font color="#008000"><i>{ if mxy&gt;199 ==&gt; mxy:=199 }
        </i></font><font color="#FF00FF">jl @maxin
        mov cx,199
@maxin: cmp cx,0                        </font><font color="#008000"><i>{ if mxy&lt;0 ==&gt; Exit }
        </i></font><font color="#FF00FF">jl @pexit
        cmp ax,199                      </font><font color="#008000"><i>{ if mny&gt;199 ==&gt; Exit }
        </i></font><font color="#FF00FF">jg @pexit

        mov mny,ax                      </font><font color="#008000"><i>{ ax=mny=lowest point }
        </i></font><font color="#FF00FF">mov mxy,cx                      </font><font color="#008000"><i>{ cx=mxy=highest point }

        </i></font><font color="#FF00FF">push x1                         </font><font color="#008000"><i>{ RangeChk(x1,y1,x2,y2) }
        </i></font><font color="#FF00FF">push y1
        push x2
        push y2
        call @Range

        push x2                         </font><font color="#008000"><i>{ RangeChk(x2,y2,x3,y3) }
        </i></font><font color="#FF00FF">push y2
        push x3
        push y3
        call @Range

        push x3                         </font><font color="#008000"><i>{ RangeChk(x3,y3,x4,y4) }
        </i></font><font color="#FF00FF">push y3
        cmp Triangles,0
        jz @Poly4
        push x1
        push y1
        jmp @Last

@Poly4: push x4
        push y4
        call @Range

        push x4                         </font><font color="#008000"><i>{ RangeChk(x4,y4,x1,y1) }
        </i></font><font color="#FF00FF">push y4
        push x1
        push y1
@Last:  call @Range

        mov ax,mny                      </font><font color="#008000"><i>{ Show a poly }
        </i></font><font color="#FF00FF">mov di,ax                       </font><font color="#008000"><i>{ y:=mny }
        </i></font><font color="#FF00FF">shl di,2
        lea bx,xpos
        add di,bx                       </font><font color="#008000"><i>{ di points to xpos[y,0] }
</i></font><font color="#FF00FF">@Show:  mov y,ax                        </font><font color="#008000"><i>{ repeat ... }
        </i></font><font color="#FF00FF">mov cx,[di]
        mov dx,[di+2]
        mov px1,cx
        mov px2,dx
        push ax
        push di
        call @xhlin                     </font><font color="#008000"><i>{ xhlin(px1,px2,y,c) }
        </i></font><font color="#FF00FF">pop di
        pop ax
        add di,4                        </font><font color="#008000"><i>{ Next xpos }
        </i></font><font color="#FF00FF">inc ax                          </font><font color="#008000"><i>{ inc(y) }
        </i></font><font color="#FF00FF">cmp ax,mxy                      </font><font color="#008000"><i>{ ... until y&gt;mxy; }
        </i></font><font color="#FF00FF">jle @Show
        jmp @pexit

</font><font color="#008000"><i>{ RangeChk }

</i></font><font color="#FF00FF">@Range: pop di                          </font><font color="#008000"><i>{ Get return IP }
        </i></font><font color="#FF00FF">pop py2                         </font><font color="#008000"><i>{ Get params }
        </i></font><font color="#FF00FF">pop px2
        pop py1
        pop px1
        push di                         </font><font color="#008000"><i>{ Save return IP }

        </i></font><font color="#FF00FF">mov ax,py1                      </font><font color="#008000"><i>{ dir:=byte(y1&lt;y2) }
        </i></font><font color="#FF00FF">cmp ax,py2
        mov ax,1
        jl @Rdwn
        dec al
@Rdwn:  mov dir,al

        shl al,1
        push ax
        shl al,2
        sub ax,4
        mov stb,ax                      </font><font color="#008000"><i>{ stb:=8*dir-4 }
        </i></font><font color="#FF00FF">pop ax
        dec ax                          </font><font color="#008000"><i>{ s:=2*dir-1 }
        </i></font><font color="#FF00FF">mov s,ax                        </font><font color="#008000"><i>{ Check directions (-1= down, 1=up) }

        </i></font><font color="#FF00FF">test AH,10000000b               </font><font color="#008000"><i>{ Calculate constants }
        </i></font><font color="#FF00FF">mov dx,0
        jz @Rposi
        dec dx
@Rposi: mov bx,px2
        sub bx,px1
        imul bx
        mov mult,ax                     </font><font color="#008000"><i>{ mult:=s*(x2-x1) }
        </i></font><font color="#FF00FF">mov ax,py2
        mov bx,py1
        mov cx,ax
        sub ax,bx
        mov divi,ax                     </font><font color="#008000"><i>{ divi:=y2-y1 }

        </i></font><font color="#FF00FF">cmp bx,cx                       </font><font color="#008000"><i>{ &uml;y1=y2? }

        </i></font><font color="#FF00FF">pushf                           </font><font color="#008000"><i>{ Calculate pointer to xpos[y,dir] }
        </i></font><font color="#FF00FF">mov y,bx                        </font><font color="#008000"><i>{ y:=y1 }
        </i></font><font color="#FF00FF">mov di,bx
        shl di,2
        lea bx,xpos
        add di,bx
        mov cl,dir
        mov ch,0
        shl cl,1
        add di,cx                       </font><font color="#008000"><i>{ di points to xpos[y,dir] }
        </i></font><font color="#FF00FF">popf

        je @Requ                        </font><font color="#008000"><i>{ if y1=y2 ==&gt; @Requ }

        </i></font><font color="#FF00FF">mov m,0                         </font><font color="#008000"><i>{ m:=0 }
        </i></font><font color="#FF00FF">mov ax,py2
        add ax,s
        mov top,ax                      </font><font color="#008000"><i>{ top:=y2+s }

</i></font><font color="#FF00FF">@RLoop: mov ax,y                        </font><font color="#008000"><i>{ repeat ... }
        </i></font><font color="#FF00FF">cmp ax,mny                      </font><font color="#008000"><i>{ if y&lt;mny ==&gt; @RNext }
        </i></font><font color="#FF00FF">jl @RNext
        cmp ax,mxy                      </font><font color="#008000"><i>{ if y&gt;mxy ==&gt; @RNext }
        </i></font><font color="#FF00FF">jg @RNext

        mov ax,m                        </font><font color="#008000"><i>{ Calculate int(m/divi)+x1 }
        </i></font><font color="#FF00FF">test AH,10000000b
        mov dx,0
        jz @RLpos
        dec dx
@RLpos: mov bx,divi
        idiv bx
        add ax,px1
        call @HR                        </font><font color="#008000"><i>{ HorRangeChk(m div divi+x1) }

</i></font><font color="#FF00FF">@RNext: mov ax,mult
        add m,ax                        </font><font color="#008000"><i>{ inc(m,mult) }
        </i></font><font color="#FF00FF">add di,stb                      </font><font color="#008000"><i>{ Next xpos }
        </i></font><font color="#FF00FF">mov ax,y                        </font><font color="#008000"><i>{ inc(y,s) }
        </i></font><font color="#FF00FF">add ax,s
        mov y,ax
        cmp ax,top
        jne @RLoop                      </font><font color="#008000"><i>{ ... until y=top }
        </i></font><font color="#FF00FF">jmp @Rexit

@Requ:  mov ax,y
        cmp ax,mny                      </font><font color="#008000"><i>{ if y&lt;mny ==&gt; Exit }
        </i></font><font color="#FF00FF">jl @Rexit
        cmp ax,mxy                      </font><font color="#008000"><i>{ if y&gt;mxy ==&gt; Exit }
        </i></font><font color="#FF00FF">jg @Rexit
        mov ax,px1
        call @HR                        </font><font color="#008000"><i>{ HorRangeChk(px1) }
</i></font><font color="#FF00FF">@Rexit: jmp @exit

</font><font color="#008000"><i>{ HorRangeChk }

</i></font><font color="#FF00FF">@HR:    mov bx,minx                     </font><font color="#008000"><i>{ bx:=minx }
        </i></font><font color="#FF00FF">cmp ax,bx
        jl @HRsav
        mov bx,maxx                     </font><font color="#008000"><i>{ bx:=maxx }
        </i></font><font color="#FF00FF">cmp ax,bx
        jg @HRsav
        mov bx,ax
@HRsav: mov [di],bx                     </font><font color="#008000"><i>{ xpos[y,dir]:=bx }
        </i></font><font color="#FF00FF">jmp @exit
</font><font color="#008000"><i>{ xhlin }

</i></font><font color="#FF00FF">@xhlin: mov es,vidseg
        cld
        mov ax,80
        mul y
        mov di,ax                       </font><font color="#008000"><i>{ base of scan line }
        </i></font><font color="#FF00FF">add di,address

        mov bx,px1                      </font><font color="#008000"><i>{ px1 = x begin coord }
        </i></font><font color="#FF00FF">mov dx,px2                      </font><font color="#008000"><i>{ px2 = x end coord }
        </i></font><font color="#FF00FF">cmp bx,dx
        jb @skip
        xchg bx,dx                      </font><font color="#008000"><i>{ switch coords if px1&gt;px2 }

</i></font><font color="#FF00FF">@skip:  mov cl,bl
        shr bx,2
        mov ch,dl
        shr dx,2
        and cx,$0303
        sub dx,bx                       </font><font color="#008000"><i>{ width in Bytes }
        </i></font><font color="#FF00FF">add di,bx                       </font><font color="#008000"><i>{ offset into video buffer }
        </i></font><font color="#FF00FF">mov ax,$ff02
        shl ah,cl
        and ah,1111b                    </font><font color="#008000"><i>{ left edge mask }
        </i></font><font color="#FF00FF">mov cl,ch
        mov bh,$f1
        rol bh,cl
        and bh,1111b                    </font><font color="#008000"><i>{ right edge mask }
        </i></font><font color="#FF00FF">mov cx,dx
        or cx,cx
        jnz @left
        and ah,bh                       </font><font color="#008000"><i>{ combine left &amp; right bitmasks }

</i></font><font color="#FF00FF">@left:  mov dx,$03c4
        out dx,ax
        inc dx
        mov al,c
        stosb
        jcxz @exit
        dec cx
        jcxz @right
        mov al,1111b
        out dx,al                       </font><font color="#008000"><i>{ skipped if cx=0,1 }
        </i></font><font color="#FF00FF">mov al,c
        repz stosb                      </font><font color="#008000"><i>{ fill middle Bytes }

</i></font><font color="#FF00FF">@right: mov al,bh
        out dx,al                       </font><font color="#008000"><i>{ skipped if cx=0 }
        </i></font><font color="#FF00FF">mov al,c
        stosb

@exit:  pop ax
        push cs
        push ax
        ret
@pexit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$f+}

</i></font><font color="#FF0000"><b>Function </b></font>cosinus<font color="#000080">(</font>i<font color="#000080">:</font>byte<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>cosinus<font color="#000080">:=</font>ctab<font color="#000080">[</font>i<font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>sinus<font color="#000080">(</font>i<font color="#000080">:</font>byte<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>sinus<font color="#000080">:=</font>stab<font color="#000080">[</font>i<font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Initialize<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>i<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>triangles<font color="#000080">:=</font>False<font color="#000080">;
 </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do </b></font>ctab<font color="#000080">[</font>i<font color="#000080">]:=</font>round<font color="#000080">(-</font>cos<font color="#000080">(</font>i<font color="#000080">*</font>pi<font color="#000080">/</font><font color="#800000">128</font><font color="#000080">)*</font>divd<font color="#000080">);
 </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do </b></font>stab<font color="#000080">[</font>i<font color="#000080">]:=</font>round<font color="#000080">(</font>sin<font color="#000080">(</font>i<font color="#000080">*</font>pi<font color="#000080">/</font><font color="#800000">128</font><font color="#000080">)*</font>divd<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
 </b></font>Initialize<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0132.PAS">Original</a><b>]</b></p></body>
</html>
