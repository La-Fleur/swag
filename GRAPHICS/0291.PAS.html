<html>
<head><title> "Draw 320x200 in X-Mode" by KJETIL FURNES</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0291.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000080">&gt;&gt; </font>I need <font color="#FF0000"><b>to </b></font>put a <font color="#800000">64</font>k Raw Image onto Page <font color="#800000">0 </font><font color="#FF0000"><b>in </b></font><font color="#800000">320</font>x200 X<font color="#000080">-</font>Mode<font color="#000080">.
&gt;
&gt; </font>Bas van Gaalen
<font color="#000080">&gt;</font>Well<font color="#000080">, </font>that wasn<font color="#800000">'t too hard. Faster then the following one doesn'</font>t seem
<font color="#000080">&gt;</font>possible<font color="#000080">. </font>Don<font color="#800000">'t try to make the f_bufsize too large: it'</font>ll probably hang your
<font color="#000080">&gt;</font>computer <font color="#FF0000"><b>and </b></font>it won<font color="#800000">'t speed up the picture display. You could, however, set the
</font><font color="#000080">&gt;</font>palette <font color="#FF0000"><b>to </b></font>all black when displaying the picture<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>when it<font color="#800000">'s ready, set the
</font><font color="#000080">&gt;</font>colors <font color="#FF0000"><b>of </b></font>the picture correctly<font color="#000080">.

</font>Actually<font color="#000080">, </font>you can make it a lot faster<font color="#000080">.
</font>Since I haven<font color="#800000">'t seen the original post, there is no way for me to know what
</font>you need this <font color="#FF0000"><b>for</b></font><font color="#000080">, </font>but <font color="#FF0000"><b>to </b></font>speed up execution speed<font color="#000080">, </font>I<font color="#800000">'ve divided it into
</font>two files<font color="#000080">, </font>raw2mxi<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>viewmxi<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>it <font color="#FF0000"><b>is </b></font>intended <font color="#FF0000"><b>for </b></font>a viewer <font color="#000080">(</font>but
<font color="#FF0000"><b>then </b></font>you wouldn<font color="#800000">'t use mode X at all, I guess), there should be no problems
</font>rewriting it<font color="#000080">, </font>sorry <font color="#FF0000"><b>for </b></font>the slow disk read<font color="#000080">/</font>write routines<font color="#000080">, </font>but I<font color="#800000">'m a little
</font>rusty <font color="#FF0000"><b>in Pascal</b></font><font color="#000080">. (</font>Haven<font color="#800000">'t used it the last half year.)
</font>There <font color="#FF0000"><b>is </b></font>two differences<font color="#000080">, </font>one I write <font color="#FF0000"><b>to </b></font>the change plane ports <font color="#800000">4 </font>times
<font color="#FF0000"><b>while </b></font>van Gaalen wrote <font color="#FF0000"><b>to </b></font>the ports each time he drew a pixel<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>when I
draw<font color="#000080">, </font>I just use int <font color="#800000">21 </font><font color="#000080">(</font>Yes<font color="#000080">, </font>I know this might be slower<font color="#000080">, </font>but <font color="#FF0000"><b>on </b></font>slower
machines<font color="#000080">, </font>you may actually gain speed <font color="#FF0000"><b>on </b></font>slower systems because the DOS
<font color="#FF0000"><b>file </b></font>handler <font color="#FF0000"><b>uses </b></font>DMA <font color="#FF0000"><b>to </b></font>write directly <font color="#FF0000"><b>to </b></font>the memory area<font color="#000080">.

---------- </font>cut here <font color="#000080">----------- </font>start <font color="#000080">---------------- </font>raw2mxi<font color="#000080">.</font>pas <font color="#000080">------------

</font><font color="#008000"><i>{$A+,B-,D+,E+,F-,G+,I+,L+,N+,O-,P-,Q-,R-,S+,T-,V+,X+} { TP7.0 Directives }
{$M 16384,0,655360}


</i></font><font color="#FF0000"><b>PROGRAM </b></font>OptimizeImageForModeX<font color="#000080">;
</font><font color="#008000"><i>{ Program to optimize raw images for mode X, written by Kjetil Furnes, AKA
  ShadowBeam. E-Mail: hefurnes@online.no
  it assumes that the given file is a raw image without a header (i.e. it
  only contains the pixel color information. I leave it up to the coder to
  add the pallette since he wanted it to be a raw image (for the uninitated,
  a raw image is basically a string of bytes. There is nothing that indicates
  the pallette, the size of the image or anything.

  And yes, I know I could probably optimize this code a lot, but I'm lazy :)
  and this doesn't affect run-time of the other part of the program.
}


</i></font><font color="#FF0000"><b>USES
  </b></font>CRT<font color="#000080">, </font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>f<font color="#000080">: </font><font color="#FF0000"><b>FILE OF </b></font>BYTE<font color="#000080">;
  </font>T<font color="#000080">: </font><font color="#FF0000"><b>FILE OF </b></font>BYTE<font color="#000080">;

  </font>buffer<font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63999</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
  </font>ca<font color="#000080">, </font>cb<font color="#000080">, </font>cc<font color="#000080">: </font>WORD<font color="#000080">;



</font><font color="#FF0000"><b>FUNCTION </b></font>InFile<font color="#000080">(</font>FileName<font color="#000080">: </font>PathStr<font color="#000080">): </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  IF </b></font>FileName <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Please supply a raw-image filename.'</font><font color="#000080">);
    </font>InFile <font color="#000080">:= </font>False<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>Assign<font color="#000080">(</font>f<font color="#000080">, </font>FileName<font color="#000080">);
  </font><font color="#008000"><i>{$I-} </i></font>Reset<font color="#000080">(</font>f<font color="#000080">); </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>IF </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WriteLn<font color="#000080">(</font>fexpand<font color="#000080">(</font>filename<font color="#000080">) + </font><font color="#800000">' not found.'</font><font color="#000080">);
    </font>InFile <font color="#000080">:= </font>False<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">push DS
    mov BX, SEG f
    mov DS, BX
    lea BX, [f]
    mov BX, [BX]
    pop DS
    lea DX, [buffer]

    mov BX, SI
    mov AH, 3Fh
    mov CX, 16000
    int 21h

  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>FOR </b></font>ca <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">63999  </font><font color="#FF0000"><b>DO </b></font>Read<font color="#000080">(</font>f<font color="#000080">, </font>buffer<font color="#000080">[</font>ca<font color="#000080">]);
  </font>Close<font color="#000080">(</font>f<font color="#000080">);
  </font>InFile <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>OutFile<font color="#000080">(</font>P<font color="#000080">: </font>PathStr<font color="#000080">);
</font><font color="#FF0000"><b>VAR </b></font>D<font color="#000080">: </font>DirStr<font color="#000080">; </font>N<font color="#000080">: </font>NameStr<font color="#000080">; </font>E<font color="#000080">: </font>ExtStr<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>FSplit<font color="#000080">(</font>P<font color="#000080">, </font>D<font color="#000080">, </font>N<font color="#000080">, </font>E<font color="#000080">);
  </font>E <font color="#000080">:= </font><font color="#800000">'.mxi'</font><font color="#000080">;
  </font>P <font color="#000080">:= </font>D <font color="#000080">+ </font>N <font color="#000080">+ </font>E<font color="#000080">;
  </font>Assign<font color="#000080">(</font>T<font color="#000080">, </font>P<font color="#000080">);
  </font>rewrite<font color="#000080">(</font>T<font color="#000080">);
  </font><font color="#FF0000"><b>FOR </b></font>cc <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">3 </font><font color="#FF0000"><b>DO BEGIN
      </b></font>cb <font color="#000080">:= </font>cc<font color="#000080">;
    </font><font color="#FF0000"><b>FOR </b></font>ca <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">15999 </font><font color="#FF0000"><b>DO BEGIN
        </b></font>Write<font color="#000080">(</font>T<font color="#000080">, </font>buffer<font color="#000080">[</font>cb<font color="#000080">]);
        </font>cb <font color="#000080">:= </font>cb <font color="#000080">+ </font><font color="#800000">4</font><font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>Close<font color="#000080">(</font>T<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'File was successfully completed.'</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>BEGIN
  IF </b></font>InFile<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)) </font><font color="#FF0000"><b>THEN </b></font>OutFile<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

---------- </font>cut here <font color="#000080">------------ </font><font color="#FF0000"><b>end </b></font><font color="#000080">----------------- </font>raw2mxi<font color="#000080">.</font>pas <font color="#000080">------------
---------- </font>cut here <font color="#000080">----------- </font>start <font color="#000080">---------------- </font>mxidraw<font color="#000080">.</font>pas <font color="#000080">------------

</font><font color="#008000"><i>{$A+,B-,D+,E+,F-,G+,I+,L+,N+,O-,P-,Q-,R-,S+,T-,V+,X+} { TP7.0 Directives }
{$M 16384,0,655360}


</i></font><font color="#FF0000"><b>PROGRAM </b></font>DrawModeXImage<font color="#000080">;
</font><font color="#008000"><i>{ Program to display mxi images in mode X 320x200x256, written by Kjetil
  Furnes, AKA ShadowBeam. E-Mail: hefurnes@online.no
  it assumes that the given file is a mxi image, that is, a raw image
  converted by the raw2mxi (and in case you are wondering. Mode X Image)

  Oh, and close an image file before you open another, you don't have an
  endless amount of file allocation space.
}
</i></font><font color="#FF0000"><b>uses
  </b></font>CRT<font color="#000080">, </font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>f<font color="#000080">: </font><font color="#FF0000"><b>FILE OF </b></font>BYTE<font color="#000080">;
  </font>video    <font color="#000080">:</font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63999</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE <font color="#FF0000"><b>ABSOLUTE </b></font><font color="#800000">$0A000</font><font color="#000080">:</font><font color="#800000">$0</font><font color="#000080">;
  </font>ca<font color="#000080">, </font>cb<font color="#000080">, </font>cc<font color="#000080">: </font>WORD<font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>SetModeX<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">mov AX, 13h;
    int 10h;
    mov DX, 3C4h;
    mov AX, 0604h;
    out DX, AX;
    mov AX, 0F02h
    out DX, AX;
    mov CX, 64000;
    mov AX, 0A000h;
    mov ES, AX
    xor AX, AX;
    mov DI, AX;
rep stosw
    mov DX, 3D4h;
    mov AX, 0014h;
    out DX, AX;
    mov AX, 0E317h;
    out DX, AX;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Retrace<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">mov DX, 3DAh;
@V1:
    in AL, DX;
    test AL, 8;
    jz @V1
@V2:
    in AL, DX;
    test AL, 8;
    jnz @V2;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;




</font><font color="#FF0000"><b>FUNCTION </b></font>LoadMXI<font color="#000080">(</font>FileName<font color="#000080">: </font>PathStr<font color="#000080">): </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  IF </b></font>FileName <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Please supply a mxi-image filename.'</font><font color="#000080">);
    </font>LoadMXI <font color="#000080">:= </font>False<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>Assign<font color="#000080">(</font>f<font color="#000080">,</font>FileName<font color="#000080">);
  </font><font color="#008000"><i>{$I-} </i></font>Reset<font color="#000080">(</font>f<font color="#000080">); </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>IF </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WriteLn<font color="#000080">(</font>fexpand<font color="#000080">(</font>filename<font color="#000080">) + </font><font color="#800000">' not found.'</font><font color="#000080">);
    </font>LoadMXI <font color="#000080">:= </font>False<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>LoadMXI <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>DrawMXI<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  ASM
    </b></font><font color="#FF00FF">push DS
    push SI
    mov SI, SEG f
    mov DS, SI
    lea SI, [f]
    mov SI, [SI]
    mov AX, 0A000h
    mov DS, AX

    mov DX, 03C4h;
    mov AX, 102h;
    out DX, AX;

    xor DX, DX
    mov BX, SI
    mov AH, 3Fh
    mov CX, 16000
    int 21h

    mov DX, 03C4h;
    mov AX, 202h;
    out DX, AX;

    xor DX, DX
    mov BX, SI
    mov AH, 3Fh
    mov CX, 16000
    int 21h

    mov DX, 03C4h;
    mov AX, 402h;
    out DX, AX;

    xor DX, DX
    mov BX, SI
    mov AH, 3Fh
    mov CX, 16000
    int 21h

    mov DX, 03C4h;
    mov AX, 802h;
    out DX, AX;

    xor DX, DX
    mov BX, SI
    mov AH, 3Fh
    mov CX, 16000
    int 21h

    pop SI
    pop DS
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>Reset<font color="#000080">(</font>f<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>BEGIN
  IF </b></font>LoadMXI<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)) = </font>FALSE <font color="#FF0000"><b>THEN </b></font>Exit<font color="#000080">;
  </font>SetModeX<font color="#000080">;
  </font>Retrace<font color="#000080">;

  </font>DrawMXI<font color="#000080">;

  </font>ReadKey<font color="#000080">;
  </font>Close<font color="#000080">(</font>f<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

---------- </font>cut here <font color="#000080">------------ </font><font color="#FF0000"><b>end </b></font><font color="#000080">----------------- </font>mxidraw<font color="#000080">.</font>pas <font color="#000080">------------


</font>That<font color="#800000">'s all I guess.

</font>Just <font color="#FF0000"><b>to </b></font>be <font color="#FF0000"><b>on </b></font>the safe side<font color="#000080">:
</font>I<font color="#800000">'m allowing anyone to use this code without any restrictions or legalities,
</font><font color="#FF0000"><b>except </b></font>that the one who compiles this code takes responsibility <font color="#FF0000"><b>for </b></font>what
happens <font color="#FF0000"><b>with </b></font>the machine<font color="#000080">, </font>this code will work <font color="#FF0000"><b>if </b></font>the machine <font color="#FF0000"><b>is set </b></font>up
correctly<font color="#000080">, </font>but I don<font color="#800000">'t know how it'</font>ll work <font color="#FF0000"><b>on </b></font>a machine without a vga
compatible device connected since the code write <font color="#FF0000"><b>to </b></font>some <font color="#FF0000"><b>of </b></font>its prots<font color="#000080">.


</font>						<font color="#000080">- </font>Kjetil Furnes
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0291.PAS">Original</a><b>]</b></p></body>
</html>
