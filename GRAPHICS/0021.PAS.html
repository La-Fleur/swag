<html>
<head><title> "ModeX Code" by MARK DIXON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
MARK DIXON

Um, have a look at this, and see what you can come up with. It's some code I
wrote a while back to use mode-x and do double buffering (or page-flipping).
}

</i></font><font color="#FF0000"><b>Program </b></font>Test_ModeX<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>crt<font color="#000080">;


</font><font color="#008000"><i>{ This program will put the VGA card into a MODEX mode (still only 320x200)
  and demonstrate double buffering (page flipping)

  This program was written by Mark Dixon, and has been donated to the
  Public Domain with the exception that if you make use of these routines,
  the author of these routines would appreciate his name mentioned somewhere
  in the documentation.

  Use these routines at your own risk! Because they use the VGA's registers,
  cards that are not 100% register compatible may not function correctly, and
  may even be damaged. The author will bear no responsability for any actions
  occuring as a direct (or even indirect) result of the use of this program.

  Any donations (eg Money, Postcards, death threats.. ) can be sent to  :

  Mark Dixon
  12 Finchley St
  Lynwood,
  Western Australia
  6147

  If you have Netmail access, then I can also be contacted on 3:690/660.14

  }

</i></font><font color="#FF0000"><b>Const
  </b></font>Page <font color="#000080">: </font>Byte <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">, </font>J <font color="#000080">: </font>Word<font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>InitModeX<font color="#000080">;
</font><font color="#008000"><i>{ Sets up video mode to Mode X (320x200x256 with NO CHAIN4) making available
  4 pages of 4x16k bitmaps }
</i></font><font color="#FF0000"><b>Begin
  asm
    </b></font><font color="#FF00FF">mov    ax, 0013h    </font><font color="#008000"><i>{ Use bios to enter standard Mode 13h }
    </i></font><font color="#FF00FF">int    10h
    mov    dx, 03c4h    </font><font color="#008000"><i>{ Set up DX to one of the VGA registers }
    </i></font><font color="#FF00FF">mov    al, 04h      </font><font color="#008000"><i>{ Register = Sequencer : Memory Modes }
    </i></font><font color="#FF00FF">out    dx, al
    inc    dx           </font><font color="#008000"><i>{ Now get the status of the register }
    </i></font><font color="#FF00FF">in     al, dx       </font><font color="#008000"><i>{ from the next port }
    </i></font><font color="#FF00FF">and    al, 0c7h     </font><font color="#008000"><i>{ AND it with 11000111b ie, bits 3,4,5 wiped }
    </i></font><font color="#FF00FF">or     al, 04h      </font><font color="#008000"><i>{ Turn on bit 2 (00000100b) }
    </i></font><font color="#FF00FF">out    dx, al       </font><font color="#008000"><i>{ and send it out to the register }
    </i></font><font color="#FF00FF">mov    dx, 03c4h    </font><font color="#008000"><i>{ Again, get ready to activate a register }
    </i></font><font color="#FF00FF">mov    al, 02h      </font><font color="#008000"><i>{ Register = Map Mask }
    </i></font><font color="#FF00FF">out    dx, al
    inc    dx
    mov    al, 0fh      </font><font color="#008000"><i>{ Send 00001111b to Map Mask register }
    </i></font><font color="#FF00FF">out    dx, al       </font><font color="#008000"><i>{ Setting all planes active }
    </i></font><font color="#FF00FF">mov    ax, 0a000h   </font><font color="#008000"><i>{ VGA memory segment is 0a000h }
    </i></font><font color="#FF00FF">mov    es, ax       </font><font color="#008000"><i>{ load it into ES }
    </i></font><font color="#FF00FF">sub    di, di       </font><font color="#008000"><i>{ clear DI }
    </i></font><font color="#FF00FF">mov    ax, di       </font><font color="#008000"><i>{ clear AX }
    </i></font><font color="#FF00FF">mov    cx, 8000h    </font><font color="#008000"><i>{ set entire 64k memory area (all 4 pages) }
    </i></font><font color="#FF00FF">repnz  stosw        </font><font color="#008000"><i>{ to colour BLACK (ie, Clear screens) }
    </i></font><font color="#FF00FF">mov    dx, 03d4h    </font><font color="#008000"><i>{ User another VGA register }
    </i></font><font color="#FF00FF">mov    al, 14h      </font><font color="#008000"><i>{ Register = Underline Location }
    </i></font><font color="#FF00FF">out    dx, al
    inc    dx           </font><font color="#008000"><i>{ Read status of register }
    </i></font><font color="#FF00FF">in     al, dx       </font><font color="#008000"><i>{ into AL }
    </i></font><font color="#FF00FF">and    al, 0bFh     </font><font color="#008000"><i>{ AND AL with 10111111b }
    </i></font><font color="#FF00FF">out    dx, al       </font><font color="#008000"><i>{ and send it to the register }
                        { to deactivate Double Word mode addressing }
    </i></font><font color="#FF00FF">dec    dx           </font><font color="#008000"><i>{ Okay, this time we want another register,}
    </i></font><font color="#FF00FF">mov    al, 17h      </font><font color="#008000"><i>{ Register = CRTC : Mode Control }
    </i></font><font color="#FF00FF">out    dx, al
    inc    dx
    in     al, dx       </font><font color="#008000"><i>{ Get status of this register }
    </i></font><font color="#FF00FF">or     al, 40h      </font><font color="#008000"><i>{ and Turn the 6th bit ON }
    </i></font><font color="#FF00FF">out    dx, al       </font><font color="#008000"><i>{ to turn WORD mode off }
                        { And thats all there is too it!}
  </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>Flip<font color="#000080">;
</font><font color="#008000"><i>{ This routine will flip to the next page, and change the value in
  PAGE such that we will allways be drawing to the invisible page. }
</i></font><font color="#FF0000"><b>Var
  </b></font>OfsAdr <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>OfsAdr <font color="#000080">:= </font>Page <font color="#000080">* </font><font color="#800000">16000</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov    dx, 03D4h
    mov    al, 0Dh      </font><font color="#008000"><i>{ Set the Start address LOW register }
    </i></font><font color="#FF00FF">out    dx, al
    inc    dx

    mov    ax, OfsAdr
    out    dx, al       </font><font color="#008000"><i>{ by sending low byte of offset address }
    </i></font><font color="#FF00FF">dec    dx
    mov    al, 0Ch      </font><font color="#008000"><i>{ now set the Start Address HIGH register }
    </i></font><font color="#FF00FF">out    dx, al
    inc    dx
    mov    al, ah
    out    dx, al       </font><font color="#008000"><i>{ by sending high byte of offset address }
  </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font>Page <font color="#000080">:= </font><font color="#800000">1 </font><font color="#000080">- </font>Page<font color="#000080">;     </font><font color="#008000"><i>{ Flip the page value.
                          Effectively does a :
                          If Page = 0 then Page = 1 else
                          If Page = 1 then Page = 0.       }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;



</font><font color="#FF0000"><b>Procedure </b></font>PutPixel <font color="#000080">(</font>X<font color="#000080">, </font>Y <font color="#000080">: </font>Integer<font color="#000080">; </font>Colour <font color="#000080">: </font>Byte <font color="#000080">);
</font><font color="#008000"><i>{ Puts a pixel on the screen at the current page. }
</i></font><font color="#FF0000"><b>Var
  </b></font>OfsAdr <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>OfsAdr <font color="#000080">:= </font>Page <font color="#000080">* </font><font color="#800000">16000</font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">mov    bx, x
    mov    ax, Y
    mov    cx, 80     </font><font color="#008000"><i>{ Since there are now 4 pixels per byte, we
                        only multiply by 80 (320/4) }
    </i></font><font color="#FF00FF">mul    cx
    mov    di, ax
    mov    ax, bx
    shr    ax, 1
    shr    ax, 1
    add    di, ax
    and    bx, 3
    mov    ah, 1
    mov    cl, bl
    shl    ah, cl

    mov    al, 2
    mov    dx, 03C4h

    mov    bx, $A000
    mov    es, bx
    add    di, OfsAdr

    out    dx, ax        </font><font color="#008000"><i>{ Set plane to address (where AH=Plane) }
    </i></font><font color="#FF00FF">mov    al, Colour
    mov    es:[di], al
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Randomize<font color="#000080">;
  </font>InitModeX<font color="#000080">;
  </font>Flip<font color="#000080">;

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">319 </font><font color="#FF0000"><b>do
    For </b></font>J <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">199 </font><font color="#FF0000"><b>do
      </b></font>PutPixel<font color="#000080">(</font>I<font color="#000080">, </font>J<font color="#000080">, </font>Random<font color="#000080">(</font><font color="#800000">32</font><font color="#000080">) );
  </font>Flip<font color="#000080">;

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">319 </font><font color="#FF0000"><b>do
    For </b></font>J <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">199 </font><font color="#FF0000"><b>do
      </b></font>PutPixel<font color="#000080">(</font>I<font color="#000080">, </font>J<font color="#000080">, </font>Random<font color="#000080">(</font><font color="#800000">32</font><font color="#000080">) + </font><font color="#800000">32</font><font color="#000080">);

  </font><font color="#FF0000"><b>Repeat
    </b></font>Flip<font color="#000080">;
    </font>Delay<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font>Keypressed<font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p></body>
</html>
