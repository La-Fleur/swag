<html>
<head><title> "Pcx Viewer!" by JAMES COOK</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0115.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>Uses </b></font>Crt<font color="#000080">;
</font><font color="#008000"><i>{ Sample program to display a 320x200x256 PCX in
  mode 13h.  PCX source copied from MCGA07, a MCGA
  graphics unit written by James Cook in his MCGA
  programming tutorial on Quantum Leap BBS }

</i></font><font color="#FF0000"><b>TYPE
  </b></font>TPalette <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>PalettePtr <font color="#000080">= ^</font>TPalette<font color="#000080">;
</font><font color="#008000"><i>{ PCX stuff }
  </i></font>PCXHeaderPtr<font color="#000080">=  ^</font>PCXHeader<font color="#000080">;
  </font>PCXHeader   <font color="#000080">=  </font><font color="#FF0000"><b>record
                   </b></font>Signature      <font color="#000080">:  </font>Char<font color="#000080">;
                   </font>Version        <font color="#000080">:  </font>Char<font color="#000080">;
                   </font>Encoding       <font color="#000080">:  </font>Char<font color="#000080">;
                   </font>BitsPerPixel   <font color="#000080">:  </font>Char<font color="#000080">;
                   </font>XMin<font color="#000080">,</font>YMin<font color="#000080">,
                   </font>XMax<font color="#000080">,</font>YMax      <font color="#000080">:  </font>Integer<font color="#000080">;
                   </font>HRes<font color="#000080">,</font>VRes      <font color="#000080">:  </font>Integer<font color="#000080">;
                   </font>Palette        <font color="#000080">:  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">47</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                   </font>Reserved       <font color="#000080">:  </font>Char<font color="#000080">;
                   </font>Planes         <font color="#000080">:  </font>Char<font color="#000080">;
                   </font>BytesPerLine   <font color="#000080">:  </font>Integer<font color="#000080">;
                   </font>PaletteType    <font color="#000080">:  </font>Integer<font color="#000080">;
                   </font>Filler         <font color="#000080">:  </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">57</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ExtractLineASM <font color="#000080">(</font>BytesWide<font color="#000080">:</font>Integer<font color="#000080">;</font><font color="#FF0000"><b>Var </b></font>Source<font color="#000080">,</font>Dest<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>DestSeg<font color="#000080">,
  </font>DestOfs<font color="#000080">,
  </font>SourceSeg<font color="#000080">,
  </font>SourceOfs   <font color="#000080">:  </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>SourceSeg <font color="#000080">:= </font>Seg <font color="#000080">(</font>Source<font color="#000080">^);
  </font>SourceOfs <font color="#000080">:= </font>Ofs <font color="#000080">(</font>Source<font color="#000080">^);
  </font>DestSeg   <font color="#000080">:= </font>Seg <font color="#000080">(</font>Dest<font color="#000080">^);
  </font>DestOfs   <font color="#000080">:= </font>Ofs <font color="#000080">(</font>Dest<font color="#000080">^);

  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push  ds
    push  si

    cld

    mov   ax,DestSeg
    mov   es,ax
    mov   di,DestOfs     </font><font color="#008000"><i>{ es:di -&gt; destination pointer }
    </i></font><font color="#FF00FF">mov   ax,SourceSeg
    mov   ds,ax
    mov   si,SourceOfs   </font><font color="#008000"><i>{ ds:si -&gt; source buffer }

    </i></font><font color="#FF00FF">mov   bx,di
    add   bx,BytesWide   </font><font color="#008000"><i>{ bx holds position to stop for this row }
    </i></font><font color="#FF00FF">xor   cx,cx

  @@GetNextByte:
    cmp   bx,di          </font><font color="#008000"><i>{ are we done with the line }
    </i></font><font color="#FF00FF">jbe   @@ExitHere

    lodsb                </font><font color="#008000"><i>{ al contains next byte }

    </i></font><font color="#FF00FF">mov   ah,al
    and   ah,0C0h
    cmp   ah,0C0h

    jne    @@SingleByte
                         </font><font color="#008000"><i>{ must be a run of bytes }
    </i></font><font color="#FF00FF">mov   cl,al
    and   cl,3Fh
    lodsb
    rep   stosb
    jmp   @@GetNextByte

  @@SingleByte:
    stosb
    jmp   @@GetNextByte

  @@ExitHere:
    mov   SourceSeg,ds
    mov   SourceOfs,si
    mov   DestSeg,es
    mov   DestOfs,di

    pop   si
    pop   ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>Source <font color="#000080">:= </font>Ptr <font color="#000080">(</font>SourceSeg<font color="#000080">,</font>SourceOfs<font color="#000080">);
  </font>Dest   <font color="#000080">:= </font>Ptr <font color="#000080">(</font>DestSeg<font color="#000080">,</font>DestOfs<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DisplayPCX <font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">:</font>Integer<font color="#000080">;</font>Buf<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">,</font>NumRows<font color="#000080">,
  </font>BytesWide   <font color="#000080">:  </font>Integer<font color="#000080">;
  </font>Header      <font color="#000080">:  </font>PCXHeaderPtr<font color="#000080">;
  </font>DestPtr     <font color="#000080">:  </font>Pointer<font color="#000080">;
  </font>Offset      <font color="#000080">:  </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Header    <font color="#000080">:= </font>Ptr <font color="#000080">(</font>Seg<font color="#000080">(</font>Buf<font color="#000080">^),</font>Ofs<font color="#000080">(</font>Buf<font color="#000080">^));
  </font>Buf       <font color="#000080">:= </font>Ptr <font color="#000080">(</font>Seg<font color="#000080">(</font>Buf<font color="#000080">^),</font>Ofs<font color="#000080">(</font>Buf<font color="#000080">^)+</font><font color="#800000">128</font><font color="#000080">);
  </font>Offset    <font color="#000080">:= </font>Y <font color="#000080">* </font><font color="#800000">320 </font><font color="#000080">+ </font>X<font color="#000080">;
  </font>NumRows   <font color="#000080">:= </font>Header<font color="#000080">^.</font>YMax <font color="#000080">- </font>Header<font color="#000080">^.</font>YMin <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>BytesWide <font color="#000080">:= </font>Header<font color="#000080">^.</font>XMax <font color="#000080">- </font>Header<font color="#000080">^.</font>XMin <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>Odd <font color="#000080">(</font>BytesWide<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Inc <font color="#000080">(</font>BytesWide<font color="#000080">);

  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>NumRows <font color="#FF0000"><b>do begin
    </b></font>DestPtr <font color="#000080">:= </font>Ptr <font color="#000080">(</font><font color="#800000">$A000</font><font color="#000080">,</font>Offset<font color="#000080">);
    </font>ExtractLineASM <font color="#000080">(</font>BytesWide<font color="#000080">,</font>Buf<font color="#000080">,</font>DestPtr<font color="#000080">);
    </font>Inc <font color="#000080">(</font>Offset<font color="#000080">,</font><font color="#800000">320</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{ end PCX stuff }

</i></font><font color="#FF0000"><b>Procedure </b></font>Graph13h<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov al,$13
  mov ah,0
  int 10h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>F<font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;           </font><font color="#008000"><i>{ PCX file }
  </i></font>Hdr<font color="#000080">: </font>PCXHeaderPtr<font color="#000080">; </font><font color="#008000"><i>{ PCX header structure &amp; file }
  </i></font>Pal<font color="#000080">: </font>PalettePtr<font color="#000080">;   </font><font color="#008000"><i>{ PCX palette }
  </i></font>Shade<font color="#000080">, </font>Size<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ RGB shade, file size }

</i></font><font color="#FF0000"><b>BEGIN
  </b></font>Graph13h<font color="#000080">;                          </font><font color="#008000"><i>{ set mode 13h }
  </i></font>Assign<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">'filename.pcx'</font><font color="#000080">);         </font><font color="#008000"><i>{ open PCX file }
  </i></font>Reset<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>Size <font color="#000080">:= </font>FileSize<font color="#000080">(</font>F<font color="#000080">);
  </font>GetMem<font color="#000080">(</font>Hdr<font color="#000080">, </font>Size<font color="#000080">);                 </font><font color="#008000"><i>{ load PCX into memory }
  </i></font>Blockread<font color="#000080">(</font>F<font color="#000080">, </font>Hdr<font color="#000080">^, </font>Size<font color="#000080">);
  </font>Close<font color="#000080">(</font>F<font color="#000080">);
  </font>Pal <font color="#000080">:= </font>Ptr<font color="#000080">( </font>Seg<font color="#000080">(</font>Hdr<font color="#000080">^), </font>Ofs<font color="#000080">(</font>Hdr<font color="#000080">^) + </font>Size <font color="#000080">- </font><font color="#800000">768</font><font color="#000080">);    </font><font color="#008000"><i>{ get palette location }
  </i></font>Port<font color="#000080">[</font><font color="#800000">968</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;                                    </font><font color="#008000"><i>{ set palette }
  </i></font><font color="#FF0000"><b>FOR </b></font>Shade <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">767 </font><font color="#FF0000"><b>DO
    </b></font>Port<font color="#000080">[</font><font color="#800000">969</font><font color="#000080">] := </font>Pal<font color="#000080">^[</font>Shade<font color="#000080">] </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">2</font><font color="#000080">;
  </font>DisplayPCX<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>Hdr<font color="#000080">);                             </font><font color="#008000"><i>{ decode PCX to screen }
  </i></font><font color="#FF0000"><b>WHILE </b></font>Readkey <font color="#000080">&lt;&gt; </font><font color="#800000">#13 </font><font color="#FF0000"><b>DO</b></font><font color="#000080">;                           </font><font color="#008000"><i>{ wait for return key }
  </i></font>TextMode<font color="#000080">(</font>CO80<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0115.PAS">Original</a><b>]</b></p></body>
</html>
