<html>
<head><title> "FAST ASM Clipped Masking" by WESLEY BURNS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0248.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{Written By     : Wesley Burns                                               }
{Email          : microcon@iafrica.com                                       }

{Email: me if you have ANY questions about                                   }
{ : 64k DMA Sound Blaster Programming using XMS                              }
{ : Fast Memory Management                                                   }
{ : PCX using XMS                                                            }
{ : XMS Units                                                                }
{ : Pascal in general                                                        }
{ : Or if you have some fast procedures that you don't mind parting with.    }

</i></font><font color="#FF0000"><b>PROGRAM </b></font>FastClipMask<font color="#000080">;
</font><font color="#008000"><i>{values: . x,y         :coords of picture
         . width,height:width and height of picture
         . maskcolor   :color to leave out
         . Sprite      :Souce of picture(Pointer)
         . Dest        :Pointer of destionation e.g Dest = ptr($a000:0000)}

</i></font><font color="#FF0000"><b>var </b></font>Pic<font color="#000080">,</font>VScreen<font color="#000080">,</font>BScreen<font color="#000080">:</font>Pointer<font color="#000080">;
    </font>Counter<font color="#000080">:</font>word<font color="#000080">;
    </font>time<font color="#000080">:</font>real<font color="#000080">;
    </font>color<font color="#000080">:</font>integer<font color="#000080">;

</font><font color="#008000"><i>{General Timer}
 </i></font><font color="#FF0000"><b>Function </b></font>timer<font color="#000080">:</font>real<font color="#000080">;</font><font color="#FF0000"><b>begin  </b></font>timer<font color="#000080">:=</font>meml<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006c</font><font color="#000080">]/</font><font color="#800000">18.2</font><font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{Wait for vertical retrace, to stop flicker}
 </i></font><font color="#FF0000"><b>Procedure </b></font>WaitRetrace<font color="#000080">; </font><font color="#FF0000"><b>Begin while </b></font><font color="#000080">((</font>Port<font color="#000080">[</font><font color="#800000">$3DA</font><font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">8</font><font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do</b></font><font color="#000080">; </font><font color="#FF0000"><b>while 
</b></font><font color="#000080">((</font>Port<font color="#000080">[</font><font color="#800000">$3DA</font><font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">8</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do</b></font><font color="#000080">; </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{Much Faster that pascal Move Command}
 </i></font><font color="#FF0000"><b>procedure </b></font>DMove <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>source<font color="#000080">, </font>dest<font color="#000080">; </font>count<font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">push ds
   lds  si,source      </font><font color="#008000"><i>{ds,si = source}
   </i></font><font color="#FF00FF">les  di,dest        </font><font color="#008000"><i>{es,di = dest}
   </i></font><font color="#FF00FF">mov  cx,count       </font><font color="#008000"><i>{cx = count}
   </i></font><font color="#FF00FF">mov  ax,cx          </font><font color="#008000"><i>{ax = count}
   </i></font><font color="#FF00FF">cld
   shr  cx,2           </font><font color="#008000"><i>{cx = count / 4}
   </i></font><font color="#FF00FF">db   66h
   rep  movsw          </font><font color="#008000"><i>{copy double words}
   </i></font><font color="#FF00FF">mov  cl,al          </font><font color="#008000"><i>{get rest bytes}
   </i></font><font color="#FF00FF">and  cl,3
   rep  movsb          </font><font color="#008000"><i>{copy rest}
   </i></font><font color="#FF00FF">pop  ds
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{Mask Picture}
</i></font><font color="#FF0000"><b>Procedure </b></font>MaskPic<font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">,</font>Width<font color="#000080">,</font>Height<font color="#000080">:</font>integer<font color="#000080">; </font>Maskcolor<font color="#000080">:</font>byte<font color="#000080">; </font>Sprite<font color="#000080">, 
</font>Dest<font color="#000080">:</font>Pointer<font color="#000080">);
 </font><font color="#FF0000"><b>Begin

  If </b></font><font color="#000080">(</font>x <font color="#000080">&lt;= -</font>width<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>x <font color="#000080">&gt;= </font><font color="#800000">320</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>y <font color="#000080">&lt;= -</font>height<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>y <font color="#000080">&gt;= </font><font color="#800000">200</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
   </font><font color="#008000"><i>{The above command checks to seek if the picture TOTAL runs of the scneen.}
   {This is so, because if the below procedure is given a picture that falls}
   {total past &gt;= 320X200 then it screws up.}

 </i></font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">PUSH  DS             </font><font color="#008000"><i>{ save DS. Turbo Pascal automatically }
                        { saves other registers (ES SI DI)    }
   </i></font><font color="#FF00FF">LDS   SI,Sprite      </font><font color="#008000"><i>{ Make DS:SI point to image data }
   </i></font><font color="#FF00FF">MOV   AX,WIDTH       </font><font color="#008000"><i>{ store width in variable }
   </i></font><font color="#FF00FF">MOV   DX,AX
   PUSH  DX             </font><font color="#008000"><i>{ Save width for use with the }
                        { actual screen copying }
   </i></font><font color="#FF00FF">ADD   AX,X           </font><font color="#008000"><i>{ Add X to width, check for right side cut }
   </i></font><font color="#FF00FF">PUSH  Width          </font><font color="#008000"><i>{ save origonal width for possible top cutting }
   </i></font><font color="#FF00FF">CMP   AX,320         </font><font color="#008000"><i>{ Check for right side clipping }
   </i></font><font color="#FF00FF">JG    @RightCut
   SUB   AX,X           </font><font color="#008000"><i>{ Check for left side clipping }
   </i></font><font color="#FF00FF">JC    @LeftCut
   JMP   @CheckBottom   </font><font color="#008000"><i>{ no clipping necessary on sides }

 </i></font><font color="#FF00FF">@RightCut:
   SUB   AX,Width
   SUB   AX,320
   NEG   AX             </font><font color="#008000"><i>{ AX= -(new width), NEG to get + value }
   </i></font><font color="#FF00FF">MOV   Width,AX       </font><font color="#008000"><i>{ set new width according to rightclip }
   </i></font><font color="#FF00FF">JMP   @CheckBottom

 @LeftCut:
   ADD   AX,X
   MOV   Width,AX       </font><font color="#008000"><i>{ set width according to left clip }
   </i></font><font color="#FF00FF">SUB   DX,AX
   ADD   SI,DX
   XOR   BX,BX
   MOV   X,BX           </font><font color="#008000"><i>{ recalculate X parameter }

 </i></font><font color="#FF00FF">@CheckBottom:
   MOV   AX,Height
   ADD   AX,Y
   CMP   AX,200         </font><font color="#008000"><i>{ Check for bottom cut }
   </i></font><font color="#FF00FF">JG    @BottomCut

   SUB   AX,Y           </font><font color="#008000"><i>{ Check for top cut }
   </i></font><font color="#FF00FF">JC    @TopCut
   POP   BX             </font><font color="#008000"><i>{ Saved Width is no longer necessary }
                        { so remove it from the stack }
   </i></font><font color="#FF00FF">JMP   @Display       </font><font color="#008000"><i>{ no clipping on bottom necessary }

 </i></font><font color="#FF00FF">@BottomCut:
   POP   BX             </font><font color="#008000"><i>{ remove saved width from stack }
                        { no longer necessary }
   </i></font><font color="#FF00FF">SUB   AX,Height
   SUB   AX,200
   NEG   AX
   MOV   Height,AX       </font><font color="#008000"><i>{ adjust height according to clip}
   </i></font><font color="#FF00FF">JMP   @Display

 @TopCut:
  ADD   AX,Y
  POP   BX             </font><font color="#008000"><i>{ retreive saved width value }
  </i></font><font color="#FF00FF">PUSH  AX             </font><font color="#008000"><i>{ save AX, which is new height value }
  </i></font><font color="#FF00FF">MOV   AX,Y
  NEG   AX
  IMUL  BX
  ADD   SI,AX          </font><font color="#008000"><i>{ adjust starting offset in sprite data }
                       { according to the top cut }
  </i></font><font color="#FF00FF">POP   AX             </font><font color="#008000"><i>{ retrieve new height value }

  </i></font><font color="#FF00FF">MOV   Height,AX       </font><font color="#008000"><i>{ adjust height according to clip}
  </i></font><font color="#FF00FF">MOV   BX,0
  MOV   Y,BX            </font><font color="#008000"><i>{ Recalculate Y parameter }
 
 </i></font><font color="#FF00FF">@Display:
 </font><font color="#008000"><i>{  les   AX,dest}
 {  MOV   di,AX}
   </i></font><font color="#FF00FF">LES di,dest
 </font><font color="#008000"><i>{  XOR   DI,DI           { Make ES:DI point to A000h:0000h}
   </i></font><font color="#FF00FF">MOV   AX,320
   IMUL  [Y]
   MOV   DI,AX
   ADD   DI,X            </font><font color="#008000"><i>{ Calculate screen offset }
   </i></font><font color="#FF00FF">POP   DX              </font><font color="#008000"><i>{ Retrieve origional width }

   </i></font><font color="#FF00FF">MOV   BX,Width        </font><font color="#008000"><i>{ Store values in registers }
   </i></font><font color="#FF00FF">MOV   CX,Height       </font><font color="#008000"><i>{ for optimal speed }

   { The actual sprite is copied here.
     The Byte Ptr operations are used because they are faster
     than LODSB and STOSB on 386+ CPUs! Change it and see
     for yourself! The same is true with the DEC CX/JNZ
     instead of the LOOP instruction }

  </i></font><font color="#FF00FF">@HeightLoop:               </font><font color="#008000"><i>{ Loop for height }
   </i></font><font color="#FF00FF">PUSH  SI
   PUSH  DI

   PUSH  CX
   MOV   CX,BX
  @WidthLoop:                </font><font color="#008000"><i>{ Loop for width }
   </i></font><font color="#FF00FF">MOV   AL,Byte Ptr [DS:SI] </font><font color="#008000"><i>{ get 1 byte of sprite data }
   </i></font><font color="#FF00FF">CMP   AL,Maskcolor        </font><font color="#008000"><i>{ check for &quot;transparent&quot; color }
   </i></font><font color="#FF00FF">JZ    @Skipped
   MOV   Byte Ptr [ES:DI],AL </font><font color="#008000"><i>{ Store sprite data onto screen }

  </i></font><font color="#FF00FF">@Skipped:
   INC   SI
   INC   DI

   DEC   CX
   JNZ  @WidthLoop

   POP   CX
   POP   DI
   POP   SI
   ADD   DI,320  </font><font color="#008000"><i>{ Increment video memory by 1 line }
   </i></font><font color="#FF00FF">ADD   SI,DX   </font><font color="#008000"><i>{ Increment Sprite data by 1 line (DX=Width)}

   </i></font><font color="#FF00FF">DEC   CX
   JNZ  @HeightLoop
 
   POP   DS
   </font><font color="#008000"><i>{all done, whew!}
 </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
 asm</b></font><font color="#FF00FF">; mov ax,13h;int 10h;</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>Getmem<font color="#000080">(</font>Pic<font color="#000080">,</font><font color="#800000">40000</font><font color="#000080">);       </font><font color="#008000"><i>{50x50 picture}
 </i></font>GetMem<font color="#000080">(</font>VScreen<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);  </font><font color="#008000"><i>{Virtual Screen, Scratch Pad}
 </i></font>GetMem<font color="#000080">(</font>BScreen<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);  </font><font color="#008000"><i>{Background, holds &quot;game scenery&quot;}
 </i></font>Fillchar<font color="#000080">(</font>VScreen<font color="#000080">^,</font><font color="#800000">64000</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
 </font>Fillchar<font color="#000080">(</font>BScreen<font color="#000080">^,</font><font color="#800000">64000</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
 </font>Color <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

 </font><font color="#008000"><i>{make picture}
 </i></font><font color="#FF0000"><b>for </b></font>counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">40000 </font><font color="#FF0000"><b>do
  begin </b></font>color <font color="#000080">:= </font><font color="#FF0000"><b>not </b></font>color<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>COLOR <font color="#000080">= -</font><font color="#800000">1 </font><font color="#FF0000"><b>THEN </b></font>mem<font color="#000080">[</font>seg<font color="#000080">(</font>Pic<font color="#000080">^):</font>counter<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>COLOR <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN </b></font>mem<font color="#000080">[</font>seg<font color="#000080">(</font>Pic<font color="#000080">^):</font>counter<font color="#000080">] := </font>random<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#008000"><i>{Animate }
 </i></font>time<font color="#000080">:=</font>timer<font color="#000080">;
 </font><font color="#FF0000"><b>for </b></font>counter <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">199 </font><font color="#FF0000"><b>do
  begin
   </b></font><font color="#008000"><i>{picture has black(0) and blue(1) stripes, masking only Black(0)}
   {                             | mask color, try changing it.    }
   </i></font>MaskPic<font color="#000080">(</font>counter<font color="#000080">,</font>counter<font color="#000080">, </font><font color="#800000">200</font><font color="#000080">, </font><font color="#800000">200</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>Pic<font color="#000080">, </font>VScreen<font color="#000080">); </font><font color="#008000"><i>{Draw Picture To 
VIRTUAL SCREEN}
   </i></font>DMove<font color="#000080">(</font>VScreen<font color="#000080">^, </font>mem<font color="#000080">[</font><font color="#800000">$A000</font><font color="#000080">:</font><font color="#800000">0000</font><font color="#000080">], </font><font color="#800000">64000</font><font color="#000080">);        </font><font color="#008000"><i>{Move VScreen to 
Screen($a000:0000)}
   </i></font>DMove<font color="#000080">(</font>BScreen<font color="#000080">^, </font>VScreen<font color="#000080">^, </font><font color="#800000">64000</font><font color="#000080">);               </font><font color="#008000"><i>{Restore Background screen}
   </i></font>WaitRetrace<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#008000"><i>{Shut Down}
 </i></font><font color="#FF0000"><b>asm</b></font><font color="#FF00FF">; mov ax,03h;int 10h;</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font>writeln<font color="#000080">;
 </font>writeln<font color="#000080">(</font><font color="#800000">'With Background Updating, Copying to screen and Wait Retrace'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">' Tested on 486-DX4-100MHz                : 2.91 seconds for 100x200x200 frames'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">' On This machine for 100x 200x200 frames : '</font><font color="#000080">, </font>timer<font color="#000080">-</font>time<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">:</font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">'seconds'</font><font color="#000080">);

 </font>Freemem<font color="#000080">(</font>Pic<font color="#000080">,</font><font color="#800000">40000</font><font color="#000080">);
 </font>FreeMem<font color="#000080">(</font>VScreen<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);
 </font>FreeMem<font color="#000080">(</font>BScreen<font color="#000080">,</font><font color="#800000">64000</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0248.PAS">Original</a><b>]</b></p></body>
</html>
