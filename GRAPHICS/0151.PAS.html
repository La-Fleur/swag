<html>
<head><title> "Sprite Engine" by MARIUS KJELDAHL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0151.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;I am making a computer game using pascal and a 640x480x16 resolution,
&gt;using Jordan Hargrafix's SVGABG16.BGI driver, and I want to use the
&gt;setactivepage/setvisualpage commands to &quot;hide&quot; the screen as it is being
&gt;redrawn, and then show it again to give the effect of super fast screen
&gt;refresh (i.e. so fast, you can't see it)

I don't havce time to find out what you mean exactly.
This unit redraws sprites, and doesn't display them until
ShowVirtualScreen is activated.
}
</i></font><font color="#FF0000"><b>unit </b></font>Sprites<font color="#000080">;
</font><font color="#008000"><i>{ Basically a simple and effective spriteengine for use with Turbo }
{ Pascal 6.0. (Does not require the GRAPH unit..)                  }
{                                                                  }
{ Designed for use with MCGA, VGA and compatibles. Works in mode   }
{ mode $13 (320x200 with 256 simultaneously colours.               }
{                                                                  }
{ Written by:                                                      }
{            Marius Kjeldahl                                       }
{            Stud. post 104                                        }
{            N-7034 Trondheim - NTH                                }
{            Norway                                                }
{            Ph. +47 7 58 91 11                                    }
{            e-mail: mariusk@lise.unit.no                          }
{                    (at NTH - Norwegian Institute of Technology ) }
{                    (dept. of Business and Information Technolgy) }
{                                                                  }
{ These routines are being distributed as shareware. To be used in,}
{ or as part of any commercial product, you have to become a       }
{ registered user. As a registered user you will receive upgrades  }
{ and rights to distribute these routines with your products.      }
{ To become a registered user, you will have to send a letter with }
{ who you are and what product(s) will use these routines and      }
{ make US$39 payable to the author (cheque or money..).            }
{                                                                  }
{                                                                  }
{ If you have any suggestions or comments please do not hesitate   }
{ to contact me. Have fun...                                       }
{                                                                  }
{ Future plans for enhancements: interrupt driven, faster rep      }
{ movsw for sprites, built in animation, screen region scrolling   }
{ and more..                                                       }

</i></font><font color="#FF0000"><b>interface
uses
  </b></font>Dos<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>MaxSprites <font color="#000080">= </font><font color="#800000">14</font><font color="#000080">; </font><font color="#008000"><i>{ Maximum number of sprites activated simultaneously }
  </i></font>MaxDim <font color="#000080">= </font><font color="#800000">80</font><font color="#000080">*</font><font color="#800000">10</font><font color="#000080">;  </font><font color="#008000"><i>{ Dimensions of largest sprite to be used (x*y)      }
</i></font><font color="#FF0000"><b>type
  </b></font>ScreenTypePointer <font color="#000080">= ^</font>ScreenType<font color="#000080">;       </font><font color="#008000"><i>{ Pointer to a virtual screen  }
  </i></font>ScreenType <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">64000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">; </font><font color="#008000"><i>{ Array to hold virtual screen }
  </i></font>SpriteType <font color="#000080">= </font><font color="#FF0000"><b>record                    </b></font><font color="#008000"><i>{ Misc. sprite data            }
                 </i></font>oldx<font color="#000080">, </font>oldy<font color="#000080">,             </font><font color="#008000"><i>{ - old location               }
                 </i></font>x<font color="#000080">, </font>y <font color="#000080">: </font>integer<font color="#000080">;         </font><font color="#008000"><i>{ - current location           }
                 </i></font>w<font color="#000080">, </font>h <font color="#000080">: </font>byte<font color="#000080">;            </font><font color="#008000"><i>{ - width and height           }
                 </i></font>SpriteData<font color="#000080">,             </font><font color="#008000"><i>{ - spriteimage                }
                 </i></font>Buffer <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>MaxDim<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">; </font><font color="#008000"><i>{ spritebackgr.  }
                 </i></font>Active <font color="#000080">: </font>boolean<font color="#000080">;       </font><font color="#008000"><i>{ - currently active           }
                 </i></font>ix<font color="#000080">, </font>iy <font color="#000080">: </font>integer<font color="#000080">;       </font><font color="#008000"><i>{ - sprite increment           }
                                         {   (not currently used)       }
               </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Sprite <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>MaxSprites<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>SpriteType<font color="#000080">; </font><font color="#008000"><i>{ Array of sprites      }
  </i></font>Virtual_Screen <font color="#000080">: </font>ScreenTypePointer<font color="#000080">;    </font><font color="#008000"><i>{ Pointer to virtual screen    }

  </i></font><font color="#FF0000"><b>procedure </b></font>DrawSprites<font color="#000080">;
  </font><font color="#008000"><i>{ Saves background and draws all currently active sprites at their    }
  { current location.                                                   }

  </i></font><font color="#FF0000"><b>procedure </b></font>LoadSprite <font color="#000080">(</font>Num <font color="#000080">: </font>byte<font color="#000080">; </font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
  </font><font color="#008000"><i>{ Loads spritedata from ordinary text file. Examine the .SPR files    }
  { for further details. Use .CEL files instead if you've have          }
  { purchased AutoDesk Animator...                                      }

  </i></font><font color="#FF0000"><b>procedure </b></font>SetMode <font color="#000080">(</font>Mode <font color="#000080">: </font>word<font color="#000080">);
  </font><font color="#008000"><i>{ Sets screen mode. Use $13 for use with sprites                      }

  </i></font><font color="#FF0000"><b>procedure </b></font>ShowVirtualScreen <font color="#000080">;
  </font><font color="#008000"><i>{ Copies the VirtualScreen to the users screen. Any changes done with }
  { the sprites and/or their position will NOT be visible until this    }
  { routine has been called!                                            }

  </i></font><font color="#FF0000"><b>procedure </b></font>LoadCOL <font color="#000080">(</font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
  </font><font color="#008000"><i>{ Loads a file containing the palette desc. of the 256 colours and    }
  { programs the VGA/MCGA to use these palette. It uses AutoDesk        }
  { Animators file format - so you can use Animator to select colors and}
  { then save the palette in Animators ordinary .COL file.              }
  { For those without Animator (you should not be..) the file format is }
  { simple. Each colour (from 0 to 255) has three bytes which containts }
  { red, green and blue values. First in the file comes (usually)       }
  { 0,0,0 - black and so on until the last colour.                      }

  </i></font><font color="#FF0000"><b>procedure </b></font>LoadCEL <font color="#000080">(</font>FileName <font color="#000080">:  </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>ScrPtr <font color="#000080">: </font>pointer<font color="#000080">);
  </font><font color="#008000"><i>{ Directly loads a CEL to the location pointed to by ScrPtr.          }
  { This routine uses AutoDesk Animators file format. This means you    }
  { can use Animators excellent drawing tools to design you sprites and }
  { save them in a ordinary .CEL file.                                  }
  { For those without Animator; here is a short desc. of the format:    }
  { The first 800 bytes is Animators header. It does include various    }
  { information like it's own colours palette, width and height.        }
  { However this version skips all that information and just reads the  }
  { image data into the location pointed to by ScrPtr. Remember to      }
  { set the sprites width and height too! (It is NOT read you of the    }
  { .CEL file in this release..                                         }

  </i></font><font color="#FF0000"><b>procedure </b></font>DisableAllSprites<font color="#000080">;
  </font><font color="#008000"><i>{ Disables all sprites. But this routine does not restore the screen  }
  { image (compare with HideSprites..                                   }

  </i></font><font color="#FF0000"><b>procedure </b></font>HideSprites<font color="#000080">;
  </font><font color="#008000"><i>{ Disables all sprites. Basically same as DisableAllSprites, but this }
  { routine also recovers the &quot;original&quot; screen image.                  }

  </i></font><font color="#FF0000"><b>procedure </b></font>FillBox <font color="#000080">(</font>x1<font color="#000080">, </font>y1<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>integer<font color="#000080">; </font>b <font color="#000080">: </font>byte<font color="#000080">);
  </font><font color="#008000"><i>{ Draws a coloured box with upper left corner x1,y1 and lower right   }
  { corner x2,y2.                                                       }

  </i></font><font color="#FF0000"><b>procedure </b></font>CopySprite <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Sprite <font color="#000080">: </font>SpriteType<font color="#000080">; </font>x1<font color="#000080">, </font>y1 <font color="#000080">: </font>integer<font color="#000080">);
  </font><font color="#008000"><i>{ &quot;Stamps&quot; a copy of any sprite at the chosen location x1,y1.         }
  { Use this routine if you want to put the image there, but do not plan}
  { to animate in anyway..                                              }

  </i></font><font color="#FF0000"><b>procedure </b></font>WaitForVerticalRetrace<font color="#000080">;
  </font><font color="#008000"><i>{ Waits for vertical retrace. Will be used in further releases..      }

</i></font><font color="#FF0000"><b>implementation

procedure </b></font>CopySprite <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Sprite <font color="#000080">: </font>SpriteType<font color="#000080">; </font>x1<font color="#000080">, </font>y1 <font color="#000080">: </font>integer<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label
  </b></font>_Redraw<font color="#000080">, </font>_DrawLoop<font color="#000080">, </font>_Exit<font color="#000080">, </font>_LineLoop<font color="#000080">, </font>_NextLine<font color="#000080">, </font>_Store<font color="#000080">, </font>_NoPaint<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push  ds
    push  es
    lds   si,Sprite
    mov   ax,x1     </font><font color="#008000"><i>{ ax = x }
    </i></font><font color="#FF00FF">mov   bx,y1     </font><font color="#008000"><i>{ bx = y }
</i></font><font color="#FF00FF">_Redraw:
    push  ax
    push  bx
    mov   ax,word(Virtual_Screen+2)
    mov   es,ax         </font><font color="#008000"><i>{ ES=A000h }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ ax = y }
    </i></font><font color="#FF00FF">mov   ax,320
    mul   bx            </font><font color="#008000"><i>{ ax = y * 320 }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ ax = x }
    </i></font><font color="#FF00FF">add   ax,bx         </font><font color="#008000"><i>{ bx = bx + ax dvs. skjermadr.. }
    </i></font><font color="#FF00FF">mov   di,ax         </font><font color="#008000"><i>{ di = skjermadr. }
    </i></font><font color="#FF00FF">mov   dl,[si+9]     </font><font color="#008000"><i>{ dl = height of sprite }
    </i></font><font color="#FF00FF">xor   ch,ch
    mov   cl,[si+8]     </font><font color="#008000"><i>{ cx = width of sprite }
    </i></font><font color="#FF00FF">add   si,10         </font><font color="#008000"><i>{ si = start of spritedata }
    </i></font><font color="#FF00FF">cld
_DrawLoop:
    push  di            </font><font color="#008000"><i>{ store y adr. for later }
    </i></font><font color="#FF00FF">push  cx            </font><font color="#008000"><i>{ store width }
</i></font><font color="#FF00FF">_LineLoop:
    mov   bl,byte ptr [si]
    or    bl,bl
    jnz   _Store
_NoPaint:
    inc    si
    inc    di
    loop   _LineLoop
    jmp    _NextLine
_Store:
</font><font color="#008000"><i>{    test   byte ptr [es:di],1
    jz     _NoPaint}
    </i></font><font color="#FF00FF">movsb
    loop  _LineLoop
_NextLine:
    pop   cx
    pop   di
    dec   dl
    jz    _Exit
    add   di,320        </font><font color="#008000"><i>{ di = next line of sprite }
    </i></font><font color="#FF00FF">jmp   _DrawLoop
_Exit:
    pop   es
    pop   ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>DrawSprite <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Sprite <font color="#000080">: </font>SpriteType<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label
  </b></font>_Redraw<font color="#000080">, </font>_DrawLoop<font color="#000080">, </font>_Exit<font color="#000080">, </font>_LineLoop<font color="#000080">, </font>_NextLine<font color="#000080">, </font>_Store<font color="#000080">, </font>_NoPaint<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push  ds
    push  es
    lds   si,Sprite
    mov   ax,[si+4]     </font><font color="#008000"><i>{ ax = x }
    </i></font><font color="#FF00FF">mov   bx,[si+6]     </font><font color="#008000"><i>{ bx = y }
    </i></font><font color="#FF00FF">cmp   ax,[si]        </font><font color="#008000"><i>{if x &lt;&gt; oldx then _Redraw}
    </i></font><font color="#FF00FF">jne   _Redraw       </font><font color="#008000"><i>{
    cmp   bx,[si+2]
   je    _Exit         { if (x=oldx) and (y=oldy) then exit }
</i></font><font color="#FF00FF">_Redraw:
    mov   [si],ax       </font><font color="#008000"><i>{ oldx = x }
    </i></font><font color="#FF00FF">mov   [si+2],bx     </font><font color="#008000"><i>{ oldy = y }
    </i></font><font color="#FF00FF">push  ax
    push  bx
    mov   ax,word(Virtual_Screen+2)
    mov   es,ax         </font><font color="#008000"><i>{ ES=A000h }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ ax = y }
    </i></font><font color="#FF00FF">mov   ax,320
    mul   bx            </font><font color="#008000"><i>{ ax = y * 320 }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ ax = x }
    </i></font><font color="#FF00FF">add   ax,bx         </font><font color="#008000"><i>{ bx = bx + ax dvs. skjermadr.. }
    </i></font><font color="#FF00FF">mov   di,ax         </font><font color="#008000"><i>{ di = skjermadr. }
    </i></font><font color="#FF00FF">mov   dl,[si+9]     </font><font color="#008000"><i>{ dl = height of sprite }
    </i></font><font color="#FF00FF">xor   ch,ch
    mov   cl,[si+8]     </font><font color="#008000"><i>{ cx = width of sprite }
    </i></font><font color="#FF00FF">add   si,10         </font><font color="#008000"><i>{ si = start of spritedata }
    </i></font><font color="#FF00FF">cld
_DrawLoop:
    push  di            </font><font color="#008000"><i>{ store y adr. for later }
    </i></font><font color="#FF00FF">push  cx            </font><font color="#008000"><i>{ store width }
</i></font><font color="#FF00FF">_LineLoop:
    mov   bl,byte ptr [si]
    or    bl,bl
    jnz   _Store
_NoPaint:
    inc    si
    inc    di
    loop   _LineLoop
    jmp    _NextLine
_Store:
</font><font color="#008000"><i>{    test   byte ptr [es:di],1
    jz     _NoPaint}
    </i></font><font color="#FF00FF">movsb
    loop  _LineLoop
_NextLine:
    pop   cx
    pop   di
    dec   dl
    jz    _Exit
    add   di,320        </font><font color="#008000"><i>{ di = next line of sprite }
    </i></font><font color="#FF00FF">jmp   _DrawLoop
_Exit:
    pop   es
    pop   ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SaveSpriteBackground <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Sprite <font color="#000080">: </font>Spritetype<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label
  </b></font>_Redraw<font color="#000080">, </font>_DrawLoop<font color="#000080">, </font>_Exit<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push  ds
    push  es
    les   di,Sprite
    mov   ax,es:[di+4]     </font><font color="#008000"><i>{ ax = x }
    </i></font><font color="#FF00FF">mov   bx,es:[di+6]     </font><font color="#008000"><i>{ bx = y }
    </i></font><font color="#FF00FF">push  ax
    push  bx
    mov   ax,word(Virtual_Screen+2)
    mov   ds,ax         </font><font color="#008000"><i>{ DS=A000h }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ bx = y }
    </i></font><font color="#FF00FF">mov   ax,320
    mul   bx            </font><font color="#008000"><i>{ ax = y * 320 }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ bx = x }
    </i></font><font color="#FF00FF">add   ax,bx         </font><font color="#008000"><i>{ ax = ax + bx dvs. skjermadr.. }
    </i></font><font color="#FF00FF">mov   si,ax         </font><font color="#008000"><i>{ si = skjermadr. }
    </i></font><font color="#FF00FF">mov   dl,es:[di+9]     </font><font color="#008000"><i>{ dl = height of sprite }
    </i></font><font color="#FF00FF">xor   ch,ch
    mov   cl,es:[di+8]     </font><font color="#008000"><i>{ cx = width of sprite }
    </i></font><font color="#FF00FF">add   di,10+MaxDim  </font><font color="#008000"><i>{ di = start of screenbuffer }
    </i></font><font color="#FF00FF">cld
_DrawLoop:
    push  si            </font><font color="#008000"><i>{ store y adr. for later }
    </i></font><font color="#FF00FF">push  cx            </font><font color="#008000"><i>{ store width }
    </i></font><font color="#FF00FF">rep   movsb
    pop   cx
    pop   si
    dec   dl
    jz    _Exit
    add   si,320        </font><font color="#008000"><i>{ di = next line of sprite }
    </i></font><font color="#FF00FF">jmp   _DrawLoop
_Exit:
    pop   es
    pop   ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>FillBox <font color="#000080">(</font>x1<font color="#000080">, </font>y1<font color="#000080">, </font>x2<font color="#000080">, </font>y2 <font color="#000080">: </font>integer<font color="#000080">; </font>b <font color="#000080">: </font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label
  </b></font>_l1<font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push  ds
  push  es
  mov   ax,word(Virtual_Screen+2)
  mov   es,ax
  mov   ax,y1
  mov   bx,320
  mul   bx
  mov   di,ax
  add   di,x1
  mov   ax,y1
  mov   dx,y2
  sub   dx,ax
  inc   dx

  mov   ax,x1
  mov   cx,x2
  sub   cx,ax </font><font color="#008000"><i>{ cx contains number of bytes across }
  </i></font><font color="#FF00FF">inc   cx
  mov   al,b
  cld
_l1:
  push  di
  push  cx
  rep   stosb
  pop   cx
  pop   di
  add   di,320
  dec   dx
  jnz   _l1
  pop   es
  pop   ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>RestoreSpriteBackground <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Sprite <font color="#000080">: </font>Spritetype<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label
  </b></font>_Redraw<font color="#000080">, </font>_DrawLoop<font color="#000080">, </font>_Exit<font color="#000080">, </font>_LineLoop<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push  ds
    push  es
    lds   si,Sprite
    mov   ax,[si]     </font><font color="#008000"><i>{ ax = x }
    </i></font><font color="#FF00FF">mov   bx,[si+2]     </font><font color="#008000"><i>{ bx = y }
    </i></font><font color="#FF00FF">push  ax
    push  bx
    mov   ax,word(Virtual_Screen+2)
    mov   es,ax         </font><font color="#008000"><i>{ ES=A000h }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ ax = y }
    </i></font><font color="#FF00FF">mov   ax,320
    mul   bx            </font><font color="#008000"><i>{ ax = y * 320 }
    </i></font><font color="#FF00FF">pop   bx            </font><font color="#008000"><i>{ ax = x }
    </i></font><font color="#FF00FF">add   ax,bx         </font><font color="#008000"><i>{ bx = bx + ax dvs. skjermadr.. }
    </i></font><font color="#FF00FF">mov   di,ax         </font><font color="#008000"><i>{ di = skjermadr. }
    </i></font><font color="#FF00FF">mov   dl,[si+9]     </font><font color="#008000"><i>{ dl = height of sprite }
    </i></font><font color="#FF00FF">xor   ch,ch
    mov   cl,[si+8]     </font><font color="#008000"><i>{ cx = width of sprite }
    </i></font><font color="#FF00FF">add   si,10+MaxDim         </font><font color="#008000"><i>{ si = start of spritedata }
    </i></font><font color="#FF00FF">cld
_DrawLoop:
    push  di            </font><font color="#008000"><i>{ store y adr. for later }
    </i></font><font color="#FF00FF">push  cx            </font><font color="#008000"><i>{ store width }
    </i></font><font color="#FF00FF">rep   movsb
    pop   cx
    pop   di
    dec   dl
    jz    _Exit
    add   di,320        </font><font color="#008000"><i>{ di = next line of sprite }
    </i></font><font color="#FF00FF">jmp   _DrawLoop
_Exit:
    pop   es
    pop   ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>DrawSprites<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>I <font color="#000080">:= </font>MaxSprites <font color="#FF0000"><b>downto </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do
    if </b></font><font color="#000080">(</font>Sprite<font color="#000080">[</font>I<font color="#000080">].</font>Active<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Sprite <font color="#000080">[</font>I<font color="#000080">].</font>oldx <font color="#000080">&lt;&gt; -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>RestoreSpriteBackground <font color="#000080">(</font>Sprite <font color="#000080">[</font>I<font color="#000080">]);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>MaxSprites <font color="#FF0000"><b>do begin
    if </b></font>Sprite <font color="#000080">[</font>I<font color="#000080">].</font>Active <font color="#FF0000"><b>then begin
      </b></font>SaveSpriteBackground <font color="#000080">(</font>Sprite <font color="#000080">[</font>I<font color="#000080">]);
      </font>DrawSprite <font color="#000080">(</font>Sprite <font color="#000080">[</font>I<font color="#000080">]);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>HideSprites<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>I <font color="#000080">:= </font>MaxSprites <font color="#FF0000"><b>downto </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do
    if </b></font><font color="#000080">(</font>Sprite <font color="#000080">[</font>I<font color="#000080">].</font>oldx <font color="#000080">&lt;&gt; -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font>RestoreSpriteBackground <font color="#000080">(</font>Sprite <font color="#000080">[</font>I<font color="#000080">]);
      </font>Sprite <font color="#000080">[</font>I<font color="#000080">].</font>oldx <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetMode <font color="#000080">(</font>Mode <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">mov ax,Mode;
    int 10h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>LoadSprite <font color="#000080">(</font>Num <font color="#000080">: </font>byte<font color="#000080">; </font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Fil <font color="#000080">: </font>text<font color="#000080">;
  </font>fx<font color="#000080">, </font>fy <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>assign <font color="#000080">(</font>Fil<font color="#000080">, </font>FileName<font color="#000080">);
  </font>reset <font color="#000080">(</font>Fil<font color="#000080">);
  </font>fillchar <font color="#000080">(</font>Sprite <font color="#000080">[</font>Num<font color="#000080">], </font>sizeof <font color="#000080">(</font>Sprite<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]), </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>with </b></font>Sprite <font color="#000080">[</font>Num<font color="#000080">] </font><font color="#FF0000"><b>do begin
    </b></font>oldx <font color="#000080">:= </font>integer <font color="#000080">(</font><font color="#800000">$FFFF</font><font color="#000080">);
    </font>readln <font color="#000080">(</font>Fil<font color="#000080">, </font>w<font color="#000080">, </font>h<font color="#000080">);          </font><font color="#008000"><i>{integer-32768}
    </i></font><font color="#FF0000"><b>for </b></font>fy <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>h <font color="#FF0000"><b>do begin
      for </b></font>fx <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>w <font color="#FF0000"><b>do
        </b></font>read <font color="#000080">(</font>Fil<font color="#000080">, </font>SpriteData <font color="#000080">[</font>pred <font color="#000080">(</font>fy<font color="#000080">) * </font>w <font color="#000080">+ </font>pred <font color="#000080">(</font>fx<font color="#000080">)]);
      </font>readln <font color="#000080">(</font>fil<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>close <font color="#000080">(</font>Fil<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>LoadCOL <font color="#000080">(</font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>type
  </b></font>DACType <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of record
                                </b></font>R<font color="#000080">, </font>G<font color="#000080">, </font>B <font color="#000080">: </font>byte<font color="#000080">;
                              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>DAC <font color="#000080">: </font>DACType<font color="#000080">;
  </font>Fil <font color="#000080">: </font><font color="#FF0000"><b>file of </b></font>DACType<font color="#000080">;
  </font>I <font color="#000080">: </font>integer<font color="#000080">;
  </font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>assign <font color="#000080">(</font>Fil<font color="#000080">, </font>FileName<font color="#000080">);
  </font>reset <font color="#000080">(</font>Fil<font color="#000080">);
  </font>read <font color="#000080">(</font>Fil<font color="#000080">, </font>DAC<font color="#000080">);
  </font>close <font color="#000080">(</font>Fil<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do begin
    with </b></font>Regs <font color="#FF0000"><b>do begin
      </b></font>AX <font color="#000080">:= </font><font color="#800000">$1010</font><font color="#000080">;
      </font>BX <font color="#000080">:= </font>I<font color="#000080">;
      </font>DH <font color="#000080">:= </font>DAC <font color="#000080">[</font>I<font color="#000080">].</font>R<font color="#000080">;
      </font>CH <font color="#000080">:= </font>DAC <font color="#000080">[</font>I<font color="#000080">].</font>G<font color="#000080">;
      </font>CL <font color="#000080">:= </font>DAC <font color="#000080">[</font>I<font color="#000080">].</font>B<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>Intr <font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">, </font>Regs<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>WaitForVerticalRetrace<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label
  </b></font>l1<font color="#000080">, </font>l2<font color="#000080">;
</font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">cli
    mov dx,3DAh
l1:
    in al,dx
    and al,08h
    jnz l1
l2:
    in al,dx
    and al,08h
    jz  l2
    sti
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>ShowVirtualScreen<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">push ds
      push es
      xor  si,si
      xor  di,di
      cld
      mov  ax,word(Virtual_Screen + 2)
      mov  ds,ax
      mov  ax,0A000h
      mov  es,ax
      mov  cx,7D00h
      rep  movsw
      pop  es
      pop  ds
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>LoadCEL <font color="#000080">(</font>FileName <font color="#000080">:  </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>ScrPtr <font color="#000080">: </font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Fil <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>Buf <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">1024</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>BlocksRead<font color="#000080">, </font>Count <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>assign <font color="#000080">(</font>Fil<font color="#000080">, </font>FileName<font color="#000080">);
  </font>reset <font color="#000080">(</font>Fil<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>BlockRead <font color="#000080">(</font>Fil<font color="#000080">, </font>Buf<font color="#000080">, </font><font color="#800000">800</font><font color="#000080">);
  </font>Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>BlocksRead <font color="#000080">:= </font><font color="#800000">$FFFF</font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>eof <font color="#000080">(</font>Fil<font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>BlocksRead <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>BlockRead <font color="#000080">(</font>Fil<font color="#000080">, </font>mem <font color="#000080">[</font>seg <font color="#000080">(</font>ScrPtr<font color="#000080">^): </font>ofs <font color="#000080">(</font>ScrPtr<font color="#000080">^) + </font>Count<font color="#000080">], </font><font color="#800000">1024</font><font color="#000080">,
</font>BlocksRead<font color="#000080">);
    </font>Count <font color="#000080">:= </font>Count <font color="#000080">+ </font><font color="#800000">1024</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>close <font color="#000080">(</font>Fil<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>DisableAllSprites<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>MaxSprites <font color="#FF0000"><b>do
    with </b></font>Sprite <font color="#000080">[</font>I<font color="#000080">] </font><font color="#FF0000"><b>do begin
      </b></font>OldX <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
      </font>Active <font color="#000080">:= </font>FALSE<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Dum <font color="#000080">: ^</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DisableAllSprites<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>new <font color="#000080">(</font>Virtual_Screen<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>ofs <font color="#000080">(</font>Virtual_Screen<font color="#000080">^) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>dispose <font color="#000080">(</font>Virtual_Screen<font color="#000080">);
      </font>new <font color="#000080">(</font>Dum<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>until </b></font>ofs <font color="#000080">(</font>Virtual_Screen<font color="#000080">^) = </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0151.PAS">Original</a><b>]</b></p></body>
</html>
