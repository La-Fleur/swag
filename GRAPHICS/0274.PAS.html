<html>
<head><title> "Wormhole Graphic" by JACO VAN NIEKERK</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0274.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{Jaco van Niekerk   sparky@lantic.co.za}
{Any comments, whatever, please mail!}

{Please note : I take NO responsibility on the effect of the code  }
{              I've tested it on many machines, so I can't see any }
{              reason why it should not work on yours.             }


{worm hole in 320x200}
{$N+}
</i></font><font color="#FF0000"><b>program </b></font>wormhole<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>crt<font color="#000080">; </font><font color="#008000"><i>{for keypressed}

</i></font><font color="#FF0000"><b>var </b></font>circle_x <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">80</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">61</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
    </font>circle_y <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">80</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">61</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
    </font>cposx<font color="#000080">, </font>xposy <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">80</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">61</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
    </font>relpos_x <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">80</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
    </font>relpos_y <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">80</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
    </font>vscreen <font color="#000080">: </font>pointer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>calc_circles<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>deg<font color="#000080">, </font>x<font color="#000080">, </font>y<font color="#000080">, </font>c <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
     for </b></font>c<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">80 </font><font color="#FF0000"><b>do
     begin
          </b></font>relpos_x<font color="#000080">[</font>c<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">; </font>relpos_y<font color="#000080">[</font>c<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#FF0000"><b>for </b></font>deg<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">60 </font><font color="#FF0000"><b>do
          begin
               </b></font>x<font color="#000080">:=</font>round<font color="#000080">(</font>c<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">*</font>cos<font color="#000080">(</font>deg<font color="#000080">*</font>pi<font color="#000080">/</font><font color="#800000">30</font><font color="#000080">)); </font>y<font color="#000080">:=</font>round<font color="#000080">(</font>c<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">*</font>sin<font color="#000080">(</font>deg<font color="#000080">*</font>pi<font color="#000080">/</font><font color="#800000">30</font><font color="#000080">));
               </font>circle_x<font color="#000080">[</font>c<font color="#000080">, </font>deg<font color="#000080">]:=</font><font color="#800000">160</font><font color="#000080">+</font>x<font color="#000080">; </font>circle_y<font color="#000080">[</font>c<font color="#000080">, </font>deg<font color="#000080">]:=</font><font color="#800000">100</font><font color="#000080">+</font>y<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>copyw<font color="#000080">(</font>source <font color="#000080">: </font>pointer<font color="#000080">; </font>dest <font color="#000080">: </font>pointer<font color="#000080">; </font>cnt <font color="#000080">: </font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">les di, [dest]
   push ds
   lds si, [source]
   mov cx, [cnt]
   cld
   rep movsw
   pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>clrdw<font color="#000080">(</font>source <font color="#000080">: </font>pointer<font color="#000080">; </font>cnt <font color="#000080">: </font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">les di, [source]
   mov cx, [cnt]
   db $66; xor ax, ax </font><font color="#008000"><i>{xor eax, eax}
   </i></font><font color="#FF00FF">db $66; rep stosw  </font><font color="#008000"><i>{rep storsdw}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>waitretrace<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#008000"><i>{this waits for a vertical retrace, exiting when it occurs}
   </i></font><font color="#FF00FF">mov dx,3DAh
   @loop1:
   in al,dx
   and al,08h
   jnz @loop1
   @loop2:
   in al,dx
   and al,08h
   jz @loop2
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>xp<font color="#000080">, </font>yp<font color="#000080">, </font>i<font color="#000080">, </font>j<font color="#000080">, </font>sg<font color="#000080">, </font>os<font color="#000080">, </font>new_y<font color="#000080">, </font>new_x <font color="#000080">: </font>word<font color="#000080">;
    </font>cx<font color="#000080">, </font>cy<font color="#000080">, </font>dx<font color="#000080">, </font>dy <font color="#000080">: </font>real<font color="#000080">;
    </font>tx<font color="#000080">, </font>ty <font color="#000080">: </font>integer<font color="#000080">;

    </font>mpos <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
     </b></font>randomize<font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>maxavail<font color="#000080">&lt;</font><font color="#800000">64000 </font><font color="#FF0000"><b>then
        begin </b></font>writeln<font color="#000080">(</font><font color="#800000">'Not enough memory!'</font><font color="#000080">); </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">); </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font>getmem<font color="#000080">(</font>vscreen<font color="#000080">, </font><font color="#800000">64000</font><font color="#000080">);

     </font>calc_circles<font color="#000080">;
     </font>sg<font color="#000080">:=</font>seg<font color="#000080">(</font>vscreen<font color="#000080">^); </font>os<font color="#000080">:=</font>ofs<font color="#000080">(</font>vscreen<font color="#000080">^);
     </font>cx<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>cy<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>dx<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>dy<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
     </font>tx<font color="#000080">:=</font>random<font color="#000080">(</font><font color="#800000">20</font><font color="#000080">)-</font><font color="#800000">10</font><font color="#000080">; </font>ty<font color="#000080">:=</font>random<font color="#000080">(</font><font color="#800000">20</font><font color="#000080">)-</font><font color="#800000">10</font><font color="#000080">;
     </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax, 13h; int 10h; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font>port<font color="#000080">[</font><font color="#800000">$3c8</font><font color="#000080">]:=</font><font color="#800000">1</font><font color="#000080">;
     </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">80 </font><font color="#FF0000"><b>do
     begin
          </b></font>port<font color="#000080">[</font><font color="#800000">$3c9</font><font color="#000080">]:=</font>round<font color="#000080">(</font>i<font color="#000080">*</font><font color="#800000">0.7</font><font color="#000080">);
          </font>port<font color="#000080">[</font><font color="#800000">$3c9</font><font color="#000080">]:=</font>round<font color="#000080">(</font>i<font color="#000080">*</font><font color="#800000">0.7</font><font color="#000080">);
          </font>port<font color="#000080">[</font><font color="#800000">$3c9</font><font color="#000080">]:=</font>round<font color="#000080">(</font>i<font color="#000080">*</font><font color="#800000">0.7</font><font color="#000080">);
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>repeat
           </b></font><font color="#008000"><i>{clear screen}
           </i></font>clrdw<font color="#000080">(</font>vscreen<font color="#000080">, </font><font color="#800000">16000</font><font color="#000080">);

           </font><font color="#008000"><i>{update offset buffer}
           </i></font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">80 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do
               begin
                    </b></font>relpos_x<font color="#000080">[</font>i<font color="#000080">]:=</font>relpos_x<font color="#000080">[</font>i<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">];
                    </font>relpos_y<font color="#000080">[</font>i<font color="#000080">]:=</font>relpos_y<font color="#000080">[</font>i<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">];
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

           </font><font color="#008000"><i>{create &quot;new&quot; circle}
           </i></font><font color="#FF0000"><b>if </b></font>cx<font color="#000080">&gt;</font>tx <font color="#FF0000"><b>then </b></font>dx<font color="#000080">:=</font>dx<font color="#000080">-</font><font color="#800000">0.55 </font><font color="#FF0000"><b>else
              if </b></font>cx<font color="#000080">&lt;</font>tx <font color="#FF0000"><b>then </b></font>dx<font color="#000080">:=</font>dx<font color="#000080">+</font><font color="#800000">0.55</font><font color="#000080">;
           </font><font color="#FF0000"><b>if </b></font>cy<font color="#000080">&gt;</font>ty <font color="#FF0000"><b>then </b></font>dy<font color="#000080">:=</font>dy<font color="#000080">-</font><font color="#800000">0.55 </font><font color="#FF0000"><b>else
              if </b></font>cy<font color="#000080">&lt;</font>ty <font color="#FF0000"><b>then </b></font>dy<font color="#000080">:=</font>dy<font color="#000080">+</font><font color="#800000">0.55</font><font color="#000080">;
           </font><font color="#FF0000"><b>if </b></font>sqr<font color="#000080">(</font>cx<font color="#000080">-</font>tx<font color="#000080">)+</font>sqr<font color="#000080">(</font>cy<font color="#000080">-</font>ty<font color="#000080">)&lt;</font><font color="#800000">200 </font><font color="#FF0000"><b>then
           begin </b></font>tx<font color="#000080">:=</font>random<font color="#000080">(</font><font color="#800000">80</font><font color="#000080">)-</font><font color="#800000">30</font><font color="#000080">; </font>ty<font color="#000080">:=</font>random<font color="#000080">(</font><font color="#800000">50</font><font color="#000080">)-</font><font color="#800000">25</font><font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
           </font>cx<font color="#000080">:=</font>cx<font color="#000080">+</font>dx<font color="#000080">; </font>cy<font color="#000080">:=</font>cy<font color="#000080">+</font>dy<font color="#000080">;

           </font><font color="#008000"><i>{speed control}
           </i></font><font color="#FF0000"><b>if </b></font>dx<font color="#000080">&gt;</font><font color="#800000">5 </font><font color="#FF0000"><b>then </b></font>dx<font color="#000080">:=</font><font color="#800000">5</font><font color="#000080">;
           </font><font color="#FF0000"><b>if </b></font>dx<font color="#000080">&lt;-</font><font color="#800000">5 </font><font color="#FF0000"><b>then </b></font>dx<font color="#000080">:=-</font><font color="#800000">5</font><font color="#000080">;
           </font><font color="#FF0000"><b>if </b></font>dy<font color="#000080">&gt;</font><font color="#800000">5 </font><font color="#FF0000"><b>then </b></font>dy<font color="#000080">:=</font><font color="#800000">5</font><font color="#000080">;
           </font><font color="#FF0000"><b>if </b></font>dy<font color="#000080">&lt;-</font><font color="#800000">5 </font><font color="#FF0000"><b>then </b></font>dy<font color="#000080">:=-</font><font color="#800000">5</font><font color="#000080">;

           </font><font color="#008000"><i>{update new circle}
           </i></font>relpos_x<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:=</font>round<font color="#000080">(</font>cx<font color="#000080">); </font>relpos_y<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:=</font>round<font color="#000080">(</font>cy<font color="#000080">);

           </font><font color="#008000"><i>{plot circles}
           </i></font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">80 </font><font color="#FF0000"><b>do
               for </b></font>j<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">60 </font><font color="#FF0000"><b>do
               begin
                    </b></font>new_x<font color="#000080">:=</font>circle_x<font color="#000080">[</font>i<font color="#000080">][</font>j<font color="#000080">] + </font>relpos_x<font color="#000080">[</font>i<font color="#000080">];
                    </font>new_y<font color="#000080">:=</font>circle_y<font color="#000080">[</font>i<font color="#000080">][</font>j<font color="#000080">] + </font>relpos_y<font color="#000080">[</font>i<font color="#000080">];
                    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>new_x<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>new_x<font color="#000080">&lt;</font><font color="#800000">320</font><font color="#000080">) </font><font color="#FF0000"><b>and
                       </b></font><font color="#000080">(</font>new_y<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>new_y<font color="#000080">&lt;</font><font color="#800000">200</font><font color="#000080">) </font><font color="#FF0000"><b>then
                       </b></font>mem<font color="#000080">[</font>sg<font color="#000080">:</font>os<font color="#000080">+</font>new_y <font color="#FF0000"><b>shl </b></font><font color="#800000">6</font><font color="#000080">+</font>new_y <font color="#FF0000"><b>shl </b></font><font color="#800000">8</font><font color="#000080">+</font>new_x<font color="#000080">]:=</font>i<font color="#000080">;

               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

           </font><font color="#008000"><i>{blast to screen}
           </i></font>waitretrace<font color="#000080">;
           </font>copyw<font color="#000080">(</font>vscreen<font color="#000080">, </font>ptr<font color="#000080">(</font><font color="#800000">$a000</font><font color="#000080">,</font><font color="#800000">0000</font><font color="#000080">), </font><font color="#800000">32000</font><font color="#000080">);
     </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>keypressed<font color="#000080">);
     </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax, 03h; int 10h; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font>freemem<font color="#000080">(</font>vscreen<font color="#000080">, </font><font color="#800000">64000</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
--</font><font color="#FF0000"><b>Message</b></font><font color="#000080">-</font>Boundary<font color="#000080">-</font><font color="#800000">5639
</font>Content<font color="#000080">-</font><font color="#FF0000"><b>type</b></font><font color="#000080">: </font>text<font color="#000080">/</font>plain<font color="#000080">; </font>charset<font color="#000080">=</font>US<font color="#000080">-</font>ASCII
Content<font color="#000080">-</font>transfer<font color="#000080">-</font>encoding<font color="#000080">: </font><font color="#800000">7</font>BIT
Content<font color="#000080">-</font>description<font color="#000080">: </font>Text from <font color="#FF0000"><b>file </b></font><font color="#800000">'SIMBA.PAS'

</font><font color="#008000"><i>{ By Jaco van Niekerk - sparky@lantic.co.za
   (Any problems, feel free to mail me)

{Please note : I take NO responsibility on the effect of the code  }
{              I've tested it on many machines, so I can't see any }
{              reason why it should not work on yours.             }

{The wonders of the VGA card}
{$N+}
</i></font><font color="#FF0000"><b>program </b></font>run_around<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>crt<font color="#000080">;

</font><font color="#FF0000"><b>type </b></font>header <font color="#000080">= </font><font color="#FF0000"><b>record
       </b></font>manufacturer <font color="#000080">: </font>byte<font color="#000080">;
       </font>version <font color="#000080">: </font>byte<font color="#000080">;
       </font>encoding <font color="#000080">: </font>byte<font color="#000080">;
       </font>bits_per_pixel <font color="#000080">: </font>byte<font color="#000080">;
       </font>xmin<font color="#000080">, </font>ymin<font color="#000080">, </font>xmax<font color="#000080">, </font>ymax <font color="#000080">: </font>integer<font color="#000080">;
       </font>hdpi<font color="#000080">, </font>vdpi <font color="#000080">: </font>integer<font color="#000080">;
       </font>colormap <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">47</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
       </font>reserved <font color="#000080">: </font>byte<font color="#000080">;
       </font>nplanes <font color="#000080">: </font>byte<font color="#000080">;
       </font>bytes_per_line <font color="#000080">: </font>integer<font color="#000080">;
       </font>palette_info <font color="#000080">: </font>integer<font color="#000080">;
       </font>hscreensize<font color="#000080">, </font>vscreensize <font color="#000080">: </font>integer<font color="#000080">;
       </font>dummy <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">53</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>width <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">80</font><font color="#000080">; </font><font color="#008000"><i>{80 * 8 = 640}
      </i></font>fade <font color="#000080">= </font><font color="#800000">20</font><font color="#000080">;
      </font>spin <font color="#000080">= </font><font color="#800000">200</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>initmode<font color="#000080">; </font><font color="#008000"><i>{320x200 chain4 off}
</i></font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{first go to chain-4 mode}
     </i></font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov ah, 0
        mov al, 13h
        int 10h
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#008000"><i>{turn chain-4 bit off}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3c4</font><font color="#000080">]:=</font><font color="#800000">$4</font><font color="#000080">; </font><font color="#008000"><i>{index 2}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3c5</font><font color="#000080">]:=</font>port<font color="#000080">[</font><font color="#800000">$3c5</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$f7</font><font color="#000080">; </font><font color="#008000"><i>{now set bit 3 to zero}
     {turn off word mode}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3d4</font><font color="#000080">]:=</font><font color="#800000">$17</font><font color="#000080">; </font><font color="#008000"><i>{index 17}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3d5</font><font color="#000080">]:=</font>port<font color="#000080">[</font><font color="#800000">$3d5</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$40</font><font color="#000080">;
     </font><font color="#008000"><i>{turn off double word mode}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3d4</font><font color="#000080">]:=</font><font color="#800000">$14</font><font color="#000080">; </font><font color="#008000"><i>{index 14}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3d5</font><font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
     </font><font color="#008000"><i>{set logical screen width}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3d4</font><font color="#000080">]:=</font><font color="#800000">$13</font><font color="#000080">;
     </font>port<font color="#000080">[</font><font color="#800000">$3d5</font><font color="#000080">]:=</font>width<font color="#000080">;
     </font><font color="#008000"><i>{clear the video memory}
     </i></font>portw<font color="#000080">[</font><font color="#800000">$3c4</font><font color="#000080">]:=</font><font color="#800000">$0f02</font><font color="#000080">;
     </font>fillchar<font color="#000080">(</font>mem<font color="#000080">[</font><font color="#800000">$a000</font><font color="#000080">:</font><font color="#800000">000</font><font color="#000080">],</font><font color="#800000">65535</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>moveto<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>offset <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>offset<font color="#000080">:=</font>width<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">*</font>y<font color="#000080">+(</font>x <font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">);
     </font>port<font color="#000080">[</font><font color="#800000">$3d4</font><font color="#000080">]:=</font><font color="#800000">$c</font><font color="#000080">; </font>port<font color="#000080">[</font><font color="#800000">$3d5</font><font color="#000080">]:=</font>hi<font color="#000080">(</font>offset<font color="#000080">);
     </font>port<font color="#000080">[</font><font color="#800000">$3d4</font><font color="#000080">]:=</font><font color="#800000">$d</font><font color="#000080">; </font>port<font color="#000080">[</font><font color="#800000">$3d5</font><font color="#000080">]:=</font>lo<font color="#000080">(</font>offset<font color="#000080">);
     </font><font color="#008000"><i>{smooth panning compatible}
     </i></font>port<font color="#000080">[</font><font color="#800000">$3c0</font><font color="#000080">]:=</font><font color="#800000">$13 </font><font color="#FF0000"><b>or </b></font><font color="#800000">$20</font><font color="#000080">;
     </font>port<font color="#000080">[</font><font color="#800000">$3c0</font><font color="#000080">]:=(</font>x <font color="#FF0000"><b>mod </b></font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>putpixel<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>word<font color="#000080">; </font>col <font color="#000080">: </font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov ax, 0a000h
   mov es, ax           </font><font color="#008000"><i>{video address in es}
   </i></font><font color="#FF00FF">mov dx, 03c4h        </font><font color="#008000"><i>{mov register value into dx}
   </i></font><font color="#FF00FF">mov al, 02h          </font><font color="#008000"><i>{we want index 2}
   </i></font><font color="#FF00FF">mov ah, 01h          </font><font color="#008000"><i>{from here on, calculate the correct plane}
   </i></font><font color="#FF00FF">mov cx, [x]
   and cx, 3
   shl ah, cl
   out dx, ax           </font><font color="#008000"><i>{one port write}
   </i></font><font color="#FF00FF">mov ax, [y]          </font><font color="#008000"><i>{calculate address}
   </i></font><font color="#FF00FF">shl ax, 1
   shl ax, 4
   mov di, ax
   shl ax, 2
   add di, ax
   mov ax, [x]
   shr ax, 2
   add di, ax
   mov al, [col]
   mov [es:di], al      </font><font color="#008000"><i>{plot the colour}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>getpixel<font color="#000080">(</font>x<font color="#000080">, </font>y <font color="#000080">: </font>word<font color="#000080">):</font>byte<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov ax, 0a000h
   mov es, ax
   mov dx, $3ce         </font><font color="#008000"><i>{prepare port word}
   </i></font><font color="#FF00FF">mov bx, [x]
   and bx, 3
   mov ah, bl
   mov al, 04h
   out dx, ax           </font><font color="#008000"><i>{write ax to port dx}
   </i></font><font color="#FF00FF">mov ax, [y]          </font><font color="#008000"><i>{calculate address}
   </i></font><font color="#FF00FF">shl ax, 1
   shl ax, 4
   mov di, ax
   shl ax, 2
   add di, ax
   mov ax, [x]
   shr ax, 2
   add di, ax
   mov al, [es:di]      </font><font color="#008000"><i>{get the colour}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>pcxbackground<font color="#000080">(</font>fname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#008000"><i>{INPUT  : filename of 256 colour pcx image                       }
{OUTPUT : TRUE if image load successful                          }
{OTHER  : either loads pcx file or not, fades palette in         }
</i></font><font color="#FF0000"><b>const </b></font>dskbufsize <font color="#000080">= </font><font color="#800000">8192</font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>hdrb <font color="#000080">: </font>header<font color="#000080">;
    </font>palb <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font><font color="#008000"><i>{general vars}
    </i></font>f <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
    </font>eb<font color="#000080">, </font>dta<font color="#000080">, </font>rle<font color="#000080">, </font>ecode <font color="#000080">: </font>byte<font color="#000080">;
    </font>dx<font color="#000080">, </font>dy<font color="#000080">, </font>i<font color="#000080">, </font>j  <font color="#000080">: </font>word<font color="#000080">;
    </font>tot<font color="#000080">, </font>mc <font color="#000080">: </font>longint<font color="#000080">;

    </font><font color="#008000"><i>{global cashread vars}
    </i></font>dskbuf <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>dskbufsize<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>cnt<font color="#000080">, </font>cursize <font color="#000080">: </font>word<font color="#000080">;

    </font><font color="#FF0000"><b>function </b></font>casheread <font color="#000080">: </font>byte<font color="#000080">;
    </font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{cashread routine}
         </i></font><font color="#FF0000"><b>if </b></font>cnt<font color="#000080">=</font>cursize <font color="#FF0000"><b>then </b></font><font color="#008000"><i>{read ahead}
         </i></font><font color="#FF0000"><b>begin
              </b></font>blockread<font color="#000080">(</font>f<font color="#000080">, </font>dskbuf<font color="#000080">, </font>dskbufsize<font color="#000080">, </font>cursize<font color="#000080">); </font>cnt<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>cnt<font color="#000080">:=</font>cnt<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
         </font>casheread<font color="#000080">:=</font>dskbuf<font color="#000080">[</font>cnt<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">];
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
     </b></font>assign<font color="#000080">(</font>f<font color="#000080">, </font>fname<font color="#000080">);
     </font><font color="#008000"><i>{$I-} </i></font>reset<font color="#000080">(</font>f<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{$I+} </i></font>eb<font color="#000080">:=</font>ioresult<font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>eb<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
     begin
          </b></font><font color="#008000"><i>{set up globals}
          </i></font>port<font color="#000080">[</font><font color="#800000">$3c8</font><font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">; </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">767 </font><font color="#FF0000"><b>do </b></font>port<font color="#000080">[</font><font color="#800000">$3c9</font><font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
          </font>cnt<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>cursize<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>ecode<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>filesize<font color="#000080">(</font>f<font color="#000080">)&lt;</font><font color="#800000">1920 </font><font color="#FF0000"><b>then </b></font>ecode<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>ecode<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
          begin
               </b></font><font color="#008000"><i>{pcx header}
               </i></font>blockread<font color="#000080">(</font>f<font color="#000080">, </font>hdrb<font color="#000080">, </font><font color="#800000">128</font><font color="#000080">);

               </font><font color="#008000"><i>{256 colour palette}
               </i></font>seek<font color="#000080">(</font>f<font color="#000080">, </font>filesize<font color="#000080">(</font>f<font color="#000080">)-</font><font color="#800000">768</font><font color="#000080">); </font>blockread<font color="#000080">(</font>f<font color="#000080">, </font>palb<font color="#000080">, </font><font color="#800000">768</font><font color="#000080">);
               </font>seek<font color="#000080">(</font>f<font color="#000080">, </font><font color="#800000">128</font><font color="#000080">); </font><font color="#008000"><i>{actual data}
          </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

          </font><font color="#008000"><i>{complete encoding test}
          </i></font><font color="#FF0000"><b>with </b></font>hdrb <font color="#FF0000"><b>do
          begin
</b></font>		<font color="#FF0000"><b>if </b></font>manufacturer<font color="#000080">&lt;&gt;</font><font color="#800000">10 </font><font color="#FF0000"><b>then </b></font>ecode<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">;
</font>		<font color="#FF0000"><b>if </b></font>encoding<font color="#000080">&lt;&gt;</font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font>ecode<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">;
</font>		<font color="#FF0000"><b>if </b></font>bits_per_pixel<font color="#000080">&lt;&gt;</font><font color="#800000">8 </font><font color="#FF0000"><b>then </b></font>ecode<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">;
</font>		<font color="#FF0000"><b>if </b></font>nplanes<font color="#000080">&lt;&gt;</font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font>ecode<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">;
</font>	  <font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>ecode<font color="#000080">&lt;&gt;</font><font color="#800000">3 </font><font color="#FF0000"><b>then
          begin
               </b></font><font color="#008000"><i>{calc needy vars}
               </i></font>dx<font color="#000080">:=(</font>hdrb<font color="#000080">.</font>xmax<font color="#000080">-</font>hdrb<font color="#000080">.</font>xmin<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">; </font>dy<font color="#000080">:=(</font>hdrb<font color="#000080">.</font>ymax<font color="#000080">-</font>hdrb<font color="#000080">.</font>ymin<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
               </font>tot<font color="#000080">:=</font>longint<font color="#000080">(</font>dx<font color="#000080">) * </font>longint<font color="#000080">(</font>dy<font color="#000080">);
               </font>mc<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;

               </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>mc<font color="#000080">&lt;</font>tot<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>ecode<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do
               begin
                    </b></font>dta<font color="#000080">:=</font>casheread<font color="#000080">;
                    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>dta <font color="#FF0000"><b>and </b></font><font color="#800000">$c0</font><font color="#000080">) = </font><font color="#800000">$c0 </font><font color="#FF0000"><b>then
                    begin </b></font><font color="#008000"><i>{run-length-encoding}
                         </i></font>rle<font color="#000080">:=</font>casheread<font color="#000080">; </font>dta<font color="#000080">:=</font>dta <font color="#FF0000"><b>and </b></font><font color="#800000">$3f</font><font color="#000080">;
                         </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>dta<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                             </b></font>putpixel<font color="#000080">((</font>mc<font color="#000080">+</font>i<font color="#000080">) </font><font color="#FF0000"><b>mod </b></font>dx<font color="#000080">, (</font>mc<font color="#000080">+</font>i<font color="#000080">) </font><font color="#FF0000"><b>div </b></font>dx<font color="#000080">, </font>rle<font color="#000080">);
                         </font>inc<font color="#000080">(</font>mc<font color="#000080">, </font>dta<font color="#000080">);
                    </font><font color="#FF0000"><b>end else
                    begin </b></font><font color="#008000"><i>{no compression}
                         </i></font>putpixel<font color="#000080">(</font>mc <font color="#FF0000"><b>mod </b></font>dx<font color="#000080">, </font>mc <font color="#FF0000"><b>div </b></font>dx<font color="#000080">, </font>dta<font color="#000080">);
                         </font>inc<font color="#000080">(</font>mc<font color="#000080">);
                    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
               </font>close<font color="#000080">(</font>f<font color="#000080">);
              </font><font color="#008000"><i>{ for j:=0 to 100 do
               begin} </i></font>j<font color="#000080">:=</font><font color="#800000">100</font><font color="#000080">;
                    </font>port<font color="#000080">[</font><font color="#800000">$3c8</font><font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
                    </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">767 </font><font color="#FF0000"><b>do </b></font>port<font color="#000080">[</font><font color="#800000">$3c9</font><font color="#000080">]:=</font>round<font color="#000080">(</font>palb<font color="#000080">[</font>i<font color="#000080">]*</font>j<font color="#000080">/</font><font color="#800000">100</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">;
              </font><font color="#008000"><i>{ end; }
               </i></font>pcxbackground<font color="#000080">:=</font>true<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>end else </b></font>pcxbackground<font color="#000080">:=</font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>waitretrace<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov dx,3DAh
   @loop1:
   in al,dx
   and al,08h
   jnz @loop1
   @loop2:
   in al,dx
   and al,08h
   jz @loop2
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>i<font color="#000080">, </font>j<font color="#000080">, </font>k <font color="#000080">: </font>word<font color="#000080">;
    </font>x<font color="#000080">, </font>y<font color="#000080">, </font>deg<font color="#000080">, </font>w <font color="#000080">: </font>real<font color="#000080">;
    </font>f <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
    </font>c <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">768</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>real<font color="#000080">;

</font><font color="#FF0000"><b>begin
     </b></font>initmode<font color="#000080">;
     </font><font color="#008000"><i>{any 640x400 pcx file, 8bit}
     </i></font><font color="#FF0000"><b>if </b></font>pcxbackground<font color="#000080">(</font><font color="#800000">'yourfile.pcx'</font><font color="#000080">) </font><font color="#FF0000"><b>then
     begin
          </b></font>x<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>y<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>deg<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#FF0000"><b>while </b></font>keypressed <font color="#FF0000"><b>do </b></font>readkey<font color="#000080">;

          </font><font color="#FF0000"><b>repeat
                </b></font>moveto<font color="#000080">(</font>round<font color="#000080">(</font><font color="#800000">160</font><font color="#000080">+</font>x<font color="#000080">), </font>round<font color="#000080">(</font><font color="#800000">100</font><font color="#000080">+</font>y<font color="#000080">));
                </font>x<font color="#000080">:=</font><font color="#800000">160</font><font color="#000080">*</font>sin<font color="#000080">(</font>deg<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">)*</font>cos<font color="#000080">(</font>deg<font color="#000080">);
                </font>y<font color="#000080">:=</font><font color="#800000">100</font><font color="#000080">*</font>sin<font color="#000080">(</font>deg<font color="#000080">/</font><font color="#800000">2</font><font color="#000080">)*</font>sin<font color="#000080">(</font>deg<font color="#000080">);
                </font>deg<font color="#000080">:=</font>deg<font color="#000080">+</font><font color="#800000">0.001</font><font color="#000080">;
          </font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov ah, 0
        mov al, 03h
        int 10h
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
--</font><font color="#FF0000"><b>Message</b></font><font color="#000080">-</font>Boundary<font color="#000080">-</font><font color="#800000">5639
</font>Content<font color="#000080">-</font><font color="#FF0000"><b>type</b></font><font color="#000080">: </font>text<font color="#000080">/</font>plain<font color="#000080">; </font>charset<font color="#000080">=</font>US<font color="#000080">-</font>ASCII
Content<font color="#000080">-</font>transfer<font color="#000080">-</font>encoding<font color="#000080">: </font><font color="#800000">7</font>BIT
Content<font color="#000080">-</font>description<font color="#000080">: </font>Text from <font color="#FF0000"><b>file </b></font><font color="#800000">'RS232.PAS'

</font><font color="#008000"><i>{ By Jaco van Niekerk - sparky@lantic.co.za
   (Any problems, feel free to mail me)

  Unit to handle RS232 communication
  Set the COM ports up with open_serial
  Shut down with close_serial
  recieve_byte and send_byte fot the communication }

{Please note : I take NO responsibility on the effect of the code  }
{              I've tested it on many machines, so I can't see any }
{              reason why it should not work on yours.             }


</i></font><font color="#FF0000"><b>unit </b></font>rs232<font color="#000080">;

</font><font color="#FF0000"><b>interface

const </b></font>COM_1 <font color="#000080">= </font><font color="#800000">$3f8</font><font color="#000080">;
      </font>COM_2 <font color="#000080">= </font><font color="#800000">$2f8</font><font color="#000080">;

      </font>SER_BAUD_600 <font color="#000080">= </font><font color="#800000">192</font><font color="#000080">;
      </font>SER_BAUD_1200 <font color="#000080">= </font><font color="#800000">96</font><font color="#000080">;
      </font>SER_BAUD_2400 <font color="#000080">= </font><font color="#800000">48</font><font color="#000080">;
      </font>SER_BAUD_9600 <font color="#000080">= </font><font color="#800000">12</font><font color="#000080">;
      </font>SER_BAUD_19200 <font color="#000080">= </font><font color="#800000">6</font><font color="#000080">;
      </font>SER_BAUD_115200 <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;

      </font>SER_STOP_1 <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
      </font>SER_STOP_2 <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;

      </font>SER_BITS_5 <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
      </font>SER_BITS_6 <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
      </font>SER_BITS_7 <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
      </font>SER_BITS_8 <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;

      </font>PARITY_NONE <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
      </font>PARITY_ODD <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;
      </font>PARITY_EVEN <font color="#000080">= </font><font color="#800000">24</font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>chars_waiting <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>open_serial<font color="#000080">(</font>port_base<font color="#000080">, </font>baud<font color="#000080">, </font>configuration <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>close_serial<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>receive_byte<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>send_byte<font color="#000080">(</font>thingy <font color="#000080">: </font>byte<font color="#000080">);

</font><font color="#FF0000"><b>implementation
uses </b></font>dos<font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>Max_buffer_size <font color="#000080">= </font><font color="#800000">8192</font><font color="#000080">;   </font><font color="#008000"><i>{8kb circular buffer}

{these variables CAN NOT be implemented as locals
{and must therefore be declared global}

</i></font><font color="#FF0000"><b>var </b></font>open_port <font color="#000080">: </font>word<font color="#000080">;
    </font>serial_lock <font color="#000080">: </font>byte<font color="#000080">;
    </font>old_int_mask <font color="#000080">: </font>byte<font color="#000080">;
    </font>old_handler <font color="#000080">: </font><font color="#FF0000"><b>procedure</b></font><font color="#000080">;
    </font>my_buffer <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>Max_buffer_size<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>buf_read<font color="#000080">, </font>buf_write <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>my_handler<font color="#000080">;</font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>my_byte <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>serial_lock<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;                    </font><font color="#008000"><i>{lock the buffer}
     </i></font>my_byte<font color="#000080">:=</font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">0</font><font color="#000080">];      </font><font color="#008000"><i>{get byte from harware port}
     </i></font>my_buffer<font color="#000080">[</font>buf_write<font color="#000080">]:=</font>my_byte<font color="#000080">;     </font><font color="#008000"><i>{put byte into software buffer}

     </i></font>buf_write<font color="#000080">:=(</font>buf_write<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>mod </b></font>Max_buffer_size<font color="#000080">;  </font><font color="#008000"><i>{add + wrap around}
     </i></font>inc<font color="#000080">(</font>chars_waiting<font color="#000080">);                            </font><font color="#008000"><i>{one more byte}

     </i></font>port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;          </font><font color="#008000"><i>{let PIC know, we are done!}
     </i></font>serial_lock<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;          </font><font color="#008000"><i>{unlock buffer}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>close_serial<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{disable required interrupts}
     </i></font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">4</font><font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
     </font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
     </font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>old_int_mask<font color="#000080">;

     </font><font color="#008000"><i>{give controll back to old handler}
     </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>open_port <font color="#000080">= </font>COM_1<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>setintvec<font color="#000080">(</font><font color="#800000">$0c</font><font color="#000080">, </font>addr<font color="#000080">(</font>old_handler<font color="#000080">))
                            </font><font color="#FF0000"><b>else </b></font>setintvec<font color="#000080">(</font><font color="#800000">$0b</font><font color="#000080">, </font>addr<font color="#000080">(</font>old_handler<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>open_serial<font color="#000080">(</font>port_base<font color="#000080">, </font>baud<font color="#000080">, </font>configuration <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{set up global variables}
     </i></font>open_port<font color="#000080">:=</font>port_base<font color="#000080">;
     </font>buf_read<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>buf_write<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
     </font>chars_waiting<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;

     </font><font color="#008000"><i>{set the baud rate}
     </i></font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">3</font><font color="#000080">]:=</font><font color="#800000">128</font><font color="#000080">;
     </font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">0</font><font color="#000080">]:=</font>baud <font color="#FF0000"><b>and </b></font><font color="#800000">255</font><font color="#000080">; </font><font color="#008000"><i>{lsb}
     </i></font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">]:=(</font>baud <font color="#FF0000"><b>shr </b></font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">255</font><font color="#000080">; </font><font color="#008000"><i>{msb}


     {set the configuration}
     </i></font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">3</font><font color="#000080">]:=</font>configuration<font color="#000080">;

     </font><font color="#008000"><i>{setup interrupts and enable them}
     </i></font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">4</font><font color="#000080">]:=</font><font color="#800000">8</font><font color="#000080">;               </font><font color="#008000"><i>{enable interrupts}
     </i></font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">]:=</font><font color="#800000">1</font><font color="#000080">;               </font><font color="#008000"><i>{interrupt CPU for char received}

     {now, take control!}
     </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>open_port <font color="#000080">= </font>COM_1<font color="#000080">) </font><font color="#FF0000"><b>then
     begin
          </b></font>getintvec<font color="#000080">(</font><font color="#800000">$0c</font><font color="#000080">, @</font>old_handler<font color="#000080">);
          </font>setintvec<font color="#000080">(</font><font color="#800000">$0c</font><font color="#000080">, </font>addr<font color="#000080">(</font>my_handler<font color="#000080">));
     </font><font color="#FF0000"><b>end else
     begin
          </b></font>getintvec<font color="#000080">(</font><font color="#800000">$0b</font><font color="#000080">, @</font>old_handler<font color="#000080">);
          </font>setintvec<font color="#000080">(</font><font color="#800000">$0b</font><font color="#000080">, </font>addr<font color="#000080">(</font>my_handler<font color="#000080">));
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#008000"><i>{tell mr. PIC}
     </i></font>old_int_mask<font color="#000080">:=</font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">];
     </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>open_port <font color="#000080">= </font>COM_1<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>old_int_mask <font color="#FF0000"><b>and </b></font><font color="#800000">$ef
                            </font><font color="#FF0000"><b>else </b></font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>old_int_mask <font color="#FF0000"><b>and </b></font><font color="#800000">$e7</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>receive_byte<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>ret_this <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
     while </b></font><font color="#000080">(</font>serial_lock <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>chars_waiting<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
     begin
          </b></font>ret_this<font color="#000080">:=</font>my_buffer<font color="#000080">[</font>buf_read<font color="#000080">];                </font><font color="#008000"><i>{get next byte}
          </i></font>buf_read<font color="#000080">:=(</font>buf_read<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>mod </b></font>Max_buffer_size<font color="#000080">;   </font><font color="#008000"><i>{add + wrap around}
          </i></font>dec<font color="#000080">(</font>chars_waiting<font color="#000080">);                           </font><font color="#008000"><i>{one less byte}
     </i></font><font color="#FF0000"><b>end else </b></font>ret_this<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
     </font>receive_byte<font color="#000080">:=</font>ret_this<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>send_byte<font color="#000080">(</font>thingy <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{pole line-status-register for &quot;ready to send&quot;}
     </i></font><font color="#FF0000"><b>while not</b></font><font color="#000080">((</font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">5</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$20</font><font color="#000080">)=</font><font color="#800000">$20</font><font color="#000080">) </font><font color="#FF0000"><b>do </b></font><font color="#008000"><i>{nothing}</i></font><font color="#000080">;

     </font><font color="#008000"><i>{interrupts has to be disbaled while sending is in progress}
     {unfortunatly this makes full-duplex communications not possible}
     </i></font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>port<font color="#000080">[</font>open_port <font color="#000080">+ </font><font color="#800000">0</font><font color="#000080">]:=</font>thingy<font color="#000080">;
     </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0274.PAS">Original</a><b>]</b></p></body>
</html>
