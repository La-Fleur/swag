<html>
<head><title> "Fast Snow Flakes" by WILLIAM BARATH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0149.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
{you've seen it before, but not this fast... :-) }
(********************************************************************
 Originally idea  : Nick Batalas, ( dated    14-6-1994 )
 Sourced from                   : Eric Coolman, ( modified 19-6-1994 )
 Rewritten by                   : Wil Barath,              03-9-1994
 new : assembly optimisation, random weaving, memory reduction, etc.
 ********************************************************************)
{$G+}
</i></font><font color="#FF0000"><b>Program </b></font>SnowFall<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>Flakes <font color="#000080">= </font><font color="#800000">3000</font><font color="#000080">;     </font><font color="#008000"><i>{ higher = more flakes }
  </i></font>Fastest<font color="#000080">= </font><font color="#800000">240</font><font color="#000080">;      </font><font color="#008000"><i>{ try smaller numbers for slower flakes}
  </i></font>Explosion <font color="#000080">= </font>False<font color="#000080">; </font><font color="#008000"><i>{ False for no explosion }
</i></font><font color="#FF0000"><b>Var </b></font>r<font color="#000080">:</font>Word<font color="#000080">;
</font><font color="#008000"><i>{---------------- Stuff not specific to snowfall ----------------}
</i></font><font color="#FF0000"><b>Procedure </b></font>vidMode<font color="#000080">(</font>mode <font color="#000080">: </font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ah,$00;  mov al,mode; int 10h; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>ReadKey<font color="#000080">:</font>Char<font color="#000080">;</font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">Mov ax,0000h; int 16h; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>Keypressed<font color="#000080">:</font>Boolean<font color="#000080">;</font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">Mov ax,0100h; int 16h; JNZ @1; Xor ax,ax; Ret;
@1: Inc ax; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>Perturb<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;  </font><font color="#008000"><i>{Peturbation algorhythm (C) 1982 BarathSoft}
</i></font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">Mov dx,r; Xor dx,0aa55h; SHL dx,1; Adc dx,$118; Mov r,dx; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------------------------MAIN PROGRAM-------------------------}
</i></font><font color="#FF0000"><b>Type </b></font>FlakeyRec <font color="#000080">= </font><font color="#FF0000"><b>Record </b></font>x<font color="#000080">,</font>y<font color="#000080">:</font>Byte<font color="#000080">;</font>p<font color="#000080">:</font>Word<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var  </b></font>CurFlake<font color="#000080">,</font>s<font color="#000080">,</font>pf<font color="#000080">:</font>Word<font color="#000080">;
                 </font>Flake<font color="#000080">:</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>flakes<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>flakeyrec<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>Pascal_Version<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  repeat
    for </b></font>CurFlake<font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>flakes <font color="#FF0000"><b>do with </b></font>flake<font color="#000080">[</font>curflake<font color="#000080">] </font><font color="#FF0000"><b>do
    begin
      </b></font>Perturb<font color="#000080">; </font>Mem<font color="#000080">[</font><font color="#800000">$a000</font><font color="#000080">:</font>p<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font>x<font color="#000080">&gt;=</font>lo<font color="#000080">(</font>r<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Inc<font color="#000080">(</font>p<font color="#000080">);
      </font><font color="#FF0000"><b>If </b></font>y<font color="#000080">&gt;=</font>Hi<font color="#000080">(</font>r<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Inc<font color="#000080">(</font>p<font color="#000080">,</font><font color="#800000">320</font><font color="#000080">);
      </font>Mem<font color="#000080">[</font><font color="#800000">$a000</font><font color="#000080">:</font>p<font color="#000080">]:=</font>y <font color="#FF0000"><b>SHR </b></font><font color="#800000">5 </font><font color="#000080">+ </font><font color="#800000">$18</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>Repeat Until </b></font><font color="#000080">(</font>port<font color="#000080">[</font><font color="#800000">$3da</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$08</font><font color="#000080">) = </font><font color="#800000">$08</font><font color="#000080">;  </font><font color="#008000"><i>{wait for vRetrace }
  </i></font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>Assembly_version<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  repeat              </b></font><font color="#008000"><i>{ * NOTE * the above pascal version was derived }
       </i></font><font color="#FF0000"><b>ASM            </b></font><font color="#008000"><i>{ from the assembly below, and is Very optimal. }
          </i></font><font color="#FF00FF">Mov dx,r
          Mov cx,flakes             </font><font color="#008000"><i>{for CurFlake:= 1 to flakes do}
          </i></font><font color="#FF00FF">Mov pf,Offset flake;      </font><font color="#008000"><i>{with flake[curflake] do}
          </i></font><font color="#FF00FF">Mov ax,0a000h
          Mov es,ax                 </font><font color="#008000"><i>{begin}
          </i></font><font color="#FF00FF">Mov bx,$118
@0:       Xor dx,0aa55h             </font><font color="#008000"><i>{Perturb }
          </i></font><font color="#FF00FF">SHL dx,1
          Adc dx,bx
          Mov si,pf
          Mov di,[si.FlakeyRec.p]
          Xor al,al
          Mov es:[di],al            </font><font color="#008000"><i>{Mem[$a000:p]:=0;}
          </i></font><font color="#FF00FF">Cmp dl,[si.FlakeyRec.x]   </font><font color="#008000"><i>{If x&gt;=Lo(r) then Inc(p);}
          </i></font><font color="#FF00FF">Jnc @1
          Inc di
@1:       Mov ah,[si.FlakeyRec.y]
          Cmp dh,ah                 </font><font color="#008000"><i>{If y&gt;=Hi(r) then Inc(p,320);}
          </i></font><font color="#FF00FF">Jnc @2
          Add di,320
@2:       Mov Word Ptr [si.FlakeyRec.p],di
          Shr ah,5                  </font><font color="#008000"><i>{Mem[$a000:p]:=y SHR 5 + $18;}
          </i></font><font color="#FF00FF">add ah,bl
          Mov es:[di],ah
          Add pf,Type flakeyRec
          Loop @0
          Mov r,dx
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;                        </font><font color="#008000"><i>{end;}
    </i></font><font color="#FF0000"><b>Repeat Until </b></font><font color="#000080">(</font>port<font color="#000080">[</font><font color="#800000">$3da</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$08</font><font color="#000080">) = </font><font color="#800000">$08</font><font color="#000080">;  </font><font color="#008000"><i>{ wait for vRetrace }
  </i></font><font color="#FF0000"><b>until </b></font>keypressed<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Begin
  for </b></font>CurFlake<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Flakes <font color="#FF0000"><b>do With </b></font>Flake<font color="#000080">[</font>curflake<font color="#000080">] </font><font color="#FF0000"><b>do
  begin                              </b></font><font color="#008000"><i>{ set up snow lookup table }
    </i></font>Perturb<font color="#000080">; </font>Inc<font color="#000080">(</font>s<font color="#000080">,</font>r<font color="#000080">);
    </font>y<font color="#000080">:=</font>Hi<font color="#000080">(</font>Hi<font color="#000080">(</font>r<font color="#000080">)*</font>fastest<font color="#000080">)+</font><font color="#800000">5</font><font color="#000080">;
    </font>x<font color="#000080">:=</font>Hi<font color="#000080">(</font>Lo<font color="#000080">(</font>r<font color="#000080">)*</font>y<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;                </font><font color="#008000"><i>{limit x movement}
    </i></font><font color="#FF0000"><b>If </b></font>explosion <font color="#000080">= </font>False <font color="#FF0000"><b>then </b></font>p<font color="#000080">:=</font>s<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>vidMode<font color="#000080">(</font><font color="#800000">$13</font><font color="#000080">);                      </font><font color="#008000"><i>{ 320x200x256 graphics mode }
  </i></font><font color="#FF0000"><b>Repeat
    </b></font>Pascal_version<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>ReadKey<font color="#000080">=</font><font color="#800000">#27 </font><font color="#FF0000"><b>then </b></font>Break<font color="#000080">;
    </font>Assembly_version<font color="#000080">;
  </font><font color="#FF0000"><b>Until </b></font>ReadKey<font color="#000080">=</font><font color="#800000">#27</font><font color="#000080">;
  </font>vidMode<font color="#000080">(</font><font color="#800000">$03</font><font color="#000080">);                      </font><font color="#008000"><i>{ return to 80x25 textmode }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0149.PAS">Original</a><b>]</b></p></body>
</html>
