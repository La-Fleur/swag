<html>
<head><title> "Drawing DOOM-like floors" by GEORGE HARROWER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0205.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{This is my procedure for drawing DOOM-like floors for the game I am working
on. It uses the similar triangle method, but does not work as fast as I
would like. The problem is probably that I am using Turbo Pascal.  I tried to 
optimize using assembler, but have never used it before.   If anyone could 
help me speed it up, I would really appreciate it. I think this procedure runs 
at about 11-12 fps without my wall,objects procedures, at about 8 fps with 
them.  The wall,objects procedures run at about 20 fps without the floor 
procedure.  My goal is for a nice 15 fps with everything.  All speeds are on a 
486 DX2/66.



Sorry for the sloppy code. I'll try to explain.}



</i></font><font color="#FF0000"><b>procedure </b></font>floorcast<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>player1<font color="#000080">:</font>player<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>xp<font color="#000080">,</font>yp<font color="#000080">:</font>integer<font color="#000080">;       </font><font color="#008000"><i>{some of these variables might not be needed}
   </i></font>z<font color="#000080">:</font>word<font color="#000080">;
   </font>i<font color="#000080">:</font>byte<font color="#000080">;
   </font>dd<font color="#000080">:</font>longint<font color="#000080">;
   </font>xstep<font color="#000080">,</font>ystep<font color="#000080">:</font>longint<font color="#000080">;
   </font>scrd<font color="#000080">:</font>integer<font color="#000080">;
   </font>finx1<font color="#000080">,</font>finy1<font color="#000080">:</font>longint<font color="#000080">;
   </font>finx2<font color="#000080">,</font>finy2<font color="#000080">:</font>integer<font color="#000080">;
   </font>finxd<font color="#000080">,</font>finyd<font color="#000080">:</font>longint<font color="#000080">;
   </font>distance<font color="#000080">:</font>longint<font color="#000080">;
   </font>cc<font color="#000080">,</font>colour<font color="#000080">:</font>byte<font color="#000080">;
   </font>ssofs<font color="#000080">:</font>word<font color="#000080">;
   </font>s3<font color="#000080">,</font>o3<font color="#000080">,</font>o4<font color="#000080">,</font>s4<font color="#000080">:</font>word<font color="#000080">;
   </font>mapx<font color="#000080">,</font>mapy<font color="#000080">,</font>bmapx<font color="#000080">,</font>bmapy<font color="#000080">:</font>byte<font color="#000080">;
   </font>ang<font color="#000080">:</font>integer<font color="#000080">;
   </font>v1<font color="#000080">,</font>v2<font color="#000080">:</font>longint<font color="#000080">;
   </font>lookm<font color="#000080">:</font>integer<font color="#000080">;
   </font>flm<font color="#000080">:</font>byte<font color="#000080">;
   </font>loop<font color="#000080">:</font>integer<font color="#000080">;
   </font>ssinc<font color="#000080">:</font>byte<font color="#000080">;
   </font>zinc<font color="#000080">:</font>word<font color="#000080">;
   </font>hh<font color="#000080">:</font>word<font color="#000080">;
   </font>shade<font color="#000080">:</font>byte<font color="#000080">;
   </font>cos2<font color="#000080">,</font>sin2<font color="#000080">,</font>cos1<font color="#000080">,</font>sin1<font color="#000080">:</font>longint<font color="#000080">;
   </font>sf<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>v1<font color="#000080">:=</font>viewcos<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">];                </font><font color="#008000"><i>{to fix the fishbowl effect}
</i></font>v2<font color="#000080">:=</font>viewcos<font color="#000080">^[</font><font color="#800000">319</font><font color="#000080">];
</font>lookm<font color="#000080">:=(</font>player1<font color="#000080">.</font>look<font color="#000080">-</font><font color="#800000">100</font><font color="#000080">); </font><font color="#008000"><i>{to find out if the player is looking up or down}
</i></font>loop<font color="#000080">:=(</font>player1<font color="#000080">.</font>look<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);    </font><font color="#008000"><i>{number of h-lines to draw}
</i></font>hh<font color="#000080">:=(</font>vdis<font color="#000080">)*</font>player1<font color="#000080">.</font>height<font color="#000080">;  </font><font color="#008000"><i>{viewer distance * player height}
</i></font>ang<font color="#000080">:=</font>dangle<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,-</font>dangle<font color="#000080">(</font>player1<font color="#000080">.</font>angle<font color="#000080">,(-</font><font color="#800000">160</font><font color="#000080">)));  </font><font color="#008000"><i>{angle for left most pixel}
</i></font>cos1<font color="#000080">:=</font>cost<font color="#000080">^[</font>ang<font color="#000080">]; </font><font color="#008000"><i>{trig values for angle}
</i></font>sin1<font color="#000080">:=</font>sint<font color="#000080">^[</font>ang<font color="#000080">];
</font>ang<font color="#000080">:=</font>dangle<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,-</font>dangle<font color="#000080">(</font>player1<font color="#000080">.</font>angle<font color="#000080">,(</font><font color="#800000">160</font><font color="#000080">)));  </font><font color="#008000"><i>{angle for right most pixel}
</i></font>cos2<font color="#000080">:=</font>cost<font color="#000080">^[</font>ang<font color="#000080">]; </font><font color="#008000"><i>{trig values for angle}
</i></font>sin2<font color="#000080">:=</font>sint<font color="#000080">^[</font>ang<font color="#000080">];
</font>ssofs<font color="#000080">:=</font><font color="#800000">320</font><font color="#000080">*</font>loop<font color="#000080">+</font>o1<font color="#000080">+</font>xmin<font color="#000080">;  </font><font color="#008000"><i>{screen offset at start of loop}
</i></font>ssinc<font color="#000080">:=</font>xmin<font color="#000080">+</font><font color="#800000">320</font><font color="#000080">-</font>xmax<font color="#000080">;     </font><font color="#008000"><i>{screen offset increment to start each h-line}
</i></font>zinc<font color="#000080">:=</font>xmax<font color="#000080">-</font>xmin<font color="#000080">;          </font><font color="#008000"><i>{size of h-viewport}
</i></font>emsmap<font color="#000080">(</font>handle<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);       </font><font color="#008000"><i>{ems routines for graphics}
</i></font>emsmap<font color="#000080">(</font>handle<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
</font>emsmap<font color="#000080">(</font>handle<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
</font>emsmap<font color="#000080">(</font>handle<font color="#000080">,</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">3</font><font color="#000080">);
</font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font>loop <font color="#FF0000"><b>to </b></font>toomax <font color="#FF0000"><b>do  </b></font><font color="#008000"><i>{loop from horizon to bottom of screen}
</i></font><font color="#FF0000"><b>begin
     </b></font>dd<font color="#000080">:=(</font>hh <font color="#FF0000"><b>div </b></font><font color="#000080">(</font>i<font color="#000080">-</font>player1<font color="#000080">.</font>look<font color="#000080">)); </font><font color="#008000"><i>{temp distance variable used twice}
     </i></font>distance<font color="#000080">:=(</font>dd<font color="#000080">*</font>v1<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;      </font><font color="#008000"><i>{fishbowl adjust}
     </i></font>distance<font color="#000080">:=(</font>distance<font color="#000080">*</font><font color="#800000">5</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;  </font><font color="#008000"><i>{This fixes a strange floor shift for me}
     </i></font>distance<font color="#000080">:=</font>distance<font color="#000080">-</font>lookm<font color="#000080">;      </font><font color="#008000"><i>{adjust for looking up or down}
     </i></font>finx1<font color="#000080">:=((</font>distance<font color="#000080">*</font>cos1<font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">; </font><font color="#008000"><i>{rotate to player angle}
     </i></font>finy1<font color="#000080">:=(-(</font>distance<font color="#000080">*</font>sin1<font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;

     </font>distance<font color="#000080">:=(</font>dd<font color="#000080">*</font>v2<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;         </font><font color="#008000"><i>{same as above for right most pixel}
     </i></font>distance<font color="#000080">:=(</font>distance<font color="#000080">*</font><font color="#800000">5</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
     </font>distance<font color="#000080">:=</font>distance<font color="#000080">-</font>lookm<font color="#000080">;
     </font>finx2<font color="#000080">:=((</font>distance<font color="#000080">*</font>cos2<font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;
     </font>finy2<font color="#000080">:=(-(</font>distance<font color="#000080">*</font>sin2<font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;

     </font>finxd<font color="#000080">:=(</font>finx2<font color="#000080">-</font>finx1<font color="#000080">);  </font><font color="#008000"><i>{x-distance}
     </i></font>finyd<font color="#000080">:=(</font>finy2<font color="#000080">-</font>finy1<font color="#000080">);  </font><font color="#008000"><i>{y-distance}
     </i></font>finx1<font color="#000080">:=</font>finx1<font color="#000080">+</font>player1<font color="#000080">.</font>x<font color="#000080">; </font><font color="#008000"><i>{translate to player position}
     </i></font>finy1<font color="#000080">:=</font>finy1<font color="#000080">+</font>player1<font color="#000080">.</font>y<font color="#000080">;
     </font>xstep<font color="#000080">:=(</font>finxd <font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">320</font><font color="#000080">;  </font><font color="#008000"><i>{x-step along map for each pixel}
     </i></font>ystep<font color="#000080">:=(</font>finyd <font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">320</font><font color="#000080">;  </font><font color="#008000"><i>{x-step along map for each pixel}
     </i></font>finx1<font color="#000080">:=</font>finx1 <font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">;
     </font>finy1<font color="#000080">:=</font>finy1 <font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">;
     </font>z<font color="#000080">:=</font>ssofs<font color="#000080">+</font>zinc<font color="#000080">;  </font><font color="#008000"><i>{value for end of loop}
     </i></font>finx1<font color="#000080">:=(</font>finx1<font color="#000080">+</font>xstep<font color="#000080">*</font>xmin<font color="#000080">); </font><font color="#008000"><i>{ adjust for variable screen size}
     </i></font>finy1<font color="#000080">:=(</font>finy1<font color="#000080">+</font>ystep<font color="#000080">*</font>xmin<font color="#000080">);
     </font><font color="#FF0000"><b>repeat
          if </b></font>mem<font color="#000080">[</font>s1<font color="#000080">:</font>o1<font color="#000080">+</font>ssofs<font color="#000080">]=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{if a wall or object has not been drawn}
          </i></font><font color="#FF0000"><b>begin
          </b></font>xp<font color="#000080">:=</font>finx1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;  </font><font color="#008000"><i>{fixed point shift}
          </i></font>yp<font color="#000080">:=</font>finy1 <font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;
          </font><font color="#FF0000"><b>asm
             </b></font><font color="#FF00FF">mov ax,xp       </font><font color="#008000"><i>{map position}
             </i></font><font color="#FF00FF">shr ax,6
             mov mapx,al
             mov ax,yp
             shr ax,6
             mov mapy,al
             mov ax,xp       </font><font color="#008000"><i>{bitmap position}
             </i></font><font color="#FF00FF">and ax,3Fh
             mov bmapx,al
             mov ax,yp
             and ax,3Fh
             mov bmapy,al
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>mapx<font color="#000080">&gt;</font><font color="#800000">25</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>mapx<font color="#000080">&lt;=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>mapy<font color="#000080">&gt;</font><font color="#800000">25</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>mapy<font color="#000080">&lt;=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
          </b></font>colour<font color="#000080">:=</font><font color="#800000">8   </font><font color="#008000"><i>{check if out of bounds, I have a small map}
          </i></font><font color="#FF0000"><b>else
          begin
          </b></font>colour<font color="#000080">:=</font>floormap<font color="#000080">^[</font>mapx<font color="#000080">,</font>mapy<font color="#000080">]; </font><font color="#008000"><i>{else find colour in map}
          </i></font>flm<font color="#000080">:=</font>flipmap<font color="#000080">^[</font>mapx<font color="#000080">,</font>mapy<font color="#000080">];     </font><font color="#008000"><i>{check if I should flip the bitmap}
          </i></font><font color="#FF0000"><b>if </b></font>flm<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
          begin
          end
          else if </b></font>flm<font color="#000080">=</font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font>bmapx<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">-</font>bmapx
          <font color="#FF0000"><b>else if </b></font>flm<font color="#000080">=</font><font color="#800000">2 </font><font color="#FF0000"><b>then </b></font>bmapy<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">-</font>bmapy
          <font color="#FF0000"><b>else if </b></font>flm<font color="#000080">=</font><font color="#800000">3 </font><font color="#FF0000"><b>then
          begin
               </b></font>bmapx<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">-</font>bmapx<font color="#000080">;
               </font>bmapy<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">-</font>bmapy<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>bmapy<font color="#000080">&gt;</font><font color="#800000">62 </font><font color="#FF0000"><b>then </b></font>bmapy<font color="#000080">:=</font><font color="#800000">62</font><font color="#000080">;
          </font>o4<font color="#000080">:=</font>bmapx<font color="#000080">+((</font>bmapy<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">6</font><font color="#000080">)+</font>ctable<font color="#000080">[</font>colour<font color="#000080">];  </font><font color="#008000"><i>{find the offset of the}
          </i></font><font color="#FF0000"><b>asm                                        </b></font><font color="#008000"><i>{pixel in the bitmap}
             </i></font><font color="#FF00FF">mov es,[segment]
             mov bx,[o4]
             mov dl,byte ptr [es:bx]                </font><font color="#008000"><i>{put it on the screen}
             </i></font><font color="#FF00FF">mov es,[s1]
             mov bx,[ssofs]
             mov byte ptr [es:bx],dl
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>ssofs<font color="#000080">:=</font>ssofs<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;                     </font><font color="#008000"><i>{increment screen offset}
          </i></font>finx1<font color="#000080">:=</font>finx1<font color="#000080">+</font>xstep<font color="#000080">;                 </font><font color="#008000"><i>{step along map}
          </i></font>finy1<font color="#000080">:=</font>finy1<font color="#000080">+</font>ystep<font color="#000080">;
     </font><font color="#FF0000"><b>until </b></font>ssofs<font color="#000080">=</font>z<font color="#000080">;                             </font><font color="#008000"><i>{until end of h-line}
     </i></font>ssofs<font color="#000080">:=</font>ssofs<font color="#000080">+</font>ssinc<font color="#000080">;                        </font><font color="#008000"><i>{move down one h-line}
     </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to GRAPHICS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0205.PAS">Original</a><b>]</b></p></body>
</html>
