<html>
<head><title> "uuencoder" by RAPHAEL VANNEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ENCRYPT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0023.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Some time ago, I posted here an uuencoder with the following comment :

8&lt;--------------------------------------------------------------
This is the fastest I could come up with ; I suspect it's fairly
faster than the one that was posted earlier. Going still faster
would require some change in the algorithm, which I'm much to
lazy to go through &lt;g&gt;.
8&lt;--------------------------------------------------------------

I was recently toying with this UU matter, and came onto that piece of
code in the SWAGS ; I found it amazingly slow, which it actually is, so
here's the new release (about 10 times faster ; I've given up lazyness
for that one).

Please note that the warning still applies :

Beware, this program does not check before overwritting an existing .uue
file. Generally speaking, the error checking is quite light.

{$r-,s-,q-}    { for the sake of speed only }
{$v-}

</i></font><font color="#FF0000"><b>Uses </b></font>DOS <font color="#000080">;

</font><font color="#FF0000"><b>Const
     </b></font>BytesPerLine   <font color="#000080">= </font><font color="#800000">45 </font><font color="#000080">;         </font><font color="#008000"><i>{ maximum bytes per encoded line }
     </i></font>Masque6bits    <font color="#000080">= </font><font color="#800000">$3f </font><font color="#000080">;        </font><font color="#008000"><i>{ mask for six lower bits }

</i></font><font color="#FF0000"><b>Procedure </b></font>EncodeBuffer<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Buf <font color="#000080">; </font>Len <font color="#000080">: </font>Integer <font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Res <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) ;
</font><font color="#008000"><i>{ UUEncodes Len bytes from Buf into Res }
</i></font><font color="#FF0000"><b>Assembler </b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
     </b></font><font color="#FF00FF">Push DS
     ClD
     LDS  SI, Buf        </font><font color="#008000"><i>{ source buffer }
     </i></font><font color="#FF00FF">LES  DI, Res        </font><font color="#008000"><i>{ destination buffer }
     </i></font><font color="#FF00FF">Mov  CX, Len        </font><font color="#008000"><i>{ source length }
     </i></font><font color="#FF00FF">Inc  DI             </font><font color="#008000"><i>{ ES:DI points to first char of Res }
     </i></font><font color="#FF00FF">Mov  AL, CL
     Add  AL, ' '
     StoSB               </font><font color="#008000"><i>{ store coded number of bytes in line }
     </i></font><font color="#FF00FF">Mov  DL, 1          </font><font color="#008000"><i>{ DL will hold the actual length of Res }
</i></font><font color="#FF00FF">@1:
     </font><font color="#008000"><i>{ This loops process 3 input bytes to make 4 output characters }
     </i></font><font color="#FF00FF">LodSB               </font><font color="#008000"><i>{ 1st byte }
     </i></font><font color="#FF00FF">Mov  BL, AL         </font><font color="#008000"><i>{ save it }
     </i></font><font color="#FF00FF">ShR  AL, 2          </font><font color="#008000"><i>{ keep 6 most significant bits (msb) }
     </i></font><font color="#FF00FF">Add  AL, ' '        </font><font color="#008000"><i>{ encode }
     </i></font><font color="#FF00FF">StoSB               </font><font color="#008000"><i>{ store in Res }
     </i></font><font color="#FF00FF">ShL  BL, 4          </font><font color="#008000"><i>{ BL's 4 msb contains 1st byte's 4 lsb }
     </i></font><font color="#FF00FF">LodSB               </font><font color="#008000"><i>{ load 2nd byte }
     </i></font><font color="#FF00FF">Mov  BH, AL         </font><font color="#008000"><i>{ save it }
     </i></font><font color="#FF00FF">ShR  AL, 4          </font><font color="#008000"><i>{ AL's 4 lsb contains 2nd byte's 4 msb }
     </i></font><font color="#FF00FF">Or   AL, BL
     And  AL, Masque6bits</font><font color="#008000"><i>{ clear out 2 msb }
     </i></font><font color="#FF00FF">Add  AL, ' '        </font><font color="#008000"><i>{ encode }
     </i></font><font color="#FF00FF">StoSB               </font><font color="#008000"><i>{ store 2nd char }
     </i></font><font color="#FF00FF">LodSB               </font><font color="#008000"><i>{ load 3rd byte }
     </i></font><font color="#FF00FF">Mov  BL, AL         </font><font color="#008000"><i>{ save it }
     </i></font><font color="#FF00FF">And  BH, $0f        </font><font color="#008000"><i>{ BH now holds 4 lsb of 2nd byte }
     </i></font><font color="#FF00FF">ShL  AL, 1          </font><font color="#008000"><i>{ rotate BH:AL... }
     </i></font><font color="#FF00FF">RCL  BH, 1          </font><font color="#008000"><i>{ ...left 2 bits so that... }
     </i></font><font color="#FF00FF">ShL  AL, 1          </font><font color="#008000"><i>{ ...6 lsb of BH contains 4 lsb of 2nd byte... }
     </i></font><font color="#FF00FF">RCL  BH, 1          </font><font color="#008000"><i>{ ...and 2 msb of 3rd byte (clear ?) }
     </i></font><font color="#FF00FF">Mov  AL, BH
     Add  AL, ' '        </font><font color="#008000"><i>{ encode 3rd char }
     </i></font><font color="#FF00FF">StoSB               </font><font color="#008000"><i>{ store it }
     </i></font><font color="#FF00FF">Mov  AL, BL         </font><font color="#008000"><i>{ BL contains 3rd byte }
     </i></font><font color="#FF00FF">And  AL, Masque6bits</font><font color="#008000"><i>{ keep only 6 lsb }
     </i></font><font color="#FF00FF">Add  AL, ' '        </font><font color="#008000"><i>{ encode }
     </i></font><font color="#FF00FF">StoSB               </font><font color="#008000"><i>{ store 4th char }
     </i></font><font color="#FF00FF">Add  DL, 4          </font><font color="#008000"><i>{ add 4 to resulting string's length }
     </i></font><font color="#FF00FF">Sub  CX, 3          </font><font color="#008000"><i>{ 3 bytes processed }
     </i></font><font color="#FF00FF">JA   @1             </font><font color="#008000"><i>{ if more to process, loop }
     </i></font><font color="#FF00FF">Mov  DI, Word Ptr Res
     Mov  ES:[DI], DL    </font><font color="#008000"><i>{ store resulting string's length }
     </i></font><font color="#FF00FF">Pop  DS
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ReplaceSpaceWithBackQuote<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Str <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) ;
</font><font color="#008000"><i>{ Replaces ' ' with '`' in Str }
</i></font><font color="#FF0000"><b>Assembler </b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
     </b></font><font color="#FF00FF">LES  DI, Str
     Mov  CL, ES:[DI]
     XOr  CH, CH
     ClD
     Inc  DI
     Mov  AX, '`'*256+' '
#1:
     JCXZ @2
     RepNE ScaSB
     JNE  @2
     Mov  ES:[DI-1], AH
     Jmp  #1
@2:
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var  </b></font><font color="#008000"><i>{ buffers for input and output files }
     </i></font>InBuf     <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">100</font><font color="#000080">*</font>BytesPerLine<font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte <font color="#000080">;
     </font>OutBuf    <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8192</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Char <font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EncodeFile<font color="#000080">(</font>FName <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) ;
</font><font color="#FF0000"><b>Var  </b></font>InF  <font color="#000080">: </font><font color="#FF0000"><b>File </b></font><font color="#000080">;            </font><font color="#008000"><i>{ input file }
     </i></font>OutF <font color="#000080">: </font>Text <font color="#000080">;            </font><font color="#008000"><i>{ output file }
     </i></font>OutB <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font>BytesPerLine<font color="#000080">*</font><font color="#800000">4 </font><font color="#FF0000"><b>Div </b></font><font color="#800000">3</font><font color="#000080">+</font><font color="#800000">4</font><font color="#000080">] ; </font><font color="#008000"><i>{ output buffer }
     </i></font>Lus  <font color="#000080">: </font>Word <font color="#000080">;            </font><font color="#008000"><i>{ # of bytes read from input file }
     </i></font>InP  <font color="#000080">: </font>Word <font color="#000080">;            </font><font color="#008000"><i>{ current pos in input buffer }
     </i></font>Nb   <font color="#000080">: </font>Word <font color="#000080">;            </font><font color="#008000"><i>{ # of bytes to process }

     </i></font>Rep  <font color="#000080">: </font>PathStr <font color="#000080">;
     </font>Nom  <font color="#000080">: </font>NameStr <font color="#000080">;
     </font>Ext  <font color="#000080">: </font>ExtStr <font color="#000080">;
</font><font color="#FF0000"><b>Begin
     </b></font><font color="#008000"><i>{ Open input file }

     </i></font>Assign<font color="#000080">(</font>InF<font color="#000080">, </font>FName<font color="#000080">) ;
     </font><font color="#008000"><i>{$i-}
     </i></font>ReSet<font color="#000080">(</font>InF<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">) ;
     </font><font color="#008000"><i>{$i+}
     </i></font><font color="#FF0000"><b>If </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Then
     Begin
          </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Can''t open '</font><font color="#000080">, </font>FName<font color="#000080">) ;
          </font>Exit <font color="#000080">;
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;

     </font>FSplit<font color="#000080">(</font>FName<font color="#000080">, </font>Rep<font color="#000080">, </font>Nom<font color="#000080">, </font>Ext<font color="#000080">) ;

     </font><font color="#008000"><i>{ Create (erase) output file in current directory }

     </i></font>Assign<font color="#000080">(</font>OutF<font color="#000080">, </font>Nom<font color="#000080">+</font><font color="#800000">'.UUE'</font><font color="#000080">) ;
     </font>ReWrite<font color="#000080">(</font>OutF<font color="#000080">) ;
     </font>SetTextBuf<font color="#000080">(</font>OutF<font color="#000080">, </font>OutBuf<font color="#000080">, </font>SizeOf<font color="#000080">(</font>OutBuf<font color="#000080">)) ;
     </font>WriteLn<font color="#000080">(</font>OutF<font color="#000080">, </font><font color="#800000">'begin 644 '</font><font color="#000080">, </font>Nom<font color="#000080">, </font>Ext<font color="#000080">) ;

     </font><font color="#FF0000"><b>While Not </b></font>EOF<font color="#000080">(</font>InF<font color="#000080">) </font><font color="#FF0000"><b>Do
     Begin
          </b></font><font color="#008000"><i>{ Fill the input buffer }

          </i></font>BlockRead<font color="#000080">(</font>InF<font color="#000080">, </font>InBuf<font color="#000080">, </font>SizeOf<font color="#000080">(</font>InBuf<font color="#000080">), </font>Lus<font color="#000080">) ;
          </font>InP<font color="#000080">:=</font><font color="#800000">1 </font><font color="#000080">;
          </font><font color="#FF0000"><b>If </b></font>Lus<font color="#000080">&lt;</font>SizeOf<font color="#000080">(</font>InBuf<font color="#000080">) </font><font color="#FF0000"><b>Then     </b></font><font color="#008000"><i>{ this 0-filling is optional }
               </i></font>FillChar<font color="#000080">(</font>InBuf<font color="#000080">[</font>Lus<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">], </font>SizeOf<font color="#000080">(</font>InBuf<font color="#000080">)-</font>Lus<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">) ;

          </font><font color="#FF0000"><b>While </b></font>InP<font color="#000080">&lt;=</font>Lus <font color="#FF0000"><b>Do
          Begin
               </b></font><font color="#008000"><i>{ Process BytesPerLine bytes at a time }

               </i></font>Write<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">) ;
               </font>Nb<font color="#000080">:=</font>Lus<font color="#000080">-</font>InP<font color="#000080">+</font><font color="#800000">1 </font><font color="#000080">;
               </font><font color="#FF0000"><b>If </b></font>Nb<font color="#000080">&gt;</font>BytesPerLine <font color="#FF0000"><b>Then </b></font>Nb<font color="#000080">:=</font>BytesPerLine <font color="#000080">;
               </font>EncodeBuffer<font color="#000080">(</font>InBuf<font color="#000080">[</font>InP<font color="#000080">], </font>Nb<font color="#000080">, </font>OutB<font color="#000080">) ;
               </font>ReplaceSpaceWithBackQuote<font color="#000080">(</font>OutB<font color="#000080">) ;
               </font>WriteLn<font color="#000080">(</font>OutF<font color="#000080">, </font>OutB<font color="#000080">) ;
               </font>Inc<font color="#000080">(</font>InP<font color="#000080">, </font>Nb<font color="#000080">) ;
          </font><font color="#FF0000"><b>End </b></font><font color="#000080">;
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;

     </font>Close<font color="#000080">(</font>InF<font color="#000080">) ;

     </font><font color="#008000"><i>{ write UUE footer }

     </i></font>WriteLn<font color="#000080">(</font>OutF<font color="#000080">, </font><font color="#800000">'`'</font><font color="#000080">) ;
     </font>WriteLn<font color="#000080">(</font>OutF<font color="#000080">, </font><font color="#800000">'end'</font><font color="#000080">) ;
     </font>Close<font color="#000080">(</font>OutF<font color="#000080">) ;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
     If </b></font>ParamCount<font color="#000080">&lt;&gt;</font><font color="#800000">1 </font><font color="#FF0000"><b>Then
     Begin
          </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'UUE2 &lt;file name&gt;'</font><font color="#000080">) ;
          </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) ;
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;
     </font>EncodeFile<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)) ;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ENCRYPT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0023.PAS">Original</a><b>]</b></p></body>
</html>
