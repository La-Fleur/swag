<html>
<head><title> "Data Encription" by TREVOR CARLSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ENCRYPT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{   AUTHOR:  Trevor J Carlsen  Copyright 1992. All rights reserved.
             PO Box 568
             Port Hedland WA 6721
             Telephone (091) 73-2026

    This program has been written to demonstrate the coding and decoding
    of a file.

    SYNTAX:   codechal password1 password2 infile outfile

    All four parameters are required.
    The passwords are case sensitive.

    Whilst this program was written purely for the purposes of a challenge
    issued in the Oz Pascal echo, it would not be difficult to upgrade it to
    a commercial grade encryption/decryption utility - there several very
    simple changes to enhance the security of the cypher output. As written it
    will only encrypt or decrypt the first 4096 bytes of a file.  If you wish
    to use the code here as a basis for a commercial product, contact the
    author for details.

    Some may scoff at its simplicity; I say; solve the challenge, then you
    will have the right to call it simple.  You have the tools, this source
    code gives the full details of the encrypting/decrypting algorithm used.

}


</i></font><font color="#FF0000"><b>const
  </b></font>TextSize  <font color="#000080">= </font><font color="#800000">4096</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>buff_type <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>TextSize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;


</font><font color="#FF0000"><b>var
  </b></font>encrypt   <font color="#000080">: </font>boolean<font color="#000080">;
  </font>InFile<font color="#000080">,
  </font>OutFile   <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>c<font color="#000080">,
  </font>BytesRead <font color="#000080">: </font>word<font color="#000080">;
  </font>b         <font color="#000080">: </font>byte<font color="#000080">;
  </font>key       <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>buff_type<font color="#000080">;
  </font>FileBuff  <font color="#000080">: </font>buff_type<font color="#000080">;
  </font>password  <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Hash<font color="#000080">(</font>p <font color="#000080">: </font>pointer<font color="#000080">; </font>numb <font color="#000080">: </font>byte<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>result<font color="#000080">: </font>longint<font color="#000080">);
  </font><font color="#008000"><i>{ When originally called numb must be equal to sizeof    }
  { whatever p is pointing at.  If that is a string numb   }
  { should be equal to length(the_string) and p should be  }
  { ptr(seg(the_string),ofs(the_string)+1)                 }
  </i></font><font color="#FF0000"><b>var
    </b></font>temp<font color="#000080">,
    </font>w    <font color="#000080">: </font>longint<font color="#000080">;
    </font>x    <font color="#000080">: </font>byte<font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font>temp <font color="#000080">:= </font>longint<font color="#000080">(</font>p<font color="#000080">^);  </font>RandSeed <font color="#000080">:= </font>temp<font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#000080">(</font>numb <font color="#000080">- </font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
      </b></font>w <font color="#000080">:= </font>random<font color="#000080">(</font>maxint<font color="#000080">) * </font>random<font color="#000080">(</font>maxint<font color="#000080">) * </font>random<font color="#000080">(</font>maxint<font color="#000080">);
      </font>temp <font color="#000080">:= ((</font>temp <font color="#FF0000"><b>shr </b></font>random<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">)) </font><font color="#FF0000"><b>shl </b></font>random<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">)) +
                </font>w <font color="#000080">+ </font>MemL<font color="#000080">[</font>seg<font color="#000080">(</font>p<font color="#000080">^):</font>ofs<font color="#000080">(</font>p<font color="#000080">^)+</font>x<font color="#000080">];
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>result <font color="#000080">:= </font>result <font color="#FF0000"><b>xor </b></font>temp<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Hash }

</i></font><font color="#FF0000"><b>procedure </b></font>CreateKey<font color="#000080">;
  </font><font color="#008000"><i>{ Creates the &quot;keys&quot; that are used to xor with the data being encrypted }
  { decrypted.                                                            }
  </i></font><font color="#FF0000"><b>var
    </b></font>StrPtr    <font color="#000080">: </font>pointer<font color="#000080">;
    </font>count<font color="#000080">,</font>x   <font color="#000080">: </font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>FillChar<font color="#000080">(</font>key<font color="#000080">,</font>sizeof<font color="#000080">(</font>key<font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">2 </font><font color="#FF0000"><b>do begin
      </b></font>StrPtr <font color="#000080">:= </font>ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>password<font color="#000080">[</font>x<font color="#000080">]),</font>Ofs<font color="#000080">(</font>password<font color="#000080">[</font>x<font color="#000080">])+</font><font color="#800000">1</font><font color="#000080">);
      </font>Hash<font color="#000080">(</font>StrPtr<font color="#000080">,</font>length<font color="#000080">(</font>password<font color="#000080">[</font>x<font color="#000080">]),</font>RandSeed<font color="#000080">);
      </font><font color="#FF0000"><b>for </b></font>count <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>TextSize <font color="#FF0000"><b>do
        </b></font>key<font color="#000080">[</font>x<font color="#000080">,</font>count<font color="#000080">] := </font>key<font color="#000080">[</font>x<font color="#000080">,</font>count<font color="#000080">] </font><font color="#FF0000"><b>xor </b></font>random<font color="#000080">(</font><font color="#800000">256</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Initialise<font color="#000080">;
  </font><font color="#FF0000"><b>var </b></font>st1<font color="#000080">,</font>st2 <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">18</font><font color="#000080">];
  </font><font color="#FF0000"><b>begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'CODECHAL - copyright 1992, Trevor Carlsen. All rights
</font>reserved<font color="#000080">.</font><font color="#800000">');    if ParamCount &lt;&gt; 4 then begin
      </font>writeln<font color="#000080">(</font><font color="#800000">'This program has been written to demonstrate the coding and
</font>deco      writeln<font color="#000080">(</font><font color="#800000">'of a file.'</font><font color="#000080">);
      </font>writeln<font color="#000080">;
      </font>writeln<font color="#000080">(</font><font color="#800000">'SYNTAX:   codechal password1 password2 infile outfile'</font><font color="#000080">);
      </font>writeln<font color="#000080">;
      </font>writeln<font color="#000080">(</font><font color="#800000">'All four parameters are required.'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'The passwords are case sensitive.'</font><font color="#000080">);
      </font>writeln<font color="#000080">;
      </font>halt<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>password<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
    </font>password<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>ParamStr<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>length<font color="#000080">(</font>password<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]) &lt; </font><font color="#800000">8</font><font color="#000080">)  </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>length<font color="#000080">(</font>password<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]) &lt; </font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'Passwords must be at least 8 characters...aborting'</font><font color="#000080">);
      </font>halt<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#008000"><i>{$I-}
    </i></font>assign<font color="#000080">(</font>InFile<font color="#000080">,</font>Paramstr<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">));
    </font>reset<font color="#000080">(</font>InFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>assign<font color="#000080">(</font>OutFile<font color="#000080">,</font>Paramstr<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">));
    </font>rewrite<font color="#000080">(</font>OutFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'I/O error opening files'</font><font color="#000080">);
      </font>halt<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>BlockRead<font color="#000080">(</font>InFile<font color="#000080">,</font>FileBuff<font color="#000080">,</font>TextSize<font color="#000080">,</font>BytesRead<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'I/O error reading file'</font><font color="#000080">);
      </font>halt<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>CodeDeCodeBuffer<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>buffer<font color="#000080">: </font>buff_type<font color="#000080">; </font>c<font color="#000080">: </font>word<font color="#000080">);
  </font><font color="#FF0000"><b>var </b></font>x<font color="#000080">: </font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    for </b></font>x <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>BytesRead <font color="#FF0000"><b>do
      </b></font>buffer<font color="#000080">[</font>x<font color="#000080">] := </font>buffer<font color="#000080">[</font>x<font color="#000080">] </font><font color="#FF0000"><b>xor </b></font>key<font color="#000080">[</font>c<font color="#000080">,</font>x<font color="#000080">];
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Initialise<font color="#000080">;
  </font>CreateKey<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'Working...wait'</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>c <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">2 </font><font color="#FF0000"><b>do
    </b></font>CodeDecodeBuffer<font color="#000080">(</font>FileBuff<font color="#000080">,</font>c<font color="#000080">);
  </font>BlockWrite<font color="#000080">(</font>OutFile<font color="#000080">,</font>FileBuff<font color="#000080">,</font>BytesRead<font color="#000080">);
  </font>close<font color="#000080">(</font>InFile<font color="#000080">);
  </font>close<font color="#000080">(</font>OutFile<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ENCRYPT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p></body>
</html>
