<html>
<head><title> "ENCRYPT.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ENCRYPT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$A+,B-,D-,E+,F-,G+,I+,L-,N-,O-,R-,S-,V-,X+}
{$M 4048,0,131040}
</i></font><font color="#FF0000"><b>Program </b></font>encrypt<font color="#000080">;

</font><font color="#008000"><i>{ Author Trevor J Carlsen - released into the public domain 1992         }
{        PO Box 568                                                      }
{        Port Hedland                                                    }
{        Western Australia 6721                                          }
{        Voice +61 91 73 2026  Data +61 91 73  2569                      }
{        FidoNet 3:690/644                                               }

{ Syntax: encrypt /p=PassWord /k=KeyFile /f=File                         }
{ Example -                                                              }
{         encrypt /p=billbloggs /k=c:\command.com /f=p:\prog\anyFile.pas }

{         PassWord can be any alpha-numeric sequence of AT LEAST four    }
{         Characters.                                                    }

{         KeyFile is the full path of any File on the system that this   }
{         Program runs on.  This File, preferably a large one, must not  }
{         be subject to changes.  This is critical as it is used as a    }
{         pseudo &quot;one time pad&quot; style key and the slightest change will  }
{         render decryption invalid.                                     }

{         File is the full path of the File to be encrypted or decrypted.}

{ notes:  Running Encrypt a second time With exactly the same parameters }
{         decrypts an encrypted File.  For total security the keyFile    }
{         can be stored separately on a floppy.  Without this keyFile or }
{         knowledge of its contents it is IMPOSSIBLE to decrypt the      }
{         encrypted File.                                                }

{         Parameters are Case insensitive and may be in any order and    }
{         may not contain any Dos separator Characters.                  }

</i></font><font color="#FF0000"><b>Const
  </b></font>BufferSize   <font color="#000080">= </font><font color="#800000">65520</font><font color="#000080">;
  </font>Renamed      <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>buffer_      <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>BufferSize <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>buffptr      <font color="#000080">= ^</font>buffer_<font color="#000080">;
  </font>str80        <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">80</font><font color="#000080">];

</font><font color="#FF0000"><b>Var
  </b></font>OldExitProc  <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>KeyFile<font color="#000080">,
  </font>OldFile<font color="#000080">,
  </font>NewFile      <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>KeyBuffer<font color="#000080">,
  </font>Buffer       <font color="#000080">: </font>buffptr<font color="#000080">;
  </font>KeyFileSize<font color="#000080">,
  </font>EncFileSize  <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>PassWord<font color="#000080">,
  </font>KFName<font color="#000080">,
  </font>FFName       <font color="#000080">: </font>str80<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Hash<font color="#000080">(</font>p <font color="#000080">: </font>Pointer<font color="#000080">; </font>numb <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>result<font color="#000080">: </font>LongInt<font color="#000080">);
  </font><font color="#008000"><i>{ When originally called numb must be equal to sizeof    }
  { whatever p is pointing at.  if that is a String numb   }
  { should be equal to length(the_String) and p should be  }        
  { ptr(seg(the_String),ofs(the_String)+1)                 }
  </i></font><font color="#FF0000"><b>Var
    </b></font>temp<font color="#000080">,
    </font>w    <font color="#000080">: </font>LongInt<font color="#000080">;
    </font>x    <font color="#000080">: </font>Byte<font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font>temp <font color="#000080">:= </font>LongInt<font color="#000080">(</font>p<font color="#000080">^);  </font>RandSeed <font color="#000080">:= </font>temp<font color="#000080">;
    </font><font color="#FF0000"><b>For </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#000080">(</font>numb <font color="#000080">- </font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
      </b></font>w <font color="#000080">:= </font>random<font color="#000080">(</font>maxint<font color="#000080">) * </font>random<font color="#000080">(</font>maxint<font color="#000080">) * </font>random<font color="#000080">(</font>maxint<font color="#000080">);
      </font>temp <font color="#000080">:= ((</font>temp <font color="#FF0000"><b>shr </b></font>random<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">)) </font><font color="#FF0000"><b>shl </b></font>random<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">)) +
                </font>w <font color="#000080">+ </font>MemL<font color="#000080">[</font>seg<font color="#000080">(</font>p<font color="#000080">^):</font>ofs<font color="#000080">(</font>p<font color="#000080">^)+</font>x<font color="#000080">];
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>result <font color="#000080">:= </font>result <font color="#FF0000"><b>xor </b></font>temp<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Hash }

</i></font><font color="#FF0000"><b>Procedure </b></font>NewExitProc<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ Does the &quot;housekeeping&quot; necessary on Program termination }
  </i></font><font color="#FF0000"><b>Var </b></font>code <font color="#000080">: </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>ExitProc <font color="#000080">:= </font>OldExitProc<font color="#000080">;  </font><font color="#008000"><i>{ Reset Exit Procedure Pointer to original }
    </i></font><font color="#FF0000"><b>Case </b></font>ExitCode <font color="#FF0000"><b>of
    </b></font><font color="#800000">0</font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Successfully encrypted or decrypted '</font><font color="#000080">,</font>FFName<font color="#000080">);
    </font><font color="#800000">1</font><font color="#000080">: </font><font color="#FF0000"><b>begin
         </b></font>Writeln<font color="#000080">(</font><font color="#800000">'This Program requires 3 parameters -'</font><font color="#000080">);
         </font>Writeln<font color="#000080">(</font><font color="#800000">'  /pPassWord'</font><font color="#000080">);
         </font>Writeln<font color="#000080">(</font><font color="#800000">'  /kKeyFile (full path and name)'</font><font color="#000080">);
         </font>Write  <font color="#000080">(</font><font color="#800000">'  /fFile (The full path and name of the File'</font><font color="#000080">);
         </font>Writeln<font color="#000080">(</font><font color="#800000">' to be processed)'</font><font color="#000080">);
         </font>Writeln<font color="#000080">;
         </font>Write  <font color="#000080">(</font><font color="#800000">'These parameters can be in any order, are Case,'</font><font color="#000080">);
         </font>Writeln<font color="#000080">(</font><font color="#800000">' insensitive, and may not contain any spaces.'</font><font color="#000080">);
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#800000">2</font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Could not find key File'</font><font color="#000080">);
    </font><font color="#800000">3</font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Could not rename and/or open original File'</font><font color="#000080">);
    </font><font color="#800000">4</font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Could not create encrypted File'</font><font color="#000080">);
    </font><font color="#800000">5</font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'I/O error during processing - could not Complete'</font><font color="#000080">);
    </font><font color="#800000">6</font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Insufficient memory available'</font><font color="#000080">);
    </font><font color="#800000">7</font><font color="#000080">: </font><font color="#FF0000"><b>begin
         </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Key  File is too small - aborted'</font><font color="#000080">);
         </font>Writeln<font color="#000080">;
         </font>Writeln<font color="#000080">(</font><font color="#800000">' Key File must be at least as large as the buffer size '</font><font color="#000080">);
         </font>Write  <font color="#000080">(</font><font color="#800000">' or the size of the File to be encrypted, whatever is the'</font><font color="#000080">);
         </font>Writeln<font color="#000080">(</font><font color="#800000">' smaller.'</font><font color="#000080">);
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#800000">8</font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'PassWord must consist of at least 4 Characters'</font><font color="#000080">);
    </font><font color="#FF0000"><b>else </b></font><font color="#008000"><i>{ any other error }
      </i></font>Writeln<font color="#000080">(</font><font color="#800000">'Aborted With error '</font><font color="#000080">,</font>ExitCode<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Case }
    </i></font><font color="#FF0000"><b>if </b></font>Renamed <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>ExitCode <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Writeln<font color="#000080">(</font><font color="#800000">#7'WARNinG: original File''s name is now TEMP.$$$'</font><font color="#000080">);
    </font><font color="#008000"><i>{$I-}
    </i></font>close<font color="#000080">(</font>KeyFile<font color="#000080">); </font>Code <font color="#000080">:= </font>Ioresult<font color="#000080">;
    </font>close<font color="#000080">(</font>NewFile<font color="#000080">); </font>Code <font color="#000080">:= </font>Ioresult<font color="#000080">;
    </font>close<font color="#000080">(</font>OldFile<font color="#000080">); </font>Code <font color="#000080">:= </font>Ioresult<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>ExitCode <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Erase<font color="#000080">(</font>OldFile<font color="#000080">); </font>Code <font color="#000080">:= </font>Ioresult<font color="#000080">;
    </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ NewExitProc }


</i></font><font color="#FF0000"><b>Function </b></font>Str2UpCase<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>S<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ Converts a String S to upper Case.  Valid For English. }
  </i></font><font color="#FF0000"><b>Var
    </b></font>x <font color="#000080">: </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Str2UpCase<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>S<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">];
    </font><font color="#FF0000"><b>For </b></font>x <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>S<font color="#000080">) </font><font color="#FF0000"><b>do
      </b></font>Str2UpCase<font color="#000080">[</font>x<font color="#000080">] := </font>UpCase<font color="#000080">(</font>S<font color="#000080">[</font>x<font color="#000080">]);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Str2UpCase }

</i></font><font color="#FF0000"><b>Procedure </b></font>Initialise<font color="#000080">;
  </font><font color="#FF0000"><b>Var
    </b></font>CommandLine <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font>FPos<font color="#000080">,</font>FLen<font color="#000080">,
    </font>KPos<font color="#000080">,</font>KLen<font color="#000080">,
    </font>PPos<font color="#000080">,</font>PLen   <font color="#000080">: </font>Byte<font color="#000080">;

  </font><font color="#FF0000"><b>Procedure  </b></font>AllocateMemory<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>p<font color="#000080">: </font>buffptr<font color="#000080">; </font>size<font color="#000080">: </font>LongInt<font color="#000080">);
    </font><font color="#FF0000"><b>begin
      if </b></font>size <font color="#000080">&lt; </font>BufferSize <font color="#FF0000"><b>then begin
        if </b></font>MaxAvail <font color="#000080">&lt; </font>size <font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">6</font><font color="#000080">);
        </font>GetMem<font color="#000080">(</font>p<font color="#000080">,</font>size<font color="#000080">);
      </font><font color="#FF0000"><b>end
      else begin
        if </b></font>MaxAvail <font color="#000080">&lt; </font>BufferSize <font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">6</font><font color="#000080">);
        </font>new<font color="#000080">(</font>p<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ AllocateMemory }

  </i></font><font color="#FF0000"><b>begin
    </b></font>FillChar<font color="#000080">(</font>OldExitProc<font color="#000080">,</font><font color="#800000">404</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);       </font><font color="#008000"><i>{ Initialise all global Variables }
    </i></font>FillChar<font color="#000080">(</font>PassWord<font color="#000080">,</font><font color="#800000">243</font><font color="#000080">,</font><font color="#800000">32</font><font color="#000080">);
    </font>ExitProc    <font color="#000080">:= @</font>NewExitProc<font color="#000080">;             </font><font color="#008000"><i>{ Set up new Exit Procedure }
    </i></font><font color="#FF0000"><b>if </b></font>ParamCount <font color="#000080">&lt;&gt; </font><font color="#800000">3 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
    </font>CommandLine <font color="#000080">:= </font><font color="#FF0000"><b>String</b></font><font color="#000080">(</font>ptr<font color="#000080">(</font>PrefixSeg<font color="#000080">,</font><font color="#800000">$80</font><font color="#000080">)^)+</font><font color="#800000">' '</font><font color="#000080">; </font><font color="#008000"><i>{ Add trailing space }
    </i></font>CommandLine <font color="#000080">:= </font>Str2UpCase<font color="#000080">(</font>CommandLine<font color="#000080">);      </font><font color="#008000"><i>{ Convert to upper Case }
    </i></font>PPos        <font color="#000080">:= </font>pos<font color="#000080">(</font><font color="#800000">'/P='</font><font color="#000080">,</font>CommandLine<font color="#000080">);     </font><font color="#008000"><i>{ Find passWord parameter }
    </i></font>KPos        <font color="#000080">:= </font>pos<font color="#000080">(</font><font color="#800000">'/K='</font><font color="#000080">,</font>CommandLine<font color="#000080">);      </font><font color="#008000"><i>{ Find keyFile parameter }
    </i></font>FPos        <font color="#000080">:= </font>pos<font color="#000080">(</font><font color="#800000">'/F='</font><font color="#000080">,</font>CommandLine<font color="#000080">); </font><font color="#008000"><i>{ Find Filename For encryption}
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>PPos <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>KPos <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>FPos <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
    </font>FFName      <font color="#000080">:= </font>copy<font color="#000080">(</font>CommandLine<font color="#000080">,</font>FPos<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">80</font><font color="#000080">);
    </font>FFName<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]   := </font>chr<font color="#000080">(</font>pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">,</font>FFName<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);       </font><font color="#008000"><i>{ Correct String length }
    </i></font>KFName      <font color="#000080">:= </font>copy<font color="#000080">(</font>CommandLine<font color="#000080">,</font>KPos<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">80</font><font color="#000080">);
    </font>KFName<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]   := </font>chr<font color="#000080">(</font>pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">,</font>KFName<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
    </font>PassWord    <font color="#000080">:= </font>copy<font color="#000080">(</font>CommandLine<font color="#000080">,</font>PPos<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">80</font><font color="#000080">);
    </font>PassWord<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>chr<font color="#000080">(</font>pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">,</font>PassWord<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>length<font color="#000080">(</font>PassWord<font color="#000080">) &lt; </font><font color="#800000">4 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">);
    </font><font color="#008000"><i>{ Create a random seed value based on the passWord }
    </i></font>Hash<font color="#000080">(</font>ptr<font color="#000080">(</font>seg<font color="#000080">(</font>PassWord<font color="#000080">),</font>ofs<font color="#000080">(</font>PassWord<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">),</font>length<font color="#000080">(</font>PassWord<font color="#000080">),</font>RandSeed<font color="#000080">);
    </font>assign<font color="#000080">(</font>OldFile<font color="#000080">,</font>FFName<font color="#000080">);
    </font><font color="#008000"><i>{$I-}
    </i></font>rename<font color="#000080">(</font>OldFile<font color="#000080">,</font><font color="#800000">'TEMP.$$$'</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>halt<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">)
    </font><font color="#FF0000"><b>else
      </b></font>renamed <font color="#000080">:= </font>True<font color="#000080">;
    </font>assign<font color="#000080">(</font>OldFile<font color="#000080">,</font><font color="#800000">'TEMP.$$$'</font><font color="#000080">);
    </font>reset<font color="#000080">(</font>OldFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">);
    </font>assign<font color="#000080">(</font>NewFile<font color="#000080">,</font>FFName<font color="#000080">);
    </font>reWrite<font color="#000080">(</font>NewFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">);
    </font>assign<font color="#000080">(</font>KeyFile<font color="#000080">,</font>KFName<font color="#000080">);
    </font>reset<font color="#000080">(</font>KeyFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
    </font>EncFileSize <font color="#000080">:= </font>FileSize<font color="#000080">(</font>OldFile<font color="#000080">);
    </font>KeyFileSize <font color="#000080">:= </font>FileSize<font color="#000080">(</font>KeyFile<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>KeyFileSize <font color="#000080">&gt; </font>EncFileSize <font color="#FF0000"><b>then
      </b></font>KeyFileSize <font color="#000080">:= </font>EncFileSize<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
    </font><font color="#008000"><i>{$I+}
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>KeyFileSize <font color="#000080">&lt; </font>BufferSize<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>KeyFileSize <font color="#000080">&lt; </font>EncFileSize<font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>halt<font color="#000080">(</font><font color="#800000">7</font><font color="#000080">);
    </font>AllocateMemory<font color="#000080">(</font>buffer<font color="#000080">,</font>EncFileSize<font color="#000080">);
    </font>AllocateMemory<font color="#000080">(</font>KeyBuffer<font color="#000080">,</font>KeyFileSize<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Initialise }

</i></font><font color="#FF0000"><b>Procedure </b></font>Main<font color="#000080">;
  </font><font color="#FF0000"><b>Var
    </b></font>BytesRead <font color="#000080">: </font>Word<font color="#000080">;
    </font>finished  <font color="#000080">: </font>Boolean<font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>CodeBuffer<font color="#000080">(</font>number<font color="#000080">: </font>Word<font color="#000080">);
    </font><font color="#008000"><i>{ This is the actual encryption/decryption engine }
    </i></font><font color="#FF0000"><b>Var </b></font>x <font color="#000080">: </font>Word<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      For </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>number <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do
        </b></font>buffer<font color="#000080">^[</font>x<font color="#000080">] := </font>buffer<font color="#000080">^[</font>x<font color="#000080">] </font><font color="#FF0000"><b>xor </b></font>KeyBuffer<font color="#000080">^[</font>x<font color="#000080">] </font><font color="#FF0000"><b>xor </b></font>Random<font color="#000080">(</font><font color="#800000">256</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ CodeBuffer }

  </i></font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{$I-}
    </i></font>finished <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>Repeat
      </b></font>BlockRead<font color="#000080">(</font>OldFile<font color="#000080">,</font>buffer<font color="#000080">^,</font>BufferSize<font color="#000080">,</font>BytesRead<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>FilePos<font color="#000080">(</font>KeyFile<font color="#000080">) + </font>BytesRead<font color="#000080">) &gt; </font>KeyFileSize <font color="#FF0000"><b>then
        </b></font>seek<font color="#000080">(</font>KeyFile<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font>BlockRead<font color="#000080">(</font>KeyFile<font color="#000080">,</font>KeyBuffer<font color="#000080">^,</font>BytesRead<font color="#000080">,</font>BytesRead<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
      </font>CodeBuffer<font color="#000080">(</font>BytesRead<font color="#000080">);
      </font>finished <font color="#000080">:= </font>BytesRead <font color="#000080">&lt; </font>BufferSize<font color="#000080">;
      </font>BlockWrite<font color="#000080">(</font>NewFile<font color="#000080">,</font>buffer<font color="#000080">^,</font>BytesRead<font color="#000080">);
    </font><font color="#FF0000"><b>Until </b></font>finished<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Main }

</i></font><font color="#FF0000"><b>begin
  </b></font>Initialise<font color="#000080">;
  </font>Main<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ENCRYPT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p></body>
</html>
