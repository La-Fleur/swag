<html>
<head><title> "DMA Transfers with Sound Blaster" by IAN ASH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{                                SBLASTER.PAS                            }
{ A small unit demonstrating DMA transfers to and from the Sound Blaster }
{ as well as simple double buffering techniques.                         }
{               Programmed by Ian Ash of Arcturus.                       }
</i></font><font color="#FF0000"><b>Unit </b></font>SBlaster<font color="#000080">;

</font><font color="#FF0000"><b>interface
uses </b></font>Crt<font color="#000080">, </font>Dos<font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>InitSB<font color="#000080">(</font>rate <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>SBPlay<font color="#000080">(</font>segm<font color="#000080">, </font>ofst<font color="#000080">, </font>lgth <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>SBRecord<font color="#000080">(</font>segm<font color="#000080">, </font>ofst<font color="#000080">, </font>Lgth <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>SetInterrupt<font color="#000080">(</font>Intrrpt <font color="#000080">: </font>Pointer<font color="#000080">);
  </font><font color="#FF0000"><b>Procedure </b></font>Record2Disk<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>buf<font color="#000080">; </font>name <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);

</font><font color="#FF0000"><b>type
  </b></font>InfoType <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>samplerate <font color="#000080">: </font>Byte<font color="#000080">;
  </font>CurrentInterrupt <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>FileIDByte <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Char<font color="#000080">;
  </font>EndOfTransfer <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>BasePort <font color="#000080">= </font><font color="#800000">$220</font><font color="#000080">;
  </font>DSPReset <font color="#000080">= </font>BasePort <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">;
  </font>DSPRead <font color="#000080">= </font>BasePort <font color="#000080">+ </font><font color="#800000">$0A</font><font color="#000080">;
  </font>DSPWrite <font color="#000080">= </font>BasePort <font color="#000080">+ </font><font color="#800000">$0C</font><font color="#000080">;
  </font>DSPDataAvail <font color="#000080">= </font>BasePort <font color="#000080">+ </font><font color="#800000">$0E</font><font color="#000080">;
  </font>IRQ2 <font color="#000080">= </font><font color="#800000">$0A</font><font color="#000080">;
  </font>IRQ3 <font color="#000080">= </font><font color="#800000">$0B</font><font color="#000080">;
  </font>IRQ5 <font color="#000080">= </font><font color="#800000">$0D</font><font color="#000080">;
  </font>IRQ7 <font color="#000080">= </font><font color="#800000">$0F</font><font color="#000080">;

</font><font color="#FF0000"><b>implementation
</b></font><font color="#008000"><i>{ Simple interrupt handler for use. It acknowledges the end of transfer }
{ and then sets a flag EndOfTransfer to indicate the transfer end.      }
</i></font><font color="#FF0000"><b>Procedure </b></font>HandleInterrupt<font color="#000080">; </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Info <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Info <font color="#000080">:= </font>Port<font color="#000080">[</font>DSPDataAvail<font color="#000080">];
  </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>XOR </b></font><font color="#800000">129</font><font color="#000080">;
  </font>EndOfTransfer <font color="#000080">:= </font>True<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>InitSB<font color="#000080">(</font>rate <font color="#000080">: </font>Word<font color="#000080">);  </font><font color="#008000"><i>{ Initializes SoundBlaster And Sets The }
</i></font><font color="#FF0000"><b>var                             </b></font><font color="#008000"><i>{ Sampling Rate To rate Which Is Given In }
  </i></font>ActRate <font color="#000080">: </font>LongInt<font color="#000080">;            </font><font color="#008000"><i>{ Hertz. }
  </i></font>Count <font color="#000080">: </font>Byte<font color="#000080">;
  </font>InitComplete <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CurrentInterrupt <font color="#000080">:= @</font>HandleInterrupt<font color="#000080">;
  </font>sampleRate <font color="#000080">:= </font><font color="#800000">256 </font><font color="#000080">- (</font><font color="#800000">1000000 </font><font color="#FF0000"><b>div </b></font>rate<font color="#000080">);
  </font>Port<font color="#000080">[</font>DSPReset<font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>DSPReset<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSPDataAvail<font color="#000080">] </font><font color="#FF0000"><b>And </b></font><font color="#800000">128</font><font color="#000080">) = </font><font color="#800000">128 </font><font color="#FF0000"><b>Then
  repeat
    </b></font>InitComplete <font color="#000080">:= </font>Port<font color="#000080">[</font>DSPRead<font color="#000080">];
    </font>Count <font color="#000080">:= </font>Count <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>InitComplete <font color="#000080">= </font><font color="#800000">$AA</font><font color="#000080">) </font><font color="#FF0000"><b>Or </b></font><font color="#000080">(</font>Count <font color="#000080">&gt; </font><font color="#800000">150</font><font color="#000080">);
  </font>FileIDByte<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">'I'</font><font color="#000080">; </font>FileIDByte<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font><font color="#800000">'A'</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Plays a digitised sound clip. 'segm' and 'ofst' is the segment and }
{ offset where the data is stored and Lgth is the length in bytes of }
{ the sound clip. Note that this routine can only play a sound clip  }
{ of maximum size 64K.                                               }
</i></font><font color="#FF0000"><b>Procedure </b></font>SBPlay<font color="#000080">(</font>segm<font color="#000080">, </font>ofst<font color="#000080">, </font>Lgth <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>page <font color="#000080">: </font>Byte<font color="#000080">;
  </font>offset <font color="#000080">: </font>Word<font color="#000080">;
  </font>count <font color="#000080">: </font>word<font color="#000080">;
  </font>InitComplete <font color="#000080">: </font>Byte<font color="#000080">;
  </font>OldInt <font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>SetIntVec<font color="#000080">(</font>IRQ5<font color="#000080">, @</font>HandleInterrupt<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>XOR </b></font><font color="#800000">129</font><font color="#000080">;
  </font>page <font color="#000080">:= </font>Hi<font color="#000080">(</font>segm<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">$10</font><font color="#000080">;
  </font>offset <font color="#000080">:= (</font>segm <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">) + </font>ofst<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">$05</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0C</font><font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0B</font><font color="#000080">] := </font><font color="#800000">$49</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$83</font><font color="#000080">] := </font>page<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>lo<font color="#000080">(</font>lgth<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>hi<font color="#000080">(</font>lgth<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font><font color="#800000">$D1</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font><font color="#800000">$40</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font>samplerate<font color="#000080">;
  </font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">]  </font><font color="#FF0000"><b>And </b></font><font color="#800000">128</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font><font color="#800000">$14</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font>lo<font color="#000080">(</font>lgth<font color="#000080">);
  </font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">]  </font><font color="#FF0000"><b>And </b></font><font color="#800000">128</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font>hi<font color="#000080">(</font>lgth<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Records a sound clip to data location whose segment:offset is specified }
{ in 'segm' and 'ofst' respectively. 'lgth' is the number of bytes to be  }
{ recorded.                                                               }
</i></font><font color="#FF0000"><b>Procedure </b></font>SBRecord<font color="#000080">(</font>segm<font color="#000080">, </font>ofst<font color="#000080">, </font>lgth <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>page <font color="#000080">: </font>Byte<font color="#000080">;
  </font>offset <font color="#000080">: </font>Word<font color="#000080">;
  </font>OldInt <font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>SetIntVec<font color="#000080">(</font>IRQ5<font color="#000080">, @</font>HandleInterrupt<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>XOR </b></font><font color="#800000">129</font><font color="#000080">;
  </font>page <font color="#000080">:= </font>Hi<font color="#000080">(</font>segm<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">$10</font><font color="#000080">;
  </font>offset <font color="#000080">:= (</font>segm <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">) + </font>ofst<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">$05</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0C</font><font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0B</font><font color="#000080">] := </font><font color="#800000">$45</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$83</font><font color="#000080">] := </font>page<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>lo<font color="#000080">(</font>lgth<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>hi<font color="#000080">(</font>lgth<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font><font color="#800000">$40</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">]  </font><font color="#FF0000"><b>And </b></font><font color="#800000">128</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font>samplerate<font color="#000080">;
  </font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">]  </font><font color="#FF0000"><b>And </b></font><font color="#800000">128</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font><font color="#800000">$24</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font>lo<font color="#000080">(</font>lgth<font color="#000080">);
  </font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>DSPWrite<font color="#000080">] := </font>hi<font color="#000080">(</font>lgth<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetInterrupt<font color="#000080">(</font>Intrrpt <font color="#000080">: </font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>CurrentInterrupt <font color="#000080">:= </font>Intrrpt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Records a digital sound to disk. buf is a data area to be used as a  }
{ buffer and must be 64K in size (a whole segment!!). name is the name }
{ of the DOS file to store the info in.                                }
</i></font><font color="#FF0000"><b>Procedure </b></font>Record2Disk<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>buf<font color="#000080">; </font>name <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>type
  </b></font>DataType <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>f <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>Data <font color="#000080">: </font>DataType <font color="#FF0000"><b>absolute </b></font>buf<font color="#000080">;
  </font>WorkArea <font color="#000080">: </font>Word<font color="#000080">;
  </font>ch <font color="#000080">: </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>f<font color="#000080">, </font>name<font color="#000080">);
  </font>Rewrite<font color="#000080">(</font>f<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">, </font>FileIDByte<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
  </font>FileIDByte<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>Chr<font color="#000080">(</font>samplerate<font color="#000080">);
  </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">, </font>FileIDByte<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>FileIDByte<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">'I'</font><font color="#000080">;
  </font>ch <font color="#000080">:= </font>ReadKey<font color="#000080">;
  </font>SetInterrupt<font color="#000080">(@</font>handleInterrupt<font color="#000080">);
  </font>EndOfTransfer <font color="#000080">:= </font>False<font color="#000080">;
  </font>WorkArea <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>SBRecord<font color="#000080">(</font>Seg<font color="#000080">(</font>Data<font color="#000080">[</font>WorkArea<font color="#000080">]), </font>Ofs<font color="#000080">(</font>Data<font color="#000080">[</font>WorkArea<font color="#000080">]), </font><font color="#800000">30000</font><font color="#000080">);
  </font><font color="#FF0000"><b>repeat
    repeat until </b></font>EndOfTransfer<font color="#000080">;
    </font>WorkArea <font color="#000080">:= </font><font color="#800000">30500</font><font color="#000080">;
    </font>EndOfTransfer <font color="#000080">:= </font>False<font color="#000080">;
    </font>SBRecord<font color="#000080">(</font>Seg<font color="#000080">(</font>Data<font color="#000080">[</font>WorkArea<font color="#000080">]), </font>Ofs<font color="#000080">(</font>Data<font color="#000080">[</font>WorkArea<font color="#000080">]), </font><font color="#800000">30000</font><font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">, </font>Data<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font><font color="#800000">30000</font><font color="#000080">);
    </font><font color="#FF0000"><b>repeat until </b></font>EndOfTransfer<font color="#000080">;
    </font>WorkArea <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font>EndOfTransfer <font color="#000080">:= </font>False<font color="#000080">;
    </font>SBRecord<font color="#000080">(</font>Seg<font color="#000080">(</font>Data<font color="#000080">[</font>WorkArea<font color="#000080">]), </font>Ofs<font color="#000080">(</font>Data<font color="#000080">[</font>WorkArea<font color="#000080">]), </font><font color="#800000">30000</font><font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">, </font>Data<font color="#000080">[</font>WorkArea <font color="#000080">+ </font><font color="#800000">30499</font><font color="#000080">], </font><font color="#800000">30000</font><font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>KeyPressed<font color="#000080">;
  </font>Close<font color="#000080">(</font>f<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p></body>
</html>
