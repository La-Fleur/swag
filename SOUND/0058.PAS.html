<html>
<head><title> "SB/Adlib FM Synth Code" by DIRK HOESCHEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0058.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{

&gt; Is there a way to play WAV files with TP7.0 for DOS (on SB) ?

I once posted my routine in the german PASCALecho.

Sblast... UNIT for digital Soundeffects in games by DMA and a complete test
of the SB-configs by Dirk Hoeschen (_aptain |-|eadcrash
}

</i></font><font color="#FF0000"><b>UNIT </b></font>SBlast<font color="#000080">;

</font><font color="#FF0000"><b>interface
Uses </b></font>Crt<font color="#000080">,</font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Const
   </b></font>DMA_ADDX_REG  <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;
   </font>DMA_COUNT_REG <font color="#000080">= </font><font color="#800000">$03</font><font color="#000080">;
   </font>DMA_MASK_REG  <font color="#000080">= </font><font color="#800000">$0A</font><font color="#000080">;
   </font>DMA_MODE_REG  <font color="#000080">= </font><font color="#800000">$0B</font><font color="#000080">;
   </font>DMA_FF_REG    <font color="#000080">= </font><font color="#800000">$0C</font><font color="#000080">;
   </font>DMA_PAGE_REG  <font color="#000080">= </font><font color="#800000">$83</font><font color="#000080">;
   </font>DMA_Mode      <font color="#000080">= </font><font color="#800000">$49</font><font color="#000080">;
   </font>DMA_BufSize   <font color="#000080">= </font><font color="#800000">$1000</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
   </font>DMA_activ <font color="#000080">: </font>Boolean<font color="#000080">=</font>false<font color="#000080">;
   </font>SbregDetected <font color="#000080">: </font>Boolean <font color="#000080">= </font>false<font color="#000080">;
   </font>psound <font color="#000080">: </font>Boolean <font color="#000080">= </font>true<font color="#000080">;
   </font>dsp_adr <font color="#000080">: </font>word <font color="#000080">=</font><font color="#800000">$0</font><font color="#000080">;
   </font>dsp_irq <font color="#000080">: </font>byte <font color="#000080">=</font><font color="#800000">$0</font><font color="#000080">;
   </font>DMA_CH  <font color="#000080">: </font>byte <font color="#000080">=</font><font color="#800000">$1</font><font color="#000080">; </font><font color="#008000"><i>{don't change it if you'r not shure}

 </i></font><font color="#FF0000"><b>function  </b></font>Detect_Reg_Sb <font color="#000080">: </font>Boolean<font color="#000080">;
 </font><font color="#008000"><i>{ Find Sbadress! Adresse nachher in dsp_adr.
   false if no SBcard availiable}

 </i></font><font color="#FF0000"><b>function  </b></font>Reset_Sb <font color="#000080">: </font>Boolean<font color="#000080">;

 </font><font color="#FF0000"><b>Function  </b></font>GetDSPversion<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
 </font><font color="#008000"><i>{ Get Versionsnummer the Yamaha OPL}

 </i></font><font color="#FF0000"><b>Procedure </b></font>Find_DSP_Irq<font color="#000080">(</font>Mode<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>irq <font color="#000080">: </font>byte<font color="#000080">);
 </font><font color="#008000"><i>{ If IRQ=0 then no interrupt was found.
   if Mode=1 FIND_IRQ only tests the Interrupt in IRQ}

 </i></font><font color="#FF0000"><b>function  </b></font>wr_dsp_adr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#008000"><i>{writes the address on the screen}

 </i></font><font color="#FF0000"><b>procedure </b></font>wr_dsp<font color="#000080">(</font>v <font color="#000080">: </font>byte<font color="#000080">);
 </font><font color="#FF0000"><b>function  </b></font>Sbreadbyte <font color="#000080">: </font>byte<font color="#000080">;
 </font><font color="#FF0000"><b>procedure </b></font>Sb_Befehl110h<font color="#000080">(</font>v <font color="#000080">: </font>byte<font color="#000080">);

 </font><font color="#FF0000"><b>procedure </b></font>Set_frequence<font color="#000080">(</font>freq <font color="#000080">: </font>Word<font color="#000080">);

 </font><font color="#FF0000"><b>Procedure </b></font>Lautsprecher_Ein<font color="#000080">;
 </font><font color="#FF0000"><b>Procedure </b></font>Lautsprecher_Aus<font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>Play_DMA<font color="#000080">(</font>count <font color="#000080">: </font>Word<font color="#000080">);
 </font><font color="#FF0000"><b>Procedure </b></font>Play_Wave<font color="#000080">(</font>fname <font color="#000080">: </font>pathstr<font color="#000080">);

 </font><font color="#FF0000"><b>Procedure </b></font>Stop_DMA<font color="#000080">;
 </font><font color="#FF0000"><b>Procedure </b></font>Continue_DMA<font color="#000080">;
 </font><font color="#FF0000"><b>Procedure </b></font>Stop_Playing<font color="#000080">;

</font><font color="#FF0000"><b>implementation
Type
    </b></font>Page <font color="#000080">= </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">64000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>Page_point <font color="#000080">= ^</font>Page<font color="#000080">;
    </font>Wave_head <font color="#000080">= </font><font color="#FF0000"><b>ReCord
         </b></font>TypeID <font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#008000"><i>{normally Riff}
         </i></font>Length <font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#008000"><i>{Length of file }
         </i></font>WaveID <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;</font><font color="#008000"><i>{WAVE}
         </i></font>fmtID  <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;</font><font color="#008000"><i>{fmt}
         </i></font>CHlength <font color="#000080">: </font>Longint<font color="#000080">;</font><font color="#008000"><i>{Laenge des Chunks}
         </i></font>Wformat <font color="#000080">: </font>Word<font color="#000080">;</font><font color="#008000"><i>{0=Left /1=Right /2 Stereo}
         </i></font>Wchannels<font color="#000080">: </font>Word<font color="#000080">;</font><font color="#008000"><i>{# of channels 2=Stereo}
         </i></font>Wrate <font color="#000080">: </font>Longint<font color="#000080">;</font><font color="#008000"><i>{frequence}
         </i></font>Wbps  <font color="#000080">: </font>Longint<font color="#000080">;</font><font color="#008000"><i>{Bits per second}
         </i></font>BytespSample <font color="#000080">: </font>Word<font color="#000080">;
         </font>BitspSample <font color="#000080">: </font>Word<font color="#000080">;
         </font>DataID <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;</font><font color="#008000"><i>{Data}
         </i></font>Filler <font color="#000080">: </font>Longint<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
   </b></font>Tbuf<font color="#000080">, </font>SbintSave <font color="#000080">: </font>Pointer<font color="#000080">;
   </font>Soundbuf <font color="#000080">: </font>Page_point<font color="#000080">;
   </font>Rem_size <font color="#000080">: </font>Word<font color="#000080">;
   </font>ppage<font color="#000080">, </font>pofs <font color="#000080">:</font>Word<font color="#000080">;
   </font>frate <font color="#000080">: </font>Word<font color="#000080">;
   </font>IRQ_found<font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Reset_Sb <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>ready <font color="#000080">= </font><font color="#800000">$AA</font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>ct<font color="#000080">,</font>Stat <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$6</font><font color="#000080">]:=</font><font color="#800000">1</font><font color="#000080">;
  </font>delay<font color="#000080">(</font><font color="#800000">100</font><font color="#000080">);
  </font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$6</font><font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
  </font>stat<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>ct  <font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>stat <font color="#000080">&lt;&gt; </font>ready<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Ct<font color="#000080">&lt; </font><font color="#800000">100</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
   </b></font>Stat<font color="#000080">:=</font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$E</font><font color="#000080">];
   </font>Stat<font color="#000080">:=</font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$A</font><font color="#000080">];
   </font>Inc<font color="#000080">(</font>ct<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Reset_Sb <font color="#000080">:= (</font>Stat <font color="#000080">= </font>ready<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>wr_dsp_adr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  case </b></font>dsp_adr <font color="#FF0000"><b>of
    </b></font><font color="#800000">$210 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'210 Hex'</font><font color="#000080">;
    </font><font color="#800000">$220 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'220 Hex'</font><font color="#000080">;
    </font><font color="#800000">$230 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'230 Hex'</font><font color="#000080">;
    </font><font color="#800000">$240 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'240 Hex'</font><font color="#000080">;
    </font><font color="#800000">$250 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'250 Hex'</font><font color="#000080">;
    </font><font color="#800000">$260 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'260 Hex'</font><font color="#000080">;
    </font><font color="#800000">$270 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'270 Hex'</font><font color="#000080">;
    </font><font color="#800000">$280 </font><font color="#000080">: </font>wr_dsp_adr <font color="#000080">:= </font><font color="#800000">'280 Hex'</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Detect_Reg_Sb <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>Port<font color="#000080">, </font>Lst <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>Detect_Reg_Sb <font color="#000080">:= </font>SBRegDetected<font color="#000080">;
  </font>Port <font color="#000080">:= </font><font color="#800000">$210</font><font color="#000080">;
  </font>Lst <font color="#000080">:= </font><font color="#800000">$280</font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>SBRegDetected<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Port <font color="#000080">&lt;= </font>Lst<font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>Dsp_adr<font color="#000080">:=</font>Port<font color="#000080">;
    </font>SbRegDetected<font color="#000080">:= </font>Reset_Sb<font color="#000080">;
    </font><font color="#FF0000"><b>if not </b></font>SBRegDetected <font color="#FF0000"><b>then </b></font>inc<font color="#000080">(</font>Port<font color="#000080">,</font><font color="#800000">$10</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Detect_Reg_Sb <font color="#000080">:= </font>SBRegDetected<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>wr_dsp<font color="#000080">(</font>v <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  While </b></font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$c</font><font color="#000080">] &gt;= </font><font color="#800000">128 </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$c</font><font color="#000080">] := </font>v<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>SbReadByte<font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  While </b></font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$a</font><font color="#000080">] = </font><font color="#800000">$AA </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font>SbReadByte <font color="#000080">:= </font>port<font color="#000080">[</font>dsp_adr<font color="#000080">+</font><font color="#800000">$a</font><font color="#000080">];
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Sb_Befehl110h<font color="#000080">(</font>v <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  </b></font>wr_dsp<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">);
  </font>wr_dsp<font color="#000080">(</font>v<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Set_frequence<font color="#000080">(</font>freq <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>tc<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>tc <font color="#000080">:= </font>trunc<font color="#000080">(</font><font color="#800000">256</font><font color="#000080">-(</font><font color="#800000">1000000</font><font color="#000080">/</font>freq<font color="#000080">));
  </font><font color="#008000"><i>{Die samplefrequenz berechnet sich aus
   256-10000000/Hz}
  </i></font>wr_dsp<font color="#000080">(</font><font color="#800000">$40</font><font color="#000080">); </font><font color="#008000"><i>{40h set frequence}
  </i></font>wr_dsp<font color="#000080">(</font>tc<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Lautsprecher_Ein<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN  </b></font>wr_dsp<font color="#000080">(</font><font color="#800000">$D1</font><font color="#000080">); </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Lautsprecher_Aus<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN  </b></font>wr_dsp<font color="#000080">(</font><font color="#800000">$D3</font><font color="#000080">); </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Stop_DMA<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN  </b></font>wr_dsp<font color="#000080">(</font><font color="#800000">$D0</font><font color="#000080">); </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Continue_DMA<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN  </b></font>wr_dsp<font color="#000080">(</font><font color="#800000">$D4</font><font color="#000080">); </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetDSPversion<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
    </font>SbVersMaj <font color="#000080">: </font>byte<font color="#000080">;
    </font>SbVersMin <font color="#000080">: </font>byte<font color="#000080">;
    </font>SbVersStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">5</font><font color="#000080">];
</font><font color="#FF0000"><b>BEGIN
  </b></font>GetDSPVersion<font color="#000080">:=</font><font color="#800000">';-)'</font><font color="#000080">;
  </font>wr_dsp<font color="#000080">(</font><font color="#800000">$E1</font><font color="#000080">);
  </font>SbVersMaj <font color="#000080">:= </font>SbreadByte<font color="#000080">;
  </font>SbVersMin <font color="#000080">:= </font>SbreadByte<font color="#000080">;
  </font>Str<font color="#000080">(</font>SbversMaj <font color="#000080">, </font>SbVersStr<font color="#000080">);
  </font>SbVersStr<font color="#000080">:= </font>SbVersStr <font color="#000080">+ </font><font color="#800000">'.'</font><font color="#000080">;
  </font>Str<font color="#000080">(</font>SbversMin <font color="#000080">, </font>s<font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>Sbversmin <font color="#000080">&gt; </font><font color="#800000">9 </font><font color="#FF0000"><b>then
    </b></font>SbVersStr<font color="#000080">:= </font>SbVersStr <font color="#000080">+ </font>s
  <font color="#FF0000"><b>else
    </b></font>SbVersStr<font color="#000080">:= </font>SbVersStr <font color="#000080">+ </font><font color="#800000">'0' </font><font color="#000080">+ </font>s<font color="#000080">;
  </font>GetDSPVersion<font color="#000080">:=</font>SBversStr<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Start_DMA_transfer<font color="#000080">(</font>len <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#008000"><i>{ Wie gesagt, hier wird der DMA-controller initialisiert
  und der Befehl $14=Play 8Bit uncompressed via DMA an
  die SB-karte gesendet. Sobald die laenge und die Adresse
  uebergeben ist, startet der Transfer. }
</i></font><font color="#FF0000"><b>type </b></font>pt <font color="#000080">= </font><font color="#FF0000"><b>record
       </b></font>ofs<font color="#000080">, </font>sgm <font color="#000080">: </font>Word<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>L <font color="#000080">: </font>Longint<font color="#000080">;
    </font>pn<font color="#000080">, </font>ofs <font color="#000080">:</font>Word<font color="#000080">;
    </font>dummy<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>dummy<font color="#000080">:=</font>Port<font color="#000080">[</font>DSP_adr<font color="#000080">+</font><font color="#800000">$0E</font><font color="#000080">];
   </font>l <font color="#000080">:= </font><font color="#800000">16</font><font color="#000080">*</font>longint<font color="#000080">(</font>ppage<font color="#000080">)+</font>pofs<font color="#000080">;
   </font>pn <font color="#000080">:= </font>Pt<font color="#000080">(</font>l<font color="#000080">).</font>sgm<font color="#000080">; </font><font color="#008000"><i>{Man beachte die Berechnung der Page}
   </i></font>ofs <font color="#000080">:= </font>Pt<font color="#000080">(</font>l<font color="#000080">).</font>ofs<font color="#000080">;
   </font>Port<font color="#000080">[</font>DMA_MAsk_Reg<font color="#000080">]:=</font>DMA_CH<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">;
   </font>Port<font color="#000080">[</font>DMA_FF_Reg<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
   </font>Port<font color="#000080">[</font>DMA_Mode_Reg<font color="#000080">]:=</font>Dma_Mode<font color="#000080">;
   </font>Port<font color="#000080">[</font>DMA_ADDX_Reg<font color="#000080">]:=</font>Lo<font color="#000080">(</font>ofs<font color="#000080">);
   </font>Port<font color="#000080">[</font>DMA_ADDX_Reg<font color="#000080">]:=</font>hi<font color="#000080">(</font>ofs<font color="#000080">);
   </font>Port<font color="#000080">[</font>DMA_PAGE_Reg<font color="#000080">]:=</font>pn<font color="#000080">;
   </font>Port<font color="#000080">[</font>DMA_COUNT_Reg<font color="#000080">]:=</font>Lo<font color="#000080">(</font>len<font color="#000080">);
   </font>Port<font color="#000080">[</font>DMA_COUNT_Reg<font color="#000080">]:=</font>hi<font color="#000080">(</font>len<font color="#000080">);
   </font>Port<font color="#000080">[</font>DMA_MAsk_Reg<font color="#000080">]:=</font>DMA_CH<font color="#000080">; </font><font color="#008000"><i>{DMA 1 freigeben}</i></font><font color="#000080">;
   </font>wr_dsp<font color="#000080">(</font><font color="#800000">$14</font><font color="#000080">);
   </font>wr_dsp<font color="#000080">(</font>Lo<font color="#000080">(</font>len<font color="#000080">));
   </font>wr_dsp<font color="#000080">(</font>hi<font color="#000080">(</font>len<font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Stop_Playing<font color="#000080">;
</font><font color="#FF0000"><b>begin
 if </b></font>psound <font color="#FF0000"><b>then begin
   </b></font>Stop_DMA<font color="#000080">;
   </font>Port<font color="#000080">[</font>DMA_MAsk_Reg<font color="#000080">]:=</font>DMA_CH<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">;
   </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>DSP_Irq<font color="#000080">);
   </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
   </font>SetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+ </font>DSP_Irq<font color="#000080">,</font>SBIntSave<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DummySBint <font color="#000080">; </font>Interrupt<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>IRQ_found<font color="#000080">:=</font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Find_DSP_Irq<font color="#000080">(</font>Mode<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>irq <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>const </b></font>possible_IRQs <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">5</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte <font color="#000080">= (</font><font color="#800000">$7</font><font color="#000080">,</font><font color="#800000">$5</font><font color="#000080">,</font><font color="#800000">$2</font><font color="#000080">,</font><font color="#800000">$3</font><font color="#000080">,</font><font color="#800000">$10</font><font color="#000080">); </font><font color="#008000"><i>{ Das System
dieser Routine ist einfach, aber auch nicht ganz  ungefaerlich. DummySBint wird
nacheinander in die moeglichen  Soundblasterinterrupts eingeklinkt. Dannach ein
kurzer DMA-  transfer gestartet. Wenn der IRQ stimmt, dann setzt der dummy
  interrupt ein flag.}
</i></font><font color="#FF0000"><b>var </b></font>c <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>getmem<font color="#000080">(</font>tbuf<font color="#000080">,</font><font color="#800000">100</font><font color="#000080">);
  </font>Ppage<font color="#000080">:=</font>seg<font color="#000080">(</font>tBuf<font color="#000080">^);
  </font>Pofs<font color="#000080">:=</font>Ofs<font color="#000080">(</font>tBuf<font color="#000080">^);
  </font>Lautsprecher_Aus<font color="#000080">;
  </font>Set_Frequence<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">);
  </font>IRQ_found<font color="#000080">:=</font>false<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>mode<font color="#000080">=</font><font color="#800000">1 </font><font color="#FF0000"><b>then Begin
      </b></font>GetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>Irq<font color="#000080">,</font>SBIntSave<font color="#000080">);
      </font>SetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>IRQ<font color="#000080">,@</font>DummySBInt<font color="#000080">);
      </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>and not </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>IRQ<font color="#000080">);
      </font>wr_dsp<font color="#000080">(</font><font color="#800000">$D0</font><font color="#000080">);
      </font>Start_DMA_transfer<font color="#000080">(</font><font color="#800000">20</font><font color="#000080">);
      </font>Delay<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">);
      </font>Stop_Playing<font color="#000080">;
      </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>IRQ<font color="#000080">);
      </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
      </font>SetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>Irq<font color="#000080">,</font>SBIntSave<font color="#000080">);
  </font><font color="#FF0000"><b>end else begin
    </b></font>c<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>Repeat
      </b></font>IRQ<font color="#000080">:=</font>Possible_IRQs<font color="#000080">[</font>c<font color="#000080">];
      </font>GetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>Irq<font color="#000080">,</font>SBIntSave<font color="#000080">);
      </font>SetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>IRQ<font color="#000080">,@</font>DummySBInt<font color="#000080">);
      </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>and not </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>IRQ<font color="#000080">);
      </font>wr_dsp<font color="#000080">(</font><font color="#800000">$D0</font><font color="#000080">);
      </font>Start_DMA_transfer<font color="#000080">(</font><font color="#800000">20</font><font color="#000080">);
      </font>Delay<font color="#000080">(</font><font color="#800000">200</font><font color="#000080">);
      </font>Inc<font color="#000080">(</font>c<font color="#000080">);
      </font>Stop_Playing<font color="#000080">;
      </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>IRQ<font color="#000080">);
      </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
      </font>SetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>Irq<font color="#000080">,</font>SBIntSave<font color="#000080">);
    </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>IRQ_found<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>c<font color="#000080">=</font><font color="#800000">6</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>If not </b></font>IRQ_found <font color="#FF0000"><b>then </b></font>IRQ<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>Lautsprecher_Ein<font color="#000080">;
  </font>freemem<font color="#000080">(</font>tbuf<font color="#000080">,</font><font color="#800000">100</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SBint <font color="#000080">; </font>Interrupt<font color="#000080">;
</font><font color="#008000"><i>{ Diese procedure wird in den SB-interrupt eingeklinkt und
  angesprungen, wenn der DMA-Block vollstaendig ausgegeben
  wurde}
</i></font><font color="#FF0000"><b>Begin
  If </b></font>Rem_Size<font color="#000080">&lt;</font><font color="#800000">50 </font><font color="#FF0000"><b>then begin
     </b></font>DMA_ACtiv<font color="#000080">:=</font>False  <font color="#008000"><i>{End of dma_transfer}
     </i></font>Dispose<font color="#000080">(</font>Soundbuff<font color="#000080">);
  </font><font color="#FF0000"><b>end else If </b></font>Rem_size<font color="#000080">&lt;= </font>DMA_bufsize <font color="#FF0000"><b>then begin
     </b></font>Pofs<font color="#000080">:=</font>Pofs<font color="#000080">+</font>DMA_Bufsize<font color="#000080">;
     </font>Start_DMA_transfer<font color="#000080">(</font>Rem_size<font color="#000080">);
     </font>Rem_Size<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;     </font><font color="#008000"><i>{nix mehr uebrig}
    </i></font><font color="#FF0000"><b>end else begin
     </b></font>Pofs<font color="#000080">:=</font>Pofs<font color="#000080">+</font>DMA_Bufsize<font color="#000080">;
     </font>Start_DMA_transfer<font color="#000080">(</font>DMA_bufsize<font color="#000080">);
     </font>Rem_Size<font color="#000080">:=</font>Rem_Size<font color="#000080">-</font>DMA_bufsize<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Play_DMA<font color="#000080">(</font>count <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var
    </b></font>L <font color="#000080">: </font>Longint<font color="#000080">;
    </font>hbyte <font color="#000080">: </font>byte<font color="#000080">;
    </font>a <font color="#000080">: </font>word<font color="#000080">;
    </font>Oldv<font color="#000080">, </font>Newv<font color="#000080">, </font>Hilfe <font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>Ppage<font color="#000080">:=</font>Seg<font color="#000080">(</font>Soundbuff<font color="#000080">^);
   </font>Pofs<font color="#000080">:=</font>Ofs<font color="#000080">(</font>Soundbuff<font color="#000080">^);
   </font>a<font color="#000080">:=</font>Count<font color="#000080">;
   </font><font color="#FF0000"><b>If </b></font>a<font color="#000080">&lt;= </font>DMA_bufsize <font color="#FF0000"><b>then begin
      </b></font>Rem_Size<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>end else begin
      </b></font>Rem_Size<font color="#000080">:=</font>a<font color="#000080">-</font>DMA_bufsize<font color="#000080">;
      </font>a<font color="#000080">:=</font>DMA_bufsize<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Lautsprecher_Ein<font color="#000080">;
   </font>Set_Frequence<font color="#000080">(</font>Frate<font color="#000080">);
   </font>GetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>DSP_Irq<font color="#000080">,</font>SBIntSave<font color="#000080">);
   </font>SetIntVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">+</font>DSP_Irq<font color="#000080">,@</font>SBInt<font color="#000080">);
   </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>and not </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>DSP_Irq<font color="#000080">);
   </font>wr_dsp<font color="#000080">(</font><font color="#800000">$D0</font><font color="#000080">);
   </font>Start_DMA_TRANSFER<font color="#000080">(</font>a<font color="#000080">);
   </font>DMA_activ<font color="#000080">:=</font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Play_Wave<font color="#000080">(</font>fname <font color="#000080">:</font>Pathstr<font color="#000080">);
</font><font color="#FF0000"><b>Var
   </b></font>size <font color="#000080">: </font>LongInt<font color="#000080">;
   </font>IdStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];
   </font>Header <font color="#000080">: </font>Wave_Head<font color="#000080">;
   </font>F <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>psound <font color="#FF0000"><b>then begin
   </b></font>size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>Assign<font color="#000080">(</font>f<font color="#000080">,</font>Fname<font color="#000080">);
   </font>reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
   </font><font color="#FF0000"><b>With </b></font>Header <font color="#FF0000"><b>do begin
    </b></font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>Header<font color="#000080">,</font>sizeOf<font color="#000080">(</font>Header<font color="#000080">));
    </font>IdStr<font color="#000080">:=</font>chr<font color="#000080">(</font>WaveID<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])+</font>chr<font color="#000080">(</font>WaveID<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">])+</font>chr<font color="#000080">(</font>WaveID<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">])+</font>chr<font color="#000080">(</font>WaveID<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">]);
    </font><font color="#FF0000"><b>if </b></font>IdStr <font color="#000080">= </font><font color="#800000">'WAVE' </font><font color="#FF0000"><b>then begin
     </b></font>size <font color="#000080">:= </font>Length<font color="#000080">-</font>Sizeof<font color="#000080">(</font>header<font color="#000080">);
     </font><font color="#FF0000"><b>If </b></font>size<font color="#000080">&gt;</font><font color="#800000">50 </font><font color="#FF0000"><b>then begin
        </b></font>frate<font color="#000080">:=</font>Wrate<font color="#000080">;
        </font>New<font color="#000080">(</font>Soundbuff<font color="#000080">);
        </font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>Soundbuff<font color="#000080">^,</font>size<font color="#000080">);
</font><font color="#008000"><i>{Soundbuff^ is an ARRAY to buffer the WAVe. I know, that the
 unit is very dirty here, but its only do demonstrate how
 it works.}
        </i></font>Play_DMA<font color="#000080">(</font>size<font color="#000080">);
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>close<font color="#000080">(</font>f<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>BEGIN</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0058.PAS">Original</a><b>]</b></p></body>
</html>
