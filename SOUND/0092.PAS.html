<html>
<head><title> "MTM->S3M converter" by JON MERKEL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0092.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Things that WILL mess it up due to ST3 limitations:
    - more than 16 channels
    - more than 8 channels at left or at right
    - 16 bit samples
    - samples greater than 64000 bytes
}

</i></font><font color="#FF0000"><b>program </b></font>mtm2s3m<font color="#000080">;    </font><font color="#008000"><i>{$G+,I-,S-}
 
</i></font><font color="#FF0000"><b>type
    </b></font>S3Mnote <font color="#000080">= </font><font color="#FF0000"><b>record  </b></font>n<font color="#000080">,</font>i<font color="#000080">,</font>v<font color="#000080">,</font>e<font color="#000080">,</font>a<font color="#000080">: </font>byte<font color="#000080">;  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>mtm<font color="#000080">,</font>s3m<font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
    </font>MTMheader<font color="#000080">: </font><font color="#FF0000"><b>record
        </b></font>Marker<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>Version<font color="#000080">: </font>byte<font color="#000080">;
        </font>SongName<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">19</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>NumTracks<font color="#000080">: </font>word<font color="#000080">;
        </font>LastPattern<font color="#000080">, </font>LastOrder<font color="#000080">: </font>byte<font color="#000080">;
        </font>Comment<font color="#000080">: </font>word<font color="#000080">;
        </font>NumSamples<font color="#000080">, </font>Attribute<font color="#000080">, </font>BPM<font color="#000080">, </font>NumChannels<font color="#000080">: </font>byte<font color="#000080">;
        </font>PanPositions<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>S3Mheader<font color="#000080">: </font><font color="#FF0000"><b>record
        </b></font>Sname<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">27</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>EOFtype<font color="#000080">: </font>word<font color="#000080">;
        </font>Reserved1<font color="#000080">: </font>word<font color="#000080">;
        </font>OrdNum<font color="#000080">, </font>InsNum<font color="#000080">, </font>PatNum<font color="#000080">, </font>Flags<font color="#000080">, </font>Cwtv<font color="#000080">, </font>Ffi<font color="#000080">: </font>word<font color="#000080">;
        </font>SCRM<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>GV<font color="#000080">, </font><font color="#FF0000"><b>IS</b></font><font color="#000080">, </font>IT<font color="#000080">, </font>MV<font color="#000080">, </font>UC<font color="#000080">, </font>DP<font color="#000080">: </font>byte<font color="#000080">;
        </font>Reserved2<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">10</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
        </font>Channels<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>S3Mpan<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>MTMins<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">30</font><font color="#000080">] </font><font color="#FF0000"><b>of record
            </b></font>Mname<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">21</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
            </font>MLength<font color="#000080">, </font>MLoopBeg<font color="#000080">, </font>MLoopEnd<font color="#000080">: </font>longint<font color="#000080">;
            </font>FineTune<font color="#000080">, </font>Volume<font color="#000080">, </font>Attrib<font color="#000080">: </font>byte<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>S3Mins<font color="#000080">: </font><font color="#FF0000"><b>record
        </b></font>Itype<font color="#000080">: </font>byte<font color="#000080">;
        </font>Filename<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">12</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>MemSeg<font color="#000080">: </font>word<font color="#000080">;
        </font>Length<font color="#000080">, </font>LoopBeg<font color="#000080">, </font>LoopEnd<font color="#000080">: </font>longint<font color="#000080">;
        </font>Vol<font color="#000080">: </font>word<font color="#000080">;
        </font>P<font color="#000080">, </font>F<font color="#000080">: </font>byte<font color="#000080">;
        </font>C2spd<font color="#000080">: </font>longint<font color="#000080">;
        </font>Reserved<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">12</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
        </font>SampleName<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">27</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>SCRS<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>InsPtrPos<font color="#000080">, </font>PatPtrPos<font color="#000080">, </font>SamplePos<font color="#000080">: </font>longint<font color="#000080">;
    </font>temp<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">8192</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>tempw<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4095</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word <font color="#FF0000"><b>absolute </b></font>temp<font color="#000080">;
    </font>MTMtrack<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte <font color="#FF0000"><b>absolute </b></font>temp<font color="#000080">;
    </font>pattern<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>S3Mnote<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Init<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>fname<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
    if </b></font>pos<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">, </font>fname<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        </b></font>fname<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>chr<font color="#000080">(</font>pos<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">, </font>fname<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
    </font>assign<font color="#000080">(</font>mtm<font color="#000080">, </font>fname<font color="#000080">+</font><font color="#800000">'.MTM'</font><font color="#000080">);
    </font>reset<font color="#000080">(</font>mtm<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>ioresult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
        </b></font>init <font color="#000080">:= </font>false
    <font color="#FF0000"><b>else begin
        </b></font>assign<font color="#000080">(</font>s3m<font color="#000080">, </font>fname<font color="#000080">+</font><font color="#800000">'.S3M'</font><font color="#000080">);
        </font>rewrite<font color="#000080">(</font>s3m<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
        </font>init <font color="#000080">:= </font>true<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 
</font><font color="#FF0000"><b>procedure </b></font>DoHeader<font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>j<font color="#000080">, </font>lcount<font color="#000080">, </font>rcount<font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
    </b></font>blockread<font color="#000080">(</font>mtm<font color="#000080">, </font>MTMheader<font color="#000080">, </font>sizeof<font color="#000080">(</font>MTMheader<font color="#000080">));
    </font>fillchar<font color="#000080">(</font>S3Mheader<font color="#000080">, </font>sizeof<font color="#000080">(</font>S3Mheader<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>with </b></font>MTMheader<font color="#000080">, </font>S3Mheader <font color="#FF0000"><b>do begin
        </b></font>EOFtype <font color="#000080">:= </font><font color="#800000">$101A</font><font color="#000080">; </font>Cwtv <font color="#000080">:= </font><font color="#800000">$1320</font><font color="#000080">; </font>FFi <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">; </font>SCRM <font color="#000080">:= </font><font color="#800000">'SCRM'</font><font color="#000080">;
        </font>GV <font color="#000080">:= </font><font color="#800000">64</font><font color="#000080">; </font><font color="#FF0000"><b>IS </b></font><font color="#000080">:= </font><font color="#800000">6</font><font color="#000080">; </font>IT <font color="#000080">:= </font><font color="#800000">125</font><font color="#000080">; </font>MV <font color="#000080">:= </font><font color="#800000">176</font><font color="#000080">; </font>UC <font color="#000080">:= </font><font color="#800000">16</font><font color="#000080">; </font>DP <font color="#000080">:= </font><font color="#800000">252</font><font color="#000080">;
        </font>move<font color="#000080">(</font>SongName<font color="#000080">, </font>Sname<font color="#000080">, </font><font color="#800000">20</font><font color="#000080">);
        </font>OrdNum <font color="#000080">:= (</font>LastOrder<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>and not </b></font><font color="#800000">1</font><font color="#000080">;
        </font>InsNum <font color="#000080">:= </font>NumSamples<font color="#000080">;
        </font>PatNum <font color="#000080">:= </font>LastPattern<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
        </font>fillchar<font color="#000080">(</font>Channels<font color="#000080">, </font><font color="#800000">32</font><font color="#000080">, </font><font color="#800000">$FF</font><font color="#000080">);
        </font>fillchar<font color="#000080">(</font>S3Mpan<font color="#000080">, </font><font color="#800000">32</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
        </font>lcount <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>rcount <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
        </font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumChannels<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
            </b></font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] := </font>PanPositions<font color="#000080">[</font>j<font color="#000080">];
            </font><font color="#FF0000"><b>if </b></font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] &lt; </font><font color="#800000">8 </font><font color="#FF0000"><b>then begin
                </b></font>Channels<font color="#000080">[</font>j<font color="#000080">] := </font>lcount<font color="#000080">; </font>inc<font color="#000080">(</font>lcount<font color="#000080">);
                </font><font color="#FF0000"><b>if </b></font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] &lt;&gt; </font><font color="#800000">3 </font><font color="#FF0000"><b>then </b></font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] := </font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$20</font><font color="#000080">;
            </font><font color="#FF0000"><b>end
            else begin
                </b></font>Channels<font color="#000080">[</font>j<font color="#000080">] := </font>rcount<font color="#000080">; </font>inc<font color="#000080">(</font>rcount<font color="#000080">);
                </font><font color="#FF0000"><b>if </b></font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] &lt;&gt; </font><font color="#800000">$0C </font><font color="#FF0000"><b>then </b></font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] := </font>S3Mpan<font color="#000080">[</font>j<font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$20</font><font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>S3Mheader<font color="#000080">, </font>sizeof<font color="#000080">(</font>S3Mheader<font color="#000080">));
        </font>seek<font color="#000080">(</font>mtm<font color="#000080">, </font><font color="#800000">66 </font><font color="#000080">+ </font>NumSamples<font color="#000080">*</font><font color="#800000">37</font><font color="#000080">);
        </font>fillchar<font color="#000080">(</font>temp<font color="#000080">, </font><font color="#800000">256</font><font color="#000080">, </font><font color="#800000">$FF</font><font color="#000080">);
        </font>blockread<font color="#000080">(</font>mtm<font color="#000080">, </font>temp<font color="#000080">, </font>LastOrder<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, </font>OrdNum<font color="#000080">);
        </font>InsPtrPos <font color="#000080">:= </font>filepos<font color="#000080">(</font>s3m<font color="#000080">);
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, </font>InsNum<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">);
        </font>PatPtrPos <font color="#000080">:= </font>InsPtrPos <font color="#000080">+ </font>InsNum<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">;
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, </font>PatNum<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">);
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>S3Mpan<font color="#000080">, </font><font color="#800000">32</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 
</font><font color="#FF0000"><b>const
    </b></font>FineTuneTable<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word <font color="#000080">= (</font><font color="#800000">8363</font><font color="#000080">,</font><font color="#800000">8413</font><font color="#000080">,</font><font color="#800000">8463</font><font color="#000080">,</font><font color="#800000">8529</font><font color="#000080">,</font><font color="#800000">8581</font><font color="#000080">,
        </font><font color="#800000">8651</font><font color="#000080">,</font><font color="#800000">8723</font><font color="#000080">,</font><font color="#800000">8757</font><font color="#000080">,</font><font color="#800000">7895</font><font color="#000080">,</font><font color="#800000">7941</font><font color="#000080">,</font><font color="#800000">7985</font><font color="#000080">,</font><font color="#800000">8046</font><font color="#000080">,</font><font color="#800000">8107</font><font color="#000080">,</font><font color="#800000">8169</font><font color="#000080">,</font><font color="#800000">8232</font><font color="#000080">,</font><font color="#800000">8280</font><font color="#000080">);
 
</font><font color="#FF0000"><b>procedure </b></font>DoInstruments<font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>j<font color="#000080">: </font>integer<font color="#000080">;
    </font>savepos<font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
    </b></font>seek<font color="#000080">(</font>mtm<font color="#000080">, </font><font color="#800000">66</font><font color="#000080">);
    </font>blockread<font color="#000080">(</font>mtm<font color="#000080">, </font>MTMins<font color="#000080">, </font>MTMheader<font color="#000080">.</font>NumSamples<font color="#000080">*</font><font color="#800000">37</font><font color="#000080">);
    </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, (</font><font color="#800000">16</font><font color="#000080">-</font>filesize<font color="#000080">(</font>s3m<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">);
    </font>SamplePos <font color="#000080">:= </font>filesize<font color="#000080">(</font>s3m<font color="#000080">);
    </font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>MTMheader<font color="#000080">.</font>NumSamples<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do with </b></font>MTMins<font color="#000080">[</font>j<font color="#000080">],</font>S3Mins <font color="#FF0000"><b>do begin
        </b></font>tempw<font color="#000080">[</font>j<font color="#000080">] := </font>SamplePos <font color="#FF0000"><b>shr </b></font><font color="#800000">4 </font><font color="#000080">+</font>j<font color="#000080">*</font><font color="#800000">5</font><font color="#000080">;
        </font>fillchar<font color="#000080">(</font>S3Mins<font color="#000080">, </font>sizeof<font color="#000080">(</font>S3Mins<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>MLength <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Itype <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
        </font>Length <font color="#000080">:= </font>MLength<font color="#000080">;
        </font>LoopBeg <font color="#000080">:= </font>MLoopBeg<font color="#000080">;
        </font>LoopEnd <font color="#000080">:= </font>MLoopEnd<font color="#000080">;
        </font>Vol <font color="#000080">:= </font>Volume<font color="#000080">;
        </font>F <font color="#000080">:= </font>byte<font color="#000080">(</font>MLoopBeg<font color="#000080">&lt;&gt;</font>MLoopEnd<font color="#000080">);
        </font>C2spd <font color="#000080">:= </font>FineTuneTable<font color="#000080">[</font>FineTune<font color="#000080">];
        </font>move<font color="#000080">(</font>Mname<font color="#000080">, </font>SampleName<font color="#000080">, </font><font color="#800000">22</font><font color="#000080">);
        </font>SCRS <font color="#000080">:= </font><font color="#800000">'SCRS'</font><font color="#000080">;
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>S3Mins<font color="#000080">, </font>sizeof<font color="#000080">(</font>S3Mins<font color="#000080">));
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>SavePos <font color="#000080">:= </font>filepos<font color="#000080">(</font>s3m<font color="#000080">);
    </font>seek<font color="#000080">(</font>s3m<font color="#000080">, </font>InsPtrPos<font color="#000080">);
    </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, </font>MTMheader<font color="#000080">.</font>NumSamples<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">);
    </font>seek<font color="#000080">(</font>s3m<font color="#000080">, </font>SavePos<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 
</font><font color="#FF0000"><b>const
    </b></font>EffectTable<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte <font color="#000080">= (
        </font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">5</font><font color="#000080">,</font><font color="#800000">7</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">12</font><font color="#000080">,</font><font color="#800000">11</font><font color="#000080">,</font><font color="#800000">18</font><font color="#000080">,</font><font color="#800000">24</font><font color="#000080">,</font><font color="#800000">15</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">19</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>NeedsFixing<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte <font color="#000080">= (
          </font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
 
</font><font color="#FF0000"><b>procedure </b></font>DoPatterns<font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>j<font color="#000080">, </font>k<font color="#000080">, </font>l<font color="#000080">: </font>integer<font color="#000080">;
    </font>order<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
    </font>SavePos<font color="#000080">, </font>pos<font color="#000080">, </font>mpos<font color="#000080">: </font>word<font color="#000080">;
    </font>mask<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
    with </b></font>MTMheader <font color="#FF0000"><b>do
    for </b></font>j <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>LastPattern <font color="#FF0000"><b>do begin
        </b></font>seek<font color="#000080">(</font>mtm<font color="#000080">, </font><font color="#800000">194</font><font color="#000080">+</font>NumSamples<font color="#000080">*</font><font color="#800000">37</font><font color="#000080">+</font>NumTracks<font color="#000080">*</font><font color="#800000">192</font><font color="#000080">+</font>j<font color="#000080">*</font><font color="#800000">64</font><font color="#000080">);
        </font>blockread<font color="#000080">(</font>mtm<font color="#000080">, </font>order<font color="#000080">, </font>sizeof<font color="#000080">(</font>order<font color="#000080">));
        </font>fillchar<font color="#000080">(</font>pattern<font color="#000080">, </font>sizeof<font color="#000080">(</font>pattern<font color="#000080">), </font><font color="#800000">$FF</font><font color="#000080">);
</font><font color="#008000"><i>{ Convert MTM tracks to ST3-like pattern }
        </i></font><font color="#FF0000"><b>for </b></font>k <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumChannels<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do if </b></font>order<font color="#000080">[</font>k<font color="#000080">] &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
            </b></font>seek<font color="#000080">(</font>mtm<font color="#000080">, </font><font color="#800000">194</font><font color="#000080">+</font>NumSamples<font color="#000080">*</font><font color="#800000">37</font><font color="#000080">+</font>order<font color="#000080">[</font>k<font color="#000080">]*</font><font color="#800000">192</font><font color="#000080">-</font><font color="#800000">192</font><font color="#000080">);
            </font>blockread<font color="#000080">(</font>mtm<font color="#000080">, </font>MTMtrack<font color="#000080">, </font><font color="#800000">192</font><font color="#000080">);
            </font><font color="#FF0000"><b>for </b></font>l <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">63 </font><font color="#FF0000"><b>do with </b></font>pattern<font color="#000080">[</font>l<font color="#000080">,</font>k<font color="#000080">] </font><font color="#FF0000"><b>do begin
                </b></font>n <font color="#000080">:= </font>MTMtrack<font color="#000080">[</font>l<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">] </font><font color="#FF0000"><b>shr </b></font><font color="#800000">2</font><font color="#000080">;
                </font>i <font color="#000080">:= (</font>MTMtrack<font color="#000080">[</font>l<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4 </font><font color="#000080">+ (</font>MTMtrack<font color="#000080">[</font>l<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">);
                </font>e <font color="#000080">:= </font>EffectTable<font color="#000080">[</font>MTMtrack<font color="#000080">[</font>l<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">];
                </font>a <font color="#000080">:= </font>MTMtrack<font color="#000080">[</font>l<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">];
                </font><font color="#FF0000"><b>if </b></font>boolean<font color="#000080">(</font>NeedsFixing<font color="#000080">[</font>MTMtrack<font color="#000080">[</font>l<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">]) </font><font color="#FF0000"><b>then
                    case </b></font>MTMtrack<font color="#000080">[</font>l<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">15 </font><font color="#FF0000"><b>of
                        </b></font><font color="#800000">0</font><font color="#000080">: </font><font color="#FF0000"><b>if </b></font>a <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>e <font color="#000080">:= </font><font color="#800000">10</font><font color="#000080">;
                        </font><font color="#800000">1</font><font color="#000080">: </font><font color="#FF0000"><b>if </b></font>a <font color="#000080">&gt; </font><font color="#800000">$DF </font><font color="#FF0000"><b>then </b></font>a <font color="#000080">:= </font><font color="#800000">$DF</font><font color="#000080">;
                        </font><font color="#800000">2</font><font color="#000080">: </font><font color="#FF0000"><b>if </b></font>a <font color="#000080">&gt; </font><font color="#800000">$DF </font><font color="#FF0000"><b>then </b></font>a <font color="#000080">:= </font><font color="#800000">$DF</font><font color="#000080">;
                       </font><font color="#800000">10</font><font color="#000080">: </font><font color="#FF0000"><b>if </b></font>a<font color="#000080">&gt;</font><font color="#800000">$0F </font><font color="#FF0000"><b>then </b></font>a <font color="#000080">:= </font>a <font color="#FF0000"><b>and </b></font><font color="#800000">$F0</font><font color="#000080">;
                       </font><font color="#800000">12</font><font color="#000080">: </font>v <font color="#000080">:= </font>a<font color="#000080">;
                       </font><font color="#800000">14</font><font color="#000080">: </font><font color="#FF0000"><b>case </b></font>a <font color="#FF0000"><b>shr </b></font><font color="#800000">4 </font><font color="#FF0000"><b>of
                            </b></font><font color="#800000">1</font><font color="#000080">: </font><font color="#FF0000"><b>begin </b></font>e <font color="#000080">:= </font><font color="#800000">6</font><font color="#000080">; </font>a <font color="#000080">:= </font><font color="#800000">$F0 </font><font color="#000080">+ </font>a <font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                            </font><font color="#800000">2</font><font color="#000080">: </font><font color="#FF0000"><b>begin </b></font>e <font color="#000080">:= </font><font color="#800000">5</font><font color="#000080">; </font>a <font color="#000080">:= </font><font color="#800000">$F0 </font><font color="#000080">+ </font>a <font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                            </font><font color="#800000">5</font><font color="#000080">: </font>a <font color="#000080">:= </font><font color="#800000">$20 </font><font color="#000080">+ </font>a <font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">;
                            </font><font color="#800000">9</font><font color="#000080">: </font><font color="#FF0000"><b>begin </b></font>e <font color="#000080">:= </font><font color="#800000">17</font><font color="#000080">; </font>a <font color="#000080">:= </font>a <font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                           </font><font color="#800000">10</font><font color="#000080">: </font><font color="#FF0000"><b>begin </b></font>e <font color="#000080">:= </font><font color="#800000">4</font><font color="#000080">; </font>a <font color="#000080">:= </font><font color="#800000">$0F </font><font color="#000080">+ </font>a <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                           </font><font color="#800000">11</font><font color="#000080">: </font><font color="#FF0000"><b>begin </b></font>e <font color="#000080">:= </font><font color="#800000">4</font><font color="#000080">; </font>a <font color="#000080">:= </font><font color="#800000">$F0 </font><font color="#000080">+ </font>a <font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                       </font><font color="#800000">15</font><font color="#000080">: </font><font color="#FF0000"><b>if </b></font>a<font color="#000080">&gt;=</font><font color="#800000">$20 </font><font color="#FF0000"><b>then </b></font>e <font color="#000080">:= </font><font color="#800000">20</font><font color="#000080">;
                    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>savepos <font color="#000080">:= </font>filepos<font color="#000080">(</font>s3m<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;
        </font>seek<font color="#000080">(</font>s3m<font color="#000080">, </font>PatPtrPos<font color="#000080">+</font>j<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">);
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>savepos<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
        </font>seek<font color="#000080">(</font>s3m<font color="#000080">, </font>savepos<font color="#000080">*</font>longint<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">));
</font><font color="#008000"><i>{ Now compress pattern }
        </i></font>pos <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
        </font><font color="#FF0000"><b>for </b></font>k <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">63 </font><font color="#FF0000"><b>do begin
            for </b></font>l <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumChannels<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do with </b></font>pattern<font color="#000080">[</font>k<font color="#000080">,</font>l<font color="#000080">] </font><font color="#FF0000"><b>do begin
                </b></font>mpos <font color="#000080">:= </font>pos<font color="#000080">;
                </font>mask <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                </font>inc<font color="#000080">(</font>pos<font color="#000080">);
                </font><font color="#FF0000"><b>if not </b></font><font color="#000080">(((</font>n <font color="#FF0000"><b>or </b></font>i<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">((</font>n <font color="#FF0000"><b>and </b></font>i<font color="#000080">)=</font><font color="#800000">$FF</font><font color="#000080">)) </font><font color="#FF0000"><b>then begin
                    </b></font>mask <font color="#000080">:= </font>mask <font color="#FF0000"><b>or </b></font><font color="#800000">32</font><font color="#000080">;
                    </font><font color="#FF0000"><b>if </b></font>n<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>temp<font color="#000080">[</font>pos<font color="#000080">] := </font><font color="#800000">$FF
                    </font><font color="#FF0000"><b>else
                        </b></font>temp<font color="#000080">[</font>pos<font color="#000080">] := (</font>n<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">12</font><font color="#000080">*</font><font color="#800000">16 </font><font color="#000080">+ (</font>n<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>mod </b></font><font color="#800000">12 </font><font color="#000080">+ </font><font color="#800000">32</font><font color="#000080">;
                    </font>temp<font color="#000080">[</font>pos<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">] := </font>i<font color="#000080">;
                    </font>inc<font color="#000080">(</font>pos<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                </font><font color="#FF0000"><b>if </b></font>v <font color="#000080">&lt;&gt; </font><font color="#800000">$FF </font><font color="#FF0000"><b>then begin
                    </b></font>mask <font color="#000080">:= </font>mask <font color="#FF0000"><b>or </b></font><font color="#800000">64</font><font color="#000080">;
                    </font>temp<font color="#000080">[</font>pos<font color="#000080">] := </font>v<font color="#000080">;
                    </font>inc<font color="#000080">(</font>pos<font color="#000080">);
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                </font><font color="#FF0000"><b>if </b></font>e<font color="#000080">&lt;&gt;</font><font color="#800000">$FF </font><font color="#FF0000"><b>then begin
                    </b></font>mask <font color="#000080">:= </font>mask <font color="#FF0000"><b>or </b></font><font color="#800000">128</font><font color="#000080">;
                    </font>temp<font color="#000080">[</font>pos<font color="#000080">] := </font>e<font color="#000080">;
                    </font>temp<font color="#000080">[</font>pos<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">] := </font>a<font color="#000080">;
                    </font>inc<font color="#000080">(</font>pos<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                </font><font color="#FF0000"><b>if </b></font>mask <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
                    </b></font>temp<font color="#000080">[</font>mpos<font color="#000080">] := </font>mask <font color="#FF0000"><b>or </b></font>l
                <font color="#FF0000"><b>else </b></font>dec<font color="#000080">(</font>pos<font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font>temp<font color="#000080">[</font>pos<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
            </font>inc<font color="#000080">(</font>pos<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>tempw<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>pos<font color="#000080">;
        </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, (</font>pos<font color="#000080">+</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>and not </b></font><font color="#800000">15</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 
</font><font color="#FF0000"><b>procedure </b></font>DoSamples<font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>j<font color="#000080">: </font>integer<font color="#000080">;
    </font>savepos<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
    with </b></font>MTMheader <font color="#FF0000"><b>do begin
        </b></font>seek<font color="#000080">(</font>mtm<font color="#000080">,</font><font color="#800000">194</font><font color="#000080">+</font>NumSamples<font color="#000080">*</font><font color="#800000">37</font><font color="#000080">+</font>NumTracks<font color="#000080">*</font><font color="#800000">192</font><font color="#000080">+(</font>LastPattern<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">64</font><font color="#000080">+</font>Comment<font color="#000080">);
        </font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumSamples<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do with </b></font>MTMins<font color="#000080">[</font>j<font color="#000080">] </font><font color="#FF0000"><b>do begin
            </b></font>savepos <font color="#000080">:= </font>filepos<font color="#000080">(</font>s3m<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;
            </font>seek<font color="#000080">(</font>s3m<font color="#000080">, </font>SamplePos<font color="#000080">+</font>j<font color="#000080">*</font><font color="#800000">80</font><font color="#000080">+</font><font color="#800000">14</font><font color="#000080">);
            </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>savepos<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
            </font>seek<font color="#000080">(</font>s3m<font color="#000080">, </font>savepos<font color="#000080">*</font>longint<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">));
            </font><font color="#FF0000"><b>while </b></font>Mlength <font color="#000080">&gt; </font><font color="#800000">8192 </font><font color="#FF0000"><b>do begin
                </b></font>blockread<font color="#000080">(</font>mtm<font color="#000080">, </font>temp<font color="#000080">, </font><font color="#800000">8192</font><font color="#000080">);
                </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, </font><font color="#800000">8192</font><font color="#000080">);
                </font>dec<font color="#000080">(</font>Mlength<font color="#000080">, </font><font color="#800000">8192</font><font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font>blockread<font color="#000080">(</font>mtm<font color="#000080">, </font>temp<font color="#000080">, </font>Mlength<font color="#000080">);
            </font>blockwrite<font color="#000080">(</font>s3m<font color="#000080">, </font>temp<font color="#000080">, (</font>Mlength<font color="#000080">+</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>and not </b></font><font color="#800000">15</font><font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 
</font><font color="#FF0000"><b>var
    </b></font>s<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
    </b></font>write<font color="#000080">(</font><font color="#800000">'Filename: '</font><font color="#000080">);
    </font>readln<font color="#000080">(</font>s<font color="#000080">);
    </font><font color="#FF0000"><b>if not </b></font>Init<font color="#000080">(</font>s<font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font>writeln<font color="#000080">(</font><font color="#800000">'Error loading '</font><font color="#000080">, </font>s<font color="#000080">+</font><font color="#800000">'.MTM'</font><font color="#000080">);
        </font>halt<font color="#000080">(</font><font color="#800000">$FF</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>DoHeader<font color="#000080">;
    </font>DoInstruments<font color="#000080">;
    </font>DoPatterns<font color="#000080">;
    </font>DoSamples<font color="#000080">;
    </font>close<font color="#000080">(</font>s3m<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0092.PAS">Original</a><b>]</b></p></body>
</html>
