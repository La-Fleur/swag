<html>
<head><title> "Playing MOD Files" by MARCIN BORKOWSKI</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0084.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Small Eastern gift, divided into several messages. Whole source can be freqed
from my system under magic 'MODPLAY' (or will be in next few minutes, if I'll
not forget :).
                                                Borek

---------
}
{$A+,B-,D+,E+,F-,G+,I-,L+,N-,O-,P-,Q-,R-,S-,T-,V+,X+,Y+}
{$M 16384,0,655360}

</i></font><font color="#FF0000"><b>program </b></font>modplay<font color="#000080">;

</font><font color="#FF0000"><b>uses </b></font>mixer<font color="#000080">,</font>dos<font color="#000080">,</font>crt<font color="#000080">;

</font><font color="#008000"><i>{ Program by Borek (Marcin Borkowski), Warsaw, Poland.
  You can find me in a Top Secret BBS, +48 2 6788783
  Fido 2:480/25, Pascal Net 115:4804/104

  This program needs fast machine, as it is written in
  plain vanilla Pascal. If you are looking for proffesional
  quality implementation of MOD player, keep trying
  (I'm sure you'll have to paid for that). If you are looking
  for a source to understand and start work by yourself -
  you've got what you are looking for! You may freely copy
  and use this source, as long as it is unchanged and states my
  name in the begining. If you find more profitable use of this
  code, feel free to share your profits with me! At least - let
  me know you were able to use it for your own purposes.

  This program should be accompanied by the MIXER unit source.

  Attention - this implementation of playing MOD's is BAD
  and will probably not work on some MOD's with changed
  order of playing patterns, also MOD's based on effects
  will not be played properly. Effects (and many other things -
  as sample volumes, finetuning) aren't implemented, and in
  fact that's only a sketch. Program is probably bugged, but
  for sure it plays 40% MOD's from my BBS in an acceptable way.

  Parts of code ripped from PCPGE, various sources from
  Ethan Brodsky and probably from SWAG. I can't remember
  source of every byte, but for sure 95% of code is mine. }

</i></font><font color="#FF0000"><b>const
  </b></font>TIMERINTR <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;
  </font>PIT_FREQ  <font color="#000080">= </font><font color="#800000">$1234DD</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>sampledata <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">65533</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>pattern    <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">63</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>patptr     <font color="#000080">= ^</font>pattern<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>BIOSTimerHandler    <font color="#000080">: </font><font color="#FF0000"><b>procedure</b></font><font color="#000080">;
  </font>clock_ticks<font color="#000080">,</font>counter <font color="#000080">: </font>longint<font color="#000080">;

  </font>playend <font color="#000080">: </font>boolean<font color="#000080">;
  </font>ticks<font color="#000080">,</font>speed <font color="#000080">: </font>word<font color="#000080">;
  </font>divplayed <font color="#000080">: </font>word<font color="#000080">;
  </font>patplayed <font color="#000080">: </font>word<font color="#000080">;
  </font>patterns <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>patptr<font color="#000080">;
  </font>patternorder <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">127</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>fmod    <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>hdr     <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">1084</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>nofsamples <font color="#000080">: </font>word<font color="#000080">;
  </font>nofpatterns <font color="#000080">: </font>word<font color="#000080">;
  </font>OldExit <font color="#000080">: </font>pointer<font color="#000080">;
  </font>samples <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">]</font><font color="#FF0000"><b>of record
                             </b></font>sname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">22</font><font color="#000080">];
                             </font>length <font color="#000080">: </font>word<font color="#000080">;
                             </font>finet  <font color="#000080">: </font>byte<font color="#000080">;
                             </font>volume <font color="#000080">: </font>byte<font color="#000080">;
                             </font>repst<font color="#000080">,</font>repend <font color="#000080">: </font>word<font color="#000080">;
                           </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>amiword<font color="#000080">(</font>w <font color="#000080">: </font>word<font color="#000080">): </font>word<font color="#000080">;
</font><font color="#008000"><i>{ Data in MOD files are usually in 68000 format. }
</i></font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,w
  xchg ah,al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>nextdivision<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font><font color="#008000"><i>{ Sometimes data have to be treated as bytes,
  sometimes as words. Let's use some tricks! }
  </i></font>divis <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>diwis <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word <font color="#FF0000"><b>absolute </b></font>divis<font color="#000080">;
  </font>smp<font color="#000080">,</font>tmp<font color="#000080">,</font>freq <font color="#000080">: </font>word<font color="#000080">;
  </font>eff<font color="#000080">,</font>arg <font color="#000080">: </font>byte<font color="#000080">;
  </font>i       <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>divplayed<font color="#000080">=</font><font color="#800000">64 </font><font color="#FF0000"><b>then
  begin
    </b></font>divplayed<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>inc<font color="#000080">(</font>patplayed<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>patplayed<font color="#000080">&gt;=</font>hdr<font color="#000080">[</font><font color="#800000">951</font><font color="#000080">] </font><font color="#FF0000"><b>then
  begin
    </b></font>playend<font color="#000080">:=</font>true<font color="#000080">;
    </font>EXIT
  <font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>gotoxy<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">21</font><font color="#000080">);
  </font>write<font color="#000080">(</font><font color="#800000">'Pattern: '</font><font color="#000080">,</font>patplayed<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">:</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">'/'</font><font color="#000080">,</font>hdr<font color="#000080">[</font><font color="#800000">951</font><font color="#000080">],
        </font><font color="#800000">'    division: '</font><font color="#000080">,</font>divplayed<font color="#000080">:</font><font color="#800000">2</font><font color="#000080">);
  </font>move<font color="#000080">(</font>patterns<font color="#000080">[</font>patternorder<font color="#000080">[</font>patplayed<font color="#000080">]]^[</font>divplayed<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">],</font>divis<font color="#000080">,</font><font color="#800000">16</font><font color="#000080">);

  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">3 </font><font color="#FF0000"><b>do
  begin
    </b></font>smp<font color="#000080">:=(</font>divis<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">*</font>i<font color="#000080">+</font><font color="#800000">0</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$F0</font><font color="#000080">)+</font>divis<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">*</font>i<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;  </font><font color="#008000"><i>{sample number}
    </i></font>tmp<font color="#000080">:=(</font>amiword<font color="#000080">(</font>diwis<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">*</font>i<font color="#000080">]) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0FFF</font><font color="#000080">);      </font><font color="#008000"><i>{sample period}
    </i></font><font color="#FF0000"><b>if </b></font>tmp<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>freq<font color="#000080">:=</font><font color="#800000">3546895 </font><font color="#FF0000"><b>div </b></font>tmp<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>smp<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>startchannel<font color="#000080">(</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">,</font>smp<font color="#000080">,</font><font color="#800000">64</font><font color="#000080">,</font>freq<font color="#000080">)
              </font><font color="#FF0000"><b>else if </b></font>tmp<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>setchannelfrequency<font color="#000080">(</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">,</font>freq<font color="#000080">);

    </font>gotoxy<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">22</font><font color="#000080">+</font>i<font color="#000080">);
    </font>write<font color="#000080">(</font><font color="#800000">' channel '</font><font color="#000080">,</font>i<font color="#000080">,</font><font color="#800000">': '</font><font color="#000080">,</font>samples<font color="#000080">[</font>smp<font color="#000080">].</font>sname<font color="#000080">:</font><font color="#800000">22</font><font color="#000080">,</font><font color="#800000">' freq: '</font><font color="#000080">,</font>freq<font color="#000080">:</font><font color="#800000">5</font><font color="#000080">,</font><font color="#800000">' '</font><font color="#000080">:</font><font color="#800000">20</font><font color="#000080">);
    </font>gotoxy<font color="#000080">(</font><font color="#800000">50</font><font color="#000080">,</font><font color="#800000">22</font><font color="#000080">+</font>i<font color="#000080">);

    </font>eff<font color="#000080">:=</font>divis<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">*</font>i<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">;                 </font><font color="#008000"><i>{effect number}
    </i></font>arg<font color="#000080">:=</font>divis<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">*</font>i<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">];                           </font><font color="#008000"><i>{effect argument}
    </i></font><font color="#FF0000"><b>case </b></font>eff <font color="#FF0000"><b>of
      </b></font><font color="#800000">$0C </font><font color="#000080">: </font><font color="#FF0000"><b>begin
              </b></font>setchannelvolume<font color="#000080">(</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">,</font>arg<font color="#000080">);
              </font>write<font color="#000080">(</font><font color="#800000">'  volume change'</font><font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#800000">$0F </font><font color="#000080">: </font><font color="#FF0000"><b>if </b></font>arg<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
            begin
              </b></font>speed<font color="#000080">:=</font>arg<font color="#000080">;
              </font>write<font color="#000080">(</font><font color="#800000">'  speed change'</font><font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#800000">$0B </font><font color="#000080">: </font><font color="#FF0000"><b>begin
              </b></font>divplayed<font color="#000080">:=</font><font color="#800000">63</font><font color="#000080">;
              </font>patplayed<font color="#000080">:=</font>arg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
              </font>write<font color="#000080">(</font><font color="#800000">'  pattern break'</font><font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#800000">$0D </font><font color="#000080">: </font><font color="#FF0000"><b>begin
              </b></font>inc<font color="#000080">(</font>patplayed<font color="#000080">);
              </font>divplayed<font color="#000080">:=</font><font color="#800000">10</font><font color="#000080">*(</font>arg <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">)+</font>arg <font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
              </font>write<font color="#000080">(</font><font color="#800000">'  pattern jump'</font><font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>inc<font color="#000080">(</font>divplayed<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>play<font color="#000080">;
</font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>inc<font color="#000080">(</font>ticks<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ticks<font color="#000080">=</font>speed <font color="#FF0000"><b>then
  begin
    </b></font>ticks<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>nextdivision<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>clock_ticks <font color="#000080">:= </font>clock_ticks <font color="#000080">+ </font>counter<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>clock_ticks <font color="#000080">&gt;= </font><font color="#800000">$10000 </font><font color="#FF0000"><b>then
    begin
      </b></font>clock_ticks <font color="#000080">:= </font>clock_ticks <font color="#000080">- </font><font color="#800000">$10000</font><font color="#000080">;
      </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">pushf </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>BIOSTimerHandler<font color="#000080">;
    </font><font color="#FF0000"><b>end
  else </b></font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>CleanUpTimer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$34</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>SetIntVec<font color="#000080">(</font>TIMERINTR<font color="#000080">, @</font>BIOSTimerHandler<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetTimer<font color="#000080">(</font>TimerHandler <font color="#000080">: </font>pointer<font color="#000080">; </font>frequency <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>clock_ticks <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>counter <font color="#000080">:= </font><font color="#800000">$1234DD </font><font color="#FF0000"><b>div </b></font>frequency<font color="#000080">;
  </font>GetIntVec<font color="#000080">(</font>TIMERINTR<font color="#000080">, @</font>BIOSTimerHandler<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font>TIMERINTR<font color="#000080">, </font>TimerHandler<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$34</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>counter <font color="#FF0000"><b>mod </b></font><font color="#800000">256</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>counter <font color="#FF0000"><b>div </b></font><font color="#800000">256</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$F+}
</i></font><font color="#FF0000"><b>procedure </b></font>shutdown<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CleanUpTimer<font color="#000080">;
  </font>exitproc<font color="#000080">:=</font>oldexit
<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}

</i></font><font color="#FF0000"><b>procedure </b></font>error<font color="#000080">(</font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>writeln<font color="#000080">(</font>s<font color="#000080">);
  </font>close<font color="#000080">(</font>fmod<font color="#000080">);
  </font>HALT
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>openmod<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>paramcount<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>error<font color="#000080">(</font><font color="#800000">'Needs filename (*.mod) as parameter'</font><font color="#000080">);
  </font>assign<font color="#000080">(</font>fmod<font color="#000080">,</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
  </font>reset<font color="#000080">(</font>fmod<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>error<font color="#000080">(</font><font color="#800000">'Can''t open file: '</font><font color="#000080">+</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
  </font>blockread<font color="#000080">(</font>fmod<font color="#000080">,</font>hdr<font color="#000080">,</font><font color="#800000">1084</font><font color="#000080">);
  </font>move<font color="#000080">(</font>hdr<font color="#000080">[</font><font color="#800000">1081</font><font color="#000080">],</font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font><font color="#800000">4</font><font color="#000080">);
  </font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#4</font><font color="#000080">;
  </font><font color="#FF0000"><b>if not</b></font><font color="#000080">((</font>s<font color="#000080">=</font><font color="#800000">'M.K.'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>s<font color="#000080">=</font><font color="#800000">'M!K!'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>s<font color="#000080">=</font><font color="#800000">'FLT4'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>s<font color="#000080">=</font><font color="#800000">'4CHN'</font><font color="#000080">)) </font><font color="#FF0000"><b>then
    </b></font>error<font color="#000080">(</font><font color="#800000">'Invalid mod file format tag: '</font><font color="#000080">+</font>s<font color="#000080">);
  </font>nofsamples<font color="#000080">:=</font><font color="#800000">31</font><font color="#000080">;
  </font>move<font color="#000080">(</font>hdr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font><font color="#800000">20</font><font color="#000080">);
  </font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#1</font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>s<font color="#000080">[</font>ord<font color="#000080">(</font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])]&lt;&gt;</font><font color="#800000">#0 </font><font color="#FF0000"><b>do </b></font>inc<font color="#000080">(</font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
  </font>writeln<font color="#000080">(</font><font color="#800000">'Song name: '</font><font color="#000080">,</font>s<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>getsamples<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>integer<font color="#000080">;
  </font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>w <font color="#000080">: </font>word<font color="#000080">;
  </font>totalsamplength <font color="#000080">: </font>longint<font color="#000080">;
  </font>p <font color="#000080">: </font>pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>totalsamplength<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>nofsamples <font color="#FF0000"><b>do with </b></font>samples<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>do
  begin
    </b></font>move<font color="#000080">(</font>hdr<font color="#000080">[</font><font color="#800000">21</font><font color="#000080">+(</font>i<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">30</font><font color="#000080">],</font>sname<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font><font color="#800000">21</font><font color="#000080">);
    </font>sname<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#1</font><font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font>sname<font color="#000080">[</font>ord<font color="#000080">(</font>sname<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])]&lt;&gt;</font><font color="#800000">#0 </font><font color="#FF0000"><b>do </b></font>inc<font color="#000080">(</font>sname<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
    </font>move<font color="#000080">(</font>hdr<font color="#000080">[</font><font color="#800000">43</font><font color="#000080">+</font><font color="#800000">30</font><font color="#000080">*(</font>i<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)],</font>w<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);    </font>length<font color="#000080">:=</font>amiword<font color="#000080">(</font>w<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
    </font>inc<font color="#000080">(</font>totalsamplength<font color="#000080">,</font>length<font color="#000080">);
    </font>volume<font color="#000080">:=</font>hdr<font color="#000080">[</font><font color="#800000">46</font><font color="#000080">+</font><font color="#800000">30</font><font color="#000080">*(</font>i<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)];
    </font>move<font color="#000080">(</font>hdr<font color="#000080">[</font><font color="#800000">47</font><font color="#000080">+</font><font color="#800000">30</font><font color="#000080">*(</font>i<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)],</font>w<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);    </font>repst<font color="#000080">:=</font>amiword<font color="#000080">(</font>w<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
    </font>move<font color="#000080">(</font>hdr<font color="#000080">[</font><font color="#800000">49</font><font color="#000080">+</font><font color="#800000">30</font><font color="#000080">*(</font>i<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)],</font>w<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);    </font>repend<font color="#000080">:=</font>repst<font color="#000080">+</font>amiword<font color="#000080">(</font>w<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>length<font color="#000080">&gt;</font><font color="#800000">2 </font><font color="#FF0000"><b>then
      </b></font>writeln<font color="#000080">(</font><font color="#800000">' sample '</font><font color="#000080">,</font>i<font color="#000080">:</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">': '</font><font color="#000080">,</font>sname<font color="#000080">:</font><font color="#800000">22</font><font color="#000080">,</font>length<font color="#000080">:</font><font color="#800000">6</font><font color="#000080">,
              </font>volume<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">,</font>repst<font color="#000080">:</font><font color="#800000">6</font><font color="#000080">,</font>repend<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">:</font><font color="#800000">6</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>nofpatterns<font color="#000080">:=(</font>filesize<font color="#000080">(</font>fmod<font color="#000080">)-</font><font color="#800000">1084</font><font color="#000080">-</font>totalsamplength<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">1024</font><font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'Number of different patterns in song: '</font><font color="#000080">,</font>nofpatterns<font color="#000080">);
  </font>seek<font color="#000080">(</font>fmod<font color="#000080">,</font>filesize<font color="#000080">(</font>fmod<font color="#000080">)-</font>totalsamplength<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>nofsamples <font color="#FF0000"><b>do
    with </b></font>samples<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>do
      if </b></font>length<font color="#000080">&gt;</font><font color="#800000">2 </font><font color="#FF0000"><b>then
      begin
        </b></font>getmem<font color="#000080">(</font>p<font color="#000080">,</font>length<font color="#000080">);
        </font>blockread<font color="#000080">(</font>fmod<font color="#000080">,</font>w<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
        </font>blockread<font color="#000080">(</font>fmod<font color="#000080">,</font>p<font color="#000080">^,</font>length<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">,</font>w<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>error<font color="#000080">(</font><font color="#800000">'Can''t read samples, file is to short!'</font><font color="#000080">);
      </font><font color="#008000"><i>{ Convert sample to appropriate format. }
        </i></font><font color="#FF0000"><b>for </b></font>w<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">-</font><font color="#800000">3 </font><font color="#FF0000"><b>do </b></font>inc<font color="#000080">(</font>sampledata<font color="#000080">(</font>p<font color="#000080">^)[</font>w<font color="#000080">],</font><font color="#800000">128</font><font color="#000080">);
        </font>addvoice<font color="#000080">(</font>i<font color="#000080">,</font>length<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">,</font>repst<font color="#000080">,</font>repend<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">,</font>p<font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>getpatterns<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>seek<font color="#000080">(</font>fmod<font color="#000080">,</font><font color="#800000">1084</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>nofpatterns<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
  begin
    </b></font>new<font color="#000080">(</font>patterns<font color="#000080">[</font>i<font color="#000080">]);
    </font>blockread<font color="#000080">(</font>fmod<font color="#000080">,</font>patterns<font color="#000080">[</font>i<font color="#000080">]^,</font><font color="#800000">1024</font><font color="#000080">)
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>seek<font color="#000080">(</font>fmod<font color="#000080">,</font><font color="#800000">952</font><font color="#000080">);
  </font>blockread<font color="#000080">(</font>fmod<font color="#000080">,</font>patternorder<font color="#000080">,</font><font color="#800000">128</font><font color="#000080">);
  </font>close<font color="#000080">(</font>fmod<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>startplay<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>speed<font color="#000080">:=</font><font color="#800000">6</font><font color="#000080">;
  </font>divplayed<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>patplayed<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>SetTimer<font color="#000080">(@</font>play<font color="#000080">,</font><font color="#800000">50</font><font color="#000080">);
  </font>playend<font color="#000080">:=</font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>clrscr<font color="#000080">;
  </font>OldExit<font color="#000080">:=</font>ExitProc<font color="#000080">;
  </font>ExitProc<font color="#000080">:=@</font>ShutDown<font color="#000080">;
  </font>openmod<font color="#000080">;
  </font>getsamples<font color="#000080">;
  </font>getpatterns<font color="#000080">;
  </font>startplay<font color="#000080">;
  </font><font color="#FF0000"><b>repeat until </b></font>keypressed <font color="#FF0000"><b>or </b></font>playend<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{  -----------------------  UNIT FILES ----------------------- }

{$A+,B-,D+,E-,F-,G+,I-,L+,N-,O-,P-,Q-,R-,S-,T-,V+,X+,Y+}
{$M 16384,0,655360}

</i></font><font color="#FF0000"><b>unit </b></font>mixer<font color="#000080">;

</font><font color="#008000"><i>{ Program by Borek (Marcin Borkowski), Warsaw, Poland.
  You can find me in a Top Secret BBS, +48 2 6788783
  Fido 2:480/25, Pascal Net 115:4804/104

  You may freely copy and use this source, as long it is
  unchanged and states my name in the begining. If you find
  more profitable use of this code, fell free to share your
  profits with me! At least - let me know you were able to
  use it for your own purposes.

  This unit should be accompanied by the MODPLAY source.

  This version of mixing (even at 44 kHz) works OK on my
  UMC 40 MHz machine (that's a little bit less than 486 50 MHz).
  If you want to make it work on 386DX 33MHz, you must 'unroll'
  the main loop and put used there data into 'hardcoded' variables.
  Such a version works on my old 386 and on several other
  computers of the same class, even with QEMM.

  If you stop this program by ctrl break, you may not be able to
  restart it without resetting your computer - and that's not the
  only one bug I know in the code.

  Parts of code ripped from PCPGE, various sources from
  Ethan Brodsky and probably from SWAG. I can't remember
  source of every byte, but for sure 95% of code is mine. }

</i></font><font color="#FF0000"><b>interface

procedure </b></font>addvoice<font color="#000080">(</font>voice<font color="#000080">,</font>_samplesize<font color="#000080">,</font>_loopstart<font color="#000080">,</font>_loopend <font color="#000080">: </font>word<font color="#000080">;
                   </font>sample <font color="#000080">: </font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>startchannel<font color="#000080">(</font>channel<font color="#000080">,</font>voice<font color="#000080">,</font>volume<font color="#000080">,</font>frequency <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>stopchannel<font color="#000080">(</font>channel <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>setchannelfrequency<font color="#000080">(</font>channel<font color="#000080">,</font>frequency <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>setchannelvolume<font color="#000080">(</font>channel<font color="#000080">,</font>volume <font color="#000080">: </font>word<font color="#000080">);

</font><font color="#FF0000"><b>implementation

uses </b></font>crt<font color="#000080">,</font>dos<font color="#000080">;

</font><font color="#FF0000"><b>const
</b></font><font color="#008000"><i>{ Mixer data }
  </i></font>max_num_voices <font color="#000080">= </font><font color="#800000">32</font><font color="#000080">; </font><font color="#008000"><i>{ number of voices }
  </i></font>max_num_channels <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">; </font><font color="#008000"><i>{ number of channels }
  </i></font>PlayFreq <font color="#000080">= </font><font color="#800000">22222</font><font color="#000080">; </font><font color="#008000"><i>{ samples played at, at 11111 sound is very bad. }
  </i></font>playbufsize <font color="#000080">= </font><font color="#800000">512</font><font color="#000080">; </font><font color="#008000"><i>{ Size of play buffer}
{ SB data - change it for your card settings. }
  </i></font>SBIO    <font color="#000080">: </font>word <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;  </font><font color="#008000"><i>{ 2x0 }
  </i></font>SBIRQ   <font color="#000080">: </font>word <font color="#000080">= </font><font color="#800000">7</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>sampledata <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">65533</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>_channel   <font color="#000080">= </font><font color="#FF0000"><b>record
                 </b></font>nvoice<font color="#000080">,</font>position<font color="#000080">,</font>increment<font color="#000080">,</font>subposition<font color="#000080">,</font>vol <font color="#000080">: </font>word<font color="#000080">;
                 </font>inloop<font color="#000080">,</font>active <font color="#000080">: </font>boolean
               <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
</b></font><font color="#008000"><i>{ Pointers to samples. }
  </i></font>voicesdata <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_voices<font color="#000080">]</font><font color="#FF0000"><b>of </b></font><font color="#000080">^</font>sampledata<font color="#000080">;
</font><font color="#008000"><i>{ Sizes of voices }
  </i></font>voicessize <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_voices<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#008000"><i>{ Those two defines begining and end of loop in sample }
  </i></font>voicesloopstart <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_voices<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
  </font>voicesloopend <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_voices<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#008000"><i>{ Voice ready to use? }
  </i></font>voicesdefined <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_voices<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ Which voice played in this channel? }
  </i></font>channelsnvoice <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_channels<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#008000"><i>{ Which position in sample? }
  </i></font>channelsposition <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_channels<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#008000"><i>{ How to increment subposition? }
  </i></font>channelsincrement <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_channels<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#008000"><i>{ Which subposistion in position - it allows to change frequencies,
  as one byte of sample can be played several times. It gives not a
  perfect sound, but it works. To improove sound quality, one should
  use interpolation (and assembler :-) }
  </i></font>channelssubposition <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_channels<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#008000"><i>{ Volume of channel }
  </i></font>channelsvol <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_channels<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#008000"><i>{ Is sample in this channel loop? }
  </i></font>channelsinloop <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_channels<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ Channel being played? }
  </i></font>channelsactive <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>max_num_channels<font color="#000080">]</font><font color="#FF0000"><b>of </b></font>boolean<font color="#000080">;

</font><font color="#008000"><i>{ SB addresses }
  </i></font>DSP_RESET        <font color="#000080">: </font>word<font color="#000080">;
  </font>DSP_READ_DATA    <font color="#000080">: </font>word<font color="#000080">;
  </font>DSP_WRITE_DATA   <font color="#000080">: </font>word<font color="#000080">;
  </font>DSP_WRITE_STATUS <font color="#000080">: </font>word<font color="#000080">;
  </font>DSP_DATA_AVAIL   <font color="#000080">: </font>word<font color="#000080">;

  </font>timeconst        <font color="#000080">: </font>byte<font color="#000080">;
  </font>playbuf          <font color="#000080">: </font>pointer<font color="#000080">;
  </font>oldint<font color="#000080">,</font>oldexit   <font color="#000080">: </font>pointer<font color="#000080">;
  </font>firstbuff        <font color="#000080">: </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>carry <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$B0</font><font color="#000080">/</font><font color="#800000">$01</font><font color="#000080">/     </font><font color="#008000"><i>{  mov al,01 }
       </i></font><font color="#800000">$72</font><font color="#000080">/</font><font color="#800000">$02</font><font color="#000080">/     </font><font color="#008000"><i>{  jc @carryset }
       </i></font><font color="#800000">$30</font><font color="#000080">/</font><font color="#800000">$C0</font><font color="#000080">);    </font><font color="#008000"><i>{  xor al,al }
                    { @carryset: }

</i></font><font color="#FF0000"><b>function </b></font>ResetDSP<font color="#000080">(</font>base <font color="#000080">: </font>word<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>base <font color="#000080">:= </font>base <font color="#000080">* </font><font color="#800000">$10</font><font color="#000080">;
  </font>DSP_RESET <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$206</font><font color="#000080">;
  </font>DSP_READ_DATA <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20A</font><font color="#000080">;
  </font>DSP_WRITE_DATA <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20C</font><font color="#000080">;
  </font>DSP_WRITE_STATUS <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20C</font><font color="#000080">;
  </font>DSP_DATA_AVAIL <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20E</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSP_RESET<font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>DSP_RESET<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSP_DATA_AVAIL<font color="#000080">] </font><font color="#FF0000"><b>And </b></font><font color="#800000">$80 </font><font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSP_READ_DATA<font color="#000080">] = </font><font color="#800000">$AA</font><font color="#000080">)
     </font><font color="#FF0000"><b>then </b></font>ResetDSP <font color="#000080">:= </font>true
     <font color="#FF0000"><b>else </b></font>ResetDSP <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>WriteDSP<font color="#000080">(</font>value <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
  while </b></font>Port<font color="#000080">[</font>DSP_WRITE_STATUS<font color="#000080">] </font><font color="#FF0000"><b>And </b></font><font color="#800000">$80 </font><font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSP_WRITE_DATA<font color="#000080">] := </font>value<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ReadDSP <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  while </b></font>Port<font color="#000080">[</font>DSP_DATA_AVAIL<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$80 </font><font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font>ReadDSP <font color="#000080">:= </font>Port<font color="#000080">[</font>DSP_READ_DATA<font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>SpeakerOn<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$D1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>SpeakerOff<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$D3</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Playback<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>page<font color="#000080">,</font>offset<font color="#000080">,</font>size   <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ SB and DMA are working in autoinit modes - but DMA buffer is
  twice as long as SB buffer. Each time SB buffer is finished an
  IRQ is generated - a signal that next part of samples should be
  mixed. Play buffer has two parts - when one is played, second
  is being filled. Simple, uh? This version of procedure was checked
  on AWE 32, on SB 16 and on several clones of SB, but for sure
  it'll not work on some cards - especially on older versions
  that are not supporting autoinit mode. }
  </i></font>firstbuff<font color="#000080">:=</font>true<font color="#000080">;
  </font>size <font color="#000080">:= </font>playbufsize<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
  </font>offset <font color="#000080">:= </font>Seg<font color="#000080">(</font>playbuf<font color="#000080">^) </font><font color="#FF0000"><b>Shl </b></font><font color="#800000">4 </font><font color="#000080">+ </font>Ofs<font color="#000080">(</font>playbuf<font color="#000080">^);
  </font>page <font color="#000080">:= (</font>Seg<font color="#000080">(</font>playbuf<font color="#000080">^) + </font>Ofs<font color="#000080">(</font>playbuf<font color="#000080">^) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">12</font><font color="#000080">;
</font><font color="#008000"><i>{ DMA programming }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">5</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0C</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0B</font><font color="#000080">] := </font><font color="#800000">$59</font><font color="#000080">; </font><font color="#008000"><i>{ DMA autoinit }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$83</font><font color="#000080">] := </font>page<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;
</font><font color="#008000"><i>{ SB programming }
  </i></font>WriteDSP<font color="#000080">(</font><font color="#800000">$40</font><font color="#000080">);
  </font>WriteDSP<font color="#000080">(</font>timeconst<font color="#000080">);
  </font>WriteDSP<font color="#000080">(</font><font color="#800000">$48</font><font color="#000080">); </font><font color="#008000"><i>{ 8-bit sample type with autoinit}
  </i></font>WriteDSP<font color="#000080">(</font>Lo<font color="#000080">(</font>playbufsize <font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">));
  </font>WriteDSP<font color="#000080">(</font>Hi<font color="#000080">(</font>playbufsize <font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">));
  </font>WriteDSP<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">) </font><font color="#008000"><i>{???? I don't know why, but it is necessary }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>mix<font color="#000080">;
</font><font color="#008000"><i>{ Main procedure - mixes samples with appropriate frequencies and
  puts mixed signal into play buffer. If it's too slow for your
  computer, don't blame me - but translate procedure into assembler
  (or buy something faster :-) }
</i></font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">,</font>j <font color="#000080">: </font>integer<font color="#000080">;
  </font>nvoice<font color="#000080">,</font>sw  <font color="#000080">: </font>word<font color="#000080">;
  </font>pombuf <font color="#000080">: ^</font>sampledata<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ Pointer to play buffer - is it first, or second part? }
  </i></font><font color="#FF0000"><b>if </b></font>firstbuff <font color="#FF0000"><b>then </b></font>pombuf<font color="#000080">:=@</font>sampledata<font color="#000080">(</font>playbuf<font color="#000080">^)[</font>playbufsize <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">]
               </font><font color="#FF0000"><b>else </b></font>pombuf<font color="#000080">:=</font>playbuf<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>playbufsize <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
  begin
    </b></font>sw<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>j<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>max_num_channels <font color="#FF0000"><b>do
      if </b></font>channelsactive<font color="#000080">[</font>j<font color="#000080">] </font><font color="#FF0000"><b>then
      begin
        </b></font>nvoice<font color="#000080">:=</font>channelsnvoice<font color="#000080">[</font>j<font color="#000080">];
</font><font color="#008000"><i>{ That's mixing - without interpolation. }
        </i></font>inc<font color="#000080">(</font>sw<font color="#000080">, </font>voicesdata<font color="#000080">[</font>nvoice<font color="#000080">]^[</font>channelsposition<font color="#000080">[</font>j<font color="#000080">]] * </font>channelsvol<font color="#000080">[</font>j<font color="#000080">]);
</font><font color="#008000"><i>{ Here is the most important thing - next two lines (excluding
  remarks:) are responsible for output frequency of sample.  }
        </i></font>inc<font color="#000080">(</font>channelssubposition<font color="#000080">[</font>j<font color="#000080">],</font>channelsincrement<font color="#000080">[</font>j<font color="#000080">]);
</font><font color="#008000"><i>{ That's a nasty trick - but it works. You can do it other ways,
  in Pascal, Assembler and so on. }
        </i></font><font color="#FF0000"><b>if </b></font>carry <font color="#FF0000"><b>then </b></font>inc<font color="#000080">(</font>channelsposition<font color="#000080">[</font>j<font color="#000080">]);
</font><font color="#008000"><i>{ Now work with looped samples. }
        </i></font><font color="#FF0000"><b>if </b></font>channelsinloop<font color="#000080">[</font>j<font color="#000080">] </font><font color="#FF0000"><b>then
          if </b></font>channelsposition<font color="#000080">[</font>j<font color="#000080">] &gt; </font>voicesloopend<font color="#000080">[</font>nvoice<font color="#000080">] </font><font color="#FF0000"><b>then
                 </b></font>channelsposition<font color="#000080">[</font>j<font color="#000080">] := </font>voicesloopstart<font color="#000080">[</font>nvoice<font color="#000080">];
</font><font color="#008000"><i>{ Maybe we should stop playing this sample? Or put it in a loop mode? }
        </i></font><font color="#FF0000"><b>if </b></font>channelsposition<font color="#000080">[</font>j<font color="#000080">] &gt; </font>voicessize<font color="#000080">[</font>nvoice<font color="#000080">] </font><font color="#FF0000"><b>then
          if </b></font>voicesloopstart<font color="#000080">[</font>nvoice<font color="#000080">]&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
          begin
            </b></font>channelsposition<font color="#000080">[</font>j<font color="#000080">] := </font>voicesloopstart<font color="#000080">[</font>nvoice<font color="#000080">];
            </font>channelsinloop<font color="#000080">[</font>j<font color="#000080">]:=</font>true
          <font color="#FF0000"><b>end
          else </b></font>channelsactive<font color="#000080">[</font>j<font color="#000080">]:=</font>false<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>pombuf<font color="#000080">^[</font>i<font color="#000080">]:=</font>Lo<font color="#000080">(</font>sw <font color="#FF0000"><b>shr </b></font><font color="#800000">6</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>inthandler<font color="#000080">;
</font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>w <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>w<font color="#000080">:=</font>Port<font color="#000080">[</font>DSP_DATA_AVAIL<font color="#000080">];
  </font>port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
  </font>firstbuff<font color="#000080">:=</font><font color="#FF0000"><b>not </b></font>firstbuff<font color="#000080">;
  </font>mix<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>enableIRQ<font color="#000080">(</font>n <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>and not </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>n<font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>disableIRQ<font color="#000080">(</font>n <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>n<font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>allocmem<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p <font color="#000080">: </font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>adr <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ Allocates memory not crossing page boundary ($X0000) }
  </i></font><font color="#FF0000"><b>repeat
    </b></font>getmem<font color="#000080">(</font>p<font color="#000080">,</font>playbufsize<font color="#000080">);
    </font>adr<font color="#000080">:=</font>longint<font color="#000080">(</font>Seg<font color="#000080">(</font>p<font color="#000080">^)) </font><font color="#FF0000"><b>Shl </b></font><font color="#800000">4 </font><font color="#000080">+ </font>Ofs<font color="#000080">(</font>p<font color="#000080">^);
  </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>adr <font color="#FF0000"><b>and </b></font><font color="#800000">$FFFF</font><font color="#000080">)&lt;</font><font color="#800000">$FFFF</font><font color="#000080">-</font>playbufsize
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$F+ }
</i></font><font color="#FF0000"><b>procedure </b></font>MixerExit<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ExitProc<font color="#000080">:=</font>OldExit<font color="#000080">;
  </font>WriteDSP<font color="#000080">(</font><font color="#800000">$D0</font><font color="#000080">); </font><font color="#008000"><i>{ ??? }
  </i></font>speakeroff<font color="#000080">;
  </font>disableIRQ<font color="#000080">(</font>SBIRQ<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">+</font>SBIRQ<font color="#000080">,</font>oldint<font color="#000080">);
  </font>ResetDSP<font color="#000080">(</font>SBIO<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F- }

</i></font><font color="#FF0000"><b>procedure </b></font>initplayloop<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not </b></font>ResetDSP<font color="#000080">(</font>SBIO<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>HALT<font color="#000080">;
  </font>allocmem<font color="#000080">(</font>playbuf<font color="#000080">);
  </font>getintvec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">+</font>SBIRQ<font color="#000080">,</font>oldint<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">+</font>SBIRQ<font color="#000080">,@</font>inthandler<font color="#000080">);
  </font>enableIRQ<font color="#000080">(</font>SBIRQ<font color="#000080">);
  </font>speakeron<font color="#000080">;
  </font>timeconst<font color="#000080">:=</font><font color="#800000">256</font><font color="#000080">-</font><font color="#800000">1000000 </font><font color="#FF0000"><b>div </b></font>PlayFreq<font color="#000080">;
  </font>fillchar<font color="#000080">(</font>playbuf<font color="#000080">^,</font>playbufsize<font color="#000080">,</font><font color="#800000">#0</font><font color="#000080">);
  </font>playback<font color="#000080">;
  </font>OldExit<font color="#000080">:=</font>ExitProc<font color="#000080">;
  </font>ExitProc<font color="#000080">:=@</font>MixerExit
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>addvoice<font color="#000080">(</font>voice<font color="#000080">,</font>_samplesize<font color="#000080">,</font>_loopstart<font color="#000080">,</font>_loopend <font color="#000080">: </font>word<font color="#000080">;
                   </font>sample <font color="#000080">: </font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>voicesdata<font color="#000080">[</font>voice<font color="#000080">]:=</font>sample<font color="#000080">;
  </font>voicessize<font color="#000080">[</font>voice<font color="#000080">]:=</font>_samplesize<font color="#000080">;
  </font>voicesloopstart<font color="#000080">[</font>voice<font color="#000080">]:=</font>_loopstart<font color="#000080">;
  </font>voicesloopend<font color="#000080">[</font>voice<font color="#000080">]:=</font>_loopend<font color="#000080">;
  </font>voicesdefined<font color="#000080">[</font>voice<font color="#000080">]:=</font>true
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>startchannel<font color="#000080">(</font>channel<font color="#000080">,</font>voice<font color="#000080">,</font>volume<font color="#000080">,</font>frequency <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>channelsactive<font color="#000080">[</font>channel<font color="#000080">] </font><font color="#FF0000"><b>then </b></font>channelsactive<font color="#000080">[</font>channel<font color="#000080">]:=</font>true<font color="#000080">;
  </font>channelsinloop<font color="#000080">[</font>channel<font color="#000080">]:=</font>false<font color="#000080">;
  </font>channelsnvoice<font color="#000080">[</font>channel<font color="#000080">]:=</font>voice<font color="#000080">;
  </font>channelsincrement<font color="#000080">[</font>channel<font color="#000080">]:=(</font>longint<font color="#000080">(</font>frequency<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>PlayFreq<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>volume<font color="#000080">&gt;=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>volume<font color="#000080">&lt;=</font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>channelsvol<font color="#000080">[</font>channel<font color="#000080">]:=</font>volume
                                  <font color="#FF0000"><b>else </b></font>channelsvol<font color="#000080">[</font>channel<font color="#000080">]:=</font><font color="#800000">16</font><font color="#000080">;
  </font>channelssubposition<font color="#000080">[</font>channel<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
  </font>channelsposition<font color="#000080">[</font>channel<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>stopchannel<font color="#000080">(</font>channel <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>channelsactive<font color="#000080">[</font>channel<font color="#000080">]:=</font>false<font color="#000080">;
  </font>channelsinloop<font color="#000080">[</font>channel<font color="#000080">]:=</font>false
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setchannelfrequency<font color="#000080">(</font>channel<font color="#000080">,</font>frequency <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>channelsincrement<font color="#000080">[</font>channel<font color="#000080">]:=(</font>longint<font color="#000080">(</font>frequency<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">16</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>PlayFreq<font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setchannelvolume<font color="#000080">(</font>channel<font color="#000080">,</font>volume <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{}
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>volume<font color="#000080">&gt;=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>volume<font color="#000080">&lt;=</font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>channelsvol<font color="#000080">[</font>channel<font color="#000080">]:=</font>volume<font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>fillchar<font color="#000080">(</font>voicesdata<font color="#000080">,</font>sizeof<font color="#000080">(</font>voicesdata<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>voicessize<font color="#000080">,</font>sizeof<font color="#000080">(</font>voicessize<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>voicesloopstart<font color="#000080">,</font>sizeof<font color="#000080">(</font>voicesloopstart<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>voicesloopend<font color="#000080">,</font>sizeof<font color="#000080">(</font>voicesloopend<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>voicesdefined<font color="#000080">,</font>sizeof<font color="#000080">(</font>voicesdefined<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>channelsnvoice<font color="#000080">,</font>sizeof<font color="#000080">(</font>channelsnvoice<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>channelsposition<font color="#000080">,</font>sizeof<font color="#000080">(</font>channelsposition<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>channelsincrement<font color="#000080">,</font>sizeof<font color="#000080">(</font>channelsincrement<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>channelssubposition<font color="#000080">,</font>sizeof<font color="#000080">(</font>channelssubposition<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>channelsvol<font color="#000080">,</font>sizeof<font color="#000080">(</font>channelsvol<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>channelsinloop<font color="#000080">,</font>sizeof<font color="#000080">(</font>channelsinloop<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillchar<font color="#000080">(</font>channelsactive<font color="#000080">,</font>sizeof<font color="#000080">(</font>channelsactive<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>initplayloop
<font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0084.PAS">Original</a><b>]</b></p></body>
</html>
