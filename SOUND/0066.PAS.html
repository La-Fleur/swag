<html>
<head><title> "Reading and Converting MIDI Files" by COLIN BUCKLEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0066.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: colin.buckley@canrem.com (Colin Buckley)

&gt;&gt; Does anyone have some good Pascal code for 1) real-time MIDI performance
&gt;&gt; on a standard (Roland MPU-401) card; or 2) reading of MIDI data files.

&gt;Nope.  Nobody has any of this, nor does any exist anywhere on the
&gt;Internet, I can guarantee you this.  I have been asking for this for over
&gt;a year now and it just does *not* exist anywhere.

Which question are you answering?

MIDI is very simple stuff.  Playing or reading and writing the files.
Playing just involves tossing the midi messages out a port.  To read or
write, all you need are the MIDI specs, and you shouldn't have any problem
finding those.  But I don't have FTP so I wouldn't really know.

I have &quot;pascal code&quot; for question 1, but it's actually assembler.  I write
all my low level stuff in assembler, then I wrote a pascal shell around it
when someone in the Fido pascal conference wanted to play MIDI.  It should
be in SWAG, never looked though.  I'll include it at the end of this message.
Just a little while ago I saw a pure Turbo Pascal version.

As for question 2, I'll post the pascal code to my MIDI file convertor as it
can read in *certain* MIDI files.  I've only tested it on files created with
ROL2MIDI, which means there single track and only certain events appear.
It converts to a simple format I use in my games.

Look for the source code disk from the Official Sound Blaster Book (I think
that's the title).  It uses nothing but Creative Lab drivers, but it does
have code to read MOD and MIDI files.  I have the MIDI Unit (MIDUNIT), but
I didn't write it, so I won't post it or email it.  It supports more midi
messages then my routines do, but it's also single track.
}
</i></font><font color="#FF0000"><b>Program </b></font>MDI2MUS<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>CRT<font color="#000080">,</font>Fast<font color="#000080">,</font>FM<font color="#000080">,</font>GM<font color="#000080">;
  </font><font color="#008000"><i>{ It's obivously not going to compile.  FAST is just my unit of little
    routines, like screen writes, string routines, etc.

    FM and GM have the same functions and procedures for playing sounds
    on those devices as the purpose of the program is to convert a MDI
    composed on an Adlib to something I can play on Adlib or General Midi.
    The PickGMInstrument, lets me pick a GM instrument by hearing both.

    Comment out the sound stuff, and supply your own generic routines.
  }


</i></font><font color="#FF0000"><b>Const
  </b></font>MUSID<font color="#000080">=</font><font color="#800000">245</font><font color="#000080">;
  </font>MUSTempo<font color="#000080">=</font><font color="#800000">72.8</font><font color="#000080">;
  </font>MUSOverflow<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
  </font>MUSInstrument<font color="#000080">=</font><font color="#800000">1 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
  </font>MUSVolume<font color="#000080">=</font><font color="#800000">2 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
  </font>MUSNoteOn<font color="#000080">=</font><font color="#800000">3 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
  </font>MUSNoteOff<font color="#000080">=</font><font color="#800000">4 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
  </font>MUSPitch<font color="#000080">=</font><font color="#800000">5 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
  </font>MUSMarker<font color="#000080">=</font><font color="#800000">14 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
  </font>MUSEnd<font color="#000080">=</font><font color="#800000">15 </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>MUSHeaderRec<font color="#000080">=</font><font color="#FF0000"><b>Record
    </b></font>ID<font color="#000080">:</font>Byte<font color="#000080">;
    </font>Title<font color="#000080">:</font>MStr<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font>MUSInsRec<font color="#000080">=</font><font color="#FF0000"><b>Record
    </b></font>GMIns<font color="#000080">:</font>Byte<font color="#000080">;
    </font>FMIns<font color="#000080">:</font>FMInstrument<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font>MDIHeaderRec<font color="#000080">=</font><font color="#FF0000"><b>Record
    </b></font>ID<font color="#000080">:</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
    </font>Length<font color="#000080">:</font>LongInt<font color="#000080">;
    </font>Format<font color="#000080">:</font>Word<font color="#000080">;
    </font>NumTracks<font color="#000080">:</font>Word<font color="#000080">;
    </font>Division<font color="#000080">:</font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font>MDITrackRec<font color="#000080">=</font><font color="#FF0000"><b>Record
    </b></font>ID<font color="#000080">:</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Char<font color="#000080">;
    </font>Length<font color="#000080">:</font>LongInt<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>MUS<font color="#000080">:</font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>MUSHeader<font color="#000080">:</font>MUSHeaderRec<font color="#000080">;
  </font>MDI<font color="#000080">:</font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>MDIHeader<font color="#000080">:</font>MDIHeaderRec<font color="#000080">;
  </font>MDITrack<font color="#000080">:</font>MDITrackRec<font color="#000080">;
  </font>EndOfTrack<font color="#000080">:</font>Boolean<font color="#000080">;
  </font>Next<font color="#000080">:</font>Byte<font color="#000080">;
  </font>NewTempo<font color="#000080">:</font>Real<font color="#000080">;
  </font>Tempo<font color="#000080">:</font>LongInt<font color="#000080">;
  </font>Time<font color="#000080">:</font>Word<font color="#000080">;
  </font>Channel<font color="#000080">:</font>Byte<font color="#000080">;
  </font>Command<font color="#000080">:</font>Byte<font color="#000080">;
  </font>Note<font color="#000080">:</font>Byte<font color="#000080">;
  </font>Volume<font color="#000080">:</font>Byte<font color="#000080">;
  </font>VolumeArray<font color="#000080">:</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>Pitch<font color="#000080">:</font>Word<font color="#000080">;
  </font>FMIns<font color="#000080">:</font>Instrument<font color="#000080">;
  </font>MUSIns<font color="#000080">:</font>MUSInsRec<font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>Error<font color="#000080">(</font>Msg<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);
  </font><font color="#FF0000"><b>Begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'* '</font><font color="#000080">+</font>Msg<font color="#000080">);
    </font>Halt<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>PickGMInstrument<font color="#000080">(</font>Voice<font color="#000080">:</font>Byte<font color="#000080">);
  </font><font color="#FF0000"><b>Var
    </b></font>Patch<font color="#000080">:</font>Byte<font color="#000080">;
    </font>Key<font color="#000080">:</font>Char<font color="#000080">;
    </font>FMOn<font color="#000080">:</font>Boolean<font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>InitMUS<font color="#000080">;
    </font><font color="#FF0000"><b>Begin
      </b></font>FM<font color="#000080">.</font>InitFM<font color="#000080">;
      </font>GM<font color="#000080">.</font>InitGM<font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>ResetMUS<font color="#000080">;
    </font><font color="#FF0000"><b>Begin
      </b></font>FM<font color="#000080">.</font>ResetFM<font color="#000080">;
      </font>GM<font color="#000080">.</font>ResetGM<font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>SetNoteOn<font color="#000080">(</font>Voice<font color="#000080">,</font>Note<font color="#000080">:</font>Byte<font color="#000080">);
    </font><font color="#FF0000"><b>Begin
      If </b></font>FMOn <font color="#FF0000"><b>then
        </b></font>FM<font color="#000080">.</font>SetNoteOn<font color="#000080">(</font>Voice<font color="#000080">,</font>Note<font color="#000080">)
      </font><font color="#FF0000"><b>Else
        </b></font>GM<font color="#000080">.</font>GMSetNoteOn<font color="#000080">(</font>Voice<font color="#000080">,</font>Note<font color="#000080">)
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>SetNoteOff<font color="#000080">(</font>Voice<font color="#000080">:</font>Byte<font color="#000080">);
    </font><font color="#FF0000"><b>Begin
      If </b></font>FMOn <font color="#FF0000"><b>then
        </b></font>FM<font color="#000080">.</font>SetNoteOff<font color="#000080">(</font>Voice<font color="#000080">)
      </font><font color="#FF0000"><b>Else
        </b></font>GM<font color="#000080">.</font>GMSetNoteOn<font color="#000080">(</font>Voice<font color="#000080">,</font>Note<font color="#000080">)
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>SetVolume<font color="#000080">(</font>Voice<font color="#000080">,</font>Volume<font color="#000080">:</font>Byte<font color="#000080">);
    </font><font color="#FF0000"><b>Begin
      </b></font>FM<font color="#000080">.</font>SetVolume<font color="#000080">(</font>Voice<font color="#000080">,</font>Volume<font color="#000080">);
      </font>GM<font color="#000080">.</font>GMSetVolume<font color="#000080">(</font>Voice<font color="#000080">,</font>Volume<font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Begin
    </b></font>FMOn<font color="#000080">:=</font>True<font color="#000080">;
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Encountered FM Instrument on Channel '</font><font color="#000080">,</font>Voice<font color="#000080">);
    </font>Writeln<font color="#000080">;
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Instructions:'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'C     = Middle C Note'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'1..0  = Note Scale'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'SPACE = Toggle Device'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'P     = Change Patch'</font><font color="#000080">);
    </font>Writeln<font color="#000080">;
    </font>InitMUS<font color="#000080">;
    </font>FM<font color="#000080">.</font>SetInstrument<font color="#000080">(</font>Voice<font color="#000080">,@</font>MUSIns<font color="#000080">.</font>FMIns<font color="#000080">);
    </font>GMSetInstrument<font color="#000080">(</font>Voice<font color="#000080">,</font>MUSIns<font color="#000080">.</font>GMIns<font color="#000080">);
    </font>SetVolume<font color="#000080">(</font>Voice<font color="#000080">,</font><font color="#800000">127</font><font color="#000080">);
    </font><font color="#FF0000"><b>Repeat
      </b></font>Write<font color="#000080">(</font><font color="#800000">'Patch: '</font><font color="#000080">,</font>MUSIns<font color="#000080">.</font>GMIns<font color="#000080">);</font>ClrEol<font color="#000080">;
      </font>GotoXY<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>WhereY<font color="#000080">);
      </font>Key<font color="#000080">:=</font>Upcase<font color="#000080">(</font>BIOSKey<font color="#000080">);
      </font><font color="#FF0000"><b>Case </b></font>Key <font color="#FF0000"><b>of
        </b></font><font color="#800000">'1'</font><font color="#000080">..</font><font color="#800000">'9'</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
                   </b></font>SetNoteOn<font color="#000080">(</font>Voice<font color="#000080">,</font><font color="#800000">54</font><font color="#000080">+(</font>Ord<font color="#000080">(</font>Key<font color="#000080">)-</font><font color="#800000">48</font><font color="#000080">));
                   </font>Delay<font color="#000080">(</font><font color="#800000">175</font><font color="#000080">);
                   </font>SetNoteOff<font color="#000080">(</font>Voice<font color="#000080">);
                 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#800000">'0'</font><font color="#000080">:     </font><font color="#FF0000"><b>Begin
                   </b></font>SetNoteOn<font color="#000080">(</font>Voice<font color="#000080">,</font><font color="#800000">65</font><font color="#000080">);
                   </font>Delay<font color="#000080">(</font><font color="#800000">175</font><font color="#000080">);
                   </font>SetNoteOff<font color="#000080">(</font>Voice<font color="#000080">);
                 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
         </font>SPACEKey<font color="#000080">:</font>FMOn<font color="#000080">:=</font><font color="#FF0000"><b>Not </b></font>FMOn<font color="#000080">;
         </font><font color="#800000">'P'</font><font color="#000080">:    </font><font color="#FF0000"><b>Begin
                   </b></font>Writeln<font color="#000080">;
                   </font>Write<font color="#000080">(</font><font color="#800000">'New Patch [0-127]: '</font><font color="#000080">);
                   </font>Readln<font color="#000080">(</font>MUSIns<font color="#000080">.</font>GMIns<font color="#000080">);
                   </font>GotoXY<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>WhereY<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">);
                   </font>ClrEol<font color="#000080">;
                   </font>GotoXY<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>WhereY<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">);
                   </font>ClrEol<font color="#000080">;
                   </font>GMSetInstrument<font color="#000080">(</font>Voice<font color="#000080">,</font>MUSIns<font color="#000080">.</font>GMIns<font color="#000080">);
                 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Key<font color="#000080">=</font>ESCKey<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Key<font color="#000080">=</font>ENTERKey<font color="#000080">);
    </font>ResetMUS<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>WriteMUS<font color="#000080">(</font>Time<font color="#000080">:</font>Byte<font color="#000080">; </font>Command<font color="#000080">,</font>Channel<font color="#000080">:</font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Data<font color="#000080">; </font>DataSize<font color="#000080">:</font>Byte<font color="#000080">);
  </font><font color="#FF0000"><b>Var
    </b></font>Combined<font color="#000080">:</font>Byte<font color="#000080">;
    </font>T<font color="#000080">:</font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    </b></font><font color="#008000"><i>{ Set Delta Time }
    </i></font>BlockWrite<font color="#000080">(</font>MUS<font color="#000080">,</font>Time<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Time<font color="#000080">));
    </font><font color="#FF0000"><b>ASM
      </b></font><font color="#FF00FF">MOV  AL,[Command]
      AND  AL,11110000b
      MOV  AH,[Channel]
      AND  AH,00001111b
      ADD  AL,AH
      MOV  [Combined],AL
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#008000"><i>{ Set Command/Channel Combined Byte }
    </i></font>BlockWrite<font color="#000080">(</font>MUS<font color="#000080">,</font>Combined<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Combined<font color="#000080">));
    </font><font color="#008000"><i>{ Set Command Data }
    </i></font><font color="#FF0000"><b>If </b></font>DataSize<font color="#000080">&gt;=</font><font color="#800000">1 </font><font color="#FF0000"><b>then
      </b></font>BlockWrite<font color="#000080">(</font>MUS<font color="#000080">,</font>Data<font color="#000080">,</font>DataSize<font color="#000080">);
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Function </b></font>IntelLong<font color="#000080">(</font>Motorolla<font color="#000080">:</font>LongInt<font color="#000080">):</font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV  AX,[WORD PTR Motorolla]
    MOV  DX,[WORD PTR Motorolla+2]
    XCHG AL,AH
    XCHG DL,DH
    XCHG AX,DX
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Function </b></font>IntelWord<font color="#000080">(</font>Motorolla<font color="#000080">:</font>Word<font color="#000080">):</font>Word<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV  AX,[Motorolla]
    XCHG AL,AH
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>ReadMDI<font color="#000080">(</font>MDIFile<font color="#000080">:</font>LStr<font color="#000080">);
  </font><font color="#FF0000"><b>Begin
    </b></font>Assign<font color="#000080">(</font>MDI<font color="#000080">,</font>MDIFile<font color="#000080">);
    </font>Reset<font color="#000080">(</font>MDI<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Error<font color="#000080">(</font>MDIFile<font color="#000080">+</font><font color="#800000">' Not Found!'</font><font color="#000080">);
    </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>MDIHeader<font color="#000080">,</font>SizeOf<font color="#000080">(</font>MDIHeader<font color="#000080">));
    </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>MDITrack<font color="#000080">,</font>SizeOf<font color="#000080">(</font>MDITrack<font color="#000080">));
    </font><font color="#FF0000"><b>With </b></font>MDIHeader <font color="#FF0000"><b>do
    Begin
      </b></font>Length<font color="#000080">:=</font>IntelLong<font color="#000080">(</font>Length<font color="#000080">);
      </font>Format<font color="#000080">:=</font>IntelWord<font color="#000080">(</font>Format<font color="#000080">);
      </font>NumTracks<font color="#000080">:=</font>IntelWord<font color="#000080">(</font>NumTracks<font color="#000080">);
      </font>Division<font color="#000080">:=</font>IntelWord<font color="#000080">(</font>Division<font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>With </b></font>MDITrack <font color="#FF0000"><b>do
      </b></font>Length<font color="#000080">:=</font>IntelLong<font color="#000080">(</font>Length<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>MDIHeader<font color="#000080">.</font>ID<font color="#000080">&lt;&gt;</font><font color="#800000">'MThd'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>MDIHeader<font color="#000080">.</font>Format<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>MDITrack<font color="#000080">.</font>ID<font color="#000080">&lt;&gt;</font><font color="#800000">'MTrk'</font><font color="#000080">)
      </font>Error<font color="#000080">(</font><font color="#800000">'Invalid Type 0 .MDI File: '</font><font color="#000080">+</font>MDIFile<font color="#000080">);
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>CreateMUS<font color="#000080">(</font>MUSFile<font color="#000080">:</font>LStr<font color="#000080">);
  </font><font color="#FF0000"><b>Var
    </b></font>Temp<font color="#000080">:</font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    </b></font>FillChar<font color="#000080">(</font>MUSHeader<font color="#000080">,</font>SizeOf<font color="#000080">(</font>MUSHeader<font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
    </font>MUSHeader<font color="#000080">.</font>ID<font color="#000080">:=</font>MUSID<font color="#000080">;
    </font>Write<font color="#000080">(</font><font color="#800000">'Enter Title: '</font><font color="#000080">);
    </font>Readln<font color="#000080">(</font>MUSHeader<font color="#000080">.</font>Title<font color="#000080">);
    </font>Assign<font color="#000080">(</font>MUS<font color="#000080">,</font>MUSFile<font color="#000080">);
    </font>Rewrite<font color="#000080">(</font>MUS<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>MUS<font color="#000080">,</font>MUSHeader<font color="#000080">,</font>SizeOf<font color="#000080">(</font>MUSHeader<font color="#000080">));
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>ConvertMDI<font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>DoDeltaTime<font color="#000080">;
    </font><font color="#FF0000"><b>Var
      </b></font>VarLength<font color="#000080">:</font>LongInt<font color="#000080">;
    </font><font color="#FF0000"><b>Begin
      </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Next<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>VarLength<font color="#000080">:=</font>Next<font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>Next <font color="#FF0000"><b>And </b></font><font color="#800000">$80</font><font color="#000080">)=</font><font color="#800000">$80 </font><font color="#FF0000"><b>then
      Begin
        </b></font>VarLength<font color="#000080">:=</font>VarLength <font color="#FF0000"><b>And </b></font><font color="#800000">$7F</font><font color="#000080">;
        </font><font color="#FF0000"><b>Repeat
          </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Next<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
          </font>VarLength<font color="#000080">:=(</font>VarLength <font color="#FF0000"><b>Shl </b></font><font color="#800000">7</font><font color="#000080">) + (</font>Next <font color="#FF0000"><b>And </b></font><font color="#800000">$7F</font><font color="#000080">)
        </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Next <font color="#FF0000"><b>And </b></font><font color="#800000">$80</font><font color="#000080">)&lt;&gt;</font><font color="#800000">$80</font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font>Time<font color="#000080">:=</font>Trunc<font color="#000080">(</font>VarLength<font color="#000080">*</font>NewTempo<font color="#000080">);
      </font><font color="#FF0000"><b>If </b></font>Time<font color="#000080">&gt;</font><font color="#800000">255 </font><font color="#FF0000"><b>then
      Begin
        </b></font>WriteMUS<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>MUSOverflow<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>Time<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Time<font color="#000080">));
        </font>Time<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>DoSysExEvent<font color="#000080">;
    </font><font color="#FF0000"><b>Begin

    End</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>DoMIDIEvent<font color="#000080">;
    </font><font color="#FF0000"><b>Begin
      </b></font>Channel<font color="#000080">:=</font>Command <font color="#FF0000"><b>And </b></font><font color="#800000">$F</font><font color="#000080">;
      </font>Command<font color="#000080">:=</font>Command <font color="#FF0000"><b>And </b></font><font color="#800000">$F0</font><font color="#000080">;
      </font><font color="#FF0000"><b>Case </b></font>Command <font color="#FF0000"><b>of
        </b></font><font color="#008000"><i>{ Note Off }
        </i></font><font color="#800000">$80</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
              </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Note<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
              </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Volume<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
              </font>WriteMUS<font color="#000080">(</font>Time<font color="#000080">,</font>MUSNoteOff<font color="#000080">,</font>Channel<font color="#000080">,</font>Note<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#008000"><i>{ Note On }
        </i></font><font color="#800000">$90</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
              </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Note<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
              </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Volume<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
              </font><font color="#008000"><i>{ If Volume=0 it's the same as a NoteOff }
              </i></font><font color="#FF0000"><b>If </b></font>Volume<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
                </b></font>WriteMUS<font color="#000080">(</font>Time<font color="#000080">,</font>MUSNoteOff<font color="#000080">,</font>Channel<font color="#000080">,</font>Note<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)
              </font><font color="#FF0000"><b>Else
              Begin
                </b></font><font color="#008000"><i>{ Update Volume if different then previous }
                </i></font><font color="#FF0000"><b>If </b></font>VolumeArray<font color="#000080">[</font>Channel<font color="#000080">]&lt;&gt;</font>Volume <font color="#FF0000"><b>then
                Begin
                  </b></font>VolumeArray<font color="#000080">[</font>Channel<font color="#000080">]:=</font>Volume<font color="#000080">;
                  </font>WriteMUS<font color="#000080">(</font>Time<font color="#000080">,</font>MUSVolume<font color="#000080">,</font>Channel<font color="#000080">,</font>Volume<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Volume<font color="#000080">));
                  </font>Time<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
                </font>WriteMUS<font color="#000080">(</font>Time<font color="#000080">,</font>MUSNoteOn<font color="#000080">,</font>Channel<font color="#000080">,</font>Note<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Note<font color="#000080">));
              </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#008000"><i>{ Volume Change / Channel Pressure / After Touch }
        </i></font><font color="#800000">$D0</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
              </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Volume<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#008000"><i>{ Pitch Change }
        </i></font><font color="#800000">$E0</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
              </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Pitch<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
              </font>Pitch<font color="#000080">:=</font>IntelWord<font color="#000080">(</font>Pitch<font color="#000080">);
              </font>WriteMUS<font color="#000080">(</font>Time<font color="#000080">,</font>MUSPitch<font color="#000080">,</font>Channel<font color="#000080">,</font>Pitch<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Pitch<font color="#000080">));
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>Else
          </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Unknown MIDI event!'</font><font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>DoMetaEvent<font color="#000080">;
    </font><font color="#FF0000"><b>Var
      </b></font>Length<font color="#000080">:</font>Byte<font color="#000080">;
      </font>FPos<font color="#000080">:</font>LongInt<font color="#000080">;
      </font>ID<font color="#000080">:</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
    </font><font color="#FF0000"><b>Begin
      </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Command<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Length<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>FPos<font color="#000080">:=</font>FilePos<font color="#000080">(</font>MDI<font color="#000080">);
      </font><font color="#FF0000"><b>Case </b></font>Command <font color="#FF0000"><b>of
        </b></font><font color="#800000">$2F</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
              </b></font>EndOfTrack<font color="#000080">:=</font>True<font color="#000080">;
              </font>WriteMUS<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>MUSEnd<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>Note<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#008000"><i>{ Tempo }
        </i></font><font color="#800000">$51</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
              </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Next<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
              </font>Tempo<font color="#000080">:=</font>Next<font color="#000080">*</font><font color="#800000">65536</font><font color="#000080">;
              </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Next<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
              </font>Inc<font color="#000080">(</font>Tempo<font color="#000080">,</font>Word<font color="#000080">(</font>Next<font color="#000080">*</font><font color="#800000">256</font><font color="#000080">));
              </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Next<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
              </font>Inc<font color="#000080">(</font>Tempo<font color="#000080">,</font>Next<font color="#000080">);
              </font>NewTempo<font color="#000080">:=</font>MUSTempo<font color="#000080">/(</font>MDIHeader<font color="#000080">.</font>Division<font color="#000080">*(</font><font color="#800000">1000000</font><font color="#000080">/</font>Tempo<font color="#000080">));
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#008000"><i>{ Sequencer Specific }
        </i></font><font color="#800000">$7F</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
              </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>ID<font color="#000080">,</font>SizeOf<font color="#000080">(</font>ID<font color="#000080">));
              </font><font color="#008000"><i>{ Adlib ID }
              </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ID<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]=</font><font color="#800000">$00</font><font color="#000080">) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>ID<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]=</font><font color="#800000">$00</font><font color="#000080">) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>ID<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]=</font><font color="#800000">$3F</font><font color="#000080">) </font><font color="#FF0000"><b>then
                Case </b></font>Ord<font color="#000080">(</font>ID<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">]) </font><font color="#FF0000"><b>of
                  </b></font><font color="#008000"><i>{ Instrument }
                  </i></font><font color="#800000">1</font><font color="#000080">:</font><font color="#FF0000"><b>Begin
                      </b></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Channel<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
                      </font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>FMIns<font color="#000080">,</font>SizeOf<font color="#000080">(</font>FMIns<font color="#000080">));
                      </font>ConvertInstrument<font color="#000080">(</font>FMIns<font color="#000080">,</font>MUSIns<font color="#000080">.</font>FMIns<font color="#000080">);
                      </font>PickGMInstrument<font color="#000080">(</font>Channel<font color="#000080">);
                      </font>WriteMUS<font color="#000080">(</font>Time<font color="#000080">,</font>MUSInstrument<font color="#000080">,</font>Channel<font color="#000080">,</font>MUSIns
SizeOf<font color="#000080">(</font>MUSIns<font color="#000080">))
                    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
                  </font><font color="#008000"><i>{ Melodic or Percussion Mode }
                  </i></font><font color="#800000">2</font><font color="#000080">:</font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Next<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
                  </font><font color="#008000"><i>{ Waveforms }
                  </i></font><font color="#800000">3</font><font color="#000080">:</font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Next<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font>Seek<font color="#000080">(</font>MDI<font color="#000080">,</font>FPos<font color="#000080">+</font>Length<font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Begin
    </b></font>EndOfTrack<font color="#000080">:=</font>False<font color="#000080">;
    </font>Time<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>NewTempo<font color="#000080">:=</font><font color="#800000">500000</font><font color="#000080">;
    </font>FillChar<font color="#000080">(</font>VolumeArray<font color="#000080">,</font>SizeOf<font color="#000080">(</font>VolumeArray<font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>While Not </b></font><font color="#000080">(</font>EOF<font color="#000080">(</font>MDI<font color="#000080">) </font><font color="#FF0000"><b>And </b></font>EndOfTrack<font color="#000080">) </font><font color="#FF0000"><b>do
    Begin
      </b></font><font color="#008000"><i>{ Get Time of Event }
      </i></font>DoDeltaTime<font color="#000080">;
      </font><font color="#008000"><i>{ Get Event from Midi Stream }
      </i></font>BlockRead<font color="#000080">(</font>MDI<font color="#000080">,</font>Command<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>Case </b></font>Command <font color="#FF0000"><b>of
        </b></font><font color="#800000">$80</font><font color="#000080">..</font><font color="#800000">$EF</font><font color="#000080">:</font>DoMidiEvent<font color="#000080">;
        </font><font color="#008000"><i>{
        $F0,$F7: DoSysExEvent;
        }
        </i></font><font color="#800000">$FF</font><font color="#000080">:     </font>DoMetaEvent<font color="#000080">;
      </font><font color="#FF0000"><b>Else
        </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Unknown Event in MIDI Stream!'</font><font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font>Close<font color="#000080">(</font>MDI<font color="#000080">);
    </font>Close<font color="#000080">(</font>MUS<font color="#000080">);
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Writeln<font color="#000080">(</font><font color="#800000">'+-----------------------  +++++-++|+++++ +++++++++-----------------
  </font>Writeln<font color="#000080">(</font><font color="#800000">'|                         ++++-++++++++- +++++++++-
  </font>Writeln<font color="#000080">(</font><font color="#800000">'|
  </font>Writeln<font color="#000080">(</font><font color="#800000">'|                              Music Conversion
  </font>Writeln<font color="#000080">(</font><font color="#800000">'|
  </font>Writeln<font color="#000080">(</font><font color="#800000">'|              Copyright 1992 by Absolute Magic, Inc and Colin Buckle
  </font>Writeln<font color="#000080">(</font><font color="#800000">'+--------------------------------------------------------------------
  </font>Writeln<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>ParamCount<font color="#000080">&lt;</font><font color="#800000">2 </font><font color="#FF0000"><b>then
  Begin
    </b></font>Writeln<font color="#000080">;
    </font>Writeln<font color="#000080">(</font><font color="#800000">'USAGE: MUS &lt;MDIFile&gt; &lt;MUSFile&gt;'</font><font color="#000080">);
    </font>Writeln<font color="#000080">;
    </font>Writeln<font color="#000080">(</font><font color="#800000">'&lt;MDIFile&gt; is created by converting a .ROL with ROL2MIDI.EXE'</font><font color="#000080">);
    </font>Writeln<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>ReadMDI<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
  </font>CreateMUS<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">));
  </font>ConvertMDI<font color="#000080">;
  </font>Writeln<font color="#000080">;
  </font><font color="#FF0000"><b>If Not </b></font>EndOfTrack <font color="#FF0000"><b>then
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'* Unsuccessful Conversion.  End Of Track Not Encountered.'</font><font color="#000080">)
  </font><font color="#FF0000"><b>Else
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'* Successful Conversion'</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.





-----------------------------------------------------------------------------

</font><font color="#FF0000"><b>Program </b></font>GMTest<font color="#000080">;

</font><font color="#008000"><i>{
Public domain.  Do whatever you want with it.
Colin Buckley.
}

</i></font><font color="#FF0000"><b>Const
  </b></font>GMPort        <font color="#000080">= </font><font color="#800000">$331</font><font color="#000080">;
  </font>Send          <font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">;
  </font>Receive       <font color="#000080">= </font><font color="#800000">$40</font><font color="#000080">;

</font><font color="#008000"><i>{ AL:=Command; }
</i></font><font color="#FF0000"><b>Procedure </b></font>WriteGMCommand<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   DX,GMPort                   </font><font color="#008000"><i>{;DX:=GMStatusPort;                 }
    </i></font><font color="#FF00FF">PUSH  AX                          </font><font color="#008000"><i>{;Save AX                           }
    </i></font><font color="#FF00FF">XOR   AX,AX                       </font><font color="#008000"><i>{;AH:=TimeOutValue;                 }
</i></font><font color="#FF00FF">@@WaitLoop:
    </font><font color="#008000"><i>{ ;Prevent Infinite Loop with Timeout }
    </i></font><font color="#FF00FF">DEC   AH                          </font><font color="#008000"><i>{; |If TimeOutCount=0 then          }
    </i></font><font color="#FF00FF">JZ    @@TimeOut                   </font><font color="#008000"><i>{;/   TimeOut;                      }
    {; Wait until GM is ready }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{; |If Not Ready then               }
    </i></font><font color="#FF00FF">AND   AL,Receive                  </font><font color="#008000"><i>{; |  WaitLoop;                     }
    </i></font><font color="#FF00FF">JNZ   @@WaitLoop                  </font><font color="#008000"><i>{;/                                 }
</i></font><font color="#FF00FF">@@TimeOut:
    POP   AX                          </font><font color="#008000"><i>{;Restore AX                        }

    </i></font><font color="#FF00FF">OUT   DX,AL                       </font><font color="#008000"><i>{;Send Data                         }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ; AL:=Data }
</i></font><font color="#FF0000"><b>Procedure </b></font>WriteGM<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   DX,GMPort                   </font><font color="#008000"><i>{;DX:=GMStatusPort;                 }
    </i></font><font color="#FF00FF">PUSH  AX                          </font><font color="#008000"><i>{;Save AX                           }
    </i></font><font color="#FF00FF">XOR   AX,AX                       </font><font color="#008000"><i>{;AH:=TimeOutValue;                 }
</i></font><font color="#FF00FF">@@WaitLoop:
    </font><font color="#008000"><i>{ ; Prevent Infinite Loop with Timeout }
    </i></font><font color="#FF00FF">DEC   AH                          </font><font color="#008000"><i>{; |If TimeOutCount=0 then          }
    </i></font><font color="#FF00FF">JZ    @@TimeOut                   </font><font color="#008000"><i>{;/   TimeOut;                      }
    { ; Wait until GM is ready }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{; |If Not Ready then               }
    </i></font><font color="#FF00FF">AND   AL,Receive                  </font><font color="#008000"><i>{; |  WaitLoop;                     }
    </i></font><font color="#FF00FF">JNZ   @@WaitLoop                  </font><font color="#008000"><i>{;/                                 }
</i></font><font color="#FF00FF">@@TimeOut:
    POP   AX                          </font><font color="#008000"><i>{;Restore AX                        }

    </i></font><font color="#FF00FF">DEC   DX                          </font><font color="#008000"><i>{;DX:=DataPort                     }
    </i></font><font color="#FF00FF">OUT   DX,AL                       </font><font color="#008000"><i>{;Send Data                        }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ;Returns Data }
</i></font><font color="#FF0000"><b>Function </b></font>ReadGM<font color="#000080">:</font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   DX,GMPort                   </font><font color="#008000"><i>{;DX:=GMStatusPort;                 }
    </i></font><font color="#FF00FF">PUSH  AX                          </font><font color="#008000"><i>{;Save AX                           }
    </i></font><font color="#FF00FF">XOR   AX,AX                       </font><font color="#008000"><i>{;AH:=TimeOutValue;                 }
</i></font><font color="#FF00FF">@@WaitLoop:
    </font><font color="#008000"><i>{ ; Prevent Infinite Loop with Timeout }
    </i></font><font color="#FF00FF">DEC   AH                          </font><font color="#008000"><i>{; |If TimeOutCount=0 then          }
    </i></font><font color="#FF00FF">JZ    @@TimeOut                   </font><font color="#008000"><i>{;/   TimeOut;                      }
    { ; Wait until GM is ready }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{; |If Not Ready then               }
    </i></font><font color="#FF00FF">AND   AL,Send                     </font><font color="#008000"><i>{; |  WaitLoop;                     }
    </i></font><font color="#FF00FF">JNZ   @@WaitLoop                  </font><font color="#008000"><i>{;/                                 }
</i></font><font color="#FF00FF">@@TimeOut:
    POP   AX                          </font><font color="#008000"><i>{;Restore AX                        }

    </i></font><font color="#FF00FF">DEC   DX                          </font><font color="#008000"><i>{;DX:=DataPort                      }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{;Receive Data                      }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ResetGM<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#008000"><i>{ ;Reset GM }
    </i></font><font color="#FF00FF">MOV   DX,GMPort
    MOV   AL,0FFh
    OUT   DX,AL
    </font><font color="#008000"><i>{; Get ACK }
    </i></font><font color="#FF00FF">CALL  ReadGM
    </font><font color="#008000"><i>{; UART Mode }
    </i></font><font color="#FF00FF">MOV   AL,03Fh
    CALL  WriteGMCommand
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetNoteOn<font color="#000080">(</font>Channel<font color="#000080">,</font>Note<font color="#000080">,</font>Volume<font color="#000080">:</font>Byte<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   AL,[Channel]
    ADD   AL,90h
    Call  WriteGM
    MOV   AL,[Note]
    CALL  WriteGM
    MOV   AL,[Volume]
    CALL  WriteGM
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetNoteOff<font color="#000080">(</font>Channel<font color="#000080">,</font>Note<font color="#000080">,</font>Volume<font color="#000080">:</font>Byte<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   AL,[Channel]
    ADD   AL,80h
    Call  WriteGM
    MOV   AL,[Note]
    CALL  WriteGM
    MOV   AL,[Volume]
    CALL  WriteGM
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ResetGM<font color="#000080">;
  </font>SetNoteOn<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">64</font><font color="#000080">,</font><font color="#800000">127</font><font color="#000080">);
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#008000"><i>{ ;Wait for Key }
    </i></font><font color="#FF00FF">XOR   AX,AX
    INT   16h
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>SetNoteOff<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">64</font><font color="#000080">,</font><font color="#800000">127</font><font color="#000080">);
  </font>ResetGM<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0066.PAS">Original</a><b>]</b></p></body>
</html>
