<html>
<head><title> "General Midi Code" by COLIN BUCKLEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here is the PASCAL version of a portion of the Assembler code I used in my
game to get General Midi sound.  I've compiled the program, and it works fine
on my GM device, MEGA-EM a TSR for the Gravis Ultrasound.

No checking is performed, make sure you have the correct hardware, but
it should run due to the timeout checking.

If you don't get sound, then it's probably because no instrument was
defined.  Send a program change midi sequence.

Feel free to toss this in SWAG.  Sound code is always requested,
and General Midi is so simple compared to everything else.
}
</i></font><font color="#FF0000"><b>Program </b></font>GMTest<font color="#000080">;

</font><font color="#008000"><i>(*
Take from Colin Buckley's cheezy shareware game Tubes, written in BP.
The actual GM code is a converted assembler file, thus the obvious macro
like sequences, register passing, and semi-colon comments.  Sorry for any
typos/bugs introduced during the quick conversion.

This is completely public domain.  Which means no restrictions whatsoever.

{$DEFINE EducateTheMasses}
To the uninformed, you can not say something is public domain, then paste a
copyright on it and say it's required for you to be acknowledged or
get a post card or something.  You give up all rights when you give something
to the public domain.  What you want, is called freeware.
{$ENDIF}
*)

</i></font><font color="#FF0000"><b>Const
  </b></font>GMPort        <font color="#000080">= </font><font color="#800000">$331</font><font color="#000080">;
  </font>Send          <font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">;
  </font>Receive       <font color="#000080">= </font><font color="#800000">$40</font><font color="#000080">;

</font><font color="#008000"><i>{ AL:=Command; }
</i></font><font color="#FF0000"><b>Procedure </b></font>WriteGMCommand<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   DX,GMPort                   </font><font color="#008000"><i>{;DX:=GMStatusPort;                 }
    </i></font><font color="#FF00FF">PUSH  AX                          </font><font color="#008000"><i>{;Save AX                           }
    </i></font><font color="#FF00FF">XOR   AX,AX                       </font><font color="#008000"><i>{;AH:=TimeOutValue;                 }
</i></font><font color="#FF00FF">@@WaitLoop:
    </font><font color="#008000"><i>{ ;Prevent Infinite Loop with Timeout }
    </i></font><font color="#FF00FF">DEC   AH                          </font><font color="#008000"><i>{; |If TimeOutCount=0 then          }
    </i></font><font color="#FF00FF">JZ    @@TimeOut                   </font><font color="#008000"><i>{;/   TimeOut;                      }
    {; Wait until GM is ready }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{; |If Not Ready then               }
    </i></font><font color="#FF00FF">AND   AL,Receive                  </font><font color="#008000"><i>{; |  WaitLoop;                     }
    </i></font><font color="#FF00FF">JNZ   @@WaitLoop                  </font><font color="#008000"><i>{;/                                 }
</i></font><font color="#FF00FF">@@TimeOut:
    POP   AX                          </font><font color="#008000"><i>{;Restore AX                        }

    </i></font><font color="#FF00FF">OUT   DX,AL                       </font><font color="#008000"><i>{;Send Data                         }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ; AL:=Data }
</i></font><font color="#FF0000"><b>Procedure </b></font>WriteGM<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   DX,GMPort                   </font><font color="#008000"><i>{;DX:=GMStatusPort;                 }
    </i></font><font color="#FF00FF">PUSH  AX                          </font><font color="#008000"><i>{;Save AX                           }
    </i></font><font color="#FF00FF">XOR   AX,AX                       </font><font color="#008000"><i>{;AH:=TimeOutValue;                 }
</i></font><font color="#FF00FF">@@WaitLoop:
    </font><font color="#008000"><i>{ ; Prevent Infinite Loop with Timeout }
    </i></font><font color="#FF00FF">DEC   AH                          </font><font color="#008000"><i>{; |If TimeOutCount=0 then          }
    </i></font><font color="#FF00FF">JZ    @@TimeOut                   </font><font color="#008000"><i>{;/   TimeOut;                      }
    { ; Wait until GM is ready }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{; |If Not Ready then               }
    </i></font><font color="#FF00FF">AND   AL,Receive                  </font><font color="#008000"><i>{; |  WaitLoop;                     }
    </i></font><font color="#FF00FF">JNZ   @@WaitLoop                  </font><font color="#008000"><i>{;/                                 }
</i></font><font color="#FF00FF">@@TimeOut:
    POP   AX                          </font><font color="#008000"><i>{;Restore AX                        }

    </i></font><font color="#FF00FF">DEC   DX                          </font><font color="#008000"><i>{;DX:=DataPort                     }
    </i></font><font color="#FF00FF">OUT   DX,AL                       </font><font color="#008000"><i>{;Send Data                        }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ;Returns Data }
</i></font><font color="#FF0000"><b>Function </b></font>ReadGM<font color="#000080">:</font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   DX,GMPort                   </font><font color="#008000"><i>{;DX:=GMStatusPort;                 }
    </i></font><font color="#FF00FF">PUSH  AX                          </font><font color="#008000"><i>{;Save AX                           }
    </i></font><font color="#FF00FF">XOR   AX,AX                       </font><font color="#008000"><i>{;AH:=TimeOutValue;                 }
</i></font><font color="#FF00FF">@@WaitLoop:
    </font><font color="#008000"><i>{ ; Prevent Infinite Loop with Timeout }
    </i></font><font color="#FF00FF">DEC   AH                          </font><font color="#008000"><i>{; |If TimeOutCount=0 then          }
    </i></font><font color="#FF00FF">JZ    @@TimeOut                   </font><font color="#008000"><i>{;/   TimeOut;                      }
    { ; Wait until GM is ready }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{; |If Not Ready then               }
    </i></font><font color="#FF00FF">AND   AL,Send                     </font><font color="#008000"><i>{; |  WaitLoop;                     }
    </i></font><font color="#FF00FF">JNZ   @@WaitLoop                  </font><font color="#008000"><i>{;/                                 }
</i></font><font color="#FF00FF">@@TimeOut:
    POP   AX                          </font><font color="#008000"><i>{;Restore AX                        }

    </i></font><font color="#FF00FF">DEC   DX                          </font><font color="#008000"><i>{;DX:=DataPort                      }
    </i></font><font color="#FF00FF">IN    AL,DX                       </font><font color="#008000"><i>{;Receive Data                      }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ResetGM<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#008000"><i>{ ;Reset GM }
    </i></font><font color="#FF00FF">MOV   DX,GMPort
    MOV   AL,0FFh
    OUT   DX,AL
    </font><font color="#008000"><i>{; Get ACK }
    </i></font><font color="#FF00FF">CALL  ReadGM
    </font><font color="#008000"><i>{; UART Mode }
    </i></font><font color="#FF00FF">MOV   AL,03Fh
    CALL  WriteGMCommand
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetNoteOn<font color="#000080">(</font>Channel<font color="#000080">,</font>Note<font color="#000080">,</font>Volume<font color="#000080">:</font>Byte<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   AL,[Channel]
    ADD   AL,90h
    Call  WriteGM
    MOV   AL,[Note]
    CALL  WriteGM
    MOV   AL,[Volume]
    CALL  WriteGM
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetNoteOff<font color="#000080">(</font>Channel<font color="#000080">,</font>Note<font color="#000080">,</font>Volume<font color="#000080">:</font>Byte<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV   AL,[Channel]
    ADD   AL,80h
    Call  WriteGM
    MOV   AL,[Note]
    CALL  WriteGM
    MOV   AL,[Volume]
    CALL  WriteGM
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ResetGM<font color="#000080">;
  </font>SetNoteOn<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">64</font><font color="#000080">,</font><font color="#800000">127</font><font color="#000080">);
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#008000"><i>{ ;Wait for Key }
    </i></font><font color="#FF00FF">XOR   AX,AX
    INT   16h
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>SetNoteOff<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">64</font><font color="#000080">,</font><font color="#800000">127</font><font color="#000080">);
  </font>ResetGM<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p></body>
</html>
