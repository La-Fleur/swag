<html>
<head><title> "Multiple Sound Channels" by ARNE DE.BRUIJN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0059.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; - trying to produce a 400hz sound in one channel and a 404hz sound in
&gt; another... How difficult will that be for me?  Do I even need to invest
&gt; in a book, or might someone have some code floating around ... *GRiN*

Well, I can help you for the PC Speaker, I've once picked this source up from a
Dutch pascal echo:------------------------------
}

</i></font><font color="#FF0000"><b>Unit </b></font>SoundU<font color="#000080">;
</font><font color="#FF0000"><b>Interface
Uses
 </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DoubleSound<font color="#000080">(</font>Freq1<font color="#000080">,</font>Freq2<font color="#000080">,</font>Duration<font color="#000080">,</font>SampleFrequency<font color="#000080">:</font>Real<font color="#000080">);
</font><font color="#008000"><i>{Play two tones simulatisly: Does sort of:
 Sound(Freq1) + Sound(Freq2)
 Delay(Duration/SampeFrequency*1000)
 NoSound;
}

</i></font><font color="#FF0000"><b>Procedure </b></font>Cli<font color="#000080">;
</font><font color="#008000"><i>{ disable interrupt }
</i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$fa</font><font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>Sti<font color="#000080">;
</font><font color="#008000"><i>{ enable interrupt }
</i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$fb</font><font color="#000080">);

</font><font color="#FF0000"><b>Implementation

Type </b></font><font color="#008000"><i>{ general multitype record for typecasting }
 </i></font>mtype <font color="#000080">= </font><font color="#FF0000"><b>Record
  Case </b></font>Byte <font color="#FF0000"><b>Of
   </b></font><font color="#800000">2</font><font color="#000080">: (</font>o<font color="#000080">,</font>s<font color="#000080">: </font>Word<font color="#000080">);
   </font><font color="#800000">4</font><font color="#000080">: (</font>l<font color="#000080">: </font>LongInt<font color="#000080">);
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Const
 </b></font>Clk8253 <font color="#000080">= </font><font color="#800000">1193180</font><font color="#000080">; </font><font color="#008000"><i>{ Clock input to 8253A-5 timerchip }

</i></font><font color="#FF0000"><b>Var
 </b></font>old_vector<font color="#000080">: </font>Pointer<font color="#000080">; </font><font color="#008000"><i>{ pointer to original interrupt interrupt }
 </i></font>dacptr1<font color="#000080">,</font>dacptr2<font color="#000080">: </font>Word<font color="#000080">;</font><font color="#008000"><i>{ pointer to start of buffer }
 </i></font>step1<font color="#000080">,</font>step2<font color="#000080">: </font>mtype<font color="#000080">; </font><font color="#008000"><i>{ table step value }
 </i></font>Frac1<font color="#000080">,</font>Frac2<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ fractional part of pointer }
 </i></font>OnsShotTable<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{ Table of Timer 2 ReLoad Values }
 </i></font>SineTable<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{ Sine Table }
 </i></font>Timer0Reload<font color="#000080">: </font>Word<font color="#000080">;
 </font>CountDown<font color="#000080">: </font>Word<font color="#000080">;
 </font>factor<font color="#000080">: </font>Real<font color="#000080">;

</font><font color="#008000"><i>{$S-}
</i></font><font color="#FF0000"><b>procedure </b></font>Int8<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">push ax
 push bx
 push cx
 push ds
 mov ax,Seg @Data
 mov ds,ax
 cmp CountDown,0  </font><font color="#008000"><i>{ Timeout ? }
 </i></font><font color="#FF00FF">jz @Exit
 dec CountDown
 mov bx,dacptr1  </font><font color="#008000"><i>{ Get first sample }
 </i></font><font color="#FF00FF">mov ax,step1.o
 add Frac1,ax
 adc bx,step1.s
 mov dacptr1,bx
 and bx,$ff
 mov al,[bx+offset SineTable]
 cbw
 mov cx,ax
 mov bx,dacptr2  </font><font color="#008000"><i>{ Get second sample }
 </i></font><font color="#FF00FF">mov ax,step2.o
 add Frac2,ax
 adc bx,step2.s
 mov dacptr2,bx
 and bx,$ff
 mov al,[BX+Offset SineTable]
 cbw
 add ax,cx   </font><font color="#008000"><i>{ Add samples }
 </i></font><font color="#FF00FF">sar ax,1   </font><font color="#008000"><i>{ Adjust }
 </i></font><font color="#FF00FF">add al,$80   </font><font color="#008000"><i>{ Signed to Absolute }
 </i></font><font color="#FF00FF">mov bx,Offset OnsShotTable </font><font color="#008000"><i>{ Now, lookup Timer 2 Reload value }
 </i></font><font color="#FF00FF">xlat
 out $42,al   </font><font color="#008000"><i>{ Reload timer channel 2 }
</i></font><font color="#FF00FF">@Exit:
 mov al,$20   </font><font color="#008000"><i>{ send End_Of_Interrupt }
 </i></font><font color="#FF00FF">out $20,al
 pop ds
 pop cx
 pop bx
 pop ax
 sti    </font><font color="#008000"><i>{ Position not critical }
 </i></font><font color="#FF00FF">iret
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$S+}

</i></font><font color="#FF0000"><b>Procedure </b></font>DoubleSound<font color="#000080">(</font>Freq1<font color="#000080">,</font>Freq2<font color="#000080">,</font>Duration<font color="#000080">,</font>SampleFrequency<font color="#000080">:</font>Real<font color="#000080">);
</font><font color="#FF0000"><b>Var
 </b></font>I<font color="#000080">:</font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
 </b></font><font color="#008000"><i>{INIT}
 </i></font>Timer0Reload<font color="#000080">:=</font>Round<font color="#000080">(</font>Clk8253<font color="#000080">/</font>SampleFrequency<font color="#000080">);
 </font>SampleFrequency<font color="#000080">:=</font>Round<font color="#000080">(</font>Clk8253<font color="#000080">/</font>Timer0Reload<font color="#000080">);
 </font>factor<font color="#000080">:=</font>Clk8253<font color="#000080">/(</font>SampleFrequency<font color="#000080">*(</font><font color="#800000">256</font><font color="#000080">+</font><font color="#800000">5</font><font color="#000080">));
 </font><font color="#FF0000"><b>For </b></font>I<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>To </b></font><font color="#800000">255 </font><font color="#FF0000"><b>Do </b></font>OnsShotTable<font color="#000080">[</font>I<font color="#000080">]:=</font><font color="#800000">1</font><font color="#000080">+</font>Round<font color="#000080">(</font>I<font color="#000080">*</font>factor<font color="#000080">);
 </font><font color="#FF0000"><b>For </b></font>I<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>To </b></font><font color="#800000">255 </font><font color="#FF0000"><b>Do </b></font>SineTable<font color="#000080">[</font>I<font color="#000080">]:=</font>Byte<font color="#000080">(</font>Round<font color="#000080">(</font>Sin<font color="#000080">((</font><font color="#800000">2</font><font color="#000080">*</font>Pi<font color="#000080">*</font>I<font color="#000080">)/</font><font color="#800000">256</font><font color="#000080">)*</font><font color="#800000">127</font><font color="#000080">));
 </font><font color="#008000"><i>{ Calculate first SineTable Stepvalue }
 </i></font>step1<font color="#000080">.</font>l<font color="#000080">:=</font>Round<font color="#000080">(</font><font color="#800000">65536.0</font><font color="#000080">*</font>freq1<font color="#000080">*</font><font color="#800000">256.0</font><font color="#000080">/</font>SampleFrequency<font color="#000080">);
 </font>dacptr1<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font>Frac1<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font><font color="#008000"><i>{ Calculate second SineTable Stepvalue }
 </i></font>step2<font color="#000080">.</font>l<font color="#000080">:=</font>Round<font color="#000080">(</font><font color="#800000">65536.0</font><font color="#000080">*</font>freq2<font color="#000080">*</font><font color="#800000">256.0</font><font color="#000080">/</font>SampleFrequency<font color="#000080">);
 </font>dacptr2<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font>Frac2<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font><font color="#008000"><i>{ Calculate Timeout value }
 </i></font>CountDown<font color="#000080">:=</font>Round<font color="#000080">(</font>SampleFrequency<font color="#000080">*</font>duration<font color="#000080">);
 </font><font color="#008000"><i>{ OK, time to enable our int8 procedure }
 </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,</font>old_vector<font color="#000080">);
 </font>cli<font color="#000080">;
 </font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,@</font>Int8<font color="#000080">);
 </font><font color="#008000"><i>{ initialize 8253 timer-chip }
 { 8255 PPI, Enable Speaker, Speaker input Gate = output from 8253 channel 2 }
 </i></font>port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">]:=</font>port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] </font><font color="#FF0000"><b>Or </b></font><font color="#800000">$03</font><font color="#000080">;
 </font>port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">]:=</font><font color="#800000">$90</font><font color="#000080">; </font><font color="#008000"><i>{ Channel 2, Read/Write only LSB, Mode 0=OneShot, Binary }
 { Set Interrupt 8 frequency (samplefrequency) }
 </i></font>port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">]:=</font><font color="#800000">$36</font><font color="#000080">; </font><font color="#008000"><i>{ Channel 0, Read/Write LSB then MSB, Mode 3=SqrW, Binary }
 </i></font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">]:=</font>Lo<font color="#000080">(</font>Timer0Reload<font color="#000080">); </font><font color="#008000"><i>{ LSB }
 </i></font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">]:=</font>Hi<font color="#000080">(</font>Timer0Reload<font color="#000080">); </font><font color="#008000"><i>{ MSB }
 </i></font>sti<font color="#000080">; </font><font color="#008000"><i>{ Start PC Speak'ing }
 </i></font><font color="#FF0000"><b>Repeat
  </b></font><font color="#008000"><i>{ BEEP'ING }
 </i></font><font color="#FF0000"><b>Until </b></font>CountDown<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
 </font>cli<font color="#000080">;
 </font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,</font>old_vector<font color="#000080">); </font><font color="#008000"><i>{ restore original int8 vector }
 </i></font>port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">]:=</font><font color="#800000">$36</font><font color="#000080">;
 </font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">]:=</font><font color="#800000">$00</font><font color="#000080">;
 </font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">]:=</font><font color="#800000">$00</font><font color="#000080">;
 </font>sti<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ output_sound }

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0059.PAS">Original</a><b>]</b></p></body>
</html>
