<html>
<head><title> "Programming the PC-SPEAKER" by MARK FELDMAN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0107.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000000">                     <font color="#000080">+----------------------------+
                     | </font>Programming the PC Speaker <font color="#000080">|
                     +----------------------------+

            </font>Written <font color="#FF0000"><b>for </b></font>the PC<font color="#000080">-</font>GPE by Mark Feldman
            e<font color="#000080">-</font>mail address <font color="#000080">: </font>u914097<font color="#000080">@</font>student<font color="#000080">.</font>canberra<font color="#000080">.</font>edu<font color="#000080">.</font>au
                             myndale<font color="#000080">@</font>cairo<font color="#000080">.</font>anu<font color="#000080">.</font>edu<font color="#000080">.</font>au

              <font color="#000080">+-------------------------------------------+
              |      </font>THIS <font color="#FF0000"><b>FILE </b></font>MAY <font color="#FF0000"><b>NOT </b></font>BE DISTRIBUTED     <font color="#000080">|
              | </font>SEPARATE <font color="#FF0000"><b>TO </b></font>THE ENTIRE PC<font color="#000080">-</font>GPE COLLECTION<font color="#000080">. |
              +-------------------------------------------+


+------------+---------------------------------------------------------------
| </font>Disclaimer <font color="#000080">|
+------------+

</font>I assume no responsibility whatsoever <font color="#FF0000"><b>for </b></font>any effect that this <font color="#FF0000"><b>file</b></font><font color="#000080">, </font>the
information contained therein <font color="#FF0000"><b>or </b></font>the use thereof has <font color="#FF0000"><b>on </b></font>you<font color="#000080">, </font>your sanity<font color="#000080">,
</font>computer<font color="#000080">, </font>spouse<font color="#000080">, </font>children<font color="#000080">, </font>pets <font color="#FF0000"><b>or </b></font>anything <font color="#FF0000"><b>else </b></font>related <font color="#FF0000"><b>to </b></font>you <font color="#FF0000"><b>or </b></font>your
existance<font color="#000080">. </font>No warranty <font color="#FF0000"><b>is </b></font>provided nor implied <font color="#FF0000"><b>with </b></font>this information<font color="#000080">.

+------------------------+---------------------------------------------------
| </font>Basic Programming Info <font color="#000080">|
+------------------------+

</font>The PC speaker has two states<font color="#000080">, </font><font color="#FF0000"><b>in and out </b></font><font color="#000080">(</font><font color="#800000">0 </font><font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">, </font><font color="#FF0000"><b>on and </b></font>off<font color="#000080">, </font>Adam <font color="#FF0000"><b>and
</b></font>Eve etc<font color="#000080">). </font>You can directly <font color="#FF0000"><b>set </b></font>the state <font color="#FF0000"><b>of </b></font>the PC speaker <font color="#FF0000"><b>or </b></font>you can hook
the speaker up <font color="#FF0000"><b>to </b></font>the output <font color="#FF0000"><b>of </b></font>PIT timer <font color="#800000">2 </font><font color="#FF0000"><b>to </b></font>get various effects<font color="#000080">.

</font>Port <font color="#800000">61</font>h controls how the speaker will operate <font color="#FF0000"><b>as </b></font>follows<font color="#000080">:

</font>Bit <font color="#800000">0    </font>Effect
<font color="#000080">-----------------------------------------------------------------
  </font><font color="#800000">0      </font>The state <font color="#FF0000"><b>of </b></font>the speaker will follow bit <font color="#800000">1 </font><font color="#FF0000"><b>of </b></font>port <font color="#800000">61</font>h
  <font color="#800000">1      </font>The speaker will be connected <font color="#FF0000"><b>to </b></font>PIT channel <font color="#800000">2</font><font color="#000080">, </font>bit <font color="#800000">1 </font><font color="#FF0000"><b>is
         </b></font>used <font color="#FF0000"><b>as </b></font>switch ie <font color="#800000">0 </font><font color="#000080">= </font><font color="#FF0000"><b>not </b></font>connected<font color="#000080">, </font><font color="#800000">1 </font><font color="#000080">= </font>connected<font color="#000080">.

</font>Playing around <font color="#FF0000"><b>with </b></font>the bits <font color="#FF0000"><b>in </b></font>port <font color="#800000">61</font>h can prevent the Borland BC<font color="#000080">++ </font><font color="#FF0000"><b>and
Pascal </b></font>sound<font color="#000080">() </font>procedures from working properly<font color="#000080">. </font>When you are done using the
speaker make sure you <font color="#FF0000"><b>set </b></font>bit<font color="#800000">'s 0 and 1 of port 61h to 0.

</font><font color="#000080">+-----------------+----------------------------------------------------------
| </font>Your First Tone <font color="#000080">|
+-----------------+

</font>Ok<font color="#000080">, </font>so lets generate a simple tone<font color="#000080">. </font>We<font color="#800000">'ll send a string of 0'</font>s <font color="#FF0000"><b>and </b></font><font color="#800000">1's to the
</font>PC speaker <font color="#FF0000"><b>to </b></font>generate a square wave<font color="#000080">. </font>Here<font color="#800000">'s the Pascal routine:


</font><font color="#FF0000"><b>Uses </b></font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>SPEAKER_PORT <font color="#000080">= </font><font color="#800000">$61</font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>portval <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin

  </b></font>portval <font color="#000080">:= </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$FC</font><font color="#000080">;

  </font><font color="#FF0000"><b>while not </b></font>KeyPressed <font color="#FF0000"><b>do
    begin
      </b></font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] := </font>portval <font color="#FF0000"><b>or </b></font><font color="#800000">2</font><font color="#000080">;
      </font>Delay<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
      </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] := </font>portval<font color="#000080">;
      </font>Delay<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ReadKey<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#FF0000"><b>On </b></font>my <font color="#800000">486</font>SX33 this generates a tone <font color="#FF0000"><b>of </b></font>around about <font color="#800000">100</font>Hz<font color="#000080">.

</font>First this routine grabs the value from the speaker port<font color="#000080">, </font>sets the lower two
bits <font color="#FF0000"><b>to </b></font><font color="#800000">0 </font><font color="#FF0000"><b>and </b></font>stores it<font color="#000080">. </font>The loop first sets the speaker <font color="#FF0000"><b>to </b></font><font color="#000080">&quot;</font><font color="#FF0000"><b>on</b></font><font color="#000080">&quot;, </font>waits a
short <font color="#FF0000"><b>while</b></font><font color="#000080">, </font>sets it <font color="#FF0000"><b>to </b></font><font color="#000080">&quot;</font>off<font color="#000080">&quot; </font><font color="#FF0000"><b>and </b></font>waits another short <font color="#FF0000"><b>while</b></font><font color="#000080">. </font>I write the loop
<font color="#FF0000"><b>to do </b></font>it <font color="#FF0000"><b>in </b></font>this order so that when a key <font color="#FF0000"><b>is </b></font>pressed <font color="#FF0000"><b>and </b></font>the <font color="#FF0000"><b>program </b></font>exits
the loop the lower two bits <font color="#FF0000"><b>in </b></font>the speaker port will both be <font color="#800000">0 </font>so it won<font color="#800000">'t
</font>prevent other programs which <font color="#FF0000"><b>then </b></font>use the speaker from working properly<font color="#000080">.

</font>This <font color="#FF0000"><b>is </b></font>a really bad way <font color="#FF0000"><b>of </b></font>generating a tone<font color="#000080">. </font><font color="#FF0000"><b>While </b></font>the <font color="#FF0000"><b>program is </b></font>running
interrupts are continually occurring <font color="#FF0000"><b>in </b></font>the PC <font color="#FF0000"><b>and </b></font>this prevents the timing
from being accurate<font color="#000080">. </font><font color="#FF0000"><b>Try </b></font>running the <font color="#FF0000"><b>program and </b></font>moving the mouse around<font color="#000080">.
</font>You can get a nicer tone by disabling interrupts first<font color="#000080">, </font>but this would
prevent the KeyPressed <font color="#FF0000"><b>function </b></font>from working<font color="#000080">. </font><font color="#FF0000"><b>In </b></font>any <font color="#FF0000"><b>case </b></font>we want <font color="#FF0000"><b>to
</b></font>generate a nice tone <font color="#FF0000"><b>of </b></font>a given frequency<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>using the Delay <font color="#FF0000"><b>procedure
</b></font>doesn<font color="#800000">'t really allow us to do this. To top it all off, this procedure uses
</font>all <font color="#FF0000"><b>of </b></font>the CPU<font color="#800000">'s time so we can'</font>t <font color="#FF0000"><b>do </b></font>anything <font color="#FF0000"><b>in </b></font>the background <font color="#FF0000"><b>while </b></font>the
tone <font color="#FF0000"><b>is </b></font>playing<font color="#000080">.


+---------------------+------------------------------------------------------
| </font>Using PIT Channel <font color="#800000">2 </font><font color="#000080">|
+---------------------+

</font>Connecting the PC speaker <font color="#FF0000"><b>to </b></font>PIT channel <font color="#800000">2 </font><font color="#FF0000"><b>is </b></font>simply a matter <font color="#FF0000"><b>of </b></font>programming
the channel <font color="#FF0000"><b>to </b></font>generate a square wave <font color="#FF0000"><b>of </b></font>a given frequency <font color="#FF0000"><b>and then </b></font>setting
the lower two bits <font color="#FF0000"><b>in </b></font>the speaker port <font color="#FF0000"><b>to </b></font>a <font color="#800000">1. </font>Detailed information <font color="#FF0000"><b>on
</b></font>programming the PIT chip can be found <font color="#FF0000"><b>in </b></font>the <font color="#FF0000"><b>file </b></font>PIT<font color="#000080">.</font>TXT<font color="#000080">, </font>but here <font color="#FF0000"><b>is
</b></font>the <font color="#FF0000"><b>pascal </b></font>source you<font color="#800000">'ll need to do the job:

</font><font color="#FF0000"><b>const </b></font>SPEAKER_PORT <font color="#000080">= </font><font color="#800000">$61</font><font color="#000080">;
       </font>PIT_CONTROL <font color="#000080">= </font><font color="#800000">$43</font><font color="#000080">;
     </font>PIT_CHANNEL_2 <font color="#000080">= </font><font color="#800000">$42</font><font color="#000080">;
          </font>PIT_FREQ <font color="#000080">= </font><font color="#800000">$1234DD</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Sound<font color="#000080">(</font>frequency <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>counter <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin

  </b></font><font color="#008000"><i>{ Program the PIT chip }
  </i></font>counter <font color="#000080">:= </font>PIT_FREQ <font color="#FF0000"><b>div </b></font>frequency<font color="#000080">;
  </font>Port<font color="#000080">[</font>PIT_CONTROL<font color="#000080">] := </font><font color="#800000">$B6</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIT_CHANNEL_2<font color="#000080">] := </font>Lo<font color="#000080">(</font>counter<font color="#000080">);
  </font>Port<font color="#000080">[</font>PIT_CHANNEL_2<font color="#000080">] := </font>Hi<font color="#000080">(</font>counter<font color="#000080">);

  </font><font color="#008000"><i>{ Connect the speaker to the PIT }
  </i></font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] := </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">3</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>NoSound<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] := </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$FC</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


+--------------------------------------------+-------------------------------
| </font>Playing <font color="#800000">8</font><font color="#000080">-</font>bit Sound Through the PC Speaker <font color="#000080">|
+--------------------------------------------+

</font>Terminolgy
<font color="#000080">----------

</font><font color="#FF0000"><b>To </b></font>clear up any confusion<font color="#000080">, </font>here<font color="#800000">'s my own definition of some words I'</font>ll be
using <font color="#FF0000"><b>in </b></font>this section<font color="#000080">:

</font>sample <font color="#000080">: </font>A single value <font color="#FF0000"><b>in </b></font>the range <font color="#800000">0</font><font color="#000080">-</font><font color="#800000">255 </font>representing the input level <font color="#FF0000"><b>of
         </b></font>the microphone at any given moment<font color="#000080">.

</font>volume <font color="#000080">: </font>A sort <font color="#FF0000"><b>of </b></font>generic version <font color="#FF0000"><b>of </b></font>sample<font color="#000080">, </font><font color="#FF0000"><b>not </b></font>limited <font color="#FF0000"><b>to </b></font>the <font color="#800000">0</font><font color="#000080">-</font><font color="#800000">255 </font>range<font color="#000080">.

  </font>song <font color="#000080">: </font>A bunch <font color="#FF0000"><b>of </b></font>samples <font color="#FF0000"><b>in </b></font>a row representing a continuous sound<font color="#000080">.

</font><font color="#FF0000"><b>string </b></font><font color="#000080">: </font>A bunch <font color="#FF0000"><b>of </b></font>binary values <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>in </b></font>a row<font color="#000080">.



</font>Programs like the legendary <font color="#000080">&quot;</font>Magic Mushroom<font color="#000080">&quot; </font>demo <font color="#FF0000"><b>do </b></font>a handly little trick
<font color="#FF0000"><b>to </b></font>play <font color="#800000">8</font><font color="#000080">-</font>bit sound from the PC speaker by sending binary strings <font color="#FF0000"><b>to </b></font>the
PC speaker <font color="#FF0000"><b>for </b></font>every sample they play<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>the bits are all <font color="#800000">0's, then the
</font>speaker will be <font color="#000080">&quot;</font>off<font color="#000080">&quot;. </font><font color="#FF0000"><b>If </b></font>they are all <font color="#800000">1's the speaker will be &quot;on&quot;. If they
</font>alternate <font color="#800000">0's and 1'</font>s <font color="#FF0000"><b>then </b></font>the speaker will behave <font color="#FF0000"><b>as if </b></font>it<font color="#800000">'s &quot;half&quot; on, and
</font>so forth<font color="#000080">.

                +-----------------------------------+
                | </font>Bit <font color="#FF0000"><b>string     </b></font>Time speaker <font color="#FF0000"><b>is on </b></font><font color="#000080">|
                +-----------------------------------+
                | </font><font color="#800000">11111111              100</font><font color="#000080">%        |
                | </font><font color="#800000">11101110               75</font><font color="#000080">%        |
                | </font><font color="#800000">10101010               50</font><font color="#000080">%        |
                | </font><font color="#800000">10001000               25</font><font color="#000080">%        |
                | </font><font color="#800000">00000000                0</font><font color="#000080">%        |
                +-----------------------------------+

</font>Note that <font color="#FF0000"><b>in </b></font>this table I<font color="#800000">'ve used strings which are 8 bits long meaning that
</font>there can only be <font color="#800000">9 </font>discrete volume levels <font color="#000080">(</font>since anywhere from <font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">8 </font><font color="#FF0000"><b>of
</b></font>them can be <font color="#FF0000"><b>set to </b></font><font color="#800000">1</font><font color="#000080">). </font><font color="#FF0000"><b>In </b></font>reality the strings would be longer<font color="#000080">.

</font>The problem <font color="#FF0000"><b>with </b></font>using bit strings such <font color="#FF0000"><b>as </b></font>this <font color="#FF0000"><b>is </b></font>getting accurate timing
between each bit you send<font color="#000080">. </font>One way around this <font color="#FF0000"><b>is to </b></font>put all the <font color="#800000">1's at the
</font>front <font color="#FF0000"><b>of </b></font>the <font color="#FF0000"><b>string and </b></font>all the <font color="#800000">0's at the end, like so:

                </font><font color="#000080">+-----------------------------------+
                | </font>Bit <font color="#FF0000"><b>string     </b></font>Time speaker <font color="#FF0000"><b>is on </b></font><font color="#000080">|
                +-----------------------------------+
                | </font><font color="#800000">11111111              100</font><font color="#000080">%        |
                | </font><font color="#800000">11111100               75</font><font color="#000080">%        |
                | </font><font color="#800000">11110000               50</font><font color="#000080">%        |
                | </font><font color="#800000">11000000               25</font><font color="#000080">%        |
                | </font><font color="#800000">00000000                0</font><font color="#000080">%        |
                +-----------------------------------+

</font>This way you can send all the <font color="#800000">1's as a single pulse and your timing doesn'</font>t
have <font color="#FF0000"><b>to </b></font>be quite <font color="#FF0000"><b>as </b></font>accurate<font color="#000080">. </font>The sound isn<font color="#800000">'t quite as good, but I'</font>ve found
it <font color="#FF0000"><b>to </b></font>be pretty reasonable<font color="#000080">. </font>A real advantage <font color="#FF0000"><b>in </b></font>using this method <font color="#FF0000"><b>is </b></font>that
you can <font color="#FF0000"><b>program </b></font>the PIT chip <font color="#FF0000"><b>for </b></font><font color="#000080">&quot;</font>interrupt <font color="#FF0000"><b>on </b></font>terminal count<font color="#000080">&quot; </font>mode<font color="#000080">, </font>this
mode <font color="#FF0000"><b>is </b></font>similar <font color="#FF0000"><b>to </b></font>the one<font color="#000080">-</font>shot mode<font color="#000080">, </font>but counting starts <font color="#FF0000"><b>as </b></font>soon <font color="#FF0000"><b>as </b></font>you
load the PIT counter<font color="#000080">. </font>So <font color="#FF0000"><b>if </b></font>you are playing an <font color="#800000">11</font>kHz song you simply load the
PIT counter <font color="#800000">11000 </font>times a second <font color="#FF0000"><b>with </b></font>a value that<font color="#800000">'s proportional to the
</font>sample value <font color="#FF0000"><b>and </b></font>trigger it<font color="#000080">. </font>The speaker output will go low <font color="#FF0000"><b>for </b></font>the <font color="#FF0000"><b>set </b></font>time
<font color="#FF0000"><b>and then </b></font>remain high <font color="#FF0000"><b>until </b></font>the next time you trigger it <font color="#000080">(</font><font color="#FF0000"><b>in </b></font>practise it
doesn<font color="#800000">'t matter whether the string of 1'</font>s make the speaker go <font color="#000080">&quot;</font>low<font color="#000080">&quot; </font><font color="#FF0000"><b>or
</b></font><font color="#000080">&quot;</font>high<font color="#000080">&quot;, </font>just so long <font color="#FF0000"><b>as </b></font>it<font color="#800000">'s consistent). I'</font>ve managed <font color="#FF0000"><b>to </b></font>get good results
using PIT channel <font color="#800000">2 </font><font color="#FF0000"><b>to </b></font>handle the one<font color="#000080">-</font>shot <font color="#FF0000"><b>for </b></font>each sample <font color="#FF0000"><b>and </b></font>PIT channel <font color="#800000">0
</font><font color="#FF0000"><b>to </b></font>handle when <font color="#FF0000"><b>to </b></font>trigger channel <font color="#800000">2 </font><font color="#000080">(</font>ie <font color="#800000">11000 </font>times a second<font color="#000080">). *</font>PLUS<font color="#000080">* </font>I was
able <font color="#FF0000"><b>to </b></font>have a <font color="#FF0000"><b>program </b></font>drawing stuff <font color="#FF0000"><b>on </b></font>the screen <font color="#FF0000"><b>while </b></font>all this was going
<font color="#FF0000"><b>on in </b></font>the background<font color="#000080">!

</font>Incidently I should mention here that the <font color="#000080">&quot;</font>interrupt <font color="#FF0000"><b>on </b></font>terminal count<font color="#000080">&quot; </font>mode
does <font color="#FF0000"><b>not </b></font>generate an actual interrupt <font color="#FF0000"><b>on </b></font>the Intel CPU<font color="#000080">. </font>The mode was given
this name since the PIT can can be hooked up <font color="#FF0000"><b>to </b></font>a CPU <font color="#FF0000"><b>to </b></font>generate an
interrupt<font color="#000080">. </font><font color="#FF0000"><b>As far as </b></font>I can tell IBM didn<font color="#800000">'t do it like this.

</font>This technique does have one nasty side<font color="#000080">-</font>effect though<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>you are playing an
<font color="#800000">11</font>kHz tone <font color="#FF0000"><b>for </b></font>example <font color="#FF0000"><b>then </b></font>the PC speaker will be being turned <font color="#FF0000"><b>on and </b></font>off
exactly <font color="#800000">11000 </font>times a second<font color="#000080">, </font><font color="#FF0000"><b>in </b></font>other words you<font color="#800000">'ll hear a nice 11kHz sine
</font>wave superimposed over the song <font color="#000080">(</font><font color="#FF0000"><b>do </b></font>any <font color="#FF0000"><b>of </b></font>you math weirdo<font color="#800000">'s want to do
</font>a FFT <font color="#FF0000"><b>to </b></font>prove this <font color="#FF0000"><b>for </b></font>me<font color="#000080">?). </font>A way around this <font color="#FF0000"><b>is to </b></font>play the song back
at <font color="#800000">22</font>kHz <font color="#FF0000"><b>and </b></font>play each sample twice<font color="#000080">. </font>This will result <font color="#FF0000"><b>in </b></font>a <font color="#800000">22</font>kHz sine wave
which will pretty much be filtered <font color="#FF0000"><b>out </b></font>by the tiny PC speaker <font color="#FF0000"><b>and </b></font>the simple
low<font color="#000080">-</font>pass filter circuit that it<font color="#800000">'s usually connected to on the motherboard.

</font>The PIT chip runs at a frequency <font color="#FF0000"><b>of </b></font><font color="#800000">1193181 </font>Hz <font color="#000080">(</font><font color="#800000">1234</font>DDh<font color="#000080">). </font><font color="#FF0000"><b>If </b></font>you are playing
an <font color="#800000">11</font>kHz song at <font color="#800000">22</font>kHz <font color="#FF0000"><b>then </b></font><font color="#800000">1193181 </font><font color="#000080">/ </font><font color="#800000">22000 </font><font color="#000080">= </font><font color="#800000">54 </font>clocks per second<font color="#000080">, </font>so
you<font color="#800000">'ll have to program the PIT to count a maximum of 54 clocks for each
</font>sample<font color="#000080">. </font>What I<font color="#800000">'m getting at is that you'</font>ll only be able <font color="#FF0000"><b>to </b></font>play <font color="#800000">54 </font>discreet
sample levels using this method<font color="#000080">, </font>so you<font color="#800000">'ll have to scale the 256 different
</font>levels <font color="#FF0000"><b>in </b></font>an <font color="#800000">8</font><font color="#000080">-</font>bit song <font color="#FF0000"><b>to </b></font>fit into this range which will also result <font color="#FF0000"><b>in
</b></font>futher loss <font color="#FF0000"><b>of </b></font>sound quality<font color="#000080">. </font>I sped things up considerably by pre<font color="#000080">-
</font>calculating a lookup table like so<font color="#000080">:

</font><font color="#FF0000"><b>var </b></font>count_values <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;

</font><font color="#FF0000"><b>for </b></font>level <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
  </b></font>count_values<font color="#000080">[</font>level<font color="#000080">] := </font>level <font color="#000080">* </font><font color="#800000">54 </font><font color="#FF0000"><b>div </b></font><font color="#800000">255</font><font color="#000080">;

</font><font color="#FF0000"><b>Then for </b></font>each sample I just look up what it<font color="#800000">'s counter value is and send
</font>that <font color="#FF0000"><b>to </b></font>the PIT chip<font color="#000080">. </font>Since each value <font color="#FF0000"><b>is of </b></font>byte size you can <font color="#FF0000"><b>program </b></font>the
PIT chip <font color="#FF0000"><b>to </b></font>accept the LSB only <font color="#000080">(</font>see PIT<font color="#000080">.</font>TXT <font color="#FF0000"><b>for </b></font>more info<font color="#000080">). </font>The following
<font color="#FF0000"><b>pascal </b></font>code will <font color="#FF0000"><b>set </b></font>the PIT chip up <font color="#FF0000"><b>for </b></font><font color="#000080">&quot;</font>interrupt <font color="#FF0000"><b>on </b></font>terminal count<font color="#000080">&quot; </font>mode
where only the LSB <font color="#FF0000"><b>of </b></font>the count needs <font color="#FF0000"><b>to </b></font>be loaded<font color="#000080">:

</font>Port<font color="#000080">[</font>PIT_CONTROL<font color="#000080">] := </font><font color="#800000">$90</font><font color="#000080">;
</font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] := </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">3</font><font color="#000080">;

</font><font color="#FF0000"><b>And </b></font>the following line will trigger the one<font color="#000080">-</font>shot <font color="#FF0000"><b>for </b></font>a given sample value
from <font color="#800000">0</font><font color="#000080">-</font><font color="#800000">255</font><font color="#000080">:

</font>Port<font color="#000080">[</font>PIT_CHANNEL_2<font color="#000080">] := </font>count_values<font color="#000080">[</font>sample_value<font color="#000080">];

</font><font color="#FF0000"><b>Do </b></font>that <font color="#800000">22000 </font>times a second <font color="#FF0000"><b>and </b></font>whaddaya know<font color="#000080">, </font>you<font color="#800000">'ll hear &quot;8-bit&quot; sound
</font>from your PC speaker<font color="#000080">! </font>Here<font color="#800000">'s a bit of code which works ok on my machine:


</font><font color="#000080">----------------------------------------------------------------------------

</font><font color="#FF0000"><b>const </b></font>SPEAKER_PORT <font color="#000080">= </font><font color="#800000">$61</font><font color="#000080">;
       </font>PIT_CONTROL <font color="#000080">= </font><font color="#800000">$43</font><font color="#000080">;
     </font>PIT_CHANNEL_2 <font color="#000080">= </font><font color="#800000">$42</font><font color="#000080">;
          </font>PIT_FREQ <font color="#000080">= </font><font color="#800000">$1234DD</font><font color="#000080">;

     </font>DELAY_LENGTH <font color="#000080">= </font><font color="#800000">100</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>PlaySound<font color="#000080">(</font>sound <font color="#000080">: </font>PChar<font color="#000080">; </font>length <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>count_values <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>i<font color="#000080">, </font>loop <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin

  </b></font><font color="#008000"><i>{ Set up the count table }
  </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
    </b></font>count_values<font color="#000080">[</font>i<font color="#000080">] := </font>i <font color="#000080">* </font><font color="#800000">54 </font><font color="#FF0000"><b>div </b></font><font color="#800000">255</font><font color="#000080">;

  </font><font color="#008000"><i>{ Set up the PIT and connect the speaker to it }
  </i></font>Port<font color="#000080">[</font>PIT_CONTROL<font color="#000080">] := </font><font color="#800000">$90</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] := </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">3</font><font color="#000080">;

  </font><font color="#008000"><i>{ Play the sound }

  </i></font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>length <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do
    begin
      </b></font>Port<font color="#000080">[</font>PIT_CHANNEL_2<font color="#000080">] := </font>count_values<font color="#000080">[</font>byte<font color="#000080">(</font>sound<font color="#000080">^)];
      </font><font color="#FF0000"><b>for </b></font>loop <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>DELAY_LENGTH <font color="#FF0000"><b>do</b></font><font color="#000080">;
      </font>Port<font color="#000080">[</font>PIT_CHANNEL_2<font color="#000080">] := </font>count_values<font color="#000080">[</font>byte<font color="#000080">(</font>sound<font color="#000080">^)];
      </font><font color="#FF0000"><b>for </b></font>loop <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>DELAY_LENGTH <font color="#FF0000"><b>do</b></font><font color="#000080">;
      </font>sound <font color="#000080">:= </font>sound <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Reprogram the speaker for normal operation }
  </i></font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] := </font>Port<font color="#000080">[</font>SPEAKER_PORT<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$FC</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIT_CONTROL<font color="#000080">] := </font><font color="#800000">$B6</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

----------------------------------------------------------------------------


</font>Note that <font color="#FF0000"><b>in </b></font>this simple example I used a loop <font color="#FF0000"><b>of </b></font>DELAY_LENGTH <font color="#FF0000"><b>to </b></font>get the
timing between samples<font color="#000080">. </font>I had <font color="#FF0000"><b>to </b></font>fiddle around <font color="#FF0000"><b>to </b></font>get the right value <font color="#FF0000"><b>for </b></font>my
machine <font color="#FF0000"><b>and </b></font>it varies from machine <font color="#FF0000"><b>to </b></font>machine<font color="#000080">. </font>I also disable interrupts
<font color="#FF0000"><b>while </b></font>the inner loop <font color="#FF0000"><b>is </b></font>playing<font color="#000080">, </font>otherwise you hear the <font color="#800000">18.2</font>Hz timer tick
<font color="#FF0000"><b>while </b></font>the sound was playing<font color="#000080">.


</font>Both <font color="#FF0000"><b>of </b></font>these techniques suffer from two drawbacks<font color="#000080">. </font>The first <font color="#FF0000"><b>is </b></font>that
samples played from the speaker <font color="#FF0000"><b>do not </b></font>sound very loud<font color="#000080">. </font>You can make them
louder by making the song you are playing louder<font color="#000080">, </font>but this eventually means
the sample values will start falling outside the <font color="#800000">0</font><font color="#000080">-</font><font color="#800000">255 </font>range <font color="#FF0000"><b>and </b></font>you<font color="#800000">'ll have
</font><font color="#FF0000"><b>to </b></font>clip them which starts distorting the sound<font color="#000080">. </font>The second problem <font color="#FF0000"><b>is </b></font>that
this technique doesn<font color="#800000">'t work on the psezio-electric &quot;speakers&quot; inside lap-top
</font>computers<font color="#000080">.


&lt;/</font>PRE<font color="#000080">&gt;
&lt;</font>P<font color="#000080">&gt;&lt;</font>P<font color="#000080">&gt;&lt;</font>A HREF<font color="#000080">=&quot;</font>index<font color="#000080">.</font>html<font color="#000080">&quot;&gt;&lt;</font>IMG SRC<font color="#000080">=&quot;</font>contents<font color="#000080">.</font>gif<font color="#000080">&quot;&gt;&lt;/</font>A<font color="#000080">&gt;
&lt;/</font>BODY<font color="#000080">&gt;
&lt;/</font>HTML<font color="#000080">&gt;</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0107.PAS">Original</a><b>]</b></p></body>
</html>
