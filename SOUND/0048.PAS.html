<html>
<head><title> "FM Synth Code" by RODNEY JOHNSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
  I got FM-synth code for the PAS (originally for the SB).  Here it is:
}
</i></font><font color="#FF0000"><b>Program </b></font>fmtest<font color="#000080">;
</font><font color="#FF0000"><b>uses
  </b></font>sbfm<font color="#000080">, </font>crt<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>instrument<font color="#000080">: </font>TFMInstrument <font color="#000080">= (</font>SoundCharacteristic<font color="#000080">: (</font><font color="#800000">$11</font><font color="#000080">, </font><font color="#800000">$1</font><font color="#000080">);
                               </font>Level<font color="#000080">: (</font><font color="#800000">$8A</font><font color="#000080">, </font><font color="#800000">$40</font><font color="#000080">);
                               </font>AttackDecay<font color="#000080">: (</font><font color="#800000">$F0</font><font color="#000080">, </font><font color="#800000">$F0</font><font color="#000080">);
                               </font>SustainRelease<font color="#000080">: (</font><font color="#800000">$FF</font><font color="#000080">, </font><font color="#800000">$B3</font><font color="#000080">);
                               </font>WaveSelect<font color="#000080">: (</font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">);
                               </font>FeedBack<font color="#000080">: </font><font color="#800000">$00</font><font color="#000080">;
                               </font>Filler<font color="#000080">: (</font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">));
  </font>notes<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">12</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer <font color="#000080">= (</font><font color="#800000">$157</font><font color="#000080">, </font><font color="#800000">$16B</font><font color="#000080">, </font><font color="#800000">$181</font><font color="#000080">, </font><font color="#800000">$198</font><font color="#000080">, </font><font color="#800000">$1B0</font><font color="#000080">, </font><font color="#800000">$1C1</font><font color="#000080">, </font><font color="#800000">$1E5</font><font color="#000080">,
        </font><font color="#800000">$202</font><font color="#000080">, </font><font color="#800000">$220</font><font color="#000080">, </font><font color="#800000">$241</font><font color="#000080">, </font><font color="#800000">$263</font><font color="#000080">, </font><font color="#800000">$287</font><font color="#000080">, </font><font color="#800000">$2AE</font><font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>SbFMReset<font color="#000080">;
  </font>SbFMSetVoice<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,@</font>instrument<font color="#000080">);
  </font>SbFMSetVoice<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,@</font>instrument<font color="#000080">);
  </font>SbFMSetVoice<font color="#000080">(</font><font color="#800000">11</font><font color="#000080">,@</font>instrument<font color="#000080">);
  </font>SbFMSetVoice<font color="#000080">(</font><font color="#800000">12</font><font color="#000080">,@</font>instrument<font color="#000080">);

  </font>SbFMKeyOn<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>notes<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">],</font><font color="#800000">2</font><font color="#000080">);
  </font>delay<font color="#000080">(</font><font color="#800000">250</font><font color="#000080">);
  </font>SbFMKeyOn<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>notes<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">],</font><font color="#800000">3</font><font color="#000080">);
  </font>delay<font color="#000080">(</font><font color="#800000">250</font><font color="#000080">);
  </font>SbFMKeyOn<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>notes<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">],</font><font color="#800000">3</font><font color="#000080">);
  </font>delay<font color="#000080">(</font><font color="#800000">250</font><font color="#000080">);
  </font>SbFMKeyOn<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>notes<font color="#000080">[</font><font color="#800000">12</font><font color="#000080">],</font><font color="#800000">3</font><font color="#000080">);
  </font>delay<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">);

  </font>sbFMKeyOff<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font>sbFMKeyOff<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>sbFMKeyOff<font color="#000080">(</font><font color="#800000">11</font><font color="#000080">);
  </font>sbFMKeyOff<font color="#000080">(</font><font color="#800000">12</font><font color="#000080">);
  </font>sbFMReset<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#FF0000"><b>Unit </b></font>SbFM<font color="#000080">;
</font><font color="#FF0000"><b>interface
type
  </b></font>PFMInstrument <font color="#000080">= ^</font>TFMInstrument<font color="#000080">;
  </font>TFMInstrument <font color="#000080">= </font><font color="#FF0000"><b>record
                    </b></font>SoundCharacteristic<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                    </font>Level<font color="#000080">:              </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                    </font>AttackDecay<font color="#000080">:        </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                    </font>SustainRelease<font color="#000080">:     </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                    </font>WaveSelect<font color="#000080">:         </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                    </font>Feedback<font color="#000080">:           </font>byte<font color="#000080">;
                    </font>filler<font color="#000080">:             </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">5</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>SbIOAddr<font color="#000080">=</font><font color="#800000">$220</font><font color="#000080">;
  </font>LeftFmAddress<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
  </font>RightFmAddress<font color="#000080">=</font><font color="#800000">2</font><font color="#000080">;
  </font>FMADDRESS<font color="#000080">=</font><font color="#800000">$08</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>addr<font color="#000080">, </font>data<font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>SbFmReset<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SbFMKeyOff<font color="#000080">(</font>voice<font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>SbFMKeyOn<font color="#000080">(</font>voice<font color="#000080">, </font>freq<font color="#000080">, </font>octave<font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>SbFMVoiceVolume<font color="#000080">(</font>voice<font color="#000080">, </font>vol<font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>sbFMSetVoice<font color="#000080">(</font>voicenum<font color="#000080">: </font>integer<font color="#000080">; </font>Ins<font color="#000080">: </font>PFMInstrument<font color="#000080">);
</font><font color="#FF0000"><b>implementation
Procedure </b></font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>addr<font color="#000080">, </font>data<font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>ChipAddr<font color="#000080">:                                </font>integer<font color="#000080">;
  </font>t<font color="#000080">:                                        </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>chip<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>chipaddr<font color="#000080">:=</font>SbIOAddr <font color="#000080">+ </font>RightFMAddress <font color="#FF0000"><b>else
               </b></font>chipaddr<font color="#000080">:=</font>sbIOAddr <font color="#000080">+ </font>LeftFMAddress<font color="#000080">;
  </font>chipaddr<font color="#000080">:=</font>SbIOAddr <font color="#000080">+ </font>FMAddress<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push dx
    push ax
    push cx
    mov dx,chipaddr
    mov al,addr
    out dx,al
    in al,dx
    inc dx
    mov al,data
    out dx,al
    dec dx
    mov cx,4
@L:
    in al,dx
    loop @L
    pop cx
    pop ax
    pop dx
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SbFmReset<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>WriteFM<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SbFMKeyOff<font color="#000080">(</font>voice<font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>regnum<font color="#000080">:                                </font>byte<font color="#000080">;
  </font>chip<font color="#000080">:                                        </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>chip<font color="#000080">:=</font>voice <font color="#FF0000"><b>div </b></font><font color="#800000">11</font><font color="#000080">;
  </font>regnum<font color="#000080">:=</font><font color="#800000">$B0 </font><font color="#000080">+ (</font>voice <font color="#FF0000"><b>mod </b></font><font color="#800000">11</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>regnum<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SbFMKeyOn<font color="#000080">(</font>voice<font color="#000080">, </font>freq<font color="#000080">, </font>octave<font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>regnum<font color="#000080">, </font>t<font color="#000080">:                                </font>byte<font color="#000080">;
  </font>chip<font color="#000080">:                                        </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>chip<font color="#000080">:=</font>voice <font color="#FF0000"><b>div </b></font><font color="#800000">11</font><font color="#000080">;
  </font>regnum<font color="#000080">:=</font><font color="#800000">$A0 </font><font color="#000080">+ (</font>voice <font color="#FF0000"><b>mod </b></font><font color="#800000">11</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>regnum<font color="#000080">, </font>freq <font color="#FF0000"><b>and </b></font><font color="#800000">$FF</font><font color="#000080">);
  </font>regnum<font color="#000080">:=</font><font color="#800000">$B0 </font><font color="#000080">+ (</font>voice <font color="#FF0000"><b>mod </b></font><font color="#800000">11</font><font color="#000080">);
  </font>t<font color="#000080">:=(</font>freq <font color="#FF0000"><b>shr </b></font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>octave <font color="#FF0000"><b>shl </b></font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#800000">$20</font><font color="#000080">;
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>regnum<font color="#000080">, </font>t<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SbFMVoiceVolume<font color="#000080">(</font>voice<font color="#000080">, </font>vol<font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>regnum<font color="#000080">:                                </font>byte<font color="#000080">;
  </font>chip<font color="#000080">:                                        </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>chip<font color="#000080">:=</font>voice <font color="#FF0000"><b>div </b></font><font color="#800000">11</font><font color="#000080">;
  </font>regnum<font color="#000080">:=</font><font color="#800000">$40 </font><font color="#000080">+ (</font>voice <font color="#FF0000"><b>mod </b></font><font color="#800000">11</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>regnum<font color="#000080">, </font>vol<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>sbFMSetVoice<font color="#000080">(</font>voicenum<font color="#000080">: </font>integer<font color="#000080">; </font>Ins<font color="#000080">: </font>PFMInstrument<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>opcellnum<font color="#000080">:                                </font>byte<font color="#000080">;
  </font>celloffset<font color="#000080">, </font>i<font color="#000080">, </font>chip<font color="#000080">:                        </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>chip<font color="#000080">:=</font>voicenum <font color="#FF0000"><b>div </b></font><font color="#800000">11</font><font color="#000080">;
  </font>voicenum<font color="#000080">:=</font>voicenum <font color="#FF0000"><b>mod </b></font><font color="#800000">11</font><font color="#000080">;
  </font>celloffset<font color="#000080">:=(</font>voicenum <font color="#FF0000"><b>mod </b></font><font color="#800000">3</font><font color="#000080">) + ((</font>voicenum <font color="#FF0000"><b>div </b></font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">3</font><font color="#000080">);
  </font>opcellnum<font color="#000080">:=</font><font color="#800000">$20 </font><font color="#000080">+ </font>celloffset<font color="#000080">;
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>SoundCharacteristic<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
  </font>inc<font color="#000080">(</font>opcellnum<font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>SoundCharacteristic<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
  </font>opcellnum<font color="#000080">:=</font><font color="#800000">$40 </font><font color="#000080">+ </font>celloffset<font color="#000080">;
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>level<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
  </font>inc<font color="#000080">(</font>opcellnum<font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>Level<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
  </font>opcellnum<font color="#000080">:=</font><font color="#800000">$60 </font><font color="#000080">+ </font>celloffset<font color="#000080">;
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>AttackDecay<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
  </font>inc<font color="#000080">(</font>opcellnum<font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>AttackDecay<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
  </font>opcellnum<font color="#000080">:=</font><font color="#800000">$80 </font><font color="#000080">+ </font>celloffset<font color="#000080">;
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>SustainRelease<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
  </font>inc<font color="#000080">(</font>opcellnum<font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>SustainRelease<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
  </font>opcellnum<font color="#000080">:=</font><font color="#800000">$E0 </font><font color="#000080">+ </font>celloffset<font color="#000080">;
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>WaveSelect<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
  </font>inc<font color="#000080">(</font>opcellnum<font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>WaveSelect<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
  </font>opcellnum<font color="#000080">:=</font><font color="#800000">$C0 </font><font color="#000080">+ </font>voicenum<font color="#000080">;
  </font>WriteFM<font color="#000080">(</font>chip<font color="#000080">, </font>opcellnum<font color="#000080">, </font>ins<font color="#000080">^.</font>feedback<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
Message 1 is FMTEST.PAS
Messages 2+3 are SBFM.PAS
That's all.  One thing: if you can make this work with more than two
voices at a time, I'd be interested in improved code.  I think that this
code uses the AdLib compatibility, which is by no means impressive :-).
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p></body>
</html>
