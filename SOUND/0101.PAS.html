<html>
<head><title> "Soundblaster-pro driver (BP7)" by MENNO VICTOR VAN DER STAR</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0101.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Unit </b></font>Audio<font color="#000080">;
</font><font color="#008000"><i>{----------------------------------------------------------------------------}
{  Audio : An implementation of a Soundblaster-pro driver (BP 7.0). The      }
{          Soundblaster-Pro object features record and playback using DMA    }
{          so your CPU can do something else while sound is being played     }
{          or recorded. Both Real and Protected Mode are supported.          }
{          This code has only been tested on a Soundblaster-Pro clone with   }
{          BasePort=$220, Irq=7 and DMAchannel=1.                            }
{          Do what ever you like with this code, but use it at your own      }
{          risk!!!!!                                                         }
{          Comments and/or bug fixes are welcome at the e-mail address below }
{****************************************************************************}
{  Author            : Menno Victor van der star                             }
{  E-mail            : s795238@dutiwy.twi.tudelft.nl                         }
{  Developed on      : 08-02-'95                                             }
{  Last update on    : 13-06-'95                                             }
{  Status            : Working, but only tested on a SB-pro clone with       }
{                      Baseport=$220, Irq=7 and DMAChannel=1                 }
{  Future extensions : - Direct input/output filter for playing .WAV/.VOC's  }
{                      - Extensive testing (Feedback appreciated :)          }
{----------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>Interface

</b></font><font color="#008000"><i>{$IFDEF DPMI} </i></font><font color="#FF0000"><b>Uses </b></font>WinAPI<font color="#000080">; </font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>Const
</b></font><font color="#008000"><i>{-- Constants for soundblaster-pro object --}

  </i></font>Stereo <font color="#000080">= </font>True<font color="#000080">;         </font><font color="#008000"><i>{ Stereo/Mono constants }
  </i></font>Mono   <font color="#000080">= </font>False<font color="#000080">;

  </font>Master     <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;        </font><font color="#008000"><i>{ Volume/Input devices }
  </i></font>Microphone <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>CDAudio    <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
  </font>LineIn     <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;
  </font>Voice      <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;
  </font>FM         <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">;

  </font>Left         <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;      </font><font color="#008000"><i>{ Indications for left, right or both channels }
  </i></font>Right        <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>LeftAndRight <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;

  </font>HighPass <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;          </font><font color="#008000"><i>{ Bandpass filter constants }
  </i></font>LowPass  <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>PSoundBlasterPro <font color="#000080">= ^</font>SoundBlasterPro<font color="#000080">;
  </font>SoundBlasterPro <font color="#000080">= </font><font color="#FF0000"><b>Object

                      Constructor </b></font>Init <font color="#000080">(</font>Port<font color="#000080">, </font>IRQ<font color="#000080">, </font>DMA <font color="#000080">: </font>Word<font color="#000080">);
                      </font><font color="#FF0000"><b>Destructor  </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;

                      </font><font color="#008000"><i>{ The following 4 virtual procedures have to be redefined via inheritance :
                        - OutBuffer : Write 'Size' recorded bytes from 'Buffer'
                        - InBuffer : Read 'Size' bytes to be played back from 'Buffer'
                        - RecordingReady : This procedure is called after the recording is done
                        - PlaybackReady : This procedure is called after the sound has been played }

                      </i></font><font color="#FF0000"><b>Procedure   </b></font>OutBuffer <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Buffer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure   </b></font>InBuffer  <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Buffer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure   </b></font>RecordingReady<font color="#000080">; </font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure   </b></font>PlaybackReady<font color="#000080">; </font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;

                      </font><font color="#FF0000"><b>Function    </b></font>Reset <font color="#000080">: </font>Boolean<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure   </b></font>PlaySample   <font color="#000080">(</font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Length <font color="#000080">: </font>LongInt<font color="#000080">);
                      </font><font color="#FF0000"><b>Procedure   </b></font>RecordSample <font color="#000080">(</font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Length <font color="#000080">: </font>LongInt<font color="#000080">);

                      </font><font color="#FF0000"><b>Procedure   </b></font>SetStereoIn<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure   </b></font>SetMonoIn<font color="#000080">;
                      </font><font color="#FF0000"><b>Function    </b></font>InputMode <font color="#000080">: </font>Boolean<font color="#000080">;

                      </font><font color="#FF0000"><b>Procedure   </b></font>SetVolume <font color="#000080">(</font>VolumeType<font color="#000080">, </font>Channel<font color="#000080">, </font>Volume <font color="#000080">: </font>Byte<font color="#000080">);
                      </font><font color="#FF0000"><b>Function    </b></font>GetVolume <font color="#000080">(</font>VolumeType<font color="#000080">, </font>Channel <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure   </b></font>SetInput <font color="#000080">(</font>InputDevice<font color="#000080">, </font>Filter <font color="#000080">: </font>Byte<font color="#000080">; </font>FilterOn <font color="#000080">: </font>Boolean<font color="#000080">);
                      </font><font color="#FF0000"><b>Procedure   </b></font>GetInput <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>InputDevice<font color="#000080">, </font>Filter <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>FilterOn <font color="#000080">: </font>Boolean<font color="#000080">);
                      </font><font color="#FF0000"><b>Procedure   </b></font>SetOutput <font color="#000080">(</font>StereoOut<font color="#000080">, </font>FilterOutput <font color="#000080">: </font>Boolean<font color="#000080">);
                      </font><font color="#FF0000"><b>Procedure   </b></font>GetOutput <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>StereoOut<font color="#000080">, </font>FilterOutput <font color="#000080">: </font>Boolean<font color="#000080">);

                      </font><font color="#FF0000"><b>Procedure   </b></font>HandleRecordIrq<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure   </b></font>HandlePlaybackIrq<font color="#000080">;

                    </font><font color="#FF0000"><b>Private

                      </b></font>DMAChannel<font color="#000080">, </font>IrqVector<font color="#000080">, </font>IrqIntVector<font color="#000080">, </font>SBPort<font color="#000080">, </font>PICPort<font color="#000080">,
                      </font>ResetPort<font color="#000080">, </font>ReadPort<font color="#000080">, </font>WritePort<font color="#000080">, </font>PollPort<font color="#000080">, </font>MixerIndexPort<font color="#000080">,
                      </font>MixerWritePort <font color="#000080">: </font>Word<font color="#000080">;
                      </font>OldIntVector<font color="#000080">, </font>DMABuffer1<font color="#000080">, </font>DMABuffer2<font color="#000080">, </font>SoundBuffer1<font color="#000080">, </font>SoundBuffer2 <font color="#000080">: </font>Pointer<font color="#000080">;
                      </font>IRQStopMask<font color="#000080">, </font>IRQStartMask<font color="#000080">, </font>DMAStartMask<font color="#000080">, </font>DMAStopMask<font color="#000080">,
                      </font>DMAModeReg <font color="#000080">: </font>Byte<font color="#000080">;

                      </font>StereoMode <font color="#000080">: </font>Boolean<font color="#000080">;
                      </font>CurrentPlay<font color="#000080">, </font>CurrentRecord <font color="#000080">: </font>Pointer<font color="#000080">;
                      </font>PlayLength<font color="#000080">, </font>RecordLength <font color="#000080">: </font>LongInt<font color="#000080">;
                      </font>RecSampleSize<font color="#000080">, </font>RecSampleRate<font color="#000080">, </font>PlaySampleRate<font color="#000080">, </font>PlaySampleSize <font color="#000080">: </font>Word<font color="#000080">;

                      </font><font color="#FF0000"><b>Procedure </b></font>WriteMixer <font color="#000080">(</font>Index<font color="#000080">, </font>Value <font color="#000080">: </font>Byte<font color="#000080">);
                      </font><font color="#FF0000"><b>Function  </b></font>ReadMixer <font color="#000080">(</font>Index <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure </b></font>WriteDSP <font color="#000080">(</font>Value <font color="#000080">: </font>Byte<font color="#000080">);
                      </font><font color="#FF0000"><b>Function  </b></font>ReadDSP <font color="#000080">: </font>Byte<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure </b></font>PlayBuffer <font color="#000080">(</font>Buffer <font color="#000080">: </font>Pointer<font color="#000080">; </font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
                      </font><font color="#FF0000"><b>Procedure </b></font>RecBuffer  <font color="#000080">(</font>Buffer <font color="#000080">: </font>Pointer<font color="#000080">; </font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
                      </font><font color="#FF0000"><b>Procedure </b></font>EnableInterrupts<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure </b></font>DisableInterrupts<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure </b></font>DisableIrq<font color="#000080">;
                      </font><font color="#FF0000"><b>Procedure </b></font>EnableIrq<font color="#000080">;

                    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Uses </b></font>Crt<font color="#000080">, </font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>Module_ID <font color="#000080">= </font><font color="#800000">'AUDIO'</font><font color="#000080">;
  </font>SBPro <font color="#000080">: </font>PSoundBlasterPro <font color="#000080">= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;         </font><font color="#008000"><i>{ Pointer to current soundblaster-pro object }

</i></font><font color="#FF0000"><b>Procedure </b></font>RecordIRQ<font color="#000080">; </font>Interrupt<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Dummy <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Dummy<font color="#000080">:=</font>Port <font color="#000080">[</font><font color="#800000">$22E</font><font color="#000080">];        </font><font color="#008000"><i>{ Maybe the value $22E should be replaced with the appropriate value }
                             { if a port other than $220 is used (I can't remember (anyone?)) }
  </i></font><font color="#FF0000"><b>If </b></font>Assigned <font color="#000080">(</font>SBPro<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>SBPro<font color="#000080">^.</font>HandleRecordIrq<font color="#000080">;
  </font>Port <font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>PlayIRQ<font color="#000080">; </font>Interrupt<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Dummy <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Dummy<font color="#000080">:=</font>Port <font color="#000080">[</font><font color="#800000">$22E</font><font color="#000080">];        </font><font color="#008000"><i>{ Maybe the value $22E should be replaced with the appropriate value }
                             { if a port other than $220 is used (I can't remember (anyone?)) }
  </i></font><font color="#FF0000"><b>If </b></font>Assigned <font color="#000080">(</font>SBPro<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>SBPro<font color="#000080">^.</font>HandlePlaybackIrq<font color="#000080">;
  </font>Port <font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Constructor </b></font>SoundBlasterPro<font color="#000080">.</font>Init <font color="#000080">(</font>Port<font color="#000080">, </font>IRQ<font color="#000080">, </font>DMA <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Const
  </b></font>IrqIntNums <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte <font color="#000080">= (</font><font color="#800000">$08</font><font color="#000080">, </font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$0C</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$0E</font><font color="#000080">, </font><font color="#800000">$0F</font><font color="#000080">,
                                        </font><font color="#800000">$70</font><font color="#000080">, </font><font color="#800000">$71</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$73</font><font color="#000080">, </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$75</font><font color="#000080">, </font><font color="#800000">$76</font><font color="#000080">, </font><font color="#800000">$77</font><font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>l <font color="#000080">: </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>Assigned <font color="#000080">(</font>SBPro<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Fail<font color="#000080">;     </font><font color="#008000"><i>{ Only one instance of the object is allowed at one time }

  </i></font>DMAChannel<font color="#000080">:=</font>DMA<font color="#000080">;
  </font>IrqVector<font color="#000080">:=</font>IRQ<font color="#000080">;
  </font>SBPort<font color="#000080">:=</font>Port<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>IrqVector<font color="#000080">&lt;=</font><font color="#800000">7 </font><font color="#FF0000"><b>then </b></font>PICPort<font color="#000080">:=</font><font color="#800000">$21 </font><font color="#FF0000"><b>Else </b></font>PICPort <font color="#000080">:= </font><font color="#800000">$A1</font><font color="#000080">;
  </font>IrqIntVector<font color="#000080">:=</font>IrqIntNums<font color="#000080">[</font>IrqVector<font color="#000080">];
  </font>IrqStopMask<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>SHL </b></font><font color="#000080">(</font>IrqVector <font color="#FF0000"><b>mod </b></font><font color="#800000">8</font><font color="#000080">);
  </font>IrqStartMask<font color="#000080">:=</font><font color="#FF0000"><b>Not </b></font>IrqStopMask<font color="#000080">;
  </font>GetIntVec <font color="#000080">(</font>IRQIntVector<font color="#000080">, </font>OldIntVector<font color="#000080">);

  </font><font color="#008000"><i>{$IFDEF DPMI}

    { This code looks a bit silly but I haven't had to time to clean it up }

    </i></font>DMABuffer1<font color="#000080">:=</font>Pointer <font color="#000080">(</font>GlobalDosAlloc <font color="#000080">(</font><font color="#800000">32768</font><font color="#000080">));
    </font>DMABuffer2<font color="#000080">:=</font>Pointer <font color="#000080">(</font>GlobalDosAlloc <font color="#000080">(</font><font color="#800000">32768</font><font color="#000080">));
    </font>LongInt <font color="#000080">(</font>DMABuffer1<font color="#000080">):=(</font>LongInt <font color="#000080">(</font>DMABuffer1<font color="#000080">) </font><font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">16</font><font color="#000080">;
    </font>LongInt <font color="#000080">(</font>DMABuffer2<font color="#000080">):=(</font>LongInt <font color="#000080">(</font>DMABuffer2<font color="#000080">) </font><font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">16</font><font color="#000080">;

    </font>SoundBuffer1<font color="#000080">:=</font>Pointer <font color="#000080">(</font>AllocSelector <font color="#000080">(</font>LongInt <font color="#000080">(</font>DMABuffer1<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">));
    </font>LongInt <font color="#000080">(</font>SoundBuffer1<font color="#000080">):=</font>LongInt <font color="#000080">(</font>SoundBuffer1<font color="#000080">) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">16</font><font color="#000080">;
    </font>SoundBuffer2<font color="#000080">:=</font>Pointer <font color="#000080">(</font>AllocSelector <font color="#000080">(</font>LongInt <font color="#000080">(</font>DMABuffer2<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">));
    </font>LongInt <font color="#000080">(</font>SoundBuffer2<font color="#000080">):=</font>LongInt <font color="#000080">(</font>SoundBuffer2<font color="#000080">) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">16</font><font color="#000080">;

    </font>l<font color="#000080">:=</font>GetSelectorBase <font color="#000080">(</font>LongInt <font color="#000080">(</font>SoundBuffer1<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">&gt;</font><font color="#800000">49152 </font><font color="#FF0000"><b>then Begin
      While </b></font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Do </b></font>Inc <font color="#000080">(</font>l<font color="#000080">);
      </font>SetSelectorBase <font color="#000080">(</font>LongInt <font color="#000080">(</font>SoundBuffer1<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">,</font>l<font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

    </font>l<font color="#000080">:=</font>GetSelectorBase <font color="#000080">(</font>LongInt <font color="#000080">(</font>SoundBuffer2<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">&gt;</font><font color="#800000">49152 </font><font color="#FF0000"><b>then Begin
      While </b></font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Do </b></font>Inc <font color="#000080">(</font>l<font color="#000080">);
      </font>SetSelectorBase <font color="#000080">(</font>LongInt <font color="#000080">(</font>SoundBuffer2<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">,</font>l<font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#008000"><i>{$ELSE}
    </i></font>DMABuffer1<font color="#000080">:=</font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
    </font>DMABuffer2<font color="#000080">:=</font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
    </font>GetMem <font color="#000080">(</font>DMABuffer1<font color="#000080">,</font><font color="#800000">32768</font><font color="#000080">);
    </font>GetMem <font color="#000080">(</font>DMABuffer2<font color="#000080">,</font><font color="#800000">32768</font><font color="#000080">);
    </font><font color="#FF0000"><b>If Not </b></font>Assigned <font color="#000080">(</font>DMABuffer1<font color="#000080">) </font><font color="#FF0000"><b>Or Not </b></font>Assigned <font color="#000080">(</font>DMABuffer2<font color="#000080">) </font><font color="#FF0000"><b>then Begin </b></font>Done<font color="#000080">; </font>Fail<font color="#000080">; </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font>l<font color="#000080">:=</font>Seg <font color="#000080">(</font>DMABuffer1<font color="#000080">^); </font>l<font color="#000080">:=</font>l<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">; </font>l<font color="#000080">:=</font>l<font color="#000080">+</font>Ofs <font color="#000080">(</font>DMABuffer1<font color="#000080">^);
    </font><font color="#FF0000"><b>If </b></font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">&lt;=</font><font color="#800000">49152 </font><font color="#FF0000"><b>then </b></font>SoundBuffer1<font color="#000080">:=</font>DMABuffer1 <font color="#FF0000"><b>Else </b></font>SoundBuffer1<font color="#000080">:=</font>Ptr <font color="#000080">(((</font>l <font color="#FF0000"><b>DIV </b></font><font color="#800000">65536</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">4096</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
    </font>l<font color="#000080">:=</font>Seg <font color="#000080">(</font>DMABuffer2<font color="#000080">^); </font>l<font color="#000080">:=</font>l<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">; </font>l<font color="#000080">:=</font>l<font color="#000080">+</font>Ofs <font color="#000080">(</font>DMABuffer2<font color="#000080">^);
    </font><font color="#FF0000"><b>If </b></font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">&lt;=</font><font color="#800000">49152 </font><font color="#FF0000"><b>then </b></font>SoundBuffer2<font color="#000080">:=</font>DMABuffer2 <font color="#FF0000"><b>Else </b></font>SoundBuffer2<font color="#000080">:=</font>Ptr <font color="#000080">(((</font>l <font color="#FF0000"><b>DIV </b></font><font color="#800000">65536</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">4096</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#008000"><i>{$ENDIF}

  </i></font>ResetPort<font color="#000080">:=</font>SBPort<font color="#000080">+</font><font color="#800000">$6</font><font color="#000080">;
  </font>ReadPort<font color="#000080">:=</font>SBPort<font color="#000080">+</font><font color="#800000">$A</font><font color="#000080">;
  </font>WritePort<font color="#000080">:=</font>SBPort<font color="#000080">+</font><font color="#800000">$C</font><font color="#000080">;
  </font>PollPort<font color="#000080">:=</font>SBPort<font color="#000080">+</font><font color="#800000">$E</font><font color="#000080">;
  </font>MixerIndexPort<font color="#000080">:=</font>SBPort<font color="#000080">+</font><font color="#800000">$4</font><font color="#000080">;
  </font>MixerWritePort<font color="#000080">:=</font>SBPort<font color="#000080">+</font><font color="#800000">$5</font><font color="#000080">;

  </font>DMAStartMask<font color="#000080">:=</font>DMAChannel<font color="#000080">+</font><font color="#800000">$00</font><font color="#000080">;
  </font>DMAStopMask<font color="#000080">:=</font>DMAChannel<font color="#000080">+</font><font color="#800000">$04</font><font color="#000080">;
  </font>DMAModeReg<font color="#000080">:=</font>DMAChannel<font color="#000080">+</font><font color="#800000">$48</font><font color="#000080">;

  </font><font color="#FF0000"><b>If Not </b></font>Reset <font color="#FF0000"><b>then Begin </b></font>Done<font color="#000080">; </font>Fail<font color="#000080">; </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>SetStereoIn<font color="#000080">;
  </font>SetVolume <font color="#000080">(</font>Master<font color="#000080">,</font>LeftAndRight<font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
  </font>SetVolume <font color="#000080">(</font>Voice<font color="#000080">,</font>LeftAndRight<font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
  </font>SetVolume <font color="#000080">(</font>FM<font color="#000080">,</font>LeftAndRight<font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
  </font>SetVolume <font color="#000080">(</font>Microphone<font color="#000080">,</font>Right<font color="#000080">,</font><font color="#800000">7</font><font color="#000080">);
  </font>SetVolume <font color="#000080">(</font>CDAudio<font color="#000080">,</font>LeftAndRight<font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
  </font>SetVolume <font color="#000080">(</font>LineIn<font color="#000080">,</font>LeftAndRight<font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
  </font>SetInput <font color="#000080">(</font>LineIn<font color="#000080">,</font>LowPass<font color="#000080">,</font>True<font color="#000080">);
  </font>SetOutput <font color="#000080">(</font>Stereo<font color="#000080">,</font>True<font color="#000080">);
  </font>SBPro<font color="#000080">:=@</font>SELF<font color="#000080">;

  </font>DisableIrq<font color="#000080">;
  </font>SetIntVec <font color="#000080">(</font>IRQIntVector<font color="#000080">, @</font>PlayIrq<font color="#000080">);
  </font>EnableIrq<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Destructor </b></font>SoundBlasterPro<font color="#000080">.</font>Done<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>SetIntVec <font color="#000080">(</font>IRQIntVector<font color="#000080">,</font>OldIntVector<font color="#000080">);
  </font><font color="#008000"><i>{$IFDEF DPMI}
    </i></font>GlobalDosFree <font color="#000080">(</font>LongInt <font color="#000080">(</font>DMABuffer1<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
    </font>GlobalDosFree <font color="#000080">(</font>LongInt <font color="#000080">(</font>DMABuffer2<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
    </font>FreeSelector <font color="#000080">(</font>LongInt <font color="#000080">(</font>SoundBuffer1<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
    </font>FreeSelector <font color="#000080">(</font>LongInt <font color="#000080">(</font>SoundBuffer2<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
  </font><font color="#008000"><i>{$ELSE}
    </i></font><font color="#FF0000"><b>If </b></font>Assigned <font color="#000080">(</font>DMABuffer1<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>FreeMem <font color="#000080">(</font>DMABuffer1<font color="#000080">,</font><font color="#800000">32768</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>Assigned <font color="#000080">(</font>DMABuffer2<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>FreeMem <font color="#000080">(</font>DMABuffer2<font color="#000080">,</font><font color="#800000">32768</font><font color="#000080">);
  </font><font color="#008000"><i>{$ENDIF}
  </i></font>SBPro<font color="#000080">:=</font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>OutBuffer <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Buffer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Begin
  </b></font>RunError <font color="#000080">(</font><font color="#800000">211</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>InBuffer  <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Buffer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Begin
  </b></font>RunError <font color="#000080">(</font><font color="#800000">211</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>RecordingReady<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>RunError <font color="#000080">(</font><font color="#800000">211</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>PlaybackReady<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>RunError <font color="#000080">(</font><font color="#800000">211</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SoundBlasterPro<font color="#000080">.</font>Reset <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>i <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Port<font color="#000080">[</font>ResetPort<font color="#000080">]:=</font><font color="#800000">1</font><font color="#000080">;
  </font>Delay <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>ResetPort<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
  </font>i<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>ReadDSP<font color="#000080">&lt;&gt;</font><font color="#800000">$AA</font><font color="#000080">) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>i<font color="#000080">&lt;</font><font color="#800000">100</font><font color="#000080">) </font><font color="#FF0000"><b>Do </b></font>Inc <font color="#000080">(</font>i<font color="#000080">);
  </font>Reset<font color="#000080">:=</font>i<font color="#000080">&lt;</font><font color="#800000">100</font><font color="#000080">;
  </font>WriteMixer <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>PlaySample <font color="#000080">(</font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Length <font color="#000080">: </font>LongInt<font color="#000080">);

</font><font color="#FF0000"><b>Begin
  </b></font>PlayLength<font color="#000080">:=</font>Length<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>PlayLength <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then Begin
    </b></font>DisableIrq<font color="#000080">;
    </font>SetIntVec <font color="#000080">(</font>IRQIntVector<font color="#000080">, @</font>PlayIrq<font color="#000080">);
    </font>EnableIrq<font color="#000080">;
    </font>CurrentPlay<font color="#000080">:=</font>SoundBuffer1<font color="#000080">;
    </font>PlaySampleRate<font color="#000080">:=</font>SampleRate<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>PlayLength <font color="#000080">&gt;= </font><font color="#800000">16384 </font><font color="#FF0000"><b>then </b></font>PlaySampleSize<font color="#000080">:=</font><font color="#800000">16384 </font><font color="#FF0000"><b>Else </b></font>PlaySampleSize<font color="#000080">:=</font>PlayLength<font color="#000080">;
    </font>Dec <font color="#000080">(</font>PlayLength<font color="#000080">,</font>PlaySampleSize<font color="#000080">);
    </font>InBuffer <font color="#000080">(</font>CurrentPlay<font color="#000080">^,</font>PlaySampleSize<font color="#000080">);
    </font>PlayBuffer <font color="#000080">(</font>CurrentPlay<font color="#000080">,</font>SampleRate<font color="#000080">,</font>PlaySampleSize<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>PlayLength <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then Begin
      If </b></font>PlayLength <font color="#000080">&gt;= </font><font color="#800000">16384 </font><font color="#FF0000"><b>then </b></font>PlaySampleSize<font color="#000080">:=</font><font color="#800000">16384 </font><font color="#FF0000"><b>Else </b></font>PlaySampleSize<font color="#000080">:=</font>PlayLength<font color="#000080">;
      </font>Dec <font color="#000080">(</font>PlayLength<font color="#000080">,</font>PlaySampleSize<font color="#000080">);
      </font>InBuffer <font color="#000080">(</font>SoundBuffer2<font color="#000080">^,</font>PlaySampleSize<font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>RecordSample <font color="#000080">(</font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Length <font color="#000080">: </font>LongInt<font color="#000080">);

</font><font color="#FF0000"><b>Begin
  </b></font>RecordLength<font color="#000080">:=</font>Length<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>RecordLength <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then Begin
    </b></font>DisableIrq<font color="#000080">;
    </font>SetIntVec <font color="#000080">(</font>IRQIntVector<font color="#000080">, @</font>RecordIrq<font color="#000080">);
    </font>EnableIrq<font color="#000080">;
    </font>CurrentRecord<font color="#000080">:=</font>SoundBuffer1<font color="#000080">;
    </font>RecSampleRate<font color="#000080">:=</font>SampleRate<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>RecordLength <font color="#000080">&gt;= </font><font color="#800000">16384 </font><font color="#FF0000"><b>then </b></font>RecSampleSize<font color="#000080">:=</font><font color="#800000">16384 </font><font color="#FF0000"><b>Else </b></font>RecSampleSize<font color="#000080">:=</font>RecordLength<font color="#000080">;
    </font>Dec <font color="#000080">(</font>RecordLength<font color="#000080">,</font>RecSampleSize<font color="#000080">);
    </font>RecBuffer <font color="#000080">(</font>CurrentRecord<font color="#000080">,</font>RecSampleRate<font color="#000080">,</font>RecSampleSize<font color="#000080">);
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>SetStereoIn<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>WriteDSP <font color="#000080">(</font><font color="#800000">$A8</font><font color="#000080">);
  </font>StereoMode<font color="#000080">:=</font>Stereo<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>SetMonoIn<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>WriteDSP <font color="#000080">(</font><font color="#800000">$A0</font><font color="#000080">);
  </font>StereoMode<font color="#000080">:=</font>Mono<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SoundBlasterPro<font color="#000080">.</font>InputMode <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>InputMode<font color="#000080">:=</font>StereoMode<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>WriteMixer <font color="#000080">(</font>Index<font color="#000080">, </font>Value <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>Begin
  </b></font>Port <font color="#000080">[</font>MixerIndexPort<font color="#000080">]:=</font>Index<font color="#000080">;
  </font>Port <font color="#000080">[</font>MixerWritePort<font color="#000080">]:=</font>Value<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SoundBlasterPro<font color="#000080">.</font>ReadMixer <font color="#000080">(</font>Index <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Port <font color="#000080">[</font>MixerIndexPort<font color="#000080">]:=</font>Index<font color="#000080">;
  </font>ReadMixer<font color="#000080">:=</font>Port <font color="#000080">[</font>MixerWritePort<font color="#000080">];
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>SetVolume <font color="#000080">(</font>VolumeType<font color="#000080">, </font>Channel<font color="#000080">, </font>Volume <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>IndexReg <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>VolumeType<font color="#000080">&lt;&gt;</font>Microphone <font color="#FF0000"><b>then Begin
    Case </b></font>Channel <font color="#FF0000"><b>Of
      </b></font>Left         <font color="#000080">: </font>Volume<font color="#000080">:=</font>Volume <font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">;
      </font>LeftAndRight <font color="#000080">: </font>Volume<font color="#000080">:=</font>Volume <font color="#FF0000"><b>Or </b></font><font color="#000080">(</font>Volume <font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Case </b></font>VolumeType <font color="#FF0000"><b>Of
    </b></font>Master     <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$22</font><font color="#000080">;
    </font>Voice      <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$4</font><font color="#000080">;
    </font>FM         <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$26</font><font color="#000080">;
    </font>Microphone <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$0A</font><font color="#000080">;
    </font>CDAudio    <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$28</font><font color="#000080">;
    </font>LineIn     <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$2E</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>WriteMixer <font color="#000080">(</font>IndexReg<font color="#000080">,</font>Volume<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SoundBlasterPro<font color="#000080">.</font>GetVolume <font color="#000080">(</font>VolumeType<font color="#000080">, </font>Channel <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>IndexReg<font color="#000080">, </font>Volume <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  Case </b></font>VolumeType <font color="#FF0000"><b>Of
    </b></font>Master     <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$22</font><font color="#000080">;
    </font>Voice      <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$4</font><font color="#000080">;
    </font>FM         <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$26</font><font color="#000080">;
    </font>Microphone <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$0A</font><font color="#000080">;
    </font>CDAudio    <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$28</font><font color="#000080">;
    </font>LineIn     <font color="#000080">: </font>IndexReg<font color="#000080">:=</font><font color="#800000">$2E</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>Volume<font color="#000080">:=</font>ReadMixer <font color="#000080">(</font>IndexReg<font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>VolumeType<font color="#000080">&lt;&gt;</font>Microphone<font color="#000080">) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>Channel<font color="#000080">=</font>Left<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Volume<font color="#000080">:=</font>Volume <font color="#FF0000"><b>SHR </b></font><font color="#800000">4</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>VolumeType<font color="#000080">=</font>Microphone <font color="#FF0000"><b>then </b></font>Volume<font color="#000080">:=</font>Volume <font color="#FF0000"><b>And </b></font><font color="#800000">7 </font><font color="#FF0000"><b>Else </b></font>Volume<font color="#000080">:=</font>Volume <font color="#FF0000"><b>And </b></font><font color="#800000">15</font><font color="#000080">;
  </font>GetVolume<font color="#000080">:=</font>Volume<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>SetInput <font color="#000080">(</font>InputDevice<font color="#000080">, </font>Filter <font color="#000080">: </font>Byte<font color="#000080">; </font>FilterOn <font color="#000080">: </font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>Value <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  Case </b></font>InputDevice <font color="#FF0000"><b>Of
    </b></font>Microphone <font color="#000080">: </font>Value<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>CDAudio    <font color="#000080">: </font>Value<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">;
    </font>LineIn     <font color="#000080">: </font>Value<font color="#000080">:=</font><font color="#800000">6</font><font color="#000080">;
  </font><font color="#FF0000"><b>Else
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>Filter<font color="#000080">=</font>LowPass <font color="#FF0000"><b>then </b></font>Value<font color="#000080">:=</font>Value <font color="#FF0000"><b>Or </b></font><font color="#800000">8</font><font color="#000080">;
  </font><font color="#FF0000"><b>If Not </b></font>FilterOn <font color="#FF0000"><b>then </b></font>Value<font color="#000080">:=</font>Value <font color="#FF0000"><b>Or </b></font><font color="#800000">32</font><font color="#000080">;
  </font>WriteMixer <font color="#000080">(</font><font color="#800000">$0C</font><font color="#000080">,</font>Value<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>GetInput <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>InputDevice<font color="#000080">, </font>Filter <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>FilterOn <font color="#000080">: </font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>Value <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Value<font color="#000080">:=</font>ReadMixer <font color="#000080">(</font><font color="#800000">$0C</font><font color="#000080">);
  </font><font color="#FF0000"><b>Case </b></font>Value <font color="#FF0000"><b>And </b></font><font color="#800000">6 </font><font color="#FF0000"><b>Of
    </b></font><font color="#800000">0 </font><font color="#000080">: </font>InputDevice<font color="#000080">:=</font>Microphone<font color="#000080">;
    </font><font color="#800000">2 </font><font color="#000080">: </font>InputDevice<font color="#000080">:=</font>CDAudio<font color="#000080">;
    </font><font color="#800000">6 </font><font color="#000080">: </font>InputDevice<font color="#000080">:=</font>LineIn<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>Value <font color="#FF0000"><b>And </b></font><font color="#800000">8</font><font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Filter<font color="#000080">:=</font>LowPass <font color="#FF0000"><b>Else </b></font>Filter<font color="#000080">:=</font>HighPass<font color="#000080">;
  </font>FilterOn<font color="#000080">:=(</font>Value <font color="#FF0000"><b>And </b></font><font color="#800000">32</font><font color="#000080">)=</font><font color="#800000">0
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>SetOutput <font color="#000080">(</font>StereoOut<font color="#000080">, </font>FilterOutput <font color="#000080">: </font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>Value <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>StereoOut <font color="#FF0000"><b>then </b></font>Value<font color="#000080">:=</font><font color="#800000">2 </font><font color="#FF0000"><b>Else </b></font>Value<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>If Not </b></font>FilterOutput <font color="#FF0000"><b>then </b></font>Value<font color="#000080">:=</font>Value <font color="#FF0000"><b>Or </b></font><font color="#800000">32</font><font color="#000080">;
  </font>WriteMixer <font color="#000080">(</font><font color="#800000">$0E</font><font color="#000080">,</font>Value<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>GetOutput <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>StereoOut<font color="#000080">, </font>FilterOutput <font color="#000080">: </font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>Value <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Value<font color="#000080">:=</font>ReadMixer <font color="#000080">(</font><font color="#800000">$0E</font><font color="#000080">);
  </font>StereoOut<font color="#000080">:=(</font>Value <font color="#FF0000"><b>And </b></font><font color="#800000">2</font><font color="#000080">)&lt;&gt;</font><font color="#800000">0</font><font color="#000080">;
  </font>FilterOutput<font color="#000080">:=(</font>Value <font color="#FF0000"><b>And </b></font><font color="#800000">32</font><font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>HandleRecordIrq<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>RecordLength<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then Begin
    If </b></font>CurrentRecord<font color="#000080">=</font>SoundBuffer1 <font color="#FF0000"><b>then </b></font>CurrentRecord<font color="#000080">:=</font>SoundBuffer2 <font color="#FF0000"><b>Else </b></font>CurrentRecord<font color="#000080">:=</font>SoundBuffer1<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>RecordLength <font color="#000080">&gt;= </font><font color="#800000">16384 </font><font color="#FF0000"><b>then </b></font>RecSampleSize<font color="#000080">:=</font><font color="#800000">16384 </font><font color="#FF0000"><b>Else </b></font>RecSampleSize<font color="#000080">:=</font>RecordLength<font color="#000080">;
    </font>Dec <font color="#000080">(</font>RecordLength<font color="#000080">,</font>RecSampleSize<font color="#000080">);
    </font>RecBuffer <font color="#000080">(</font>CurrentRecord<font color="#000080">,</font>RecSampleRate<font color="#000080">,</font>RecSampleSize<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>CurrentRecord<font color="#000080">=</font>SoundBuffer1 <font color="#FF0000"><b>then </b></font>OutBuffer <font color="#000080">(</font>SoundBuffer2<font color="#000080">^,</font><font color="#800000">16384</font><font color="#000080">) </font><font color="#FF0000"><b>Else </b></font>OutBuffer <font color="#000080">(</font>SoundBuffer1<font color="#000080">^,</font><font color="#800000">16384</font><font color="#000080">);
  </font><font color="#FF0000"><b>End
  Else Begin
    If </b></font>CurrentRecord<font color="#000080">=</font>SoundBuffer1 <font color="#FF0000"><b>then
      </b></font>OutBuffer <font color="#000080">(</font>SoundBuffer1<font color="#000080">^,</font>RecSampleSize<font color="#000080">)
    </font><font color="#FF0000"><b>Else
      </b></font>OutBuffer <font color="#000080">(</font>SoundBuffer2<font color="#000080">^,</font>RecSampleSize<font color="#000080">);
    </font>RecordingReady<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>HandlePlaybackIrq<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>PlayLength<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then Begin
    If </b></font>CurrentPlay<font color="#000080">=</font>SoundBuffer1 <font color="#FF0000"><b>then </b></font>CurrentPlay<font color="#000080">:=</font>SoundBuffer2 <font color="#FF0000"><b>Else </b></font>CurrentPlay<font color="#000080">:=</font>SoundBuffer1<font color="#000080">;
    </font>PlayBuffer <font color="#000080">(</font>CurrentPlay<font color="#000080">,</font>PlaySampleRate<font color="#000080">,</font>PlaySampleSize<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>PlayLength <font color="#000080">&gt;= </font><font color="#800000">16384 </font><font color="#FF0000"><b>then </b></font>PlaySampleSize<font color="#000080">:=</font><font color="#800000">16384 </font><font color="#FF0000"><b>Else </b></font>PlaySampleSize<font color="#000080">:=</font>PlayLength<font color="#000080">;
    </font>Dec <font color="#000080">(</font>PlayLength<font color="#000080">,</font>PlaySampleSize<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>CurrentPlay<font color="#000080">=</font>SoundBuffer1 <font color="#FF0000"><b>then
      </b></font>InBuffer <font color="#000080">(</font>SoundBuffer2<font color="#000080">^,</font>PlaySampleSize<font color="#000080">)
    </font><font color="#FF0000"><b>Else
      </b></font>InBuffer <font color="#000080">(</font>SoundBuffer1<font color="#000080">^,</font>PlaySampleSize<font color="#000080">);
  </font><font color="#FF0000"><b>End
  Else Begin
    If </b></font>PlaySampleSize<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then Begin
      If </b></font>CurrentPlay<font color="#000080">=</font>SoundBuffer1 <font color="#FF0000"><b>then </b></font>CurrentPlay<font color="#000080">:=</font>SoundBuffer2 <font color="#FF0000"><b>Else </b></font>CurrentPlay<font color="#000080">:=</font>SoundBuffer1<font color="#000080">;
      </font>PlayBuffer <font color="#000080">(</font>CurrentPlay<font color="#000080">,</font>PlaySampleRate<font color="#000080">,</font>PlaySampleSize<font color="#000080">);
      </font>PlaySampleSize<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>End
    Else
      </b></font>PlaybackReady<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>WriteDSP <font color="#000080">(</font>Value <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>Begin
  While </b></font>Port<font color="#000080">[</font>WritePort<font color="#000080">] &gt; </font><font color="#800000">127 </font><font color="#FF0000"><b>Do </b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>WritePort<font color="#000080">]:=</font>Value<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SoundBlasterPro<font color="#000080">.</font>ReadDSP <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  While </b></font>Port<font color="#000080">[</font>PollPort<font color="#000080">] &lt; </font><font color="#800000">128 </font><font color="#FF0000"><b>Do</b></font><font color="#000080">;
  </font>ReadDSP<font color="#000080">:=</font>Port<font color="#000080">[</font>ReadPort<font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>PlayBuffer <font color="#000080">(</font>Buffer <font color="#000080">: </font>Pointer<font color="#000080">; </font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>SampleRateLimit<font color="#000080">, </font>Time_constant<font color="#000080">, </font>Page<font color="#000080">, </font>Offset <font color="#000080">: </font>Word<font color="#000080">;
  </font>l <font color="#000080">: </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>Begin

  If </b></font><font color="#000080">(</font>Size<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Or </b></font><font color="#000080">(</font>Size<font color="#000080">&gt;</font><font color="#800000">16384</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;

  </font>Dec <font color="#000080">(</font>Size<font color="#000080">);

  </font><font color="#008000"><i>{ Set up the DMA chip }
  {$IFDEF DPMI}
    </i></font>l<font color="#000080">:=</font>GetSelectorBase <font color="#000080">(</font>LongInt <font color="#000080">(</font>Buffer<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
  </font><font color="#008000"><i>{$ELSE}
    </i></font>l<font color="#000080">:=</font>LongInt <font color="#000080">(</font>Seg <font color="#000080">(</font>Buffer<font color="#000080">^)) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">+</font>Ofs <font color="#000080">(</font>Buffer<font color="#000080">^);
  </font><font color="#008000"><i>{$ENDIF}
  </i></font>Offset<font color="#000080">:=</font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">;
  </font>Page<font color="#000080">:=</font>l <font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font>DMAStopMask<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0C</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0B</font><font color="#000080">] := </font>DMAModeReg<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$83</font><font color="#000080">] := </font>Page<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font>DMAStartMask<font color="#000080">;

  </font><font color="#008000"><i>{ Set the playback SampleRate }

  </i></font><font color="#FF0000"><b>If </b></font>InputMode<font color="#000080">=</font>Stereo <font color="#FF0000"><b>then Begin
    </b></font>SampleRateLimit<font color="#000080">:=</font><font color="#800000">11025</font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&lt;=</font>SampleRateLimit <font color="#FF0000"><b>then Begin
      </b></font>Time_constant <font color="#000080">:= </font><font color="#800000">256 </font><font color="#000080">- (</font><font color="#800000">1000000 </font><font color="#FF0000"><b>div </b></font><font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>SampleRate<font color="#000080">));
    </font><font color="#FF0000"><b>End
    Else Begin
      </b></font>Time_constant <font color="#000080">:= </font>Hi <font color="#000080">(</font><font color="#800000">65536</font><font color="#000080">-(</font><font color="#800000">256000000 </font><font color="#FF0000"><b>DIV </b></font><font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>SampleRate<font color="#000080">)));
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End
  Else Begin
    </b></font>SampleRateLimit<font color="#000080">:=</font><font color="#800000">22050</font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&lt;=</font>SampleRateLimit <font color="#FF0000"><b>then Begin
      </b></font>Time_constant <font color="#000080">:= </font><font color="#800000">256 </font><font color="#000080">- (</font><font color="#800000">1000000 </font><font color="#FF0000"><b>div </b></font>SampleRate<font color="#000080">);
    </font><font color="#FF0000"><b>End
    Else Begin
      </b></font>Time_constant <font color="#000080">:= </font>Hi <font color="#000080">(</font><font color="#800000">65536</font><font color="#000080">-(</font><font color="#800000">256000000 </font><font color="#FF0000"><b>DIV </b></font>SampleRate<font color="#000080">));
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>WriteDSP <font color="#000080">(</font><font color="#800000">$40</font><font color="#000080">);
  </font>WriteDSP <font color="#000080">(</font>Time_constant<font color="#000080">);

  </font><font color="#008000"><i>{ Set the playback type (8-bit) }

  </i></font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&lt;=</font>SampleRateLimit <font color="#FF0000"><b>then </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$14</font><font color="#000080">) </font><font color="#FF0000"><b>Else </b></font>WriteDSP <font color="#000080">(</font><font color="#800000">$48</font><font color="#000080">);
  </font>WriteDSP <font color="#000080">(</font>Lo<font color="#000080">(</font>size<font color="#000080">));
  </font>WriteDSP <font color="#000080">(</font>Hi<font color="#000080">(</font>size<font color="#000080">));
  </font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&gt;</font>SampleRateLimit <font color="#FF0000"><b>then </b></font>WriteDSP <font color="#000080">(</font><font color="#800000">$91</font><font color="#000080">);

  </font>Port <font color="#000080">[</font>PICPort<font color="#000080">]:=</font>Port <font color="#000080">[</font>PICPort<font color="#000080">] </font><font color="#FF0000"><b>And </b></font>IrqStartMask<font color="#000080">;
  </font>Port <font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>RecBuffer <font color="#000080">(</font>Buffer <font color="#000080">: </font>Pointer<font color="#000080">; </font>SampleRate <font color="#000080">: </font>Word<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>SampleRateLimit<font color="#000080">, </font>Time_constant<font color="#000080">, </font>Page<font color="#000080">, </font>Offset <font color="#000080">: </font>Word<font color="#000080">;
  </font>l <font color="#000080">: </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>Begin

  If </b></font><font color="#000080">(</font>Size<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Or </b></font><font color="#000080">(</font>Size<font color="#000080">&gt;</font><font color="#800000">16384</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;

  </font>Dec <font color="#000080">(</font>Size<font color="#000080">);

  </font><font color="#008000"><i>{ Set up the DMA chip }
  {$IFDEF DPMI}
    </i></font>l<font color="#000080">:=</font>GetSelectorBase <font color="#000080">(</font>LongInt <font color="#000080">(</font>Buffer<font color="#000080">) </font><font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">);
  </font><font color="#008000"><i>{$ELSE}
    </i></font>l<font color="#000080">:=</font>LongInt <font color="#000080">(</font>Seg <font color="#000080">(</font>Buffer<font color="#000080">^)) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">4</font><font color="#000080">+</font>Ofs <font color="#000080">(</font>Buffer<font color="#000080">^);
  </font><font color="#008000"><i>{$ENDIF}
  </i></font>Offset<font color="#000080">:=</font>l <font color="#FF0000"><b>MOD </b></font><font color="#800000">65536</font><font color="#000080">;
  </font>Page<font color="#000080">:=</font>l <font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font>DMAStopMask<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0C</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0B</font><font color="#000080">] := </font><font color="#800000">$45</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Lo <font color="#000080">(</font>Offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Hi <font color="#000080">(</font>Offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$83</font><font color="#000080">] := </font>Page<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Lo <font color="#000080">(</font>Size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Hi <font color="#000080">(</font>Size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font>DMAStartMask<font color="#000080">;

  </font><font color="#008000"><i>{ Set the record SampleRate }
  </i></font><font color="#FF0000"><b>If </b></font>InputMode<font color="#000080">=</font>Stereo <font color="#FF0000"><b>then Begin
    </b></font>SampleRateLimit<font color="#000080">:=</font><font color="#800000">11025</font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&lt;=</font>SampleRateLimit <font color="#FF0000"><b>then Begin
      </b></font>Time_constant <font color="#000080">:= </font><font color="#800000">256 </font><font color="#000080">- (</font><font color="#800000">1000000 </font><font color="#FF0000"><b>div </b></font><font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>SampleRate<font color="#000080">));
    </font><font color="#FF0000"><b>End
    Else Begin
      </b></font>Time_constant <font color="#000080">:= </font>Hi <font color="#000080">(</font><font color="#800000">65536</font><font color="#000080">-(</font><font color="#800000">256000000 </font><font color="#FF0000"><b>DIV </b></font><font color="#000080">(</font><font color="#800000">2</font><font color="#000080">*</font>SampleRate<font color="#000080">)));
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End
  Else Begin
    </b></font>SampleRateLimit<font color="#000080">:=</font><font color="#800000">22050</font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&lt;=</font>SampleRateLimit <font color="#FF0000"><b>then Begin
      </b></font>Time_constant <font color="#000080">:= </font><font color="#800000">256 </font><font color="#000080">- (</font><font color="#800000">1000000 </font><font color="#FF0000"><b>div </b></font>SampleRate<font color="#000080">);
    </font><font color="#FF0000"><b>End
    Else Begin
      </b></font>Time_constant <font color="#000080">:= </font>Hi <font color="#000080">(</font><font color="#800000">65536</font><font color="#000080">-(</font><font color="#800000">256000000 </font><font color="#FF0000"><b>DIV </b></font>SampleRate<font color="#000080">));
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>WriteDSP <font color="#000080">(</font><font color="#800000">$40</font><font color="#000080">);
  </font>WriteDSP <font color="#000080">(</font>Time_constant<font color="#000080">);

  </font><font color="#008000"><i>{ Set the record type (8-bit) }
  </i></font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&lt;=</font>SampleRateLimit <font color="#FF0000"><b>then </b></font>WriteDSP <font color="#000080">(</font><font color="#800000">$24</font><font color="#000080">) </font><font color="#FF0000"><b>Else </b></font>WriteDSP <font color="#000080">(</font><font color="#800000">$48</font><font color="#000080">);
  </font>WriteDSP <font color="#000080">(</font>Lo <font color="#000080">(</font>Size<font color="#000080">));
  </font>WriteDSP <font color="#000080">(</font>Hi <font color="#000080">(</font>Size<font color="#000080">));
  </font><font color="#FF0000"><b>If </b></font>SampleRate<font color="#000080">&gt;</font>SampleRateLimit <font color="#FF0000"><b>then </b></font>WriteDSP <font color="#000080">(</font><font color="#800000">$99</font><font color="#000080">);

  </font>Port <font color="#000080">[</font>PICPort<font color="#000080">]:=</font>Port <font color="#000080">[</font>PICPort<font color="#000080">] </font><font color="#FF0000"><b>And </b></font>IrqStartMask<font color="#000080">;
  </font>Port <font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>DisableInterrupts<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">; </font><font color="#FF0000"><b>ASM </b></font><font color="#FF00FF">CLI </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>EnableInterrupts<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">; </font><font color="#FF0000"><b>ASM </b></font><font color="#FF00FF">STI </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>DisableIrq<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Port<font color="#000080">[</font>PICPort<font color="#000080">]:=</font>Port<font color="#000080">[</font>PICPort<font color="#000080">] </font><font color="#FF0000"><b>Or </b></font>IrqStopMask<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SoundBlasterPro<font color="#000080">.</font>EnableIrq<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Port<font color="#000080">[</font>PICPort<font color="#000080">]:=</font>Port<font color="#000080">[</font>PICPort<font color="#000080">] </font><font color="#FF0000"><b>And </b></font>IrqStartMask<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.



</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0101.PAS">Original</a><b>]</b></p></body>
</html>
