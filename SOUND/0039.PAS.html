<html>
<head><title> "R2D2 Noises" by SEAN PALMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
If anyone can fill me in on how to output in stereo, I'd be very
appreciative... I've heard that port $220/$221 is for left channel,
$222/$223 is for the right, but that doesn't make any sense...does it?

This code makes R2D2 noises on a SoundBlaster until you press ESC.

{adapted from SS4CH.PAS by Frank Hirsch}
</i></font><font color="#FF0000"><b>USES </b></font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>sampleSize<font color="#000080">=</font><font color="#800000">4096</font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>sampleData<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>sampleSize<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">]</font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>samplePos<font color="#000080">:</font>longint<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>sampleSpeed<font color="#000080">:</font>longint<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>sampleDelta<font color="#000080">:</font>longint<font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>resetPort <font color="#000080">=</font><font color="#800000">$226</font><font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>readPort  <font color="#000080">=</font><font color="#800000">$22A</font><font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>writePort <font color="#000080">=</font><font color="#800000">$22C</font><font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>dataAvailPort<font color="#000080">=</font><font color="#800000">$22E</font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>readByte<font color="#000080">:</font>byte<font color="#000080">;</font><font color="#FF0000"><b>begin
 repeat until </b></font>shortInt<font color="#000080">(</font>port<font color="#000080">[</font>dataAvailPort<font color="#000080">])&lt;</font><font color="#800000">0</font><font color="#000080">;
 </font>readByte<font color="#000080">:=</font>port<font color="#000080">[</font>readPort<font color="#000080">];
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>initDSP<font color="#000080">;</font><font color="#FF0000"><b>begin
 </b></font>port<font color="#000080">[</font>resetPort<font color="#000080">]:=</font><font color="#800000">1</font><font color="#000080">;
 </font>delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
 </font>port<font color="#000080">[</font>resetPort<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
 </font><font color="#FF0000"><b>repeat until </b></font>readByte<font color="#000080">=</font><font color="#800000">$AA</font><font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>counter<font color="#000080">:</font>longint<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>timerInt<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ax
  push bx
  push dx
  push di
  push ds
  push es
  mov ax,seg @DATA
  mov ds,ax

  mov es,[segB800]
  xor byte ptr es:[0],$21

  mov bx,[word ptr samplePos+2]
  mov ah,byte ptr sampleData[bx]
  mov dx,[word ptr sampleSpeed]    </font><font color="#008000"><i>{next sample byte}
  </i></font><font color="#FF00FF">add [word ptr samplePos],dx
  adc bx,[word ptr sampleSpeed+2]
  and bx,[sampleSize-1]
  mov [word ptr samplePos+2],bx
  mov bx,[word ptr sampleDelta]
  add [word ptr sampleSpeed],bx
  mov bx,[word ptr sampleDelta+2]
  adc [word ptr sampleSpeed+2],bx
  mov dx,writePort
 @P2:              </font><font color="#008000"><i>{ready for output byte?}
  </i></font><font color="#FF00FF">in al,dx
  test al,$80
  jnz @P2
  mov al,ah
  out dx,al

  mov al,$20       </font><font color="#008000"><i>{process interrupt}
  </i></font><font color="#FF00FF">out $20,al
</font><font color="#008000"><i>{  sti}
                   {prep NEXT output}
 </i></font><font color="#FF00FF">@P1:              </font><font color="#008000"><i>{ready for command?}
  </i></font><font color="#FF00FF">in al,dx
  test al,$80
  jnz @P1
  mov al,$10       </font><font color="#008000"><i>{set up a DAC output}
  </i></font><font color="#FF00FF">out dx,al

  db $66; inc word ptr [counter]

  pop es
  pop ds
  pop di
  pop dx
  pop bx
  pop ax
  iret
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>vec08<font color="#000080">:</font>pointer <font color="#FF0000"><b>absolute </b></font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">8</font><font color="#000080">*</font><font color="#800000">4</font><font color="#000080">;
  </font>old08<font color="#000080">:</font>pointer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setTimerTics<font color="#000080">(</font>tics<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>begin
  asm </b></font><font color="#FF00FF">cli; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">]:=</font><font color="#800000">$36</font><font color="#000080">;
  </font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">]:=</font>lo<font color="#000080">(</font>tics<font color="#000080">);
  </font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">]:=</font>hi<font color="#000080">(</font>tics<font color="#000080">);
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setTimerFreq<font color="#000080">(</font>freq<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>begin
  </b></font>setTimerTics<font color="#000080">(</font>succ<font color="#000080">(</font>word<font color="#000080">(</font><font color="#800000">$1234DC </font><font color="#FF0000"><b>div </b></font>freq<font color="#000080">)));
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>stopTimer<font color="#000080">;</font><font color="#FF0000"><b>begin </b></font>setTimerTics<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">); </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>writeByte<font color="#000080">(</font>b<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>begin
  repeat until </b></font>shortInt<font color="#000080">(</font>port<font color="#000080">[</font>writePort<font color="#000080">])&gt;=</font><font color="#800000">0</font><font color="#000080">;
  </font>port<font color="#000080">[</font>writePort<font color="#000080">]:=</font>b<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>speaker<font color="#000080">(</font>onOff<font color="#000080">:</font>boolean<font color="#000080">);</font><font color="#FF0000"><b>begin
  if </b></font>onOff <font color="#FF0000"><b>then </b></font>writeByte<font color="#000080">(</font><font color="#800000">$D1</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>writeByte<font color="#000080">(</font><font color="#800000">$D3</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>i<font color="#000080">,</font>j<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>rate<font color="#000080">=</font><font color="#800000">16384</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>note<font color="#000080">(</font>freq<font color="#000080">,</font>dur<font color="#000080">,</font>slide<font color="#000080">:</font>longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>counter<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>sampleSpeed<font color="#000080">:=</font>freq<font color="#000080">*</font>sampleSize<font color="#000080">*(</font><font color="#800000">65536 </font><font color="#FF0000"><b>div </b></font>rate<font color="#000080">);
  </font>sampleDelta<font color="#000080">:=</font>slide<font color="#000080">;
  </font>dur<font color="#000080">:=(</font>dur<font color="#000080">*</font>rate<font color="#000080">)</font><font color="#FF0000"><b>div </b></font><font color="#800000">1000</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    if </b></font>port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">]=</font><font color="#800000">$81 </font><font color="#FF0000"><b>then </b></font>break<font color="#000080">;
    </font><font color="#FF0000"><b>until </b></font>counter<font color="#000080">&gt;=</font>dur<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin
 </b></font>initDSP<font color="#000080">;
 </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>sampleSize<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
   </b></font>sampleData<font color="#000080">[</font>i<font color="#000080">]:=</font>round<font color="#000080">(</font>sin<font color="#000080">(</font>i<font color="#000080">*</font>pi<font color="#000080">/(</font>sampleSize <font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">))*</font><font color="#800000">127.5</font><font color="#000080">+</font><font color="#800000">127.5</font><font color="#000080">);
 </font>old08<font color="#000080">:=</font>vec08<font color="#000080">;
 </font>speaker<font color="#000080">(</font>true<font color="#000080">);
 </font>writeByte<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">);  </font><font color="#008000"><i>{prep sb for data}
 </i></font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>vec08<font color="#000080">:=@</font>timerInt<font color="#000080">;
 </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>setTimerFreq<font color="#000080">(</font>rate<font color="#000080">);
 </font><font color="#FF0000"><b>repeat
   case </b></font>random<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>of
     </b></font><font color="#800000">0</font><font color="#000080">:</font>note<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">1900</font><font color="#000080">)+</font><font color="#800000">60</font><font color="#000080">,(</font>random<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">)*</font><font color="#800000">80</font><font color="#000080">)+</font><font color="#800000">40</font><font color="#000080">,</font>integer<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">))-</font><font color="#800000">1</font><font color="#000080">);
     </font><font color="#800000">1</font><font color="#000080">:</font>note<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">800</font><font color="#000080">)+</font><font color="#800000">450</font><font color="#000080">,(</font>random<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">)*</font><font color="#800000">80</font><font color="#000080">)+</font><font color="#800000">140</font><font color="#000080">,</font>integer<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">2049</font><font color="#000080">))
                                                              -</font><font color="#800000">1024</font><font color="#000080">);
     </font><font color="#800000">2</font><font color="#000080">:</font>note<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,(</font>random<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">40</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
     </font><font color="#800000">3</font><font color="#000080">:</font>note<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">30</font><font color="#000080">)+</font><font color="#800000">15</font><font color="#000080">,(</font>random<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">)*</font><font color="#800000">80</font><font color="#000080">)+</font><font color="#800000">40</font><font color="#000080">,</font>random<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">));
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>until </b></font>port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">]=</font><font color="#800000">$81</font><font color="#000080">;
 </font>stopTimer<font color="#000080">;
 </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>vec08<font color="#000080">:=</font>old08<font color="#000080">;
 </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>speaker<font color="#000080">(</font>false<font color="#000080">);  </font><font color="#008000"><i>{it's probably gonna eat this as data}
 </i></font>speaker<font color="#000080">(</font>false<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p></body>
</html>
