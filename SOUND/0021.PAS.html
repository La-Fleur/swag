<html>
<head><title> "Play CMF Files on SB" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>UNIT </b></font>CMFTool<font color="#000080">;
</font><font color="#008000"><i>{** Unit - uses SBFMDRV.COM **}
</i></font><font color="#FF0000"><b>INTERFACE
USES </b></font>Dos<font color="#000080">;
</font><font color="#FF0000"><b>TYPE
  </b></font>CMFFileTyp <font color="#000080">= </font><font color="#FF0000"><b>FILE</b></font><font color="#000080">;
  </font>CMFDataTyp <font color="#000080">= </font>Pointer<font color="#000080">;
  </font>CMFHeader <font color="#000080">= </font><font color="#FF0000"><b>RECORD
    </b></font>CMFFileID         <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>CHAR<font color="#000080">;
    </font>CMFVersion        <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFInstrBlockOfs  <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFMusicBlockOfs  <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFTickPerBeat    <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFClockTicksPS   <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFFileTitleOfs   <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFComposerOfs    <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFMusicRemarkOfs <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFChannelsUsed   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>CHAR<font color="#000080">;
    </font>CMFInstrNumber    <font color="#000080">: </font>WORD<font color="#000080">;
    </font>CMFBasicTempo     <font color="#000080">: </font>WORD<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>CONST
   </b></font>CMFToolVersion       <font color="#000080">= </font><font color="#800000">'v1.0'</font><font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>CMFStatusByte      <font color="#000080">: </font>BYTE<font color="#000080">;
   </font>CMFErrStat         <font color="#000080">: </font>WORD<font color="#000080">;
   </font>CMFDriverInstalled <font color="#000080">: </font>BOOLEAN<font color="#000080">;
   </font>CMFDriverIRQ       <font color="#000080">: </font>WORD<font color="#000080">;
   </font>CMFSongPaused      <font color="#000080">: </font>BOOLEAN<font color="#000080">;
   </font>OldExitProc        <font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>PrintCMFErrMessage<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFGetSongBuffer<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">; </font>CMFFile <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFFreeSongBuffer <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFInitDriver <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFGetVersion <font color="#000080">: </font>WORD<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetStatusByte<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFSetInstruments<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFSetSingleInstruments<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFInstrument<font color="#000080">:</font>Pointer<font color="#000080">; </font>No<font color="#000080">:</font>WORD<font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetSysClock<font color="#000080">(</font>Frequency <font color="#000080">: </font>WORD<font color="#000080">);
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetDriverClock<font color="#000080">(</font>Frequency <font color="#000080">: </font>WORD<font color="#000080">);
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetTransposeOfs <font color="#000080">(</font>Offset <font color="#000080">: </font>INTEGER<font color="#000080">);
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFPlaySong<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">) : </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFStopSong <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFResetDriver<font color="#000080">:</font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFPauseSong <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFContinueSong <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>IMPLEMENTATION
TYPE
   </b></font>TypeCastTyp <font color="#000080">= </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">6000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
   </font>CMFIntern <font color="#000080">: ^</font>CMFHeader<font color="#000080">; </font><font color="#008000"><i>{ Internal pointer to CMF structure }
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>PrintCMFErrMessage<font color="#000080">;
</font><font color="#008000"><i>{ PURPOSE : Displays SB error as text; no change to error status. }
</i></font><font color="#FF0000"><b>BEGIN
   CASE </b></font>CMFErrStat <font color="#FF0000"><b>OF
      </b></font><font color="#800000">100 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' SBFMDRV sound driver not found '</font><font color="#000080">);
      </font><font color="#800000">110 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' Driver reset successful '</font><font color="#000080">);
      </font><font color="#800000">200 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' CMF file not found '</font><font color="#000080">);
      </font><font color="#800000">210 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' No memory free for CMF file '</font><font color="#000080">);
      </font><font color="#800000">220 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' File not in CMF format '</font><font color="#000080">);
      </font><font color="#800000">300 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' Memory allocation error occurred '</font><font color="#000080">);
      </font><font color="#800000">400 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' Too many instruments defined '</font><font color="#000080">);
      </font><font color="#800000">500 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' CMF data could not be played '</font><font color="#000080">);
      </font><font color="#800000">510 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' CMF data could not be stopped '</font><font color="#000080">);
      </font><font color="#800000">520 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' CMF data could not be paused '</font><font color="#000080">);
      </font><font color="#800000">530 </font><font color="#000080">: </font>Write<font color="#000080">(</font><font color="#800000">' CMF data could not be continued '</font><font color="#000080">);
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Exists <font color="#000080">(</font>Filename <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ PURPOSE : Checks for the existence of a file, and returns a Boolean exp. }
</i></font><font color="#FF0000"><b>VAR
   </b></font>F <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Assign<font color="#000080">(</font>F<font color="#000080">,</font>Filename<font color="#000080">);
</font><font color="#008000"><i>{$I-}
   </i></font>Reset<font color="#000080">(</font>F<font color="#000080">);
   </font>Close<font color="#000080">(</font>F<font color="#000080">);
</font><font color="#008000"><i>{$I+}
   </i></font>Exists <font color="#000080">:= (</font>IoResult <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>Filename <font color="#000080">&lt;&gt; </font><font color="#800000">''</font><font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>AllocateMem <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Pt <font color="#000080">: </font>Pointer<font color="#000080">; </font>Size <font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#008000"><i>{ Reserves as many bytes as Size allows, then sets the pointer in the
  Pt variable. If not enough memory is available, Pt is set to NIL. }
</i></font><font color="#FF0000"><b>VAR
   </b></font>SizeIntern <font color="#000080">: </font>WORD<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Inc<font color="#000080">(</font>Size<font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
   </font>SizeIntern <font color="#000080">:= (</font>Size <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">);
   </font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$48</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font>SizeIntern<font color="#000080">;
   </font>MsDos<font color="#000080">(</font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>Regs<font color="#000080">.</font>BX <font color="#000080">&lt;&gt; </font>SizeIntern<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>Pt <font color="#000080">:= </font><font color="#FF0000"><b>NIL
   ELSE </b></font>Pt <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Regs<font color="#000080">.</font>AX<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CheckFreeMem <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">; </font>CMFSize <font color="#000080">: </font>LongInt<font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Ensures that enough memory has been allocated for CMF file. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>AllocateMem<font color="#000080">(</font>CMFBuffer<font color="#000080">,</font>CMFSize<font color="#000080">);
   </font>CheckFreeMem <font color="#000080">:= </font>CMFBuffer <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>CMFGetSongBuffer<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">; </font>CMFFile <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Loads file into memory; returns TRUE if load successful, FALSE if not. }
</i></font><font color="#FF0000"><b>CONST
   </b></font>FileCheck <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">[</font><font color="#800000">4</font><font color="#000080">] = </font><font color="#800000">'CTMF'</font><font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>CMFFileSize <font color="#000080">: </font>LongInt<font color="#000080">;
   </font>FPresent    <font color="#000080">: </font>BOOLEAN<font color="#000080">;
   </font>VFile       <font color="#000080">: </font>CMFFileTyp<font color="#000080">;
   </font>Segs        <font color="#000080">: </font>WORD<font color="#000080">;
   </font>Read        <font color="#000080">: </font>WORD<font color="#000080">;
   </font>Checkcount  <font color="#000080">: </font>BYTE<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>FPresent <font color="#000080">:= </font>Exists<font color="#000080">(</font>CMFFile<font color="#000080">);

</font><font color="#008000"><i>{ CMF file could not be found }
   </i></font><font color="#FF0000"><b>IF Not</b></font><font color="#000080">(</font>FPresent<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>CMFGetSongBuffer <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat   <font color="#000080">:= </font><font color="#800000">200</font><font color="#000080">;
      </font>EXIT
      <font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font>Assign<font color="#000080">(</font>VFile<font color="#000080">,</font>CMFFile<font color="#000080">);
   </font>Reset<font color="#000080">(</font>VFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
   </font>CMFFileSize <font color="#000080">:= </font>Filesize<font color="#000080">(</font>VFile<font color="#000080">);
   </font>AllocateMem<font color="#000080">(</font>CMFBuffer<font color="#000080">,</font>CMFFileSize<font color="#000080">);
</font><font color="#008000"><i>{ Insufficient memory for CMF file }
   </i></font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>CMFBuffer <font color="#000080">= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Close<font color="#000080">(</font>VFile<font color="#000080">);
      </font>CMFGetSongBuffer <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat   <font color="#000080">:= </font><font color="#800000">210</font><font color="#000080">;
      </font>EXIT<font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font>Segs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>REPEAT
      </b></font>Blockread<font color="#000080">(</font>VFile<font color="#000080">,</font>Ptr<font color="#000080">(</font>seg<font color="#000080">(</font>CMFBuffer<font color="#000080">^)+</font><font color="#800000">4096</font><font color="#000080">*</font>Segs<font color="#000080">,</font>Ofs<font color="#000080">(</font>CMFBuffer<font color="#000080">^))^,</font><font color="#800000">$FFFF</font><font color="#000080">,</font>Read
<font color="#000080">);
      </font>Inc<font color="#000080">(</font>Segs<font color="#000080">);
      </font><font color="#FF0000"><b>UNTIL </b></font>Read <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
   </font>Close<font color="#000080">(</font>VFile<font color="#000080">);
</font><font color="#008000"><i>{ File not in CMF format }
   </i></font>CMFIntern <font color="#000080">:= </font>CMFBuffer<font color="#000080">;
   </font>CheckCount <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>REPEAT
      IF </b></font>FileCheck<font color="#000080">[</font>CheckCount<font color="#000080">] = </font>CMFIntern<font color="#000080">^.</font>CMFFileID<font color="#000080">[</font>CheckCount<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">]
         </font><font color="#FF0000"><b>THEN </b></font>Inc<font color="#000080">(</font>CheckCount<font color="#000080">)
         </font><font color="#FF0000"><b>ELSE </b></font>CheckCount <font color="#000080">:= </font><font color="#800000">$FF</font><font color="#000080">;
      </font><font color="#FF0000"><b>UNTIL </b></font>CheckCount <font color="#000080">&gt;= </font><font color="#800000">3</font><font color="#000080">;
   </font><font color="#FF0000"><b>IF NOT</b></font><font color="#000080">(</font>CheckCount <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>CMFGetSongBuffer <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat   <font color="#000080">:= </font><font color="#800000">220</font><font color="#000080">;
      </font>EXIT<font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Load was successful }
   </i></font>CMFGetSongBuffer <font color="#000080">:= </font>TRUE<font color="#000080">;
   </font>CMFErrStat   <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFFreeSongBuffer <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Frees memory allocated for CMF file. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$49</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>ES <font color="#000080">:= </font>seg<font color="#000080">(</font>CMFBuffer<font color="#000080">^);
   </font>MsDos<font color="#000080">(</font>Regs<font color="#000080">);
   </font>CMFFreeSongBuffer <font color="#000080">:= </font>TRUE<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">9</font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>CMFFreeSongBuffer <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat <font color="#000080">:= </font><font color="#800000">300
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFInitDriver <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Checks for SBFMDRV.COM resident in memory, and resets driver }
</i></font><font color="#FF0000"><b>CONST
   </b></font>DriverCheck <font color="#000080">:</font><font color="#FF0000"><b>STRING</b></font><font color="#000080">[</font><font color="#800000">5</font><font color="#000080">] = </font><font color="#800000">'FMDRV'</font><font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>ScanIRQ<font color="#000080">,
   </font>CheckCount  <font color="#000080">: </font>BYTE<font color="#000080">;
   </font>IRQPtr<font color="#000080">,
   </font>DummyPtr    <font color="#000080">: </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
</b></font><font color="#008000"><i>{ Possible SBFMDRV interrupts lie in range $80 - $BF }
   </i></font><font color="#FF0000"><b>FOR </b></font>ScanIRQ <font color="#000080">:= </font><font color="#800000">$80 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">$BF </font><font color="#FF0000"><b>DO BEGIN
      </b></font>GetIntVec<font color="#000080">(</font>ScanIRQ<font color="#000080">, </font>IRQPtr<font color="#000080">);
      </font>DummyPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>IRQPtr<font color="#000080">^), </font><font color="#800000">$102</font><font color="#000080">);
</font><font color="#008000"><i>{ Check for string 'FMDRV' in interrupt program. }
      </i></font>CheckCount <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>REPEAT
         IF </b></font>DriverCheck<font color="#000080">[</font>CheckCount<font color="#000080">] = </font>TypeCastTyp<font color="#000080">(</font>DummyPtr<font color="#000080">^)[</font>CheckCount<font color="#000080">]
            </font><font color="#FF0000"><b>THEN </b></font>Inc<font color="#000080">(</font>CheckCount<font color="#000080">)
            </font><font color="#FF0000"><b>ELSE </b></font>CheckCount <font color="#000080">:= </font><font color="#800000">$FF</font><font color="#000080">;
         </font><font color="#FF0000"><b>UNTIL </b></font>CheckCount <font color="#000080">&gt;= </font><font color="#800000">5</font><font color="#000080">;
      </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>CheckCount <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
</b></font><font color="#008000"><i>{ String found; reset executed }
         </i></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">08</font><font color="#000080">;
         </font>CMFDriverIRQ <font color="#000080">:= </font>ScanIRQ<font color="#000080">;
         </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
            </b></font>CMFInitDriver <font color="#000080">:= </font>TRUE
         <font color="#FF0000"><b>ELSE BEGIN
            </b></font>CMFInitDriver <font color="#000080">:= </font>FALSE<font color="#000080">;
            </font>CMFErrStat    <font color="#000080">:= </font><font color="#800000">110</font><font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font>Exit<font color="#000080">;
         </font><font color="#FF0000"><b>END
      ELSE BEGIN
</b></font><font color="#008000"><i>{ String not found }
         </i></font>CMFInitDriver <font color="#000080">:= </font>FALSE<font color="#000080">;
         </font>CMFErrStat <font color="#000080">:= </font><font color="#800000">100</font><font color="#000080">;
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFGetVersion <font color="#000080">: </font>WORD<font color="#000080">;
</font><font color="#008000"><i>{ Gets version number from SBFMDRV driver. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">,</font>Regs<font color="#000080">);
   </font>CMFGetVersion <font color="#000080">:= </font>Regs<font color="#000080">.</font>AX<font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetStatusByte<font color="#000080">;
</font><font color="#008000"><i>{ Place driver status byte in CMFStatusByte variable. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX<font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>DX<font color="#000080">:= </font>Seg<font color="#000080">(</font>CMFStatusByte<font color="#000080">);
   </font>Regs<font color="#000080">.</font>AX<font color="#000080">:= </font>Ofs<font color="#000080">(</font>CMFStatusByte<font color="#000080">);
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFSetInstruments<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Sets SB card FM registers to instrumentation stated in CMF file. }
</i></font><font color="#FF0000"><b>BEGIN
    </b></font>CMFIntern <font color="#000080">:= </font>CMFBuffer<font color="#000080">;
    </font><font color="#FF0000"><b>IF </b></font>CMFIntern<font color="#000080">^.</font>CMFInstrNumber <font color="#000080">&gt; </font><font color="#800000">128 </font><font color="#FF0000"><b>THEN BEGIN
       </b></font>CMFErrStat <font color="#000080">:= </font><font color="#800000">400</font><font color="#000080">;
       </font>CMFSetInstruments <font color="#000080">:= </font>FALSE<font color="#000080">;
       </font>Exit<font color="#000080">;
       </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">02</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>CX <font color="#000080">:= </font>CMFIntern<font color="#000080">^.</font>CMFInstrNumber<font color="#000080">;
    </font>Regs<font color="#000080">.</font>DX <font color="#000080">:= </font>Seg<font color="#000080">(</font>CMFBuffer<font color="#000080">^);
    </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font>Ofs<font color="#000080">(</font>CMFBuffer<font color="#000080">^)+</font>CMFIntern<font color="#000080">^.</font>CMFInstrBlockOfs<font color="#000080">;
    </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
    </font>CMFSetInstruments <font color="#000080">:= </font>TRUE<font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFSetSingleInstruments<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFInstrument<font color="#000080">:</font>Pointer<font color="#000080">; </font>No<font color="#000080">:</font>WORD<font color="#000080">):</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Sets SB FM registers to instrument values corresponding to the
  data structure following the CMFInstrument pointer. }
</i></font><font color="#FF0000"><b>BEGIN
    IF </b></font>No <font color="#000080">&gt; </font><font color="#800000">128 </font><font color="#FF0000"><b>THEN BEGIN
       </b></font>CMFErrStat <font color="#000080">:= </font><font color="#800000">400</font><font color="#000080">;
       </font>CMFSetSingleInstruments <font color="#000080">:= </font>FALSE<font color="#000080">;
       </font>Exit<font color="#000080">;
       </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">02</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>CX <font color="#000080">:= </font>No<font color="#000080">;
    </font>Regs<font color="#000080">.</font>DX <font color="#000080">:= </font>Seg<font color="#000080">(</font>CMFInstrument<font color="#000080">^);
    </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font>Ofs<font color="#000080">(</font>CMFInstrument<font color="#000080">^);
    </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
    </font>CMFSetSingleInstruments <font color="#000080">:= </font>TRUE<font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetSysClock<font color="#000080">(</font>Frequency <font color="#000080">: </font>WORD<font color="#000080">);
</font><font color="#008000"><i>{ Sets default value of timer 0 to new value. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">03</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= (</font><font color="#800000">1193180 </font><font color="#FF0000"><b>DIV </b></font>Frequency<font color="#000080">);
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetDriverClock<font color="#000080">(</font>Frequency <font color="#000080">: </font>WORD<font color="#000080">);
</font><font color="#008000"><i>{ Sets driver timer frequency to new value. }

</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">04</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= (</font><font color="#800000">1193180 </font><font color="#FF0000"><b>DIV </b></font>Frequency<font color="#000080">);
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>CMFSetTransposeOfs <font color="#000080">(</font>Offset <font color="#000080">: </font>INTEGER<font color="#000080">);
</font><font color="#008000"><i>{ Transposes all notes in the CMF file by &quot;Offset.&quot; }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">05</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font>Offset<font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFPlaySong<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>CMFBuffer <font color="#000080">: </font>Pointer<font color="#000080">) : </font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Initializes all important parameters and starts song playback. }
</i></font><font color="#FF0000"><b>VAR
   </b></font>Check <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>CMFIntern <font color="#000080">:= </font>CMFBuffer<font color="#000080">;
</font><font color="#008000"><i>{ Set driver clock frequency }
   </i></font>CMFSetDriverClock<font color="#000080">(</font>CMFIntern<font color="#000080">^.</font>CMFClockTicksPS<font color="#000080">);
</font><font color="#008000"><i>{ Set instruments }
   </i></font>Check <font color="#000080">:= </font>CMFSetInstruments<font color="#000080">(</font>CMFBuffer<font color="#000080">);
   </font><font color="#FF0000"><b>IF Not</b></font><font color="#000080">(</font>Check<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>Exit<font color="#000080">;
   </font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">06</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>DX <font color="#000080">:= </font>Seg<font color="#000080">(</font>CMFIntern<font color="#000080">^);
   </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font>Ofs<font color="#000080">(</font>CMFIntern<font color="#000080">^)+</font>CMFIntern<font color="#000080">^.</font>CMFMusicBlockOfs<font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>CMFPlaySong <font color="#000080">:= </font>TRUE<font color="#000080">;
      </font>CMFSongPaused <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font><font color="#FF0000"><b>END
   ELSE BEGIN
      </b></font>CMFPlaySong <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat <font color="#000080">:= </font><font color="#800000">500</font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFStopSong <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Attempts to stop song playback. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">07</font><font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      </b></font>CMFStopSong <font color="#000080">:= </font>TRUE
   <font color="#FF0000"><b>ELSE BEGIN
      </b></font>CMFStopSong <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat  <font color="#000080">:= </font><font color="#800000">510</font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFResetDriver<font color="#000080">:</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Resets driver to starting status. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">08</font><font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      </b></font>CMFResetDriver <font color="#000080">:= </font>TRUE
   <font color="#FF0000"><b>ELSE BEGIN
      </b></font>CMFResetDriver <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat    <font color="#000080">:= </font><font color="#800000">110</font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFPauseSong <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Attempts to pause song playback. If pause is possible, this
  function sets the CMFSongPaused variable to TRUE. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">09</font><font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>CMFPauseSong  <font color="#000080">:= </font>TRUE<font color="#000080">;
      </font>CMFSongPaused <font color="#000080">:= </font>TRUE<font color="#000080">;
      </font><font color="#FF0000"><b>END
   ELSE BEGIN
      </b></font>CMFPauseSong <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat   <font color="#000080">:= </font><font color="#800000">520</font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CMFContinueSong <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ Attempts to continue playback of a paused song. If continuation
  is possible, this function sets CMFSongPaused to FALSE. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">10</font><font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>Regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>CMFContinueSong  <font color="#000080">:= </font>TRUE<font color="#000080">;
      </font>CMFSongPaused    <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font><font color="#FF0000"><b>END
   ELSE BEGIN
      </b></font>CMFContinueSong <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>CMFErrStat      <font color="#000080">:= </font><font color="#800000">530</font><font color="#000080">;

      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F+}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>CMFToolsExitProc<font color="#000080">;
</font><font color="#008000"><i>{$F-}
{ Resets the status byte address, allowing this program to exit.}
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>BX<font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>DX<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>Regs<font color="#000080">.</font>AX<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>Intr<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">, </font>Regs<font color="#000080">);
   </font>ExitProc <font color="#000080">:= </font>OldExitProc<font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
</b></font><font color="#008000"><i>{ Reset old ExitProc to the Tool unit proc }
   </i></font>OldExitProc <font color="#000080">:= </font>ExitProc<font color="#000080">;
   </font>ExitProc <font color="#000080">:= @</font>CMFToolsExitProc<font color="#000080">;
</font><font color="#008000"><i>{ Initialize variables }
   </i></font>CMFErrStat <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>CMFSongPaused <font color="#000080">:= </font>FALSE<font color="#000080">;
</font><font color="#008000"><i>{ Initialize driver }
   </i></font>CMFDriverInstalled <font color="#000080">:= </font>CMFInitDriver<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>CMFDriverInstalled <font color="#FF0000"><b>THEN BEGIN
      </b></font>CMFStatusByte <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>CMFSetStatusByte<font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font><font color="#008000"><i>{ ---------------------    DEMO PROGRAM  -----------------  }

</i></font><font color="#FF0000"><b>Program </b></font>CMFDemo<font color="#000080">;
</font><font color="#008000"><i>{* Demo program for CMFTOOL unit *}
{$M 16384,0,65535}
</i></font><font color="#FF0000"><b>Uses </b></font>CMFTool<font color="#000080">,</font>Crt<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Check      <font color="#000080">: </font>BOOLEAN<font color="#000080">;
   </font>SongName   <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
   </font>SongBuffer <font color="#000080">: </font>CMFDataTyp<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>TextNumError<font color="#000080">;
</font><font color="#008000"><i>{* INPUT   : None; data comes from CMFErrStat global variable
 * OUTPUT  : None
 * PURPOSE : Displays SB error as text, including error number. }
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>Write<font color="#000080">(</font><font color="#800000">' Error #'</font><font color="#000080">,</font>CMFErrStat<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">': '</font><font color="#000080">);
   </font>PrintCMFErrMessage<font color="#000080">;
   </font>WriteLn<font color="#000080">;
   </font>Halt<font color="#000080">(</font>CMFErrStat<font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ClrScr<font color="#000080">;
</font><font color="#008000"><i>{ Displays error if SBFMDRV driver has not been installed }
   </i></font><font color="#FF0000"><b>IF Not </b></font><font color="#000080">(</font>CMFDriverInstalled<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>TextNumError<font color="#000080">;
</font><font color="#008000"><i>{ If no song name is included with command line parameters,
  program searches for the default name (here STARFM.CMF). }
   </i></font><font color="#FF0000"><b>IF </b></font>ParamCount <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN </b></font>SongName <font color="#000080">:= </font><font color="#800000">'STARFM.CMF'
                     </font><font color="#FF0000"><b>ELSE </b></font>SongName <font color="#000080">:= </font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#008000"><i>{ Display driver's version and subversion numbers }
   </i></font>GotoXY<font color="#000080">(</font><font color="#800000">28</font><font color="#000080">,</font><font color="#800000">5</font><font color="#000080">);
   </font>Write  <font color="#000080">(</font><font color="#800000">'SBFMDRV Version '</font><font color="#000080">,</font>Hi<font color="#000080">(</font>CMFGetVersion<font color="#000080">):</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">'.'</font><font color="#000080">);
   </font>WriteLn<font color="#000080">(</font>Lo<font color="#000080">(</font>CMFGetVersion<font color="#000080">):</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">' loaded'</font><font color="#000080">);
</font><font color="#008000"><i>{ Display interrupt number in use }
   </i></font>GotoXY<font color="#000080">(</font><font color="#800000">24</font><font color="#000080">,</font><font color="#800000">10</font><font color="#000080">);
   </font>Write  <font color="#000080">(</font><font color="#800000">'System interrupt (IRQ) '</font><font color="#000080">);
   </font>WriteLn<font color="#000080">(</font>CMFDriverIRQ<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">' in use'</font><font color="#000080">);
   </font>GotoXY<font color="#000080">(</font><font color="#800000">35</font><font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
   </font>WriteLn<font color="#000080">(</font><font color="#800000">'Song Status'</font><font color="#000080">);
   </font>GotoXY<font color="#000080">(</font><font color="#800000">31</font><font color="#000080">,</font><font color="#800000">23</font><font color="#000080">);
   </font>WriteLn<font color="#000080">(</font><font color="#800000">'Song name: '</font><font color="#000080">,</font>SongName<font color="#000080">);
</font><font color="#008000"><i>{ Load song file }
   </i></font>Check <font color="#000080">:= </font>CMFGetSongBuffer<font color="#000080">(</font>SongBuffer<font color="#000080">,</font>SongName<font color="#000080">);
   </font><font color="#FF0000"><b>IF NOT</b></font><font color="#000080">(</font>Check<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>TextNumError<font color="#000080">;
</font><font color="#008000"><i>{ CMFSetTransposeOfs() controls transposition down or up of the loaded song
  (positive values transpose up, negative values transpose down). The value
  0 plays the loaded song in its original key. }
   </i></font>CMFSetTransposeOfs<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">); </font><font color="#008000"><i>{ Experiment with this value }
{ Play song }
   </i></font>Check <font color="#000080">:= </font>CMFPlaySong<font color="#000080">(</font>SongBuffer<font color="#000080">);
   </font><font color="#FF0000"><b>IF NOT</b></font><font color="#000080">(</font>Check<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>TextNumError<font color="#000080">;
</font><font color="#008000"><i>{ During playback, display status byte }
   </i></font><font color="#FF0000"><b>REPEAT
      </b></font>GotoXY<font color="#000080">(</font><font color="#800000">41</font><font color="#000080">,</font><font color="#800000">17</font><font color="#000080">);</font>Write<font color="#000080">(</font>CMFStatusByte<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">);
      </font><font color="#FF0000"><b>UNTIL </b></font><font color="#000080">(</font>KeyPressed <font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>CMFStatusByte <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">));
</font><font color="#008000"><i>{ Stop playback if user presses a key }
   </i></font><font color="#FF0000"><b>IF </b></font>KeyPressed <font color="#FF0000"><b>THEN BEGIN
      </b></font>Check <font color="#000080">:= </font>CMFStopSong<font color="#000080">;
      </font><font color="#FF0000"><b>IF NOT</b></font><font color="#000080">(</font>Check<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>TextNumError<font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Re-initialize driver }
   </i></font>Check <font color="#000080">:= </font>CMFResetDriver<font color="#000080">;
   </font><font color="#FF0000"><b>IF NOT</b></font><font color="#000080">(</font>Check<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>TextNumError<font color="#000080">;
</font><font color="#008000"><i>{ Free song file memory }
   </i></font>Check <font color="#000080">:= </font>CMFFreeSongBuffer<font color="#000080">(</font>SongBuffer<font color="#000080">);
   </font><font color="#FF0000"><b>IF NOT</b></font><font color="#000080">(</font>Check<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>TextNumError<font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p></body>
</html>
