<html>
<head><title> "Soundblaster DSP Unit for Real mode" by MARK FELDMAN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0065.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;4.  I have all my GUS routines working, but can anyone point me to
&gt;a place where I can get ANY *PUBLIC DOMAIN* SB/SBPro code which
&gt;would help me play/mix digital samples?  (I'm not talking CT-VOICE VOC code)

{
  DSP.PAS - A demo SoundBlaster DSP unit for real mode
  By Mark Feldman
}

</i></font><font color="#FF0000"><b>Unit </b></font>DSP<font color="#000080">;

</font><font color="#FF0000"><b>Interface

</b></font><font color="#008000"><i>{ ResetDSP returns true if reset was successful
  base should be 1 for base address 210h, 2 for 220h etc... } </i></font><font color="#FF0000"><b>function
</b></font>ResetDSP<font color="#000080">(</font>base <font color="#000080">: </font>word<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ Write DAC sets the speaker output level } </i></font><font color="#FF0000"><b>procedure </b></font>WriteDAC<font color="#000080">(</font>level <font color="#000080">: </font>byte<font color="#000080">);

</font><font color="#008000"><i>{ ReadDAC reads the microphone input level } </i></font><font color="#FF0000"><b>function </b></font>ReadDAC <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#008000"><i>{ SpeakerOn connects the DAC to the speaker } </i></font><font color="#FF0000"><b>function </b></font>SpeakerOn<font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#008000"><i>{ SpeakerOff disconnects the DAC from the speaker,
  but does not affect the DAC operation } </i></font><font color="#FF0000"><b>function </b></font>SpeakerOff<font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#008000"><i>{ Functions to pause DMA playback }
</i></font><font color="#FF0000"><b>procedure </b></font>DMAStop<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>DMAContinue<font color="#000080">;

</font><font color="#008000"><i>{ Playback plays a sample of a given size back at a given frequency using
  DMA channel 1. The sample must not cross a page boundry } </i></font><font color="#FF0000"><b>procedure
</b></font>Playback<font color="#000080">(</font>sound <font color="#000080">: </font>Pointer<font color="#000080">; </font>size <font color="#000080">: </font>word<font color="#000080">; </font>frequency <font color="#000080">: </font>word<font color="#000080">);

</font><font color="#FF0000"><b>Implementation

Uses </b></font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>var      </b></font>DSP_RESET <font color="#000080">: </font>word<font color="#000080">;
     </font>DSP_READ_DATA <font color="#000080">: </font>word<font color="#000080">;
    </font>DSP_WRITE_DATA <font color="#000080">: </font>word<font color="#000080">;
  </font>DSP_WRITE_STATUS <font color="#000080">: </font>word<font color="#000080">;
    </font>DSP_DATA_AVAIL <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ResetDSP<font color="#000080">(</font>base <font color="#000080">: </font>word<font color="#000080">) : </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>begin

  </b></font>base <font color="#000080">:= </font>base <font color="#000080">* </font><font color="#800000">$10</font><font color="#000080">;

  </font><font color="#008000"><i>{ Calculate the port addresses }
  </i></font>DSP_RESET <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$206</font><font color="#000080">;
  </font>DSP_READ_DATA <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20A</font><font color="#000080">;
  </font>DSP_WRITE_DATA <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20C</font><font color="#000080">;
  </font>DSP_WRITE_STATUS <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20C</font><font color="#000080">;
  </font>DSP_DATA_AVAIL <font color="#000080">:= </font>base <font color="#000080">+ </font><font color="#800000">$20E</font><font color="#000080">;

  </font><font color="#008000"><i>{ Reset the DSP, and give some nice long delays just to be safe }
  </i></font>Port<font color="#000080">[</font>DSP_RESET<font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>DSP_RESET<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Delay<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSP_DATA_AVAIL<font color="#000080">] </font><font color="#FF0000"><b>And </b></font><font color="#800000">$80 </font><font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>DSP_READ_DATA<font color="#000080">] = </font><font color="#800000">$AA</font><font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font>ResetDSP <font color="#000080">:= </font>true
  <font color="#FF0000"><b>else
    </b></font>ResetDSP <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>WriteDSP<font color="#000080">(</font>value <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
  while </b></font>Port<font color="#000080">[</font>DSP_WRITE_STATUS<font color="#000080">] </font><font color="#FF0000"><b>And </b></font><font color="#800000">$80 </font><font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>DSP_WRITE_DATA<font color="#000080">] := </font>value<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ReadDSP <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  while </b></font>Port<font color="#000080">[</font>DSP_DATA_AVAIL<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$80 </font><font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font>ReadDSP <font color="#000080">:= </font>Port<font color="#000080">[</font>DSP_READ_DATA<font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>WriteDAC<font color="#000080">(</font>level <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">);
  </font>WriteDSP<font color="#000080">(</font>level<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ReadDAC <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$20</font><font color="#000080">);
  </font>ReadDAC <font color="#000080">:= </font>ReadDSP<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>SpeakerOn<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$D1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>SpeakerOff<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$D3</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>DMAContinue<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$D4</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>DMAStop<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteDSP<font color="#000080">(</font><font color="#800000">$D0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Playback<font color="#000080">(</font>sound <font color="#000080">: </font>Pointer<font color="#000080">; </font>size <font color="#000080">: </font>word<font color="#000080">; </font>frequency <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>var
</b></font>time_constant <font color="#000080">: </font>word<font color="#000080">;     </font>page<font color="#000080">, </font>offset <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin

  </b></font>SpeakerOn<font color="#000080">;

  </font>size <font color="#000080">:= </font>size <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;

  </font><font color="#008000"><i>{ Set up the DMA chip }
  </i></font>offset <font color="#000080">:= </font>Seg<font color="#000080">(</font>sound<font color="#000080">^) </font><font color="#FF0000"><b>Shl </b></font><font color="#800000">4 </font><font color="#000080">+ </font>Ofs<font color="#000080">(</font>sound<font color="#000080">^);
  </font>page <font color="#000080">:= (</font>Seg<font color="#000080">(</font>sound<font color="#000080">^) + </font>Ofs<font color="#000080">(</font>sound<font color="#000080">^) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">12</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">5</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0C</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$0B</font><font color="#000080">] := </font><font color="#800000">$49</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>offset<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$83</font><font color="#000080">] := </font>page<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$03</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>size<font color="#000080">);
  </font>Port<font color="#000080">[</font><font color="#800000">$0A</font><font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;

  </font><font color="#008000"><i>{ Set the playback frequency }
  </i></font>time_constant <font color="#000080">:= </font><font color="#800000">256 </font><font color="#000080">- </font><font color="#800000">1000000 </font><font color="#FF0000"><b>div </b></font>frequency<font color="#000080">;
  </font>WriteDSP<font color="#000080">(</font><font color="#800000">$40</font><font color="#000080">);
  </font>WriteDSP<font color="#000080">(</font>time_constant<font color="#000080">);

  </font><font color="#008000"><i>{ Set the playback type (8-bit) }
  </i></font>WriteDSP<font color="#000080">(</font><font color="#800000">$14</font><font color="#000080">);
  </font>WriteDSP<font color="#000080">(</font>Lo<font color="#000080">(</font>size<font color="#000080">));
  </font>WriteDSP<font color="#000080">(</font>Hi<font color="#000080">(</font>size<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0065.PAS">Original</a><b>]</b></p></body>
</html>
