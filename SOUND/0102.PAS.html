<html>
<head><title> "Access FM Sound on SB/Adlib Cards" by JACK NEELY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0102.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>FM<font color="#000080">;

</font><font color="#008000"><i>{Version 1.0

Copyright 1996 Jack Neely

This unit was written by Jack Neely using Borland's Turbo
Pascal 7.0.  You may contact me for any reason using the
e-mail address hneely@ac.net

This unit takes advantage of the FM sound abilities of the
Adlib/Sound Blaster and compatible sound cards.  All the
procedures below should be self explanatory to those who
know a little of creating FM sound.  Documentation to help
you understand FM sound and that I used in writing this unit
can be found on my Pascal page at

http://www.ac.net/~hneely/pascal/

The rhythm parts of FM sound I do not fully understand.  They
are supported in this unit but un-tested.  Any pointers on how
to uses these would be welcome.  If you find any bugs please
let me know.  Bugs that I can confirm will be corrected
and a new version of this unit will become available.

I ask that you do not change this unit without my permission.
All improvements I want to make so that I can make a new version
of this unit available as I said before.

I would like to give note to Jeffery S. Lee.  Without his
documentation of the OPL2 chip I would not have been able to
write this.  His documentation is available on my Pascal Page.
I would also like to thank R. E. Donais for pointing out my
stupid mistakes and for a bit of wisdom.

I hope you enjoy this unit and that it satisfies your FM
programming needs.  Please contact me and tell me what you
think!

Jack Neely
hneely@ac.net
http://www.ac.net/~hneely/                                   }

</i></font><font color="#FF0000"><b>interface

const
   </b></font><font color="#008000"><i>{  Note constants.  &quot;s&quot; implies a sharp.  Use for the PITCH parameter
   in the KEY_ON procedure.}
   </i></font>Cs <font color="#000080">= </font><font color="#800000">$16B</font><font color="#000080">; </font>Db <font color="#000080">= </font><font color="#800000">$16B</font><font color="#000080">;
   </font>D <font color="#000080">=  </font><font color="#800000">$181</font><font color="#000080">;
   </font>Ds <font color="#000080">= </font><font color="#800000">$198</font><font color="#000080">; </font>Eb <font color="#000080">= </font><font color="#800000">$198</font><font color="#000080">;
   </font>E <font color="#000080">=  </font><font color="#800000">$1B0</font><font color="#000080">;
   </font>F <font color="#000080">=  </font><font color="#800000">$1CA</font><font color="#000080">;
   </font>Fs <font color="#000080">= </font><font color="#800000">$1E5</font><font color="#000080">; </font>Gb <font color="#000080">= </font><font color="#800000">$1E5</font><font color="#000080">;
   </font>A <font color="#000080">=  </font><font color="#800000">$241</font><font color="#000080">;
   </font><font color="#FF0000"><b>As </b></font><font color="#000080">= </font><font color="#800000">$263</font><font color="#000080">; </font>Bb <font color="#000080">= </font><font color="#800000">$263</font><font color="#000080">;
   </font>B <font color="#000080">= </font><font color="#800000">$287</font><font color="#000080">;
   </font>C <font color="#000080">= </font><font color="#800000">$2AE</font><font color="#000080">;
   </font><font color="#008000"><i>{  Offset array.  Offsets[operator, channel]  This is to be used for
      the offsets in the procedures below.  It calculates the correct
      channel and operator.}
   </i></font>Offsets <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word <font color="#000080">=
      ((</font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$08</font><font color="#000080">, </font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$10</font><font color="#000080">, </font><font color="#800000">$11</font><font color="#000080">, </font><font color="#800000">$12</font><font color="#000080">),
       (</font><font color="#800000">$03</font><font color="#000080">, </font><font color="#800000">$04</font><font color="#000080">, </font><font color="#800000">$05</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$0C</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$13</font><font color="#000080">, </font><font color="#800000">$14</font><font color="#000080">, </font><font color="#800000">$15</font><font color="#000080">));
   </font><font color="#008000"><i>{Main IO ports for Adlib/Sound Blaster}
   </i></font>IOPort <font color="#000080">= </font><font color="#800000">$388</font><font color="#000080">;
   </font>IODataPort <font color="#000080">= </font><font color="#800000">$389</font><font color="#000080">;

</font><font color="#FF0000"><b>type
   </b></font>FMregisters <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">244</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;

</font><font color="#FF0000"><b>var
   </b></font>IsSound<font color="#000080">:</font>boolean<font color="#000080">;             </font><font color="#008000"><i>{True if sound card detected else false.}
   </i></font>FMdata<font color="#000080">:</font>FMregisters<font color="#000080">;           </font><font color="#008000"><i>{Contains the data in the FM registers.}
      {You cannot set the registers by changing the values in this array
       directly, you must call the apporpiate procedure.  This only stores
       the data curently in the registers sence they are write only.}

</i></font><font color="#FF0000"><b>procedure Out</b></font><font color="#000080">(</font>p<font color="#000080">:</font>word<font color="#000080">; </font>reg<font color="#000080">:</font>byte<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{Procedure Out sends VALUE to REG (register) using ports P and P + 1}
</i></font><font color="#FF0000"><b>procedure </b></font>resetFM<font color="#000080">;
   </font><font color="#008000"><i>{Resets the sound card by writing 0 to all registers.}
</i></font><font color="#FF0000"><b>procedure </b></font>setvibrato<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>bit<font color="#000080">, </font>vd<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{Changes the vibrato bit to the value of BIT. If VD is true the vibrato
   is set at 14 cent else 7 cent.  If BIT is false, VD is a dummy.  OFFSET
   controls channel and operator.}
</i></font><font color="#FF0000"><b>procedure </b></font>amplitude_modulation<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>bit<font color="#000080">, </font>AMd<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{Applies amplitued modulation when BIT is true.  When AMD is true depth
   is 4.8dB else 1 dB.  If BIT is false AMD is a dummy.  OFFSET controls
   channel and operator.}
</i></font><font color="#FF0000"><b>procedure </b></font>setsustain<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>bit<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{When BIT is true the sustain level is maintained until released, else
   the sound begins to decay after susatin phase is hit.}
</i></font><font color="#FF0000"><b>procedure </b></font>set_harmonic_op<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{VALUE controls what harmonic multiple sound (or modulation) will be
   produced.
                      0 - one octave below
                      1 - at the voice's specified frequency
                      2 - one octave above
                      3 - an octave and a fifth above
                      4 - two octaves above
                      5 - two octaves and a major third above
                      6 - two octaves and a fifth above
                      7 - two octaves and a minor seventh above
                      8 - three octaves above
                      9 - three octaves and a major second above
                      A - three octaves and a major third above
                      B -  &quot;       &quot;     &quot;  &quot;   &quot;     &quot;     &quot;
                      C - three octaves and a fifth above
                      D -   &quot;      &quot;     &quot;  &quot;   &quot;     &quot;
                      E - three octaves and a major seventh above
                      F -   &quot;      &quot;     &quot;  &quot;   &quot;      &quot;      &quot;  }
</i></font><font color="#FF0000"><b>procedure </b></font>setvolume<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{BYTE must be in the range of [0..63] (decimal).  0 is loudest 63
   is softest.}
</i></font><font color="#FF0000"><b>procedure </b></font>attackrate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{VALUE must be in rang of [0..F] (hex).  0 is slowest, F is shortest.}
</i></font><font color="#FF0000"><b>procedure </b></font>decayrate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{Same as attackrate.}
</i></font><font color="#FF0000"><b>procedure </b></font>sustain_level<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{VALUE must be in rang of [0..F] (hex). 0 is loudest, F is softest.}
</i></font><font color="#FF0000"><b>procedure </b></font>release_rate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{VALUE must be in rang of [0..F] (hex). 0 is slowest, F is fastest.}
</i></font><font color="#FF0000"><b>procedure </b></font>waveform<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{Changes waveform.  Diagram below.  Numbers are in binary.
         ___              ___            ___    ___       _      _
        /   \            /   \          /   \  /   \     / |    / |
       /_____\_______   /_____\_____   /_____\/_____\   /__|___/__|___
              \     /
               \___/

            00              01               10               11
    }
</i></font><font color="#FF0000"><b>procedure </b></font>scalling_rate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{Causes output level to decrease as frequency rises. Numbers are in binary.
                          00   -  no change
                          10   -  1.5 dB/8ve
                          01   -  3 dB/8ve
                          11   -  6 dB/8ve
   }
</i></font><font color="#FF0000"><b>procedure </b></font>feedback<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
   </font><font color="#008000"><i>{Feedback strength.  Value must be in the range [1..7].  0 is the
   least ad 7 is the greatest.  CHANNLE is the channel affected.}
</i></font><font color="#FF0000"><b>procedure </b></font>connection<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{If FALSE operator 1 modulates operator 2, therefore operator 2 is the
   only one producing sound.  If TRUE both operators produce sound
   directly.  Create complex sounds by setting to FALSE.  CHANNEL is the
   channel affected.}
</i></font><font color="#FF0000"><b>procedure </b></font>key_on<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">; </font>octave<font color="#000080">:</font>byte<font color="#000080">; </font>pitch<font color="#000080">:</font>word<font color="#000080">);
   </font><font color="#008000"><i>{Sounds note.  OCTAVE is [0..7] where 4 contains middle C.  Pitch
   is a note constant defined above.  CHANNEL is the channel to sound
   note on.}
</i></font><font color="#FF0000"><b>procedure </b></font>key_off<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">);
   </font><font color="#008000"><i>{Truns note off.}
</i></font><font color="#FF0000"><b>procedure </b></font>rhythm<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{If VALUE true then rhythm is enabled, else disenabled.  When enabled,
   KEY-ON bits for channels 6 - 8 must be off.  6 melodic voices.  Other
   parameters such as attack/decay/sustain/release must be set appropriately.
   When disenabled, 9 melodic voices.}
</i></font><font color="#FF0000"><b>procedure </b></font>bass_drum<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{Bass drum on/off.}
</i></font><font color="#FF0000"><b>procedure </b></font>Snare_drum<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{Snare on/off}
</i></font><font color="#FF0000"><b>procedure </b></font>Tom_tom<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{Tom tom on/off}
</i></font><font color="#FF0000"><b>procedure </b></font>cymbal<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{Cymbal on/off}
</i></font><font color="#FF0000"><b>procedure </b></font>Hi_Hat<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
   </font><font color="#008000"><i>{Hi hat on/off}

</i></font><font color="#FF0000"><b>implementation  </b></font><font color="#008000"><i>{Documentation ENDS here.}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>MyDelay<font color="#000080">(</font>Clocks<font color="#000080">: </font>Longint<font color="#000080">);
</font><font color="#FF0000"><b>VAR
   </b></font>Elapsed<font color="#000080">: </font>Longint<font color="#000080">;
   </font>Last<font color="#000080">, </font>Next<font color="#000080">, </font>NCopy<font color="#000080">, </font>Diff<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Elapsed <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
   </font>Last <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">];
   </font>Last <font color="#000080">:= </font><font color="#FF0000"><b>NOT</b></font><font color="#000080">((</font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] </font><font color="#FF0000"><b>shl </b></font><font color="#800000">8</font><font color="#000080">) + </font>Last<font color="#000080">);
   </font><font color="#FF0000"><b>REPEAT
      </b></font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
      </font>Next <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">];
      </font>Next <font color="#000080">:= </font><font color="#FF0000"><b>NOT</b></font><font color="#000080">((</font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] </font><font color="#FF0000"><b>shl </b></font><font color="#800000">8</font><font color="#000080">) + </font>Next<font color="#000080">);
      </font>NCopy <font color="#000080">:= </font>Next<font color="#000080">;
      </font>Dec<font color="#000080">(</font>Next<font color="#000080">, </font>Last<font color="#000080">);
      </font>Inc<font color="#000080">(</font>Elapsed<font color="#000080">, </font>Next<font color="#000080">);
      </font>Last <font color="#000080">:= </font>NCopy<font color="#000080">;
   </font><font color="#FF0000"><b>UNTIL </b></font>Elapsed <font color="#000080">&gt;= </font>Clocks<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure out</b></font><font color="#000080">(</font>p<font color="#000080">:</font>word<font color="#000080">; </font>reg<font color="#000080">:</font>byte<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>port<font color="#000080">[</font>p<font color="#000080">]:= </font>reg<font color="#000080">;
   </font>mydelay<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">);
   </font>port<font color="#000080">[</font>p<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]:= </font>value<font color="#000080">;
   </font>mydelay<font color="#000080">(</font><font color="#800000">55</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>detect<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>sound<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>store1<font color="#000080">, </font>store2<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   out</b></font><font color="#000080">(</font>IOport<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">$60</font><font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">$80</font><font color="#000080">);
   </font>store1<font color="#000080">:= </font>port<font color="#000080">[</font><font color="#800000">$388</font><font color="#000080">];
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">$FF</font><font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">$21</font><font color="#000080">);
   </font>mydelay<font color="#000080">(</font><font color="#800000">191</font><font color="#000080">);
   </font>store2<font color="#000080">:= </font>port<font color="#000080">[</font><font color="#800000">$388</font><font color="#000080">];
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">$60</font><font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">$80</font><font color="#000080">);
   </font>sound<font color="#000080">:= ((</font>store1 <font color="#FF0000"><b>and </b></font><font color="#800000">$E0 </font><font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>store2 <font color="#FF0000"><b>and </b></font><font color="#800000">$E0 </font><font color="#000080">= </font><font color="#800000">$C0</font><font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setbit<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>b<font color="#000080">:</font>byte<font color="#000080">; </font>bit<font color="#000080">:</font>integer<font color="#000080">; </font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>c<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>c<font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>value <font color="#FF0000"><b>then
      </b></font>b<font color="#000080">:= </font>b <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>c <font color="#FF0000"><b>shl </b></font>bit<font color="#000080">)
   </font><font color="#FF0000"><b>else
      </b></font>b<font color="#000080">:= </font>b <font color="#FF0000"><b>and not</b></font><font color="#000080">(</font>c <font color="#FF0000"><b>shl </b></font>bit<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>resetFM<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>i<font color="#000080">:</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
   for </b></font>i<font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">244 </font><font color="#FF0000"><b>do
      begin
         out</b></font><font color="#000080">(</font>IOport<font color="#000080">, </font>i<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
         </font>FMdata<font color="#000080">[</font>i<font color="#000080">]:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font><font color="#800000">5</font><font color="#000080">, </font>true<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>IOport<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setvibrato<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>bit<font color="#000080">, </font>vd<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">], </font><font color="#800000">6</font><font color="#000080">, </font>bit<font color="#000080">);
   </font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">6</font><font color="#000080">, </font>vd<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">]);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>amplitude_modulation<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>bit<font color="#000080">, </font>amd<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">], </font><font color="#800000">7</font><font color="#000080">, </font>bit<font color="#000080">);
   </font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">7</font><font color="#000080">, </font>amd<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">]);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setsustain<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>bit<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">], </font><font color="#800000">5</font><font color="#000080">, </font>bit<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>set_harmonic_op<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">]:= </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">240</font><font color="#000080">;
   </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">]:= </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">] + </font>value<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$20</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setvolume<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">]:= </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">192</font><font color="#000080">;
   </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">]:= </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">] + </font>value<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>attackrate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>temp<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>temp<font color="#000080">:= </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">;
   </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">]:= (</font>value <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">) + </font>temp<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>decayrate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">]:= (</font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">240</font><font color="#000080">) + </font>value<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$60</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>sustain_level<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>temp<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>temp<font color="#000080">:= </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">;
   </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">]:= (</font>value <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">) + </font>temp<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>release_rate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">]:= (</font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">240</font><font color="#000080">) + </font>value<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$80</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>waveform<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$E0</font><font color="#000080">]:= </font>value<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$E0</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$E0</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>scalling_rate<font color="#000080">(</font>offset<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>temp<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>temp<font color="#000080">:= </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">63</font><font color="#000080">;
   </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">]:= (</font>value <font color="#FF0000"><b>shl </b></font><font color="#800000">6</font><font color="#000080">) + </font>temp<font color="#000080">;
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>offset<font color="#000080">+</font><font color="#800000">$40</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>feedback<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>channel<font color="#000080">:= </font>channel <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
   </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$C0</font><font color="#000080">]:= (</font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$C0</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">241</font><font color="#000080">) + (</font>value <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>channel<font color="#000080">+</font><font color="#800000">$C0</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$C0</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>connection<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">; </font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>channel<font color="#000080">:= </font>channel <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
   </font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$C0</font><font color="#000080">], </font><font color="#800000">0</font><font color="#000080">, </font>value<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>channel<font color="#000080">+</font><font color="#800000">$C0</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$C0</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>key_on<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">; </font>octave<font color="#000080">:</font>byte<font color="#000080">; </font>pitch<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>highpitch<font color="#000080">,
   </font>lowpitch<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>lowpitch<font color="#000080">:= </font>pitch <font color="#FF0000"><b>and </b></font><font color="#800000">$00FF</font><font color="#000080">;
   </font>highpitch<font color="#000080">:= (</font>pitch <font color="#FF0000"><b>and </b></font><font color="#800000">$FF00</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">8</font><font color="#000080">;
   </font>channel<font color="#000080">:= </font>channel <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
   </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$B0</font><font color="#000080">]:= (</font>octave <font color="#FF0000"><b>shl </b></font><font color="#800000">2</font><font color="#000080">) + </font>highpitch<font color="#000080">;
   </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$A0</font><font color="#000080">]:= </font>lowpitch<font color="#000080">;
   </font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$B0</font><font color="#000080">], </font><font color="#800000">5</font><font color="#000080">, </font>true<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>channel<font color="#000080">+</font><font color="#800000">$A0</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$A0</font><font color="#000080">]);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>channel<font color="#000080">+</font><font color="#800000">$B0</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$B0</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>key_off<font color="#000080">(</font>channel<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>channel<font color="#000080">:= </font>channel <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
   </font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$B0</font><font color="#000080">], </font><font color="#800000">5</font><font color="#000080">, </font>false<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font>channel<font color="#000080">+</font><font color="#800000">$B0</font><font color="#000080">, </font>FMdata<font color="#000080">[</font>channel<font color="#000080">+</font><font color="#800000">$B0</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>rhythm<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">5</font><font color="#000080">, </font>value<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>bass_drum<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">4</font><font color="#000080">, </font>value<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>snare_drum<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">3</font><font color="#000080">, </font>value<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Tom_tom<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">2</font><font color="#000080">, </font>value<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>cymbal<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">1</font><font color="#000080">, </font>value<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Hi_hat<font color="#000080">(</font>value<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>setbit<font color="#000080">(</font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">], </font><font color="#800000">0</font><font color="#000080">, </font>value<font color="#000080">);
   </font><font color="#FF0000"><b>out</b></font><font color="#000080">(</font>ioport<font color="#000080">, </font><font color="#800000">$BD</font><font color="#000080">, </font>FMdata<font color="#000080">[</font><font color="#800000">$BD</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{initialization}
</i></font><font color="#FF0000"><b>begin
   </b></font>detect<font color="#000080">(</font>IsSound<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>IsSound <font color="#FF0000"><b>then
      </b></font>resetFM<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0102.PAS">Original</a><b>]</b></p></body>
</html>
