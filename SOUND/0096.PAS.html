<html>
<head><title> "Silence Speaker Sound" by ARNE DE BRUIJN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
If you want absolute silence (no ticks and very short beeps you get with the
timer interrupt approach), and you are running QEMM 7.03 or higher, you can
use this.If anyone is interested, I have also some sources with the same
routines to capture IO access under QEMM.
===
{ NoSound, PC Speaker sound killer for QEMM 7.03+, Arne de Bruijn, 19960405. }
{ Released to the Public Domain. }
{ Run it to install, run with /U to remove it. }
{$G+}
</i></font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">;
</font><font color="#008000"><i>{ Resident part }
{ Only code segment will be preserved, so necessary variables are stored here
}</i></font><font color="#FF0000"><b>procedure </b></font>QPI_CS<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">db 0,0,0; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>OldTrap_CS<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>OldIOTrap_CS<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">db 0,0,0; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>MyTrap<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#008000"><i>{ Called when something accesses port $61 }
</i></font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">test cl,4      </font><font color="#008000"><i>{ Is the program writing to port $61? }
 </i></font><font color="#FF00FF">jne @IsWrite   </font><font color="#008000"><i>{ Yes, jump to @IsWrite }
 </i></font><font color="#FF00FF">push bx
 mov bx,ax
 mov ax,1a05h   </font><font color="#008000"><i>{ Pass port read to QEMM, to execute it }
 </i></font><font color="#FF00FF">call dword ptr cs:[QPI_CS]
 mov ax,bx
 pop bx
 retf
@IsWrite:
 and al,not 2   </font><font color="#008000"><i>{ Clear speaker bits, so it's always off }
 </i></font><font color="#FF00FF">push bx
 mov bx,ax
 mov ax,1a05h   </font><font color="#008000"><i>{ Pass port write to QEMM, to execute it }
 </i></font><font color="#FF00FF">call dword ptr cs:[QPI_CS]
 mov ax,bx
 pop bx
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>End_Of_TSR_Label<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">; </font><font color="#FF0000"><b>asm end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>type
 </b></font>TPtr<font color="#000080">=</font><font color="#FF0000"><b>record </b></font>Ofs<font color="#000080">,</font>Seg<font color="#000080">:</font>word<font color="#000080">; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>const
 </b></font>QPI<font color="#000080">:</font>pointer<font color="#000080">=</font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>GetQemmApi<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>QPI<font color="#000080">:</font>pointer<font color="#000080">):</font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ah,3fh
 mov cx,'QE'
 mov dx,'MM'
 int 67h
 mov al,0
 test ah,ah
 jnz @NoQemm
 mov ax,di
 mov dx,es
 cld
 les di,QPI
 stosw
 mov ax,dx
 stosw
 mov al,1
@NoQemm:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>QPI_SetIOCallback<font color="#000080">(</font>IOCallback<font color="#000080">:</font>pointer<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,1a07h
 les di,IOCallback
 call [QPI]
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>QPI_GetPortTrap<font color="#000080">(</font>PortNo<font color="#000080">:</font>word<font color="#000080">):</font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,1a08h
 mov dx,PortNo
 call [QPI]
 mov al,bl
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>QPI_SetPortTrap<font color="#000080">(</font>PortNo<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,1a09h
 mov dx,PortNo
 call [QPI]
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>QPI_ClearPortTrap<font color="#000080">(</font>PortNo<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,1a0ah
 mov dx,PortNo
 call [QPI]
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>QPI_GetVersion<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Version<font color="#000080">:</font>word<font color="#000080">):</font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,word ptr [QPI]
 or ax,word ptr [QPI+2]
 jz @NoQemm
 mov ah,3
 call [QPI]
 jc @NoQemm
 les di,Version
 stosw
 mov al,1
 db 0a9h </font><font color="#008000"><i>{ Skip following instruction (2 bytes) }
</i></font><font color="#FF00FF">@NoQemm:
 mov al,0
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>QPI_GetIOCallback<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>IOCallBack<font color="#000080">:</font>pointer<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov ax,1a06h
 call [QPI]
 mov ax,di
 mov dx,es
 cld
 les di,IOCallBack
 stosw
 mov ax,dx
 stosw
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
 </b></font>W<font color="#000080">:</font>word<font color="#000080">;
 </font>OldIOTrap<font color="#000080">:</font>pointer<font color="#000080">;
 </font>S<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
</font><font color="#FF0000"><b>begin
 if not </b></font>GetQemmApi<font color="#000080">(</font>QPI<font color="#000080">) </font><font color="#FF0000"><b>then
  begin </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'QEMM not installed!'</font><font color="#000080">); </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">); </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>pointer<font color="#000080">((@</font>QPI_CS<font color="#000080">)^):=</font>QPI<font color="#000080">;
 </font><font color="#FF0000"><b>if not </b></font>QPI_GetVersion<font color="#000080">(</font>W<font color="#000080">) </font><font color="#FF0000"><b>then
  begin </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'QPI_GetVersion error!'</font><font color="#000080">); </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">); </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>if </b></font>W<font color="#000080">&lt;</font><font color="#800000">$0703 </font><font color="#FF0000"><b>then
  begin </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Need QEMM 7.03+'</font><font color="#000080">); </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">); </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>QPI_GetIOCallback<font color="#000080">(</font>OldIOTrap<font color="#000080">); </font><font color="#008000"><i>{ Get current IO trap function }
 </i></font><font color="#FF0000"><b>if </b></font>word<font color="#000080">(</font>OldIOTrap<font color="#000080">)=</font>Ofs<font color="#000080">(</font>MyTrap<font color="#000080">) </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ Ours? }
  </i></font><font color="#FF0000"><b>begin
   </b></font>S<font color="#000080">:=</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">); </font>S<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]:=</font>Upcase<font color="#000080">(</font>S<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]);
   </font><font color="#FF0000"><b>if </b></font>S<font color="#000080">&lt;&gt;</font><font color="#800000">'/U' </font><font color="#FF0000"><b>then
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'NoSound already installed! Use /U to unload.'</font><font color="#000080">)
   </font><font color="#FF0000"><b>else
    begin
     </b></font><font color="#008000"><i>{ Restore port trap state }
     </i></font><font color="#FF0000"><b>if not </b></font>boolean<font color="#000080">(</font>ptr<font color="#000080">(</font>TPtr<font color="#000080">(</font>OldIOTrap<font color="#000080">).</font>Seg<font color="#000080">,</font>ofs<font color="#000080">(</font>OldTrap_CS<font color="#000080">))^) </font><font color="#FF0000"><b>then
      </b></font>QPI_ClearPortTrap<font color="#000080">(</font><font color="#800000">$61</font><font color="#000080">);
     </font>QPI_SetIOCallback<font color="#000080">(</font>pointer<font color="#000080">(</font>ptr<font color="#000080">(</font>TPtr<font color="#000080">(</font>OldIOTrap<font color="#000080">).</font>Seg<font color="#000080">,</font>ofs<font color="#000080">(</font>OldIOTrap_CS<font color="#000080">))^));
     </font>W<font color="#000080">:=</font>TPtr<font color="#000080">(</font>OldIOTrap<font color="#000080">).</font>Seg<font color="#000080">-</font><font color="#800000">$10</font><font color="#000080">;  </font><font color="#008000"><i>{ TSR PSP segment (just under code segment)
}     </i></font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov ah,49h         </font><font color="#008000"><i>{ DOS function 'Free memory block' }
      </i></font><font color="#FF00FF">mov es,W           </font><font color="#008000"><i>{ Get TSR PSP segment }
      </i></font><font color="#FF00FF">push es            </font><font color="#008000"><i>{ Save it }
      </i></font><font color="#FF00FF">mov es,es:[2ch]    </font><font color="#008000"><i>{ Get TSR environment segment }
      </i></font><font color="#FF00FF">int 21h            </font><font color="#008000"><i>{ Free it }
      </i></font><font color="#FF00FF">mov ah,49h         </font><font color="#008000"><i>{ Again 'Free memory block' }
      </i></font><font color="#FF00FF">pop es             </font><font color="#008000"><i>{ Restore TSR PSP segment }
      </i></font><font color="#FF00FF">int 21h            </font><font color="#008000"><i>{ Free it }
     </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>WriteLn<font color="#000080">(</font><font color="#800000">'NoSound removed.'</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Halt<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>QPI_SetIOCallback<font color="#000080">(@</font>MyTrap<font color="#000080">);
 </font>pointer<font color="#000080">((@</font>OldIOTrap_CS<font color="#000080">)^):=</font>OldIOTrap<font color="#000080">;
 </font>boolean<font color="#000080">((@</font>OldTrap_CS<font color="#000080">)^):=</font>QPI_GetPortTrap<font color="#000080">(</font><font color="#800000">$61</font><font color="#000080">);
 </font>QPI_SetPortTrap<font color="#000080">(</font><font color="#800000">$61</font><font color="#000080">);
 </font>WriteLn<font color="#000080">(</font><font color="#800000">'NoSound installed.'</font><font color="#000080">);
 </font>swapvectors<font color="#000080">;
 </font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,3100h   </font><font color="#008000"><i>{ DOS function 'Terminate and stay resident' }
  </i></font><font color="#FF00FF">mov dx,offset End_Of_Tsr_Label+15+256  </font><font color="#008000"><i>{ Calculate resident size }
  </i></font><font color="#FF00FF">shr dx,4       </font><font color="#008000"><i>{ Scale down to paragraphs }
  </i></font><font color="#FF00FF">int 21h        </font><font color="#008000"><i>{ Go TSR }
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SOUND SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p></body>
</html>
