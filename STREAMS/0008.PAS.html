<html>
<head><title> "LARGE MEMORY STREAMS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to STREAMS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
  Streams : stream su aree di memoria.
}
</i></font><font color="#FF0000"><b>unit </b></font>Streams<font color="#000080">;

</font><font color="#008000"><i>{$V-}
{$IFDEF Final}        { Remove debug code for final version}
{$D-,I-,L-,R-,S-,G+}
{$ELSE}
{$D+,I+,L+,R+,S+}
{$ENDIF}

</i></font><font color="#FF0000"><b>interface

uses
  </b></font>Objects<font color="#000080">,
  </font>Strings<font color="#000080">,
  </font>Arit<font color="#000080">;

</font><font color="#008000"><i>{--------------------- Classe TMemStream : stream su aree di memoria (&lt; 64KB) }

</i></font><font color="#FF0000"><b>type
  </b></font>PMemStream <font color="#000080">= ^</font>TMemStream<font color="#000080">;
  </font>TMemStream <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TStream<font color="#000080">)
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>BlockPtr <font color="#000080">: </font>PChar<font color="#000080">; </font>BlockSize <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetPos <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetSize <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Read<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Seek<font color="#000080">(</font>Pos <font color="#000080">: </font>longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Truncate<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>private
    </b></font>StartPtr<font color="#000080">,</font>CurPtr <font color="#000080">: </font>PChar<font color="#000080">;
    </font>Size <font color="#000080">: </font>word<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{------------------ Classe TBigMemStream : stream su aree di memoria (&gt; 64KB) }

</i></font><font color="#FF0000"><b>type
  </b></font>TLongRec <font color="#000080">= </font><font color="#FF0000"><b>record
    case </b></font>integer <font color="#FF0000"><b>of
      </b></font><font color="#800000">0 </font><font color="#000080">: (</font>L <font color="#000080">: </font>longint<font color="#000080">);
      </font><font color="#800000">1 </font><font color="#000080">: (</font>LoW <font color="#000080">: </font>word<font color="#000080">;
           </font>HiW <font color="#000080">: </font>word<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PBigMemStream <font color="#000080">= ^</font>TBigMemStream<font color="#000080">;
  </font>TBigMemStream <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TStream<font color="#000080">)
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>BlockPtr <font color="#000080">: </font>PChar<font color="#000080">; </font>BlockSize <font color="#000080">: </font>longint<font color="#000080">);
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetPos <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetSize <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Read<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Seek<font color="#000080">(</font>Pos <font color="#000080">: </font>longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Truncate<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>private
    </b></font>MemOfs <font color="#000080">: </font>word<font color="#000080">;
    </font>MemSeg <font color="#000080">: </font>word<font color="#000080">;
    </font>CurPos <font color="#000080">: </font>TLongRec<font color="#000080">;
    </font>Size <font color="#000080">: </font>longint<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------- Classe TBuffer : buffer dinamici }

</i></font><font color="#FF0000"><b>type
  </b></font>PBuffer <font color="#000080">= ^</font>TBuffer<font color="#000080">;
  </font>TBuffer <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TObject<font color="#000080">)
    </font>Size<font color="#000080">,</font>Len<font color="#000080">,</font>AllocSize <font color="#000080">: </font>word<font color="#000080">;
    </font>BufPtr <font color="#000080">: </font>PChar<font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>StartSize<font color="#000080">,</font>Alloc <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetLen <font color="#000080">: </font>word<font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetBuffer <font color="#000080">: </font>PChar<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Append<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Insert<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">; </font>Pos <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>AppendChar<font color="#000080">(</font>C <font color="#000080">: </font>char<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>AppendStr<font color="#000080">(</font>S <font color="#000080">: </font>PChar<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Overwrite<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">; </font>Pos <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Reset<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Truncate<font color="#000080">(</font>NewLen <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Delete<font color="#000080">(</font>From<font color="#000080">,</font>N <font color="#000080">: </font>word<font color="#000080">);
  </font><font color="#FF0000"><b>private
    procedure </b></font>Realloc<font color="#000080">(</font>NewLen <font color="#000080">: </font>word<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{--------------- Classe TAllocStream : stream di scrittura su buffer dinamici }

</i></font><font color="#FF0000"><b>type
  </b></font>PAllocStream <font color="#000080">= ^</font>TAllocStream<font color="#000080">;
  </font>TAllocStream <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TStream<font color="#000080">)
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>StartSize<font color="#000080">,</font>Alloc <font color="#000080">: </font>word<font color="#000080">);
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetPos <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetSize <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Seek<font color="#000080">(</font>Pos <font color="#000080">: </font>longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Truncate<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetBuffer <font color="#000080">: </font>PChar<font color="#000080">;
  </font><font color="#FF0000"><b>private
    </b></font>CurPos <font color="#000080">: </font>word<font color="#000080">;
    </font>Buffer <font color="#000080">: </font>TBuffer<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------- Classe TSCollection : collection non ordinate di stringhe  }

</i></font><font color="#FF0000"><b>type
  </b></font>PSCollection <font color="#000080">= ^</font>TSCollection<font color="#000080">;
  </font>TSCollection <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TCollection<font color="#000080">)
    </font><font color="#FF0000"><b>procedure </b></font>FreeItem<font color="#000080">(</font>Item <font color="#000080">: </font>pointer<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{-------------------------- Classe TErrCollection : gestione error metodo At  }

</i></font><font color="#FF0000"><b>type
  </b></font>PErrCollection <font color="#000080">= ^</font>TErrCollection<font color="#000080">;
  </font>TErrCollection <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TCollection<font color="#000080">)
    </font><font color="#FF0000"><b>procedure </b></font>Error<font color="#000080">(</font>Code<font color="#000080">,</font>Info <font color="#000080">: </font>integer<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation </b></font><font color="#008000"><i>{==============================================================}

</i></font><font color="#FF0000"><b>uses
  </b></font>WinTypes<font color="#000080">,
  </font>WinProcs<font color="#000080">;

</font><font color="#008000"><i>{----------------- Metodi di TMemStream : stream su aree di memoria (&lt; 64 KB) }

</i></font><font color="#FF0000"><b>constructor </b></font>TMemStream<font color="#000080">.</font>Init<font color="#000080">(</font>BlockPtr <font color="#000080">: </font>PChar<font color="#000080">; </font>BlockSize <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  inherited </b></font>Init<font color="#000080">;
  </font>StartPtr <font color="#000080">:= </font>BlockPtr<font color="#000080">;
  </font>CurPtr <font color="#000080">:= </font>BlockPtr<font color="#000080">;
  </font>Size <font color="#000080">:= </font>BlockSize<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Init }

</i></font><font color="#FF0000"><b>destructor </b></font>TMemStream<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>StartPtr <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>CurPtr <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>Size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Done }

</i></font><font color="#FF0000"><b>function </b></font>TMemStream<font color="#000080">.</font>GetPos <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetPos <font color="#000080">:= </font>CurPtr<font color="#000080">-</font>StartPtr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetPos }

</i></font><font color="#FF0000"><b>function </b></font>TMemStream<font color="#000080">.</font>GetSize <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetSize <font color="#000080">:= </font>Size<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetSize }

</i></font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Read<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Status <font color="#000080">= </font>stOk <font color="#FF0000"><b>then begin
    if </b></font><font color="#000080">(</font>CurPtr<font color="#000080">-</font>StartPtr<font color="#000080">)+</font>Count <font color="#000080">&gt; </font>Size <font color="#FF0000"><b>then begin
      </b></font>FillChar<font color="#000080">(</font>Buf<font color="#000080">,</font>Count<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font>Error<font color="#000080">(</font>stReadError<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end else begin
      </b></font>move<font color="#000080">(</font>CurPtr<font color="#000080">^,</font>Buf<font color="#000080">,</font>Count<font color="#000080">);
      </font>inc<font color="#000080">(</font>CurPtr<font color="#000080">,</font>Count<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Read }

</i></font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Seek<font color="#000080">(</font>Pos <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Pos <font color="#000080">&gt;= </font>Size <font color="#FF0000"><b>then </b></font>Error<font color="#000080">(</font>stReadError<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>CurPtr <font color="#000080">:= </font>StartPtr<font color="#000080">+</font>Pos<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Seek }

</i></font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Truncate<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CurPtr <font color="#000080">:= </font>StartPtr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Truncate }

</i></font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Status <font color="#000080">= </font>stOk <font color="#FF0000"><b>then begin
    if </b></font><font color="#000080">(</font>CurPtr<font color="#000080">-</font>StartPtr<font color="#000080">)+</font>Count <font color="#000080">&gt; </font>Size <font color="#FF0000"><b>then
      </b></font>Error<font color="#000080">(</font>stWriteError<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)
    </font><font color="#FF0000"><b>else begin
      </b></font>move<font color="#000080">(</font>Buf<font color="#000080">,</font>CurPtr<font color="#000080">^,</font>Count<font color="#000080">);
      </font>inc<font color="#000080">(</font>CurPtr<font color="#000080">,</font>Count<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Write }

{-------------- Metodi di TBigMemStream : stream su aree di memoria (&gt; 64 KB) }

</i></font><font color="#FF0000"><b>procedure </b></font>AHIncr<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">; </font><font color="#FF0000"><b>external </b></font><font color="#800000">'KERNEL' </font>index <font color="#800000">114</font><font color="#000080">;

</font><font color="#FF0000"><b>constructor </b></font>TBigMemStream<font color="#000080">.</font>Init<font color="#000080">(</font>BlockPtr <font color="#000080">: </font>PChar<font color="#000080">; </font>BlockSize <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>TStream<font color="#000080">.</font>Init<font color="#000080">;
  </font>MemSeg <font color="#000080">:= </font>Seg<font color="#000080">(</font>BlockPtr<font color="#000080">^);
  </font>MemOfs <font color="#000080">:= </font>Ofs<font color="#000080">(</font>BlockPtr<font color="#000080">^);
  </font>CurPos<font color="#000080">.</font>L <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Size <font color="#000080">:= </font>BlockSize<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Init }

</i></font><font color="#FF0000"><b>destructor </b></font>TBigMemStream<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>MemSeg <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>MemOfs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>CurPos<font color="#000080">.</font>L <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Done }

</i></font><font color="#FF0000"><b>function </b></font>TBigMemStream<font color="#000080">.</font>GetPos <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetPos <font color="#000080">:= </font>CurPos<font color="#000080">.</font>L<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetPos }

</i></font><font color="#FF0000"><b>function </b></font>TBigMemStream<font color="#000080">.</font>GetSize <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetSize <font color="#000080">:= </font>Size<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetSize }

</i></font><font color="#FF0000"><b>procedure </b></font>TBigMemStream<font color="#000080">.</font>Read<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>CurPtr <font color="#000080">: </font>pointer<font color="#000080">;
  </font>BufPtr <font color="#000080">: </font>PChar<font color="#000080">;
  </font>MaxCount <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Status <font color="#000080">= </font>stOk <font color="#FF0000"><b>then begin
    if </b></font>CurPos<font color="#000080">.</font>L<font color="#000080">+</font>Count <font color="#000080">&gt; </font>Size <font color="#FF0000"><b>then begin
      </b></font>FillChar<font color="#000080">(</font>Buf<font color="#000080">,</font>Count<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font>Error<font color="#000080">(</font>stReadError<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end else begin
      </b></font>CurPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>MemSeg<font color="#000080">+</font>CurPos<font color="#000080">.</font>HiW<font color="#000080">*</font>Ofs<font color="#000080">(</font>AHIncr<font color="#000080">),</font>MemOfs<font color="#000080">+</font>CurPos<font color="#000080">.</font>LoW<font color="#000080">);
      </font>BufPtr <font color="#000080">:= @</font>Buf<font color="#000080">;
      </font>MaxCount <font color="#000080">:= </font><font color="#800000">65536</font><font color="#000080">-</font>CurPos<font color="#000080">.</font>LoW<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>Count <font color="#000080">&gt; </font>MaxCount <font color="#FF0000"><b>then begin
        </b></font>move<font color="#000080">(</font>CurPtr<font color="#000080">^,</font>Buf<font color="#000080">,</font>MaxCount<font color="#000080">);
        </font>inc<font color="#000080">(</font>CurPos<font color="#000080">.</font>L<font color="#000080">,</font>MaxCount<font color="#000080">);
        </font>dec<font color="#000080">(</font>Count<font color="#000080">,</font>MaxCount<font color="#000080">);
        </font>inc<font color="#000080">(</font>BufPtr<font color="#000080">,</font>MaxCount<font color="#000080">);
        </font>CurPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>MemSeg<font color="#000080">+</font>CurPos<font color="#000080">.</font>HiW<font color="#000080">*</font>Ofs<font color="#000080">(</font>AHIncr<font color="#000080">),</font>MemOfs<font color="#000080">+</font>CurPos<font color="#000080">.</font>LoW<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>move<font color="#000080">(</font>CurPtr<font color="#000080">^,</font>BufPtr<font color="#000080">^,</font>Count<font color="#000080">);
      </font>inc<font color="#000080">(</font>CurPos<font color="#000080">.</font>L<font color="#000080">,</font>Count<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Read }

</i></font><font color="#FF0000"><b>procedure </b></font>TBigMemStream<font color="#000080">.</font>Seek<font color="#000080">(</font>Pos <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Pos <font color="#000080">&gt;= </font>Size <font color="#FF0000"><b>then </b></font>Error<font color="#000080">(</font>stReadError<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>CurPos<font color="#000080">.</font>L <font color="#000080">:= </font>Pos<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Seek }

</i></font><font color="#FF0000"><b>procedure </b></font>TBigMemStream<font color="#000080">.</font>Truncate<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CurPos<font color="#000080">.</font>L <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Truncate }

</i></font><font color="#FF0000"><b>procedure </b></font>TBigMemStream<font color="#000080">.</font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>CurPtr <font color="#000080">: </font>pointer<font color="#000080">;
  </font>BufPtr <font color="#000080">: </font>PChar<font color="#000080">;
  </font>MaxCount <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Status <font color="#000080">= </font>stOk <font color="#FF0000"><b>then begin
    if </b></font>CurPos<font color="#000080">.</font>L<font color="#000080">+</font>Count <font color="#000080">&gt; </font>Size <font color="#FF0000"><b>then
      </b></font>Error<font color="#000080">(</font>stWriteError<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)
    </font><font color="#FF0000"><b>else begin
      </b></font>CurPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>MemSeg<font color="#000080">+</font>CurPos<font color="#000080">.</font>HiW<font color="#000080">*</font>Ofs<font color="#000080">(</font>AHIncr<font color="#000080">),</font>MemOfs<font color="#000080">+</font>CurPos<font color="#000080">.</font>LoW<font color="#000080">);
      </font>BufPtr <font color="#000080">:= @</font>Buf<font color="#000080">;
      </font>MaxCount <font color="#000080">:= </font><font color="#800000">65536</font><font color="#000080">-</font>CurPos<font color="#000080">.</font>LoW<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>Count <font color="#000080">&gt; </font>MaxCount <font color="#FF0000"><b>then begin
        </b></font>move<font color="#000080">(</font>Buf<font color="#000080">,</font>CurPtr<font color="#000080">^,</font>MaxCount<font color="#000080">);
        </font>inc<font color="#000080">(</font>CurPos<font color="#000080">.</font>L<font color="#000080">,</font>MaxCount<font color="#000080">);
        </font>dec<font color="#000080">(</font>Count<font color="#000080">,</font>MaxCount<font color="#000080">);
        </font>inc<font color="#000080">(</font>BufPtr<font color="#000080">,</font>MaxCount<font color="#000080">);
        </font>CurPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>MemSeg<font color="#000080">+</font>CurPos<font color="#000080">.</font>HiW<font color="#000080">*</font>Ofs<font color="#000080">(</font>AHIncr<font color="#000080">),</font>MemOfs<font color="#000080">+</font>CurPos<font color="#000080">.</font>LoW<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>move<font color="#000080">(</font>BufPtr<font color="#000080">^,</font>CurPtr<font color="#000080">^,</font>Count<font color="#000080">);
      </font>inc<font color="#000080">(</font>CurPos<font color="#000080">.</font>L<font color="#000080">,</font>Count<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Write }

{---------------------------------------------------------- Metodi di TBuffer }

</i></font><font color="#FF0000"><b>constructor </b></font>TBuffer<font color="#000080">.</font>Init<font color="#000080">(</font>StartSize<font color="#000080">,</font>Alloc <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>Size <font color="#000080">:= </font>StartSize<font color="#000080">;
  </font>AllocSize <font color="#000080">:= </font>Max<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">,</font>Alloc<font color="#000080">);
  </font>Len <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Size <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>BufPtr <font color="#000080">:= </font><font color="#FF0000"><b>nil
  else begin
    </b></font>GetMem<font color="#000080">(</font>BufPtr<font color="#000080">,</font>Size<font color="#000080">);
    </font>FillChar<font color="#000080">(</font>BufPtr<font color="#000080">^,</font>Size<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Init }

</i></font><font color="#FF0000"><b>destructor </b></font>TBuffer<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>BufPtr <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>FreeMem<font color="#000080">(</font>BufPtr<font color="#000080">,</font>Size<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Done }

</i></font><font color="#FF0000"><b>function </b></font>TBuffer<font color="#000080">.</font>GetLen <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetLen <font color="#000080">:= </font>Len<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetLen }

</i></font><font color="#FF0000"><b>function </b></font>TBuffer<font color="#000080">.</font>GetBuffer <font color="#000080">: </font>PChar<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetBuffer <font color="#000080">:= </font>BufPtr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetBuffer }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>Realloc<font color="#000080">(</font>NewLen <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Temp <font color="#000080">: </font>PChar<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>NewLen <font color="#000080">:= ((</font>NewLen<font color="#000080">+</font>AllocSize<font color="#000080">) </font><font color="#FF0000"><b>div </b></font>AllocSize<font color="#000080">)*</font>AllocSize<font color="#000080">;
  </font>GetMem<font color="#000080">(</font>Temp<font color="#000080">,</font>NewLen<font color="#000080">);
  </font>FillChar<font color="#000080">(</font>Temp<font color="#000080">^,</font>NewLen<font color="#000080">,</font><font color="#800000">#0</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>BufPtr <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
    </b></font>move<font color="#000080">(</font>BufPtr<font color="#000080">^,</font>Temp<font color="#000080">^,</font>Min<font color="#000080">(</font>Len<font color="#000080">,</font>NewLen<font color="#000080">));
    </font>FreeMem<font color="#000080">(</font>BufPtr<font color="#000080">,</font>Size<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>NewLen <font color="#000080">&gt; </font>Len<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>FillChar<font color="#000080">(</font>Temp<font color="#000080">[</font>Len<font color="#000080">],</font>NewLen<font color="#000080">-</font>Len<font color="#000080">,</font><font color="#800000">#0</font><font color="#000080">);
  </font>BufPtr <font color="#000080">:= </font>Temp<font color="#000080">;
  </font>Size <font color="#000080">:= </font>NewLen<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Realloc }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>Append<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Len<font color="#000080">+</font>Count <font color="#000080">&gt;= </font>Size <font color="#FF0000"><b>then </b></font>Realloc<font color="#000080">(</font>Len<font color="#000080">+</font>Count<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
  </font>move<font color="#000080">(</font>Buf<font color="#000080">,</font>BufPtr<font color="#000080">[</font>Len<font color="#000080">],</font>Count<font color="#000080">);
  </font>inc<font color="#000080">(</font>Len<font color="#000080">,</font>Count<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Append }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>Insert<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">; </font>Pos <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>InRange<font color="#000080">(</font>Pos<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>Len<font color="#000080">) </font><font color="#FF0000"><b>then begin
    if </b></font>Len<font color="#000080">+</font>Count <font color="#000080">&gt;= </font>Size <font color="#FF0000"><b>then </b></font>Realloc<font color="#000080">(</font>Len<font color="#000080">+</font>Count<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Len <font color="#000080">&gt; </font>Pos <font color="#FF0000"><b>then </b></font>move<font color="#000080">(</font>BufPtr<font color="#000080">[</font>Pos<font color="#000080">],</font>BufPtr<font color="#000080">[</font>Pos<font color="#000080">+</font>Count<font color="#000080">],</font>Len<font color="#000080">-</font>Pos<font color="#000080">);
    </font>move<font color="#000080">(</font>Buf<font color="#000080">,</font>BufPtr<font color="#000080">[</font>Pos<font color="#000080">],</font>Count<font color="#000080">);
    </font>inc<font color="#000080">(</font>Len<font color="#000080">,</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Insert }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>AppendChar<font color="#000080">(</font>C <font color="#000080">: </font>char<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Len<font color="#000080">+</font><font color="#800000">1 </font><font color="#000080">&gt;= </font>Size <font color="#FF0000"><b>then </b></font>Realloc<font color="#000080">(</font>Len<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">);
  </font>BufPtr<font color="#000080">[</font>Len<font color="#000080">] := </font>C<font color="#000080">;
  </font>inc<font color="#000080">(</font>Len<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ AppendChar }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>AppendStr<font color="#000080">(</font>S <font color="#000080">: </font>PChar<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>S <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>Append<font color="#000080">(</font>S<font color="#000080">^,</font>StrLen<font color="#000080">(</font>S<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ AppendStr }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>Overwrite<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">; </font>Pos <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>InRange<font color="#000080">(</font>Pos<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>pred<font color="#000080">(</font>Len<font color="#000080">)) </font><font color="#FF0000"><b>then begin
    </b></font>Count <font color="#000080">:= </font>Min<font color="#000080">(</font>Count<font color="#000080">,</font>Len<font color="#000080">-</font>Pos<font color="#000080">);
    </font>move<font color="#000080">(</font>Buf<font color="#000080">,</font>BufPtr<font color="#000080">[</font>Pos<font color="#000080">],</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Overwrite }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>Reset<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Len <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>FillChar<font color="#000080">(</font>BufPtr<font color="#000080">^,</font>Size<font color="#000080">,</font><font color="#800000">#0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Reset }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>Truncate<font color="#000080">(</font>NewLen <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>NewLen <font color="#000080">&lt; </font>Len <font color="#FF0000"><b>then begin
    if </b></font>Size<font color="#000080">-</font>NewLen <font color="#000080">&gt; </font>AllocSize <font color="#FF0000"><b>then </b></font>Realloc<font color="#000080">(</font>NewLen<font color="#000080">);
    </font>Len <font color="#000080">:= </font>NewLen<font color="#000080">;
    </font>FillChar<font color="#000080">(</font>BufPtr<font color="#000080">[</font>Len<font color="#000080">],</font>Size<font color="#000080">-</font>Len<font color="#000080">,</font><font color="#800000">#0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Truncate }

</i></font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>Delete<font color="#000080">(</font>From<font color="#000080">,</font>N <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Last <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>From <font color="#000080">&lt; </font>Len<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>N <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
    </b></font>Last <font color="#000080">:= </font>From<font color="#000080">+</font>N<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Last <font color="#000080">&lt; </font>Len <font color="#FF0000"><b>then </b></font>move<font color="#000080">(</font>BufPtr<font color="#000080">[</font>Last<font color="#000080">],</font>BufPtr<font color="#000080">[</font>From<font color="#000080">],</font>succ<font color="#000080">(</font>Len<font color="#000080">-</font>Last<font color="#000080">));
    </font>Truncate<font color="#000080">(</font>Len<font color="#000080">-</font>N<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Delete }

{----------------------------------------------------- Metodi di TAllocStream }

</i></font><font color="#FF0000"><b>constructor </b></font>TAllocStream<font color="#000080">.</font>Init<font color="#000080">(</font>StartSize<font color="#000080">,</font>Alloc <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  inherited </b></font>Init<font color="#000080">;
  </font>Buffer<font color="#000080">.</font>Init<font color="#000080">(</font>StartSize<font color="#000080">,</font>Alloc<font color="#000080">);
  </font>CurPos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Init }

</i></font><font color="#FF0000"><b>destructor </b></font>TAllocStream<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Buffer<font color="#000080">.</font>Done<font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Done }

</i></font><font color="#FF0000"><b>function </b></font>TAllocStream<font color="#000080">.</font>GetPos <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetPos <font color="#000080">:= </font>CurPos<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetPos }

</i></font><font color="#FF0000"><b>function </b></font>TAllocStream<font color="#000080">.</font>GetSize <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetSize <font color="#000080">:= </font>Buffer<font color="#000080">.</font>GetLen<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetSize }

</i></font><font color="#FF0000"><b>procedure </b></font>TAllocStream<font color="#000080">.</font>Seek<font color="#000080">(</font>Pos <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>Pos <font color="#000080">&gt; </font>Buffer<font color="#000080">.</font>GetLen<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Pos <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Error<font color="#000080">(</font>stWriteError<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>CurPos <font color="#000080">:= </font>Pos<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Seek }

</i></font><font color="#FF0000"><b>procedure </b></font>TAllocStream<font color="#000080">.</font>Truncate<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>CurPos <font color="#000080">&lt; </font>Buffer<font color="#000080">.</font>GetLen <font color="#FF0000"><b>then </b></font>Buffer<font color="#000080">.</font>Truncate<font color="#000080">(</font>succ<font color="#000080">(</font>CurPos<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Truncate }

</i></font><font color="#FF0000"><b>procedure </b></font>TAllocStream<font color="#000080">.</font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Len <font color="#000080">: </font>word<font color="#000080">;
  </font>B <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">65000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#FF0000"><b>absolute </b></font>Buf<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Status <font color="#000080">= </font>stOk <font color="#FF0000"><b>then begin
    </b></font>Len <font color="#000080">:= </font>Buffer<font color="#000080">.</font>GetLen<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>CurPos <font color="#000080">&gt;= </font>Len <font color="#FF0000"><b>then </b></font>Buffer<font color="#000080">.</font>Append<font color="#000080">(</font>Buf<font color="#000080">,</font>Count<font color="#000080">)
    </font><font color="#FF0000"><b>else begin
      </b></font>Buffer<font color="#000080">.</font>Overwrite<font color="#000080">(</font>Buf<font color="#000080">,</font>Min<font color="#000080">(</font>Count<font color="#000080">,</font>Len<font color="#000080">-</font>CurPos<font color="#000080">),</font>CurPos<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Count <font color="#000080">&gt; </font>Len<font color="#000080">-</font>CurPos <font color="#FF0000"><b>then
        </b></font>Buffer<font color="#000080">.</font>Append<font color="#000080">(</font>B<font color="#000080">[</font>Len<font color="#000080">-</font>CurPos<font color="#000080">],</font>Count<font color="#000080">-</font>Len<font color="#000080">+</font>CurPos<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>inc<font color="#000080">(</font>CurPos<font color="#000080">,</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Write }

</i></font><font color="#FF0000"><b>function </b></font>TAllocStream<font color="#000080">.</font>GetBuffer <font color="#000080">: </font>PChar<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetBuffer <font color="#000080">:= </font>Buffer<font color="#000080">.</font>GetBuffer<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ GetBuffer }

{----------------- Classe TSCollection : collection non ordinate di stringhe  }

</i></font><font color="#FF0000"><b>procedure </b></font>TSCollection<font color="#000080">.</font>FreeItem<font color="#000080">(</font>Item <font color="#000080">: </font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>StrDispose<font color="#000080">(</font>PChar<font color="#000080">(</font>Item<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ FreeItem }

{-------------------------- Classe TErrCollection : gestione error metodo At  }

</i></font><font color="#FF0000"><b>procedure </b></font>TErrCollection<font color="#000080">.</font>Error<font color="#000080">(</font>Code<font color="#000080">,</font>Info <font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>ErrDesc <font color="#000080">: </font><font color="#FF0000"><b>record
    </b></font>ErrCode <font color="#000080">: </font>integer<font color="#000080">;
    </font>ErrPosHi <font color="#000080">: </font>word<font color="#000080">;
    </font>ErrPosLo <font color="#000080">: </font>word<font color="#000080">;
    </font>ErrIndex <font color="#000080">: </font>integer<font color="#000080">;
    </font>ErrCount <font color="#000080">: </font>integer<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Buffer <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">80</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">mov   cx,[BP+20]
    mov   bx,[BP+22]
    verr  bx
    je    @1
    mov   bx,$FFFF
    mov   cx,bx
    jmp   @2
@1:
    mov   es,bx
    mov   bx,word ptr es:0
@2:
    mov   ErrDesc.ErrPosLo,cx
    mov   ErrDesc.ErrPosHi,bx
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ErrDesc<font color="#000080">.</font>ErrCode <font color="#000080">:= </font><font color="#800000">212</font><font color="#000080">-</font>Code<font color="#000080">;
  </font>ErrDesc<font color="#000080">.</font>ErrIndex <font color="#000080">:= </font>Info<font color="#000080">;
  </font>ErrDesc<font color="#000080">.</font>ErrCount <font color="#000080">:= </font>Count<font color="#000080">;
  </font>WVSPrintF<font color="#000080">(</font>Buffer<font color="#000080">,</font><font color="#800000">'Runtime error %d at %04X:%04X with index %d; Count=%d'</font><font color="#000080">,</font>ErrDesc<font color="#000080">);
  </font>MessageBox<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>Buffer<font color="#000080">,</font><font color="#FF0000"><b>nil</b></font><font color="#000080">,</font>mb_Ok <font color="#FF0000"><b>or </b></font>mb_SystemModal<font color="#000080">);
  </font>halt<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Error }

{----------------------------------------------------------------------- Main }

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">. </font><font color="#008000"><i>{ unit Streams }
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to STREAMS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p></body>
</html>
