<html>
<head><title> "TEMSStream.Done Bug" by DJ MURDOCH & ALEXANDER PETROSYAN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to STREAMS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
There's a bug in TEMSStream.Done.  It leaves EMSCurHandle and EMSCurPage with
the last used values, even though it's releasing an EMS handle, which may
well be EMSCurHandle.  This means that if you allocate a second EMSStream
after disposing of the first one, it can happen that it sees the page frame
as already valid, when in fact it should load it.
A workaround is to set EMSCurHandle := $FFFF after calling TEMSStream.Done.

Here's some sample code to demonstrate the bug.  It was posted to Usenet's
comp.lang.pascal:

  From: paf@fbit.msk.su (Alexander Petrosyan)
  Subject: TEMSStream trouble (Bug?)
  Date: Mon, 26 Sep 94 16:24:34 +0400

  Try to compile and run this prog:
}

</i></font><font color="#FF0000"><b>uses
  </b></font>Objects<font color="#000080">,
  </font>wincrt<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>ES<font color="#000080">: </font>TEMSStream<font color="#000080">;
  </font>A<font color="#000080">, </font>B<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">$400</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>I<font color="#000080">, </font>J<font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Error<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteLn <font color="#000080">(</font><font color="#800000">'Error !'</font><font color="#000080">);
  </font>ES<font color="#000080">.</font>Done<font color="#000080">;
  </font>Halt <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>FillChar <font color="#000080">(</font>A<font color="#000080">, </font><font color="#800000">$400</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>ES<font color="#000080">.</font>Init <font color="#000080">(</font><font color="#800000">18 </font><font color="#000080">* </font><font color="#800000">$400</font><font color="#000080">, </font><font color="#800000">18 </font><font color="#000080">* </font><font color="#800000">$400</font><font color="#000080">);            </font><font color="#008000"><i>{ Allocate 18K EMS }
  </i></font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">18 </font><font color="#FF0000"><b>do </b></font>ES<font color="#000080">.</font>Write <font color="#000080">(</font>A<font color="#000080">, </font><font color="#800000">$400</font><font color="#000080">);    </font><font color="#008000"><i>{ Fill with 1 }
  </i></font>ES<font color="#000080">.</font>Seek <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">10</font><font color="#008000"><i>{*} </i></font><font color="#FF0000"><b>do begin                  </b></font><font color="#008000"><i>{ Read 10K of 18K }
    </i></font>ES<font color="#000080">.</font>Read <font color="#000080">(</font>B<font color="#000080">, </font><font color="#800000">$400</font><font color="#000080">);
    </font><font color="#FF0000"><b>for </b></font>J <font color="#000080">:= </font>Low <font color="#000080">(</font>B<font color="#000080">) </font><font color="#FF0000"><b>to </b></font>High <font color="#000080">(</font>B<font color="#000080">) </font><font color="#FF0000"><b>do if </b></font>B<font color="#000080">[</font>J<font color="#000080">] &lt;&gt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ Verify }
      </i></font>Error<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ES<font color="#000080">.</font>Done<font color="#000080">;                                   </font><font color="#008000"><i>{ Free allocated EMS }

{ Above code causes problem to below code }

(*  emscurhandle := $ffff;  *)    { Uncomment this line to fix the bug }

  </i></font>FillChar <font color="#000080">(</font>A<font color="#000080">, </font><font color="#800000">$400</font><font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
  </font>ES<font color="#000080">.</font>Init <font color="#000080">(</font><font color="#800000">79 </font><font color="#000080">* </font><font color="#800000">$400</font><font color="#000080">, </font><font color="#800000">79 </font><font color="#000080">* </font><font color="#800000">$400</font><font color="#000080">);            </font><font color="#008000"><i>{ Allocate 79K EMS }
  </i></font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">79 </font><font color="#FF0000"><b>do </b></font>ES<font color="#000080">.</font>Write <font color="#000080">(</font>A<font color="#000080">, </font><font color="#800000">$400</font><font color="#000080">);    </font><font color="#008000"><i>{ Fill with 2 }
  </i></font>ES<font color="#000080">.</font>Seek <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">79 </font><font color="#FF0000"><b>do begin                  </b></font><font color="#008000"><i>{ Verify ALL }
    </i></font>ES<font color="#000080">.</font>Read <font color="#000080">(</font>B<font color="#000080">, </font><font color="#800000">$400</font><font color="#000080">);
    </font><font color="#FF0000"><b>for </b></font>J <font color="#000080">:= </font>Low <font color="#000080">(</font>B<font color="#000080">) </font><font color="#FF0000"><b>to </b></font>High <font color="#000080">(</font>B<font color="#000080">) </font><font color="#FF0000"><b>do if </b></font>B<font color="#000080">[</font>J<font color="#000080">] &lt;&gt; </font><font color="#800000">2 </font><font color="#FF0000"><b>then
      </b></font>Error<font color="#000080">;  </font><font color="#008000"><i>{ I'm getting error at this point. Why? }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ES<font color="#000080">.</font>Done<font color="#000080">;

  </font>writeln<font color="#000080">(</font><font color="#800000">'Done'</font><font color="#000080">);
</font><font color="#008000"><i>{
  It seems that 1st page of this stream when being read are mapped not to the
  right place but to some page of previous stream.
}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>(*
It seems to me that error occurs when stream position at dispose time not in
last 16K EMS page (stream must be readed before dispose).

In this example we are writing 18K but reading 10K leaving stream position
not  in last page. When I change 10 to 18 at {*} all goes OK.
*)
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to STREAMS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p></body>
</html>
