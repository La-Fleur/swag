<html>
<head><title> "TV-HELP.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
Last week I found a bug in HELPFile.PAS and called Borland.  After describing
the error, the Borland representative agreed that it was a bug and that
it hasn't been reported.  ThereFore, I will describe the bug here and give
a fix to the problem.

Problem:
Recall, HELPFile.PAS is the Turbo Vision Unit that TVDEMO.PAS Uses to
provide on-line help to Turbo Vision Programs.  The problem that occurred
was that if a help panel was brought up that did not contain a cross
reference entry (i.e. hyperText link), and the user pressed [Tab] or
Shift+[Tab] then a run-time error is generated.   notE: the run-time
error is generated if the Program is Compiled With Range Checking on.
if Range checking is off, then unpredicatable results occur.

to see the bug in action, do the following:

Fire up Turbo Pascal 6 and load the TVDEMO.PAS Program (by default it exists
in the TVDEMOS subdirectory).  Make sure Range checking is turned on.
The option is in Options|Compiler.  You will also want to turn debugging
on in both the TVDEMO.PAS and HELPFile.PAS Files.  to do this, you must
edit the source code of both Files and change the {$D-} option to {$D+}
at the beginning of both Files.

Once you have done the above, press Ctrl+F9 to run TVDEMO.  When TVDEMO
comes up, press F1 to bring up the help Window.  Now, press Shift+[Tab]
or [Tab] and a RunTime error 201 will occur.

This bug arises from the fact that the HELPFile.PAS Unit assumes that
there will always be at least one cross reference field on a help panel.
Obviously, this is an invalid assumption.

Luckily, there is an easy solution to the problem.  The following shows
how to change the HELPFile.PAS Program so that this error doesn't occur.
The only Procedure that needs to be changed is THelpViewer.HandleEvent.

*)

</i></font><font color="#FF0000"><b>Procedure </b></font>THelpViewer<font color="#000080">.</font>HandleEvent<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Event<font color="#000080">: </font>TEvent<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>KeyPoint<font color="#000080">, </font>Mouse<font color="#000080">: </font>TPoint<font color="#000080">;
  </font>KeyLength<font color="#000080">: </font>Byte<font color="#000080">;
  </font>KeyRef<font color="#000080">: </font>Integer<font color="#000080">;
  </font>KeyCount<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#008000"><i>{ 1. Add the following Variable declaration }
  </i></font>n <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>MakeSelectVisible<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>D<font color="#000080">: </font>TPoint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>topic<font color="#000080">^.</font>GetCrossRef<font color="#000080">(</font>Selected<font color="#000080">, </font>KeyPoint<font color="#000080">, </font>KeyLength<font color="#000080">, </font>KeyRef<font color="#000080">);
  </font>D <font color="#000080">:= </font>Delta<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>KeyPoint<font color="#000080">.</font>X <font color="#000080">&lt; </font>D<font color="#000080">.</font>X <font color="#FF0000"><b>then </b></font>D<font color="#000080">.</font>X <font color="#000080">:= </font>KeyPoint<font color="#000080">.</font>X<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>KeyPoint<font color="#000080">.</font>X <font color="#000080">&gt; </font>D<font color="#000080">.</font>X <font color="#000080">+ </font>Size<font color="#000080">.</font>X <font color="#FF0000"><b>then </b></font>D<font color="#000080">.</font>X <font color="#000080">:= </font>KeyPoint<font color="#000080">.</font>X <font color="#000080">- </font>Size<font color="#000080">.</font>X<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>KeyPoint<font color="#000080">.</font>Y <font color="#000080">&lt; </font>D<font color="#000080">.</font>Y <font color="#FF0000"><b>then </b></font>D<font color="#000080">.</font>Y <font color="#000080">:= </font>KeyPoint<font color="#000080">.</font>Y<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>KeyPoint<font color="#000080">.</font>Y <font color="#000080">&gt; </font>D<font color="#000080">.</font>Y <font color="#000080">+ </font>Size<font color="#000080">.</font>Y <font color="#FF0000"><b>then </b></font>D<font color="#000080">.</font>Y <font color="#000080">:= </font>KeyPoint<font color="#000080">.</font>Y <font color="#000080">- </font>Size<font color="#000080">.</font>Y<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>D<font color="#000080">.</font>X <font color="#000080">&lt;&gt; </font>Delta<font color="#000080">.</font>X<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>D<font color="#000080">.</font>Y <font color="#000080">&lt;&gt; </font>Delta<font color="#000080">.</font>Y<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Scrollto<font color="#000080">(</font>D<font color="#000080">.</font>X<font color="#000080">, </font>D<font color="#000080">.</font>Y<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Switchtotopic<font color="#000080">(</font>KeyRef<font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>topic <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>Dispose<font color="#000080">(</font>topic<font color="#000080">, </font>Done<font color="#000080">);
  </font>topic <font color="#000080">:= </font>HFile<font color="#000080">^.</font>Gettopic<font color="#000080">(</font>KeyRef<font color="#000080">);
  </font>topic<font color="#000080">^.</font>SetWidth<font color="#000080">(</font>Size<font color="#000080">.</font>X<font color="#000080">);
  </font>Scrollto<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>SetLimit<font color="#000080">(</font>Limit<font color="#000080">.</font>X<font color="#000080">, </font>topic<font color="#000080">^.</font>NumLines<font color="#000080">);
  </font>Selected <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>DrawView<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>TScroller<font color="#000080">.</font>HandleEvent<font color="#000080">(</font>Event<font color="#000080">);
  </font><font color="#FF0000"><b>Case </b></font>Event<font color="#000080">.</font>What <font color="#FF0000"><b>of
    </b></font>evKeyDown<font color="#000080">:
      </font><font color="#FF0000"><b>begin
        Case </b></font>Event<font color="#000080">.</font>KeyCode <font color="#FF0000"><b>of
          </b></font>kbTab<font color="#000080">:
            </font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ 2. Change This...
              Inc(Selected);
              if Selected &gt; topic^.GetNumCrossRefs then Selected := 1;
              MakeSelectVisible;
to this... }
              </i></font>Inc<font color="#000080">(</font>Selected<font color="#000080">);
              </font>n <font color="#000080">:= </font>topic<font color="#000080">^.</font>GetNumCrossRefs<font color="#000080">;

              </font><font color="#FF0000"><b>if </b></font>n <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
              begin
                  if </b></font>Selected <font color="#000080">&gt; </font>n <font color="#FF0000"><b>then
                      </b></font>Selected <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
                  </font>MakeSelectVisible<font color="#000080">;
              </font><font color="#FF0000"><b>end
              else
                  </b></font>selected <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#008000"><i>{ end of Change 2 }
            </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>kbShiftTab<font color="#000080">:
            </font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ 3. Change this ...
              Dec(Selected);
              if Selected = 0 then Selected := topic^.GetNumCrossRefs;
              MakeSelectVisible;
to this... }
              </i></font>Dec<font color="#000080">(</font>Selected<font color="#000080">);
              </font>n <font color="#000080">:= </font>topic<font color="#000080">^.</font>GetNumCrossRefs<font color="#000080">;
              </font><font color="#FF0000"><b>if </b></font>n <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
              begin
                  if </b></font>Selected <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
                      </b></font>Selected <font color="#000080">:= </font>n<font color="#000080">;
                  </font>MakeSelectVisible<font color="#000080">;
              </font><font color="#FF0000"><b>end
              else
                  </b></font>Selected <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#008000"><i>{ end of Change 3 }
            </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>kbEnter<font color="#000080">:
            </font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{ 4. Change this...
              if Selected &lt;= topic^.GetNumCrossRefs then
              begin
                topic^.GetCrossRef(Selected, KeyPoint, KeyLength, KeyRef);
                Swithtotopic(KeyRef);
              end;
to this...}
              </i></font>n <font color="#000080">:= </font>topic<font color="#000080">^.</font>GetNumCrossRefs<font color="#000080">;
              </font><font color="#FF0000"><b>if </b></font>n <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
              begin
                  if </b></font>Selected <font color="#000080">&lt;= </font>n <font color="#FF0000"><b>then
                  begin
                    </b></font>topic<font color="#000080">^.</font>GetCrossRef<font color="#000080">(</font>Selected<font color="#000080">, </font>KeyPoint<font color="#000080">, </font>KeyLength<font color="#000080">, </font>KeyRef<font color="#000080">);
                    </font>Switchtotopic<font color="#000080">(</font>KeyRef<font color="#000080">);
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{ end of Change 4 }
            </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>kbEsc<font color="#000080">:
            </font><font color="#FF0000"><b>begin
              </b></font>Event<font color="#000080">.</font>What <font color="#000080">:= </font>evCommand<font color="#000080">;
              </font>Event<font color="#000080">.</font>Command <font color="#000080">:= </font>cmClose<font color="#000080">;
              </font>PutEvent<font color="#000080">(</font>Event<font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>else
          </b></font>Exit<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>DrawView<font color="#000080">;
        </font>ClearEvent<font color="#000080">(</font>Event<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>evMouseDown<font color="#000080">:
      </font><font color="#FF0000"><b>begin
        </b></font>MakeLocal<font color="#000080">(</font>Event<font color="#000080">.</font>Where<font color="#000080">, </font>Mouse<font color="#000080">);
        </font>Inc<font color="#000080">(</font>Mouse<font color="#000080">.</font>X<font color="#000080">, </font>Delta<font color="#000080">.</font>X<font color="#000080">); </font>Inc<font color="#000080">(</font>Mouse<font color="#000080">.</font>Y<font color="#000080">, </font>Delta<font color="#000080">.</font>Y<font color="#000080">);
        </font>KeyCount <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
        </font><font color="#FF0000"><b>Repeat
          </b></font>Inc<font color="#000080">(</font>KeyCount<font color="#000080">);
          </font><font color="#FF0000"><b>if </b></font>KeyCount <font color="#000080">&gt; </font>topic<font color="#000080">^.</font>GetNumCrossRefs <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
          </font>topic<font color="#000080">^.</font>GetCrossRef<font color="#000080">(</font>KeyCount<font color="#000080">, </font>KeyPoint<font color="#000080">, </font>KeyLength<font color="#000080">, </font>KeyRef<font color="#000080">);
        </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>KeyPoint<font color="#000080">.</font>Y <font color="#000080">= </font>Mouse<font color="#000080">.</font>Y<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Mouse<font color="#000080">.</font>X <font color="#000080">&gt;= </font>KeyPoint<font color="#000080">.</font>X<font color="#000080">) </font><font color="#FF0000"><b>and
          </b></font><font color="#000080">(</font>Mouse<font color="#000080">.</font>X <font color="#000080">&lt; </font>KeyPoint<font color="#000080">.</font>X <font color="#000080">+ </font>KeyLength<font color="#000080">);
        </font>Selected <font color="#000080">:= </font>KeyCount<font color="#000080">;
        </font>DrawView<font color="#000080">;
        </font><font color="#FF0000"><b>if </b></font>Event<font color="#000080">.</font>Double <font color="#FF0000"><b>then </b></font>Switchtotopic<font color="#000080">(</font>KeyRef<font color="#000080">);
        </font>ClearEvent<font color="#000080">(</font>Event<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>evCommand<font color="#000080">:
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Event<font color="#000080">.</font>Command <font color="#000080">= </font>cmClose<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Owner<font color="#000080">^.</font>State <font color="#FF0000"><b>and </b></font>sfModal <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>endModal<font color="#000080">(</font>cmClose<font color="#000080">);
        </font>ClearEvent<font color="#000080">(</font>Event<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p></body>
</html>
