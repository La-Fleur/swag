<html>
<head><title> "TVision Extension" by DJ MURDOCH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0031.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;try using resource files with TurboVision. When opening a resource file with
&gt;extension EXE, TV will append it to the file during write operations.
&gt;I did it already for registration stuff and it works fine.

The trouble with this approach is that each write operation appends a
record, it doesn change the existing one.  For something you do only once
like registration, that's okay, but for config changes, you need to do
something to pack the records.  With Resource files that's complicated, but
possible.  Here's the unit I use to do it.
}

</i></font><font color="#FF0000"><b>unit </b></font>resources<font color="#000080">;

</font><font color="#008000"><i>{ Unit to provide extra functions to TVision TResourceFiles }

</i></font><font color="#FF0000"><b>interface

uses
  </b></font>objects<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>PPackableResource <font color="#000080">= ^</font>TPackableResource<font color="#000080">;
  </font>TPackableResource <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TResourceFile<font color="#000080">)
    </font><font color="#FF0000"><b>function </b></font>pack <font color="#000080">: </font>boolean<font color="#000080">;
    </font><font color="#008000"><i>{ Packs the resource file by reading all resources and rewriting them to
      the stream.  Returns false if it fails. }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

type
  </b></font><font color="#008000"><i>{ Type here to get at the secret fields of the TResourceFile }
  </i></font>TResourceSecrets <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TObject<font color="#000080">)
    </font>Stream   <font color="#000080">: </font>PStream<font color="#000080">;
    </font>Modified <font color="#000080">: </font>Boolean<font color="#000080">;
    </font>BasePos  <font color="#000080">: </font>Longint<font color="#000080">;
    </font>IndexPos <font color="#000080">: </font>Longint<font color="#000080">;
    </font>Index    <font color="#000080">: </font>TResourceCollection<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PNamedItem <font color="#000080">= ^</font>TNamedItem<font color="#000080">;
  </font>TNamedItem <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TObject<font color="#000080">)
    </font>Item <font color="#000080">: </font>PObject<font color="#000080">;
    </font>Name <font color="#000080">: </font>PString<font color="#000080">;
    </font><font color="#FF0000"><b>destructor </b></font>done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>TNamedItem<font color="#000080">.</font>done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DisposeStr<font color="#000080">(</font>Name<font color="#000080">);
  </font><font color="#FF0000"><b>inherited </b></font>done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Deletechars<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S <font color="#000080">: </font>TStream<font color="#000080">; </font>count <font color="#000080">: </font>Longint<font color="#000080">);
</font><font color="#008000"><i>{ Deletes the given number of characters from the stream }
</i></font><font color="#FF0000"><b>var
  </b></font>copy    <font color="#000080">: </font>longint<font color="#000080">;
  </font>buffer  <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">1024</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>bufsize <font color="#000080">: </font>word<font color="#000080">;
  </font>pos     <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>pos     <font color="#000080">:= </font>S<font color="#000080">.</font>GetPos<font color="#000080">;
  </font>copy    <font color="#000080">:= </font>S<font color="#000080">.</font>GetSize <font color="#000080">- </font>pos <font color="#000080">- </font>count<font color="#000080">;
  </font>bufsize <font color="#000080">:= </font>sizeof<font color="#000080">(</font>buffer<font color="#000080">);

  </font><font color="#FF0000"><b>while </b></font>copy <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    if </b></font>copy <font color="#000080">&lt; </font>sizeof<font color="#000080">(</font>buffer<font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>bufsize <font color="#000080">:= </font>copy<font color="#000080">;
    </font>S<font color="#000080">.</font>Seek<font color="#000080">(</font>pos <font color="#000080">+ </font>count<font color="#000080">);
    </font>S<font color="#000080">.</font>Read<font color="#000080">(</font>Buffer<font color="#000080">, </font>bufsize<font color="#000080">);
    </font>S<font color="#000080">.</font>Seek<font color="#000080">(</font>pos<font color="#000080">);
    </font>S<font color="#000080">.</font>write<font color="#000080">(</font>Buffer<font color="#000080">, </font>bufsize<font color="#000080">);
    </font>inc<font color="#000080">(</font>pos<font color="#000080">, </font>bufsize<font color="#000080">);
    </font>dec<font color="#000080">(</font>copy<font color="#000080">, </font>bufsize<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>S<font color="#000080">.</font>Truncate<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TPackableResource<font color="#000080">.</font>Pack <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>contents  <font color="#000080">: </font>TCollection<font color="#000080">;
  </font>i         <font color="#000080">: </font>integer<font color="#000080">;
  </font>item      <font color="#000080">: </font>PObject<font color="#000080">;
  </font>nameditem <font color="#000080">: </font>PNamedItem<font color="#000080">;
  </font>OldSize   <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Flush<font color="#000080">;
  </font>pack <font color="#000080">:= </font>false<font color="#000080">;   </font><font color="#008000"><i>{ Assume failure }
  </i></font><font color="#FF0000"><b>if </b></font>Stream<font color="#000080">^.</font>status <font color="#000080">&lt;&gt; </font>stOk <font color="#FF0000"><b>then
    </b></font>exit<font color="#000080">;

  </font><font color="#008000"><i>{ First, make a copy of all the contents in memory }

  </i></font>contents<font color="#000080">.</font>init<font color="#000080">(</font>Count<font color="#000080">, </font><font color="#800000">10</font><font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>pred<font color="#000080">(</font>Count<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>item <font color="#000080">:= </font>Get<font color="#000080">(</font>KeyAt<font color="#000080">(</font>i<font color="#000080">));
    </font>New<font color="#000080">(</font>NamedItem<font color="#000080">, </font>init<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>NamedItem <font color="#000080">= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>item <font color="#000080">= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>contents<font color="#000080">.</font>done<font color="#000080">;
      </font>exit<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>NamedItem<font color="#000080">^.</font>item <font color="#000080">:= </font>item<font color="#000080">;
    </font>NamedItem<font color="#000080">^.</font>name <font color="#000080">:= </font>Newstr<font color="#000080">(</font>Keyat<font color="#000080">(</font>i<font color="#000080">));
    </font>contents<font color="#000080">.</font>atinsert<font color="#000080">(</font>i<font color="#000080">, </font>nameditem<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Now, remove all traces of the original. }

  </i></font><font color="#FF0000"><b>with </b></font>TResourceSecrets<font color="#000080">(</font>Self<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>Stream<font color="#000080">^.</font>Seek<font color="#000080">(</font>BasePos <font color="#000080">+ </font><font color="#800000">4</font><font color="#000080">);
    </font>Stream<font color="#000080">^.</font>Read<font color="#000080">(</font>OldSize<font color="#000080">, </font>Sizeof<font color="#000080">(</font>OldSize<font color="#000080">));
    </font>Stream<font color="#000080">^.</font>Seek<font color="#000080">(</font>BasePos<font color="#000080">);
    </font>DeleteChars<font color="#000080">(</font>Stream<font color="#000080">^, </font>OldSize <font color="#000080">+ </font><font color="#800000">8</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Now, close down and restart }
  </i></font>TResourceSecrets<font color="#000080">(</font>Self<font color="#000080">).</font>Index<font color="#000080">.</font>Done<font color="#000080">;
  </font>Stream<font color="#000080">^.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>inherited </b></font>init<font color="#000080">(</font>Stream<font color="#000080">);

  </font><font color="#008000"><i>{ Now rewrite all those saved objects. }
  </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>pred<font color="#000080">(</font>contents<font color="#000080">.</font>count<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>nameditem <font color="#000080">:= </font>PNamedItem<font color="#000080">(</font>contents<font color="#000080">.</font>At<font color="#000080">(</font>i<font color="#000080">));
    </font>Put<font color="#000080">(</font>nameditem<font color="#000080">^.</font>item<font color="#000080">, </font>nameditem<font color="#000080">^.</font>name<font color="#000080">^);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Get rid of the copies from memory }
  </i></font>contents<font color="#000080">.</font>done<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>Stream<font color="#000080">^.</font>Status <font color="#000080">= </font>stOk <font color="#FF0000"><b>then
    </b></font>pack <font color="#000080">:= </font>true<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0031.PAS">Original</a><b>]</b></p></body>
</html>
