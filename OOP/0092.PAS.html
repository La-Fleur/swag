<html>
<head><title> "Dbase Program" by SHMATIKOV V.</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0092.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>uses </b></font>Objects<font color="#000080">, </font>Drivers<font color="#000080">, </font>Views<font color="#000080">, </font>Menus<font color="#000080">, </font>Dialogs<font color="#000080">, </font>App<font color="#000080">, </font>Layout<font color="#000080">, </font>OODB<font color="#000080">;
                                     </font><font color="#008000"><i>{ layout and OODB are at the end !!}
</i></font><font color="#FF0000"><b>const

   </b></font>DBFileName <font color="#000080">= </font><font color="#800000">'dbdemo.dat'</font><font color="#000080">;

   </font>MaxLen <font color="#000080">= </font><font color="#800000">25</font><font color="#000080">;
   </font>CollLimit <font color="#000080">= </font><font color="#800000">$7F</font><font color="#000080">; </font>CollDelta <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;
   </font>InvPID <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;

   </font>cmInfo     <font color="#000080">= </font><font color="#800000">100</font><font color="#000080">;

   </font>cmOpen     <font color="#000080">= </font><font color="#800000">101</font><font color="#000080">;
   </font>cmShut     <font color="#000080">= </font><font color="#800000">102</font><font color="#000080">;
   </font>cmStat     <font color="#000080">= </font><font color="#800000">103</font><font color="#000080">;

   </font>cmCreate   <font color="#000080">= </font><font color="#800000">105</font><font color="#000080">;
   </font>cmGet      <font color="#000080">= </font><font color="#800000">106</font><font color="#000080">;
   </font>cmDelete   <font color="#000080">= </font><font color="#800000">107</font><font color="#000080">;

   </font>cmCommit   <font color="#000080">= </font><font color="#800000">108</font><font color="#000080">;
   </font>cmAbort    <font color="#000080">= </font><font color="#800000">109</font><font color="#000080">;

</font><font color="#FF0000"><b>type

   </b></font>NameString <font color="#000080">= </font><font color="#FF0000"><b>String </b></font><font color="#000080">[</font>MaxLen<font color="#000080">];

   </font>ModDialData <font color="#000080">=
      </font><font color="#FF0000"><b>record
         </b></font>NameData <font color="#000080">: </font>NameString
      <font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>TInvCard <font color="#000080">=
      </font><font color="#FF0000"><b>record
         </b></font>Name <font color="#000080">: </font>NameString<font color="#000080">;
         </font>ID   <font color="#000080">: </font>Word
      <font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>PInvCard <font color="#000080">= ^</font>TInvCard<font color="#000080">;

</font><font color="#008000"><i>{ ----- TCatCollection ----- }

      </i></font>TCatCollection <font color="#000080">=
         </font><font color="#FF0000"><b>object </b></font><font color="#000080">(</font>TSortedCollection<font color="#000080">)
            </font><font color="#FF0000"><b>procedure </b></font>FreeItem <font color="#000080">(</font>Item<font color="#000080">: </font>Pointer<font color="#000080">);                  </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function  </b></font>GetItem  <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">): </font>Pointer<font color="#000080">;        </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>procedure </b></font>PutItem  <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">; </font>Item<font color="#000080">: </font>Pointer<font color="#000080">);  </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function  </b></font>Compare  <font color="#000080">(</font>Key1<font color="#000080">, </font>Key2 <font color="#000080">: </font>Pointer<font color="#000080">): </font>Integer<font color="#000080">;  </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>PCatCollection <font color="#000080">= ^</font>TCatCollection<font color="#000080">;

</font><font color="#008000"><i>{ ----- TDemoApplication class ----- }

   </i></font>TDemoApplication <font color="#000080">=
      </font><font color="#FF0000"><b>object </b></font><font color="#000080">(</font>TApplication<font color="#000080">)

         </font>DB        <font color="#000080">: </font>PBase<font color="#000080">;
         </font>DBFile    <font color="#000080">: </font>PDosStream<font color="#000080">;

         </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">;
         </font><font color="#FF0000"><b>destructor  </b></font>Done<font color="#000080">;                             </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>InitMenuBar<font color="#000080">;                      </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>InitStatusLine<font color="#000080">;                   </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>HandleEvent <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Event<font color="#000080">: </font>TEvent<font color="#000080">);  </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>Idle<font color="#000080">;                             </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>function    </b></font>NameDialog <font color="#000080">(</font>Title<font color="#000080">: </font>TTitleStr<font color="#000080">):
                                </font>PDialog<font color="#000080">;               </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>procedure   </b></font>About<font color="#000080">;                            </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>procedure   </b></font>OpenDB<font color="#000080">;                           </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>ShutDB<font color="#000080">;                           </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>StatInfo<font color="#000080">;                         </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>procedure   </b></font>CreateMod<font color="#000080">;                        </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>GetMod<font color="#000080">;                           </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>DeleteMod<font color="#000080">;                        </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>procedure   </b></font>Commit<font color="#000080">;                           </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>procedure   </b></font>Rollback<font color="#000080">;                         </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>PDemoApplication <font color="#000080">= ^</font>TDemoApplication<font color="#000080">;

</font><font color="#008000"><i>{ -- Implementation of TCatCollection -- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TCatCollection<font color="#000080">.</font>FreeItem <font color="#000080">(</font>Item<font color="#000080">: </font>Pointer<font color="#000080">);

      </font><font color="#FF0000"><b>begin
         </b></font>Dispose <font color="#000080">(</font>Item<font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ FreeItem }

   </i></font><font color="#FF0000"><b>function </b></font>TCatCollection<font color="#000080">.</font>GetItem <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">): </font>Pointer<font color="#000080">;

      </font><font color="#FF0000"><b>var </b></font>Item <font color="#000080">: </font>PInvCard<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>New <font color="#000080">(</font>Item<font color="#000080">);
         </font><font color="#FF0000"><b>with </b></font>S <font color="#FF0000"><b>do
              with </b></font>Item<font color="#000080">^ </font><font color="#FF0000"><b>do
                   begin
                      </b></font>Read <font color="#000080">(</font>Name<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Name<font color="#000080">));
                      </font>Read <font color="#000080">(</font>ID<font color="#000080">,   </font>SizeOf<font color="#000080">(</font>ID<font color="#000080">))
                   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>GetItem <font color="#000080">:= </font>Item
      <font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ GetItem }

   </i></font><font color="#FF0000"><b>procedure </b></font>TCatCollection<font color="#000080">.</font>PutItem <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">; </font>Item<font color="#000080">: </font>Pointer<font color="#000080">);

      </font><font color="#FF0000"><b>begin
         with </b></font>S <font color="#FF0000"><b>do
              with </b></font>TInvCard<font color="#000080">(</font>Item<font color="#000080">^) </font><font color="#FF0000"><b>do
                   begin
                      </b></font>Write <font color="#000080">(</font>Name<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Name<font color="#000080">));
                      </font>Write <font color="#000080">(</font>ID<font color="#000080">,   </font>SizeOf<font color="#000080">(</font>ID<font color="#000080">))
                   </font><font color="#FF0000"><b>end
      end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ PutItem }

   </i></font><font color="#FF0000"><b>function </b></font>TCatCollection<font color="#000080">.</font>Compare <font color="#000080">(</font>Key1<font color="#000080">, </font>Key2 <font color="#000080">: </font>Pointer<font color="#000080">): </font>Integer<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>N1<font color="#000080">, </font>N2 <font color="#000080">: </font>NameString<font color="#000080">;
      </font><font color="#FF0000"><b>begin
         </b></font>N1 <font color="#000080">:= </font>TInvCard<font color="#000080">(</font>Key1<font color="#000080">^).</font>Name<font color="#000080">; </font>N2 <font color="#000080">:= </font>TInvCard<font color="#000080">(</font>Key2<font color="#000080">^).</font>Name<font color="#000080">;
         </font><font color="#FF0000"><b>if </b></font>N1 <font color="#000080">&gt; </font>N2
            <font color="#FF0000"><b>then </b></font>Compare <font color="#000080">:= </font><font color="#800000">1
            </font><font color="#FF0000"><b>else if </b></font>N1 <font color="#000080">&lt; </font>N2
                    <font color="#FF0000"><b>then </b></font>Compare <font color="#000080">:= -</font><font color="#800000">1
                    </font><font color="#FF0000"><b>else </b></font>Compare <font color="#000080">:= </font><font color="#800000">0
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Compare }

{ -- End of TCatCollection implementation -- }

{ ----- TDemoApplication implementation ----- }

{ ----- Init ----- }

   </i></font><font color="#FF0000"><b>constructor </b></font>TDemoApplication<font color="#000080">.</font>Init<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>TApplication<font color="#000080">.</font>Init<font color="#000080">;
         </font>DB <font color="#000080">:= </font><font color="#FF0000"><b>nil
      end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- Done ----- }

   </i></font><font color="#FF0000"><b>destructor </b></font>TDemoApplication<font color="#000080">.</font>Done<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         if </b></font>DB <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil
            then begin
                    </b></font>Dispose <font color="#000080">(</font>DB<font color="#000080">, </font>Done<font color="#000080">);
                    </font>Dispose <font color="#000080">(</font>DBFile<font color="#000080">, </font>Done<font color="#000080">)
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>TApplication<font color="#000080">.</font>Done
      <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- InitMenuBar ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>InitMenuBar<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>MenuRect<font color="#000080">: </font>TRect<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>GetExtent <font color="#000080">(</font>MenuRect<font color="#000080">);
         </font>MenuRect<font color="#000080">.</font>B<font color="#000080">.</font>Y <font color="#000080">:= </font>MenuRect<font color="#000080">.</font>A<font color="#000080">.</font>Y <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
         </font>MenuBar <font color="#000080">:= </font>New <font color="#000080">(</font>PMenuBar<font color="#000080">, </font>Init <font color="#000080">(</font>MenuRect<font color="#000080">, </font>NewMenu <font color="#000080">(
             </font>NewItem <font color="#000080">( </font><font color="#800000">'~I~nfo'</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">, </font>kbNoKey<font color="#000080">, </font>cmInfo<font color="#000080">, </font>hcNoContext<font color="#000080">,
             </font>NewSubMenu <font color="#000080">( </font><font color="#800000">'~D~atabase'</font><font color="#000080">, </font>hcNoContext<font color="#000080">, </font>NewMenu <font color="#000080">(
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~O~pen'</font><font color="#000080">, </font><font color="#800000">'F3'</font><font color="#000080">, </font>kbF3<font color="#000080">, </font>cmOpen<font color="#000080">, </font>hcNoContext<font color="#000080">,
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~S~hut'</font><font color="#000080">, </font><font color="#800000">'F4'</font><font color="#000080">, </font>kbF4<font color="#000080">, </font>cmShut<font color="#000080">, </font>hcNoContext<font color="#000080">,
                </font>NewItem <font color="#000080">( </font><font color="#800000">'S~t~atistics'</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">, </font>kbNoKey<font color="#000080">, </font>cmStat<font color="#000080">, </font>hcNoContext<font color="#000080">,
                </font>NewLine <font color="#000080">(
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~E~xit'</font><font color="#000080">, </font><font color="#800000">'Alt-X'</font><font color="#000080">, </font>kbAltX<font color="#000080">, </font>cmQuit<font color="#000080">, </font>hcNoContext<font color="#000080">,
                   </font><font color="#FF0000"><b>nil </b></font><font color="#000080">)))))),
             </font>NewSubMenu <font color="#000080">( </font><font color="#800000">'~M~odules'</font><font color="#000080">, </font>hcNoContext<font color="#000080">, </font>NewMenu <font color="#000080">(
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~C~reate'</font><font color="#000080">, </font><font color="#800000">'F5'</font><font color="#000080">, </font>kbF5<font color="#000080">, </font>cmCreate<font color="#000080">, </font>hcNoContext<font color="#000080">,
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~G~et'</font><font color="#000080">, </font><font color="#800000">'F6'</font><font color="#000080">, </font>kbF6<font color="#000080">, </font>cmGet<font color="#000080">, </font>hcNoContext<font color="#000080">,
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~D~elete'</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">, </font>kbNoKey<font color="#000080">, </font>cmDelete<font color="#000080">, </font>hcNoContext<font color="#000080">,
                   </font><font color="#FF0000"><b>nil </b></font><font color="#000080">)))),
             </font>NewSubMenu <font color="#000080">( </font><font color="#800000">'~T~ransaction'</font><font color="#000080">, </font>hcNoContext<font color="#000080">, </font>NewMenu <font color="#000080">(
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~C~ommit'</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">, </font>kbNoKey<font color="#000080">, </font>cmCommit<font color="#000080">, </font>hcNoContext<font color="#000080">,
                </font>NewItem <font color="#000080">( </font><font color="#800000">'~R~ollback'</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">, </font>kbNoKey<font color="#000080">, </font>cmAbort<font color="#000080">, </font>hcNoContext<font color="#000080">,
                   </font><font color="#FF0000"><b>nil </b></font><font color="#000080">))),
                  </font><font color="#FF0000"><b>nil </b></font><font color="#000080">)))))))
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- InitStatusLine ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>InitStatusLine<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>StatusRect<font color="#000080">: </font>TRect<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>GetExtent <font color="#000080">(</font>StatusRect<font color="#000080">);
         </font>StatusRect<font color="#000080">.</font>A<font color="#000080">.</font>Y <font color="#000080">:= </font>StatusRect<font color="#000080">.</font>B<font color="#000080">.</font>Y <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
         </font>StatusLine <font color="#000080">:= </font>New <font color="#000080">(</font>PStatusLine<font color="#000080">, </font>Init <font color="#000080">(</font>StatusRect<font color="#000080">,
            </font>NewStatusDef <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">$FFFF</font><font color="#000080">,
               </font>NewStatusKey <font color="#000080">(</font><font color="#800000">'~Alt-X~ - Exit'</font><font color="#000080">, </font>kbAltX<font color="#000080">, </font>cmQuit<font color="#000080">,
               </font>NewStatusKey <font color="#000080">(</font><font color="#800000">'~F3~ - Open database'</font><font color="#000080">, </font>kbF3<font color="#000080">, </font>cmOpen<font color="#000080">,
               </font>NewStatusKey <font color="#000080">(</font><font color="#800000">'~F10~ - Menu'</font><font color="#000080">, </font>kbF10<font color="#000080">, </font>cmMenu<font color="#000080">,
                  </font><font color="#FF0000"><b>nil </b></font><font color="#000080">))),
                 </font><font color="#FF0000"><b>nil </b></font><font color="#000080">)))
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- HandleEvent ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>HandleEvent <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Event<font color="#000080">: </font>TEvent<font color="#000080">);

      </font><font color="#FF0000"><b>begin
         </b></font>TApplication<font color="#000080">.</font>HandleEvent <font color="#000080">(</font>Event<font color="#000080">);
         </font><font color="#FF0000"><b>with </b></font>Event <font color="#FF0000"><b>do
              if </b></font>What <font color="#000080">= </font>evCommand
                 <font color="#FF0000"><b>then begin
                         case </b></font>Command <font color="#FF0000"><b>of

                              </b></font>cmInfo   <font color="#000080">: </font>About<font color="#000080">;

                              </font>cmOpen   <font color="#000080">: </font>OpenDB<font color="#000080">;
                              </font>cmShut   <font color="#000080">: </font>ShutDB<font color="#000080">;
                              </font>cmStat   <font color="#000080">: </font>StatInfo<font color="#000080">;

                              </font>cmCreate <font color="#000080">: </font>CreateMod<font color="#000080">;
                              </font>cmGet    <font color="#000080">: </font>GetMod<font color="#000080">;
                              </font>cmDelete <font color="#000080">: </font>DeleteMod<font color="#000080">;

                              </font>cmCommit <font color="#000080">: </font>Commit<font color="#000080">;
                              </font>cmAbort  <font color="#000080">: </font>Rollback<font color="#000080">;

                              </font><font color="#FF0000"><b>else
                                         </b></font>Exit
                          <font color="#FF0000"><b>end</b></font><font color="#000080">;
                          </font>ClearEvent <font color="#000080">(</font>Event<font color="#000080">)
                      </font><font color="#FF0000"><b>end
      end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- Idle ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>Idle<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>TApplication<font color="#000080">.</font>Idle<font color="#000080">;
         </font><font color="#FF0000"><b>if </b></font>DB <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil
            then </b></font>DB<font color="#000080">^.</font>IdlePack
      <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- NameDialog ----- }

   </i></font><font color="#FF0000"><b>function </b></font>TDemoApplication<font color="#000080">.</font>NameDialog <font color="#000080">(</font>Title<font color="#000080">: </font>TTitleStr<font color="#000080">): </font>PDialog<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>X<font color="#000080">, </font>Y     <font color="#000080">: </font>Word<font color="#000080">;
         </font>R        <font color="#000080">: </font>TRect<font color="#000080">;
         </font>Dial     <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>Bruce    <font color="#000080">: </font>PView<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         if </b></font>DB <font color="#000080">= </font><font color="#FF0000"><b>nil
            then begin
                    </b></font>HandleError <font color="#000080">( ^</font>C<font color="#800000">'Open database at first !' </font><font color="#000080">);
                    </font>NameDialog <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
                    </font>Exit
                 <font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>Randomize<font color="#000080">;
         </font>X <font color="#000080">:= </font><font color="#800000">2 </font><font color="#000080">+ </font>Random <font color="#000080">(</font><font color="#800000">50</font><font color="#000080">); </font>Y <font color="#000080">:= </font><font color="#800000">2 </font><font color="#000080">+ </font>Random <font color="#000080">(</font><font color="#800000">12</font><font color="#000080">);
         </font>R<font color="#000080">.</font>Assign <font color="#000080">(</font>X<font color="#000080">,</font>Y<font color="#000080">,</font>X<font color="#000080">+</font><font color="#800000">28</font><font color="#000080">,</font>Y<font color="#000080">+</font><font color="#800000">9</font><font color="#000080">);
         </font>New <font color="#000080">(</font>Dial<font color="#000080">, </font>Init <font color="#000080">(</font>R<font color="#000080">, </font>Title<font color="#000080">));
         </font><font color="#FF0000"><b>with </b></font>Dial<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>R<font color="#000080">.</font>Assign <font color="#000080">(</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">12</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">);
                 </font>Insert <font color="#000080">(</font>New <font color="#000080">(</font>PButton<font color="#000080">, </font>Init <font color="#000080">(</font>R<font color="#000080">, </font><font color="#800000">'~O~k'</font><font color="#000080">, </font>cmOK<font color="#000080">, </font>bfDefault<font color="#000080">)));
                 </font>R<font color="#000080">.</font>Assign <font color="#000080">(</font><font color="#800000">14</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">24</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">);
                 </font>Insert <font color="#000080">(</font>New <font color="#000080">(</font>PButton<font color="#000080">,
                              </font>Init <font color="#000080">(</font>R<font color="#000080">, </font><font color="#800000">'~C~ancel'</font><font color="#000080">, </font>cmCancel<font color="#000080">, </font>bfNormal<font color="#000080">)));
                 </font>R<font color="#000080">.</font>Assign <font color="#000080">(</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
                 </font>Bruce <font color="#000080">:= </font>New <font color="#000080">(</font>PInputLine<font color="#000080">, </font>Init <font color="#000080">(</font>R<font color="#000080">, </font>MaxLen<font color="#000080">));
                 </font>Insert <font color="#000080">(</font>Bruce<font color="#000080">);
                 </font>R<font color="#000080">.</font>Assign <font color="#000080">(</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">20</font><font color="#000080">,</font><font color="#800000">3</font><font color="#000080">);
                 </font>Insert <font color="#000080">(</font>New <font color="#000080">(</font>PLabel<font color="#000080">, </font>Init <font color="#000080">(</font>R<font color="#000080">, </font><font color="#800000">'Module name:'</font><font color="#000080">, </font>Bruce<font color="#000080">)))
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>NameDialog <font color="#000080">:= </font>Dial
      <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- About ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>About<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>R<font color="#000080">: </font>TRect<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>R<font color="#000080">.</font>Assign <font color="#000080">(</font><font color="#800000">15</font><font color="#000080">,</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">65</font><font color="#000080">,</font><font color="#800000">16</font><font color="#000080">);
         </font>Inform
            <font color="#000080">( </font>R<font color="#000080">,
              ^</font>C<font color="#800000">'This program is intended to demonstrate'</font><font color="#000080">^</font>M <font color="#000080">+
              ^</font>C<font color="#800000">'some features of OODBMS'</font><font color="#000080">^</font>M <font color="#000080">+
              ^</font>C<font color="#800000">'(object-oriented database management system).'</font><font color="#000080">^</font>M <font color="#000080">+
              ^</font>C<font color="#800000">'OODBMS as well as this demo'</font><font color="#000080">^</font>M <font color="#000080">+
              ^</font>C<font color="#800000">'is developed independently by Shmatikov V.'</font><font color="#000080">^</font>M<font color="#000080">^</font>M <font color="#000080">+
              ^</font>C<font color="#800000">'Spring 1992'</font><font color="#000080">,
              </font><font color="#FF0000"><b>nil </b></font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- OpenDB ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>OpenDB<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>Dial    <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>C       <font color="#000080">: </font>Word<font color="#000080">;
         </font>DBIsNew <font color="#000080">: </font>Boolean<font color="#000080">;
         </font>Invent  <font color="#000080">: </font>PCatCollection<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>DBIsNew <font color="#000080">:= </font>False<font color="#000080">;
         </font><font color="#FF0000"><b>if </b></font>DB <font color="#000080">= </font><font color="#FF0000"><b>nil
            then begin
                    if </b></font>Confirm <font color="#000080">( ^</font>C<font color="#800000">'You are to open database.'</font><font color="#000080">^</font>M <font color="#000080">+
                                 ^</font>C<font color="#800000">'Choose Ok to proceed ...' </font><font color="#000080">) =
                       </font>cmCancel
                       <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
                    </font>New <font color="#000080">(</font>DBFile<font color="#000080">, </font>Init <font color="#000080">(</font>DBFileName<font color="#000080">, </font>stOpen<font color="#000080">));
                    </font><font color="#FF0000"><b>if </b></font>DBFile<font color="#000080">^.</font>Status <font color="#000080">&lt;&gt; </font>stOk
                       <font color="#FF0000"><b>then begin
                               </b></font>Dispose <font color="#000080">(</font>DBFile<font color="#000080">, </font>Done<font color="#000080">);
                               </font>New <font color="#000080">(</font>DBFile<font color="#000080">, </font>Init <font color="#000080">(</font>DBFileName<font color="#000080">, </font>stCreate<font color="#000080">));
                               </font>DBIsNew <font color="#000080">:= </font>True<font color="#000080">;
                            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                    </font>New <font color="#000080">(</font>DB<font color="#000080">, </font>Init <font color="#000080">(</font>DBFile<font color="#000080">));
                    </font><font color="#FF0000"><b>if </b></font>DBIsNew
                       <font color="#FF0000"><b>then begin
                               </b></font>New <font color="#000080">(</font>Invent<font color="#000080">, </font>Init <font color="#000080">(</font>CollLimit<font color="#000080">, </font>CollDelta<font color="#000080">));
                               </font>DB<font color="#000080">^.</font>Put <font color="#000080">(</font>InvPID<font color="#000080">, </font>Invent<font color="#000080">);
                               </font>Inc <font color="#000080">(</font>DB<font color="#000080">^.</font>PIDCurrent<font color="#000080">);
                               </font>Dispose <font color="#000080">(</font>Invent<font color="#000080">, </font>Done<font color="#000080">)
                            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                    </font>DB<font color="#000080">^.</font>Commit
                 <font color="#FF0000"><b>end
            else </b></font>HandleError <font color="#000080">( ^</font>C<font color="#800000">'Database is in use already !' </font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- ShutDB ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>ShutDB<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>Dial <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>C    <font color="#000080">: </font>Word<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         if </b></font>DB <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil
            then begin
                    if </b></font>Confirm <font color="#000080">( ^</font>C<font color="#800000">'You are about to close database'</font><font color="#000080">^</font>M <font color="#000080">+
                                 ^</font>C<font color="#800000">'Choose Ok to do it !' </font><font color="#000080">) =
                       </font>cmCancel
                       <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
                    </font>Dispose <font color="#000080">(</font>DB<font color="#000080">, </font>Done<font color="#000080">); </font>DB <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
                    </font>Dispose <font color="#000080">(</font>DBFile<font color="#000080">, </font>Done<font color="#000080">); </font>DBFile <font color="#000080">:= </font><font color="#FF0000"><b>nil
                 end
            else </b></font>HandleError <font color="#000080">( ^</font>C<font color="#800000">'No database is in use now !' </font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- StatInfo ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>StatInfo<font color="#000080">;

      </font><font color="#FF0000"><b>type
           </b></font>InfoRec <font color="#000080">=
              </font><font color="#FF0000"><b>record
                 </b></font>FileName            <font color="#000080">: </font>PString<font color="#000080">;
                 </font>NumObj<font color="#000080">,   </font>SizeObj<font color="#000080">,
                 </font>NumHoles<font color="#000080">, </font>SizeHoles<font color="#000080">,
                 </font>SizeAnc<font color="#000080">,  </font>TotalSize <font color="#000080">: </font>Longint
              <font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>R       <font color="#000080">: </font>TRect<font color="#000080">;
         </font>DataRec <font color="#000080">: </font>InfoRec<font color="#000080">;
         </font>i       <font color="#000080">: </font>Integer<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         if </b></font>DB <font color="#000080">= </font><font color="#FF0000"><b>nil
            then begin
                    </b></font>HandleError <font color="#000080">( ^</font>C<font color="#800000">'Open database at first !' </font><font color="#000080">);
                    </font>Exit
                 <font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>with </b></font>DB<font color="#000080">^ </font><font color="#FF0000"><b>do
              with </b></font>DataRec <font color="#FF0000"><b>do
                   begin
                      </b></font>FileName<font color="#000080">^ := </font>DBFileName<font color="#000080">;
                      </font>NumObj <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>SizeObj <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                      </font><font color="#FF0000"><b>For </b></font>i <font color="#000080">:= </font><font color="#800000">2 </font><font color="#FF0000"><b>to </b></font>DBIndex<font color="#000080">^.</font>Count <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do
                          if </b></font><font color="#000080">(</font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base <font color="#000080">= </font>i<font color="#000080">) </font><font color="#FF0000"><b>and
                             </b></font><font color="#000080">(</font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)^).</font>Base <font color="#000080">&lt;&gt; </font>i<font color="#000080">)
                             </font><font color="#FF0000"><b>then begin
                                     </b></font>Inc <font color="#000080">(</font>NumObj<font color="#000080">);
                                     </font>SizeObj <font color="#000080">:= </font>SizeObj <font color="#000080">+
                                                </font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Size
                                  <font color="#FF0000"><b>end</b></font><font color="#000080">;
                      </font>NumHoles <font color="#000080">:= </font>HolesIndex<font color="#000080">^.</font>Count<font color="#000080">; </font>SizeHoles <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                      </font><font color="#FF0000"><b>For </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumHoles<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                          </b></font>SizeHoles <font color="#000080">:= </font>SizeHoles <font color="#000080">+
                                       </font>IndRec<font color="#000080">(</font>HolesIndex<font color="#000080">^.</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Size<font color="#000080">;
                      </font>SizeAnc <font color="#000080">:= </font>DBFile<font color="#000080">^.</font>GetSize <font color="#000080">- </font>SizeObj <font color="#000080">- </font>SizeHoles<font color="#000080">;
                      </font>TotalSize <font color="#000080">:= </font>DBFile<font color="#000080">^.</font>GetSize
                   <font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>R<font color="#000080">.</font>Assign <font color="#000080">(</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">70</font><font color="#000080">,</font><font color="#800000">15</font><font color="#000080">);
         </font>Inform
            <font color="#000080">( </font>R<font color="#000080">,
              </font><font color="#800000">'Database file &quot;%s&quot; is in use'</font><font color="#000080">^</font>M<font color="#000080">^</font>M <font color="#000080">+
              </font><font color="#800000">' - %d user object(s) hold(s) %d byte(s) in file'</font><font color="#000080">^</font>M <font color="#000080">+
              </font><font color="#800000">' - %d hole(s) hold(s) %d byte(s) in file'</font><font color="#000080">^</font>M <font color="#000080">+
              </font><font color="#800000">' - Ancillary information holds %d byte(s)'</font><font color="#000080">^</font>M <font color="#000080">+
              </font><font color="#800000">' - Total size of database is %d byte(s)'</font><font color="#000080">,
              @</font>DataRec <font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- CreateMod ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>CreateMod<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>NewDial  <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>C        <font color="#000080">: </font>Word<font color="#000080">;
         </font>DialData <font color="#000080">: </font>ModDialData<font color="#000080">;
         </font>Card     <font color="#000080">: </font>PInvCard<font color="#000080">;
         </font>Invent   <font color="#000080">: </font>PCatCollection<font color="#000080">;
         </font>PID      <font color="#000080">: </font>Word<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>NewDial <font color="#000080">:= </font>NameDialog <font color="#000080">(</font><font color="#800000">'New module'</font><font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>NewDial <font color="#000080">= </font><font color="#FF0000"><b>nil
            then </b></font>Exit<font color="#000080">;
         </font>C <font color="#000080">:= </font>DeskTop<font color="#000080">^.</font>ExecView <font color="#000080">(</font>NewDial<font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>C <font color="#000080">&lt;&gt; </font>CmCancel
            <font color="#FF0000"><b>then begin
                    </b></font>NewDial<font color="#000080">^.</font>GetData <font color="#000080">(</font>DialData<font color="#000080">);
                    </font><font color="#FF0000"><b>if </b></font>DialData<font color="#000080">.</font>NameData <font color="#000080">&lt;&gt; </font><font color="#800000">''
                       </font><font color="#FF0000"><b>then begin
                               </b></font>Invent <font color="#000080">:= </font>PCatCollection <font color="#000080">(</font>DB<font color="#000080">^.</font>Get <font color="#000080">(</font>InvPID<font color="#000080">));
                               </font>New <font color="#000080">(</font>Card<font color="#000080">);
                               </font>PID <font color="#000080">:= </font>DB<font color="#000080">^.</font>Create<font color="#000080">;
                               </font>Card<font color="#000080">^.</font>Name <font color="#000080">:= </font>DialData<font color="#000080">.</font>NameData<font color="#000080">;
                               </font>Card<font color="#000080">^.</font>ID <font color="#000080">:= </font>PID<font color="#000080">;
                               </font>Invent<font color="#000080">^.</font>Insert <font color="#000080">(</font>Card<font color="#000080">);
                               </font>DB<font color="#000080">^.</font>Put <font color="#000080">(</font>PID<font color="#000080">, </font>NewDial<font color="#000080">);
                               </font>DB<font color="#000080">^.</font>Destroy <font color="#000080">(</font>InvPID<font color="#000080">);
                               </font>DB<font color="#000080">^.</font>Put <font color="#000080">(</font>InvPID<font color="#000080">, </font>Invent<font color="#000080">);
                               </font>Dispose <font color="#000080">(</font>Invent<font color="#000080">, </font>Done<font color="#000080">)
                            </font><font color="#FF0000"><b>end
                 end</b></font><font color="#000080">;
         </font>Dispose <font color="#000080">(</font>NewDial<font color="#000080">, </font>Done<font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- GetMod ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>GetMod<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>Dial<font color="#000080">,
         </font>DialFromDB <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>C          <font color="#000080">: </font>Word<font color="#000080">;
         </font>DialData   <font color="#000080">: </font>ModDialData<font color="#000080">;
         </font>Card       <font color="#000080">: </font>PInvCard<font color="#000080">;
         </font>Invent     <font color="#000080">: </font>PCatCollection<font color="#000080">;
         </font>Ind        <font color="#000080">: </font>Integer<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>Dial <font color="#000080">:= </font>NameDialog <font color="#000080">(</font><font color="#800000">'Get'</font><font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>Dial <font color="#000080">= </font><font color="#FF0000"><b>nil
            then </b></font>Exit<font color="#000080">;
         </font>C <font color="#000080">:= </font>DeskTop<font color="#000080">^.</font>ExecView <font color="#000080">(</font>Dial<font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>C <font color="#000080">&lt;&gt; </font>CmCancel
            <font color="#FF0000"><b>then begin
                    </b></font>Dial<font color="#000080">^.</font>GetData <font color="#000080">(</font>DialData<font color="#000080">);
                    </font>New <font color="#000080">(</font>Card<font color="#000080">);
                    </font>Card<font color="#000080">^.</font>Name <font color="#000080">:= </font>DialData<font color="#000080">.</font>NameData<font color="#000080">;
                    </font>Invent <font color="#000080">:= </font>PCatCollection <font color="#000080">(</font>DB<font color="#000080">^.</font>Get <font color="#000080">(</font>InvPID<font color="#000080">));
                    </font><font color="#FF0000"><b>if </b></font>Invent<font color="#000080">^.</font>Search <font color="#000080">(</font>Card<font color="#000080">, </font>Ind<font color="#000080">)
                       </font><font color="#FF0000"><b>then begin
                               </b></font>DialFromDB <font color="#000080">:=
                                   </font>PDialog <font color="#000080">(</font>DB<font color="#000080">^.</font>Get
                                           <font color="#000080">(</font>TInvCard<font color="#000080">(</font>Invent<font color="#000080">^.</font>At<font color="#000080">(</font>Ind<font color="#000080">)^).</font>ID<font color="#000080">));
                               </font>C <font color="#000080">:= </font>ExecView <font color="#000080">(</font>DialFromDB<font color="#000080">);
                               </font>Dispose <font color="#000080">(</font>DialFromDB<font color="#000080">, </font>Done<font color="#000080">)
                            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                    </font>Dispose <font color="#000080">(</font>Invent<font color="#000080">, </font>Done<font color="#000080">)
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>Dispose <font color="#000080">(</font>Dial<font color="#000080">, </font>Done<font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- DeleteMod ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>DeleteMod<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>Dial     <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>C        <font color="#000080">: </font>Word<font color="#000080">;
         </font>DialData <font color="#000080">: </font>ModDialData<font color="#000080">;
         </font>Card     <font color="#000080">: </font>PInvCard<font color="#000080">;
         </font>Invent   <font color="#000080">: </font>PCatCollection<font color="#000080">;
         </font>Ind      <font color="#000080">: </font>Integer<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>Dial <font color="#000080">:= </font>NameDialog <font color="#000080">(</font><font color="#800000">'Delete'</font><font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>Dial <font color="#000080">= </font><font color="#FF0000"><b>nil
            then </b></font>Exit<font color="#000080">;
         </font>C <font color="#000080">:= </font>DeskTop<font color="#000080">^.</font>ExecView <font color="#000080">(</font>Dial<font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>C <font color="#000080">&lt;&gt; </font>CmCancel
            <font color="#FF0000"><b>then begin
                    </b></font>Dial<font color="#000080">^.</font>GetData <font color="#000080">(</font>DialData<font color="#000080">);
                    </font>New <font color="#000080">(</font>Card<font color="#000080">);
                    </font>Card<font color="#000080">^.</font>Name <font color="#000080">:= </font>DialData<font color="#000080">.</font>NameData<font color="#000080">;
                    </font>Invent <font color="#000080">:= </font>PCatCollection <font color="#000080">(</font>DB<font color="#000080">^.</font>Get <font color="#000080">(</font>InvPID<font color="#000080">));
                    </font><font color="#FF0000"><b>if </b></font>Invent<font color="#000080">^.</font>Search <font color="#000080">(</font>Card<font color="#000080">, </font>Ind<font color="#000080">)
                       </font><font color="#FF0000"><b>then begin
                               </b></font>DB<font color="#000080">^.</font>Destroy <font color="#000080">(</font>TInvCard<font color="#000080">(</font>Invent<font color="#000080">^.</font>At<font color="#000080">(</font>Ind<font color="#000080">)^).</font>ID<font color="#000080">);
                               </font>Invent<font color="#000080">^.</font>AtDelete <font color="#000080">(</font>Ind<font color="#000080">);
                               </font>DB<font color="#000080">^.</font>Destroy <font color="#000080">(</font>InvPID<font color="#000080">);
                               </font>DB<font color="#000080">^.</font>Put <font color="#000080">(</font>InvPID<font color="#000080">, </font>Invent<font color="#000080">)
                            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                    </font>Dispose <font color="#000080">(</font>Invent<font color="#000080">, </font>Done<font color="#000080">)
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>Dispose <font color="#000080">(</font>Dial<font color="#000080">, </font>Done<font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- Commit ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>Commit<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>Dial <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>C    <font color="#000080">: </font>Word<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         if </b></font>DB <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil
            then begin
                    if </b></font>Confirm
                       <font color="#000080">( ^</font>C<font color="#800000">'All changes you''ve made since last Commit '</font><font color="#000080">^</font>M <font color="#000080">+
                         ^</font>C<font color="#800000">'will be placed into the database forever !' </font><font color="#000080">) =
                       </font>cmCancel
                       <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
                    </font>DB<font color="#000080">^.</font>Commit
                 <font color="#FF0000"><b>end
            else </b></font>HandleError <font color="#000080">( ^</font>C<font color="#800000">'No database is in use now !' </font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- Rollback ----- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TDemoApplication<font color="#000080">.</font>Rollback<font color="#000080">;

      </font><font color="#FF0000"><b>var
         </b></font>Dial   <font color="#000080">: </font>PDialog<font color="#000080">;
         </font>C      <font color="#000080">: </font>Word<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         if </b></font>DB <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil
            then begin
                    if </b></font>Confirm
                       <font color="#000080">( ^</font>C<font color="#800000">'You are restoring database to its old state.'</font><font color="#000080">^</font>M <font color="#000080">+
                         ^</font>C<font color="#800000">'Changes since last Commit will be lost !' </font><font color="#000080">) =
                       </font>cmCancel
                       <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
                    </font>DB<font color="#000080">^.</font>Abort<font color="#000080">;
                 </font><font color="#FF0000"><b>end
            else </b></font>HandleError <font color="#000080">( ^</font>C<font color="#800000">'No database is in use now !' </font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>RegisterAll<font color="#000080">;

    </font><font color="#FF0000"><b>const
       </b></font>RCatCollection<font color="#000080">: </font>TStreamRec <font color="#000080">=
           ( </font>ObjType <font color="#000080">: </font><font color="#800000">10001</font><font color="#000080">;
             </font>VMTLink <font color="#000080">: </font>Ofs<font color="#000080">(</font>TypeOf<font color="#000080">(</font>TCatCollection<font color="#000080">)^);
             </font>Load    <font color="#000080">: @</font>TCatCollection<font color="#000080">.</font>Load<font color="#000080">;
             </font>Store   <font color="#000080">: @</font>TCatCollection<font color="#000080">.</font>Store <font color="#000080">);

    </font><font color="#FF0000"><b>begin
       </b></font>RegisterObjects<font color="#000080">;
       </font>RegisterViews<font color="#000080">;
       </font>RegisterDialogs<font color="#000080">;
       </font>RegisterType <font color="#000080">(</font>RCatCollection<font color="#000080">)
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ----- Program body ----- }

   </i></font><font color="#FF0000"><b>var
      </b></font>DA     <font color="#000080">: </font>TDemoApplication<font color="#000080">;

   </font><font color="#FF0000"><b>begin
      </b></font>RegisterAll<font color="#000080">;
      </font>DA<font color="#000080">.</font>Init<font color="#000080">;
      </font>DA<font color="#000080">.</font>Run<font color="#000080">;
      </font>DA<font color="#000080">.</font>Done
   <font color="#FF0000"><b>end</b></font><font color="#000080">.

   </font><font color="#008000"><i>{ ---------------------   LAYOUT.PAS ---------------------- }
   { CUT }

</i></font><font color="#FF0000"><b>unit </b></font>Layout<font color="#000080">;

</font><font color="#FF0000"><b>interface

   uses </b></font>Objects<font color="#000080">, </font>MsgBox<font color="#000080">;

   </font><font color="#FF0000"><b>procedure </b></font>HandleError <font color="#000080">( </font>Mess<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
   </font><font color="#FF0000"><b>procedure </b></font>Inform <font color="#000080">( </font>R<font color="#000080">: </font>TRect<font color="#000080">; </font>Mess<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Params<font color="#000080">: </font>Pointer <font color="#000080">);
   </font><font color="#FF0000"><b>function  </b></font>Confirm <font color="#000080">( </font>Mess<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">): </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>implementation

   procedure </b></font>HandleError <font color="#000080">( </font>Mess<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
       </font><font color="#FF0000"><b>var </b></font>C<font color="#000080">: </font>Word<font color="#000080">;
       </font><font color="#FF0000"><b>begin
          </b></font>C <font color="#000080">:= </font>MessageBox <font color="#000080">( </font>Mess<font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>mfError <font color="#000080">+ </font>mfOKButton <font color="#000080">)
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>procedure </b></font>Inform <font color="#000080">( </font>R<font color="#000080">: </font>TRect<font color="#000080">; </font>Mess<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Params<font color="#000080">: </font>Pointer <font color="#000080">);
       </font><font color="#FF0000"><b>var </b></font>C<font color="#000080">: </font>Word<font color="#000080">;
       </font><font color="#FF0000"><b>begin
          </b></font>C <font color="#000080">:= </font>MessageBoxRect <font color="#000080">( </font>R<font color="#000080">, </font>Mess<font color="#000080">, </font>Params<font color="#000080">,
                                </font>mfInformation <font color="#000080">+ </font>mfOKButton <font color="#000080">)
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>function </b></font>Confirm <font color="#000080">( </font>Mess<font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">): </font>Word<font color="#000080">;
       </font><font color="#FF0000"><b>var </b></font>R<font color="#000080">: </font>TRect<font color="#000080">;
       </font><font color="#FF0000"><b>begin
          </b></font>R<font color="#000080">.</font>Assign <font color="#000080">(</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">60</font><font color="#000080">,</font><font color="#800000">12</font><font color="#000080">);
          </font>Confirm <font color="#000080">:= </font>MessageBoxRect <font color="#000080">( </font>R<font color="#000080">, </font>Mess<font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">,
                                      </font>mfConfirmation <font color="#000080">+ </font>mfOKCancel <font color="#000080">)
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>end</b></font><font color="#000080">.

   </font><font color="#008000"><i>{ ---------------------   OODB.PAS ---------------------- }
   { CUT }

</i></font><font color="#FF0000"><b>unit </b></font>OODB<font color="#000080">;

</font><font color="#FF0000"><b>interface

   uses </b></font>Objects<font color="#000080">;

   </font><font color="#FF0000"><b>const
      </b></font>PIDLimit<font color="#000080">: </font>Word <font color="#000080">= </font><font color="#800000">$7FFF</font><font color="#000080">;
      </font>Delta <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;
      </font>Hallmark <font color="#000080">= </font><font color="#800000">9999</font><font color="#000080">;
      </font>IndexPointerLocation <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;
      </font>StorageStart <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;

   </font><font color="#FF0000"><b>type

      </b></font><font color="#008000"><i>{ Record type for object registration }

      </i></font>IndRec <font color="#000080">=
         </font><font color="#FF0000"><b>record
            </b></font>ID        <font color="#000080">: </font>Word<font color="#000080">;
            </font>StartPos<font color="#000080">,
            </font>Size      <font color="#000080">: </font>Longint<font color="#000080">;
            </font>Base      <font color="#000080">: </font>Integer
         <font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>PIndRec <font color="#000080">= ^</font>IndRec<font color="#000080">;

      </font><font color="#008000"><i>{ Stream for object size evaluation }

      </i></font>TNullStream <font color="#000080">=
         </font><font color="#FF0000"><b>object </b></font><font color="#000080">(</font>TStream<font color="#000080">)
            </font>SizeCounter <font color="#000080">: </font>Longint<font color="#000080">;
            </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">;
            </font><font color="#FF0000"><b>procedure   </b></font>ResetCounter<font color="#000080">;                   </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>procedure   </b></font>Write <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);   </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function    </b></font>SizeInStream<font color="#000080">: </font>Longint<font color="#000080">;          </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>PNullStream <font color="#000080">= ^</font>TNullStream<font color="#000080">;

      </font><font color="#008000"><i>{ Stream - database main storage }

      </i></font>DBStream <font color="#000080">= </font>TStream<font color="#000080">;
      </font>PDBStream <font color="#000080">= ^</font>DBStream<font color="#000080">;

      </font><font color="#008000"><i>{ Collection for indexes }

      </i></font>TIndexCollection <font color="#000080">=
         </font><font color="#FF0000"><b>object </b></font><font color="#000080">(</font>TCollection<font color="#000080">)
            </font><font color="#FF0000"><b>procedure </b></font>FreeItem <font color="#000080">(</font>Item<font color="#000080">: </font>Pointer<font color="#000080">);                 </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function  </b></font>GetItem <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">): </font>Pointer<font color="#000080">;        </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>procedure </b></font>PutItem <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">; </font>Item<font color="#000080">: </font>Pointer<font color="#000080">);  </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>PIndexCollection <font color="#000080">= ^</font>TIndexCollection<font color="#000080">;

      </font><font color="#008000"><i>{ --- TBASE - the main class --- }

      </i></font>TBase <font color="#000080">=
         </font><font color="#FF0000"><b>object </b></font><font color="#000080">(</font>TObject<font color="#000080">)

            </font>BaseStream <font color="#000080">: </font>PDBStream<font color="#000080">;         </font><font color="#008000"><i>{ Main storage pointer }
            </i></font>DBIndex<font color="#000080">,                        </font><font color="#008000"><i>{ Database index }
            </i></font>HolesIndex <font color="#000080">: </font>PIndexCollection<font color="#000080">;  </font><font color="#008000"><i>{ Holes index }
            </i></font>PIDCurrent <font color="#000080">: </font>Word<font color="#000080">;              </font><font color="#008000"><i>{ Unique identifier }
            </i></font>NS         <font color="#000080">: </font>PNullStream<font color="#000080">;       </font><font color="#008000"><i>{ For object size evaluation }
            </i></font>DoneFlag   <font color="#000080">: </font>Boolean<font color="#000080">;           </font><font color="#008000"><i>{ True if OODB is being disposed }

            </i></font><font color="#FF0000"><b>function  </b></font>BytesInStream <font color="#000080">(</font>P<font color="#000080">: </font>PObject<font color="#000080">): </font>Longint <font color="#000080">;
                               </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>procedure </b></font>IndexSort <font color="#000080">(</font>Cat<font color="#000080">: </font>PIndexCollection<font color="#000080">; </font>StOrd<font color="#000080">: </font>Boolean<font color="#000080">);
                               </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function  </b></font>IndexFound <font color="#000080">(</font>Cat<font color="#000080">: </font>PIndexCollection<font color="#000080">;
                                  </font>LookFor<font color="#000080">: </font>Longint<font color="#000080">;
                                  </font><font color="#FF0000"><b>var </b></font>Pos<font color="#000080">: </font>Integer<font color="#000080">;
                                  </font>PIDSorted<font color="#000080">: </font>Boolean<font color="#000080">): </font>Boolean<font color="#000080">;
                               </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function  </b></font>HoleFound <font color="#000080">(</font>S<font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Pos<font color="#000080">: </font>Longint<font color="#000080">): </font>Boolean<font color="#000080">;
                               </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

            </font><font color="#FF0000"><b>procedure   </b></font>Abort<font color="#000080">;                          </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>procedure   </b></font>Commit<font color="#000080">;                         </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>constructor </b></font>Init <font color="#000080">(</font>AStream<font color="#000080">: </font>PDBStream<font color="#000080">);
            </font><font color="#FF0000"><b>destructor  </b></font>Done<font color="#000080">;                           </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function    </b></font>Create<font color="#000080">: </font>Word<font color="#000080">;                   </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>procedure   </b></font>Put <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">; </font>P<font color="#000080">: </font>PObject<font color="#000080">);    </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function    </b></font>Get <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">): </font>PObject<font color="#000080">;       </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>procedure   </b></font>Destroy <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">);            </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

            </font><font color="#FF0000"><b>function    </b></font>ObjSize <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">): </font>Longint<font color="#000080">;   </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>function    </b></font>Count<font color="#000080">: </font>Integer<font color="#000080">;                 </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

            </font><font color="#FF0000"><b>procedure   </b></font>IdlePack<font color="#000080">;                       </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ -- TBase -- }
      </i></font>PBase <font color="#000080">= ^</font>TBase<font color="#000080">;

</font><font color="#FF0000"><b>implementation

   </b></font><font color="#008000"><i>{ -- Implementation of TNullStream -- }

   </i></font><font color="#FF0000"><b>constructor </b></font>TNullStream<font color="#000080">.</font>Init<font color="#000080">;
      </font><font color="#FF0000"><b>begin
         </b></font>TStream<font color="#000080">.</font>Init<font color="#000080">;
         </font>ResetCounter
      <font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>procedure </b></font>TNullStream<font color="#000080">.</font>ResetCounter<font color="#000080">;
      </font><font color="#FF0000"><b>begin
         </b></font>SizeCounter <font color="#000080">:= </font><font color="#800000">0
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>procedure </b></font>TNullStream<font color="#000080">.</font>Write <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);
      </font><font color="#008000"><i>{ Overrides TStream.Write method }
      </i></font><font color="#FF0000"><b>begin
         </b></font>SizeCounter <font color="#000080">:= </font>SizeCounter <font color="#000080">+ </font>Count
      <font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>function </b></font>TNullStream<font color="#000080">.</font>SizeInStream<font color="#000080">: </font>Longint<font color="#000080">;
      </font><font color="#FF0000"><b>begin
         </b></font>SizeInStream <font color="#000080">:= </font>SizeCounter
      <font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#008000"><i>{ -- End of TNullStream implementation -- }

   { -- Implementation of TIndexCollection -- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TIndexCollection<font color="#000080">.</font>FreeItem <font color="#000080">(</font>Item<font color="#000080">: </font>Pointer<font color="#000080">);

      </font><font color="#FF0000"><b>begin
         </b></font>Dispose <font color="#000080">(</font>Item<font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ FreeItem }

   </i></font><font color="#FF0000"><b>function </b></font>TIndexCollection<font color="#000080">.</font>GetItem <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">): </font>Pointer<font color="#000080">;

      </font><font color="#FF0000"><b>var </b></font>Item <font color="#000080">: </font>PIndRec<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>New <font color="#000080">(</font>Item<font color="#000080">);
         </font><font color="#FF0000"><b>with </b></font>S <font color="#FF0000"><b>do
              with </b></font>Item<font color="#000080">^ </font><font color="#FF0000"><b>do
                   begin
                      </b></font>Read <font color="#000080">(</font>ID<font color="#000080">, </font>SizeOf<font color="#000080">(</font>ID<font color="#000080">));
                      </font>Read <font color="#000080">(</font>StartPos<font color="#000080">, </font>SizeOf<font color="#000080">(</font>StartPos<font color="#000080">));
                      </font>Read <font color="#000080">(</font>Size<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Size<font color="#000080">));
                      </font>Read <font color="#000080">(</font>Base<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Base<font color="#000080">))
                   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>GetItem <font color="#000080">:= </font>Item
      <font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ GetItem }

   </i></font><font color="#FF0000"><b>procedure </b></font>TIndexCollection<font color="#000080">.</font>PutItem <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">; </font>Item<font color="#000080">: </font>Pointer<font color="#000080">);

      </font><font color="#FF0000"><b>begin
         with </b></font>S <font color="#FF0000"><b>do
              with </b></font>IndRec<font color="#000080">(</font>Item<font color="#000080">^) </font><font color="#FF0000"><b>do
                   begin
                      </b></font>Write <font color="#000080">(</font>ID<font color="#000080">, </font>SizeOf<font color="#000080">(</font>ID<font color="#000080">));
                      </font>Write <font color="#000080">(</font>StartPos<font color="#000080">, </font>SizeOf<font color="#000080">(</font>StartPos<font color="#000080">));
                      </font>Write <font color="#000080">(</font>Size<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Size<font color="#000080">));
                      </font>Write <font color="#000080">(</font>Base<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Base<font color="#000080">))
                   </font><font color="#FF0000"><b>end
      end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ PutItem }

   { -- End of TIndexCollection implementation -- }

   { -- TBASE IMPLEMENTATION -- }

   { ----- BytesInStream ------------------------------------------ }

   </i></font><font color="#FF0000"><b>function </b></font>TBase<font color="#000080">.</font>BytesInStream <font color="#000080">(</font>P<font color="#000080">: </font>PObject<font color="#000080">): </font>Longint <font color="#000080">;

   </font><font color="#008000"><i>{ Determines the number of bytes required
     to put an object into the stream }

      </i></font><font color="#FF0000"><b>begin
         with </b></font>NS<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>ResetCounter<font color="#000080">;
                 </font>Put <font color="#000080">(</font>P<font color="#000080">);
                 </font>BytesInStream <font color="#000080">:= </font>SizeInStream
              <font color="#FF0000"><b>end
      end</b></font><font color="#000080">;

   </font><font color="#008000"><i>{ ----- IndexSort ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TBase<font color="#000080">.</font>IndexSort <font color="#000080">(</font>Cat<font color="#000080">: </font>PIndexCollection<font color="#000080">; </font>StOrd<font color="#000080">: </font>Boolean<font color="#000080">);

   </font><font color="#008000"><i>{ Bubble-sorts any index (DBIndex or HolesIndex) according either to
     StartPos'es in a stream (StOrd = True) or to PID's (StOrd = False) }

      </i></font><font color="#FF0000"><b>var
         </b></font>i<font color="#000080">, </font>j<font color="#000080">, </font>k <font color="#000080">: </font>Integer<font color="#000080">;
         </font>Min     <font color="#000080">: </font>Longint<font color="#000080">;
         </font>Aux     <font color="#000080">: </font>PIndRec<font color="#000080">;

      </font><font color="#FF0000"><b>begin

         with </b></font>Cat<font color="#000080">^ </font><font color="#FF0000"><b>do

              for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count<font color="#000080">-</font><font color="#800000">2 </font><font color="#FF0000"><b>do

                  begin
                     if </b></font>StOrd
                        <font color="#FF0000"><b>then begin
                                </b></font>Min <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>StartPos<font color="#000080">; </font>k <font color="#000080">:= </font>i<font color="#000080">;
                                </font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font>i<font color="#000080">+</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                                    if </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>j<font color="#000080">)^).</font>StartPos <font color="#000080">&lt; </font>Min
                                        <font color="#FF0000"><b>then begin
                                                </b></font>k <font color="#000080">:= </font>j<font color="#000080">;
                                                </font>Min <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>k<font color="#000080">)^).</font>StartPos
                                             <font color="#FF0000"><b>end
                             end
                        else begin
                                </b></font>Min <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>ID<font color="#000080">; </font>k <font color="#000080">:= </font>i<font color="#000080">;
                                </font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font>i<font color="#000080">+</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                                    if </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>j<font color="#000080">)^).</font>ID <font color="#000080">&lt; </font>Min
                                       <font color="#FF0000"><b>then begin
                                               </b></font>k <font color="#000080">:= </font>j<font color="#000080">;
                                               </font>Min <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>k<font color="#000080">)^).</font>ID
                                            <font color="#FF0000"><b>end
                             end</b></font><font color="#000080">;
                     </font>Aux <font color="#000080">:= </font>At <font color="#000080">(</font>i<font color="#000080">);
                     </font>AtPut <font color="#000080">(</font>i<font color="#000080">,</font>At<font color="#000080">(</font>k<font color="#000080">)); </font>AtPut <font color="#000080">(</font>k<font color="#000080">,</font>Aux<font color="#000080">)    </font><font color="#008000"><i>{ Bubble is up }
                  </i></font><font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ for }

      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ IndexSort }

   { ----- IndexFound --------------------------------------------- }

   </i></font><font color="#FF0000"><b>function </b></font>TBase<font color="#000080">.</font>IndexFound
                  <font color="#000080">(</font>Cat<font color="#000080">: </font>PIndexCollection<font color="#000080">; </font>LookFor<font color="#000080">: </font>Longint<font color="#000080">;
                   </font><font color="#FF0000"><b>var </b></font>Pos<font color="#000080">: </font>Integer<font color="#000080">; </font>PIDSorted<font color="#000080">: </font>Boolean<font color="#000080">)    : </font>Boolean<font color="#000080">;

   </font><font color="#008000"><i>{ Looks for LookFor in Cat^ index (binary search) and returns True
     if hits it. Position for LookFor (Pos) is located by all means }

      </i></font><font color="#FF0000"><b>var
         </b></font>m<font color="#000080">, </font>j  <font color="#000080">: </font>Integer<font color="#000080">;
         </font>Value <font color="#000080">: </font>Longint<font color="#000080">;     </font><font color="#008000"><i>{ Value that is found }

      </i></font><font color="#FF0000"><b>begin

         </b></font>IndexFound <font color="#000080">:= </font>False<font color="#000080">;
         </font><font color="#FF0000"><b>with </b></font>Cat<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>Pos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>j <font color="#000080">:= </font>Count<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
                 </font><font color="#FF0000"><b>if </b></font>j <font color="#000080">&lt; </font>Pos
                    <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
                 </font><font color="#FF0000"><b>while </b></font>j <font color="#000080">&gt; </font>Pos <font color="#FF0000"><b>do
                       begin
                          </b></font>m <font color="#000080">:= ( </font>Pos <font color="#000080">+ </font>j <font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
                          </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>PIDSorted <font color="#FF0000"><b>and
                               </b></font><font color="#000080">(</font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>m<font color="#000080">)^).</font>ID <font color="#000080">&gt;= </font>LookFor<font color="#000080">) )
                             </font><font color="#FF0000"><b>or
                             </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>PIDSorted <font color="#FF0000"><b>and
                               </b></font><font color="#000080">(</font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>m<font color="#000080">)^).</font>StartPos <font color="#000080">&gt;= </font>LookFor<font color="#000080">) )
                             </font><font color="#FF0000"><b>then </b></font>j <font color="#000080">:= </font>m
                             <font color="#FF0000"><b>else </b></font>Pos <font color="#000080">:= </font>m <font color="#000080">+ </font><font color="#800000">1
                       </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ while }
                 </i></font><font color="#FF0000"><b>if </b></font>PIDSorted
                    <font color="#FF0000"><b>then </b></font>Value <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>ID
                    <font color="#FF0000"><b>else </b></font>Value <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>StartPos<font color="#000080">;
                 </font><font color="#FF0000"><b>if </b></font>Value <font color="#000080">&lt; </font>LookFor
                    <font color="#FF0000"><b>then </b></font>Pos <font color="#000080">:= </font>Pos <font color="#000080">+ </font><font color="#800000">1
                    </font><font color="#FF0000"><b>else if </b></font>Value <font color="#000080">= </font>LookFor
                            <font color="#FF0000"><b>then </b></font>IndexFound <font color="#000080">:= </font>True
              <font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ with }

      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ IndexFound }

   { ----- HoleFound ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>function </b></font>TBase<font color="#000080">.</font>HoleFound <font color="#000080">(</font>S<font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Pos<font color="#000080">: </font>Longint<font color="#000080">): </font>Boolean<font color="#000080">;

   </font><font color="#008000"><i>{ Looks for a hole in a storage stream.
     Linear search, FIRST-FIT }

      </i></font><font color="#FF0000"><b>var
         </b></font>Found <font color="#000080">: </font>Boolean<font color="#000080">;
         </font>i     <font color="#000080">: </font>Integer<font color="#000080">;

      </font><font color="#FF0000"><b>begin

         with </b></font>HolesIndex<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>Found <font color="#000080">:= </font>False<font color="#000080">; </font>i <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                 </font><font color="#FF0000"><b>while not </b></font><font color="#000080">(</font>Found <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>i <font color="#000080">&gt; </font>Count<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)) </font><font color="#FF0000"><b>do
                       begin
                          with </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^) </font><font color="#FF0000"><b>do
                               if </b></font>Size <font color="#000080">&gt;= </font>S
                                  <font color="#FF0000"><b>then begin
                                          </b></font>Found <font color="#000080">:= </font>True<font color="#000080">;
                                          </font>Pos <font color="#000080">:= </font>StartPos<font color="#000080">;
                                          </font>Size <font color="#000080">:= </font>Size <font color="#000080">- </font>S<font color="#000080">;
                                          </font><font color="#FF0000"><b>if </b></font>Size <font color="#000080">= </font><font color="#800000">0
                                             </font><font color="#FF0000"><b>then </b></font>AtDelete<font color="#000080">(</font>i<font color="#000080">)
                                       </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
                          </i></font>i <font color="#000080">:= </font>i <font color="#000080">+ </font><font color="#800000">1
                       </font><font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ while }
              </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ with }
         </i></font>HoleFound <font color="#000080">:= </font>Found

      <font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ HoleFound }

   { ----- Abort ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TBase<font color="#000080">.</font>Abort<font color="#000080">;

   </font><font color="#008000"><i>{ Cancels transaction. Restores old DBIndex and HolesIndex }

      </i></font><font color="#FF0000"><b>var
         </b></font>HoleStart<font color="#000080">,               </font><font color="#008000"><i>{ Start of probable hole }
         </i></font>Diff<font color="#000080">,                    </font><font color="#008000"><i>{ Length of probable hole }
         </i></font>IndLoc      <font color="#000080">: </font>Longint<font color="#000080">;   </font><font color="#008000"><i>{ Old DBIndex location in stream }
         </i></font>i           <font color="#000080">: </font>Integer<font color="#000080">;
         </font>NewRec      <font color="#000080">: </font>PIndRec<font color="#000080">;   </font><font color="#008000"><i>{ Hole registration card }

      </i></font><font color="#FF0000"><b>begin

         </b></font>Dispose <font color="#000080">(</font>DBIndex<font color="#000080">, </font>Done<font color="#000080">);    </font><font color="#008000"><i>{ Destroying old indexes }
         </i></font>Dispose <font color="#000080">(</font>HolesIndex<font color="#000080">, </font>Done<font color="#000080">);
         </font><font color="#FF0000"><b>with </b></font>BaseStream<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>Seek <font color="#000080">(</font>IndexPointerLocation<font color="#000080">); </font>Read <font color="#000080">(</font>IndLoc<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
                 </font>Seek <font color="#000080">(</font>IndLoc<font color="#000080">); </font>DBIndex <font color="#000080">:= </font>PIndexCollection <font color="#000080">(</font>Get<font color="#000080">)
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>New <font color="#000080">(</font>HolesIndex<font color="#000080">, </font>Init<font color="#000080">(</font>PIDLimit<font color="#000080">,</font>Delta<font color="#000080">));
         </font><font color="#FF0000"><b>with </b></font>DBIndex<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>HoleStart <font color="#000080">:= </font>StorageStart<font color="#000080">;
                 </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                     begin
                        </b></font>Diff <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>StartPos <font color="#000080">- </font>HoleStart<font color="#000080">;
                        </font><font color="#FF0000"><b>if </b></font>Diff <font color="#000080">&gt; </font><font color="#800000">0
                           </font><font color="#FF0000"><b>then begin
                                   </b></font>New <font color="#000080">(</font>NewRec<font color="#000080">);
                                   </font><font color="#FF0000"><b>with </b></font>NewRec<font color="#000080">^ </font><font color="#FF0000"><b>do
                                        begin
                                           </b></font>StartPos <font color="#000080">:= </font>HoleStart<font color="#000080">;
                                           </font>Size <font color="#000080">:= </font>Diff
                                        <font color="#FF0000"><b>end</b></font><font color="#000080">;
                                   </font>HolesIndex<font color="#000080">^.</font>Insert<font color="#000080">(</font>NewRec<font color="#000080">)
                                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ if }
                        </i></font>HoleStart <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>StartPos <font color="#000080">+
                                        </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Size
                     <font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ for }
                 </i></font>BaseStream<font color="#000080">^.</font>Seek <font color="#000080">(</font>HoleStart<font color="#000080">); </font>BaseStream<font color="#000080">^.</font>Truncate
              <font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ with }
         </i></font>IndexSort <font color="#000080">(</font>DBIndex<font color="#000080">, </font>False<font color="#000080">);
         </font>IndexSort <font color="#000080">(</font>HolesIndex<font color="#000080">, </font>True<font color="#000080">);
         </font>PIDCurrent <font color="#000080">:= </font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)^).</font>ID <font color="#000080">+ </font><font color="#800000">1

      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Abort }

   { ----- Commit ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TBase<font color="#000080">.</font>Commit<font color="#000080">;

   </font><font color="#008000"><i>{ Acknowledges transaction by putting DBIndex into the stream }

      </i></font><font color="#FF0000"><b>var
         </b></font>S<font color="#000080">,                      </font><font color="#008000"><i>{ Size of DBIndex }
         </i></font>IndLoc     <font color="#000080">: </font>Longint<font color="#000080">;   </font><font color="#008000"><i>{ Index location in stream }
         </i></font>i<font color="#000080">, </font>BasePos <font color="#000080">: </font>Integer<font color="#000080">;   </font><font color="#008000"><i>{ Auxiliary variables }

      </i></font><font color="#FF0000"><b>begin

         with </b></font>DBIndex<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin

                 for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                     begin
                        </b></font>BasePos <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base<font color="#000080">;
                        </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>BasePos <font color="#000080">&lt;&gt; -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>BasePos <font color="#000080">&lt;&gt; </font>i<font color="#000080">)
                           </font><font color="#FF0000"><b>then begin
                                   </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Size <font color="#000080">:=
                                         </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>Size<font color="#000080">;
                                   </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>StartPos <font color="#000080">:=
                                         </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>StartPos<font color="#000080">;
                                   </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base <font color="#000080">:= </font>i<font color="#000080">;
                                   </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>Base <font color="#000080">:= -</font><font color="#800000">1
                                </font><font color="#FF0000"><b>end
                     end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ for }

                 </i></font>i <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                 </font><font color="#FF0000"><b>while </b></font><font color="#000080">( </font>i <font color="#000080">&lt; </font>Count <font color="#000080">) </font><font color="#FF0000"><b>do
                       if </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base <font color="#000080">= -</font><font color="#800000">1
                          </font><font color="#FF0000"><b>then </b></font>AtDelete <font color="#000080">(</font>i<font color="#000080">)
                          </font><font color="#FF0000"><b>else </b></font>i <font color="#000080">:= </font>i <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;

                 </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                     </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base <font color="#000080">:= </font>i

              <font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{ with }

         </i></font>S <font color="#000080">:= </font>BytesInStream <font color="#000080">(</font>DBIndex<font color="#000080">);
         </font><font color="#FF0000"><b>if not </b></font>HoleFound <font color="#000080">(</font>S<font color="#000080">, </font>IndLoc<font color="#000080">)
            </font><font color="#FF0000"><b>then </b></font>IndLoc <font color="#000080">:= </font>BaseStream<font color="#000080">^.</font>GetSize<font color="#000080">;
         </font><font color="#FF0000"><b>with </b></font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^) </font><font color="#FF0000"><b>do
              begin
                 </b></font>ID <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                 </font>StartPos <font color="#000080">:= </font>IndLoc<font color="#000080">;
                 </font>Size <font color="#000080">:= </font>S<font color="#000080">;
                 </font>Base <font color="#000080">:= </font><font color="#800000">0
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>IndexSort <font color="#000080">(</font>DBIndex<font color="#000080">, </font>True<font color="#000080">);
         </font><font color="#FF0000"><b>with </b></font>BaseStream<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>Seek <font color="#000080">(</font>IndLoc<font color="#000080">); </font>Put <font color="#000080">(</font>DBIndex<font color="#000080">);
                 </font>Seek <font color="#000080">(</font>IndexPointerLocation<font color="#000080">); </font>Write <font color="#000080">(</font>IndLoc<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">)
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>if not </b></font>DoneFlag
            <font color="#FF0000"><b>then </b></font>Abort

      <font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Commit }

   { ----- Init ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>constructor </b></font>TBase<font color="#000080">.</font>Init <font color="#000080">(</font>AStream<font color="#000080">: </font>PDBStream<font color="#000080">);

   </font><font color="#008000"><i>{ Opens an existing database stream or creates a new one }

      </i></font><font color="#FF0000"><b>var
         </b></font>Descr     <font color="#000080">: </font>Longint<font color="#000080">;    </font><font color="#008000"><i>{ Stream descriptor }
         </i></font>IndexCard <font color="#000080">: </font>PIndRec<font color="#000080">;    </font><font color="#008000"><i>{ DBIndex registration card }

      </i></font><font color="#FF0000"><b>begin

         </b></font>TObject<font color="#000080">.</font>Init<font color="#000080">;
         </font>BaseStream <font color="#000080">:= </font>AStream<font color="#000080">;
         </font>New <font color="#000080">(</font>NS<font color="#000080">, </font>Init<font color="#000080">);
         </font>New <font color="#000080">(</font>DBIndex<font color="#000080">, </font>Init<font color="#000080">(</font>PIDLimit<font color="#000080">,</font>Delta<font color="#000080">));
         </font>New <font color="#000080">(</font>HolesIndex<font color="#000080">, </font>Init<font color="#000080">(</font>PIDLimit<font color="#000080">,</font>Delta<font color="#000080">));
         </font>DoneFlag <font color="#000080">:= </font>False<font color="#000080">;
         </font><font color="#FF0000"><b>with </b></font>BaseStream<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>Descr <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                 </font>Seek <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
                 </font><font color="#FF0000"><b>if </b></font>GetSize <font color="#000080">&gt; </font><font color="#800000">3 </font><font color="#FF0000"><b>then
                    </b></font>Read <font color="#000080">(</font>Descr<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
                 </font><font color="#FF0000"><b>if </b></font>Descr <font color="#000080">= </font>Hallmark
                    <font color="#FF0000"><b>then </b></font>Abort
                    <font color="#FF0000"><b>else begin
                            </b></font>Descr <font color="#000080">:= </font>Hallmark<font color="#000080">;
                            </font>Seek <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">); </font>Truncate<font color="#000080">; </font>Write <font color="#000080">(</font>Descr<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
                            </font>Seek <font color="#000080">(</font>IndexPointerLocation<font color="#000080">); </font>Write <font color="#000080">(</font>Descr<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
                            </font>New <font color="#000080">(</font>IndexCard<font color="#000080">);
                            </font><font color="#FF0000"><b>With </b></font>IndexCard<font color="#000080">^ </font><font color="#FF0000"><b>do
                                 begin
                                    </b></font>ID <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                                    </font>StartPos <font color="#000080">:= </font>StorageStart<font color="#000080">;
                                    </font>Size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                                    </font>Base <font color="#000080">:= </font><font color="#800000">0
                                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                            </font>DBIndex<font color="#000080">^.</font>AtInsert <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>IndexCard<font color="#000080">);
                            </font>Commit
                         <font color="#FF0000"><b>end
              end  </b></font><font color="#008000"><i>{ with }

      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{  Init  }

   { ----- Done ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>destructor </b></font>TBase<font color="#000080">.</font>Done<font color="#000080">;

   </font><font color="#008000"><i>{ Done is done ! }

      </i></font><font color="#FF0000"><b>begin
         </b></font>DoneFlag <font color="#000080">:= </font>True<font color="#000080">;
         </font>Commit<font color="#000080">;
         </font>Dispose <font color="#000080">(</font>NS<font color="#000080">, </font>Done<font color="#000080">);
         </font>Dispose <font color="#000080">(</font>DBIndex<font color="#000080">, </font>Done<font color="#000080">);
         </font>Dispose <font color="#000080">(</font>HolesIndex<font color="#000080">, </font>Done<font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Done }

   { ----- Create ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>function </b></font>TBase<font color="#000080">.</font>Create <font color="#000080">: </font>Word<font color="#000080">;

   </font><font color="#008000"><i>{ Generates unique identifier }

      </i></font><font color="#FF0000"><b>begin
         if </b></font>PIDCurrent <font color="#000080">&lt; </font>PIDLimit
            <font color="#FF0000"><b>then begin
                    </b></font>Create <font color="#000080">:= </font>PIDCurrent<font color="#000080">;
                    </font>PIDCurrent <font color="#000080">:= </font>PIDCurrent <font color="#000080">+ </font><font color="#800000">1
                 </font><font color="#FF0000"><b>end
            else </b></font>Create <font color="#000080">:= </font><font color="#800000">0
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Create }

   { ----- Destroy ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TBase<font color="#000080">.</font>Destroy <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">);

   </font><font color="#008000"><i>{ Marks object registration card in DBIndex as destroyed (Base = -1).
     If object's base has existed in a stream, it becomes a hole.
     Object doesn't vanish from a stream until transaction is over
     (Commit or Done). }

      </i></font><font color="#FF0000"><b>var
         </b></font>Pos<font color="#000080">,                     </font><font color="#008000"><i>{ Number of object's card in DBIndex }
         </i></font>HolePos<font color="#000080">,                 </font><font color="#008000"><i>{ Number of a potential hole }
         </i></font>BasePos     <font color="#000080">: </font>Integer<font color="#000080">;
         </font>BaseStart<font color="#000080">,
         </font>BaseSize    <font color="#000080">: </font>Longint<font color="#000080">;   </font><font color="#008000"><i>{ Charasteristics of object's base }
         </i></font>NewRec      <font color="#000080">: </font>PIndRec<font color="#000080">;   </font><font color="#008000"><i>{ New hole }
         </i></font>i           <font color="#000080">: </font>Integer<font color="#000080">;

      </font><font color="#FF0000"><b>begin

         with </b></font>DBIndex<font color="#000080">^ </font><font color="#FF0000"><b>do
           begin
             if not </b></font>IndexFound <font color="#000080">(</font>DBIndex<font color="#000080">, </font>PID<font color="#000080">, </font>Pos<font color="#000080">, </font>True<font color="#000080">)
                </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
             </font>BasePos <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>Base<font color="#000080">;
             </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>Base <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
             </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>BasePos <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>BasePos <font color="#000080">= </font>Pos<font color="#000080">)
                </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
             </font><font color="#FF0000"><b>if </b></font>IndexFound <font color="#000080">(</font>HolesIndex<font color="#000080">, </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>StartPos<font color="#000080">,
                            </font>HolePos<font color="#000080">, </font>False<font color="#000080">)
                </font><font color="#FF0000"><b>then </b></font>Halt <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
             </font>BaseStart <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>StartPos<font color="#000080">;
             </font>BaseSize  <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>Size<font color="#000080">;
             </font><font color="#FF0000"><b>if </b></font>HolePos <font color="#000080">&lt; </font>HolesIndex<font color="#000080">^.</font>Count
                <font color="#FF0000"><b>then if </b></font>BaseStart <font color="#000080">+ </font>BasePos <font color="#000080">=
                        </font>IndRec<font color="#000080">(</font>HolesIndex<font color="#000080">^.</font>At<font color="#000080">(</font>HolePos<font color="#000080">)^).</font>StartPos
                        <font color="#FF0000"><b>then begin
                               </b></font>IndRec<font color="#000080">(</font>HolesIndex<font color="#000080">^.</font>At<font color="#000080">(</font>HolePos<font color="#000080">)^).</font>StartPos <font color="#000080">:=
                                      </font>BaseStart<font color="#000080">;
                               </font>IndRec<font color="#000080">(</font>HolesIndex<font color="#000080">^.</font>At<font color="#000080">(</font>HolePos<font color="#000080">)^).</font>Size <font color="#000080">:=
                                      </font>IndRec<font color="#000080">(</font>HolesIndex<font color="#000080">^.</font>At<font color="#000080">(</font>HolePos<font color="#000080">)^).</font>Size <font color="#000080">+
                                      </font>BaseSize<font color="#000080">;
                               </font>Exit
                             <font color="#FF0000"><b>end</b></font><font color="#000080">;
             </font><font color="#FF0000"><b>if </b></font>BaseStart <font color="#000080">+ </font>BaseSize <font color="#000080">&lt; </font>BaseStream<font color="#000080">^.</font>GetSize
                <font color="#FF0000"><b>then begin
                        </b></font>New <font color="#000080">(</font>NewRec<font color="#000080">);
                        </font>NewRec<font color="#000080">^.</font>StartPos <font color="#000080">:= </font>BaseStart<font color="#000080">;
                        </font>NewRec<font color="#000080">^.</font>Size <font color="#000080">:= </font>BaseSize<font color="#000080">;
                        </font>HolesIndex<font color="#000080">^.</font>AtInsert <font color="#000080">(</font>HolePos<font color="#000080">, </font>NewRec<font color="#000080">)
                     </font><font color="#FF0000"><b>end
                else begin
                        </b></font>BaseStream<font color="#000080">^.</font>Seek <font color="#000080">(</font>BaseStart<font color="#000080">);
                        </font>BaseStream<font color="#000080">^.</font>Truncate
                     <font color="#FF0000"><b>end</b></font><font color="#000080">;
             </font>AtDelete <font color="#000080">(</font>BasePos<font color="#000080">);
             </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font>BasePos <font color="#FF0000"><b>to </b></font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
                 if </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base <font color="#000080">&lt;&gt; -</font><font color="#800000">1
                    </font><font color="#FF0000"><b>then </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>i<font color="#000080">)^).</font>Base<font color="#000080">-</font><font color="#800000">1
           </font><font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ with }

      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Destroy }

   { ----- Put ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TBase<font color="#000080">.</font>Put <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">; </font>P<font color="#000080">: </font>PObject<font color="#000080">);

   </font><font color="#008000"><i>{ Puts an object into the database }

      </i></font><font color="#FF0000"><b>var
         </b></font>StreamPos<font color="#000080">, </font>S <font color="#000080">: </font>Longint<font color="#000080">;   </font><font color="#008000"><i>{ Location and size of an object }
         </i></font>Pos<font color="#000080">,                      </font><font color="#008000"><i>{ Number of object registration card }
         </i></font>BasePos      <font color="#000080">: </font>Integer<font color="#000080">;   </font><font color="#008000"><i>{ Number of object's base card }
         </i></font>NewRec       <font color="#000080">: </font>PIndRec<font color="#000080">;   </font><font color="#008000"><i>{ Object registration card }

      </i></font><font color="#FF0000"><b>begin

         if </b></font>PID <font color="#000080">&gt;= </font>PIDLimit
            <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
         </font><font color="#FF0000"><b>with </b></font>DBIndex<font color="#000080">^ </font><font color="#FF0000"><b>do
              if </b></font>IndexFound <font color="#000080">(</font>DBIndex<font color="#000080">, </font>PID<font color="#000080">, </font>Pos<font color="#000080">, </font>True<font color="#000080">)
                 </font><font color="#FF0000"><b>then begin
                         </b></font>BasePos <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>Base<font color="#000080">;
                         </font><font color="#FF0000"><b>if </b></font>BasePos <font color="#000080">&lt;&gt; </font>Pos
                            <font color="#FF0000"><b>then begin
                                    if </b></font>BasePos <font color="#000080">&lt;&gt; -</font><font color="#800000">1
                                       </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
                                    </font>PID <font color="#000080">:= </font>Create<font color="#000080">;
                                    </font><font color="#FF0000"><b>if </b></font>IndexFound <font color="#000080">(</font>DBIndex<font color="#000080">, </font>PID<font color="#000080">,
                                                   </font>BasePos<font color="#000080">, </font>True <font color="#000080">)
                                       </font><font color="#FF0000"><b>then </b></font>Halt <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
                                    </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>Base <font color="#000080">:= </font>BasePos<font color="#000080">;
                                    </font>Pos <font color="#000080">:= </font>BasePos
                                 <font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ if }
                      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ if }
         </i></font>S <font color="#000080">:= </font>BytesInStream <font color="#000080">(</font>P<font color="#000080">);
         </font><font color="#FF0000"><b>if not </b></font>HoleFound <font color="#000080">(</font>S<font color="#000080">, </font>StreamPos<font color="#000080">)
            </font><font color="#FF0000"><b>then </b></font>StreamPos <font color="#000080">:= </font>BaseStream<font color="#000080">^.</font>GetSize<font color="#000080">;
         </font>New <font color="#000080">(</font>NewRec<font color="#000080">);
         </font><font color="#FF0000"><b>with </b></font>NewRec<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>ID <font color="#000080">:= </font>PID<font color="#000080">;
                 </font>StartPos <font color="#000080">:= </font>StreamPos<font color="#000080">;
                 </font>Size <font color="#000080">:= </font>S<font color="#000080">;
                 </font>Base <font color="#000080">:= </font>Pos
              <font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>DBIndex<font color="#000080">^.</font>AtInsert <font color="#000080">(</font>Pos<font color="#000080">, </font>NewRec<font color="#000080">);
         </font><font color="#FF0000"><b>with </b></font>BaseStream<font color="#000080">^ </font><font color="#FF0000"><b>do
              begin
                 </b></font>Seek <font color="#000080">(</font>StreamPos<font color="#000080">); </font>Put <font color="#000080">(</font>P<font color="#000080">)
              </font><font color="#FF0000"><b>end

      end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Put }

   { ----- Get ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>function </b></font>TBase<font color="#000080">.</font>Get <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">): </font>PObject<font color="#000080">;

   </font><font color="#008000"><i>{ Gets an object from the database }

      </i></font><font color="#FF0000"><b>var
         </b></font>Pos<font color="#000080">,                </font><font color="#008000"><i>{ Number of object registration card }
         </i></font>BasePos <font color="#000080">: </font>Integer<font color="#000080">;  </font><font color="#008000"><i>{ Number of object's base card }

      </i></font><font color="#FF0000"><b>begin
         </b></font>Get <font color="#000080">:= </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>if </b></font>IndexFound <font color="#000080">(</font>DBIndex<font color="#000080">, </font>PID<font color="#000080">, </font>Pos<font color="#000080">, </font>True<font color="#000080">)
            </font><font color="#FF0000"><b>then begin
                    </b></font>BasePos <font color="#000080">:= </font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>Base<font color="#000080">;
                    </font><font color="#FF0000"><b>if </b></font>BasePos <font color="#000080">&lt;&gt; -</font><font color="#800000">1
                       </font><font color="#FF0000"><b>then begin
                               </b></font>BaseStream<font color="#000080">^.</font>Seek
                                   <font color="#000080">(</font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>StartPos<font color="#000080">);
                               </font>Get <font color="#000080">:= </font>BaseStream<font color="#000080">^.</font>Get
                            <font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ if }
                 </i></font><font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ if }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Get }

   { ----- ObjSize ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>function </b></font>TBase<font color="#000080">.</font>ObjSize <font color="#000080">(</font>PID<font color="#000080">: </font>Word<font color="#000080">): </font>Longint<font color="#000080">;

   </font><font color="#008000"><i>{ Returns the size of an object }

      </i></font><font color="#FF0000"><b>var
         </b></font>Pos<font color="#000080">,                </font><font color="#008000"><i>{ Number of object registration card }
         </i></font>BasePos <font color="#000080">: </font>Integer<font color="#000080">;  </font><font color="#008000"><i>{ Number of object's base card }

      </i></font><font color="#FF0000"><b>begin
         </b></font>ObjSize <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
         </font><font color="#FF0000"><b>if </b></font>IndexFound <font color="#000080">(</font>DBIndex<font color="#000080">, </font>PID<font color="#000080">, </font>Pos<font color="#000080">, </font>True<font color="#000080">)
            </font><font color="#FF0000"><b>then begin
                    </b></font>BasePos <font color="#000080">:= </font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>Base<font color="#000080">;
                    </font><font color="#FF0000"><b>if </b></font>BasePos <font color="#000080">&lt;&gt; -</font><font color="#800000">1
                       </font><font color="#FF0000"><b>then </b></font>ObjSize <font color="#000080">:= </font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>BasePos<font color="#000080">)^).</font>Size
                 <font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{ if }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ ObjSize }

   { ----- Count ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>function </b></font>TBase<font color="#000080">.</font>Count<font color="#000080">: </font>Integer<font color="#000080">;

   </font><font color="#008000"><i>{ Returns the number of objects in the database }

      </i></font><font color="#FF0000"><b>begin
         </b></font>Count <font color="#000080">:= </font>DBIndex<font color="#000080">^.</font>Count
      <font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Count }

   { ----- IdlePack ---------------------------------------------- }

   </i></font><font color="#FF0000"><b>procedure </b></font>TBase<font color="#000080">.</font>IdlePack<font color="#000080">;

   </font><font color="#008000"><i>{ Makes a single step of database packing.
     Method (just now) - simple sequential relocation.
     Before object is relocated, old index is gotten
     from the stream and then put back with proper amendments. }

      </i></font><font color="#FF0000"><b>var
          </b></font>P         <font color="#000080">: </font>PObject<font color="#000080">;           </font><font color="#008000"><i>{ Relocated object }
          </i></font>OldLoc<font color="#000080">,                        </font><font color="#008000"><i>{ Old location of relocated object }
          </i></font>NewLoc<font color="#000080">,                        </font><font color="#008000"><i>{ New location of relocated object }
          </i></font>IndLoc    <font color="#000080">: </font>Longint<font color="#000080">;           </font><font color="#008000"><i>{ Location of old DBIndex }
          </i></font>OldIndex  <font color="#000080">: </font>PIndexCollection<font color="#000080">;  </font><font color="#008000"><i>{ Old DBIndex }
          </i></font>Pos       <font color="#000080">: </font>Integer<font color="#000080">;           </font><font color="#008000"><i>{ Posititon of relocated object
                                           in the index }

      </i></font><font color="#FF0000"><b>begin

         with </b></font>HolesIndex<font color="#000080">^ </font><font color="#FF0000"><b>do
           with </b></font>BaseStream<font color="#000080">^ </font><font color="#FF0000"><b>do
             begin

               if </b></font>Count <font color="#000080">= </font><font color="#800000">0
                  </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
               </font>OldLoc <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>StartPos <font color="#000080">+ </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>Size<font color="#000080">;
               </font>NewLoc <font color="#000080">:= </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>StartPos<font color="#000080">;
               </font>Seek <font color="#000080">(</font>OldLoc<font color="#000080">); </font>P <font color="#000080">:= </font>Get<font color="#000080">;
               </font><font color="#FF0000"><b>if </b></font>P <font color="#000080">= </font><font color="#FF0000"><b>Nil
                  then begin
                          </b></font>Reset<font color="#000080">;
                          </font>Seek <font color="#000080">(</font>NewLoc<font color="#000080">); </font>Truncate<font color="#000080">;
                          </font>AtDelete <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
                          </font>Exit
                       <font color="#FF0000"><b>end</b></font><font color="#000080">;
               </font>Seek <font color="#000080">(</font>IndexPointerLocation<font color="#000080">); </font>Read <font color="#000080">(</font>IndLoc<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
               </font>Seek <font color="#000080">(</font>IndLoc<font color="#000080">); </font>OldIndex <font color="#000080">:= </font>PIndexCollection <font color="#000080">(</font>Get<font color="#000080">);

               </font><font color="#FF0000"><b>if </b></font>IndexFound <font color="#000080">(</font>OldIndex<font color="#000080">, </font>OldLoc<font color="#000080">, </font>Pos<font color="#000080">, </font>False<font color="#000080">)
                  </font><font color="#FF0000"><b>then begin
                          </b></font>IndRec<font color="#000080">(</font>OldIndex<font color="#000080">^.</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>StartPos <font color="#000080">:= </font>NewLoc<font color="#000080">;
                          </font><font color="#FF0000"><b>if not </b></font>IndexFound <font color="#000080">(</font>DBIndex<font color="#000080">,
                                             </font>IndRec<font color="#000080">(</font>OldIndex<font color="#000080">^.</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>ID<font color="#000080">,
                                             </font>Pos<font color="#000080">, </font>True<font color="#000080">)
                             </font><font color="#FF0000"><b>then </b></font>Halt <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
                       </font><font color="#FF0000"><b>end
                  else begin
                          </b></font>Pos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
                          </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>StartPos <font color="#000080">&lt;&gt;
                                 </font>OldLoc<font color="#000080">) </font><font color="#FF0000"><b>do
                                </b></font>Pos <font color="#000080">:= </font>Pos <font color="#000080">+ </font><font color="#800000">1
                        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
               </font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>StartPos <font color="#000080">:= </font>NewLoc<font color="#000080">;

               </font><font color="#FF0000"><b>if </b></font>OldLoc <font color="#000080">= </font>IndLoc
                  <font color="#FF0000"><b>then </b></font>IndLoc <font color="#000080">:= </font>NewLoc<font color="#000080">;
               </font>Seek <font color="#000080">(</font>NewLoc<font color="#000080">); </font>Put <font color="#000080">(</font>P<font color="#000080">);
               </font>Seek <font color="#000080">(</font>IndexPointerLocation<font color="#000080">); </font>Write <font color="#000080">(</font>IndLoc<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
               </font>Seek <font color="#000080">(</font>IndLoc<font color="#000080">); </font>Put <font color="#000080">(</font>OldIndex<font color="#000080">);
               </font>Dispose <font color="#000080">(</font>P<font color="#000080">,</font>Done<font color="#000080">); </font>Dispose <font color="#000080">(</font>OldIndex<font color="#000080">, </font>Done<font color="#000080">);

               </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>StartPos <font color="#000080">:=
                      </font>NewLoc <font color="#000080">+ </font>IndRec<font color="#000080">(</font>DBIndex<font color="#000080">^.</font>At<font color="#000080">(</font>Pos<font color="#000080">)^).</font>Size<font color="#000080">;
               </font><font color="#FF0000"><b>if </b></font>Count <font color="#000080">&gt; </font><font color="#800000">1
                  </font><font color="#FF0000"><b>then if </b></font><font color="#000080">( </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>StartPos <font color="#000080">+ </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>Size <font color="#000080">=
                            </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)^).</font>StartPos <font color="#000080">)
                          </font><font color="#FF0000"><b>then begin
                                 </b></font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>Size <font color="#000080">:=
                                 </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)^).</font>Size <font color="#000080">+ </font>IndRec<font color="#000080">(</font>At<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)^).</font>Size<font color="#000080">;
                                 </font>AtDelete <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
                               </font><font color="#FF0000"><b>end

             end  </b></font><font color="#008000"><i>{ With }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ IdlePack }

    { -- End of TBase implementation -- }

   </i></font><font color="#FF0000"><b>const
      </b></font>RIndexCollection<font color="#000080">: </font>TStreamRec <font color="#000080">=
         ( </font>ObjType <font color="#000080">: </font><font color="#800000">10000</font><font color="#000080">;
           </font>VMTLink <font color="#000080">: </font>Ofs<font color="#000080">(</font>TypeOf<font color="#000080">(</font>TIndexCollection<font color="#000080">)^);
           </font>Load    <font color="#000080">: @</font>TIndexCollection<font color="#000080">.</font>Load<font color="#000080">;
           </font>Store   <font color="#000080">: @</font>TIndexCollection<font color="#000080">.</font>Store <font color="#000080">);

</font><font color="#FF0000"><b>begin

  </b></font><font color="#008000"><i>{ Unit body }

  </i></font>RegisterType <font color="#000080">(</font>RIndexCollection<font color="#000080">)

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0092.PAS">Original</a><b>]</b></p></body>
</html>
