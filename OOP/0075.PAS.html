<html>
<head><title> "Sorting using tCollection" by MIKE SORTZ</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0075.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>TSortLst<font color="#000080">;

</font><font color="#008000"><i>(*
    Version 1.0 5/12/95 - Mike Stortz

      Borland Pascal 7.0 has a very useful object called a TCollection that
    allows you to sort items by any key you wish and that disposes
    of any objects it owns when the collection itself is freed.
    Inexplicably, these very useful behaviors were omitted from Delphi's
    TStringList.  But now... &lt;trumpet fanfare&gt;

      This unit contains a class called &quot;TSortableList&quot; derived from
    TStringList that supports the ability for you to define descendent classes
    that sort the list any way you wish and has the option to &quot;own&quot; the objects
    that are added to it, so that they are disposed with the list.

    How to use a TSortableList that owns its objects:

    1. Create a new TSortableList and tell it that it should own any objects
       in it.

      var
        my_list : TSortableList;
      begin
      my_list := TSortableList.Create(True);     { &quot;True&quot; = Owns objects }
      my_list.Add('Aaa', TObject.Create);        { In a TStringList, this... }
      my_list.Add('Bbb', TObject.Create);        { ...would be... }
      my_list.Add('Ccc', TObject.Create);        { ...very bad! }
      my_list.Free;                              { All objects freed }
      end;

    How to sort on an arbitrary key:

    Suppose you wanted a list of strings sorted by all but the first character
    (i.e. this order -&gt; &quot;ZAble&quot;, &quot;YBaker&quot;, &quot;XCharlie&quot;).

    1. Declare a descendent of TSortableList and override the Compare method.
       The Compare method should return an integer such that the result is:
         -1 if the item at index i1 is &quot;less&quot; than the item at i2
          0 if the item at index i1 is &quot;equal&quot; than the item at i2
          1 if the item at index i1 is &quot;more&quot; than the item at i2

      TExList = class(TSortableList)
        function Compare(i1, i2 : Integer) : Integer; override;
        end;

    2. Define the new compare method

      function Compare(i1, i2 : Integer) : Integer;
        begin
        case Key of
          1 :
            Result := AnsiCompareText(Copy(Strings[i1], 2, 254),
                                      Copy(Strings[i2], 2, 254));
          else
            Result := inherited Compare(i1, i2);
          end;
        end;

    3. Specify the key you just defined.

      var
        my_list : TExList;
      begin
      my_list := TExList.Create;
      my_list.Key := 1;               { &lt;&lt;&lt;&lt;&lt; New key is made active }
      DoSomeStuff;
      my_list.Free;
      end;

      There you go!  I =strongly= suggest that any Key that you define Compare
    methods for have a value of at least 1 and that all unhandled Key
    values be passed to the inherited method, as above.  A Key of 0 is
    defined to be the default alphabetical sort.

      Note that you can define a Key based on the objects in a list, like so:

      function Compare(i1, i2 : Integer) : Integer;
        begin
        case Key of
          1 :
            Result := AnsiCompareText(TSomeObject(Objects[i1]).Text,
                                      TSomeObject(Objects[i2].Text);
          else
            Result := inherited Compare(i1, i2);
          end;
        end;

      Of course, it is your responsibility to be sure that the objects in
    the list are the type that your Compare method assumes them to be.

                  === Important ===

   If you do have a list that is
     a) sorted, and
     b) determines its order via values derived from the objects that are
        stored in the list,
   watch out for changing objects in such a way as to change their sort order;
   the TSortableList will not know that the list is now out of order and
   calls to routines that depend on knowing this (such as Add) may fail to
   work.  Your best bet in this case is to set Sorted to False, make whatever
   changes to the objects you wish, and then set Sorted back to True.  This
   will resort the list.

     I also took the liberty of &quot;protecting&quot; the Find method against the
   possibility that someone would call it when the list was not sorted --
   in that case, it now calls IndexOf (which, somewhat recursively, would
   call Find if the list =was= sorted).  This is exactly what happened in
   the example code for Find!  If you look at the method list for
   TStringList, you won't find Find -- but you can do a topic search for
   it.  The example code for Find works, but only by chance -- add another
   string to either end of the list, and &quot;Flowers&quot; won't be found.  What's
   wrong with the example code is that the list's Sorted property is not set
   to True; the reason it (accidently) works is because the item that
   was being found (&quot;Flowers&quot;) happened to be the middle item in the list,
   which is where the search algorithm looks first.

     If you have any comments, suggestions or even criticisms &lt;g&gt; for
   TSortableList, hey, tough!  No, really, send me some mail at 71744,422.
   I am particularly interested in bug reports.

*)

</i></font><font color="#FF0000"><b>interface

Uses
  </b></font>Classes<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TSortableList <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TStringList<font color="#000080">)
    </font><font color="#FF0000"><b>private
    </b></font>FOwnsObjects <font color="#000080">: </font>Boolean<font color="#000080">;
    </font>FKey <font color="#000080">: </font>Integer<font color="#000080">;
    </font>FAscending <font color="#000080">: </font>Boolean<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>QuickSort<font color="#000080">(</font>left<font color="#000080">, </font>right<font color="#000080">: </font>Integer<font color="#000080">);
    </font><font color="#FF0000"><b>function </b></font>CallCompare<font color="#000080">(</font>i1<font color="#000080">, </font>i2 <font color="#000080">: </font>Integer<font color="#000080">) : </font>Integer<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>SetAscending<font color="#000080">(</font>value <font color="#000080">: </font>Boolean<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>SetKey<font color="#000080">(</font>value <font color="#000080">: </font>Integer<font color="#000080">);
    </font><font color="#FF0000"><b>protected
    procedure </b></font>PutObject<font color="#000080">(</font>index <font color="#000080">: </font>Integer<font color="#000080">; </font>AObject <font color="#000080">: </font>TObject<font color="#000080">); </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>Compare<font color="#000080">(</font>i1<font color="#000080">, </font>i2 <font color="#000080">: </font>Integer<font color="#000080">) : </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>public
    constructor </b></font>Create<font color="#000080">(</font>owns_objects <font color="#000080">: </font>Boolean<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Clear<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Delete<font color="#000080">(</font>index <font color="#000080">: </font>Integer<font color="#000080">); </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>Find<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>index <font color="#000080">: </font>Integer<font color="#000080">): </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Sort<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Ascending <font color="#000080">: </font>Boolean <font color="#FF0000"><b>read </b></font>FAscending <font color="#FF0000"><b>write </b></font>SetAscending<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Key <font color="#000080">: </font>Integer <font color="#FF0000"><b>read </b></font>FKey <font color="#FF0000"><b>write </b></font>SetKey<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>OwnsObjects <font color="#000080">: </font>Boolean <font color="#FF0000"><b>read </b></font>FOwnsObjects<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

Uses
  </b></font>SysUtils<font color="#000080">;

</font><font color="#008000"><i>{ Private Methods }

</i></font><font color="#FF0000"><b>procedure </b></font>TSortableList<font color="#000080">.</font>QuickSort<font color="#000080">(</font>left<font color="#000080">, </font>right<font color="#000080">: </font>Integer<font color="#000080">);
  </font><font color="#FF0000"><b>var
    </b></font>i<font color="#000080">, </font>j<font color="#000080">, </font>pivot <font color="#000080">: </font>Integer<font color="#000080">;
    </font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>begin
  </b></font>i <font color="#000080">:= </font>left<font color="#000080">;
  </font>j <font color="#000080">:= </font>right<font color="#000080">;

  </font><font color="#008000"><i>{ Rather than store the pivot value (which was assumed to be a string),
    store the pivot index }
  </i></font>pivot <font color="#000080">:= (</font>left <font color="#000080">+ </font>right<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">;

  </font><font color="#FF0000"><b>repeat
    while </b></font>CallCompare<font color="#000080">(</font>i<font color="#000080">, </font>pivot<font color="#000080">) &lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
      </b></font>Inc<font color="#000080">(</font>i<font color="#000080">);
    </font><font color="#FF0000"><b>while </b></font>CallCompare<font color="#000080">(</font>j<font color="#000080">, </font>pivot<font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
      </b></font>Dec<font color="#000080">(</font>j<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>i <font color="#000080">&lt;= </font>j <font color="#FF0000"><b>then
      begin
      </b></font>Exchange<font color="#000080">(</font>i<font color="#000080">, </font>j<font color="#000080">);

      </font><font color="#008000"><i>{ If we just moved the pivot item, reset the pivot index }
      </i></font><font color="#FF0000"><b>if </b></font>pivot <font color="#000080">= </font>i <font color="#FF0000"><b>then
        </b></font>pivot <font color="#000080">:= </font>j
      <font color="#FF0000"><b>else if </b></font>pivot <font color="#000080">= </font>j <font color="#FF0000"><b>then
        </b></font>pivot <font color="#000080">:= </font>i<font color="#000080">;

      </font>Inc<font color="#000080">(</font>i<font color="#000080">);
      </font>Dec<font color="#000080">(</font>j<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>until </b></font>i <font color="#000080">&gt; </font>j<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>left <font color="#000080">&lt; </font>j <font color="#FF0000"><b>then
    </b></font>QuickSort<font color="#000080">(</font>left<font color="#000080">, </font>j<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>i <font color="#000080">&lt; </font>right <font color="#FF0000"><b>then
    </b></font>QuickSort<font color="#000080">(</font>i<font color="#000080">, </font>right<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TSortableList<font color="#000080">.</font>CallCompare<font color="#000080">(</font>i1<font color="#000080">, </font>i2 <font color="#000080">: </font>Integer<font color="#000080">) : </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:= </font>Compare<font color="#000080">(</font>i1<font color="#000080">, </font>i2<font color="#000080">);
  </font><font color="#FF0000"><b>if not </b></font>FAscending <font color="#FF0000"><b>then
    </b></font>Result <font color="#000080">:= -</font>Result<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TSortableList<font color="#000080">.</font>SetAscending<font color="#000080">(</font>value <font color="#000080">: </font>Boolean<font color="#000080">);
  </font><font color="#FF0000"><b>begin
  if </b></font>value <font color="#000080">&lt;&gt; </font>FAscending <font color="#FF0000"><b>then
    begin
    </b></font>FAscending <font color="#000080">:= </font>value<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Sorted <font color="#FF0000"><b>then
      begin
      </b></font>Sorted <font color="#000080">:= </font>False<font color="#000080">;
      </font>Sorted <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end
    end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TSortableList<font color="#000080">.</font>SetKey<font color="#000080">(</font>value <font color="#000080">: </font>Integer<font color="#000080">);
  </font><font color="#FF0000"><b>begin
  if </b></font>value <font color="#000080">&lt;&gt; </font>FKey <font color="#FF0000"><b>then
    begin
    </b></font>FKey <font color="#000080">:= </font>value<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Sorted <font color="#FF0000"><b>then
      begin
      </b></font>Sorted <font color="#000080">:= </font>False<font color="#000080">;
      </font>Sorted <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end
    end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Protected Methods }

</i></font><font color="#FF0000"><b>function </b></font>TSortableList<font color="#000080">.</font>Compare<font color="#000080">(</font>i1<font color="#000080">, </font>i2 <font color="#000080">: </font>Integer<font color="#000080">) : </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:= </font>AnsiCompareText<font color="#000080">(</font>Strings<font color="#000080">[</font>i1<font color="#000080">], </font>Strings<font color="#000080">[</font>i2<font color="#000080">]);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Public Methods }

</i></font><font color="#FF0000"><b>constructor </b></font>TSortableList<font color="#000080">.</font>Create<font color="#000080">(</font>owns_objects <font color="#000080">: </font>Boolean<font color="#000080">);
  </font><font color="#FF0000"><b>begin
  inherited </b></font>Create<font color="#000080">;
  </font>FOwnsObjects <font color="#000080">:= </font>owns_objects<font color="#000080">;
  </font>FKey <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>FAscending <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TSortableList<font color="#000080">.</font>Clear<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>index <font color="#000080">: </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  </b></font>Changing<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>FOwnsObjects <font color="#FF0000"><b>then
    for </b></font>index <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do
      </b></font>GetObject<font color="#000080">(</font>index<font color="#000080">).</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>Clear<font color="#000080">;
  </font>Changed<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TSortableList<font color="#000080">.</font>Delete<font color="#000080">(</font>index<font color="#000080">: </font>Integer<font color="#000080">);
  </font><font color="#FF0000"><b>begin
  </b></font>Changing<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>FOwnsObjects <font color="#FF0000"><b>then
    </b></font>GetObject<font color="#000080">(</font>index<font color="#000080">).</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>Delete<font color="#000080">(</font>index<font color="#000080">);
  </font>Changed<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TSortableList<font color="#000080">.</font>Find<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>index <font color="#000080">: </font>Integer<font color="#000080">): </font>Boolean<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  if not </b></font>Sorted <font color="#FF0000"><b>then
    begin
    </b></font>index <font color="#000080">:= </font>IndexOf<font color="#000080">(</font>s<font color="#000080">);
    </font>Result <font color="#000080">:= (</font>index <font color="#000080">&lt;&gt; -</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
  else
    </b></font>Result <font color="#000080">:= </font><font color="#FF0000"><b>inherited </b></font>Find<font color="#000080">(</font>s<font color="#000080">, </font>index<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TSortableList<font color="#000080">.</font>PutObject<font color="#000080">(</font>index<font color="#000080">: </font>Integer<font color="#000080">; </font>AObject<font color="#000080">: </font>TObject<font color="#000080">);
  </font><font color="#FF0000"><b>begin
  </b></font>Changing<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>FOwnsObjects <font color="#FF0000"><b>then
    </b></font>GetObject<font color="#000080">(</font>index<font color="#000080">).</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>PutObject<font color="#000080">(</font>index<font color="#000080">, </font>AObject<font color="#000080">);
  </font>Changed<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TSortableList<font color="#000080">.</font>Sort<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  if not </b></font>Sorted <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Count <font color="#000080">&gt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
    </b></font>Changing<font color="#000080">;
    </font>QuickSort<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>Count <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">);
    </font>Changed<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to OOP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0075.PAS">Original</a><b>]</b></p></body>
</html>
