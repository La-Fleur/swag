<html>
<head><title> "Modem Reference" by JACK MOFFITT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FAQ SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000000">From<font color="#000080">: </font>JACK MOFFITT                 Refer<font color="#800000">#</font><font color="#000080">: </font>NONE
  <font color="#FF0000"><b>To</b></font><font color="#000080">: </font>ALL                           Recvd<font color="#000080">: </font>NO
Subj<font color="#000080">: </font>MODEM REFERENCE       <font color="#800000">1</font><font color="#000080">/       </font>Conf<font color="#000080">: (</font><font color="#800000">1221</font><font color="#000080">) </font>F<font color="#000080">-</font><font color="#FF0000"><b>PASCAL
</b></font><font color="#000080">---------------------------------------------------------------------------
            </font><font color="#FF0000"><b>Pascal </b></font>Programmer<font color="#800000">'s Reference to Modem Communications

                                   </font>by

                               Jack Moffitt

___<font color="#000080">-------------------------------------------------------------------------


</font>INTRODUCTION
<font color="#000080">~~~~~~~~~~~~
        </font>Direct UART programming <font color="#FF0000"><b>is </b></font>a subject that <font color="#FF0000"><b>not </b></font>many people are
familiar <font color="#FF0000"><b>with</b></font><font color="#000080">.  </font>Since the advent <font color="#FF0000"><b>of </b></font>FOSSIL<font color="#000080">, </font>many people advise that one
should use that <font color="#FF0000"><b>for </b></font>all communications<font color="#000080">, </font><font color="#FF0000"><b>to </b></font>make it more portable<font color="#000080">.  </font>But <font color="#FF0000"><b>for
</b></font>some instances<font color="#000080">, </font>it <font color="#FF0000"><b>is </b></font>necessary <font color="#FF0000"><b>to </b></font>have internal modem routines <font color="#FF0000"><b>to </b></font>go <font color="#FF0000"><b>on</b></font><font color="#000080">.
</font>Because no one seems <font color="#FF0000"><b>to </b></font>know <font color="#FF0000"><b>or </b></font>understand this subject<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>because I have
found no other texts <font color="#FF0000"><b>on </b></font>the subject<font color="#000080">, </font>I have decided <font color="#FF0000"><b>to </b></font>put it all into one
text<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>maybe round off the edges <font color="#FF0000"><b>on </b></font>this subject<font color="#000080">.


</font>THE ASYNCRONOUS MODEM
<font color="#000080">~~~~~~~~~~~~~~~~~~~~~
        </font>The asyncronous modem <font color="#FF0000"><b>uses </b></font>one <font color="#000080">(</font><font color="#FF0000"><b>or </b></font>more<font color="#000080">) </font>specific ports <font color="#FF0000"><b>on </b></font>a
computer<font color="#000080">, </font><font color="#FF0000"><b>as </b></font>well <font color="#FF0000"><b>as </b></font>an IRQ <font color="#000080">(</font>Interrupt Request<font color="#000080">).  </font>Every time a character
<font color="#FF0000"><b>of </b></font>data <font color="#FF0000"><b>is </b></font>received <font color="#FF0000"><b>in </b></font>the device<font color="#000080">, </font>an interrupt <font color="#FF0000"><b>is </b></font>processed<font color="#000080">.  </font>One must
make a interrupt service routine <font color="#FF0000"><b>to </b></font>handle this input<font color="#000080">, </font>but where does it go<font color="#000080">?
</font>Since the IRQs are tied into interrupts<font color="#000080">, </font>knowing the IRQ the device <font color="#FF0000"><b>is </b></font>using<font color="#000080">,
</font>we can replace that interrupt<font color="#000080">.  </font>The port addresses <font color="#FF0000"><b>and </b></font>IRQ vectors are <font color="#FF0000"><b>as
</b></font>follows<font color="#000080">:

</font>Port Addresses<font color="#000080">: </font>COM1  <font color="#000080">--  </font><font color="#800000">03</font>F8h        IRQ Vectors   <font color="#000080">:  </font><font color="#800000">0  </font><font color="#000080">--  </font><font color="#800000">08</font>h
                COM2  <font color="#000080">--  </font><font color="#800000">02</font>F8h                         <font color="#800000">1  </font><font color="#000080">--  </font><font color="#800000">09</font>h
                COM3  <font color="#000080">--  </font><font color="#800000">03E8</font>h                         <font color="#800000">2  </font><font color="#000080">--  </font><font color="#800000">0</font>Ah
                COM4  <font color="#000080">--  </font><font color="#800000">02E8</font>h                         <font color="#800000">3  </font><font color="#000080">--  </font><font color="#800000">0</font>Bh
                                                        <font color="#800000">4  </font><font color="#000080">--  </font><font color="#800000">0</font>Ch
                                                        <font color="#800000">5  </font><font color="#000080">--  </font><font color="#800000">0</font>Dh
Standard Port IRQs<font color="#000080">: </font>COM1  <font color="#000080">--  </font><font color="#800000">4                         6  </font><font color="#000080">--  </font><font color="#800000">0E</font>h
                    COM2  <font color="#000080">--  </font><font color="#800000">3                         7  </font><font color="#000080">--  </font><font color="#800000">0</font>Fh
                    COM3  <font color="#000080">--  </font><font color="#800000">4                         8  </font><font color="#000080">--  </font><font color="#800000">70</font>h
                    COM4  <font color="#000080">--  </font><font color="#800000">3                         9  </font><font color="#000080">--  </font><font color="#800000">71</font>h
                                                       <font color="#800000">10  </font><font color="#000080">--  </font><font color="#800000">72</font>h
                                                       <font color="#800000">11  </font><font color="#000080">--  </font><font color="#800000">73</font>h
                                                       <font color="#800000">12  </font><font color="#000080">--  </font><font color="#800000">74</font>h
                                                       <font color="#800000">13  </font><font color="#000080">--  </font><font color="#800000">75</font>h
                                                       <font color="#800000">14  </font><font color="#000080">--  </font><font color="#800000">76</font>h
                                                       <font color="#800000">15  </font><font color="#000080">--  </font><font color="#800000">77</font>h

<font color="#FF0000"><b>For </b></font>standard use<font color="#000080">, </font>the IRQ <font color="#FF0000"><b>for </b></font>comm ports <font color="#800000">1 </font><font color="#FF0000"><b>and </b></font><font color="#800000">3 </font><font color="#FF0000"><b>is </b></font><font color="#800000">4</font><font color="#000080">, </font><font color="#FF0000"><b>and for </b></font><font color="#800000">2 </font><font color="#FF0000"><b>and </b></font><font color="#800000">4 </font>it<font color="#800000">'s
3.  </font>The <font color="#800000">8250 </font>UART has <font color="#800000">10 </font>registers available <font color="#FF0000"><b>for </b></font>getting<font color="#000080">, </font>receiving <font color="#FF0000"><b>and
</b></font>interperating data<font color="#000080">.  </font>They are all located at offsets from the base address
<font color="#FF0000"><b>of </b></font>the port<font color="#000080">.  </font>Here are the registers <font color="#FF0000"><b>and </b></font>their offsets<font color="#000080">:

</font><font color="#FF0000"><b>Register </b></font>Offsets<font color="#000080">:  </font>Transmitter Holding <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>THR<font color="#000080">)       --  </font><font color="#800000">00</font>h
                   Receiver Data <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>RDR<font color="#000080">)             --  </font><font color="#800000">00</font>h
                   Baud Rate Divisor Low Byte <font color="#000080">(</font>BRDL<font color="#000080">)        --  </font><font color="#800000">00</font>h
                   Baud Rate Divisor High Byte <font color="#000080">(</font>BRDH<font color="#000080">)       --  </font><font color="#800000">01</font>h
                   Interrupt Enable <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>IER<font color="#000080">)          --  </font><font color="#800000">01</font>h
                   Interrupt Identification <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>IIR<font color="#000080">)  --  </font><font color="#800000">02</font>h
                   Line Control <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>LCR<font color="#000080">)              --  </font><font color="#800000">03</font>h
                   Modem Control <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>MCR<font color="#000080">)             --  </font><font color="#800000">04</font>h
                   Line Status <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>LSR<font color="#000080">)               --  </font><font color="#800000">05</font>h
                   Modem Status <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>MSR<font color="#000080">)              --  </font><font color="#800000">06</font>h

<font color="#FF0000"><b>With </b></font>this information one can address any <font color="#FF0000"><b>register </b></font>by adding the offset <font color="#FF0000"><b>to
</b></font>the base address<font color="#000080">.  </font>Therefor<font color="#000080">, </font><font color="#FF0000"><b>if </b></font>one <font color="#FF0000"><b>is </b></font>using COM2 <font color="#000080">(</font>base address <font color="#800000">02</font>F8h<font color="#000080">) </font>they
would access the Modem Status <font color="#FF0000"><b>Register with</b></font><font color="#000080">: </font>port<font color="#000080">[</font><font color="#800000">$02F8 </font><font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">].


</font>TRANSMITTER HOLDING <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        </font>This <font color="#FF0000"><b>register contains </b></font>the data <font color="#FF0000"><b>to </b></font>be sent <font color="#FF0000"><b>to </b></font>the remote PC <font color="#FF0000"><b>or </b></font>modem<font color="#000080">.
</font>When bit <font color="#800000">5 </font><font color="#000080">(</font>THR empty<font color="#000080">) </font><font color="#FF0000"><b>of </b></font>the LSR <font color="#FF0000"><b>is set</b></font><font color="#000080">, </font>one can write <font color="#FF0000"><b>to </b></font>this port<font color="#000080">, </font>thus
sending data over the phone line <font color="#FF0000"><b>or </b></font>null modem cable<font color="#000080">.


</font>RECEIVER DATA <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~~~
        </font>This <font color="#FF0000"><b>register contains </b></font>the incoming data<font color="#000080">.  </font>Read this <font color="#FF0000"><b>register </b></font>only
<font color="#FF0000"><b>if </b></font>bit <font color="#800000">0 </font><font color="#000080">(</font>Data Received<font color="#000080">) </font><font color="#FF0000"><b>of </b></font>the LSR <font color="#FF0000"><b>is set</b></font><font color="#000080">, </font>otherwise one will get
unpredictable characters<font color="#000080">.


</font>BAUD RATE DIVISOR
<font color="#000080">~~~~~~~~~~~~~~~~~
        </font>The Baud Rate Divisor <font color="#FF0000"><b>is </b></font>used <font color="#FF0000"><b>to set </b></font>the BPS rate<font color="#000080">.  </font><font color="#FF0000"><b>To </b></font>calculate the
Baud Rate Divisor<font color="#000080">, </font>one must use the formula<font color="#000080">: (</font>UART Clock Speed<font color="#000080">)/(</font><font color="#800000">16</font><font color="#000080">*</font>BPS<font color="#000080">).
</font>The UART Clock Speed <font color="#FF0000"><b>is </b></font><font color="#800000">1843200.  </font><font color="#FF0000"><b>To set </b></font>the BRD one must first <font color="#FF0000"><b>set </b></font>bit <font color="#800000">7
</font><font color="#000080">(</font>port toggle<font color="#000080">) </font><font color="#FF0000"><b>of </b></font>the Line Control <font color="#FF0000"><b>Register to </b></font><font color="#800000">1</font><font color="#000080">, </font><font color="#FF0000"><b>and then </b></font>write the low <font color="#FF0000"><b>and
</b></font>high bytes <font color="#FF0000"><b>to </b></font>the correct offsets<font color="#000080">.  </font>Always remember <font color="#FF0000"><b>to </b></font>reset LCR bit <font color="#800000">7 </font><font color="#FF0000"><b>to </b></font><font color="#800000">0
</font>after one <font color="#FF0000"><b>is </b></font>finished setting the BPS rate<font color="#000080">.


</font>INTERRUPT ENABLE <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~~~~~~
        </font>The IER <font color="#FF0000"><b>is </b></font>used <font color="#FF0000"><b>to </b></font>simulate real interrupt calls<font color="#000080">.  </font>Write a byte
containing <font color="#FF0000"><b>to </b></font>interrupt information <font color="#FF0000"><b>to </b></font>enable any interrupts<font color="#000080">, </font>all interrupts
also have corresponding actions <font color="#FF0000"><b>to </b></font>clear the interrupts<font color="#000080">.  </font>Here<font color="#800000">'s the list:

</font>Info Byte<font color="#000080">:

</font>bit   <font color="#800000">7</font><font color="#000080">-</font><font color="#800000">6</font><font color="#000080">-</font><font color="#800000">5</font><font color="#000080">-</font><font color="#800000">4       3                 2                 1           0
      </font><font color="#000080">~~~~~~~       ~                 ~                 ~           ~
     </font>Always <font color="#800000">0   </font>MSR Change   Data Error <font color="#FF0000"><b>or </b></font>Break    THR empty  Data Received

<font color="#FF0000"><b>To </b></font>Clear<font color="#000080">:       </font>Read MSR          Read LSR        Output <font color="#FF0000"><b>to </b></font>THR   Read RDR


INTERRUPT IDENTIFICATION <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        </font>This <font color="#FF0000"><b>register is </b></font>used <font color="#FF0000"><b>to </b></font>determine what kind <font color="#FF0000"><b>of </b></font>interrupts have
occured<font color="#000080">.  </font>Read one byte from this <font color="#FF0000"><b>register</b></font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>use <font color="#FF0000"><b>AND </b></font>masks <font color="#FF0000"><b>to </b></font>find <font color="#FF0000"><b>out
</b></font>what has happened<font color="#000080">.  </font>The information <font color="#FF0000"><b>in </b></font>the byte <font color="#FF0000"><b>is</b></font><font color="#000080">:

</font>Info Byte<font color="#000080">:

</font>bit   <font color="#800000">7</font><font color="#000080">-</font><font color="#800000">6</font><font color="#000080">-</font><font color="#800000">5</font><font color="#000080">-</font><font color="#800000">4</font><font color="#000080">-</font><font color="#800000">3    2</font><font color="#000080">-</font><font color="#800000">1                                    0
      </font><font color="#000080">~~~~~~~~~    ~~~                                    ~
       </font>Unused      <font color="#800000">0</font><font color="#000080">-</font><font color="#800000">0 </font><font color="#000080">= </font>Change <font color="#FF0000"><b>in </b></font>MSR                <font color="#FF0000"><b>If </b></font>this bit <font color="#FF0000"><b>is set
                   </b></font><font color="#800000">0</font><font color="#000080">-</font><font color="#800000">1 </font><font color="#000080">= </font>THR empty                    more than one
                   <font color="#800000">1</font><font color="#000080">-</font><font color="#800000">0 </font><font color="#000080">= </font>Data Received                interrupt has
                   <font color="#800000">1</font><font color="#000080">-</font><font color="#800000">1 </font><font color="#000080">= </font>Data Error <font color="#FF0000"><b>or </b></font>Break          occured<font color="#000080">.


</font>LINE CONTROL <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~~
        </font>The Line Control <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>LCR<font color="#000080">) </font><font color="#FF0000"><b>is </b></font>used <font color="#FF0000"><b>for </b></font>changing the settings
<font color="#FF0000"><b>on </b></font>the serial line<font color="#000080">.  </font>It <font color="#FF0000"><b>is </b></font>also used <font color="#FF0000"><b>for </b></font>initializing the modem settings<font color="#000080">.
</font>Write a byte <font color="#FF0000"><b>to </b></font>the port<font color="#000080">, </font>containing the following info<font color="#000080">:

</font>LCR Byte<font color="#000080">.

      </font>Port Toggle   Break Condition   Parity      Stop Bits   Data Bits
bit       <font color="#800000">7                6           5</font><font color="#000080">-</font><font color="#800000">4</font><font color="#000080">-</font><font color="#800000">3          2          1</font><font color="#000080">-</font><font color="#800000">0
          </font><font color="#000080">~                ~           ~~~~~          ~          ~~~
          </font><font color="#800000">0 </font><font color="#000080">= </font>Normal       <font color="#800000">0 </font><font color="#000080">= </font>Off     <font color="#800000">0</font><font color="#000080">-</font><font color="#800000">0</font><font color="#000080">-</font><font color="#800000">0 </font><font color="#000080">= </font>None   <font color="#800000">0 </font><font color="#000080">= </font><font color="#800000">1      0</font><font color="#000080">-</font><font color="#800000">0 </font><font color="#000080">= </font><font color="#800000">5
          1 </font><font color="#000080">= </font><font color="#FF0000"><b>Set </b></font>BRD      <font color="#800000">1 </font><font color="#000080">= </font><font color="#FF0000"><b>On      </b></font><font color="#800000">1</font><font color="#000080">-</font><font color="#800000">0</font><font color="#000080">-</font><font color="#800000">0 </font><font color="#000080">= </font>Odd    <font color="#800000">1 </font><font color="#000080">= </font><font color="#800000">2      0</font><font color="#000080">-</font><font color="#800000">1 </font><font color="#000080">= </font><font color="#800000">6
                                       1</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">-</font><font color="#800000">0 </font><font color="#000080">= </font>Even              <font color="#800000">1</font><font color="#000080">-</font><font color="#800000">0 </font><font color="#000080">= </font><font color="#800000">7
                                       1</font><font color="#000080">-</font><font color="#800000">0</font><font color="#000080">-</font><font color="#800000">1 </font><font color="#000080">= </font>Mark              <font color="#800000">1</font><font color="#000080">-</font><font color="#800000">1 </font><font color="#000080">= </font><font color="#800000">8
                                       1</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">-</font><font color="#800000">1 </font><font color="#000080">= </font>Space
Everything <font color="#FF0000"><b>is </b></font>pretty clear <font color="#FF0000"><b>except for </b></font>the purpose <font color="#FF0000"><b>of </b></font>bits <font color="#800000">6 </font><font color="#FF0000"><b>and </b></font><font color="#800000">7.  </font>Bit <font color="#800000">6
</font>controls the sending <font color="#FF0000"><b>of </b></font>the break signal<font color="#000080">.  </font>Bit <font color="#800000">7 </font>should always be <font color="#800000">0</font><font color="#000080">, </font><font color="#FF0000"><b>except
if </b></font>one <font color="#FF0000"><b>is </b></font>changing the baud rate<font color="#000080">.  </font><font color="#FF0000"><b>Then </b></font>one must <font color="#FF0000"><b>set </b></font>it <font color="#FF0000"><b>to </b></font>one<font color="#000080">, </font>write <font color="#FF0000"><b>to
</b></font>the BRD <font color="#FF0000"><b>and then set </b></font>it back <font color="#FF0000"><b>to </b></font>zero<font color="#000080">.  </font>One can only write <font color="#FF0000"><b>to </b></font>the BRD <font color="#FF0000"><b>if </b></font>this
bit <font color="#FF0000"><b>is set</b></font><font color="#000080">.


</font>MODEM CONTROL <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~~~
        </font>The MCR <font color="#FF0000"><b>is </b></font>used <font color="#FF0000"><b>to </b></font>control the modem <font color="#FF0000"><b>and </b></font>it<font color="#800000">'s function.  Write one
</font>byte <font color="#FF0000"><b>to </b></font>the MCR containing the following info<font color="#000080">:

</font>MCR Byte<font color="#000080">.

</font>bit      <font color="#800000">0 </font><font color="#000080">= </font><font color="#FF0000"><b>Set </b></font>DTR Line
         <font color="#800000">1 </font><font color="#000080">= </font><font color="#FF0000"><b>Set </b></font>RTS Line
         <font color="#800000">2 </font><font color="#000080">= </font>User Output <font color="#800000">#1
         3 </font><font color="#000080">= </font>User Output <font color="#800000">#2
         4 </font><font color="#000080">= </font>UART Loopback
     <font color="#800000">7</font><font color="#000080">-</font><font color="#800000">6</font><font color="#000080">-</font><font color="#800000">5 </font><font color="#000080">= </font>Unused <font color="#000080">(</font><font color="#FF0000"><b>Set to </b></font><font color="#800000">0</font><font color="#000080">)

</font>Typically one will <font color="#FF0000"><b>set </b></font>bits <font color="#800000">3 </font>through <font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">1.  </font>Bit <font color="#800000">4 </font><font color="#FF0000"><b>is </b></font>used <font color="#FF0000"><b>for </b></font>testing
their routines without another modem<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>the other bits are unused<font color="#000080">, </font>but
should always be <font color="#FF0000"><b>set to </b></font><font color="#800000">0.


</font>LINE STATUS <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~
        </font>The LSR reports the current status <font color="#FF0000"><b>of </b></font>the RS232 serial line<font color="#000080">.  </font>The
information contained <font color="#FF0000"><b>is </b></font>obtained by reading one byte from the LSR<font color="#000080">.  </font>The
bits <font color="#FF0000"><b>and </b></font>the info associated <font color="#FF0000"><b>with </b></font>each are listed below<font color="#000080">.

</font>LSR Byte<font color="#000080">.

</font>bit     <font color="#800000">0 </font><font color="#000080">= </font>Data Received
        <font color="#800000">1 </font><font color="#000080">= </font>Overrun Error
        <font color="#800000">2 </font><font color="#000080">= </font>Parity Error
        <font color="#800000">3 </font><font color="#000080">= </font>Framing Error
        <font color="#800000">4 </font><font color="#000080">= </font>Break Detect
        <font color="#800000">5 </font><font color="#000080">= </font>THR empty
        <font color="#800000">6 </font><font color="#000080">= </font>Transmit Shift <font color="#FF0000"><b>Register </b></font><font color="#000080">(</font>TSR<font color="#000080">) </font>empty
        <font color="#800000">7 </font><font color="#000080">= </font>Time <font color="#FF0000"><b>Out

</b></font>The TSR takes the byte <font color="#FF0000"><b>in </b></font>the THR <font color="#FF0000"><b>and </b></font>transmits <font color="#FF0000"><b>is </b></font>one bit at a time<font color="#000080">.  </font>When
bit <font color="#800000">0 </font><font color="#FF0000"><b>is set </b></font>one should read from the RDR<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>when bit <font color="#800000">5 </font><font color="#FF0000"><b>is set </b></font>one should
write <font color="#FF0000"><b>to </b></font>the THR<font color="#000080">.  </font>What actions are taken <font color="#FF0000"><b>on </b></font>various errors are left up <font color="#FF0000"><b>to
</b></font>the programmer<font color="#000080">.


</font>MODEM STATUS <font color="#FF0000"><b>REGISTER
</b></font><font color="#000080">~~~~~~~~~~~~~~~~~~~~~
        </font>Just like the LSR returns the status <font color="#FF0000"><b>of </b></font>the RS232 line<font color="#000080">, </font>the MSR
returns the status <font color="#FF0000"><b>of </b></font>the modem<font color="#000080">.  </font><font color="#FF0000"><b>As with </b></font>other registers<font color="#000080">, </font>each bit <font color="#FF0000"><b>in </b></font>the
byte one reads from this port <font color="#FF0000"><b>contains </b></font>a certain piece <font color="#FF0000"><b>of </b></font>info<font color="#000080">.

</font>MSR byte<font color="#000080">.

</font>bit     <font color="#800000">0 </font><font color="#000080">= </font>Change <font color="#FF0000"><b>in </b></font>CTS
        <font color="#800000">1 </font><font color="#000080">= </font>Change <font color="#FF0000"><b>in </b></font>DSR
        <font color="#800000">2 </font><font color="#000080">= </font>Change <font color="#FF0000"><b>in </b></font>RI
        <font color="#800000">3 </font><font color="#000080">= </font>Change <font color="#FF0000"><b>in </b></font>DCD
        <font color="#800000">4 </font><font color="#000080">= </font>CTS <font color="#FF0000"><b>on
        </b></font><font color="#800000">5 </font><font color="#000080">= </font>DSR <font color="#FF0000"><b>on
        </b></font><font color="#800000">6 </font><font color="#000080">= </font>RI <font color="#FF0000"><b>on
        </b></font><font color="#800000">7 </font><font color="#000080">= </font>DCD <font color="#FF0000"><b>on

</b></font>Carrier Detect <font color="#FF0000"><b>is </b></font>achieved by testing bit <font color="#800000">7</font><font color="#000080">, </font><font color="#FF0000"><b>to </b></font>see <font color="#FF0000"><b>if </b></font>the line <font color="#FF0000"><b>is </b></font>ringing
test bit <font color="#800000">6.



</font>PUTTING IT ALL TOGETHER
<font color="#000080">~~~~~~~~~~~~~~~~~~~~~~~
        </font>One can now use this information about the <font color="#800000">8250 </font>UART <font color="#FF0000"><b>to </b></font>start
programming their own modem routines<font color="#000080">.  </font>But before they can <font color="#FF0000"><b>do </b></font>that<font color="#000080">, </font>they
must learn a little about interrupts <font color="#FF0000"><b>and </b></font>the <font color="#800000">8259 </font>PIC <font color="#000080">(</font>Programmable
Interrupt Controller<font color="#000080">).  </font>This information <font color="#FF0000"><b>is </b></font>necessary <font color="#FF0000"><b>to </b></font>write modem
routines that are <font color="#FF0000"><b>not </b></font>dependant <font color="#FF0000"><b>on </b></font>a slow BIOS<font color="#000080">.


</font>INTERRUPTS
<font color="#000080">~~~~~~~~~~
        </font>Interrupts are a broad subject<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>this <font color="#FF0000"><b>is not </b></font>a reference <font color="#FF0000"><b>for </b></font>them<font color="#000080">.
</font><font color="#FF0000"><b>For for </b></font>information <font color="#FF0000"><b>on </b></font>interrupts<font color="#000080">, </font>one should look at DOS Programmer<font color="#800000">'s
</font>Reference <font color="#800000">4</font>th Edition<font color="#000080">.  </font>Although there are two kinds <font color="#FF0000"><b>of </b></font>interrupts <font color="#000080">- </font>Non<font color="#000080">-
</font>Maskable <font color="#FF0000"><b>and </b></font>Maskable<font color="#000080">, </font>maskable interrupts are the only ones that one should
be concerned <font color="#FF0000"><b>with</b></font><font color="#000080">.  </font>When an interrupt generates<font color="#000080">, </font>the processor finishes the
current command<font color="#000080">, </font><font color="#FF0000"><b>and then </b></font>saves a few variables <font color="#000080">(</font>the address <font color="#FF0000"><b>to </b></font>return <font color="#FF0000"><b>to</b></font><font color="#000080">)
</font><font color="#FF0000"><b>on </b></font>the stack <font color="#FF0000"><b>and </b></font>jumps <font color="#FF0000"><b>to </b></font>the vector <font color="#FF0000"><b>of </b></font>the interrupt<font color="#000080">.  </font>One can turn off
maskable interrupts <font color="#FF0000"><b>with </b></font>the STI<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>back <font color="#FF0000"><b>on with </b></font>CLI<font color="#000080">.  </font>One can <font color="#FF0000"><b>not </b></font>turn
off non<font color="#000080">-</font>maskable interrupts<font color="#000080">.  </font>Replacing interrupt routines <font color="#FF0000"><b>in pascal is </b></font>very
easy<font color="#000080">.  </font>Include the DOS <font color="#FF0000"><b>unit in </b></font>their <font color="#FF0000"><b>program</b></font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>use the procedures GetIntVec
<font color="#FF0000"><b>and </b></font>SetIntVec<font color="#000080">.  </font><font color="#FF0000"><b>To </b></font>replace the interrupt <font color="#FF0000"><b>for </b></font>COM2 <font color="#000080">(</font>remember it<font color="#800000">'s 0Bh) one
</font>would <font color="#FF0000"><b>do </b></font>this<font color="#000080">:
               </font>GetIntVec<font color="#000080">(</font><font color="#800000">$0B</font><font color="#000080">, </font>OldInt0Bh<font color="#000080">);
               </font>SetIntVec<font color="#000080">(</font><font color="#800000">$0B</font><font color="#000080">, </font>NewInt0Bh<font color="#000080">);
</font>At the <font color="#FF0000"><b>end of </b></font>the <font color="#FF0000"><b>program</b></font><font color="#000080">, </font>one MUST restore the interrupt using<font color="#000080">:
               </font>SetIntVec<font color="#000080">(</font><font color="#800000">$0B</font><font color="#000080">, </font>OldInt0Bh<font color="#000080">);
</font>Failing <font color="#FF0000"><b>to do </b></font>this will most likely result <font color="#FF0000"><b>in </b></font>a system crash after the
<font color="#FF0000"><b>program </b></font>terminates<font color="#000080">.  </font>Because another interrupt may be called inside another
interrupt at any time<font color="#000080">, </font>it <font color="#FF0000"><b>is </b></font>necessary <font color="#FF0000"><b>to </b></font>turn off interrupts<font color="#000080">, </font><font color="#FF0000"><b>as </b></font>mentioned
above<font color="#000080">, </font>every once <font color="#FF0000"><b>in </b></font>a <font color="#FF0000"><b>while</b></font><font color="#000080">.  </font>Remember all this<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>programming <font color="#FF0000"><b>for </b></font>the
modem will be much easier <font color="#000080">( :) ).


</font><font color="#800000">8259 </font>PROGRAMMABLE INTERRUPT CONTROLLER
<font color="#000080">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        </font>The <font color="#800000">8259 </font>PIC <font color="#FF0000"><b>is </b></font>used by the processor <font color="#FF0000"><b>as </b></font>a gateway <font color="#FF0000"><b>for </b></font>interrupts<font color="#000080">.
</font>The <font color="#800000">8259 </font>decides which interrupts go first <font color="#FF0000"><b>and </b></font>which are currently active<font color="#000080">.
</font>The order interrupts are processed <font color="#FF0000"><b>in in </b></font>the order <font color="#FF0000"><b>of </b></font>their IRQ number<font color="#000080">.
</font>Thus<font color="#000080">, </font>IRQ0 will always be processed before IRQ1 <font color="#FF0000"><b>if </b></font>both are generated at the
same time<font color="#000080">.  </font>Since asyncronous communication <font color="#FF0000"><b>uses </b></font>IRQs<font color="#000080">, </font>we must instruct the
<font color="#800000">8259 </font>PIC <font color="#FF0000"><b>on </b></font>when are interrupts should start interrupting<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>when they
should stop<font color="#000080">.  </font>When initializing the modem<font color="#000080">, </font>one must <font color="#000080">&quot;</font>turn <font color="#FF0000"><b>on</b></font><font color="#000080">&quot; </font>the IRQ before
one can start <font color="#FF0000"><b>to </b></font>use it<font color="#000080">.  </font>Turning back off <font color="#FF0000"><b>is </b></font>identical<font color="#000080">, </font>but don<font color="#800000">'t turn it
</font>off <font color="#FF0000"><b>if </b></font>one <font color="#FF0000"><b>is </b></font>writing door routines<font color="#000080">!  </font><font color="#FF0000"><b>To do </b></font>either <font color="#FF0000"><b>requires </b></font>one assign the
value contained at the port the value <font color="#FF0000"><b>AND </b></font>the mask<font color="#000080">.  </font>The masks <font color="#FF0000"><b>for </b></font>turning
<font color="#FF0000"><b>on and </b></font>off the <font color="#800000">8259 </font>follows<font color="#000080">.

</font><font color="#FF0000"><b>To </b></font>Turn <font color="#FF0000"><b>On</b></font><font color="#000080">:
            </font>mask <font color="#000080">= (</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font><font color="#000080">(</font>IRQ number<font color="#000080">)) </font><font color="#FF0000"><b>xor </b></font><font color="#800000">$00FF
</font><font color="#FF0000"><b>To </b></font>Turn Off<font color="#000080">:
             </font>mask <font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font><font color="#000080">(</font>IRQ number<font color="#000080">)

</font>One must also reset the PIC <font color="#FF0000"><b>in </b></font>the custom interrupt handler after one <font color="#FF0000"><b>is
</b></font>finished <font color="#FF0000"><b>with </b></font>it<font color="#000080">.  </font>That will allow the PIC <font color="#FF0000"><b>to </b></font>process the next interrupt<font color="#000080">.
</font><font color="#FF0000"><b>To </b></font>reset the PIC<font color="#000080">, </font>write <font color="#800000">20</font>h <font color="#FF0000"><b>to </b></font>it<font color="#000080">.  </font>This <font color="#FF0000"><b>is </b></font>also refered <font color="#FF0000"><b>to as </b></font>the <font color="#FF0000"><b>End Of
</b></font>Interrupt <font color="#000080">(</font>EOI<font color="#000080">) </font>signal<font color="#000080">.  </font>This must also be done after first initializing the
modem<font color="#000080">.  </font>There <font color="#FF0000"><b>is </b></font>another PIC <font color="#FF0000"><b>on </b></font>the <font color="#800000">286</font><font color="#000080">, </font>allowing the last <font color="#800000">8 </font>IRQs <font color="#000080">(</font><font color="#800000">7 </font><font color="#000080">- </font><font color="#800000">15</font><font color="#000080">).
</font>The second PIC <font color="#FF0000"><b>is </b></font>called the cascade PIC<font color="#000080">.  </font>The addresses <font color="#FF0000"><b>for </b></font>the PIC command
<font color="#FF0000"><b>and </b></font>mask ports are listed next<font color="#000080">.

</font><font color="#800000">8259 </font>PIC command address         <font color="#000080">= </font><font color="#800000">20</font>h
<font color="#800000">8259 </font>PIC mask address            <font color="#000080">= </font><font color="#800000">21</font>h
Cascade <font color="#800000">8259 </font>PIC command address <font color="#000080">= </font>A0h
Cascade <font color="#800000">8259 </font>PIC mask address    <font color="#000080">= </font>A1h

<font color="#FF0000"><b>To </b></font>reset the PIC always write <font color="#FF0000"><b>to </b></font>the command<font color="#000080">, </font><font color="#FF0000"><b>and for </b></font>turning off <font color="#FF0000"><b>with </b></font>the
masks always write <font color="#FF0000"><b>to </b></font>the mask<font color="#000080">.  </font>The masks <font color="#FF0000"><b>for </b></font>the cascade PIC are the same
<font color="#FF0000"><b>for </b></font>the other PIC<font color="#000080">.  </font>So the mask <font color="#FF0000"><b>for </b></font>IRQ0 <font color="#FF0000"><b>is </b></font>equal <font color="#FF0000"><b>to </b></font>the mask <font color="#FF0000"><b>for </b></font>IRQ7<font color="#000080">.
</font>Also<font color="#000080">, </font>one should write <font color="#800000">20</font>h <font color="#FF0000"><b>to </b></font>the cascade PIC <font color="#FF0000"><b>as </b></font>the EOI signal<font color="#000080">.


</font>INPUT<font color="#000080">/</font>OUTPUT CONTROL
<font color="#000080">~~~~~~~~~~~~~~~~~~~~
        </font><font color="#FF0000"><b>To </b></font>keep the text simple<font color="#000080">, </font>only buffered input will be covered<font color="#000080">.
</font>Buffered output <font color="#FF0000"><b>is </b></font>a subject <font color="#FF0000"><b>of </b></font>more depth than one can provide <font color="#FF0000"><b>in </b></font>a short
reference<font color="#000080">.  </font>Buffered input <font color="#FF0000"><b>is </b></font>relatively simple<font color="#000080">, </font>but there are a few things
one must consider<font color="#000080">.  </font>The size <font color="#FF0000"><b>of </b></font>the buffer <font color="#FF0000"><b>is </b></font>very import<font color="#000080">, </font>make the buffer
<font color="#FF0000"><b>to </b></font>big <font color="#FF0000"><b>and </b></font>one will eat up the datasegment<font color="#000080">, </font>make the buffer <font color="#FF0000"><b>to </b></font>small <font color="#FF0000"><b>and
</b></font>one will get overruns<font color="#000080">.  </font>A good choice <font color="#FF0000"><b>for </b></font>a general buffer would be <font color="#FF0000"><b>in </b></font>the
range <font color="#FF0000"><b>of </b></font><font color="#800000">4 </font><font color="#FF0000"><b>to </b></font><font color="#800000">8</font>k<font color="#000080">.  </font>This should allow plenty <font color="#FF0000"><b>of </b></font>room <font color="#FF0000"><b>for </b></font>all incoming data<font color="#000080">.
</font>Another inportant factor <font color="#FF0000"><b>is </b></font>the <font color="#FF0000"><b>type of </b></font>buffer<font color="#000080">.  </font><font color="#FF0000"><b>For </b></font>simplicity <font color="#FF0000"><b>and </b></font>ease <font color="#FF0000"><b>of
</b></font>use<font color="#000080">, </font>a circular input buffer <font color="#FF0000"><b>is </b></font>recommended<font color="#000080">.  </font>A head <font color="#FF0000"><b>and </b></font>a tail point
<font color="#FF0000"><b>to </b></font>the start <font color="#FF0000"><b>and end of </b></font>the buffer<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>they will both wrap around when
either go past the <font color="#FF0000"><b>end of </b></font>the buffer<font color="#000080">, </font>thus making the buffer a kind <font color="#FF0000"><b>of
</b></font>circle<font color="#000080">.  </font>Getting data <font color="#FF0000"><b>in </b></font>the buffer <font color="#FF0000"><b>is </b></font>the primary job <font color="#FF0000"><b>of </b></font>the custom
interrupt routine<font color="#000080">.  </font>Clearing the buffer <font color="#FF0000"><b>and </b></font>reading characters from the
buffer <font color="#FF0000"><b>is then as </b></font>easy <font color="#FF0000"><b>as </b></font>reading a character from an <font color="#FF0000"><b>array</b></font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>advancing
the head <font color="#FF0000"><b>of </b></font>the buffer<font color="#000080">.  </font>Sending characters over the phone can be
accomplished by waiting <font color="#FF0000"><b>for </b></font>the flow control <font color="#FF0000"><b>and then </b></font>sending the character
<font color="#FF0000"><b>to </b></font>the THR<font color="#000080">, </font>repeating <font color="#FF0000"><b>for </b></font>every character<font color="#000080">.

</font>THE INTERRUPT SERVICE ROUTINE
<font color="#000080">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        </font>The ISR <font color="#000080">(</font>Interrupt Service Routine<font color="#000080">) </font><font color="#FF0000"><b>is </b></font>the backbone <font color="#FF0000"><b>for </b></font>asyncronous
communication<font color="#000080">.  </font>The interrupt <font color="#FF0000"><b>is </b></font>called <font color="#FF0000"><b>for </b></font>every character that comes
through the modem<font color="#000080">.  </font>So <font color="#FF0000"><b>in </b></font>the interrupt one must process these incoming
characters <font color="#FF0000"><b>or else </b></font>they will be lost<font color="#000080">.  </font>Since the the interrupt got called<font color="#000080">,
</font>one must check the IIR <font color="#000080">(</font>Interrupt Identification <font color="#FF0000"><b>Register</b></font><font color="#000080">) </font><font color="#FF0000"><b>to </b></font>see what
actually cause the interrupt <font color="#FF0000"><b>to </b></font>be called<font color="#000080">.  </font>Since the interrupt <font color="#FF0000"><b>is </b></font>mainly
dealing <font color="#FF0000"><b>with </b></font>handling the incoming data<font color="#000080">, </font><font color="#FF0000"><b>and for </b></font>reasons <font color="#FF0000"><b>of </b></font>simplicity<font color="#000080">,
</font>flow control will be ommited from the routine but will be discussed later
<font color="#FF0000"><b>in </b></font>this text<font color="#000080">.  </font>Since one <font color="#FF0000"><b>is </b></font>writing <font color="#FF0000"><b>to </b></font>the buffer<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>since another
character <font color="#FF0000"><b>is </b></font>likely <font color="#FF0000"><b>to </b></font>come <font color="#FF0000"><b>in </b></font>during this time<font color="#000080">, </font>one must disable interrupts
<font color="#FF0000"><b>for </b></font>the shortest time possible <font color="#FF0000"><b>while </b></font>writing <font color="#FF0000"><b>to </b></font>the buffer<font color="#000080">, </font><font color="#FF0000"><b>and then </b></font>reenable
them so no data <font color="#FF0000"><b>is </b></font>lost<font color="#000080">.  (</font>NOTE<font color="#000080">: </font><font color="#FF0000"><b>If </b></font>the ISR <font color="#FF0000"><b>is to </b></font>be contained <font color="#FF0000"><b>in </b></font>a <font color="#FF0000"><b>unit</b></font><font color="#000080">, </font>it
must be declared <font color="#FF0000"><b>in </b></font>the <font color="#FF0000"><b>unit</b></font><font color="#800000">'s interface section as an INTERRUPT procedure.)
</font>After disabling interrupts<font color="#000080">, </font>checking <font color="#FF0000"><b>for </b></font>data<font color="#000080">, </font>discarding data <font color="#FF0000"><b>if </b></font>no buffer
space <font color="#FF0000"><b>is </b></font>available<font color="#000080">, </font>putting the data <font color="#FF0000"><b>in </b></font>the buffer <font color="#FF0000"><b>if </b></font>there <font color="#FF0000"><b>is </b></font>room<font color="#000080">, </font><font color="#FF0000"><b>and
</b></font>clearing the RDR <font color="#FF0000"><b>if </b></font>any data error <font color="#FF0000"><b>or </b></font>break occured<font color="#000080">, </font>one must turn <font color="#FF0000"><b>on </b></font>the
interrupts <font color="#FF0000"><b>and </b></font>issue the EOI signal <font color="#FF0000"><b>to </b></font>the <font color="#800000">8259 </font>PIC <font color="#FF0000"><b>or </b></font>both the <font color="#800000">8259 </font>PIC
<font color="#FF0000"><b>and </b></font>the cascade PIC <font color="#FF0000"><b>if </b></font>IRQ7 <font color="#000080">- </font>IRQ15 <font color="#FF0000"><b>is </b></font>used<font color="#000080">.  </font>Here <font color="#FF0000"><b>is </b></font>a sample routine<font color="#000080">:


</font><font color="#FF0000"><b>const
  </b></font>BaseAddr<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1 </font><font color="#000080">.. </font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word <font color="#000080">= (</font><font color="#800000">$03F8</font><font color="#000080">, </font><font color="#800000">$02F8</font><font color="#000080">, </font><font color="#800000">$03E8</font><font color="#000080">, </font><font color="#800000">$02E8</font><font color="#000080">);
  </font><font color="#008000"><i>{ Nice array to make finding the base address easy }

</i></font><font color="#FF0000"><b>var
  </b></font>Buffer<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1 </font><font color="#000080">.. </font><font color="#800000">4096</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;  </font><font color="#008000"><i>{ A 4k buffer for input }
  </i></font>Temp<font color="#000080">,  </font><font color="#008000"><i>{ Varible to hold various modem statuses }
  </i></font>CommPort<font color="#000080">: </font>byte<font color="#000080">;  </font><font color="#008000"><i>{ Comm Port in use }
  </i></font>Head<font color="#000080">,  </font><font color="#008000"><i>{ Start of the buffer }
  </i></font>Tail<font color="#000080">,  </font><font color="#008000"><i>{ End of the buffer }
  </i></font>Size<font color="#000080">: </font>word<font color="#000080">;  </font><font color="#008000"><i>{ Size of the buffer }
  </i></font>Cascade<font color="#000080">: </font>boolean<font color="#000080">;  </font><font color="#008000"><i>{ For IRQ7 - IRQ15 }

</i></font><font color="#FF0000"><b>procedure </b></font>Async_ISR<font color="#000080">; </font>interrupt<font color="#000080">; </font><font color="#008000"><i>{ NOTE: must declare the procedure interrupt }
</i></font><font color="#FF0000"><b>begin
  inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">); </font><font color="#008000"><i>{ STI - Disable interrupts }
  </i></font>Temp <font color="#000080">:= </font>port<font color="#000080">[</font>BaseAddr<font color="#000080">[</font>CommPort<font color="#000080">] + </font><font color="#800000">$02</font><font color="#000080">];  </font><font color="#008000"><i>{ Read a byte from the IIR }
  </i></font><font color="#FF0000"><b>if </b></font>Temp <font color="#FF0000"><b>and </b></font><font color="#800000">$06 </font><font color="#000080">= </font><font color="#800000">$04 </font><font color="#FF0000"><b>then  </b></font><font color="#008000"><i>{ Character received }
  </i></font><font color="#FF0000"><b>begin
    if </b></font>Head <font color="#000080">&lt;&gt; </font>Tail <font color="#FF0000"><b>then  </b></font><font color="#008000"><i>{ Make sure there is room in the buffer }
    </i></font><font color="#FF0000"><b>begin
      </b></font>Buffer<font color="#000080">[</font>Tail<font color="#000080">] := </font>Chr<font color="#000080">(</font>port<font color="#000080">[</font>BaseAddr<font color="#000080">[</font>CommPort<font color="#000080">] + </font><font color="#800000">$00</font><font color="#000080">]);  </font><font color="#008000"><i>{ Read char }
      </i></font>inc<font color="#000080">(</font>Tail<font color="#000080">);  </font><font color="#008000"><i>{ Position the Tail for the next char }
      </i></font><font color="#FF0000"><b>if </b></font>Tail <font color="#000080">&gt; </font><font color="#800000">4096 </font><font color="#FF0000"><b>then </b></font>Tail <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;  </font><font color="#008000"><i>{ If Tail is greater, wrap the buffer }
    </i></font><font color="#FF0000"><b>end
    else </b></font>temp <font color="#000080">:= </font>port<font color="#000080">[</font>BaseAddr<font color="#000080">[</font>CommPort<font color="#000080">] + </font><font color="#800000">$00</font><font color="#000080">];  </font><font color="#008000"><i>{ Throw away overruns }
  </i></font><font color="#FF0000"><b>end
  else if </b></font>Temp <font color="#FF0000"><b>and </b></font><font color="#800000">$06 </font><font color="#000080">= </font><font color="#800000">$06 </font><font color="#FF0000"><b>then  </b></font><font color="#008000"><i>{ Data error or break }
    </i></font>Temp <font color="#000080">:= </font>port<font color="#000080">[</font>BaseAddr<font color="#000080">[</font>CommPort<font color="#000080">] + </font><font color="#800000">$00</font><font color="#000080">];  </font><font color="#008000"><i>{ Clear RDR }
  </i></font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);  </font><font color="#008000"><i>{ CLI - Enable interrupts }
  </i></font>port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;  </font><font color="#008000"><i>{ Reset the 8259 PIC }
  </i></font><font color="#FF0000"><b>if </b></font>Cascade <font color="#FF0000"><b>then </b></font>port<font color="#000080">[</font><font color="#800000">$A0</font><font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;  </font><font color="#008000"><i>{ Reset the cascade PIC }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font>First the <font color="#FF0000"><b>procedure </b></font>disables interrupts<font color="#000080">, </font><font color="#FF0000"><b>then </b></font>it reads the IIR <font color="#FF0000"><b>to </b></font>find <font color="#FF0000"><b>out
</b></font>what kind <font color="#FF0000"><b>of </b></font>interrupt needs processing<font color="#000080">.  </font>The <font color="#FF0000"><b>procedure then </b></font>masks <font color="#FF0000"><b>out </b></font>bits
<font color="#800000">2 </font><font color="#FF0000"><b>and </b></font><font color="#800000">1 </font><font color="#FF0000"><b>and </b></font>tests it <font color="#FF0000"><b>to </b></font>see <font color="#FF0000"><b>if </b></font>bit <font color="#800000">4 </font><font color="#FF0000"><b>is set</b></font><font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>data <font color="#FF0000"><b>is </b></font>received it checks
<font color="#FF0000"><b>to </b></font>make sure there <font color="#FF0000"><b>is </b></font>room <font color="#FF0000"><b>in </b></font>the buffer<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>places the character at the
position marked by Tail<font color="#000080">, </font>otherwise it disregards the character <font color="#FF0000"><b>as </b></font>overrun<font color="#000080">.
</font><font color="#FF0000"><b>If </b></font>a data error occured it clears the RDR <font color="#FF0000"><b>to </b></font>make sure no garbage <font color="#FF0000"><b>is
</b></font>received<font color="#000080">.  </font><font color="#FF0000"><b>Finally </b></font>it enables interrupts <font color="#FF0000"><b>and </b></font>resets the <font color="#800000">8259 </font><font color="#000080">(</font><font color="#FF0000"><b>and </b></font>the cascade
<font color="#FF0000"><b>if </b></font>necessary<font color="#000080">).


</font>SENDING CHARACTERS
<font color="#000080">~~~~~~~~~~~~~~~~~~
        </font>Sending character over the modem <font color="#FF0000"><b>is </b></font>much simpler than getting them<font color="#000080">.
</font>First one must wait <font color="#FF0000"><b>for </b></font>the flow control <font color="#FF0000"><b>and for </b></font>the UART <font color="#FF0000"><b>and then </b></font>write the
character <font color="#FF0000"><b>to </b></font>the THR<font color="#000080">.  </font>Here<font color="#800000">'s an example:

</font><font color="#FF0000"><b>procedure </b></font>XmitChar<font color="#000080">(</font>C<font color="#000080">: </font>char<font color="#000080">);  </font><font color="#008000"><i>{ Uses variable and constant declarations from
begin                           the previous example }
  </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">((</font>port<font color="#000080">[</font>BaseAddr<font color="#000080">[</font>CommPort<font color="#000080">] + </font><font color="#800000">$05</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$20 </font><font color="#000080">&lt;&gt; </font><font color="#800000">$20</font><font color="#000080">) </font><font color="#FF0000"><b>and  </b></font><font color="#008000"><i>{ Wait for THR }
         </i></font><font color="#000080">(</font>port<font color="#000080">[</font>BaseAddr<font color="#000080">[</font>CommPort<font color="#000080">] + </font><font color="#800000">$06</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$10 </font><font color="#000080">&lt;&gt; </font><font color="#800000">$10</font><font color="#000080">))  </font><font color="#008000"><i>{ Wait for CTS }
  </i></font><font color="#FF0000"><b>do </b></font><font color="#000080">;  </font><font color="#008000"><i>{ Do nothing until CTS and THR empty }
  </i></font>port<font color="#000080">[</font>BaseAddr<font color="#000080">[</font>CommPort<font color="#000080">] + </font><font color="#800000">$00</font><font color="#000080">] := </font>Ord<font color="#000080">(</font>C<font color="#000080">);  </font><font color="#008000"><i>{ Send character }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>This waits <font color="#FF0000"><b>for </b></font>the CTS signal <font color="#FF0000"><b>and for </b></font>the THR <font color="#FF0000"><b>to </b></font>be clear <font color="#FF0000"><b>and then </b></font>sends the
character<font color="#000080">.  </font><font color="#FF0000"><b>To </b></font>send strings just use this <font color="#FF0000"><b>in </b></font>a <font color="#FF0000"><b>repeat </b></font>loop such <font color="#FF0000"><b>as</b></font><font color="#000080">:

</font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>s<font color="#000080">) </font><font color="#FF0000"><b>do
  </b></font>XmitChar<font color="#000080">(</font>s<font color="#000080">[</font>x<font color="#000080">]);


</font>READING CHARACTERS
<font color="#000080">~~~~~~~~~~~~~~~~~~
        </font>The actual reading <font color="#FF0000"><b>of </b></font>character takes place <font color="#FF0000"><b>in </b></font>the ISR<font color="#000080">, </font>but one still
has <font color="#FF0000"><b>to </b></font>get them from the buffer<font color="#000080">.  </font>Just read the character at the head <font color="#FF0000"><b>of
</b></font>the buffer <font color="#FF0000"><b>and </b></font>pass it back<font color="#000080">.  </font>An example<font color="#000080">:

</font><font color="#FF0000"><b>function </b></font>RemoteReadKey<font color="#000080">: </font>char<font color="#000080">;  </font><font color="#008000"><i>{ Uses var and const from above }
</i></font><font color="#FF0000"><b>begin
  </b></font>RemoteReadKey <font color="#000080">:= </font>Buffer<font color="#000080">[</font>Head<font color="#000080">];  </font><font color="#008000"><i>{ Get the character }
  </i></font>inc<font color="#000080">(</font>Head<font color="#000080">);  </font><font color="#008000"><i>{ Move Head to the next character }
  </i></font><font color="#FF0000"><b>if </b></font>Head <font color="#000080">&gt; </font><font color="#800000">4096 </font><font color="#FF0000"><b>then </b></font>Head <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;  </font><font color="#008000"><i>{ Wrap Head around if necessary }
  </i></font>dec<font color="#000080">(</font>Size<font color="#000080">);  </font><font color="#008000"><i>{ Remove the character }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>To </b></font>find <font color="#FF0000"><b>out if </b></font>a character <font color="#FF0000"><b>is </b></font>waiting <font color="#FF0000"><b>is </b></font>even easier<font color="#000080">:

</font><font color="#FF0000"><b>function </b></font>RemoteKeyPressed<font color="#000080">: </font>boolean<font color="#000080">;  </font><font color="#008000"><i>{ Uses vars and consts from above }
</i></font><font color="#FF0000"><b>begin
  </b></font>RemoteKeyPressed <font color="#000080">:= </font>Size <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">;  </font><font color="#008000"><i>{ A key was pressed if there is data in
end;                               the buffer }


</i></font>INITIALIZING MODEM PARAMETERS <font color="#FF0000"><b>AND </b></font>OTHER TOPICS
<font color="#000080">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        </font><font color="#FF0000"><b>For </b></font>most cases one can use interrupt <font color="#800000">14</font>h <font color="#FF0000"><b>function </b></font><font color="#800000">00</font>h <font color="#FF0000"><b>to </b></font>initialize
modem parameters<font color="#000080">, </font>but <font color="#FF0000"><b>if </b></font>the baud rate <font color="#FF0000"><b>is </b></font>over <font color="#800000">9600</font><font color="#000080">, </font>this <font color="#FF0000"><b>function </b></font>will
<font color="#FF0000"><b>not </b></font>work<font color="#000080">.  </font>One must change the BRD themselves<font color="#000080">.  </font>It <font color="#FF0000"><b>is </b></font>a simple matter <font color="#FF0000"><b>of
</b></font>accessing the BRD by setting the LCR bit <font color="#800000">7 </font><font color="#FF0000"><b>to </b></font><font color="#800000">1 </font><font color="#FF0000"><b>and </b></font>writing <font color="#FF0000"><b>to </b></font>the BRD <font color="#FF0000"><b>and
then </b></font>reseting the LCR bit <font color="#800000">7 </font>back <font color="#FF0000"><b>to </b></font><font color="#800000">0.  </font>Everything <font color="#FF0000"><b>else</b></font><font color="#000080">, </font>clearing buffers<font color="#000080">,
</font>flushing buffers<font color="#000080">, </font>formatting input<font color="#000080">, </font><font color="#FF0000"><b>is </b></font>all up <font color="#FF0000"><b>to </b></font>the programmer<font color="#000080">.  </font>I have
provided one <font color="#FF0000"><b>with </b></font>enough information <font color="#FF0000"><b>to </b></font>grasp the basis <font color="#FF0000"><b>of </b></font>modem programming
<font color="#FF0000"><b>and </b></font>the I<font color="#000080">/</font>O involved<font color="#000080">.

</font>FLOW CONTROL
<font color="#000080">~~~~~~~~~~~~
        </font>Flow control <font color="#FF0000"><b>is </b></font>mainly used <font color="#FF0000"><b>to </b></font>prevent overflow error <font color="#FF0000"><b>on </b></font>today<font color="#800000">'s
</font>high speed modems<font color="#000080">.  </font>CTS<font color="#000080">/</font>RTS was already covered earlier<font color="#000080">, </font>but nothing has
been said <font color="#FF0000"><b>for </b></font>XOn<font color="#000080">/</font>XOff<font color="#000080">.  </font>XOn<font color="#000080">/</font>XOff will send a certain character <font color="#000080">(</font>usually
a <font color="#000080">^</font>S<font color="#000080">) </font>when the input buffer has reached a certain percentage <font color="#FF0000"><b>of </b></font>capacity<font color="#000080">.
</font>This signal <font color="#FF0000"><b>is </b></font>XOff<font color="#000080">.  </font>When the buffer has gone down <font color="#FF0000"><b>to </b></font>another percentage <font color="#FF0000"><b>of
</b></font>capacity<font color="#000080">, </font>XOn <font color="#000080">(</font>usually a <font color="#000080">^</font>Q<font color="#000080">) </font>will be sent<font color="#000080">.  </font>It <font color="#FF0000"><b>is </b></font>the programmer<font color="#800000">'s job to
</font>look <font color="#FF0000"><b>for </b></font>XOn<font color="#000080">/</font>XOff codes <font color="#FF0000"><b>and </b></font>interperate them<font color="#000080">, </font><font color="#FF0000"><b>as </b></font>there are no standard ways
<font color="#FF0000"><b>to do </b></font>it <font color="#FF0000"><b>as with </b></font>CTS<font color="#000080">/</font>RTS<font color="#000080">.  </font>It <font color="#FF0000"><b>is </b></font>also his job <font color="#FF0000"><b>to </b></font>make sure he <font color="#FF0000"><b>or </b></font>she sends
the signals at the appropriate time<font color="#000080">.


</font>CONCLUSION
<font color="#000080">~~~~~~~~~~
        </font>This text <font color="#FF0000"><b>is </b></font>general<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>won<font color="#800000">'t satisfy the needs of advanced modem
</font>programmers<font color="#000080">.  </font>It was written <font color="#FF0000"><b>to </b></font>help those just starting<font color="#000080">, </font><font color="#FF0000"><b>or </b></font>thinking about
starting<font color="#000080">, </font>through the ordeal <font color="#FF0000"><b>of </b></font>finding a book<font color="#000080">, </font><font color="#FF0000"><b>or </b></font>read through source <font color="#FF0000"><b>not
</b></font>knowing what some <font color="#FF0000"><b>of </b></font>it does<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>one finds any mistakes<font color="#000080">, </font>please feel free
<font color="#FF0000"><b>to </b></font>contact me via the <font color="#FF0000"><b>Pascal </b></font>FIDONet echo<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>he will gladly correct
them<font color="#000080">.  </font>Also<font color="#000080">, </font><font color="#FF0000"><b>if </b></font>one would like more information <font color="#FF0000"><b>on </b></font>other related topics<font color="#000080">,
</font>contact me via the <font color="#FF0000"><b>Pascal </b></font>echo<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>I will <font color="#FF0000"><b>try to </b></font>help<font color="#000080">.

</font>_____________________________________________________<font color="#000080">----


</font>I hope everyone will find this text useful<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>please feel free <font color="#FF0000"><b>to
</b></font>comment <font color="#FF0000"><b>or </b></font>correct anything<font color="#000080">.  </font>I posted it once but it got choped off <font color="#FF0000"><b>in
</b></font>places<font color="#000080">, </font>so i<font color="#800000">'m posting it again.  Enjoy.

        </font>Jack


</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FAQ SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p></body>
</html>
