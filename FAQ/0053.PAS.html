<html>
<head><title> "XMS Memory Specification" by MICROSOFT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FAQ SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0053.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">eXtended Memory Specification <font color="#000080">(</font>XMS<font color="#000080">), </font>ver <font color="#800000">3.0


</font>January <font color="#800000">1991


</font>Copyright <font color="#000080">(</font>c<font color="#000080">) </font><font color="#800000">1988</font><font color="#000080">, </font>Microsoft Corporation<font color="#000080">, </font>Lotus Development
Corporation<font color="#000080">, </font>Intel Corporation<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>AST Research<font color="#000080">, </font>Inc<font color="#000080">.

</font>Microsoft Corporation                                            
Box <font color="#800000">97017

</font>One Microsoft Way                                       
Redmond<font color="#000080">, </font>WA <font color="#800000">98073

</font>LOTUS <font color="#000080">(</font>r<font color="#000080">)
</font>INTEL <font color="#000080">(</font>r<font color="#000080">)
</font>MICROSOFT <font color="#000080">(</font>r<font color="#000080">)
</font>AST <font color="#000080">(</font>r<font color="#000080">) </font>Research

This specification was jointly developed by Microsoft Corporation<font color="#000080">,
</font>Lotus Development Corporation<font color="#000080">, </font>Intel Corporation<font color="#000080">,</font><font color="#FF0000"><b>and </b></font>AST Research<font color="#000080">,
</font>Inc<font color="#000080">. </font>Although it has been released into the <font color="#FF0000"><b>public </b></font>domain <font color="#FF0000"><b>and is not
</b></font>confidential <font color="#FF0000"><b>or </b></font>proprietary<font color="#000080">, </font>the specification <font color="#FF0000"><b>is </b></font>still the copyright
<font color="#FF0000"><b>and property of </b></font>Microsoft Corporation<font color="#000080">, </font>Lotus Development Corporation<font color="#000080">,
</font>Intel Corporation<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>AST Research<font color="#000080">, </font>Inc<font color="#000080">.

</font>Disclaimer <font color="#FF0000"><b>of </b></font>Warranty

MICROSOFT CORPORATION<font color="#000080">, </font>LOTUS DEVELOPMENT CORPORATION<font color="#000080">, </font>INTEL
CORPORATION<font color="#000080">, </font><font color="#FF0000"><b>AND </b></font>AST RESEARCH<font color="#000080">, </font>INC<font color="#000080">., </font>EXCLUDE ANY <font color="#FF0000"><b>AND </b></font>ALL IMPLIED
WARRANTIES<font color="#000080">, </font>INCLUDING WARRANTIES <font color="#FF0000"><b>OF </b></font>MERCHANTABILITY <font color="#FF0000"><b>AND </b></font>FITNESS <font color="#FF0000"><b>FOR </b></font>A
PARTICULAR PURPOSE<font color="#000080">. </font>NEITHER MICROSOFT NOR LOTUS NOR INTEL NOR AST
RESEARCH MAKE ANY WARRANTY <font color="#FF0000"><b>OF </b></font>REPRESENTATION<font color="#000080">, </font>EITHER EXPRESS <font color="#FF0000"><b>OR
</b></font>IMPLIED<font color="#000080">, </font><font color="#FF0000"><b>WITH </b></font>RESPECT <font color="#FF0000"><b>TO </b></font>THIS SPECIFICATION<font color="#000080">, </font>ITS QUALITY<font color="#000080">,
</font>PERFORMANCE<font color="#000080">, </font>MERCHANTABILITY<font color="#000080">, </font><font color="#FF0000"><b>OR </b></font>FITNESS <font color="#FF0000"><b>FOR </b></font>A PARTICULAR PURPOSE<font color="#000080">.
</font>NEITHER MICROSOFT NOR LOTUS NOR INTEL NOR AST RESEARCH SHALL HAVE ANY
LIABILITY <font color="#FF0000"><b>FOR </b></font>SPECIAL<font color="#000080">, </font>INCIDENTAL<font color="#000080">, </font><font color="#FF0000"><b>OR </b></font>CONSEQUENTIAL DAMAGES ARISING
<font color="#FF0000"><b>OUT OF OR </b></font>RESULTING FROM THE USE <font color="#FF0000"><b>OR </b></font>MODIFICATION <font color="#FF0000"><b>OF </b></font>THIS
SPECIFICATION<font color="#000080">.

</font>This specification <font color="#FF0000"><b>uses </b></font>the following trademarks<font color="#000080">:

</font>Intel <font color="#FF0000"><b>is </b></font>a registered trademark <font color="#FF0000"><b>of </b></font>Intel Corporation<font color="#000080">, </font>Microsoft <font color="#FF0000"><b>is </b></font>a
registered trademark <font color="#FF0000"><b>of </b></font>Microsoft Corporation<font color="#000080">, </font>Lotus <font color="#FF0000"><b>is </b></font>a registered
trademark <font color="#FF0000"><b>of </b></font>Lotus Development Corporation<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>AST <font color="#FF0000"><b>is </b></font>a registered
trademark <font color="#FF0000"><b>of </b></font>AST Research<font color="#000080">, </font>Inc<font color="#000080">.



</font>Extended Memory Specification

    The purpose <font color="#FF0000"><b>of </b></font>this document <font color="#FF0000"><b>is to </b></font>define the Extended Memory Specification <font color="#000080">(</font>XMS<font color="#000080">) </font>version <font color="#800000">3.00 </font><font color="#FF0000"><b>for </b></font>MS<font color="#000080">-</font>DOS<font color="#000080">.  </font>XMS allows DOS programs <font color="#FF0000"><b>to </b></font>utilize additional memory found <font color="#FF0000"><b>in </b></font>Intel<font color="#800000">'s 80286 and 80386 based machines in a consistent, machine independent manner.  With some restrictions, XMS adds almost 64K to the 640K which DOS programs can access directly.  Depending on available hardware, XMS may provide even more memory to DOS programs.  XMS also provides DOS programs with a standard method of storing data in extended memory.

        </font><font color="#FF0000"><b>To </b></font>be considered fully XMS <font color="#800000">3.0 </font>compliant<font color="#000080">, </font>all calls <font color="#FF0000"><b>except </b></font>those associated <font color="#FF0000"><b>with </b></font>UMB support must be implemented<font color="#000080">. </font>UMB functions <font color="#800000">10</font>h<font color="#000080">, </font><font color="#800000">11</font>h <font color="#FF0000"><b>and </b></font><font color="#800000">12</font>h are optional <font color="#FF0000"><b>for </b></font>XMS <font color="#800000">3.0 </font><font color="#FF0000"><b>and </b></font>may return the <font color="#FF0000"><b>Function Not </b></font>Implemented error code<font color="#000080">, </font><font color="#800000">80</font>h<font color="#000080">.

</font>DEFINITIONS<font color="#000080">:
------------

</font>Extended Memory<font color="#000080">:
</font>Memory <font color="#FF0000"><b>in </b></font><font color="#800000">80286 </font><font color="#FF0000"><b>and </b></font><font color="#800000">80386 </font>based machines which <font color="#FF0000"><b>is </b></font>located above the <font color="#800000">1</font>MB address boundary<font color="#000080">.

</font>High Memory Area <font color="#000080">(</font>HMA<font color="#000080">):
</font>The first <font color="#800000">64</font>K <font color="#FF0000"><b>of </b></font>extended memory<font color="#000080">.  </font>The High Memory Area <font color="#FF0000"><b>is </b></font>unique because code can be executed <font color="#FF0000"><b>in </b></font>it <font color="#FF0000"><b>while in </b></font>real mode<font color="#000080">.  </font>The HMA officially starts at FFFF<font color="#000080">:</font><font color="#800000">10</font>h <font color="#FF0000"><b>and </b></font>ends at FFFF<font color="#000080">:</font>FFFFh making it <font color="#800000">64</font>K<font color="#000080">-</font><font color="#800000">16 </font>bytes <font color="#FF0000"><b>in </b></font>length<font color="#000080">.
                    
</font>Upper Memory Blocks <font color="#000080">(</font>UMBs<font color="#000080">):
</font>Blocks <font color="#FF0000"><b>of </b></font>memory available <font color="#FF0000"><b>on </b></font>some <font color="#800000">80</font>x86 based machines which are located between DOS<font color="#800000">'s 640K limit and the 1MB address boundary.  The number, size, and location of these blocks vary widely depending upon the types of hardware adapter cards installed in the machine.
                    
</font>Extended Memory Blocks <font color="#000080">(</font>EMBs<font color="#000080">):
</font>Blocks <font color="#FF0000"><b>of </b></font>extended memory located above the HMA which can only be used <font color="#FF0000"><b>for </b></font>data storage<font color="#000080">.
                    
</font>A20 Line<font color="#000080">:
</font>The <font color="#800000">21</font>st address line <font color="#FF0000"><b>of </b></font><font color="#800000">80</font>x86 CPUs<font color="#000080">.  </font>Enabling the A20 line allows access <font color="#FF0000"><b>to </b></font>the HMA<font color="#000080">.

</font>XMM<font color="#000080">:
</font>An Extended Memory Manager<font color="#000080">.  </font>A DOS device driver which <font color="#FF0000"><b>implements </b></font>XMS<font color="#000080">.  </font>XMMs are machine specific but allow programs <font color="#FF0000"><b>to </b></font>use extended memory <font color="#FF0000"><b>in </b></font>a machine<font color="#000080">-</font>independent manner<font color="#000080">.
    
</font>HIMEM<font color="#000080">.</font>SYS<font color="#000080">:
</font>The Extended Memory Manager currently being distributed by Microsoft<font color="#000080">.



</font>Helpful Diagram<font color="#000080">:

|               |   </font>Top <font color="#FF0000"><b>of </b></font>Memory
<font color="#000080">|               |
|               |
|       /\      |
|      /||\     |
|       ||      |
|       ||      |
|               |
|               |
|               |
|       </font>Possible Extended Memory Block  <font color="#000080">|
|               |
|               |
|               |
|       ||      |
|       ||      |
|      \||/     |
|       \/      |
|               |
|               |
|       </font>Other EMBs could exist above <font color="#800000">1088</font>K <font color="#000080">(</font><font color="#800000">1</font>MB<font color="#000080">+</font><font color="#800000">64</font>K<font color="#000080">)    |
|               |
|               |
|               |   </font><font color="#800000">1088</font>K
<font color="#000080">|               |
|               |
|       </font>The High Memory Area    <font color="#000080">|
|               |
|               |
|               |   </font><font color="#800000">1024</font>K <font color="#FF0000"><b>or </b></font><font color="#800000">1</font>MB
<font color="#000080">|               |
|       /\      |
|      /||\     |
|       ||      |
|       ||      |
|               |
|               |
|       </font>Possible Upper Memory Block     <font color="#000080">|
|               |
|       ||      |
|       ||      |
|      \||/     |
|       \/      |
|               |
|       </font>Other UMBs could exist between <font color="#800000">640</font>K <font color="#FF0000"><b>and </b></font><font color="#800000">1</font>MB     <font color="#000080">|
|               |
|               |   </font><font color="#800000">640</font>K

<font color="#000080">|               |
|               |
|               |
|       </font>Conventional <font color="#FF0000"><b>or </b></font>DOS Memory      <font color="#000080">|
|               |
|               |
|               |
|               |
|               |
+               +   </font><font color="#800000">0</font>K

DRIVER INSTALLATION<font color="#000080">:
--------------------

    </font>An XMS driver <font color="#FF0000"><b>is </b></font>installed by including a DEVICE<font color="#000080">= </font>statement <font color="#FF0000"><b>in </b></font>the
machine<font color="#800000">'s CONFIG.SYS file.  It must be installed prior to any other
</font>devices <font color="#FF0000"><b>or </b></font>TSRs which use it<font color="#000080">.  </font>An optional parameter after the driver<font color="#800000">'s
</font>name <font color="#000080">(</font>suggested name <font color="#000080">&quot;/</font>HMAMIN<font color="#000080">=&quot;) </font>indicates the minimum amount <font color="#FF0000"><b>of </b></font>space <font color="#FF0000"><b>in
</b></font>the HMA a <font color="#FF0000"><b>program </b></font>can use<font color="#000080">.  </font>Programs which use less than the minimum will
<font color="#FF0000"><b>not </b></font>be placed <font color="#FF0000"><b>in </b></font>the HMA<font color="#000080">.  </font>See <font color="#000080">&quot;</font>Prioritizing HMA Usage<font color="#000080">&quot; </font>below <font color="#FF0000"><b>for </b></font>more
information<font color="#000080">.  </font>A second optional parameter <font color="#000080">(</font>suggested name <font color="#000080">&quot;/</font>NUMHANDLES<font color="#000080">=&quot;)
</font>allows users <font color="#FF0000"><b>to </b></font>specify the maximum number <font color="#FF0000"><b>of </b></font>extended memory blocks which
may be allocated at any time<font color="#000080">.

    </font>NOTE<font color="#000080">: </font>XMS <font color="#FF0000"><b>requires </b></font>DOS <font color="#800000">3.00 </font><font color="#FF0000"><b>or </b></font>above<font color="#000080">.


</font>THE PROGRAMMING API<font color="#000080">:
--------------------

    </font>The XMS API Functions are accessed via the XMS driver<font color="#800000">'s Control Function.
</font>The address <font color="#FF0000"><b>of </b></font>the Control <font color="#FF0000"><b>Function is </b></font>determined via INT <font color="#800000">2</font>Fh<font color="#000080">.  </font>First<font color="#000080">, </font>a
<font color="#FF0000"><b>program </b></font>should determine <font color="#FF0000"><b>if </b></font>an XMS driver <font color="#FF0000"><b>is </b></font>installed<font color="#000080">.  </font>Next<font color="#000080">, </font>it should
retrieve the address <font color="#FF0000"><b>of </b></font>the driver<font color="#800000">'s Control Function.  It can then use any
</font><font color="#FF0000"><b>of </b></font>the available XMS functions<font color="#000080">.  </font>The functions are divided into several
groups<font color="#000080">:

        </font><font color="#800000">1. </font>Driver Information Functions <font color="#000080">(</font><font color="#800000">0</font>h<font color="#000080">)
        </font><font color="#800000">2. </font>HMA Management Functions <font color="#000080">(</font><font color="#800000">1</font>h<font color="#000080">-</font><font color="#800000">2</font>h<font color="#000080">)
        </font><font color="#800000">3. </font>A20 Management Functions <font color="#000080">(</font><font color="#800000">3</font>h<font color="#000080">-</font><font color="#800000">7</font>h<font color="#000080">)
        </font><font color="#800000">4. </font>Extended Memory Management Functions <font color="#000080">(</font><font color="#800000">8</font>h<font color="#000080">-</font>Fh<font color="#000080">)
        </font><font color="#800000">5. </font>Upper Memory Management Functions <font color="#000080">(</font><font color="#800000">10</font>h<font color="#000080">-</font><font color="#800000">11</font>h<font color="#000080">)


</font>DETERMINING <font color="#FF0000"><b>IF </b></font>AN XMS DRIVER <font color="#FF0000"><b>IS </b></font>INSTALLED<font color="#000080">:
------------------------------------------

    </font>The recommended way <font color="#FF0000"><b>of </b></font>determining <font color="#FF0000"><b>if </b></font>an XMS driver <font color="#FF0000"><b>is </b></font>installed <font color="#FF0000"><b>is to
set </b></font>AH<font color="#000080">=</font><font color="#800000">43</font>h <font color="#FF0000"><b>and </b></font>AL<font color="#000080">=</font><font color="#800000">00</font>h <font color="#FF0000"><b>and then </b></font>execute INT <font color="#800000">2</font>Fh<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>an XMS driver <font color="#FF0000"><b>is </b></font>available<font color="#000080">,
</font><font color="#800000">80</font>h will be returned <font color="#FF0000"><b>in </b></font>AL<font color="#000080">.

    </font>Example<font color="#000080">:
            ; </font><font color="#FF0000"><b>Is </b></font>an XMS driver installed<font color="#000080">?
            </font>mov     ax<font color="#000080">,</font><font color="#800000">4300</font>h
            int     <font color="#800000">2</font>Fh         
            cmp     al<font color="#000080">,</font><font color="#800000">80</font>h  
            jne     NoXMSDriver
            

CALLING THE API FUNCTIONS<font color="#000080">:
--------------------------

    </font>Programs can execute INT <font color="#800000">2</font>Fh <font color="#FF0000"><b>with </b></font>AH<font color="#000080">=</font><font color="#800000">43</font>h <font color="#FF0000"><b>and </b></font>AL<font color="#000080">=</font><font color="#800000">10</font>h <font color="#FF0000"><b>to </b></font>obtain the address
<font color="#FF0000"><b>of </b></font>the driver<font color="#800000">'s control function.  The address is returned in ES:BX.  This
</font><font color="#FF0000"><b>function is </b></font>called <font color="#FF0000"><b>to </b></font>access all <font color="#FF0000"><b>of </b></font>the XMS functions<font color="#000080">.  </font>It should be called
<font color="#FF0000"><b>with </b></font>AH <font color="#FF0000"><b>set to </b></font>the number <font color="#FF0000"><b>of </b></font>the API <font color="#FF0000"><b>function </b></font>requested<font color="#000080">.  </font>The API <font color="#FF0000"><b>function
</b></font>will put a success code <font color="#FF0000"><b>of </b></font><font color="#800000">0001</font>h <font color="#FF0000"><b>or </b></font><font color="#800000">0000</font>h <font color="#FF0000"><b>in </b></font>AX<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the <font color="#FF0000"><b>function </b></font>succeeded
<font color="#000080">(</font>AX<font color="#000080">=</font><font color="#800000">0001</font>h<font color="#000080">), </font>additional information may be passed back <font color="#FF0000"><b>in </b></font>BX <font color="#FF0000"><b>and </b></font>DX<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the
<font color="#FF0000"><b>function </b></font>failed <font color="#000080">(</font>AX<font color="#000080">=</font><font color="#800000">0000</font>h<font color="#000080">), </font>an error code may be returned <font color="#FF0000"><b>in </b></font>BL<font color="#000080">.  </font>Valid
error codes have their high bit <font color="#FF0000"><b>set</b></font><font color="#000080">.  </font>Developers should keep <font color="#FF0000"><b>in </b></font>mind that
some <font color="#FF0000"><b>of </b></font>the XMS API functions may <font color="#FF0000"><b>not </b></font>be implemented by all drivers <font color="#FF0000"><b>and </b></font>will
return failure <font color="#FF0000"><b>in </b></font>all cases<font color="#000080">.

    </font>Example<font color="#000080">:
            ; </font>Get the address <font color="#FF0000"><b>of </b></font>the driver<font color="#800000">'s control function
            </font>mov     ax<font color="#000080">,</font><font color="#800000">4310</font>h
            int     <font color="#800000">2</font>Fh
            mov     word ptr <font color="#000080">[</font>XMSControl<font color="#000080">],</font>bx        <font color="#000080">; </font>XMSControl <font color="#FF0000"><b>is </b></font>a DWORD
            mov     word ptr <font color="#000080">[</font>XMSControl<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">],</font>es
            
            <font color="#000080">; </font>Get the XMS driver<font color="#800000">'s version number
            </font>mov     ah<font color="#000080">,</font><font color="#800000">00</font>h
            call    <font color="#000080">[</font>XMSControl<font color="#000080">]    ; </font>Get XMS Version Number

    NOTE<font color="#000080">: </font>Programs should make sure that at least <font color="#800000">256 </font>bytes <font color="#FF0000"><b>of </b></font>stack space
          <font color="#FF0000"><b>is </b></font>available before calling XMS API functions<font color="#000080">.


</font>API <font color="#FF0000"><b>FUNCTION </b></font>DESCRIPTIONS<font color="#000080">:
--------------------------

    </font>The following XMS API functions are available<font color="#000080">:

       </font><font color="#800000">0</font>h<font color="#000080">)  </font>Get XMS Version Number
       <font color="#800000">1</font>h<font color="#000080">)  </font>Request High Memory Area
       <font color="#800000">2</font>h<font color="#000080">)  </font>Release High Memory Area
       <font color="#800000">3</font>h<font color="#000080">)  </font>Global Enable A20
       <font color="#800000">4</font>h<font color="#000080">)  </font>Global Disable A20
       <font color="#800000">5</font>h<font color="#000080">)  </font>Local Enable A20
       <font color="#800000">6</font>h<font color="#000080">)  </font>Local Disable A20
       <font color="#800000">7</font>h<font color="#000080">)  </font>Query A20
       <font color="#800000">8</font>h<font color="#000080">)  </font>Query Free Extended Memory
       <font color="#800000">9</font>h<font color="#000080">)  </font>Allocate Extended Memory Block
       Ah<font color="#000080">)  </font>Free Extended Memory Block
       Bh<font color="#000080">)  </font>Move Extended Memory Block
       Ch<font color="#000080">)  </font>Lock Extended Memory Block
       Dh<font color="#000080">)  </font>Unlock Extended Memory Block
       Eh<font color="#000080">)  </font>Get Handle Information
       Fh<font color="#000080">)  </font>Reallocate Extended Memory Block
      <font color="#800000">10</font>h<font color="#000080">)  </font>Request Upper Memory Block
      <font color="#800000">11</font>h<font color="#000080">)  </font>Release Upper Memory Block
      <font color="#800000">12</font>h<font color="#000080">) </font>Realloc Upper Memory Block
      <font color="#800000">88</font>h<font color="#000080">) </font>Query any Free Extended Memory
      <font color="#800000">89</font>h<font color="#000080">) </font>Allocate any Extended Memory Block
      <font color="#800000">8E</font>h<font color="#000080">) </font>Get Extended EMB Handle
      <font color="#800000">8</font>Fh<font color="#000080">) </font>Realloc any Extended Memory

Each <font color="#FF0000"><b>is </b></font>described below<font color="#000080">.


</font>Get XMS Version Number <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">00</font>h<font color="#000080">):
--------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">00</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font>XMS version number
            BX <font color="#000080">= </font>Driver internal revision number
            DX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the HMA exists<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>None

    This <font color="#FF0000"><b>function </b></font>returns <font color="#FF0000"><b>with </b></font>AX equal <font color="#FF0000"><b>to </b></font>a <font color="#800000">16</font><font color="#000080">-</font>bit BCD number representing
the revision <font color="#FF0000"><b>of </b></font>the DOS Extended Memory Specification which the driver
implements <font color="#000080">(</font>e<font color="#000080">.</font>g<font color="#000080">. </font>AX<font color="#000080">=</font><font color="#800000">0235</font>h would mean that the driver implemented XMS version
<font color="#800000">2.35</font><font color="#000080">).  </font>BX <font color="#FF0000"><b>is set </b></font>equal <font color="#FF0000"><b>to </b></font>the driver<font color="#800000">'s internal revision number mainly for
</font>debugging purposes<font color="#000080">.  </font>DX indicates the existence <font color="#FF0000"><b>of </b></font>the HMA <font color="#000080">(</font><font color="#FF0000"><b>not </b></font>its
availability<font color="#000080">) </font><font color="#FF0000"><b>and is </b></font>intended mainly <font color="#FF0000"><b>for </b></font>installation programs<font color="#000080">.
    
    </font>NOTE<font color="#000080">: </font>This document defines version <font color="#800000">3.00 </font><font color="#FF0000"><b>of </b></font>the specification<font color="#000080">.


</font>Request High Memory Area <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">01</font>h<font color="#000080">):
----------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">01</font>h
            <font color="#FF0000"><b>If </b></font>the caller <font color="#FF0000"><b>is </b></font>a TSR <font color="#FF0000"><b>or </b></font>device driver<font color="#000080">,
                </font>DX <font color="#000080">= </font>Space needed <font color="#FF0000"><b>in </b></font>the HMA by the caller <font color="#FF0000"><b>in </b></font>bytes
            <font color="#FF0000"><b>If </b></font>the caller <font color="#FF0000"><b>is </b></font>an application <font color="#FF0000"><b>program</b></font><font color="#000080">,
                </font>DX <font color="#000080">= </font>FFFFh     
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the HMA <font color="#FF0000"><b>is </b></font>assigned <font color="#FF0000"><b>to </b></font>the caller<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font><font color="#800000">90</font>h <font color="#FF0000"><b>if </b></font>the HMA does <font color="#FF0000"><b>not </b></font>exist
            BL <font color="#000080">= </font><font color="#800000">91</font>h <font color="#FF0000"><b>if </b></font>the HMA <font color="#FF0000"><b>is </b></font>already <font color="#FF0000"><b>in </b></font>use
            BL <font color="#000080">= </font><font color="#800000">92</font>h <font color="#FF0000"><b>if </b></font>DX <font color="#FF0000"><b>is </b></font>less than the <font color="#000080">/</font>HMAMIN<font color="#000080">= </font>parameter

    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>reserve the <font color="#800000">64</font>K<font color="#000080">-</font><font color="#800000">16 </font>byte high memory area <font color="#FF0000"><b>for
</b></font>the caller<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the HMA <font color="#FF0000"><b>is </b></font>currently unused<font color="#000080">, </font>the caller<font color="#800000">'s size parameter is
</font>compared <font color="#FF0000"><b>to </b></font>the <font color="#000080">/</font>HMAMIN<font color="#000080">= </font>parameter <font color="#FF0000"><b>on </b></font>the driver<font color="#800000">'s command line.  If the
</font>value passed by the caller <font color="#FF0000"><b>is </b></font>greater than <font color="#FF0000"><b>or </b></font>equal <font color="#FF0000"><b>to </b></font>the amount specified
by the driver<font color="#800000">'s parameter, the request succeeds.  This provides the ability
</font><font color="#FF0000"><b>to </b></font>ensure that programs which use the HMA efficiently have priority over
those which <font color="#FF0000"><b>do not</b></font><font color="#000080">.

    </font>NOTE<font color="#000080">: </font>See the sections <font color="#000080">&quot;</font>Prioritizing HMA Usage<font color="#000080">&quot; </font><font color="#FF0000"><b>and </b></font><font color="#000080">&quot;</font>High Memory Area
          Restrictions<font color="#000080">&quot; </font>below <font color="#FF0000"><b>for </b></font>more information<font color="#000080">.


</font>Release High Memory Area <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">02</font>h<font color="#000080">):
----------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">02</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the HMA <font color="#FF0000"><b>is </b></font>successfully released<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font><font color="#800000">90</font>h <font color="#FF0000"><b>if </b></font>the HMA does <font color="#FF0000"><b>not </b></font>exist
            BL <font color="#000080">= </font><font color="#800000">93</font>h <font color="#FF0000"><b>if </b></font>the HMA was <font color="#FF0000"><b>not </b></font>allocated

    This <font color="#FF0000"><b>function </b></font>releases the high memory area <font color="#FF0000"><b>and </b></font>allows other programs <font color="#FF0000"><b>to
</b></font>use it<font color="#000080">.  </font>Programs which allocate the HMA must release it before exiting<font color="#000080">.  
</font>When the HMA has been released<font color="#000080">, </font>any code <font color="#FF0000"><b>or </b></font>data stored <font color="#FF0000"><b>in </b></font>it becomes invalid
<font color="#FF0000"><b>and </b></font>should <font color="#FF0000"><b>not </b></font>be accessed<font color="#000080">.


</font>Global Enable A20 <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">03</font>h<font color="#000080">):
---------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">03</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>enabled<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font><font color="#800000">82</font>h <font color="#FF0000"><b>if </b></font>an A20 error occurs

    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>enable the A20 line<font color="#000080">.  </font>It should only be used
by programs which have control <font color="#FF0000"><b>of </b></font>the HMA<font color="#000080">.  </font>The A20 line should be turned
off via <font color="#FF0000"><b>Function </b></font><font color="#800000">04</font>h <font color="#000080">(</font>Global Disable A20<font color="#000080">) </font>before a <font color="#FF0000"><b>program </b></font>releases control
<font color="#FF0000"><b>of </b></font>the system<font color="#000080">.

    </font>NOTE<font color="#000080">: </font><font color="#FF0000"><b>On </b></font>many machines<font color="#000080">, </font>toggling the A20 line <font color="#FF0000"><b>is </b></font>a relatively slow
          operation<font color="#000080">.


</font>Global Disable A20 <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">04</font>h<font color="#000080">):
----------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">04</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>disabled<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font><font color="#800000">82</font>h <font color="#FF0000"><b>if </b></font>an A20 error occurs
            BL <font color="#000080">= </font><font color="#800000">94</font>h <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>still enabled
    
    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>disable the A20 line<font color="#000080">.  </font>It should only be used
by programs which have control <font color="#FF0000"><b>of </b></font>the HMA<font color="#000080">.  </font>The A20 line should be disabled
before a <font color="#FF0000"><b>program </b></font>releases control <font color="#FF0000"><b>of </b></font>the system<font color="#000080">.

    </font>NOTE<font color="#000080">: </font><font color="#FF0000"><b>On </b></font>many machines<font color="#000080">, </font>toggling the A20 line <font color="#FF0000"><b>is </b></font>a relatively slow
          operation<font color="#000080">.


</font>Local Enable A20 <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">05</font>h<font color="#000080">):
--------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">05</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>enabled<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font><font color="#800000">82</font>h <font color="#FF0000"><b>if </b></font>an A20 error occurs

    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>enable the A20 line<font color="#000080">.  </font>It should only be used
by programs which need direct access <font color="#FF0000"><b>to </b></font>extended memory<font color="#000080">.  </font>Programs which use
this <font color="#FF0000"><b>function </b></font>should call <font color="#FF0000"><b>Function </b></font><font color="#800000">06</font>h <font color="#000080">(</font>Local Disable A20<font color="#000080">) </font>before releasing
control <font color="#FF0000"><b>of </b></font>the system<font color="#000080">.

    </font>NOTE<font color="#000080">: </font><font color="#FF0000"><b>On </b></font>many machines<font color="#000080">, </font>toggling the A20 line <font color="#FF0000"><b>is </b></font>a relatively slow
          operation<font color="#000080">.


</font>Local Disable A20 <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">06</font>h<font color="#000080">):
---------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">06</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function </b></font>succeeds<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font><font color="#800000">82</font>h <font color="#FF0000"><b>if </b></font>an A20 error occurs
            BL <font color="#000080">= </font><font color="#800000">94</font>h <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>still enabled

    This <font color="#FF0000"><b>function </b></font>cancels a previous call <font color="#FF0000"><b>to Function </b></font><font color="#800000">05</font>h <font color="#000080">(</font>Local Enable
A20<font color="#000080">).  </font>It should only be used by programs which need direct access <font color="#FF0000"><b>to
</b></font>extended memory<font color="#000080">.  </font>Previous calls <font color="#FF0000"><b>to Function </b></font><font color="#800000">05</font>h must be canceled before
releasing control <font color="#FF0000"><b>of </b></font>the system<font color="#000080">.

    </font>NOTE<font color="#000080">: </font><font color="#FF0000"><b>On </b></font>many machines<font color="#000080">, </font>toggling the A20 line <font color="#FF0000"><b>is </b></font>a relatively slow
          operation<font color="#000080">.


</font>Query A20 <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">07</font>h<font color="#000080">):
-------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">07</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>physically enabled<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">00</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function </b></font>succeeds
            BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected

    This <font color="#FF0000"><b>function </b></font>checks <font color="#FF0000"><b>to </b></font>see <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>physically enabled<font color="#000080">.  </font>It
does this <font color="#FF0000"><b>in </b></font>a hardware independent manner by seeing <font color="#FF0000"><b>if </b></font><font color="#000080">&quot;</font>memory wrap<font color="#000080">&quot; </font>occurs<font color="#000080">.


</font>Query Free Extended Memory <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">08</font>h<font color="#000080">):
------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">08</font>h
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font>Size <font color="#FF0000"><b>of </b></font>the largest free extended memory block <font color="#FF0000"><b>in </b></font>K<font color="#000080">-</font>bytes
            DX <font color="#000080">= </font>Total amount <font color="#FF0000"><b>of </b></font>free extended memory <font color="#FF0000"><b>in </b></font>K<font color="#000080">-</font>bytes
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font>A0h <font color="#FF0000"><b>if </b></font>all extended memory <font color="#FF0000"><b>is </b></font>allocated

    This <font color="#FF0000"><b>function </b></font>returns the size <font color="#FF0000"><b>of </b></font>the largest available extended memory
block <font color="#FF0000"><b>in </b></font>the system<font color="#000080">.

    </font>NOTE<font color="#000080">: </font>The <font color="#800000">64</font>K HMA <font color="#FF0000"><b>is not </b></font>included <font color="#FF0000"><b>in </b></font>the returned value even <font color="#FF0000"><b>if </b></font>it <font color="#FF0000"><b>is
          not in </b></font>use<font color="#000080">.


</font>Allocate Extended Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">09</font>h<font color="#000080">):
----------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">09</font>h
            DX <font color="#000080">= </font>Amount <font color="#FF0000"><b>of </b></font>extended memory being requested <font color="#FF0000"><b>in </b></font>K<font color="#000080">-</font>bytes
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>allocated<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
            DX <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">-</font>bit handle <font color="#FF0000"><b>to </b></font>the allocated block
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font>A0h <font color="#FF0000"><b>if </b></font>all available extended memory <font color="#FF0000"><b>is </b></font>allocated
            BL <font color="#000080">= </font>A1h <font color="#FF0000"><b>if </b></font>all available extended memory handles are <font color="#FF0000"><b>in </b></font>use
            
    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>allocate a block <font color="#FF0000"><b>of </b></font>the given size <font color="#FF0000"><b>out of </b></font>the
pool <font color="#FF0000"><b>of </b></font>free extended memory<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>a block <font color="#FF0000"><b>is </b></font>available<font color="#000080">, </font>it <font color="#FF0000"><b>is </b></font>reserved
<font color="#FF0000"><b>for </b></font>the caller <font color="#FF0000"><b>and </b></font>a <font color="#800000">16</font><font color="#000080">-</font>bit handle <font color="#FF0000"><b>to </b></font>that block <font color="#FF0000"><b>is </b></font>returned<font color="#000080">.  </font>The handle
should be used <font color="#FF0000"><b>in </b></font>all subsequent extended memory calls<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>no memory was
allocated<font color="#000080">, </font>the returned handle <font color="#FF0000"><b>is </b></font>null<font color="#000080">.

    </font>NOTE<font color="#000080">: </font>Extended memory handles are scarce resources<font color="#000080">.  </font>Programs should
          <font color="#FF0000"><b>try to </b></font>allocate <font color="#FF0000"><b>as </b></font>few <font color="#FF0000"><b>as </b></font>possible at any one time<font color="#000080">.  </font>When all
          <font color="#FF0000"><b>of </b></font>a driver<font color="#800000">'s handles are in use, any free extended memory is
          </font>unavailable<font color="#000080">.



</font>Free Extended Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">0</font>Ah<font color="#000080">):
------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">0</font>Ah
            DX <font color="#000080">= </font>Handle <font color="#FF0000"><b>to </b></font>the allocated block which should be freed
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>successfully freed<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font>A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>ABh <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>locked

    This <font color="#FF0000"><b>function </b></font>frees a block <font color="#FF0000"><b>of </b></font>extended memory which was previously
allocated using <font color="#FF0000"><b>Function </b></font><font color="#800000">09</font>h <font color="#000080">(</font>Allocate Extended Memory Block<font color="#000080">).  </font>Programs
which allocate extended memory should free their memory blocks before
exiting<font color="#000080">.  </font>When an extended memory buffer <font color="#FF0000"><b>is </b></font>freed<font color="#000080">, </font>its handle <font color="#FF0000"><b>and </b></font>all data
stored <font color="#FF0000"><b>in </b></font>it become invalid <font color="#FF0000"><b>and </b></font>should <font color="#FF0000"><b>not </b></font>be accessed<font color="#000080">.


</font>Move Extended Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">0</font>Bh<font color="#000080">):
------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">0</font>Bh
            DS<font color="#000080">:</font>SI <font color="#000080">= </font>Pointer <font color="#FF0000"><b>to </b></font>an Extended Memory Move Structure <font color="#000080">(</font>see below<font color="#000080">)
    </font>RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the move <font color="#FF0000"><b>is </b></font>successful<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font><font color="#800000">82</font>h <font color="#FF0000"><b>if </b></font>an A20 error occurs
            BL <font color="#000080">= </font>A3h <font color="#FF0000"><b>if </b></font>the SourceHandle <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>A4h <font color="#FF0000"><b>if </b></font>the SourceOffset <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>A5h <font color="#FF0000"><b>if </b></font>the DestHandle <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>A6h <font color="#FF0000"><b>if </b></font>the DestOffset <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>A7h <font color="#FF0000"><b>if </b></font>the Length <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>A8h <font color="#FF0000"><b>if </b></font>the move has an invalid overlap
            BL <font color="#000080">= </font>A9h <font color="#FF0000"><b>if </b></font>a parity error occurs

    Extended Memory Move Structure Definition<font color="#000080">:

        </font>ExtMemMoveStruct    struc
            Length              dd  <font color="#000080">?   ; </font><font color="#800000">32</font><font color="#000080">-</font>bit number <font color="#FF0000"><b>of </b></font>bytes <font color="#FF0000"><b>to </b></font>transfer
            SourceHandle        dw  <font color="#000080">?   ; </font>Handle <font color="#FF0000"><b>of </b></font>source block
            SourceOffset        dd  <font color="#000080">?   ; </font><font color="#800000">32</font><font color="#000080">-</font>bit offset into source 
            DestHandle          dw  <font color="#000080">?   ; </font>Handle <font color="#FF0000"><b>of </b></font>destination block
            DestOffset          dd  <font color="#000080">?   ; </font><font color="#800000">32</font><font color="#000080">-</font>bit offset into destination block
        ExtMemMoveStruct    ends
            
    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>transfer a block <font color="#FF0000"><b>of </b></font>data from one location <font color="#FF0000"><b>to
</b></font>another<font color="#000080">.  </font>It <font color="#FF0000"><b>is </b></font>primarily intended <font color="#FF0000"><b>for </b></font>moving blocks <font color="#FF0000"><b>of </b></font>data between
conventional memory <font color="#FF0000"><b>and </b></font>extended memory<font color="#000080">, </font>however it can be used <font color="#FF0000"><b>for </b></font>moving
blocks within conventional memory <font color="#FF0000"><b>and </b></font>within extended memory<font color="#000080">.

    </font>NOTE<font color="#000080">: </font><font color="#FF0000"><b>If </b></font>SourceHandle <font color="#FF0000"><b>is set to </b></font><font color="#800000">0000</font>h<font color="#000080">, </font>the SourceOffset <font color="#FF0000"><b>is </b></font>interpreted
          <font color="#FF0000"><b>as </b></font>a standard segment<font color="#000080">:</font>offset pair which refers <font color="#FF0000"><b>to </b></font>memory that <font color="#FF0000"><b>is
          </b></font>directly accessible by the processor<font color="#000080">.  </font>The segment<font color="#000080">:</font>offset pair
          <font color="#FF0000"><b>is </b></font>stored <font color="#FF0000"><b>in </b></font>Intel DWORD notation<font color="#000080">.  </font>The same <font color="#FF0000"><b>is </b></font>true <font color="#FF0000"><b>for </b></font>DestHandle
          <font color="#FF0000"><b>and </b></font>DestOffset<font color="#000080">.
          
          </font>SourceHandle <font color="#FF0000"><b>and </b></font>DestHandle <font color="#FF0000"><b>do not </b></font>have <font color="#FF0000"><b>to </b></font>refer <font color="#FF0000"><b>to </b></font>locked memory
          blocks<font color="#000080">.
          
          </font>Length must be even<font color="#000080">.  </font>Although <font color="#FF0000"><b>not </b></font>required<font color="#000080">, </font>WORD<font color="#000080">-</font>aligned moves
          can be significantly faster <font color="#FF0000"><b>on </b></font>most machines<font color="#000080">.  </font>DWORD aligned move
          can be even faster <font color="#FF0000"><b>on </b></font><font color="#800000">80386 </font>machines<font color="#000080">.
          
          </font><font color="#FF0000"><b>If </b></font>the source <font color="#FF0000"><b>and </b></font>destination blocks overlap<font color="#000080">, </font>only <font color="#FF0000"><b>forward </b></font>moves
          <font color="#000080">(</font>i<font color="#000080">.</font>e<font color="#000080">. </font>where the source base <font color="#FF0000"><b>is </b></font>less than the destination base<font color="#000080">) </font>are
          guaranteed <font color="#FF0000"><b>to </b></font>work properly<font color="#000080">.
          
          </font>Programs should <font color="#FF0000"><b>not </b></font>enable the A20 line before calling this
          <font color="#FF0000"><b>function</b></font><font color="#000080">.  </font>The state <font color="#FF0000"><b>of </b></font>the A20 line <font color="#FF0000"><b>is </b></font>preserved<font color="#000080">.

          </font>This <font color="#FF0000"><b>function is </b></font>guaranteed <font color="#FF0000"><b>to </b></font>provide a reasonable number <font color="#FF0000"><b>of
          </b></font>interrupt windows during long transfers<font color="#000080">.
          
          
</font>Lock Extended Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">0</font>Ch<font color="#000080">):
------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">0</font>Ch
            DX <font color="#000080">= </font>Extended memory block handle <font color="#FF0000"><b>to </b></font>lock
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>locked<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
            DX<font color="#000080">:</font>BX <font color="#000080">= </font><font color="#800000">32</font><font color="#000080">-</font>bit physical address <font color="#FF0000"><b>of </b></font>the locked block
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font>A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>ACh <font color="#FF0000"><b>if </b></font>the block<font color="#800000">'s lock count overflows
            </font>BL <font color="#000080">= </font>ADh <font color="#FF0000"><b>if </b></font>the lock fails
            
    This <font color="#FF0000"><b>function </b></font>locks an extended memory block <font color="#FF0000"><b>and </b></font>returns its base 
address <font color="#FF0000"><b>as </b></font>a <font color="#800000">32</font><font color="#000080">-</font>bit physical address<font color="#000080">.  </font>Locked memory blocks are guaranteed <font color="#FF0000"><b>not
to </b></font>move<font color="#000080">.  </font>The <font color="#800000">32</font><font color="#000080">-</font>bit pointer <font color="#FF0000"><b>is </b></font>only valid <font color="#FF0000"><b>while </b></font>the block <font color="#FF0000"><b>is </b></font>locked<font color="#000080">.
</font>Locked blocks should be unlocked <font color="#FF0000"><b>as </b></font>soon <font color="#FF0000"><b>as </b></font>possible<font color="#000080">.

    </font>NOTE<font color="#000080">: </font>A block does <font color="#FF0000"><b>not </b></font>have <font color="#FF0000"><b>to </b></font>be locked before using <font color="#FF0000"><b>Function </b></font><font color="#800000">0</font>Bh <font color="#000080">(</font>Move
          Extended Memory Block<font color="#000080">).
          
          &quot;</font>Lock counts<font color="#000080">&quot; </font>are maintained <font color="#FF0000"><b>for </b></font>EMBs<font color="#000080">.



</font>Unlock Extended Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">0</font>Dh<font color="#000080">):
--------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">0</font>Dh
            DX <font color="#000080">= </font>Extended memory block handle <font color="#FF0000"><b>to </b></font>unlock
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>unlocked<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font>A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>AAh <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is not </b></font>locked
    
    This <font color="#FF0000"><b>function </b></font>unlocks a locked extended memory block<font color="#000080">.  </font>Any <font color="#800000">32</font><font color="#000080">-</font>bit
pointers into the block become invalid <font color="#FF0000"><b>and </b></font>should no longer be used<font color="#000080">.


</font>Get EMB Handle Information <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">0E</font>h<font color="#000080">):
------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">0E</font>h
            DX <font color="#000080">= </font>Extended memory block handle
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the block<font color="#800000">'s information is found, 0000h otherwise
            </font>BH <font color="#000080">= </font>The block<font color="#800000">'s lock count
            </font>BL <font color="#000080">= </font>Number <font color="#FF0000"><b>of </b></font>free EMB handles <font color="#FF0000"><b>in </b></font>the system
            DX <font color="#000080">= </font>The block<font color="#800000">'s length in K-bytes
    </font>ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font>A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid

    This <font color="#FF0000"><b>function </b></font>returns additional information about an extended memory
block <font color="#FF0000"><b>to </b></font>the caller<font color="#000080">.

    </font>NOTE<font color="#000080">: </font><font color="#FF0000"><b>To </b></font>get the block<font color="#800000">'s base address, use Function 0Ch (Lock Extended
          </font>Memory Block<font color="#000080">).
          
          
</font>Reallocate Extended Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">0</font>Fh<font color="#000080">):
------------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">0</font>Fh
            BX <font color="#000080">= </font>New size <font color="#FF0000"><b>for </b></font>the extended memory block <font color="#FF0000"><b>in </b></font>K<font color="#000080">-</font>bytes
            DX <font color="#000080">= </font>Unlocked extended memory block handle <font color="#FF0000"><b>to </b></font>reallocate
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>reallocated<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
            BL <font color="#000080">= </font>A0h <font color="#FF0000"><b>if </b></font>all available extended memory <font color="#FF0000"><b>is </b></font>allocated
            BL <font color="#000080">= </font>A1h <font color="#FF0000"><b>if </b></font>all available extended memory handles are <font color="#FF0000"><b>in </b></font>use
            BL <font color="#000080">= </font>A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid
            BL <font color="#000080">= </font>ABh <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>locked

    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>reallocate an unlocked extended memory block
so that it becomes the newly specified size<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the new size <font color="#FF0000"><b>is </b></font>smaller
than the old block<font color="#800000">'s size, all data at the upper end of the old block is
</font>lost<font color="#000080">.


</font>Request Upper Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">10</font>h<font color="#000080">):
------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">10</font>h
            DX <font color="#000080">= </font>Size <font color="#FF0000"><b>of </b></font>requested memory block <font color="#FF0000"><b>in </b></font>paragraphs
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the request <font color="#FF0000"><b>is </b></font>granted<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
            BX <font color="#000080">= </font>Segment number <font color="#FF0000"><b>of </b></font>the upper memory block
            <font color="#FF0000"><b>If </b></font>the request <font color="#FF0000"><b>is </b></font>granted<font color="#000080">,
                </font>DX <font color="#000080">= </font>Actual size <font color="#FF0000"><b>of </b></font>the allocated block <font color="#FF0000"><b>in </b></font>paragraphs
            otherwise<font color="#000080">,
                </font>DX <font color="#000080">= </font>Size <font color="#FF0000"><b>of </b></font>the largest available UMB <font color="#FF0000"><b>in </b></font>paragraphs
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font>B0h <font color="#FF0000"><b>if </b></font>a smaller UMB <font color="#FF0000"><b>is </b></font>available
            BL <font color="#000080">= </font>B1h <font color="#FF0000"><b>if </b></font>no UMBs are available

    This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>allocate an upper memory block <font color="#FF0000"><b>to </b></font>the caller<font color="#000080">.
</font><font color="#FF0000"><b>If </b></font>the <font color="#FF0000"><b>function </b></font>fails<font color="#000080">, </font>the size <font color="#FF0000"><b>of </b></font>the largest free UMB <font color="#FF0000"><b>is </b></font>returned <font color="#FF0000"><b>in </b></font>DX<font color="#000080">.

    </font>NOTE<font color="#000080">: </font>By definition UMBs are located below the <font color="#800000">1</font>MB address boundary<font color="#000080">.
          </font>The A20 Line does <font color="#FF0000"><b>not </b></font>need <font color="#FF0000"><b>to </b></font>be enabled before accessing an
          allocated UMB<font color="#000080">.

          </font>UMBs are paragraph aligned<font color="#000080">.

          </font><font color="#FF0000"><b>To </b></font>determine the size <font color="#FF0000"><b>of </b></font>the largest available UMB<font color="#000080">, </font>attempt <font color="#FF0000"><b>to
          </b></font>allocate one <font color="#FF0000"><b>with </b></font>a size <font color="#FF0000"><b>of </b></font>FFFFh<font color="#000080">.

          </font>UMBs are unaffected by EMS calls<font color="#000080">.


</font>Release Upper Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">11</font>h<font color="#000080">):
------------------------------------------

    </font>ARGS<font color="#000080">:   </font>AH <font color="#000080">= </font><font color="#800000">11</font>h
            DX <font color="#000080">= </font>Segment number <font color="#FF0000"><b>of </b></font>the upper memory block
    RETS<font color="#000080">:   </font>AX <font color="#000080">= </font><font color="#800000">0001</font>h <font color="#FF0000"><b>if </b></font>the block was released<font color="#000080">, </font><font color="#800000">0000</font>h otherwise
    ERRS<font color="#000080">:   </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
            BL <font color="#000080">= </font>B2h <font color="#FF0000"><b>if </b></font>the UMB segment number <font color="#FF0000"><b>is </b></font>invalid

    This <font color="#FF0000"><b>function </b></font>frees a previously allocated upper memory block<font color="#000080">.  </font>When an
UMB has been released<font color="#000080">, </font>any code <font color="#FF0000"><b>or </b></font>data stored <font color="#FF0000"><b>in </b></font>it becomes invalid <font color="#FF0000"><b>and
</b></font>should <font color="#FF0000"><b>not </b></font>be accessed<font color="#000080">.




</font>Reallocate Upper Memory Block <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">12</font>h<font color="#000080">)

        </font>ARGS<font color="#000080">:
                </font>AH <font color="#000080">= </font><font color="#800000">12</font>h
                BX <font color="#000080">= </font>New size <font color="#FF0000"><b>for </b></font>UMB <font color="#FF0000"><b>in </b></font>paragraphs
                DX <font color="#000080">= </font>Segment number <font color="#FF0000"><b>of </b></font>the UMB <font color="#FF0000"><b>to </b></font>reallocate
        RETS<font color="#000080">:
                </font>AX <font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>if </b></font>the block was reallocated<font color="#000080">, </font><font color="#800000">0 </font>otherwise
        ERRS<font color="#000080">:
                </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
                BL <font color="#000080">= </font>B0h <font color="#FF0000"><b>if </b></font>no UMB large enough <font color="#FF0000"><b>to </b></font>satisfy the request <font color="#FF0000"><b>is </b></font>available<font color="#000080">.
                        </font><font color="#FF0000"><b>In </b></font>this event<font color="#000080">, </font>DX <font color="#FF0000"><b>is </b></font>returned <font color="#FF0000"><b>with </b></font>the size <font color="#FF0000"><b>of </b></font>the largest UMB that <font color="#FF0000"><b>is                  </b></font>available<font color="#000080">.
                </font>BL <font color="#000080">= </font>B2h <font color="#FF0000"><b>if </b></font>the UMB segment number <font color="#FF0000"><b>is </b></font>invalid

This <font color="#FF0000"><b>function </b></font>attempts <font color="#FF0000"><b>to </b></font>reallocate an Upper Memory Block <font color="#FF0000"><b>to </b></font>a newly specified size<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the new size <font color="#FF0000"><b>is </b></font>smaller than the old block<font color="#800000">'s size, all data at the upper end of the block is lost.



</font>Super Extended Memory Support

These changes are intended <font color="#FF0000"><b>to </b></font>provide support <font color="#FF0000"><b>for </b></font>extended memory pools up <font color="#FF0000"><b>to </b></font><font color="#800000">4 </font>Gb <font color="#FF0000"><b>in </b></font>size<font color="#000080">.  </font>The current XMS API<font color="#000080">, </font>since it <font color="#FF0000"><b>uses </b></font><font color="#800000">16</font><font color="#000080">-</font>bit values <font color="#FF0000"><b>to </b></font>specify block sizes <font color="#FF0000"><b>in </b></font>Kb<font color="#000080">, </font><font color="#FF0000"><b>is </b></font>limited <font color="#FF0000"><b>to </b></font><font color="#800000">64 </font>Mb maximum block size<font color="#000080">.  </font>Future machines are expected <font color="#FF0000"><b>to </b></font>support memory above <font color="#800000">64 </font>MB<font color="#000080">.

</font>This support <font color="#FF0000"><b>is </b></font>implemented <font color="#FF0000"><b>in </b></font>the form <font color="#FF0000"><b>of </b></font>extensions <font color="#FF0000"><b>to </b></font>existing functions<font color="#000080">, </font>rather than entirely new entry points<font color="#000080">, </font><font color="#FF0000"><b>to </b></font>allow <font color="#FF0000"><b>for </b></font>more efficient implementations<font color="#000080">.

</font>Programs should generally use the existing functions<font color="#000080">, </font>instead <font color="#FF0000"><b>of </b></font>these extended ones<font color="#000080">, </font>unless they have an explicit need <font color="#FF0000"><b>to </b></font>deal <font color="#FF0000"><b>with </b></font>memory above <font color="#800000">64 </font>Mb<font color="#000080">.  


</font>Query Any Free Extended Memory <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">88</font>h<font color="#000080">)

        </font>Entry<font color="#000080">:
                </font>AH <font color="#000080">= </font><font color="#800000">88</font>h                        
        Exit<font color="#000080">:
                </font>EAX <font color="#000080">= </font>Size <font color="#FF0000"><b>of </b></font>largest free extended memory block <font color="#FF0000"><b>in </b></font>Kb<font color="#000080">.
                </font>BL <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>if </b></font>no error occurs<font color="#000080">, </font>otherwise it takes an error code<font color="#000080">.
                </font>ECX <font color="#000080">= </font>Highest ending address <font color="#FF0000"><b>of </b></font>any memory block<font color="#000080">.
                </font>EDX <font color="#000080">= </font>Total amount <font color="#FF0000"><b>of </b></font>free memory <font color="#FF0000"><b>in </b></font>Kb<font color="#000080">.
        </font>Errors<font color="#000080">:
                </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented<font color="#000080">.
                </font>BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected<font color="#000080">.
                </font>BL <font color="#000080">= </font>A0h <font color="#FF0000"><b>if </b></font>all extended memory <font color="#FF0000"><b>is </b></font>allocated<font color="#000080">.

</font>This <font color="#FF0000"><b>function uses </b></font><font color="#800000">32</font><font color="#000080">-</font>bit values <font color="#FF0000"><b>to </b></font>return the size <font color="#FF0000"><b>of </b></font>available memory<font color="#000080">, </font>thus allowing returns up <font color="#FF0000"><b>to </b></font><font color="#800000">4</font>GByte<font color="#000080">.  </font>Additionally<font color="#000080">, </font>it returns the highest known physical memory address<font color="#000080">, </font>that <font color="#FF0000"><b>is</b></font><font color="#000080">, </font>the physical address <font color="#FF0000"><b>of </b></font>the last byte <font color="#FF0000"><b>of </b></font>memory<font color="#000080">.  </font>There may be discontinuities <font color="#FF0000"><b>in </b></font>the memory map below this address<font color="#000080">.

</font>The memory pool reported <font color="#FF0000"><b>on is </b></font>the same <font color="#FF0000"><b>as </b></font>that reported <font color="#FF0000"><b>on </b></font>by the existing Query Free Extended Memory <font color="#FF0000"><b>function</b></font><font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the highest memory address <font color="#FF0000"><b>is not </b></font>more than <font color="#800000">64 </font>Mb<font color="#000080">, </font><font color="#FF0000"><b>then </b></font>these two functions will return the same results<font color="#000080">.

</font>Because <font color="#FF0000"><b>of </b></font>its reliance <font color="#FF0000"><b>on </b></font><font color="#800000">32</font><font color="#000080">-</font>bit registers<font color="#000080">, </font>this <font color="#FF0000"><b>function is </b></font>only available <font color="#FF0000"><b>on </b></font><font color="#800000">80386 </font><font color="#FF0000"><b>and </b></font>higher processors<font color="#000080">.  </font>XMS drivers <font color="#FF0000"><b>on </b></font><font color="#800000">80286 </font>machines should return error code <font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>this <font color="#FF0000"><b>function is </b></font>called<font color="#000080">.

</font><font color="#FF0000"><b>If </b></font>error code <font color="#800000">81</font>h <font color="#FF0000"><b>is </b></font>returned<font color="#000080">, </font>the value <font color="#FF0000"><b>in </b></font>ECX will still be valid<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>error code A0h <font color="#FF0000"><b>is </b></font>returned<font color="#000080">, </font>EAX <font color="#FF0000"><b>and </b></font>EDX will be <font color="#800000">0</font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>ECX will still be valid<font color="#000080">.


</font>Allocate Any Extended Memory <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">89</font>h<font color="#000080">)

        </font>Entry<font color="#000080">:
                </font>AH <font color="#000080">= </font><font color="#800000">89</font>h
                EDX <font color="#000080">= </font>Amount <font color="#FF0000"><b>of </b></font>extended memory requested<font color="#000080">, </font><font color="#FF0000"><b>in </b></font>Kb<font color="#000080">.
        </font>Exit<font color="#000080">:
                </font>AX <font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>allocated<font color="#000080">, </font><font color="#800000">0 </font><font color="#FF0000"><b>if not
                </b></font>DX <font color="#000080">= </font>Handle <font color="#FF0000"><b>to </b></font>allocated block<font color="#000080">.
        </font>Errors<font color="#000080">:
                </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented<font color="#000080">.
                </font>BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected<font color="#000080">.
                </font>BL <font color="#000080">= </font>A0h <font color="#FF0000"><b>if </b></font>all available extended memory <font color="#FF0000"><b>is </b></font>allocated<font color="#000080">.
                </font>BL <font color="#000080">= </font>A1h <font color="#FF0000"><b>if </b></font>all available extended memory handles are <font color="#FF0000"><b>in </b></font>use<font color="#000080">.

</font>This <font color="#FF0000"><b>function is </b></font>similar <font color="#FF0000"><b>to </b></font>the existing Allocate Extended Memory<font color="#000080">, </font><font color="#FF0000"><b>except </b></font>that it <font color="#FF0000"><b>uses </b></font>a <font color="#800000">32</font><font color="#000080">-</font>bit instead <font color="#FF0000"><b>of </b></font>a <font color="#800000">16</font><font color="#000080">-</font>bit value <font color="#FF0000"><b>to </b></font>specify the amount <font color="#FF0000"><b>of </b></font>memory requested<font color="#000080">.  </font>It allocates from the same memory <font color="#FF0000"><b>and </b></font>handle pool <font color="#FF0000"><b>as </b></font>the current <font color="#FF0000"><b>function</b></font><font color="#000080">.  </font>Since it <font color="#FF0000"><b>requires </b></font>a <font color="#800000">32</font><font color="#000080">-</font>bit <font color="#FF0000"><b>register</b></font><font color="#000080">, </font>this <font color="#FF0000"><b>function </b></font>can be supported only <font color="#FF0000"><b>on </b></font><font color="#800000">80386 </font><font color="#FF0000"><b>and </b></font>higher processors<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>XMS drivers <font color="#FF0000"><b>on </b></font><font color="#800000">80286 </font>machines should return error code <font color="#800000">80</font>h<font color="#000080">.


</font>Get Extended EMB Handle Information <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">8E</font>h<font color="#000080">)

        </font>Entry<font color="#000080">:
                </font>AH <font color="#000080">= </font><font color="#800000">8E</font>h
                DX <font color="#000080">= </font>Extended memory block handle<font color="#000080">.
        </font>Exit<font color="#000080">:
                </font>AX <font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>if </b></font>the block<font color="#800000">'s information is found, 0 if not
                </font>BH <font color="#000080">= </font>Block lock count
                CX <font color="#000080">= </font>Number <font color="#FF0000"><b>of </b></font>free EMB handles <font color="#FF0000"><b>in </b></font>the system
                EDX <font color="#000080">= </font>Block<font color="#800000">'s length in Kb.
        </font>Errors<font color="#000080">:
                </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented<font color="#000080">.
                </font>BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected<font color="#000080">.
                </font>BL <font color="#000080">= </font>A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid<font color="#000080">.

</font>This <font color="#FF0000"><b>function is </b></font>similar <font color="#FF0000"><b>to </b></font>the Get EMB Handle Information <font color="#FF0000"><b>function</b></font><font color="#000080">.  </font>Since it <font color="#FF0000"><b>uses </b></font>a <font color="#800000">32</font><font color="#000080">-</font>bit <font color="#FF0000"><b>register to </b></font>report the block size<font color="#000080">, </font>it can be used <font color="#FF0000"><b>to </b></font>get information <font color="#FF0000"><b>on </b></font>blocks larger than <font color="#800000">64 </font>Mb<font color="#000080">.  </font>It also <font color="#FF0000"><b>uses </b></font>a <font color="#800000">16</font><font color="#000080">-</font>bit instead <font color="#FF0000"><b>of </b></font><font color="#800000">8</font><font color="#000080">-</font>bit <font color="#FF0000"><b>register to </b></font>report the number <font color="#FF0000"><b>of </b></font>free handles<font color="#000080">, </font>allowing the handle pool <font color="#FF0000"><b>to </b></font>be extended beyond <font color="#800000">256 </font>entries<font color="#000080">.

</font>Because <font color="#FF0000"><b>of </b></font>its reliance <font color="#FF0000"><b>on </b></font>a <font color="#800000">32</font><font color="#000080">-</font>bit <font color="#FF0000"><b>register</b></font><font color="#000080">, </font>this <font color="#FF0000"><b>function is </b></font>available <font color="#FF0000"><b>on </b></font><font color="#800000">80386 </font><font color="#FF0000"><b>and </b></font>higher processors<font color="#000080">.  </font>XMS drivers <font color="#FF0000"><b>on </b></font><font color="#800000">80286 </font>machines should return error code <font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>this <font color="#FF0000"><b>function is </b></font>called<font color="#000080">.


</font>Reallocate Any Extended Memory <font color="#000080">(</font><font color="#FF0000"><b>Function </b></font><font color="#800000">8</font>Fh<font color="#000080">)

        </font>Entry<font color="#000080">:
                </font>AH <font color="#000080">= </font><font color="#800000">8</font>Fh
                EBX <font color="#000080">= </font>New size <font color="#FF0000"><b>for </b></font>extended memory block<font color="#000080">, </font><font color="#FF0000"><b>in </b></font>Kb<font color="#000080">.
                </font>DX <font color="#000080">= </font>Unlocked handle <font color="#FF0000"><b>for </b></font>memory block <font color="#FF0000"><b>to </b></font>be resized<font color="#000080">.
        </font>Exit<font color="#000080">:
                </font>AX <font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>reallocated<font color="#000080">, </font><font color="#800000">0 </font><font color="#FF0000"><b>if not
        </b></font>Errors<font color="#000080">:
                </font>BL <font color="#000080">= </font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented<font color="#000080">.
                </font>BL <font color="#000080">= </font><font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected<font color="#000080">.
                </font>BL <font color="#000080">= </font>A0h <font color="#FF0000"><b>if </b></font>all available extended memory <font color="#FF0000"><b>is </b></font>allocated<font color="#000080">.
                </font>BL <font color="#000080">= </font>A1h <font color="#FF0000"><b>if </b></font>all available extended memory handles are <font color="#FF0000"><b>in </b></font>use<font color="#000080">.
                </font>BL <font color="#000080">= </font>A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid<font color="#000080">.
                </font>BL <font color="#000080">= </font>ABh <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>locked<font color="#000080">.

</font>This <font color="#FF0000"><b>function is </b></font>similar <font color="#FF0000"><b>to </b></font>the existing Reallocate Extended Memory<font color="#000080">, </font><font color="#FF0000"><b>except </b></font>that it <font color="#FF0000"><b>uses </b></font>a <font color="#800000">32</font><font color="#000080">-</font>bit instead <font color="#FF0000"><b>of </b></font>a <font color="#800000">16</font><font color="#000080">-</font>bit value <font color="#FF0000"><b>to </b></font>specify the amount <font color="#FF0000"><b>of </b></font>memory requested<font color="#000080">.  </font>It allocates from the same memory <font color="#FF0000"><b>and </b></font>handle pool <font color="#FF0000"><b>as </b></font>the current <font color="#FF0000"><b>function</b></font><font color="#000080">.  </font>Since it <font color="#FF0000"><b>requires </b></font>a <font color="#800000">32</font><font color="#000080">-</font>bit <font color="#FF0000"><b>register</b></font><font color="#000080">, </font>this <font color="#FF0000"><b>function </b></font>can be supported only <font color="#FF0000"><b>on </b></font><font color="#800000">80386 </font><font color="#FF0000"><b>and </b></font>higher processors<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>XMS drivers <font color="#FF0000"><b>on </b></font><font color="#800000">80286 </font>machines should return error code <font color="#800000">80</font>h<font color="#000080">.




</font>PRIORITIZING HMA USAGE<font color="#000080">:
-----------------------

    </font><font color="#FF0000"><b>For </b></font>DOS users <font color="#FF0000"><b>to </b></font>receive the maximum benefit from the High Memory Area<font color="#000080">,
</font>programs which use the HMA must store <font color="#FF0000"><b>as </b></font>much <font color="#FF0000"><b>of </b></font>their resident code <font color="#FF0000"><b>in </b></font>it <font color="#FF0000"><b>as
is </b></font>possible<font color="#000080">.  </font>It <font color="#FF0000"><b>is </b></font>very important that developers realize that the HMA <font color="#FF0000"><b>is
</b></font>allocated <font color="#FF0000"><b>as </b></font>a single <font color="#FF0000"><b>unit</b></font><font color="#000080">. 

    </font><font color="#FF0000"><b>For </b></font>example<font color="#000080">, </font>a TSR <font color="#FF0000"><b>program </b></font>which grabs the HMA <font color="#FF0000"><b>and </b></font>puts <font color="#800000">10</font>K <font color="#FF0000"><b>of </b></font>code into
it may prevent a later TSR from putting <font color="#800000">62</font>K into the HMA<font color="#000080">.  </font>Obviously<font color="#000080">, </font>regular
DOS programs would have more memory available <font color="#FF0000"><b>to </b></font>them below the <font color="#800000">640</font>K line <font color="#FF0000"><b>if
</b></font>the <font color="#800000">62</font>K TSR was moved into the HMA instead <font color="#FF0000"><b>of </b></font>the <font color="#800000">10</font>K one<font color="#000080">.

    </font>The first method <font color="#FF0000"><b>for </b></font>dealing <font color="#FF0000"><b>with </b></font>conflicts such <font color="#FF0000"><b>as </b></font>this <font color="#FF0000"><b>is to </b></font>require 
programs which use the HMA <font color="#FF0000"><b>to </b></font>provide a command line option <font color="#FF0000"><b>for </b></font>disabling
this feature<font color="#000080">.  </font>It <font color="#FF0000"><b>is </b></font>crucial that TSRs which <font color="#FF0000"><b>do not </b></font>make full use <font color="#FF0000"><b>of </b></font>the HMA
provide such a switch <font color="#FF0000"><b>on </b></font>their own command line <font color="#000080">(</font>suggested name <font color="#000080">&quot;/</font>NOHMA<font color="#000080">&quot;).

    </font>The second method <font color="#FF0000"><b>for </b></font>optimizing HMA usage <font color="#FF0000"><b>is </b></font>through the <font color="#000080">/</font>HMAMIN<font color="#000080">=
</font>parameter <font color="#FF0000"><b>on </b></font>the XMS device driver line<font color="#000080">.  </font>The number after the parameter
<font color="#FF0000"><b>is </b></font>defined <font color="#FF0000"><b>to </b></font>be the minimum amount <font color="#FF0000"><b>of </b></font>HMA space <font color="#000080">(</font><font color="#FF0000"><b>in </b></font>K<font color="#000080">-</font>bytes<font color="#000080">) </font>used by any
driver <font color="#FF0000"><b>or </b></font>TSR<font color="#000080">.  </font><font color="#FF0000"><b>For </b></font>example<font color="#000080">, </font><font color="#FF0000"><b>if </b></font><font color="#000080">&quot;</font>DEVICE<font color="#000080">=</font>HIMEM<font color="#000080">.</font>SYS <font color="#000080">/</font>HMAMIN<font color="#000080">=</font><font color="#800000">48</font><font color="#000080">&quot; </font><font color="#FF0000"><b>is in </b></font>a
user<font color="#800000">'s CONFIG.SYS file, only programs which request at least 48K would be
</font>allowed <font color="#FF0000"><b>to </b></font>allocate the HMA<font color="#000080">.  </font>This number can be adjusted either by
installation programs <font color="#FF0000"><b>or </b></font>by the user himself<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>this parameter <font color="#FF0000"><b>is not
</b></font>specified<font color="#000080">, </font>the <font color="#FF0000"><b>default </b></font>value <font color="#FF0000"><b>of </b></font><font color="#800000">0 </font><font color="#FF0000"><b>is </b></font>used causing the HMA <font color="#FF0000"><b>to </b></font>be allocated
<font color="#FF0000"><b>on </b></font>a first come<font color="#000080">, </font>first served basis<font color="#000080">.

    </font>Note that this problem does <font color="#FF0000"><b>not </b></font>impact application programs<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the HMA
<font color="#FF0000"><b>is </b></font>available when an application <font color="#FF0000"><b>program </b></font>starts<font color="#000080">, </font>the application <font color="#FF0000"><b>is </b></font>free <font color="#FF0000"><b>to
</b></font>use <font color="#FF0000"><b>as </b></font>much <font color="#FF0000"><b>or as </b></font>little <font color="#FF0000"><b>of </b></font>the HMA <font color="#FF0000"><b>as </b></font>it wants<font color="#000080">.  </font><font color="#FF0000"><b>For </b></font>this reason<font color="#000080">,
</font>applications should pass FFFFh <font color="#FF0000"><b>in </b></font>DX when calling <font color="#FF0000"><b>Function </b></font><font color="#800000">01</font>h<font color="#000080">.



</font>HIGH MEMORY AREA RESTRICTIONS<font color="#000080">:
------------------------------

-   </font><font color="#FF0000"><b>Far </b></font>pointers <font color="#FF0000"><b>to </b></font>data located <font color="#FF0000"><b>in </b></font>the HMA cannot be passed <font color="#FF0000"><b>to </b></font>DOS<font color="#000080">.  </font>DOS
    normalizes any pointer which <font color="#FF0000"><b>is </b></font>passed into it<font color="#000080">.  </font>This will cause data
    addresses <font color="#FF0000"><b>in </b></font>the HMA <font color="#FF0000"><b>to </b></font>be invalidated<font color="#000080">.

-   </font>Disk I<font color="#000080">/</font>O directly into the HMA <font color="#000080">(</font>via DOS<font color="#000080">, </font>INT <font color="#800000">13</font>h<font color="#000080">, </font><font color="#FF0000"><b>or </b></font>otherwise<font color="#000080">) </font><font color="#FF0000"><b>is not
    </b></font>recommended<font color="#000080">.
       
-   </font>Programs<font color="#000080">, </font>especially drivers <font color="#FF0000"><b>and </b></font>TSRs<font color="#000080">, </font>which use the HMA <font color="#000080">*</font>MUST<font color="#000080">* </font>use
    <font color="#FF0000"><b>as </b></font>much <font color="#FF0000"><b>of </b></font>it <font color="#FF0000"><b>as </b></font>possible<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>a driver <font color="#FF0000"><b>or </b></font>TSR <font color="#FF0000"><b>is </b></font>unable <font color="#FF0000"><b>to </b></font>use at
    least <font color="#800000">90</font><font color="#000080">% </font><font color="#FF0000"><b>of </b></font>the available HMA <font color="#000080">(</font>typically <font color="#000080">~</font><font color="#800000">58</font>K<font color="#000080">), </font>they must provide
    a command line switch <font color="#FF0000"><b>for </b></font>overriding HMA usage<font color="#000080">.  </font>This will allow
    the user <font color="#FF0000"><b>to </b></font>configure his machine <font color="#FF0000"><b>for </b></font>optimum use <font color="#FF0000"><b>of </b></font>the HMA<font color="#000080">.
       
-   </font>Device drivers <font color="#FF0000"><b>and </b></font>TSRs cannot leave the A20 line permanently turned
    <font color="#FF0000"><b>on</b></font><font color="#000080">.  </font>Several applications rely <font color="#FF0000"><b>on </b></font><font color="#800000">1</font>MB memory wrap <font color="#FF0000"><b>and </b></font>will overwrite the
    HMA <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>left enabled potentially causing a system crash<font color="#000080">.
        
-   </font>Interrupt vectors must <font color="#FF0000"><b>not </b></font>point into the HMA<font color="#000080">.  </font>This <font color="#FF0000"><b>is </b></font>a result <font color="#FF0000"><b>of
    </b></font>the previous restriction<font color="#000080">.  </font>Note that interrupt vectors can point into
    any allocated upper memory blocks however<font color="#000080">.

</font>ERROR CODE INDEX<font color="#000080">:
-----------------

</font><font color="#FF0000"><b>If </b></font>AX<font color="#000080">=</font><font color="#800000">0000</font>h when a <font color="#FF0000"><b>function </b></font>returns <font color="#FF0000"><b>and </b></font>the high bit <font color="#FF0000"><b>of </b></font>BL <font color="#FF0000"><b>is set</b></font><font color="#000080">,

    </font>BL<font color="#000080">=</font><font color="#800000">80</font>h <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>function is not </b></font>implemented
       <font color="#800000">81</font>h <font color="#FF0000"><b>if </b></font>a VDISK device <font color="#FF0000"><b>is </b></font>detected
       <font color="#800000">82</font>h <font color="#FF0000"><b>if </b></font>an A20 error occurs
       <font color="#800000">8E</font>h <font color="#FF0000"><b>if </b></font>a general driver error occurs
       <font color="#800000">8</font>Fh <font color="#FF0000"><b>if </b></font>an unrecoverable driver error occurs
       <font color="#800000">90</font>h <font color="#FF0000"><b>if </b></font>the HMA does <font color="#FF0000"><b>not </b></font>exist
       <font color="#800000">91</font>h <font color="#FF0000"><b>if </b></font>the HMA <font color="#FF0000"><b>is </b></font>already <font color="#FF0000"><b>in </b></font>use
       <font color="#800000">92</font>h <font color="#FF0000"><b>if </b></font>DX <font color="#FF0000"><b>is </b></font>less than the <font color="#000080">/</font>HMAMIN<font color="#000080">= </font>parameter
       <font color="#800000">93</font>h <font color="#FF0000"><b>if </b></font>the HMA <font color="#FF0000"><b>is not </b></font>allocated
       <font color="#800000">94</font>h <font color="#FF0000"><b>if </b></font>the A20 line <font color="#FF0000"><b>is </b></font>still enabled
       A0h <font color="#FF0000"><b>if </b></font>all extended memory <font color="#FF0000"><b>is </b></font>allocated
       A1h <font color="#FF0000"><b>if </b></font>all available extended memory handles are <font color="#FF0000"><b>in </b></font>use
       A2h <font color="#FF0000"><b>if </b></font>the handle <font color="#FF0000"><b>is </b></font>invalid
       A3h <font color="#FF0000"><b>if </b></font>the SourceHandle <font color="#FF0000"><b>is </b></font>invalid
       A4h <font color="#FF0000"><b>if </b></font>the SourceOffset <font color="#FF0000"><b>is </b></font>invalid
       A5h <font color="#FF0000"><b>if </b></font>the DestHandle <font color="#FF0000"><b>is </b></font>invalid
       A6h <font color="#FF0000"><b>if </b></font>the DestOffset <font color="#FF0000"><b>is </b></font>invalid
       A7h <font color="#FF0000"><b>if </b></font>the Length <font color="#FF0000"><b>is </b></font>invalid
       A8h <font color="#FF0000"><b>if </b></font>the move has an invalid overlap
       A9h <font color="#FF0000"><b>if </b></font>a parity error occurs
       AAh <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is not </b></font>locked
       ABh <font color="#FF0000"><b>if </b></font>the block <font color="#FF0000"><b>is </b></font>locked
       ACh <font color="#FF0000"><b>if </b></font>the block<font color="#800000">'s lock count overflows
       </font>ADh <font color="#FF0000"><b>if </b></font>the lock fails
       B0h <font color="#FF0000"><b>if </b></font>a smaller UMB <font color="#FF0000"><b>is </b></font>available
       B1h <font color="#FF0000"><b>if </b></font>no UMBs are available
       B2h <font color="#FF0000"><b>if </b></font>the UMB segment number <font color="#FF0000"><b>is </b></font>invalid


<font color="#FF0000"><b>IMPLEMENTATION </b></font>NOTES <font color="#FF0000"><b>FOR </b></font>DOS XMS DRIVERS<font color="#000080">:
-----------------------------------------

-   </font>A DOS XMS driver<font color="#800000">'s control function must begin with code similar to the
    </font>following<font color="#000080">:

</font>XMMControl  proc    <font color="#FF0000"><b>far

            </b></font>jmp     short XCControlEntry    <font color="#000080">; </font><font color="#FF0000"><b>For </b></font><font color="#000080">&quot;</font>hookability<font color="#000080">&quot;
            </font>nop                     <font color="#000080">; </font>NOTE<font color="#000080">: </font>The jump must be a short
            nop                     <font color="#000080">;  </font>jump <font color="#FF0000"><b>to </b></font>indicate the <font color="#FF0000"><b>end of
            </b></font>nop                     <font color="#000080">;  </font>any hook chainThe nop<font color="#800000">'s
                                            </font><font color="#000080">;  </font>allow a <font color="#FF0000"><b>far </b></font>jump <font color="#FF0000"><b>to </b></font>be
                                            <font color="#000080">;  </font>patched <font color="#FF0000"><b>in</b></font><font color="#000080">.
</font>XCControlEntry<font color="#000080">:


-   </font>XMS drivers must preserve all registers <font color="#FF0000"><b>except </b></font>those containing
    returned values across any <font color="#FF0000"><b>function </b></font>call<font color="#000080">.

-   </font>XMS drivers are required <font color="#FF0000"><b>to </b></font>hook INT <font color="#800000">15</font>h <font color="#FF0000"><b>and </b></font>watch <font color="#FF0000"><b>for </b></font>calls <font color="#FF0000"><b>to
    </b></font>functions <font color="#800000">87</font>h <font color="#000080">(</font>Block Move<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">88</font>h <font color="#000080">(</font>Extended Memory Available<font color="#000080">).  </font>The
    INT <font color="#800000">15</font>h Block Move <font color="#FF0000"><b>function </b></font>must be hooked so that the state <font color="#FF0000"><b>of </b></font>the A20
    line <font color="#FF0000"><b>is </b></font>preserved across the call<font color="#000080">.  </font>The INT <font color="#800000">15</font>h Extended Memory
    Available <font color="#FF0000"><b>function </b></font>must be hooked <font color="#FF0000"><b>to </b></font>return <font color="#800000">0</font>h <font color="#FF0000"><b>to </b></font>protect the HMA<font color="#000080">.

-   </font><font color="#FF0000"><b>In </b></font>order <font color="#FF0000"><b>to </b></font>maintain compatibility <font color="#FF0000"><b>with </b></font>existing device drivers<font color="#000080">, </font>DOS XMS
    drivers must <font color="#FF0000"><b>not </b></font>hook INT <font color="#800000">15</font>h <font color="#FF0000"><b>until </b></font>the first non<font color="#000080">-</font>Version Number call
    <font color="#FF0000"><b>to </b></font>the control <font color="#FF0000"><b>function is </b></font>made<font color="#000080">.

-   </font>XMS drivers are required <font color="#FF0000"><b>to </b></font>check <font color="#FF0000"><b>for </b></font>the presence <font color="#FF0000"><b>of </b></font>drivers which
    use the IBM VDISK allocation scheme<font color="#000080">.  </font>Note that it <font color="#FF0000"><b>is not </b></font>sufficient <font color="#FF0000"><b>to
    </b></font>check <font color="#FF0000"><b>for </b></font>VDISK users at installation time but at the time when the HMA
    <font color="#FF0000"><b>is </b></font>first allocated<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>a VDISK user <font color="#FF0000"><b>is </b></font>detected<font color="#000080">, </font>the HMA must <font color="#FF0000"><b>not </b></font>be
    allocated<font color="#000080">.  </font>Microsoft will publish a standard method <font color="#FF0000"><b>for </b></font>detecting
    drivers which use the VDISK allocation scheme<font color="#000080">.

-   </font>XMS drivers which have a fixed number <font color="#FF0000"><b>of </b></font>extended memory handles <font color="#000080">(</font>most
    <font color="#FF0000"><b>do</b></font><font color="#000080">) </font>should implement a command line parameter <font color="#FF0000"><b>for </b></font>adjusting that number
    <font color="#000080">(</font>suggested name <font color="#000080">&quot;/</font>NUMHANDLES<font color="#000080">=&quot;)

-   </font>XMS drivers should make sure that the major DOS version number <font color="#FF0000"><b>is
    </b></font>greater than <font color="#FF0000"><b>or </b></font>equal <font color="#FF0000"><b>to </b></font><font color="#800000">3 </font>before installing themselves<font color="#000080">.

-   </font>UMBs cannot occupy memory addresses that can be banked by EMS <font color="#800000">4.0.
    </font>EMS <font color="#800000">4.0 </font>takes precedence over UMBs <font color="#FF0000"><b>for </b></font>physically addressable memory<font color="#000080">.

-   </font>All driver functions must be re<font color="#000080">-</font>entrant<font color="#000080">.  </font>Care should be taken <font color="#FF0000"><b>to not
    </b></font>leave interrupts disabled <font color="#FF0000"><b>for </b></font>long periods <font color="#FF0000"><b>of </b></font>time<font color="#000080">.

-   </font>Allocation <font color="#FF0000"><b>of </b></font>a zero length extended memory buffer <font color="#FF0000"><b>is </b></font>allowed<font color="#000080">.  </font>Programs
    which hook XMS drivers may need <font color="#FF0000"><b>to </b></font>reserve a handle <font color="#FF0000"><b>for private </b></font>use via
    this method<font color="#000080">.  </font>Programs which hook an XMS driver should pass all requests
    <font color="#FF0000"><b>for </b></font>zero length EMBs <font color="#FF0000"><b>to </b></font>the next driver <font color="#FF0000"><b>in </b></font>the chain<font color="#000080">.

-   </font>Drivers should control the A20 line via an <font color="#000080">&quot;</font>enable count<font color="#000080">.&quot;  </font>Local En<font color="#000080">-
    </font>able only enables the A20 line <font color="#FF0000"><b>if </b></font>the count <font color="#FF0000"><b>is </b></font>zero<font color="#000080">.  </font>It <font color="#FF0000"><b>then </b></font>increments
    the count<font color="#000080">.  </font>Local Disable only disables A20 <font color="#FF0000"><b>if </b></font>the count <font color="#FF0000"><b>is </b></font>one<font color="#000080">.  </font>It
    <font color="#FF0000"><b>then </b></font>decrements the count<font color="#000080">.  </font>Global Enable<font color="#000080">/</font>Disable keeps a flag which
    indicates the state <font color="#FF0000"><b>of </b></font>A20<font color="#000080">.  </font>They use Local Enable<font color="#000080">/</font>Disable <font color="#FF0000"><b>to </b></font>actually
    change the state<font color="#000080">.

-  </font>Drivers should always check the physical A20 state <font color="#FF0000"><b>in </b></font>the local Enable<font color="#000080">-</font>Disable calls<font color="#000080">, </font><font color="#FF0000"><b>to </b></font>see
    that the physical state matches the internal count<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>the physical state does <font color="#FF0000"><b>not </b></font>match<font color="#000080">, </font>it should
    be modified so that it matches the internal count<font color="#000080">.  </font>This avoids problems <font color="#FF0000"><b>with </b></font>applications that 
    modify A20 directly<font color="#000080">.


</font><font color="#FF0000"><b>IMPLEMENTATION OF </b></font>CODE <font color="#FF0000"><b>FOR </b></font>HOOKING THE XMS DRIVER<font color="#000080">:

  </font><font color="#FF0000"><b>In </b></font>order <font color="#FF0000"><b>to </b></font>support the hooking <font color="#FF0000"><b>of </b></font>the XMS driver by multiple
  pieces <font color="#FF0000"><b>of </b></font>code<font color="#000080">, </font>the following code sample should be followed<font color="#000080">.
  </font>Use <font color="#FF0000"><b>of </b></font>other methods <font color="#FF0000"><b>for </b></font>hooking the XMS driver will <font color="#FF0000"><b>not </b></font>work
  <font color="#FF0000"><b>in </b></font>many cases<font color="#000080">. </font>This method <font color="#FF0000"><b>is </b></font>the official supported one<font color="#000080">.

  </font>The basic strategy <font color="#FF0000"><b>is</b></font><font color="#000080">:

    </font>Find the XMS driver header which has the <font color="#000080">&quot;</font><font color="#FF0000"><b>near </b></font>jump<font color="#000080">&quot; </font>dispatch<font color="#000080">.

    </font>Patch the <font color="#FF0000"><b>near </b></font>jump <font color="#FF0000"><b>to </b></font>a <font color="#FF0000"><b>FAR </b></font>jump which jumps <font color="#FF0000"><b>to </b></font>my HOOK XMS
        driver header<font color="#000080">.

  </font>NOTES<font color="#000080">:

    </font>o This architecture allows the most recent HOOKer <font color="#FF0000"><b>to </b></font>undo his
        XMS driver hook at any time without having <font color="#FF0000"><b>to </b></font>worry about
        damaging a <font color="#000080">&quot;</font>hook chain<font color="#000080">&quot;.

    </font>o This architecture allows the complete XMS hook chain <font color="#FF0000"><b>to </b></font>be
        enumerated at any time<font color="#000080">. </font>There are no <font color="#000080">&quot;</font>hidden hooks<font color="#000080">&quot;.

    </font>o This architecture allows the HOOKer <font color="#FF0000"><b>to not </b></font>have <font color="#FF0000"><b>to </b></font>worry
        about installing an <font color="#000080">&quot;</font>INT <font color="#800000">2</font>F hook<font color="#000080">&quot; </font><font color="#FF0000"><b>to </b></font>hook the AH<font color="#000080">=</font><font color="#800000">43</font>h
        INT <font color="#800000">2</font>Fs handled by the XMS driver<font color="#000080">. </font>The base XMS driver
        continues <font color="#FF0000"><b>to </b></font>be the only one installed <font color="#FF0000"><b>on </b></font>INT <font color="#800000">2</font>Fh AH<font color="#000080">=</font><font color="#800000">43</font>h<font color="#000080">.

        </font>This avoids all <font color="#FF0000"><b>of </b></font>the problems <font color="#FF0000"><b>of </b></font>undoing a software
        interrupt hook<font color="#000080">.

  ;
  ; </font>When I wish <font color="#FF0000"><b>to </b></font>CHAIN <font color="#FF0000"><b>to </b></font>the previous XMS driver<font color="#000080">, </font>I execute a <font color="#FF0000"><b>FAR </b></font>JMP
  <font color="#000080">;     </font><font color="#FF0000"><b>to </b></font>the address stored <font color="#FF0000"><b>in </b></font>this DWORD<font color="#000080">.
  ;
  </font>PrevXMSControlAddr    dd      <font color="#000080">?

  ;
  ; </font>The next two data items are needed ONLY <font color="#FF0000"><b>if </b></font>I desire <font color="#FF0000"><b>to </b></font>be able <font color="#FF0000"><b>to </b></font>undo
  <font color="#000080">;     </font>my XMS hook<font color="#000080">.
  ; </font>PrevXMSControlJmpVal stores the previos XMS dispatch <font color="#FF0000"><b>near </b></font>jump offset
  <font color="#000080">;     </font>value that <font color="#FF0000"><b>is </b></font>used <font color="#FF0000"><b>to </b></font>unhook my XMS hook
  <font color="#000080">; </font>PrevXMSControlBase stores the address <font color="#FF0000"><b>of </b></font>the XMS header that I hooked
  <font color="#000080">;
  </font>PrevXMSControlBase    dd      <font color="#000080">?
  </font>PrevXMSControlJmpVal  db      <font color="#000080">?

  ;
  ; </font>This <font color="#FF0000"><b>is </b></font>MY XMS control header<font color="#000080">.
  ;
  </font>MyXMSControlFunc proc <font color="#FF0000"><b>FAR
        </b></font>jmp     short XMSControlEntry
        nop
        nop
        nop
  XMSControlEntry<font color="#000080">:

  ......

  </font>Chain<font color="#000080">:
        </font>jmp     cs<font color="#000080">:[</font>PrevXMSControlAddr<font color="#000080">]

  </font>MyXMSControlFunc endp


  <font color="#000080">.......
  ;
  ; </font>This <font color="#FF0000"><b>is </b></font>the code which installs my hook into the XMS driver<font color="#000080">.
  ;
    ;
    ; </font>See <font color="#FF0000"><b>if </b></font>there <font color="#FF0000"><b>is </b></font>an XMS driver <font color="#FF0000"><b>to </b></font>hook
    <font color="#000080">;
        </font>mov     ax<font color="#000080">,</font><font color="#800000">4300</font>h
        int     <font color="#800000">2</font>Fh
        cmp     al<font color="#000080">,</font><font color="#800000">80</font>h
        jne     NoXMSDrvrToHookError
    <font color="#000080">;
    ; </font>Get the current XMS driver Control address
    <font color="#000080">;
        </font>mov     ax<font color="#000080">,</font><font color="#800000">4310</font>h
        int     <font color="#800000">2</font>Fh
  NextXMSHeader<font color="#000080">:
        </font>mov     word ptr <font color="#000080">[</font>PrevXMSControlAddr<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">],</font>es
        mov     word ptr <font color="#000080">[</font>PrevXMSControlBase<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">],</font>es
        mov     word ptr <font color="#000080">[</font>PrevXMSControlBase<font color="#000080">],</font>bx
        mov     cx<font color="#000080">,</font>word ptr es<font color="#000080">:[</font>bx<font color="#000080">]
        </font>cmp     cl<font color="#000080">,</font><font color="#800000">0E</font>Bh                         <font color="#000080">; </font><font color="#FF0000"><b>Near </b></font>JUMP
        je      ComputeNearJmp
        cmp     cl<font color="#000080">,</font><font color="#800000">0E</font>Ah                         <font color="#000080">; </font><font color="#FF0000"><b>Far </b></font>JUMP
        jne     XMSDrvrChainMessedUpError
  ComputeFarJmp<font color="#000080">:
        </font>mov     si<font color="#000080">,</font>word ptr es<font color="#000080">:[</font>bx<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]           ; </font>Offset <font color="#FF0000"><b>of </b></font>jump
        mov     es<font color="#000080">,</font>word ptr es<font color="#000080">:[</font>bx<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">+</font><font color="#800000">2</font><font color="#000080">]         ; </font>Seg <font color="#FF0000"><b>of </b></font>jump
        mov     bx<font color="#000080">,</font>si
        jmp     short NextXMSHeader

  ComputeNearJmp<font color="#000080">:
        </font>cmp     word ptr es<font color="#000080">:[</font>bx<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">],</font><font color="#800000">9090</font>h        <font color="#000080">; </font>Two NOPs<font color="#000080">?
        </font>jne     XMSDrvrChainMessedUpError       <font color="#000080">; </font>No
        cmp     byte ptr es<font color="#000080">:[</font>bx<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">],</font><font color="#800000">90</font>h          <font color="#000080">; </font>Total <font color="#FF0000"><b>of </b></font><font color="#800000">3 </font>NOPs<font color="#000080">?
        </font>jne     XMSDrvrChainMessedUpError       <font color="#000080">; </font>No
        mov     di<font color="#000080">,</font>bx                           <font color="#000080">; </font>Save pointer <font color="#FF0000"><b>to </b></font>header
        <font color="#FF0000"><b>xor     </b></font>ax<font color="#000080">,</font>ax
        mov     al<font color="#000080">,</font>ch                           <font color="#000080">; </font>jmp addr <font color="#FF0000"><b>of near </b></font>jump
        mov     <font color="#000080">[</font>PrevXMSControlJmpVal<font color="#000080">],</font>al
        add     ax<font color="#000080">,</font><font color="#800000">2                            </font><font color="#000080">; </font><font color="#FF0000"><b>NEAR </b></font>JMP <font color="#FF0000"><b>is </b></font><font color="#800000">2 </font>byte instruction
        add     bx<font color="#000080">,</font>ax                           <font color="#000080">; </font>Target <font color="#FF0000"><b>of </b></font>jump
        mov     word ptr <font color="#000080">[</font>PrevXMSControlAddr<font color="#000080">],</font>bx
    <font color="#000080">;
    ; </font>Now INSTALL my XMS HOOK
    <font color="#000080">;
        </font>cli                             <font color="#000080">; </font>Disable INTs <font color="#FF0000"><b>in case </b></font>someone calls
                                        <font color="#000080">;       </font>XMS at interrupt time
        mov     byte ptr es<font color="#000080">:[</font>di<font color="#000080">],</font><font color="#800000">0E</font>Ah   <font color="#000080">; </font><font color="#FF0000"><b>Far </b></font>Immed<font color="#000080">. </font>JUMP instruction
        mov     word ptr es<font color="#000080">:[</font>di<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">],</font>offset MyXMSControlFunc
        mov     word ptr es<font color="#000080">:[</font>di<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">],</font>cs
        sti
    <font color="#000080">.....

    ;
    ; </font>Deinstall my XMS hook<font color="#000080">. </font>This can be done <font color="#FF0000"><b>IF AND </b></font>ONLY <font color="#FF0000"><b>IF </b></font>my XMS header
    <font color="#000080">;   </font>still <font color="#FF0000"><b>contains </b></font>the <font color="#FF0000"><b>near </b></font>jump dispatch
    <font color="#000080">;
        </font>cmp     byte ptr <font color="#000080">[</font>MyXMSControlFunc<font color="#000080">],</font><font color="#800000">0E</font>Bh
        jne     CantDeinstallError
        mov     al<font color="#000080">,</font><font color="#800000">0E</font>Bh
        mov     ah<font color="#000080">,[</font>PrevXMSControlJmpVal<font color="#000080">]
        </font>les     bx<font color="#000080">,[</font>PrevXMSControlBase<font color="#000080">]
        </font>cli                             <font color="#000080">; </font>Disable INTs <font color="#FF0000"><b>in case </b></font>someone calls
                                        <font color="#000080">;       </font>XMS at interrupt time
        mov     word ptr es<font color="#000080">:[</font>bx<font color="#000080">],</font>ax
        mov     word ptr es<font color="#000080">:[</font>bx<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">],</font><font color="#800000">9090</font>h
        mov     byte ptr es<font color="#000080">:[</font>bx<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">],</font><font color="#800000">90</font>h
        sti
    <font color="#000080">....

</font><font color="#FF0000"><b>IMPLEMENTATION </b></font>NOTES <font color="#FF0000"><b>FOR </b></font>HIMEM<font color="#000080">.</font>SYS<font color="#000080">:
-----------------------------------

-   </font>HIMEM<font color="#000080">.</font>SYS currently supports true AT<font color="#000080">-</font>compatibles<font color="#000080">, </font><font color="#800000">386 </font>AT machines<font color="#000080">, </font>IBM
    PS<font color="#000080">/</font><font color="#800000">2</font>s<font color="#000080">, </font>AT<font color="#000080">&amp;</font>T <font color="#800000">6300 </font>Plus systems <font color="#FF0000"><b>and </b></font>Hewlett Packard Vectras<font color="#000080">.

-   </font><font color="#FF0000"><b>If </b></font>HIMEM finds that it cannot properly control the A20 line <font color="#FF0000"><b>or if </b></font>there
    <font color="#FF0000"><b>is </b></font>no extended memory available when HIMEM<font color="#000080">.</font>SYS <font color="#FF0000"><b>is </b></font>invoked<font color="#000080">, </font>the driver
    does <font color="#FF0000"><b>not </b></font>install itself<font color="#000080">.  </font>HIMEM<font color="#000080">.</font>SYS displays the <font color="#FF0000"><b>message </b></font><font color="#000080">&quot;</font>High Memory
    Area Unavailable<font color="#000080">&quot; </font>when this situation occurs<font color="#000080">.

-   </font><font color="#FF0000"><b>If </b></font>HIMEM finds that the A20 line <font color="#FF0000"><b>is </b></font>already enabled when it <font color="#FF0000"><b>is </b></font>invoked<font color="#000080">,
    </font>it will <font color="#FF0000"><b>NOT </b></font>change the A20 line<font color="#800000">'s state.  The assumption is that whoever
    </font>enabled it knew what they were doing<font color="#000080">.  </font>HIMEM<font color="#000080">.</font>SYS displays the <font color="#FF0000"><b>message </b></font><font color="#000080">&quot;</font>A20
    Line Permanently Enabled<font color="#000080">&quot; </font>when this situation occurs<font color="#000080">.

-   </font>HIMEM<font color="#000080">.</font>SYS <font color="#FF0000"><b>is </b></font>incompatible <font color="#FF0000"><b>with </b></font>IBM<font color="#800000">'s VDISK.SYS driver and other drivers
    </font>which use the VDISK scheme <font color="#FF0000"><b>for </b></font>allocating extended memory<font color="#000080">.  </font>However<font color="#000080">, 
    </font>HIMEM does attempt <font color="#FF0000"><b>to </b></font>detect these drivers <font color="#FF0000"><b>and </b></font>will <font color="#FF0000"><b>not </b></font>allocate the
    HMA <font color="#FF0000"><b>if </b></font>one <font color="#FF0000"><b>is </b></font>found<font color="#000080">.

-   </font>HIMEM<font color="#000080">.</font>SYS supports the optional <font color="#000080">&quot;/</font>HMAMIN<font color="#000080">=&quot; </font>parameter<font color="#000080">.  </font>The valid values
    are decimal numbers between <font color="#800000">0 </font><font color="#FF0000"><b>and </b></font><font color="#800000">63.

</font><font color="#000080">-   </font>By <font color="#FF0000"><b>default</b></font><font color="#000080">, </font>HIMEM<font color="#000080">.</font>SYS has <font color="#800000">32 </font>extended memory handles available <font color="#FF0000"><b>for </b></font>use<font color="#000080">.
    </font>This number may be adjusted <font color="#FF0000"><b>with </b></font>the <font color="#000080">&quot;/</font>NUMHANDLES<font color="#000080">=&quot; </font>parameter<font color="#000080">.  </font>The
    maximum value <font color="#FF0000"><b>for </b></font>this parameter <font color="#FF0000"><b>is </b></font><font color="#800000">128 </font><font color="#FF0000"><b>and </b></font>the minimum <font color="#FF0000"><b>is </b></font><font color="#800000">0.  </font>Each
    handle currently <font color="#FF0000"><b>requires </b></font><font color="#800000">6 </font>bytes <font color="#FF0000"><b>of </b></font>resident space<font color="#000080">.


</font>Copyright <font color="#000080">(</font>c<font color="#000080">) </font><font color="#800000">1988</font><font color="#000080">, </font>Microsoft Corporation


<font color="#000080">&lt;/</font>PRE<font color="#000080">&gt;
&lt;</font>P<font color="#000080">&gt;&lt;</font>P<font color="#000080">&gt;&lt;</font>A HREF<font color="#000080">=&quot;</font>index<font color="#000080">.</font>html<font color="#000080">&quot;&gt;&lt;</font>IMG SRC<font color="#000080">=&quot;</font>contents<font color="#000080">.</font>gif<font color="#000080">&quot;&gt;&lt;/</font>A<font color="#000080">&gt;
&lt;/</font>BODY<font color="#000080">&gt;
&lt;/</font>HTML<font color="#000080">&gt;</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FAQ SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0053.PAS">Original</a><b>]</b></p></body>
</html>
