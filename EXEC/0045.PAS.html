<html>
<head><title> "Heap Management Tools" by DAVID DANIEL ANDERSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0045.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
           &Eacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&raquo;
           &ordm; Heap management procedures, by Keld R. Hansen &ordm;
           &ordm;       From SWAG, in the &quot;EXEC&quot; section.       &ordm;
           &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&frac14;

EXECUTE shrinks your program's memory allocation to the smallest possible
value, runs the specified program, and then expands the memory allocation
again.  Tested with Turbo Pascal 6.0 and 7.0, and Borland Pascal 7.0.

Usage: Put HeapMan in your USES clause, and call Execute instead of Exec.

Notice: Do NOT SwapVectors, since HeapMan.Execute does it for you.

WARNING: DOS.DosExitCode will no longer be valid.
Instead, query Heapman.DosExitCode after calling HeapMan.Execute.
________________________________________________________________________*)

{$N-,E- no math support needed}
{$X- function calls may not be discarded}
{$I- disable I/O checking (trap errors by checking IOResult)}
{$S- no stack checking code [routine will fail without this directive!]}

</i></font><font color="#FF0000"><b>Unit </b></font>HeapMan<font color="#000080">;

</font><font color="#FF0000"><b>Interface

USES
  </b></font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>DosExitCode<font color="#000080">: </font>WORD<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>SetHeapManDosExitCode<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>ReallocateMemory<font color="#000080">(</font>P <font color="#000080">: </font>POINTER<font color="#000080">);
</font><font color="#FF0000"><b>FUNCTION </b></font>EXECUTE<font color="#000080">(</font>Name <font color="#000080">: </font>PathStr <font color="#000080">; </font>Tail <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">) : </font>WORD<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

PROCEDURE </b></font>SetHeapManDosExitCode<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>HeapMan<font color="#000080">.</font>DosExitCode <font color="#000080">:= </font>DOS<font color="#000080">.</font>DosExitCode<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>ReSetHeapManDosExitCode<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>HeapMan<font color="#000080">.</font>DosExitCode <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>ReallocateMemory<font color="#000080">(</font>P <font color="#000080">: </font>POINTER<font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">MOV  AX, PrefixSeg
  MOV  ES, AX
  MOV  BX, WORD PTR P+2
  CMP  WORD PTR P,0
  JE   @OK
  INC  BX

 @OK:
  SUB  BX, AX
  MOV  AH, 4Ah
  INT  21h
  JC   @X
  LES  DI, P
  MOV  WORD PTR HeapEnd,DI
  MOV  WORD PTR HeapEnd+2,ES

 @X:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>EXECUTE<font color="#000080">(</font>Name <font color="#000080">: </font>PathStr <font color="#000080">; </font>Tail <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">) : </font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
</b></font><font color="#008000"><i>{$IFDEF CPU386}
  </i></font><font color="#FF00FF">DB      66h
  PUSH    WORD PTR HeapEnd
  DB      66h
  PUSH    WORD PTR Name
  DB      66h
  PUSH    WORD PTR Tail
  DB      66h
  PUSH    WORD PTR HeapPtr
</font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF00FF">PUSH    WORD PTR HeapEnd+2
  PUSH    WORD PTR HeapEnd
  PUSH    WORD PTR Name+2
  PUSH    WORD PTR Name
  PUSH    WORD PTR Tail+2
  PUSH    WORD PTR Tail
  PUSH    WORD PTR HeapPtr+2
  PUSH    WORD PTR HeapPtr
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF00FF">CALL ResetHeapManDosExitCode;
  CALL ReallocateMemory
  CALL SwapVectors
  CALL DOS.EXEC
  CALL SwapVectors
  CALL ReallocateMemory
  CALL SetHeapManDosExitCode
  MOV  AX, DosError
  OR   AX, AX
  JNZ  @OUT
  MOV  AH, 4Dh
  INT  21h

 @OUT:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0045.PAS">Original</a><b>]</b></p></body>
</html>
