<html>
<head><title> "FIND AND EXECUTE" by GAYLE DAVIS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$S-,R-,V-,I-,N-,B-,F-}

{$IFNDEF Ver40}
  {Allow overlays}
  {$F+,O-,X+,A-}
{$ENDIF}

</i></font><font color="#FF0000"><b>UNIT </b></font>FINDEXEC<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

USES </b></font>CRT<font color="#000080">,</font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>FLUSHALLDOS<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>REBOOT<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>EXECUTE <font color="#000080">(</font>Name <font color="#000080">: </font>PathStr <font color="#000080">; </font>Tail <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">) : </font>WORD<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>RunInWindow <font color="#000080">(</font>FN<font color="#000080">, </font>Cmd <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">; </font>PAUSE <font color="#000080">: </font>BOOLEAN<font color="#000080">);

</font><font color="#FF0000"><b>IMPLEMENTATION
VAR
     </b></font>cname   <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">;
     </font>Old_29H <font color="#000080">: </font>POINTER<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>FLUSHALLDOS<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">mov   ah, 0Dh
  INT   21h
  XOR   cx, cx
@1 :
  push  cx
  INT   28h
  pop   cx
  loop  @1
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Reboot<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">CALL  FLUSHALLDOS
  MOV   ds, cx
  MOV   WORD PTR [472h], 1234h
  DEC   cx
  PUSH  cx
  PUSH  ds
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{F+}
</i></font><font color="#FF0000"><b>Procedure </b></font>Int29Handler<font color="#000080">(</font>AX<font color="#000080">, </font>BX<font color="#000080">, </font>CX<font color="#000080">, </font>DX<font color="#000080">, </font>SI<font color="#000080">, </font>DI<font color="#000080">, </font>DS<font color="#000080">, </font>ES<font color="#000080">, </font>BP <font color="#000080">: </font>Word<font color="#000080">); </font>Interrupt<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Dummy <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  Asm
    </b></font><font color="#FF00FF">Sti
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Write<font color="#000080">(</font>Char<font color="#000080">(</font>Lo<font color="#000080">(</font>Ax<font color="#000080">)));
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Cli
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}

{   EXECUTE STUFF - SHRINK HEAP AND EXECUTE LIKE EXECDOS }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ReallocateMemory <font color="#000080">(</font>P <font color="#000080">: </font>POINTER<font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">MOV  AX, PrefixSeg
  MOV  ES, AX
  MOV  BX, WORD PTR P + 2
  CMP  WORD PTR P, 0
  JE   @OK
  INC  BX

 @OK :
  SUB  BX, AX
  MOV  AH, 4Ah
  INT  21h
  JC   @X
  LES  DI, P
  MOV  WORD PTR HeapEnd, DI
  MOV  WORD PTR HeapEnd + 2, ES
 @X :
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ZAP this DEFINE if NOT 386,486}
{..$DEFINE CPU386}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>EXEC <font color="#000080">(</font>Name <font color="#000080">: </font>PathStr <font color="#000080">; </font>Tail <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">) : </font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">CALL    FLUSHALLDOS
  </font><font color="#008000"><i>{$IFDEF CPU386}
  </i></font><font color="#FF00FF">DB      66h
  PUSH    WORD PTR HeapEnd
  DB      66h
  PUSH    WORD PTR Name
  DB      66h
  PUSH    WORD PTR Tail
  DB      66h
  PUSH    WORD PTR HeapPtr
  </font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF00FF">PUSH    WORD PTR HeapEnd + 2
  PUSH    WORD PTR HeapEnd
  PUSH    WORD PTR Name + 2
  PUSH    WORD PTR Name
  PUSH    WORD PTR Tail + 2
  PUSH    WORD PTR Tail
  PUSH    WORD PTR HeapPtr + 2
  PUSH    WORD PTR HeapPtr

  </font><font color="#008000"><i>{$ENDIF}

  </i></font><font color="#FF00FF">CALL ReallocateMemory
  CALL SwapVectors
  CALL DOS.EXEC
  CALL SwapVectors
  CALL ReallocateMemory
  MOV  AX, DosError
  OR   AX, AX
  JNZ  @OUT
  MOV  AH, 4Dh
  INT  21h

 @OUT :

</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>EXECUTE <font color="#000080">(</font>Name <font color="#000080">: </font>PathStr <font color="#000080">; </font>Tail <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">)  : </font>WORD<font color="#000080">;
</font><font color="#FF0000"><b>VAR </b></font>W <font color="#000080">: </font>PathStr<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
 </b></font>DosError <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
 </font>W <font color="#000080">:= </font>FSEARCH <font color="#000080">(</font>Name<font color="#000080">, </font>GetEnv <font color="#000080">(</font><font color="#800000">'PATH'</font><font color="#000080">) );
 </font><font color="#FF0000"><b>IF </b></font>W <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>THEN </b></font>EXIT<font color="#000080">;
 </font>EXECUTE <font color="#000080">:= </font>EXEC<font color="#000080">(</font>W<font color="#000080">,</font>Tail<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>RunInWindow <font color="#000080">(</font>FN<font color="#000080">, </font>Cmd <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">; </font>PAUSE <font color="#000080">: </font>BOOLEAN<font color="#000080">);

</font><font color="#FF0000"><b>VAR </b></font>sa <font color="#000080">: </font>BYTE<font color="#000080">;
    </font>w  <font color="#000080">: </font>pathstr<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN

 </b></font>DosError <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
 </font>W <font color="#000080">:= </font>FSEARCH <font color="#000080">(</font>fn<font color="#000080">, </font>GetEnv <font color="#000080">(</font><font color="#800000">'PATH'</font><font color="#000080">) );
 </font><font color="#FF0000"><b>IF </b></font>W <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>THEN </b></font>EXIT<font color="#000080">;
 </font>sa       <font color="#000080">:= </font>Textattr<font color="#000080">;

 </font>GETINTVEC <font color="#000080">(</font><font color="#800000">$29</font><font color="#000080">, </font>OLD_29H<font color="#000080">);
 </font>SETINTVEC <font color="#000080">(</font><font color="#800000">$29</font><font color="#000080">, @</font>Int29Handler<font color="#000080">);         </font><font color="#008000"><i>{ Install interrupt handler }
 </i></font>WINDOW <font color="#000080">(</font>LO <font color="#000080">(</font>WindMin<font color="#000080">) + </font><font color="#800000">1</font><font color="#000080">, </font>HI <font color="#000080">(</font>WindMin<font color="#000080">) + </font><font color="#800000">1</font><font color="#000080">, </font>LO <font color="#000080">(</font>WindMax<font color="#000080">) + </font><font color="#800000">1</font><font color="#000080">, </font>HI <font color="#000080">(</font>WindMax<font color="#000080">) + </font><font color="#800000">1</font><font color="#000080">);
 </font>EXEC <font color="#000080">(</font>W<font color="#000080">, </font>Cmd <font color="#000080">);
 </font>SETINTVEC <font color="#000080">(</font><font color="#800000">$29</font><font color="#000080">, </font>OLD_29h<font color="#000080">);

 </font><font color="#FF0000"><b>IF </b></font>PAUSE <font color="#FF0000"><b>THEN
    BEGIN
    </b></font>WRITELN<font color="#000080">;
    </font>WRITELN <font color="#000080">(</font><font color="#800000">' .. Any Key Continues .. '</font><font color="#000080">);
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">Mov AX, $0C00;               </font><font color="#008000"><i>{ flush keyboard }
      </i></font><font color="#FF00FF">Int 21h;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>WHILE NOT </b></font>KEYPRESSED <font color="#FF0000"><b>DO</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">Mov AX, $0C00;
      Int 21h;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
 </font>Textattr <font color="#000080">:= </font>sa<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p></body>
</html>
