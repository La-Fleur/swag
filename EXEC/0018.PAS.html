<html>
<head><title> "Nice DOS Shell Unit" by CARL YORK</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0018.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ A bit wordy - but easy to include in an application - three &quot;hooks&quot; in }
{ the form of the first three internal procedures to customize the code. }
{ NOTE! MaxHeap must be limited to allow the EXEC procedure to function. }
{ By Carl York with code by Neil J. Rubenking and Richard S. Sandowsky.  }

</i></font><font color="#FF0000"><b>UNIT </b></font>DOSShell<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE
procedure </b></font>ShellToDOS<font color="#000080">;

</font><font color="#FF0000"><b>IMPLEMENTATION
USES </b></font>CRT<font color="#000080">, </font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>ShellToDOS<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>SmallestAllowableRam <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">;                   </font><font color="#008000"><i>{ Set   }
  </i></font>Normal               <font color="#000080">= </font><font color="#800000">7</font><font color="#000080">;                   </font><font color="#008000"><i>{ to    }
  </i></font>Reverse              <font color="#000080">= </font><font color="#800000">112</font><font color="#000080">;                 </font><font color="#008000"><i>{ your  }
  </i></font>ApplicationName      <font color="#000080">= </font><font color="#800000">'MY OWN PROGRAM'</font><font color="#000080">;    </font><font color="#008000"><i>{ specs }
</i></font><font color="#FF0000"><b>var
  </b></font>ProgramName<font color="#000080">,
  </font>CmdLineParam<font color="#000080">,
  </font>NewDirect<font color="#000080">,
  </font>HoldDirect     <font color="#000080">: </font>PathStr<font color="#000080">;
  </font>HoldAttr       <font color="#000080">: </font>byte<font color="#000080">;
  </font>HoldMin<font color="#000080">,
  </font>HoldMax        <font color="#000080">: </font>word<font color="#000080">;
  </font>SlashSpot<font color="#000080">,
  </font>BlankSpot      <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#008000"><i>{+++++++++++++++++++++++++++++++}
</i></font><font color="#FF0000"><b>procedure </b></font>PrintMessage<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Clever message to make your end user feel foolish }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{-------------------------------}

{++++++++++++++++++++++}
</i></font><font color="#FF0000"><b>procedure </b></font>SwapScreenOut<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Whatever routine you want to use to    }
  { save the contents on the active screen }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------}

{++++++++++++++++++++++}
</i></font><font color="#FF0000"><b>procedure </b></font>SwapScreenIn<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Whatever routine you want to use to }
  { restore the contents on the screen  }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------}

{+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++}
</i></font><font color="#FF0000"><b>function </b></font>GetProgramToRun <font color="#000080">: </font>PathStr<font color="#000080">;
</font><font color="#008000"><i>{ Courtesy of Neil Rubenking, this code duplicates the way DOS normally }
{ searches the path for a file name typed in at the DOS level using the }
{ TP5 routines FSearch and FExpand (code published PC Magazine 1/17/89) }
</i></font><font color="#FF0000"><b>var
  </b></font>Name <font color="#000080">: </font>PathStr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Name <font color="#000080">:= </font>FSearch<font color="#000080">(</font>ProgramName <font color="#000080">+ </font><font color="#800000">'.COM'</font><font color="#000080">,</font><font color="#800000">''</font><font color="#000080">);          </font><font color="#008000"><i>{ Search    }
  </i></font><font color="#FF0000"><b>If </b></font>Name <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then                                  </b></font><font color="#008000"><i>{ the       }
    </i></font>Name <font color="#000080">:= </font>FSearch<font color="#000080">(</font>ProgramName <font color="#000080">+ </font><font color="#800000">'.EXE'</font><font color="#000080">,</font><font color="#800000">''</font><font color="#000080">);        </font><font color="#008000"><i>{ active    }
  </i></font><font color="#FF0000"><b>If </b></font>Name <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then                                  </b></font><font color="#008000"><i>{ drive/    }
    </i></font>Name <font color="#000080">:= </font>FSearch<font color="#000080">(</font>ProgramName <font color="#000080">+ </font><font color="#800000">'.BAT'</font><font color="#000080">,</font><font color="#800000">''</font><font color="#000080">);        </font><font color="#008000"><i>{ directory }
  </i></font><font color="#FF0000"><b>If </b></font>Name <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then
    </b></font>Name <font color="#000080">:= </font>FSearch<font color="#000080">(</font>ProgramName <font color="#000080">+ </font><font color="#800000">'.COM'</font><font color="#000080">,</font>GetEnv<font color="#000080">(</font><font color="#800000">'PATH'</font><font color="#000080">));
  </font><font color="#FF0000"><b>If </b></font>Name <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then                                          </b></font><font color="#008000"><i>{ Search }
    </i></font>Name <font color="#000080">:= </font>FSearch<font color="#000080">(</font>ProgramName <font color="#000080">+ </font><font color="#800000">'.EXE'</font><font color="#000080">,</font>GetEnv<font color="#000080">(</font><font color="#800000">'PATH'</font><font color="#000080">));    </font><font color="#008000"><i>{ the    }
  </i></font><font color="#FF0000"><b>If </b></font>Name <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then                                          </b></font><font color="#008000"><i>{ path   }
    </i></font>Name <font color="#000080">:= </font>FSearch<font color="#000080">(</font>ProgramName <font color="#000080">+ </font><font color="#800000">'.BAT'</font><font color="#000080">,</font>GetEnv<font color="#000080">(</font><font color="#800000">'PATH'</font><font color="#000080">));
  </font><font color="#FF0000"><b>If </b></font>Name <font color="#000080">&lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>then
    </b></font>Name <font color="#000080">:= </font>FExpand<font color="#000080">(</font>Name<font color="#000080">);
  </font>GetProgramToRun <font color="#000080">:= </font>Name<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{------------------------------------------------------------------------}

{++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++}
</i></font><font color="#FF0000"><b>function </b></font>RAMFreeInK <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#008000"><i>{ A tidy little chunk of Inline code from Rich Sandowsky }
</i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(
  </font><font color="#800000">$B8</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$48</font><font color="#000080">/           </font><font color="#008000"><i>{  mov   AX,$4800  ; set for DOS function 48h}
  </i></font><font color="#800000">$BB</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/           </font><font color="#008000"><i>{  mov   BX,$FFFF  ; try to allocate more RAM}
                         {                  ; than is possible}
  </i></font><font color="#800000">$CD</font><font color="#000080">/</font><font color="#800000">$21</font><font color="#000080">/               </font><font color="#008000"><i>{  int   $21       ; execute the DOS call}
  </i></font><font color="#800000">$B1</font><font color="#000080">/</font><font color="#800000">$06</font><font color="#000080">/               </font><font color="#008000"><i>{  mov   CL,6      ;}
  </i></font><font color="#800000">$D3</font><font color="#000080">/</font><font color="#800000">$EB</font><font color="#000080">/               </font><font color="#008000"><i>{  shr   BX,CL     ; convert to 1K blocks}
  </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$D8</font><font color="#000080">);              </font><font color="#008000"><i>{  mov   AX,BX     ; return number of 1K blocks}
                         {                  ; RAM free as function result}
{------------------------------------------------------------------------}

{++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++}
</i></font><font color="#FF0000"><b>procedure </b></font>WritePrompt<font color="#000080">;
</font><font color="#008000"><i>{ Create a DOS prompt for the user }
</i></font><font color="#FF0000"><b>begin
  </b></font>TextAttr <font color="#000080">:= </font>Normal<font color="#000080">;
  </font>Write<font color="#000080">(</font><font color="#800000">'Temporarily in DOS ('</font><font color="#000080">,</font>RAMFreeInK<font color="#000080">,</font><font color="#800000">'K available) ... Type '</font><font color="#000080">);
  </font>TextAttr <font color="#000080">:= </font>Reverse<font color="#000080">;
  </font>Write<font color="#000080">(</font><font color="#800000">'EXIT'</font><font color="#000080">);
  </font>TextAttr <font color="#000080">:= </font>Normal<font color="#000080">;
  </font>WriteLn<font color="#000080">(</font><font color="#800000">' to return to '</font><font color="#000080">,</font>ApplicationName<font color="#000080">);
  </font>Write<font color="#000080">(</font>NewDirect<font color="#000080">,</font><font color="#800000">'&gt;'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{------------------------------------------------------------------------}

{++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++}
</i></font><font color="#FF0000"><b>procedure </b></font>RunTheShell<font color="#000080">;
</font><font color="#008000"><i>{ The actual use of the EXEC procedure }
</i></font><font color="#FF0000"><b>var
  </b></font>Index <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetDir<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>NewDirect<font color="#000080">);
  </font>WritePrompt<font color="#000080">;
  </font>CmdLineParam <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font>ReadLn<font color="#000080">(</font>ProgramName<font color="#000080">);
  </font><font color="#FF0000"><b>For </b></font>Index <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>ProgramName<font color="#000080">) </font><font color="#FF0000"><b>do
    </b></font>ProgramName<font color="#000080">[</font>index<font color="#000080">] := </font>Upcase<font color="#000080">(</font>ProgramName<font color="#000080">[</font>Index<font color="#000080">]);
  </font><font color="#FF0000"><b>While </b></font>ProgramName<font color="#000080">[</font>length<font color="#000080">(</font>ProgramName<font color="#000080">)] = </font><font color="#800000">#32 </font><font color="#FF0000"><b>do
    </b></font>Dec<font color="#000080">(</font>ProgramName<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>length<font color="#000080">(</font>ProgramName<font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>ProgramName<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">#32</font><font color="#000080">) </font><font color="#FF0000"><b>do
    </b></font>Delete<font color="#000080">(</font>ProgramName<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ProgramName <font color="#000080">&lt;&gt; </font><font color="#800000">'EXIT'</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>EXEC<font color="#000080">(</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font><font color="#800000">'/C '</font><font color="#000080">+ </font>ProgramName <font color="#000080">+ </font>CmdLineParam<font color="#000080">);
      </font><font color="#008000"><i>{ Brute force to see if we need to pursue any further }
      </i></font><font color="#FF0000"><b>If </b></font>Lo<font color="#000080">(</font>DOSExitCode<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        begin
          </b></font>BlankSpot <font color="#000080">:= </font>pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">,</font>ProgramName<font color="#000080">);
          </font>SlashSpot <font color="#000080">:= </font>pos<font color="#000080">(</font><font color="#800000">'/'</font><font color="#000080">,</font>ProgramName<font color="#000080">);
          </font><font color="#FF0000"><b>If </b></font>SlashSpot <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
            If </b></font><font color="#000080">(</font>SlashSpot <font color="#000080">&lt; </font>BlankSpot<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>BlankSpot <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
              </b></font>BlankSpot <font color="#000080">:= </font>SlashSpot<font color="#000080">;
          </font><font color="#FF0000"><b>If </b></font>BlankSpot <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
            begin
              </b></font>CmdLineParam <font color="#000080">:= </font>copy<font color="#000080">(</font>ProgramName<font color="#000080">,</font>BlankSpot<font color="#000080">,</font>Length<font color="#000080">(</font>ProgramName<font color="#000080">));
              </font>ProgramName<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>Chr<font color="#000080">(</font>pred<font color="#000080">(</font>BlankSpot<font color="#000080">));
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>ProgramName <font color="#000080">:= </font>GetProgramToRun<font color="#000080">;
          </font><font color="#FF0000"><b>If </b></font>ProgramName <font color="#000080">&lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>then
            If </b></font>pos<font color="#000080">(</font><font color="#800000">'.BAT'</font><font color="#000080">,</font>ProgramName<font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
              </b></font>EXEC<font color="#000080">(</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font><font color="#800000">'/C '</font><font color="#000080">+ </font>ProgramName <font color="#000080">+ </font>CmdLineParam<font color="#000080">)
            </font><font color="#FF0000"><b>else </b></font>EXEC<font color="#000080">(</font>ProgramName<font color="#000080">,</font>CmdLineParam<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>WriteLn<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{------------------------------------------------------------------------}

{=================================}
</i></font><font color="#FF0000"><b>begin
  If </b></font>RamFreeInK <font color="#000080">&lt;= </font>SmallestAllowableRam <font color="#FF0000"><b>then
    begin
      </b></font>PrintMessage<font color="#000080">;
      </font>EXIT<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>HoldAttr <font color="#000080">:= </font>TextAttr<font color="#000080">;           </font><font color="#008000"><i>{ Grab the current video attribute }
  </i></font>GetDir<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>HoldDirect<font color="#000080">);           </font><font color="#008000"><i>{ Grab the current drive/path }
  </i></font>HoldMin <font color="#000080">:= </font>WindMin<font color="#000080">;
  </font>HoldMax <font color="#000080">:= </font>WindMax<font color="#000080">;             </font><font color="#008000"><i>{ And the current window }
  </i></font>TextAttr <font color="#000080">:= </font>Normal<font color="#000080">;
  </font>SwapScreenOut<font color="#000080">;
  </font>Window<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">80</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">);
  </font>ClrScr<font color="#000080">;
  </font>SwapVectors<font color="#000080">;
  </font><font color="#FF0000"><b>Repeat
    </b></font>RunTheShell<font color="#000080">;
  </font><font color="#FF0000"><b>Until </b></font>ProgramName <font color="#000080">= </font><font color="#800000">'EXIT'</font><font color="#000080">;
  </font>SwapVectors<font color="#000080">;                      </font><font color="#008000"><i>{ Restore all the original set up }
  </i></font>ChDir<font color="#000080">(</font>HoldDirect<font color="#000080">);
  </font>TextAttr <font color="#000080">:= </font>HoldAttr<font color="#000080">;
  </font>Window<font color="#000080">(</font>Lo<font color="#000080">(</font>HoldMin<font color="#000080">),</font>Hi<font color="#000080">(</font>HoldMin<font color="#000080">),</font>Lo<font color="#000080">(</font>HoldMax<font color="#000080">),</font>Hi<font color="#000080">(</font>HoldMax<font color="#000080">));
  </font>ClrScr<font color="#000080">;
  </font>SwapScreenIn<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0018.PAS">Original</a><b>]</b></p></body>
</html>
