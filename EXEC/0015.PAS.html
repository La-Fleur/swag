<html>
<head><title> "Self-Modifying EXE Files" by BJORN FELTEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0015.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
OK. Maybe this isn't exactly what you were asking for, but I've seen quite a
number of variations on this peeka-boo-into-the-exe-file, so I felt I just had
to write a comment to this matter.

   Using some kind of a magic constant, which is then searched for in the exe
file, probably is the most common approach to this kind of problem. But there's
really no need to do a search. You can calculate exactly where any const is (or
should be) located.

   The trick is to use a couple of simple facts:

   1/ The size of the exe header, in paragraphs, is located at byte 8 in the
header (actually it's a word made up by bytes 8 and 9 but I still haven't seen
an exe header of more than 4k, so I make it simple for myself using only the
byte).

   2/ After the exe header comes the code segment and then directly the data
segment. Thus the size of the code segment can be calculated by a simple dseg-
cseg. Still talking paragraphs.

   3/ Now we've reached the data segment in the exe file. The location in the
data segment can be found with ofs. Here we're talking bytes.

   Using these facts, here's a simple sample that let's you change a const
string to whatever paramstr(1) you supply. Hope you'll be able to pick out the
stuff you may find any need for.

   Since this code was extracted from a pretty small program I once wrote, it
uses the rather crude method to read the entire exe file into a buffer, and
then creating a new file blockwriting the entire buffer. If your program is
larger than 64k you obviously need to use some other method.
}

</i></font><font color="#FF0000"><b>program </b></font>SelfModifier<font color="#000080">;   </font><font color="#008000"><i>(* Looks for a const and alters it *)
                        (* Puts paramstr(1) into Name *)

</i></font><font color="#FF0000"><b>const
    </b></font>Name <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">= </font><font color="#800000">'Fix me up'</font><font color="#000080">;      </font><font color="#008000"><i>{get 256 bytes to play with}
</i></font><font color="#FF0000"><b>type
    </b></font>Buffer <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">$3fff</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>ExeFile <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
    </font>P       <font color="#000080">: ^</font>Buffer<font color="#000080">;
    </font>N<font color="#000080">,</font>I<font color="#000080">,</font>O   <font color="#000080">: </font>word<font color="#000080">;
    </font>NStr    <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
 begin
  </b></font>new<font color="#000080">(</font>P<font color="#000080">);                             </font><font color="#008000"><i>{get mem for our buffer}
  </i></font>assign<font color="#000080">(</font>ExeFile<font color="#000080">,</font>paramstr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">));        </font><font color="#008000"><i>{get myself}
  </i></font>reset<font color="#000080">(</font>ExeFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>blockread<font color="#000080">(</font>ExeFile<font color="#000080">,</font>P<font color="#000080">^,</font>sizeof<font color="#000080">(</font>Buffer<font color="#000080">),</font>N<font color="#000080">);
  </font>close<font color="#000080">(</font>ExeFile<font color="#000080">);                     </font><font color="#008000"><i>{got it into Buf, now close it}
  </i></font>O<font color="#000080">:=(</font>dseg<font color="#000080">-</font>cseg<font color="#000080">+</font>word<font color="#000080">(</font>P<font color="#000080">^[</font><font color="#800000">8</font><font color="#000080">])) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;   </font><font color="#008000"><i>{start of data seg in exe file}
  </i></font>writeln<font color="#000080">(</font><font color="#800000">'Name: '</font><font color="#000080">,</font>Name<font color="#000080">);
  </font>NStr <font color="#000080">:= </font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);                </font><font color="#008000"><i>{new string to put in Name}
  </i></font>inc<font color="#000080">(</font>O<font color="#000080">,</font>ofs<font color="#000080">(</font>Name<font color="#000080">));                   </font><font color="#008000"><i>{where Name is located}
  </i></font>move<font color="#000080">(</font>NStr<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">],</font>P<font color="#000080">^[</font>O<font color="#000080">],</font>length<font color="#000080">(</font>NStr<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{move string incl. length byte}
  </i></font>rewrite<font color="#000080">(</font>ExeFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);                 </font><font color="#008000"><i>{create new version}
  </i></font>blockwrite<font color="#000080">(</font>ExeFile<font color="#000080">,</font>P<font color="#000080">^,</font>N<font color="#000080">);           </font><font color="#008000"><i>{write it}
  </i></font>close<font color="#000080">(</font>ExeFile<font color="#000080">);                     </font><font color="#008000"><i>{close it...}
  </i></font>dispose<font color="#000080">(</font>P<font color="#000080">)                          </font><font color="#008000"><i>{...and release mem}
 </i></font><font color="#FF0000"><b>end
end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0015.PAS">Original</a><b>]</b></p></body>
</html>
