<html>
<head><title> "RE: Overlay Unit" by ARRON CUSIMANO</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
 BW&gt;&gt; I'm programming a very big program in Turbo Pascal 5.5, and when
 BW&gt;&gt; I compil VB--}it, I've the error Code segment too large. I can't split
 BW&gt;&gt; my amin program  VB--}units because many procedures call many others
 BW&gt;&gt; who call back the first. VB--}How can I solve that ?

 BW&gt;&gt; Sounds like you need some overlays.  Better study up on them.

 MC&gt;    Nope, overlays are about the last thing he needs to try.  The normal
 MC&gt; solution to this problem is Units.  They can always be (re)designed to
 MC&gt; do what's needed, structurally and functionally.  Overlays are a
 MC&gt; solution to a very specific set of problems in TP/BP programming, and
 MC&gt; this error isn't one of them...

 MC&gt; ... CAUTION! DO NOT LOOK AT LASER WITH REMAINING EYE!
cool tag...

anyway, overlays may not be what he needs but have this anyways guys &amp; girls.
tested in tp 6.0 &amp; 7.0


This was written by Arron Cusimano of ACT Australia.


(*&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
  Copyright (c)Arron Cusimano 1994           All Rights Reserved Worldwide.

  Conditions of use:
  1) I will not be held responisble for any adverse effects of this code.
  2) compliation of this code constitutes agreement to these conditions.
  3) have fun with it... :)

  Use of this unit :

    To use *.OVR files with a program, you must place {$O+} at the
  begining of each unit and {$F+} at the start of the program.
   Also, just after your uses clause in your program,
  a {$O unitname} statment is required for each unit.
  ( &quot;unitname&quot; is the name of unit you wish to be in the overlay )
   Make sure THIS unit is in your uses clause!
  Compile to disk (cannot run in memory).

          *****  NOTE : This unit MUST NOT be overlaid! *****

  Initial buffer size can be set by changing:  OverlayBufferSize: longint;
&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;*)
</i></font><font color="#FF0000"><b>UNIT </b></font>ovlinit <font color="#000080">;

</font><font color="#008000"><i>{ LEAVE next line alone! }
{$O-,I-,F+}

{ modify next line as you wish. }
{$R-,S-,D-,L-,G+,A+}

  </i></font><font color="#FF0000"><b>INTERFACE

USES </b></font>Dos<font color="#000080">, </font>Overlay<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>add_ovl_buffer_size<font color="#000080">(</font>extrasize<font color="#000080">: </font>longint<font color="#000080">; </font>add<font color="#000080">: </font>boolean<font color="#000080">);

  </font><font color="#FF0000"><b>IMPLEMENTATION

var
  </b></font>ovr_file_name<font color="#000080">: </font>pathstr<font color="#000080">;
  </font>OverlayBufferSize<font color="#000080">: </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>RemapMemory<font color="#000080">;
</font><font color="#008000"><i>{&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
        MOVE &quot;OVRHEAPORG&quot; &amp; &quot;OVRHEAPEND&quot; TO TOP OF MEMORY.
 &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;}
</i></font><font color="#FF0000"><b>begin
   </b></font>HeapOrg<font color="#000080">:= </font>Ptr<font color="#000080">(</font>OvrHeapOrg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">) ;
   </font>HeapPtr<font color="#000080">:= </font>HeapOrg <font color="#000080">;
   </font>FreeList<font color="#000080">:= </font>HeapOrg <font color="#000080">;
   </font>OvrHeapOrg<font color="#000080">:= </font>PrefixSeg <font color="#000080">+ </font>MemW<font color="#000080">[</font>pred<font color="#000080">(</font>PrefixSeg<font color="#000080">):</font><font color="#800000">3</font><font color="#000080">] - </font>OverlayBufferSize <font color="#FF0000"><b>div
</b></font><font color="#800000">16</font><font color="#000080">;   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>OverlayBufferSize <font color="#FF0000"><b>MOD </b></font><font color="#800000">16</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do </b></font>inc<font color="#000080">(</font>OvrHeapOrg<font color="#000080">);
   </font>OvrHeapPtr<font color="#000080">:= </font>OvrHeapOrg<font color="#000080">;
   </font>OvrHeapEnd<font color="#000080">:= </font>OvrHeapOrg <font color="#000080">+ </font>OverlayBufferSize <font color="#FF0000"><b>div </b></font><font color="#800000">16</font><font color="#000080">;
   </font>HeapEnd<font color="#000080">:= </font>Ptr<font color="#000080">(</font>OvrHeapOrg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end </b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>InitOverlays<font color="#000080">(</font>ovr_name<font color="#000080">: </font>pathstr<font color="#000080">);
 </font><font color="#008000"><i>{&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
     ACTIVATE OVERLAYS
  &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;}
</i></font><font color="#FF0000"><b>begin
        </b></font>OvrFileMode <font color="#000080">:= </font><font color="#800000">$20</font><font color="#000080">;     </font><font color="#008000"><i>{ Read-Only + Deny-write }
        </i></font>OvrInit<font color="#000080">(</font>ovr_name<font color="#000080">);
        </font><font color="#FF0000"><b>case </b></font>OvrResult <font color="#FF0000"><b>of
          </b></font>ovrNoMemory<font color="#000080">: </font>writeln<font color="#000080">(</font><font color="#800000">'Not enough memory for overlay!'#7</font><font color="#000080">);
          </font>ovrIOerror <font color="#000080">: </font>writeln<font color="#000080">(</font><font color="#800000">'Error reading overlay file!'#7</font><font color="#000080">);
          </font>ovrError   <font color="#000080">: </font>writeln<font color="#000080">(</font><font color="#800000">'OVERLAY ERROR!'#7</font><font color="#000080">);
        </font><font color="#FF0000"><b>else
         begin
           </b></font>OvrSetBuf <font color="#000080">(</font>OverlayBufferSize<font color="#000080">);
           </font>OvrSetRetry <font color="#000080">(</font>OvrGetBuf <font color="#FF0000"><b>div </b></font><font color="#800000">3</font><font color="#000080">);
           </font>EXIT<font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end </b></font><font color="#000080">; </font><font color="#008000"><i>{ case }
        </i></font>HALT<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end </b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>search_for_overlay_file<font color="#000080">;
 </font><font color="#008000"><i>{&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
         CHECK .EXE FILE DIRECTORY THEN PATH OR QUIT
  &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;}
</i></font><font color="#FF0000"><b>var
  </b></font>dir <font color="#000080">: </font>dirstr<font color="#000080">;
  </font>name<font color="#000080">: </font>namestr<font color="#000080">;
  </font>ext <font color="#000080">: </font>extstr<font color="#000080">;

</font><font color="#FF0000"><b>begin
  if </b></font>Lo <font color="#000080">(</font>DosVersion<font color="#000080">) &gt; </font><font color="#800000">2 </font><font color="#FF0000"><b>then </b></font>ovr_file_name <font color="#000080">:= </font>system<font color="#000080">.</font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)
        </font><font color="#FF0000"><b>else  </b></font><font color="#008000"><i>{ get dos version or quit }
                </i></font><font color="#FF0000"><b>begin
                  </b></font>write<font color="#000080">(</font><font color="#800000">'Yuck...dos version less than 3.0'</font><font color="#000080">+ </font><font color="#800000">#13#10#7</font><font color="#000080">);
                  </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ovr_file_name<font color="#000080">:= </font>FExpand<font color="#000080">(</font>ovr_file_name<font color="#000080">); </font><font color="#008000"><i>{ get full path name of exe file }
  </i></font>FSplit<font color="#000080">(</font>ovr_file_name<font color="#000080">, </font>Dir<font color="#000080">, </font>Name<font color="#000080">, </font>Ext<font color="#000080">) ; </font><font color="#008000"><i>{ split it up }
  </i></font>ovr_file_name<font color="#000080">:= </font>FSearch<font color="#000080">(</font>Name <font color="#000080">+ </font><font color="#800000">'.OVR'</font><font color="#000080">, </font>Dir<font color="#000080">);</font><font color="#008000"><i>{ ovr_file_name.EXE = 
ovr_file_name.OVR }
  </i></font><font color="#FF0000"><b>if </b></font>ovr_file_name <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ if not found, check PATH }
           </i></font>ovr_file_name<font color="#000080">:= </font>FSearch<font color="#000080">(</font>Name <font color="#000080">+ </font><font color="#800000">'.OVR'</font><font color="#000080">, </font>GetEnv<font color="#000080">(</font><font color="#800000">'PATH'</font><font color="#000080">)) ;
  </font><font color="#FF0000"><b>if </b></font>ovr_file_name <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ if still not found, quit }
         </i></font><font color="#FF0000"><b>begin
            </b></font>writeln<font color="#000080">(</font><font color="#800000">'Overlay not found in current directory or on PATH'#7</font><font color="#000080">);
            </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ovr_file_name <font color="#000080">:= </font>FExpand<font color="#000080">(</font>ovr_file_name<font color="#000080">) ;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>add_ovl_buffer_size<font color="#000080">(</font>extrasize<font color="#000080">: </font>longint<font color="#000080">; </font>add<font color="#000080">: </font>boolean<font color="#000080">);
</font><font color="#008000"><i>{&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
     ___,/|
     \ o_o|    Set boolean to true for addition to buffer -
     =(_|_)=
     /   |    set to false for subtraction.
    /      \
&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;}
  </i></font><font color="#FF0000"><b>begin
        case </b></font>add <font color="#FF0000"><b>of
          </b></font>true<font color="#000080">:
                </font><font color="#FF0000"><b>begin
                  </b></font>OvrSetBuf<font color="#000080">(</font>OvrGetBuf<font color="#000080">+</font>ExtraSize<font color="#000080">);
                  </font><font color="#FF0000"><b>if </b></font>OvrResult <font color="#000080">= </font>OvrError <font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>false<font color="#000080">:
                </font><font color="#FF0000"><b>begin
                  </b></font>OvrSetBuf<font color="#000080">(</font>OvrGetBuf<font color="#000080">-</font>ExtraSize<font color="#000080">);
                  </font><font color="#FF0000"><b>if </b></font>OvrResult <font color="#000080">= </font>OvrError <font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;</font><font color="#008000"><i>{case}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;</font><font color="#008000"><i>{procedure}

</i></font><font color="#FF0000"><b>BEGIN  </b></font><font color="#008000"><i>{ * INIT * }
         </i></font>OverlayBufferSize <font color="#000080">:= </font><font color="#800000">16000</font><font color="#000080">; </font><font color="#008000"><i>{ adjust as needed,
                                   if performance is sluggish make bigger }
         </i></font>Search_for_overlay_file<font color="#000080">;
         </font><font color="#FF0000"><b>if </b></font>OvrGetBuf <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
         begin
            </b></font>RemapMemory <font color="#000080">;
            </font>InitOverlays<font color="#000080">(</font>ovr_file_name<font color="#000080">) ;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.  </font><font color="#008000"><i>{ * END INIT * }
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p></body>
</html>
