<html>
<head><title> "Checking loaded files" by JOHN BALDWIN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0041.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 PJ&gt;    in PROG1.EXE i execute PROG2.EXE, ok...
 PJ&gt;
 PJ&gt;    in PROG2.EXE i want to check if PROG1.EXE is running,
 PJ&gt;    PROG2.EXE can not start without PROG1.EXE starting it...
 PJ&gt;
 PJ&gt;    sounds crazy? :)
 PJ&gt;
 PJ&gt;    i need a routine for that (please help me!)

If you understand assembly and interrupts here is what I'm doing: I'm
hooking int 96h and using it as an installation check. When it is called
with AX = to a magic number (MagicNumber below) it will return another
magic number that says that it is installed (ReturnValue) below.

Try this:

PROG1 :
}

</i></font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Const
   </b></font>MagicValue<font color="#000080">=</font><font color="#800000">$1248</font><font color="#000080">;
   </font>ReturnValue<font color="#000080">=</font><font color="#800000">$8421</font><font color="#000080">;

</font><font color="#FF0000"><b>Label
   </b></font>SaveInt96<font color="#000080">;

</font><font color="#FF0000"><b>Var
   </b></font>InstallSaveExitProc<font color="#000080">:</font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>InstallCheckIsr<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">cmp ax,MagicValue </font><font color="#008000"><i>{Is it an installation check?}
   </i></font><font color="#FF00FF">je  @@InsCheck    </font><font color="#008000"><i>{If so skip next part}
   </i></font><font color="#FF00FF">db  EAh             </font><font color="#008000"><i>{FAR JMP opcode}
</i></font><font color="#FF00FF">SaveInt96:
   db  0 
   db  0
   db  0 
   db  0             </font><font color="#008000"><i>{After program is running, this will jump to the

                         old interrupt handler} 
</i></font><font color="#FF00FF">@@InsCheck: 
   mov ax,ReturnValue  </font><font color="#008000"><i>{Return the ReturnValue in AX} 
   </i></font><font color="#FF00FF">iret                     </font><font color="#008000"><i>{Return from interrupt call}  
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
    
</font><font color="#FF0000"><b>Procedure </b></font>UnInstallCheck<font color="#000080">; 
 
</font><font color="#FF0000"><b>Begin
   </b></font>SetIntVector<font color="#000080">(</font><font color="#800000">$96</font><font color="#000080">,</font>POINTER<font color="#000080">(</font>SaveInt96<font color="#000080">)); 
   </font>ExitProc<font color="#000080">:=</font>InstallSaveExitProc<font color="#000080">; 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
    
</font><font color="#FF0000"><b>Procedure </b></font>InstallCheck<font color="#000080">;
 
</font><font color="#FF0000"><b>Begin 
   </b></font>GetIntVector<font color="#000080">(</font><font color="#800000">$96</font><font color="#000080">,</font>POINTER<font color="#000080">(</font>SaveInt96<font color="#000080">)); 
   </font>SetIntVector<font color="#000080">(</font><font color="#800000">$96</font><font color="#000080">,@</font>InstallCheckIsr<font color="#000080">); 
   </font>InstallSaveExitProc<font color="#000080">:=</font>ExitProc<font color="#000080">; 
   </font>ExitProc<font color="#000080">:=@</font>UnInstallCheck<font color="#000080">; 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;
 
</font>PROG <font color="#800000">2</font><font color="#000080">: 
 
</font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">; 
 
</font><font color="#FF0000"><b>Const 
   </b></font>MagicValue<font color="#000080">=</font><font color="#800000">$1248</font><font color="#000080">; 
   </font>ReturnValue<font color="#000080">=</font><font color="#800000">$8421</font><font color="#000080">; 
    
</font><font color="#FF0000"><b>Function </b></font>Installed<font color="#000080">:</font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">; 
 
</font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">mov ax,MagicValue    </font><font color="#008000"><i>{Check to see if PROG1 installed} 
   </i></font><font color="#FF00FF">int 96h 
   xor bl,bl                </font><font color="#008000"><i>{BL temporarily holds the return value, the 
                            &quot;xor bl,bl&quot; sets it to 0 (False)} 
   </i></font><font color="#FF00FF">cmp ax,ReturnValue   </font><font color="#008000"><i>{Is PROG1 installed?} 
   </i></font><font color="#FF00FF">jne @@Exit                 </font><font color="#008000"><i>{if not skip next instruction} 
   </i></font><font color="#FF00FF">inc bl                </font><font color="#008000"><i>{set BL to true (0=False and 1=True for Boolean)} 
</i></font><font color="#FF00FF">@@Exit: 
   mov al,bl                </font><font color="#008000"><i>{return Boolean in AL} 
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
</font>Now<font color="#000080">, </font><font color="#FF0000"><b>in program </b></font><font color="#800000">1</font><font color="#000080">, </font>call InstallCheck when you start the <font color="#FF0000"><b>program</b></font><font color="#000080">, </font>it will
clean itself up when the <font color="#FF0000"><b>program </b></font>ends<font color="#000080">.  </font>When <font color="#FF0000"><b>program </b></font><font color="#800000">2 </font>loads<font color="#000080">, </font>just have 
it call Installed<font color="#000080">, </font><font color="#FF0000"><b>if </b></font>it returns true <font color="#FF0000"><b>then Program </b></font><font color="#800000">1 </font><font color="#FF0000"><b>is </b></font>loaded<font color="#000080">.  </font><font color="#FF0000"><b>Finally</b></font><font color="#000080">, 
</font>make sure that the constants MagicValue <font color="#FF0000"><b>and </b></font>ReturnValue are the same <font color="#FF0000"><b>in 
</b></font>both programs<font color="#000080">, </font>otherwise <font color="#FF0000"><b>Program </b></font><font color="#800000">2 </font>will never think that <font color="#FF0000"><b>Program </b></font><font color="#800000">1 </font><font color="#FF0000"><b>is 
</b></font>installed<font color="#000080">.  (</font>You might consider putting them <font color="#FF0000"><b>in </b></font>a <font color="#FF0000"><b>unit to </b></font>avoid confusion<font color="#000080">. 
</font>One final note<font color="#000080">: </font>These routines are untested<font color="#000080">, </font>although they should work<font color="#000080">, 
</font>I<font color="#800000">'m not perfect.  If you can'</font>t get these <font color="#FF0000"><b>to </b></font>work<font color="#000080">, </font>let me know<font color="#000080">, </font><font color="#FF0000"><b>or if </b></font>you
want <font color="#FF0000"><b>to </b></font>know more about how they work<font color="#000080">, </font>let me know<font color="#000080">.  </font>Hope these help<font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0041.PAS">Original</a><b>]</b></p></body>
</html>
