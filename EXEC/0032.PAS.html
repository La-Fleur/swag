<html>
<head><title> "EXE File Format" by ANDREW EIGUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Could someone tell me the format of a standard EXE and an NE and how they
&gt; relate?

RTM, boy. Right from Tech Help 4.0:

               Standard EXE-format files begin with this header.

Offset Size Contents
&szlig;&szlig;&szlig;&szlig;&szlig;&szlig; &szlig;&szlig;&szlig;&szlig; &szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;
            &Uacute;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&iquest;
 +0      2  &sup3;4Dh 5aH&sup3; .EXE file signature ('MZ')
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
 +2      2  &sup3;PartPag&sup3; length of partial page at end (generally ignored)
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
 +4      2  &sup3;PageCnt&sup3; length of image in 512-byte pages, including the header
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
 +6      2  &sup3;ReloCnt&sup3; number of items in relocation table
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
 +8      2  &sup3;HdrSize&sup3; size of header in 16-byte paragraphs
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+0aH     2  &sup3;MinMem &sup3; minimum memory needed above end of program (paragraphs)
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+0cH     2  &sup3;MaxMem &sup3; maximum memory needed above end of program (paragraphs)
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+0eH     2  &sup3;ReloSS &sup3; segment offset of stack segment (for setting SS)
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+10H     2  &sup3;ExeSP  &sup3; value for SP register (stack pointer) when started
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+12H     2  &sup3;ChkSum &sup3; file checksum (negative sum of all words in file)
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+14H     2  &sup3;ExeIP  &sup3; value for IP register (instruction pointer) when started
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+16H     2  &sup3;ReloCS &sup3; segment offset of code segment (for setting CS)
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+18H     2  &sup3;TablOff&sup3; file-offset of first relocation item (often 001cH)
            &Atilde;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&acute;
+1aH     2  &sup3;Overlay&sup3; overlay number (0 for base module)
            &Agrave;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&Ugrave;
1cH         size of formatted portion of EXE header
            &Uacute;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Acirc;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Acirc; &Auml; &Auml; &Acirc;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Acirc;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&iquest; Relocation table.  Starts
+ ?     4*? &sup3;offset  segment&sup3;  &sup3;offset  segment&sup3; at file offset [EXE+18H].
            &Agrave;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&Aacute; &Auml; &Auml; &Aacute;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&Aacute;&Auml;&Auml;&Auml;&Ugrave; Has [EXE+6] DWORD entries.
+ ?     ?   filler to a paragraph boundary
+ ?     ?   start of program image
&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
 Since an EXE file may be loaded on any segment, all absolute segment
 references (such as FAR CALLs, long address pointers, and references such as
 MOV AX,data_seg) must be adjusted to work for the memory location in which
 they are loaded.  Here are the steps used by the DOS program loader (Fn 4bH )
 to load an EXE file:

 1. Create a PSP via DOS Fn 26H.

 2. Read 1cH bytes of the EXE file (the formatted portion of the EXE header)
    into a local memory area.

 3. Determine the load module size = ( (PageCnt*512)-(HdrSize*16) ) - PartPag

 4. Determine file offset of load module = (HdrSize * 16)

 5. Select a segment address, START_SEG, for loading (usually PSP + 10H)

 6. Read the load module into memory starting at START_SEG:0000

 7. LSEEK (set file pointer) to the start of the relocation table (TablOff)

 8. For each relocation item (ReloCnt):
    a. read the item as two 16-bit words (I_OFF,I_SEG)
    b. add RELO_SEG=(START_SEG+I_SEG)    (find the address of relocation ref)
    c. fetch the word at RELO_SEG:I_OFF  (read current value)
    d. add START_SEG to that word        (perform the segment fixup)
    e. store the sum back at its original address (RELO_SEG:I_OFF)

 9. Allocate memory for the program according to MaxMem and MinMem

10. Initialize registers and execute the program:
    a. ES = DS = PSP
    b. Set AX to indicate the validity of drive IDs in command line
    c. SS = START_SEG+ReloSS, SP = ExeSP
    d. CS = START_SEG+ReloCS, IP = ExeIP (use: PUSH seg; PUSH offset; RETF)

Note: Recent additions to the EXE format, specifically the CodeView, OS/2,
      and Windows versions of the EXE file contain additional information
      embedded in the executable file.

You won't happen to load a new executable with your bbs software coz new
executables work under special environments, such as: Windows, OS/2 and
other. You should use the above technique for dealing with custom loading of
EXEs by your program. Think of your own format... Well... But if you still
wish to learn the format for NE, try Borland Pascal Windows Help file,
search for 'File Formats', the format of new-executable. This topic is too
large to post here.
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p></body>
</html>
