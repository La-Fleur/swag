<html>
<head><title> "RealMode code to modify EXE." by DUNCAN MCNIVEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Most suggestions for modifying EXE files involve storing and searching
for a marker value.  This seems clumsy.  An alternative is given in
&quot;PC Techniques C/C++ Power Tools&quot; by Duntemann &amp; Weiskamp.  This
involves deducing the position in the disk file at which initialised
constants are stored, based on their address in RAM at run time.

I have produced a demo Pascal program based on these ideas.  The code
is given below.  It works fine, but only in real mode.  Can anyone see
any way to use the same approach in protected mode or, ideally, in
Windows ?
}
</i></font><font color="#FF0000"><b>program </b></font>TestMod<font color="#000080">;

</font><font color="#FF0000"><b>type  </b></font>TEXEHeader <font color="#000080">= </font><font color="#FF0000"><b>record
                     </b></font>EXEID    <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{EXE File identifier          }
                     </i></font>ByteMod  <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Load module image size mod512}
                     </i></font>Pages    <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{File size (inc hdr) div 512  }
                     </i></font>RelocCnt <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{No. of relocation table items}
                     </i></font>Size     <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Header size in 16-byte paras }
                     </i></font>MinParas <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Min. No. of paras above prog }
                     </i></font>MaxParas <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Max. No. of paras above prog }
                     </i></font>StackSeg <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Displacement of stack segment}
                     </i></font>spreg    <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Initial SP register value    }
                     </i></font>CheckSum <font color="#000080">: </font>Integer<font color="#000080">;</font><font color="#008000"><i>{Negative checksum (unused)  }
                     </i></font>ipreg    <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Initial IP register value    }
                     </i></font>CodeSeg  <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Displacement of code segment }
                     </i></font>Reloc1   <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{First relocation item        }
                     </i></font>ovln     <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{Overlay number               }
                   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>MyStr <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'Original string in EXE file'</font><font color="#000080">; 
      </font>PSPSize <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">; </font><font color="#008000"><i>{ Size of Program Segment Prefix = 16 paragraphs }
      </i></font>ParaSize <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">; </font><font color="#008000"><i>{ 1 paragraph = 16 bytes }
      </i></font>fmShareDenyWrite <font color="#000080">= </font><font color="#800000">$0020</font><font color="#000080">; </font><font color="#008000"><i>{ EXE File open mode }

</i></font><font color="#FF0000"><b>var   </b></font>EXEHdrSize  <font color="#000080">: </font>Integer<font color="#000080">;
      </font>EXEName     <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
      </font>DiskPos     <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>F           <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetEXENameAndHdrSize<font color="#000080">;
</font><font color="#FF0000"><b>var   </b></font>EXEHdr  <font color="#000080">: </font>TEXEHeader<font color="#000080">;
</font><font color="#FF0000"><b>begin </b></font>EXEName <font color="#000080">:= </font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
      </font>Assign<font color="#000080">(</font>F<font color="#000080">,</font>EXEName<font color="#000080">);
      </font>FileMode <font color="#000080">:= </font>fmShareDenyWrite<font color="#000080">;
      </font>Reset<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>BlockRead<font color="#000080">(</font>F<font color="#000080">,</font>EXEHdr<font color="#000080">,</font>SizeOf<font color="#000080">(</font>TEXEHeader<font color="#000080">));
      </font>close<font color="#000080">(</font>F<font color="#000080">);
      </font>EXEHdrSize <font color="#000080">:= </font>EXEHdr<font color="#000080">.</font>Size<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>RestoreDefaultStr<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>S <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
</font><font color="#FF0000"><b>var   </b></font>DiskPos <font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin </b></font>assign<font color="#000080">(</font>F<font color="#000080">,</font>EXEName<font color="#000080">);
      </font>FileMode <font color="#000080">:= </font>fmShareDenyWrite<font color="#000080">;
      </font>reset<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>DiskPos <font color="#000080">:=
(</font>Seg<font color="#000080">(</font>S<font color="#000080">)-(</font>PrefixSeg<font color="#000080">+</font>PSPSize<font color="#000080">)+</font>EXEHdrSize<font color="#000080">)*</font>ParaSize<font color="#000080">+</font>Ofs<font color="#000080">(</font>S<font color="#000080">);
      </font>seek<font color="#000080">(</font>F<font color="#000080">,</font>DiskPos<font color="#000080">);
      </font>blockread<font color="#000080">(</font>F<font color="#000080">,</font>S<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">],</font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{ Find size of default value for string }
      </i></font>blockread<font color="#000080">(</font>F<font color="#000080">,</font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>Integer<font color="#000080">(</font>S<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])); </font><font color="#008000"><i>{ Read the string itself }
      </i></font>close<font color="#000080">(</font>F<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetNewDefaultStr<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>S <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
</font><font color="#FF0000"><b>var   </b></font>DiskPos <font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin </b></font>assign<font color="#000080">(</font>F<font color="#000080">,</font>EXEName<font color="#000080">);
      </font>FileMode <font color="#000080">:= </font>fmShareDenyWrite<font color="#000080">;
      </font>rewrite<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>DiskPos <font color="#000080">:=
(</font>Seg<font color="#000080">(</font>S<font color="#000080">)-(</font>PrefixSeg<font color="#000080">+</font>PSPSize<font color="#000080">)+</font>EXEHdrSize<font color="#000080">)*</font>ParaSize<font color="#000080">+</font>Ofs<font color="#000080">(</font>S<font color="#000080">);
      </font>seek<font color="#000080">(</font>F<font color="#000080">,</font>DiskPos<font color="#000080">);
      </font>blockwrite<font color="#000080">(</font>F<font color="#000080">,</font>S<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">],</font>Length<font color="#000080">(</font>S<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">);
      </font>close<font color="#000080">(</font>f<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin

  </b></font>GetEXENameAndHdrSize<font color="#000080">;

  </font>writeln<font color="#000080">(</font>MyStr<font color="#000080">);            </font><font color="#008000"><i>{ Show original string value  }

  </i></font>MyStr <font color="#000080">:= </font><font color="#800000">'Changed in RAM'</font><font color="#000080">; </font><font color="#008000"><i>{ Change string so we can tell}
  </i></font>Writeln<font color="#000080">(</font>MyStr<font color="#000080">);            </font><font color="#008000"><i>{ if we read EXE file OK.     }

  </i></font>RestoreDefaultStr<font color="#000080">( </font>MyStr <font color="#000080">);</font><font color="#008000"><i>{ Read original from EXE file }
  </i></font>Writeln<font color="#000080">(</font>MyStr<font color="#000080">);

  </font>MyStr <font color="#000080">:= </font><font color="#800000">'Written to EXE'</font><font color="#000080">; </font><font color="#008000"><i>{ Change the string and       }
  </i></font>SetNewDefaultStr<font color="#000080">( </font>MyStr <font color="#000080">); </font><font color="#008000"><i>{ write new value to EXE file }

  </i></font>MyStr <font color="#000080">:= </font><font color="#800000">'Temp RAM value'</font><font color="#000080">; </font><font color="#008000"><i>{ Change again so we can test }
  </i></font>writeln<font color="#000080">(</font>MyStr<font color="#000080">);            </font><font color="#008000"><i>{ if new value read from EXE  }


  </i></font>RestoreDefaultStr<font color="#000080">( </font>MyStr <font color="#000080">);</font><font color="#008000"><i>{ Read the value we earlier   }
  </i></font>Writeln<font color="#000080">(</font>MyStr<font color="#000080">);            </font><font color="#008000"><i>{ wrote to the EXE file.      }

  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p></body>
</html>
