<html>
<head><title> "DOS Exec with full memory" by THILO WAGNER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
&gt; Can anyone post some code on swapping a TP (7.0) program out of
&gt; memory and executing a batch file (or EXE file; show both if they're
&gt; different please). Thanx.  [I can do it in assembly... :)... but
&gt; Pascal's a different story].

With this you must increase the maximum heap with {$M....}. But I found a
very good exec-Routine, which gives all the heap free before executing the
shell:
*)

</i></font><font color="#FF0000"><b>Function </b></font>DosShell<font color="#000080">(</font>command<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Integer<font color="#000080">;</font><font color="#FF0000"><b>Var
 </b></font>OldHeapEnd<font color="#000080">,
 </font>NewHeapEnd<font color="#000080">: </font>Word<font color="#000080">;
 </font>Error<font color="#000080">:</font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Begin
 </b></font>Error<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font><font color="#FF0000"><b>If </b></font>MemAvail<font color="#000080">&lt;</font><font color="#800000">$1000 </font><font color="#FF0000"><b>then </b></font>Error<font color="#000080">:=</font><font color="#800000">8</font><font color="#000080">;
 </font><font color="#FF0000"><b>If </b></font>Error<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then Begin
  </b></font>NewHeapEnd<font color="#000080">:=</font>Seg<font color="#000080">(</font>HeapPtr<font color="#000080">^)-</font>PrefixSeg<font color="#000080">;
  </font>OldHeapEnd<font color="#000080">:=</font>Seg<font color="#000080">(</font>HeapEnd<font color="#000080">^)-</font>PrefixSeg<font color="#000080">;
   </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ah,4Ah
    mov bx,NewHeapEnd
    mov es,PrefixSeg
    Int 21h
    jnc @EXIT
    mov Error,ax
    @EXIT:
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{asm}
  </i></font><font color="#FF0000"><b>If </b></font>Error<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
   </b></font>SwapVectors<font color="#000080">;
   </font>Exec<font color="#000080">(</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font>command<font color="#000080">);
   </font>SwapVectors<font color="#000080">;
    </font><font color="#FF0000"><b>asm
     </b></font><font color="#FF00FF">mov ah,4Ah
     mov bx,OldHeapEnd
     mov es,PrefixSeg
     Int 21h
     jnc @EXIT
     mov Error,ax
     @EXIT:
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{asm}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{If}
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;    </font><font color="#008000"><i>{If}
 </i></font>DosShell<font color="#000080">:=</font>Error<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;     </font><font color="#008000"><i>{Function}

</i></font><font color="#FF0000"><b>Procedure </b></font>LittleShellDemo<font color="#000080">;
</font><font color="#FF0000"><b>Begin
 </b></font>DosShell<font color="#000080">(</font><font color="#800000">''</font><font color="#000080">);               </font><font color="#008000"><i>{ a simple DOS-Shell }
 </i></font>DosShell<font color="#000080">(</font><font color="#800000">'/c TEST.BAT'</font><font color="#000080">);    </font><font color="#008000"><i>{ Start the batch-file TEST.BAT }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p></body>
</html>
