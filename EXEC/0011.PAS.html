<html>
<head><title> "Change the MASTER Env" by KELLY SMALL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0011.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
KELLY SMALL

&gt;Does anyone know how to change the &quot;master&quot; environment?  I want to have my
&gt;program change the dos prompt and have it be there after my program ends.
&gt;DOS's stupid little batch language can do it, so there must be a way.

Here's a procedure that should do it from TeeCee:
}

</i></font><font color="#FF0000"><b>procedure </b></font>InitNewPrompt<font color="#000080">;
</font><font color="#008000"><i>{-set up a new prompt for shelling to dos}
</i></font><font color="#FF0000"><b>type
  </b></font>_2karray <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2048</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>SegPtr   <font color="#000080">= ^</font>_2karray<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>NewPrompt <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">= (</font><font color="#800000">'PROMPT=Type EXIT to return to program$_$p$g'</font><font color="#000080">+</font><font color="#800000">#0</font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>EnvSegment<font color="#000080">,
  </font>NewEnvSeg   <font color="#000080">: </font>word<font color="#000080">;
  </font>PtrSeg<font color="#000080">,
  </font>NewEnv      <font color="#000080">: </font>SegPtr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>EnvSegment <font color="#000080">:= </font>memw<font color="#000080">[</font>prefixseg<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">];
  </font><font color="#008000"><i>{-this gets the actual starting segment of the current program's env}

  </i></font>PtrSeg <font color="#000080">:= </font>ptr<font color="#000080">(</font>pred<font color="#000080">(</font>EnvSegment<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#008000"><i>{-The segment of the program's MCB - (Memory control block) }

  </i></font>getmem<font color="#000080">(</font>NewEnv<font color="#000080">, </font><font color="#800000">1072 </font><font color="#000080">+ </font>length<font color="#000080">(</font>NewPrompt<font color="#000080">));
  </font><font color="#008000"><i>{-Allocate heap memory and allow enough room for a dummy mcb }

  </i></font><font color="#FF0000"><b>if </b></font>ofs<font color="#000080">(</font>NewEnv<font color="#000080">^) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>NewEnvSeg <font color="#000080">:= </font>seg<font color="#000080">(</font>NewEnv<font color="#000080">^) + </font><font color="#800000">2
  </font><font color="#FF0000"><b>else
    </b></font>NewEnvSeg <font color="#000080">:= </font>succ<font color="#000080">(</font>seg<font color="#000080">(</font>NewEnv<font color="#000080">^));
  </font><font color="#008000"><i>{-Force the new environment to start at paragraph boundary}

  </i></font>move<font color="#000080">(</font>PtrSeg<font color="#000080">^, </font>mem<font color="#000080">[</font>pred<font color="#000080">(</font>NewEnvSeg<font color="#000080">) : </font><font color="#800000">0</font><font color="#000080">], </font><font color="#800000">16</font><font color="#000080">);
  </font><font color="#008000"><i>{-copy the old mcb and force to paragraph boundary}

  </i></font>memw<font color="#000080">[</font>pred<font color="#000080">(</font>NewEnvSeg<font color="#000080">) : </font><font color="#800000">3</font><font color="#000080">] := (</font><font color="#800000">1072 </font><font color="#000080">+ </font>length<font color="#000080">(</font>NewPrompt<font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;
  </font><font color="#008000"><i>{-Alter the environment length by changing the dummy mcb}

  </i></font>move<font color="#000080">(</font>NewPrompt<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>memw<font color="#000080">[</font>NewEnvSeg <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">], </font>length<font color="#000080">(</font>NewPrompt<font color="#000080">));
  </font><font color="#008000"><i>{-install new prompt}

  </i></font>memw<font color="#000080">[</font>prefixseg<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">] := </font>NewEnvSeg<font color="#000080">;
  </font><font color="#008000"><i>{-let the program know where the new env is}

  </i></font>move<font color="#000080">(</font>mem<font color="#000080">[</font>EnvSegment <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">], </font>mem<font color="#000080">[</font>NewEnvSeg <font color="#000080">: </font>length<font color="#000080">(</font>NewPrompt<font color="#000080">)], </font><font color="#800000">1024</font><font color="#000080">);
  </font><font color="#008000"><i>{-shift the old env to the new area}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0011.PAS">Original</a><b>]</b></p></body>
</html>
