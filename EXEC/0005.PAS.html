<html>
<head><title> "Exec with Memory Shrink" by KELD R. HANSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0005.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
KELD R. HANSEN

&gt; I need to *simulate* something like:
&gt; {$M 16384,0,0}               {reduce heap}
&gt; Exec('c:\myprgm.exe','');    {run myprgm.exe}
&gt; {$M 16384,110000,110000}     {restore heap}

EXECUTE shrinks your programs memory allocation to the smallest possible value,
then runs the program and then expands it back up again. Works in TP 6.0 and
7.0!
*)

</i></font><font color="#FF0000"><b>USES
  </b></font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>TYPE
  </b></font>STR127 <font color="#000080">= </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">[</font><font color="#800000">127</font><font color="#000080">];

</font><font color="#FF0000"><b>PROCEDURE </b></font>ReallocateMemory<font color="#000080">(</font>P <font color="#000080">: </font>POINTER<font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">MOV  AX, PrefixSeg
  MOV  ES, AX
  MOV  BX, WORD PTR P+2
  CMP  WORD PTR P,0
  JE   @OK
  INC  BX

 @OK:
  SUB  BX, AX
  MOV  AH, 4Ah
  INT  21h
  JC   @X
  LES  DI, P
  MOV  WORD PTR HeapEnd,DI
  MOV  WORD PTR HeapEnd+2,ES

 @X:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>EXECUTE<font color="#000080">(</font>Name <font color="#000080">: </font>PathStr <font color="#000080">; </font>Tail <font color="#000080">: </font>STR127<font color="#000080">) : </font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
  </b></font><font color="#008000"><i>{$IFDEF CPU386}
  </i></font><font color="#FF00FF">DB      66h
  PUSH    WORD PTR HeapEnd
  DB      66h
  PUSH    WORD PTR Name
  DB      66h
  PUSH    WORD PTR Tail
  DB      66h
  PUSH    WORD PTR HeapPtr
  </font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF00FF">PUSH    WORD PTR HeapEnd+2
  PUSH    WORD PTR HeapEnd
  PUSH    WORD PTR Name+2
  PUSH    WORD PTR Name
  PUSH    WORD PTR Tail+2
  PUSH    WORD PTR Tail
  PUSH    WORD PTR HeapPtr+2
  PUSH    WORD PTR HeapPtr
  </font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF00FF">CALL ReallocateMemory
  CALL SwapVectors
  CALL DOS.EXEC
  CALL SwapVectors
  CALL ReallocateMemory
  MOV  AX, DosError
  OR   AX, AX
  JNZ  @OUT
  MOV  AH, 4Dh
  INT  21h

 @OUT:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0005.PAS">Original</a><b>]</b></p></body>
</html>
