<html>
<head><title> "EXECHILD.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0001.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(* This unit lets you execute any child program and redirect the
   child program output to NUL / PRN / CON or file.
   It's very simple to use (look at the EXAMPLE.PAS).
   This source is completlly freeware but make sure to remove
   this remark if any changes are made I don't want anyone to
   spread his bugs with my source.
   Of course any suggestions are welcome as well as questions
   about the source.

   Written by Schwartz Gabriel.   20/03/1993.
   Anyone who has any question can leave me a message at 
   CompuServe to EliaShim address 100320,36
*)

{$A+,B-,D-,E-,F+,G-,I-,L-,N-,O-,P-,Q-,R-,S-,T-,V-,X+,Y+}

</i></font><font color="#FF0000"><b>Unit </b></font>Redir<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Var
  </b></font>IOStatus      <font color="#000080">: </font>Integer<font color="#000080">;
  </font>RedirError    <font color="#000080">: </font>Integer<font color="#000080">;
  </font>ExecuteResult <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>Execute <font color="#000080">(</font>ProgName<font color="#000080">, </font>ComLine<font color="#000080">, </font>Redir<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#008000"><i>{------------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Implementation

Uses </b></font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>PMCB <font color="#000080">= ^</font>TMCB<font color="#000080">;
  </font>TMCB <font color="#000080">= </font><font color="#FF0000"><b>record
           </b></font>Typ   <font color="#000080">: </font>Char<font color="#000080">;
           </font>Owner <font color="#000080">: </font>Word<font color="#000080">;
           </font>Size  <font color="#000080">: </font>Word<font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PtrRec <font color="#000080">= </font><font color="#FF0000"><b>record
             </b></font>Ofs<font color="#000080">, </font>Seg <font color="#000080">: </font>Word<font color="#000080">;
           </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>THeader <font color="#000080">= </font><font color="#FF0000"><b>record
              </b></font>Signature <font color="#000080">: </font>Word<font color="#000080">;
              </font>PartPag   <font color="#000080">: </font>Word<font color="#000080">;
              </font>PageCnt   <font color="#000080">: </font>Word<font color="#000080">;
              </font>ReloCnt   <font color="#000080">: </font>Word<font color="#000080">;
              </font>HdrSize   <font color="#000080">: </font>Word<font color="#000080">;
              </font>MinMem    <font color="#000080">: </font>Word<font color="#000080">;
              </font>MaxMem    <font color="#000080">: </font>Word<font color="#000080">;
              </font>ReloSS    <font color="#000080">: </font>Word<font color="#000080">;
              </font>ExeSP     <font color="#000080">: </font>Word<font color="#000080">;
              </font>ChkSum    <font color="#000080">: </font>Word<font color="#000080">;
              </font>ExeIP     <font color="#000080">: </font>Word<font color="#000080">;
              </font>ReloCS    <font color="#000080">: </font>Word<font color="#000080">;
              </font>TablOff   <font color="#000080">: </font>Word<font color="#000080">;
              </font>OverNo    <font color="#000080">: </font>Word<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>PrefSeg      <font color="#000080">: </font>Word<font color="#000080">;
  </font>MinBlockSize <font color="#000080">: </font>Word<font color="#000080">;
  </font>MCB          <font color="#000080">: </font>PMCB<font color="#000080">;
  </font>FName        <font color="#000080">: </font>PathStr<font color="#000080">;
  </font>F            <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>MyBlockSize  <font color="#000080">: </font>Word<font color="#000080">;
  </font>Header       <font color="#000080">: </font>THeader<font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>procedure </b></font>Execute <font color="#000080">(</font>ProgName<font color="#000080">, </font>ComLine<font color="#000080">, </font>Redir<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);

</font><font color="#FF0000"><b>type
  </b></font>PHandles <font color="#000080">= ^</font>THandles<font color="#000080">;
  </font>THandles <font color="#000080">= </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font>Byte<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;

  </font>PWord <font color="#000080">= ^</font>Word<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>RedirChanged <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>Handles      <font color="#000080">: </font>PHandles<font color="#000080">;
  </font>OldHandle    <font color="#000080">: </font>Byte<font color="#000080">;

  </font><font color="#008000"><i>{............................................................................}

  </i></font><font color="#FF0000"><b>function </b></font>ChangeRedir <font color="#000080">: </font>Boolean<font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font>ChangeRedir<font color="#000080">:=</font>False<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>Redir <font color="#000080">= </font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
    </font>Assign <font color="#000080">(</font>F<font color="#000080">, </font>Redir<font color="#000080">);
    </font>Rewrite <font color="#000080">(</font>F<font color="#000080">);
    </font>RedirError<font color="#000080">:=</font>IOResult<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>IOStatus <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
    </font>Handles<font color="#000080">:=</font>Ptr <font color="#000080">(</font>PrefixSeg<font color="#000080">, </font>PWord <font color="#000080">(</font>Ptr <font color="#000080">(</font>PrefixSeg<font color="#000080">, </font><font color="#800000">$34</font><font color="#000080">))^);
    </font>OldHandle<font color="#000080">:=</font>Handles<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">];
    </font>Handles<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">]:=</font>Handles<font color="#000080">^[</font>FileRec <font color="#000080">(</font>F<font color="#000080">).</font>Handle<font color="#000080">];
    </font>ChangeRedir<font color="#000080">:=</font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{............................................................................}

  </i></font><font color="#FF0000"><b>procedure </b></font>CompactHeap<font color="#000080">;

  </font><font color="#FF0000"><b>var
    </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font>Regs<font color="#000080">.</font>AH<font color="#000080">:=</font><font color="#800000">$4A</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>ES<font color="#000080">:=</font>PrefSeg<font color="#000080">;
    </font>Regs<font color="#000080">.</font>BX<font color="#000080">:=</font>MinBlockSize <font color="#000080">+ (</font>PtrRec <font color="#000080">(</font>HeapPtr<font color="#000080">).</font>Seg <font color="#000080">- </font>PtrRec <font color="#000080">(</font>HeapOrg<font color="#000080">).</font>Seg<font color="#000080">);
    </font>MsDos <font color="#000080">(</font>Regs<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{............................................................................}

  </i></font><font color="#FF0000"><b>procedure </b></font>DosExecute<font color="#000080">;

  </font><font color="#FF0000"><b>Begin
    </b></font>SwapVectors<font color="#000080">;
    </font>Exec <font color="#000080">(</font>ProgName<font color="#000080">, </font>ComLine<font color="#000080">);
    </font>IOStatus<font color="#000080">:=</font>DosError<font color="#000080">;
    </font>ExecuteResult<font color="#000080">:=</font>DosExitCode<font color="#000080">;
    </font>SwapVectors<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#008000"><i>{............................................................................}

  </i></font><font color="#FF0000"><b>procedure </b></font>ExpandHeap<font color="#000080">;

  </font><font color="#FF0000"><b>var
    </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font>Regs<font color="#000080">.</font>AH<font color="#000080">:=</font><font color="#800000">$4A</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>ES<font color="#000080">:=</font>PrefSeg<font color="#000080">;
    </font>Regs<font color="#000080">.</font>BX<font color="#000080">:=</font>MyBlockSize<font color="#000080">;
    </font>MsDos <font color="#000080">(</font>Regs<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{............................................................................}

  </i></font><font color="#FF0000"><b>procedure </b></font>RestoreRedir<font color="#000080">;

  </font><font color="#FF0000"><b>begin
    If not </b></font>RedirChanged <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
    </font>Handles<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">]:=</font>OldHandle<font color="#000080">;
    </font>Close <font color="#000080">(</font>F<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{............................................................................}

</i></font><font color="#FF0000"><b>Begin
  </b></font>RedirError<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>RedirChanged<font color="#000080">:=</font>ChangeRedir<font color="#000080">;
  </font>CompactHeap<font color="#000080">;
  </font>DosExecute<font color="#000080">;
  </font>Expandheap<font color="#000080">;
  </font>RestoreRedir<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Begin
  </b></font>SetCBreak <font color="#000080">(</font>False<font color="#000080">);
  </font>FName<font color="#000080">:=</font>ParamStr <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font>Assign <font color="#000080">(</font>F<font color="#000080">, </font>FName<font color="#000080">);
  </font>Reset <font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>IOStatus<font color="#000080">:=</font>IOResult<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>IOStatus <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>BlockRead <font color="#000080">(</font>F<font color="#000080">, </font>Header<font color="#000080">, </font>SizeOf <font color="#000080">(</font>Header<font color="#000080">));
      </font>IOStatus<font color="#000080">:=</font>IOResult<font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font>IOStatus <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>MinBlockSize<font color="#000080">:=</font>Header<font color="#000080">.</font>PageCnt <font color="#000080">* </font><font color="#800000">32 </font><font color="#000080">+ </font>Header<font color="#000080">.</font>MinMem <font color="#000080">+ </font><font color="#800000">1
      </font><font color="#FF0000"><b>Else </b></font>MinBlockSize<font color="#000080">:=</font><font color="#800000">$8000</font><font color="#000080">;
      </font>Close <font color="#000080">(</font>F<font color="#000080">);
    </font><font color="#FF0000"><b>end
  Else </b></font>MinBlockSize<font color="#000080">:=</font><font color="#800000">$8000</font><font color="#000080">;
  </font>PtrRec <font color="#000080">(</font>MCB<font color="#000080">).</font>Seg<font color="#000080">:=</font>PrefixSeg <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
  </font>PtrRec <font color="#000080">(</font>MCB<font color="#000080">).</font>Ofs<font color="#000080">:=</font><font color="#800000">$0000</font><font color="#000080">;
  </font>MyBlockSize<font color="#000080">:=</font>MCB<font color="#000080">^.</font>Size<font color="#000080">;
  </font>PrefSeg<font color="#000080">:=</font>PrefixSeg<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0001.PAS">Original</a><b>]</b></p></body>
</html>
