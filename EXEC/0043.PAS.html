<html>
<head><title> "Anti-Debug unit" by BRAD ZAVITSKY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0043.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000000">Here <font color="#FF0000"><b>is </b></font>an anti<font color="#000080">-</font>debugging <font color="#FF0000"><b>unit </b></font>I created<font color="#000080">.  </font>Use AntiOn at the start <font color="#FF0000"><b>of
</b></font>whatever has <font color="#FF0000"><b>to </b></font>be hidden <font color="#000080">(</font>Password<font color="#000080">/</font>Key gen<font color="#000080">) </font><font color="#FF0000"><b>and </b></font>AntiOff at the <font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>Actions<font color="#000080">:
</font><font color="#800000">1</font><font color="#000080">) </font>Disable Keyboard
<font color="#800000">2</font><font color="#000080">) </font>Change interrupts <font color="#800000">1</font><font color="#000080">&amp;</font><font color="#800000">3 </font><font color="#008000"><i>{Trace and Breakpoint}
</i></font><font color="#800000">3</font><font color="#000080">) </font>Loop <font color="#FF0000"><b>until </b></font>system time changes<font color="#000080">. </font><font color="#008000"><i>{This will mess up Turbo Debugger}

</i></font>Note<font color="#000080">:
</font>Interrupts are accessed directly instead <font color="#FF0000"><b>of </b></font>through DOS <font color="#FF0000"><b>function </b></font><font color="#800000">25</font>h<font color="#000080">,
</font>this will prevent a debugger that takes over all the interrupts from
disabling from still being able <font color="#FF0000"><b>to </b></font>trace<font color="#000080">/</font>add breakpoints<font color="#000080">.

</font>Right now<font color="#000080">, </font>intxx <font color="#FF0000"><b>is set to </b></font>INT<font color="#800000">$20 </font><font color="#000080">(</font>Halt <font color="#FF0000"><b>program</b></font><font color="#000080">) </font>which will crash the
debugger<font color="#000080">.  </font><font color="#FF0000"><b>Set </b></font>it<font color="#800000">'s offset to $10 (INT$04) to just ignore the commands.


</font><font color="#008000"><i>{$A+,B-,D-,F-,G-,I-,L-,N-,O-,P-,Q-,R-,S-,T-,V-,X-}

</i></font><font color="#FF0000"><b>unit </b></font>AntiDbug<font color="#000080">;

</font><font color="#FF0000"><b>interface

</b></font><font color="#008000"><i>{Enable anti-debugging technique's, Keyboard will no longer work}
</i></font><font color="#FF0000"><b>procedure </b></font>AntiOn<font color="#000080">;
</font><font color="#008000"><i>{Disable anti-debugging technique's}
</i></font><font color="#FF0000"><b>procedure </b></font>AntiOff<font color="#000080">;
</font><font color="#008000"><i>{Halts some debuggers (Turbo Debugger), called at unit init;
 Can be called freely}
</i></font><font color="#FF0000"><b>procedure </b></font>HaltDebug<font color="#000080">;

</font><font color="#FF0000"><b>implementation

var
  </b></font><font color="#008000"><i>{Direct interrupt access}
  </i></font>Int01<font color="#000080">: </font>Pointer <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0</font><font color="#000080">:</font><font color="#800000">$004</font><font color="#000080">;
  </font>Int03<font color="#000080">: </font>Pointer <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0</font><font color="#000080">:</font><font color="#800000">$00C</font><font color="#000080">;
  </font>IntXX<font color="#000080">: </font>Pointer <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0</font><font color="#000080">:</font><font color="#800000">$080</font><font color="#000080">; </font><font color="#008000"><i>{New interrupt, 04=$10, 20=$80}


  {Saved interrupts}
  </i></font>SaveInt01<font color="#000080">,
  </font>SaveInt03<font color="#000080">: </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Cli<font color="#000080">; </font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">); </font><font color="#008000"><i>{Clear interrupts}
</i></font><font color="#FF0000"><b>procedure </b></font>Sti<font color="#000080">; </font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">); </font><font color="#008000"><i>{Store interrupts?}

</i></font><font color="#FF0000"><b>procedure </b></font>HaltDebug<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#008000"><i>{Wait until clock timer changes}
  </i></font><font color="#FF00FF">push ds
  xor ax, ax
  mov ds, ax
  mov ah, [046Ch]
@@TimerWait:
  mov al, [046Ch]
  cmp al, ah
  je @@TimerWait
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>AntiOn<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$02</font><font color="#000080">;
  </font><font color="#008000"><i>{Disable interrupts}
  </i></font>Cli<font color="#000080">;
  </font>Int03 <font color="#000080">:= </font>IntXX<font color="#000080">;
  </font>Int01 <font color="#000080">:= </font>IntXX<font color="#000080">;
  </font>Sti<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>AntiOff<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$fd</font><font color="#000080">;
  </font><font color="#008000"><i>{Enable interrupts}
  </i></font>Cli<font color="#000080">;
  </font>Int01 <font color="#000080">:= </font>SaveInt01<font color="#000080">;
  </font>Int03 <font color="#000080">:= </font>SaveInt03<font color="#000080">;
  </font>Sti<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Try to mess up debuggers}
  </i></font>HaltDebug<font color="#000080">;
  </font><font color="#008000"><i>{Save interrutps}
  </i></font>SaveInt01 <font color="#000080">:= </font>Int01<font color="#000080">;
  </font>SaveInt03 <font color="#000080">:= </font>Int03<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to EXEC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0043.PAS">Original</a><b>]</b></p></body>
</html>
