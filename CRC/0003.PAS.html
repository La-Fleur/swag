<html>
<head><title> "16 BIT CRC" by GREG VIGNEAULT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to CRC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 The following is a Turbo/Quick Pascal Implementation of calculating
 the XModem Type of 16-bit cyclic redundancy checking (CRC).

 Is there a preference For the language of the next CRC-16 example
 (80x86 Assembly, BASIC, or C) ?
}

(*******************************************************************)
</i></font><font color="#FF0000"><b>Program </b></font>TPCRC16<font color="#000080">;    </font><font color="#008000"><i>{ Compiler: TurboPascal 4.0+ &amp; QuickPascal 1.0+ }
{ Turbo Pascal 16-bit Cyclic Redundancy Checking (CRC) a.la. XModem }
{ Greg Vigneault, Box 7169, Station A, toronto, Canada M5W 1X8.     }

</i></font><font color="#FF0000"><b>Const   </b></font>Beep        <font color="#000080">= </font><font color="#800000">#7</font><font color="#000080">;                       </font><font color="#008000"><i>{ ASCII bell tone   }
</i></font><font color="#FF0000"><b>Type    </b></font>bArray      <font color="#000080">= </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">$4000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{ define buffer     }
        </i></font>bPointer    <font color="#000080">= ^</font>bArray<font color="#000080">;                  </font><font color="#008000"><i>{ Pointer to buffer }
</i></font><font color="#FF0000"><b>Var     </b></font>DataPtr     <font color="#000080">: </font>bPointer<font color="#000080">;                 </font><font color="#008000"><i>{ Pointer to data   }
        </i></font>fName       <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;                   </font><font color="#008000"><i>{ File name         }
        </i></font>fHandle     <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;                     </font><font color="#008000"><i>{ File handle       }
        </i></font>BytesIn     <font color="#000080">: </font>Word<font color="#000080">;                     </font><font color="#008000"><i>{ For counting data }
        </i></font>CRC16       <font color="#000080">: </font>Integer<font color="#000080">;                  </font><font color="#008000"><i>{ running CRC-16    }

{-------------------------------------------------------------------}
 </i></font><font color="#FF0000"><b>Procedure </b></font>WriteHex<font color="#000080">( </font>raw <font color="#000080">: </font>Integer <font color="#000080">);   </font><font color="#008000"><i>{ display hexadecimal value }
    </i></font><font color="#FF0000"><b>Var </b></font>ch      <font color="#000080">: </font>Char<font color="#000080">;
        </font>shft    <font color="#000080">: </font>Byte<font color="#000080">;
    </font><font color="#FF0000"><b>begin
        if </b></font><font color="#000080">(</font>raw <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Write<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">)            </font><font color="#008000"><i>{ if zero           }
        </i></font><font color="#FF0000"><b>else begin
            </b></font>shft <font color="#000080">:= </font><font color="#800000">16</font><font color="#000080">;                         </font><font color="#008000"><i>{ bit count         }
            </i></font><font color="#FF0000"><b>Repeat  </b></font><font color="#008000"><i>{ isolate each hex nibble, and convert to ASCII }
                </i></font>DEC<font color="#000080">( </font>shft<font color="#000080">, </font><font color="#800000">4 </font><font color="#000080">);                 </font><font color="#008000"><i>{ shift by nibble   }
                </i></font>ch <font color="#000080">:= </font>CHR<font color="#000080">( </font>raw <font color="#FF0000"><b>SHR </b></font>shft <font color="#FF0000"><b>and </b></font><font color="#800000">$F </font><font color="#FF0000"><b>or </b></font>orD<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">) ); </font><font color="#008000"><i>{0..9 }
                </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>ch <font color="#000080">&gt; </font><font color="#800000">'9'</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>inC<font color="#000080">( </font>ch<font color="#000080">, </font><font color="#800000">7 </font><font color="#000080">);              </font><font color="#008000"><i>{A..F }
                </i></font>Write<font color="#000080">( </font>ch <font color="#000080">);                    </font><font color="#008000"><i>{ display the digit }
            </i></font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>shft <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{WriteHex}</i></font><font color="#000080">;

</font><font color="#008000"><i>{-------------------------------------------------------------------}
 </i></font><font color="#FF0000"><b>Function </b></font>UpdateCRC16<font color="#000080">(</font>CRC       <font color="#000080">: </font>Integer<font color="#000080">;      </font><font color="#008000"><i>{ CRC-16 to update  }
                      </i></font>InBuf     <font color="#000080">: </font>bPointer<font color="#000080">;     </font><font color="#008000"><i>{ Pointer to data   }
                      </i></font>InLen     <font color="#000080">: </font>Integer<font color="#000080">) :</font>Integer<font color="#000080">;  </font><font color="#008000"><i>{ data count  }
    </i></font><font color="#FF0000"><b>Var </b></font>Bit<font color="#000080">, </font>ByteCount          <font color="#000080">: </font>Integer<font color="#000080">;
        </font>Carry                   <font color="#000080">: </font>Boolean<font color="#000080">;      </font><font color="#008000"><i>{ catch overflow    }
    </i></font><font color="#FF0000"><b>begin
    For </b></font>ByteCount <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>InLen <font color="#FF0000"><b>do              </b></font><font color="#008000"><i>{ all data Bytes    }
        </i></font><font color="#FF0000"><b>For </b></font>Bit <font color="#000080">:= </font><font color="#800000">7 </font><font color="#FF0000"><b>doWNto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do begin          </b></font><font color="#008000"><i>{ 8 bits per Byte   }
            </i></font>Carry <font color="#000080">:= </font>CRC <font color="#FF0000"><b>and </b></font><font color="#800000">$8000 </font><font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">;        </font><font color="#008000"><i>{ shift overlow?    }
            </i></font>CRC <font color="#000080">:= </font>CRC <font color="#FF0000"><b>SHL </b></font><font color="#800000">1 </font><font color="#FF0000"><b>or </b></font>InBuf<font color="#000080">^[</font>ByteCount<font color="#000080">] </font><font color="#FF0000"><b>SHR </b></font>Bit <font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">;
            </font><font color="#FF0000"><b>if </b></font>Carry <font color="#FF0000"><b>then </b></font>CRC <font color="#000080">:= </font>CRC <font color="#FF0000"><b>xor </b></font><font color="#800000">$1021</font><font color="#000080">; </font><font color="#008000"><i>{ apply polynomial  }
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ For Bit &amp; ByteCount }            { all Bytes &amp; bits  }
    </i></font>UpdateCRC16 <font color="#000080">:= </font>CRC<font color="#000080">;                         </font><font color="#008000"><i>{ updated CRC-16    }
    </i></font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{UpdateCRC16}</i></font><font color="#000080">;

</font><font color="#008000"><i>{-------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>begin
    if </b></font><font color="#000080">( </font>MaxAvail <font color="#000080">&lt; </font>Sizeof<font color="#000080">(</font>bArray<font color="#000080">) ) </font><font color="#FF0000"><b>then begin </b></font><font color="#008000"><i>{ check For memory  }
        </i></font>WriteLn<font color="#000080">( </font><font color="#800000">'not enough memory!'</font><font color="#000080">, </font>Beep <font color="#000080">);
        </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>ParamCount <font color="#000080">&lt;&gt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then begin             </b></font><font color="#008000"><i>{ File name input?  }
        </i></font>WriteLn<font color="#000080">( </font><font color="#800000">'Use TPCRC16 &lt;fName&gt;'</font><font color="#000080">, </font>Beep <font color="#000080">);;
        </font>Halt<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>fName <font color="#000080">:= </font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);                       </font><font color="#008000"><i>{ get File name     }
    </i></font>Assign<font color="#000080">( </font>fHandle<font color="#000080">, </font>fName <font color="#000080">);                   </font><font color="#008000"><i>{ open the File     }
    {$i-} </i></font>Reset<font color="#000080">( </font>fHandle<font color="#000080">, </font><font color="#800000">1 </font><font color="#000080">); </font><font color="#008000"><i>{$i+}            { open succeeded?   }
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>IoResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin               </b></font><font color="#008000"><i>{ if not ...        }
        </i></font>WriteLn<font color="#000080">( </font><font color="#800000">'File access ERRor'</font><font color="#000080">, </font>Beep <font color="#000080">);
        </font>Halt<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>New<font color="#000080">( </font>DataPtr <font color="#000080">);                             </font><font color="#008000"><i>{ allocate memory   }
    </i></font>CRC16 <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                                 </font><font color="#008000"><i>{ initialize CRC-16 }
    </i></font><font color="#FF0000"><b>Repeat
        </b></font>BlockRead<font color="#000080">( </font>fHandle<font color="#000080">, </font>DataPtr<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">], </font>Sizeof<font color="#000080">(</font>bArray<font color="#000080">), </font>BytesIn <font color="#000080">);
        </font>CRC16 <font color="#000080">:= </font>UpdateCRC16<font color="#000080">( </font>CRC16<font color="#000080">, </font>DataPtr<font color="#000080">, </font>BytesIn <font color="#000080">);
    </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>BytesIn <font color="#000080">&lt;&gt; </font>Sizeof<font color="#000080">(</font>bArray<font color="#000080">)) </font><font color="#FF0000"><b>or </b></font>Eof<font color="#000080">(</font>fHandle<font color="#000080">);
    </font>Close<font color="#000080">( </font>fHandle <font color="#000080">);                           </font><font color="#008000"><i>{ close input File  }
    </i></font>DataPtr<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">; </font>DataPtr<font color="#000080">^[</font><font color="#800000">2</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;         </font><font color="#008000"><i>{ insert two nulls  }
    </i></font>CRC16 <font color="#000080">:= </font>UpdateCRC16<font color="#000080">( </font>CRC16<font color="#000080">, </font>DataPtr<font color="#000080">, </font><font color="#800000">2 </font><font color="#000080">);  </font><font color="#008000"><i>{ For final calc    }
    </i></font>Dispose<font color="#000080">( </font>DataPtr <font color="#000080">);                         </font><font color="#008000"><i>{ release memory    }
    </i></font>Write<font color="#000080">( </font><font color="#800000">'The CRC-16 of File '</font><font color="#000080">, </font>fName<font color="#000080">, </font><font color="#800000">' is $' </font><font color="#000080">);
    </font>WriteHex<font color="#000080">( </font>CRC16 <font color="#000080">);  </font>WriteLn<font color="#000080">;

</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{TPCRCXMO}</i></font><font color="#000080">.
</font><font color="#008000"><i>(*********************************************************************)
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to CRC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p></body>
</html>
