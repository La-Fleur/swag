<html>
<head><title> "Buffer Streams" by ALEXANDER STAUBO</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to POINTERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0015.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
JB&gt; AS&gt;Use buffered streams.  That way you can access fairly many records on
JB&gt; AS&gt;disk without noticable speed degradation.
JB&gt;                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^
JB&gt; Do you mean from RAM?? Whoah! How do you go about using buffered
JB&gt; streams?

Actually, you should write a local &quot;cache&quot; for your records.  Ie.,
your implement an array of records, say 1..50, or, 1..MaxCacheSize,
where MaxCacheSize is a defined constant.  Then you have a couple of
generalized procedures for putting/getting records; now, the point is,
whenever the program asks for a record -that is in the cache-, that
record is read directly from RAM.  If the record is -not- in the
cache, the record is read, and, if there is space in the cache, the
record is inserted into the cache.

Let's try a Pascal implementation.
}

        </i></font><font color="#FF0000"><b>const
          </b></font>MaxCacheSize <font color="#000080">= </font><font color="#800000">50</font><font color="#000080">; </font><font color="#008000"><i>(* cache can hold 50 records *)

        </i></font><font color="#FF0000"><b>type
          </b></font><font color="#008000"><i>(* this is the cache item *)
          </i></font>PCacheItem <font color="#000080">= ^</font>TCacheItem<font color="#000080">;
          </font>TCacheItem <font color="#000080">=
            </font><font color="#FF0000"><b>record
              </b></font>Offset <font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#008000"><i>(* file offset of cache record *)
              </i></font>Rec    <font color="#000080">: </font>TRecord<font color="#000080">; </font><font color="#008000"><i>(* use your own record type here *)
            </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font><font color="#FF0000"><b>var
          </b></font>Cache <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>MaxCacheSize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>PCacheItem<font color="#000080">;
          </font>CacheSize <font color="#000080">: </font>Word<font color="#000080">;

        </font><font color="#FF0000"><b>procedure </b></font>InitCache<font color="#000080">;
          </font><font color="#008000"><i>{-Resets cache}
        </i></font><font color="#FF0000"><b>begin
          </b></font>CacheSize<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font><font color="#FF0000"><b>function </b></font>FindCache <font color="#000080">(</font>Offset <font color="#000080">: </font>Longint<font color="#000080">) : </font>PCacheItem<font color="#000080">;
          </font><font color="#008000"><i>{-Returns cache item for Offset if found, otherwise nil}
        </i></font><font color="#FF0000"><b>var
          </b></font>W <font color="#000080">: </font>Word<font color="#000080">;
        </font><font color="#FF0000"><b>begin
          for </b></font>W<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>CacheSize <font color="#FF0000"><b>do
            if </b></font>Cache<font color="#000080">[</font>W<font color="#000080">]^.</font>Offset <font color="#000080">= </font>Offset <font color="#FF0000"><b>then
              begin
                </b></font>FindCache<font color="#000080">:=</font>Cache<font color="#000080">[</font>W<font color="#000080">];
                </font>Exit<font color="#000080">;
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>FindCache<font color="#000080">:=</font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font><font color="#FF0000"><b>var
          </b></font>F <font color="#000080">: </font><font color="#FF0000"><b>file of </b></font>TRecord<font color="#000080">; </font><font color="#008000"><i>(* file in question *)

        </i></font><font color="#FF0000"><b>procedure </b></font>PutRecord <font color="#000080">(</font>Offset <font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Rec <font color="#000080">: </font>TRecord<font color="#000080">);
          </font><font color="#008000"><i>{-Put record into cache and file}
        </i></font><font color="#FF0000"><b>var
          </b></font>P <font color="#000080">: </font>PCacheItem<font color="#000080">;
        </font><font color="#FF0000"><b>begin
          </b></font>Write<font color="#000080">(</font>F<font color="#000080">, </font>Rec<font color="#000080">);

          </font><font color="#008000"><i>(* if exists in RAM (cache), update it *)
          </i></font>P<font color="#000080">:=</font>FindCache<font color="#000080">(</font>Offset<font color="#000080">);
          </font><font color="#FF0000"><b>if </b></font>P <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then
            </b></font>P<font color="#000080">^.</font>Rec<font color="#000080">:=</font>Rec
          <font color="#FF0000"><b>else
            begin
              </b></font><font color="#008000"><i>(* put into cache *)
              </i></font>Inc<font color="#000080">(</font>CacheSize<font color="#000080">);
              </font>New<font color="#000080">(</font>Cache<font color="#000080">[</font>CacheSize<font color="#000080">]);
              </font>Cache<font color="#000080">[</font>CacheSize<font color="#000080">]^.</font>Offset<font color="#000080">:=</font>Offset<font color="#000080">;
              </font>Cache<font color="#000080">[</font>CacheSize<font color="#000080">]^.</font>Rec<font color="#000080">:=</font>Rec<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font><font color="#FF0000"><b>procedure </b></font>GetRecord <font color="#000080">(</font>Offset <font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Rec <font color="#000080">: </font>TRecord<font color="#000080">);
          </font><font color="#008000"><i>{-Get record from cached file}
        </i></font><font color="#FF0000"><b>var
          </b></font>P <font color="#000080">: </font>PCacheItem<font color="#000080">;
        </font><font color="#FF0000"><b>begin
          </b></font><font color="#008000"><i>(* if exists in RAM (cache), get it *)
          </i></font>P<font color="#000080">:=</font>FindCache<font color="#000080">(</font>Offset<font color="#000080">);
          </font><font color="#FF0000"><b>if </b></font>P <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then
            </b></font>Rec<font color="#000080">:=</font>P<font color="#000080">^.</font>Rec
          <font color="#FF0000"><b>else if </b></font>CacheSize <font color="#000080">&lt; </font>MaxCacheSize <font color="#FF0000"><b>then
            begin
              </b></font><font color="#008000"><i>(* read record from file *)
              </i></font>Read<font color="#000080">(</font>F<font color="#000080">, </font>Rec<font color="#000080">);

              </font><font color="#008000"><i>(* put into cache *)
              </i></font>Inc<font color="#000080">(</font>CacheSize<font color="#000080">);
              </font>New<font color="#000080">(</font>Cache<font color="#000080">[</font>CacheSize<font color="#000080">]);
              </font>Cache<font color="#000080">[</font>CacheSize<font color="#000080">]^.</font>Offset<font color="#000080">:=</font>Offset<font color="#000080">;
              </font>Cache<font color="#000080">[</font>CacheSize<font color="#000080">]^.</font>Rec<font color="#000080">:=</font>Rec<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>To </b></font>use the routines<font color="#000080">:

          </font>Assign<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">'MYFILE.DAT'</font><font color="#000080">);
          </font>Reset<font color="#000080">(</font>F<font color="#000080">);
          </font>GetRecord<font color="#000080">(</font>FilePos<font color="#000080">(</font>F<font color="#000080">), </font>MyRec<font color="#000080">);
          </font>GetRecord<font color="#000080">(</font>FilePos<font color="#000080">(</font>F<font color="#000080">), </font>MyRec<font color="#000080">);
          </font>GetRecord<font color="#000080">(</font>FilePos<font color="#000080">(</font>F<font color="#000080">), </font>MyRec<font color="#000080">);
          </font>PutRecord<font color="#000080">(</font>FilePos<font color="#000080">(</font>F<font color="#000080">), </font>MyRec<font color="#000080">);
          </font>Close<font color="#000080">(</font>F<font color="#000080">);

</font><font color="#FF0000"><b>Or </b></font>something like that<font color="#000080">, </font>anyway<font color="#000080">.

</font>Now<font color="#000080">, </font>there <font color="#FF0000"><b>is </b></font>a simpler way<font color="#000080">; &quot;</font>simpler<font color="#000080">&quot; </font><font color="#FF0000"><b>in </b></font>this <font color="#FF0000"><b>case </b></font>means <font color="#000080">&quot;</font>some guy
has already spent hours writing it just <font color="#FF0000"><b>for </b></font>you<font color="#000080">&quot;.  </font>The concept <font color="#FF0000"><b>is
</b></font>called streams<font color="#000080">.  </font>Now<font color="#000080">, </font>I don<font color="#800000">'t know how &quot;novice&quot; a programmer you are,
</font>but knowledge <font color="#FF0000"><b>of </b></font>streams <font color="#FF0000"><b>requires </b></font>knowledge <font color="#FF0000"><b>of </b></font>OOP<font color="#000080">.  </font>I suggest you
read about OOP right away<font color="#000080">.

</font>Streams work <font color="#FF0000"><b>in </b></font>a very simple way<font color="#000080">.  </font>You have a basic<font color="#000080">, &quot;</font><font color="#FF0000"><b>abstract</b></font><font color="#000080">&quot;
</font><font color="#FF0000"><b>object</b></font><font color="#000080">, </font>which provides some simple I<font color="#000080">/</font>O tools<font color="#000080">.  </font>A stream <font color="#FF0000"><b>is </b></font>a <font color="#FF0000"><b>type of
</b></font><font color="#000080">(</font><font color="#FF0000"><b>abstract</b></font><font color="#000080">) </font><font color="#FF0000"><b>file</b></font><font color="#000080">, </font>an input<font color="#000080">/</font>output mechanism<font color="#000080">, </font>that you may manipulate<font color="#000080">;
</font>most often it<font color="#800000">'s on a hierarchical level, ie., the high-level
</font>procedures call low<font color="#000080">-</font>level procedures<font color="#000080">, </font>just like DOS<font color="#000080">.  </font>Think <font color="#FF0000"><b>of </b></font>streams
<font color="#FF0000"><b>as </b></font>the <font color="#FF0000"><b>Pascal type </b></font><font color="#000080">&quot;</font><font color="#FF0000"><b>file</b></font><font color="#000080">&quot;, </font><font color="#FF0000"><b>except </b></font>now the stream <font color="#FF0000"><b>is </b></font>a shell <font color="#FF0000"><b>for
</b></font>anything<font color="#000080">.

</font>The shell implements a <font color="#000080">-</font>standard<font color="#000080">- </font><font color="#FF0000"><b>interface for </b></font>any kind <font color="#FF0000"><b>of
</b></font>information area<font color="#000080">.  </font>You have <font color="#FF0000"><b>file </b></font>streams<font color="#000080">, </font>buffered streams <font color="#000080">(</font>streams
that caches areas <font color="#FF0000"><b>of </b></font>the <font color="#FF0000"><b>file in </b></font>memory <font color="#FF0000"><b>to </b></font>optimize access
efficiency<font color="#000080">), </font>EMS streams <font color="#000080">(</font>yes<font color="#000080">, </font>you can have a <font color="#000080">&quot;</font><font color="#FF0000"><b>virtual file</b></font><font color="#000080">&quot; </font>that lies
<font color="#FF0000"><b>in </b></font>EMS memory <font color="#FF0000"><b>and </b></font>may be used just like a <font color="#FF0000"><b>file</b></font><font color="#000080">), </font><font color="#FF0000"><b>and </b></font>so <font color="#FF0000"><b>on</b></font><font color="#000080">.  </font>The
standardization implies that you may write more flexible programs<font color="#000080">.

</font>A tiny example<font color="#000080">:

        </font><font color="#FF0000"><b>var
          </b></font>S   <font color="#000080">: </font>TBufStream<font color="#000080">;
          </font>T   <font color="#000080">: </font>TRecord<font color="#000080">;
          </font>Str <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>begin
          </b></font>S<font color="#000080">.</font>Init<font color="#000080">(</font><font color="#800000">'MYFILE.DAT'</font><font color="#000080">, </font>stOpen<font color="#000080">, </font><font color="#800000">2048</font><font color="#000080">);
              </font><font color="#008000"><i>(* |             |          |
                 file name     file mode  buffer size
              *)
          </i></font>S<font color="#000080">.</font>Read<font color="#000080">(</font>T<font color="#000080">, </font>SizeOf<font color="#000080">(</font>T<font color="#000080">));
          </font>S<font color="#000080">.</font>Write<font color="#000080">(</font>T<font color="#000080">, </font>SizeOf<font color="#000080">(</font>T<font color="#000080">));
          </font>Str<font color="#000080">:=</font>S<font color="#000080">.</font>ReadStr<font color="#000080">^;

          </font>S<font color="#000080">.</font>Done<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>The corresponding boring<font color="#000080">-</font>old<font color="#000080">-</font>Dos example<font color="#800000">'d be:

        </font><font color="#FF0000"><b>var
          </b></font>F   <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
          </font>T   <font color="#000080">: </font>TRecord<font color="#000080">;
          </font>Str <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>begin
          </b></font><font color="#008000"><i>(* note: no buffering -&gt; slower! *)
          </i></font>Assign<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">'MYFILE.DAT'</font><font color="#000080">);
          </font>Reset<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);

          </font>BlockRead<font color="#000080">(</font>F<font color="#000080">, </font>T<font color="#000080">, </font>SizeOf<font color="#000080">(</font>T<font color="#000080">));
          </font>BlockWrite<font color="#000080">(</font>F<font color="#000080">, </font>T<font color="#000080">, </font>SizeOf<font color="#000080">(</font>T<font color="#000080">));
          </font>Read<font color="#000080">(</font>F<font color="#000080">, </font>Str<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
          </font>BlockRead<font color="#000080">(</font>F<font color="#000080">, </font>Str<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>Ord<font color="#000080">(</font>Str<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]));

          </font>Close<font color="#000080">(</font>F<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>In </b></font>the <font color="#FF0000"><b>end</b></font><font color="#000080">, </font>streams <font color="#000080">-</font>are<font color="#000080">- </font>simpler<font color="#000080">, </font>too<font color="#000080">.  </font><font color="#FF0000"><b>And </b></font>they are extremely fast<font color="#000080">;
</font>a friend <font color="#FF0000"><b>of </b></font>mine <font color="#FF0000"><b>is </b></font>writing a mail reader <font color="#FF0000"><b>and is </b></font>using <font color="#FF0000"><b>object </b></font>streams
<font color="#FF0000"><b>for </b></font>the <font color="#FF0000"><b>message</b></font><font color="#000080">/</font>conference<font color="#000080">/</font>etc<font color="#000080">. </font>databases<font color="#000080">.  </font>Now<font color="#000080">, </font>personally I use
indexed<font color="#000080">, </font>light<font color="#000080">-</font>speed B<font color="#000080">-</font>tree databases<font color="#000080">.  </font><font color="#FF0000"><b>And </b></font>his work <font color="#000080">-</font>just fine<font color="#000080">-.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to POINTERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0015.PAS">Original</a><b>]</b></p></body>
</html>
