<html>
<head><title> "New Bp 7.0 Bugs" by DJ MURDOCH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0149.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I saw a message from someone that said you had compiled a list of all the
&gt; bugs with BP 7.0... is it possible I could get a copy?

Look around for BP7BUGS2.ZIP.  That's the currently released version.  It's
available for Internet ftp from garbo.uwasa.fi:/pc/turbopas; it's also on
Compuserve, but in the CLMFORUM in the PC Techniques area, because Borland
didn't want it on BPASCAL.  It should also be available on a lot of BBS
systems.
That version isn't quite up to date; here are the newer entries:

54.  SetVisualPage doesn't take effect immediately, so writes to the old page
after the page change may show up on the screen.  Put in a delay or a wait for
the retrace if you intend to draw to the hidden page.

55.  In protected mode when using BGI with linked in fonts, repeated font
changes eventually cause the BGI driver to get messed up and abort.  There's no
problem if the .CHR files are available in the directory given to InitGraph.

56.  In BASM, &quot;dw @variable&quot; will not assemble properly.  BP and BPC abort,
while TURBO and TPC give a wrong answer.
58.  An array of zero length records (e.g. array[boolean] of record end;) gives
a spurious &quot;structure too large error&quot;.
59.  Real numbers aren't parsed as the manual describes -- the decimal part and
number part of the scale factor are sometimes optional.  For example, &quot;(1. )&quot;
is a legal expression, but &quot;(1.)&quot; is not; both &quot;1e +1&quot; and &quot;1e+1&quot; are legal,
but have different values (2 and 10).
60.  Hardware interrupts during memory allocations in protected mode can cause
general protection faults.  For details and a patch, see PROTINT.FIX.

61.  Inline procedures are treated like forward declarations:  you can have a
duplicate definition of the same identifier later, and the compiler won't
declare an error unless the form of the declaration is different.  It's the
inline definition that will be used.
62.  The TEMSStream.Done destructor doesn't reset EMSCurhandle to $FFFF, so
that the next TEMSStream may work on the wrong page frame at first.  Fix: After
calling Done, manually set EMSCurhandle to $FFFF.

63.  OutText and OutTextXY don't update the current pointer properly in all
justification modes.  Use MoveTo(GetX,GetY) after a call if you want to be sure
to have CP act properly.
64.  For certain very rare pairs x and y, a $N+ division x/y will only be
accurate to about 4 decimal digits when calculated on a Pentium produced before
Fall 1994.  (This is the famous Pentium FDIV bug, not a BP bug.)

And here's the PROTINT.FIX file:


 #: 252543 S7/DOS Programming  [BPASCAL]
     14-Mar-94  04:01:44
 Sb: #252502-Increment Bug in BP7
 Fm: Peter Petersen 100120,1363
 To: DJ Murdoch 71631,122

DJ,

A protected mode program will crash when the first access to a newly allocated
segment is interrupted by a hardware interrupt. The following test program
demonstrates the bug within a few seconds:
}
   </i></font><font color="#FF0000"><b>PROGRAM </b></font>DPMIBug<font color="#000080">;
   </font><font color="#FF0000"><b>USES
      </b></font>DOS<font color="#000080">, </font>CRT<font color="#000080">;
   </font><font color="#FF0000"><b>CONST
      </b></font>COM <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;  </font><font color="#008000"><i>{ may be set to 1..4 }
      </i></font>IRQ <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>byte <font color="#000080">= (</font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);
      </font>RXB  <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">; </font>TXB  <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">; </font>IER  <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">; </font>IIR  <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">; </font>LCR  <font color="#000080">= </font><font color="#800000">$03</font><font color="#000080">;
      </font>MCR  <font color="#000080">= </font><font color="#800000">$04</font><font color="#000080">; </font>LSR  <font color="#000080">= </font><font color="#800000">$05</font><font color="#000080">; </font>MSR  <font color="#000080">= </font><font color="#800000">$06</font><font color="#000080">; </font>DLL  <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">; </font>DLM  <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;
   </font><font color="#FF0000"><b>VAR
      </b></font>Base<font color="#000080">: </font>Word<font color="#000080">;
      </font>Count<font color="#000080">: </font>LongInt<font color="#000080">;
      </font>OrgHandler<font color="#000080">: </font>Pointer<font color="#000080">;

      </font><font color="#008000"><i>{$S- ------------------------------}
      </i></font><font color="#FF0000"><b>PROCEDURE </b></font>IntCOM<font color="#000080">; </font>INTERRUPT<font color="#000080">;
      </font><font color="#FF0000"><b>VAR
         </b></font>Dummy<font color="#000080">: </font>Byte<font color="#000080">;
      </font><font color="#FF0000"><b>BEGIN
         </b></font>Inc<font color="#000080">(</font>Count<font color="#000080">);
         </font><font color="#FF0000"><b>WHILE </b></font>Port<font color="#000080">[</font>Base<font color="#000080">+</font>IIR<font color="#000080">] &lt;&gt; </font><font color="#800000">1 </font><font color="#FF0000"><b>DO
         BEGIN
            </b></font>Dummy<font color="#000080">:=</font>Port<font color="#000080">[</font>Base<font color="#000080">+</font>LSR<font color="#000080">];
            </font>Dummy<font color="#000080">:=</font>Port<font color="#000080">[</font>Base<font color="#000080">+</font>RXB<font color="#000080">];
            </font>Port<font color="#000080">[</font>Base<font color="#000080">+</font>TXB<font color="#000080">]:=</font>Ord<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">)
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

      </font><font color="#008000"><i>{----------------------------------}
      </i></font><font color="#FF0000"><b>PROCEDURE </b></font>InitPort<font color="#000080">(</font>P<font color="#000080">: </font>Byte<font color="#000080">; </font>Baud<font color="#000080">: </font>LongInt<font color="#000080">);
      </font><font color="#FF0000"><b>CONST
         </b></font>MaxBaudRate <font color="#000080">= </font><font color="#800000">115200</font><font color="#000080">;
      </font><font color="#FF0000"><b>VAR
         </b></font>Divider  <font color="#000080">: </font>Word<font color="#000080">;
      </font><font color="#FF0000"><b>BEGIN
         </b></font>Base<font color="#000080">:=</font>MemW<font color="#000080">[</font>Seg0040<font color="#000080">:</font>SizeOf<font color="#000080">(</font>Word<font color="#000080">) * (</font>P<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)];
         </font><font color="#FF0000"><b>IF </b></font>Base <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
         BEGIN
            </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Port COM'</font><font color="#000080">, </font>P<font color="#000080">, </font><font color="#800000">' not installed.'</font><font color="#000080">);
            </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font>Port<font color="#000080">[</font>Base <font color="#000080">+ </font>LCR<font color="#000080">]:=</font><font color="#800000">$80</font><font color="#000080">;
         </font>Divider<font color="#000080">:=(</font>MaxBaudRate <font color="#000080">+ </font>MaxBaudRate <font color="#FF0000"><b>MOD </b></font>Baud<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font>Baud<font color="#000080">;
         </font>Port<font color="#000080">[</font>Base <font color="#000080">+ </font>DLL<font color="#000080">]:=</font>Lo<font color="#000080">(</font>Divider<font color="#000080">);
         </font>Port<font color="#000080">[</font>Base <font color="#000080">+ </font>DLM<font color="#000080">]:=</font>Hi<font color="#000080">(</font>Divider<font color="#000080">);
         </font>Port<font color="#000080">[</font>Base <font color="#000080">+ </font>LCR<font color="#000080">]:=(</font><font color="#800000">8</font><font color="#000080">-</font><font color="#800000">5</font><font color="#000080">) + ((</font><font color="#800000">1</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">2</font><font color="#000080">) + </font><font color="#800000">0</font><font color="#000080">;
         </font>GetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">+</font>IRQ<font color="#000080">[</font>P<font color="#000080">], </font>OrgHandler<font color="#000080">);
         </font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">+</font>IRQ<font color="#000080">[</font>P<font color="#000080">], </font>Addr<font color="#000080">(</font>IntCom<font color="#000080">));
         </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]:=</font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>AND NOT </b></font><font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>SHL </b></font>IRQ<font color="#000080">[</font>P<font color="#000080">]);
         </font>Port<font color="#000080">[</font>Base <font color="#000080">+ </font>MCR<font color="#000080">]:=</font><font color="#800000">$01 </font><font color="#000080">+ </font><font color="#800000">$01 </font><font color="#000080">+ </font><font color="#800000">$04 </font><font color="#000080">+ </font><font color="#800000">$08</font><font color="#000080">;
         </font>Port<font color="#000080">[</font>Base <font color="#000080">+ </font>IER<font color="#000080">]:=</font><font color="#800000">$0F
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

      </font><font color="#008000"><i>{----------------------------------}
      </i></font><font color="#FF0000"><b>PROCEDURE </b></font>DisableCOMInterrupt <font color="#000080">(</font>P<font color="#000080">: </font>Byte<font color="#000080">);
      </font><font color="#FF0000"><b>BEGIN
         </b></font>Port<font color="#000080">[</font>Base <font color="#000080">+ </font>IER<font color="#000080">]:=</font><font color="#800000">0</font><font color="#000080">;
         </font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">+</font>IRQ<font color="#000080">[</font>P<font color="#000080">], </font>OrgHandler<font color="#000080">)
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>VAR
      </b></font>P<font color="#000080">: ^</font>Word<font color="#000080">;
   </font><font color="#FF0000"><b>BEGIN
      </b></font>System<font color="#000080">.</font>Test8086<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#008000"><i>{$IFDEF DPMI }
      </i></font>System<font color="#000080">.</font>HeapLimit<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#008000"><i>{$ENDIF }
      </i></font>Count<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font>InitPort<font color="#000080">(</font>COM<font color="#000080">, </font><font color="#800000">38400</font><font color="#000080">);
      </font>Port<font color="#000080">[</font>Base<font color="#000080">+</font>TXB<font color="#000080">]:=</font>Ord<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">);
      </font><font color="#FF0000"><b>WHILE NOT </b></font>keypressed <font color="#FF0000"><b>DO
      BEGIN
         </b></font>Write<font color="#000080">(^</font>M<font color="#000080">, </font>count<font color="#000080">);
         </font>New<font color="#000080">(</font>P<font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>P <font color="#000080">= </font><font color="#FF0000"><b>NIL THEN </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'error in alloc!'</font><font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>p<font color="#000080">^ = </font><font color="#800000">7 </font><font color="#FF0000"><b>THEN </b></font><font color="#000080">;  </font><font color="#008000"><i>{ read access }
         </i></font>Dispose<font color="#000080">(</font>P<font color="#000080">)
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font>DisableCOMInterrupt<font color="#000080">(</font>COM<font color="#000080">);
      </font><font color="#FF0000"><b>WHILE </b></font>Keypressed <font color="#FF0000"><b>DO IF </b></font>ReadKey <font color="#000080">= </font><font color="#800000">' ' </font><font color="#FF0000"><b>THEN
   END</b></font><font color="#000080">.
</font><font color="#008000"><i>{
The problem can be worked around by disabling interrupts during the first
access to the segment. This is achieved with the following changes to file
WMEM.ASM (part of unit System):
   Comparing files WMEM.ASM and C:\BP70\RTL\SYS\WMEM.ASM
   ***** WMEM.ASM
           OR      AX,AX
           JE      @@2                     ; line number 253
           STC                             ; error and return
           RET
   @@2:    PUSH    AX                      ; save return value
           MOV     AX, 0900H               ; DPMI ints off
           INT     31H                     ; leave int state in AX
           MOV     ES, DX                  ; load seg-reg to load segment
           INT     31H                     ; DPMI restore int state
           POP     AX                      ; restore return value
       ENDIF
   ***** C:\BP70\RTL\SYS\WMEM.ASM
           OR      AX,AX
           JE      @@1
           STC
       ENDIF
   *****

Please note that this fix only affects allocations of the heap. Others (such as
LoadLibrary, InitGraph, GlobalAlloc, etc.) are still affected.
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0149.PAS">Original</a><b>]</b></p></body>
</html>
