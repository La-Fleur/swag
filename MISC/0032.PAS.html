<html>
<head><title> "Modify EXE constants" by GABE KRUPA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
GABE KRUPA

&gt; I need to add some information to the end of an EXE file and be able
&gt; Say a PCX image for example.  I'm concerned about the EXE file alread
&gt; open due to being executed.  Does info tacked to the end of an EXE ge
&gt; into memory automatically, etc.  I haven't tried this yet but am abou
&gt; hoping someone who has tried it can assist me to avoid some of the pi
&gt; they may have encountered.  Thanks.  (BTW, I am experienced in Pas &amp;

  Well, I made a unit for that purpose, but my unit only tacks on 1K of
storage space... You can make it as large as you want it, but it'll be a
REAL time consumer and it might push your text editor to the limits (I'm
not sure if the IDE has a file size limit).

  Here it is (in a VERY shortened version )
}
unit inject1k;

interface
implementation
const doesnt_matter_what_this_is_called : boolean = false;

procedure never_really_call_this_procedure;
begin
  if doesnt_matter_what_this_is_called then
    inline( 228/229/230/231/231/233/234/  { this I use for a ID string }
            234/234/234/234/234/234/234/
            234/234/234/234/243/234/234/
{ repeat as many times until you get enough .. each '234/' is 1 byte }
            234/234/234/234/234/234/234/
            234/234/234/234/234/234/234/  { this is the actual 'junk' }
           ); { inline }
end; { procedure }

end. { unit }
{
  I only inject 1024 into my EXE file... If you want, you can make
identical units like that, but the DATA area will NOT be in one long
string unless all the bytes are in one unit.
  I use the ID string to correctly place the file pointer. Just open the
EXE, read in bytes until you get a 228. Read another, if it's a 229
etc.. Keep looping until you get a 228-229-230-231-232-233-234 and then
you can start reading/writing. It's by no means the easiest way, but I
prefer it over trying to append to the end. I tried that, but I kept
getting errors and such. As long as the PCX file is fairly small, you
won't have too much of a problem.
  I'm not sure what the chances are, they must be pretty slim to find a
string (228-234) one after the other in an EXE. If you think they are
higher, or whatever, just put your own in. You could probably even put
text in like this:
}
inline('D'/'A'/'T'/'A'/' '/'S'/'T'/'A'/'R'/'T'/'S'/' '/'H'/'E'/'R'/'E'/
111/111/111/111  { etc... } );
{
         I hope this helps, or gives you some ideas. Note, the unit will
be about TWICE as large as the number of bytes you inject (maybe 1000
more), but the EXE will only increse by the number you add. I'm pretty
sure that the extra bytes are just data/debug info in the TPU file.
*)

{
MARK LEWIS

&gt; I need to add some information to the end of an EXE file and be able
&gt; Say a PCX image for example.  I'm concerned about the EXE file alread

[... trim ...]

&gt; Well, I made a unit for that purpose, but my unit only tacks on
&gt; 1K of storage space... You can make it as large as you want it,
&gt; but it'll be a REAL time consumer and it might push your text
&gt; editor to the limits (I'm not sure if the IDE has a file size
&gt; limit). Here it is (in a VERY shortened version )
&gt; unit inject1k;

[... trim ...]

interesting&lt;&lt;smile&gt;&gt;... i never thought of doing it like that.. hehe.. here's
a unit i got from this echo or the other PASCAL echo several years ago.. i've
used it in self-limiting programs (ones that only run a certain number of
times) and other programs that may be subject to hacking of various forms...
i've modified it slightly for my purposes...
}
</i></font><font color="#FF0000"><b>unit </b></font>selfmod<font color="#000080">;

</font><font color="#008000"><i>{ Allows a program to self modify a typed constant in the .exe file.  It     }
{ also performs an automatic checksum type .exe file integrity check.        }
{ A longint value is added to the end of the exe file.  This can be read by  }
{ a separate configuration program to enable it to determine the start of    }
{ the programs configuration data area.  To use this the configuration       }
{ typed constant should be added immediately following the declaration of    }
{ ExeData.                                                                   }
{ Where this unit is used, it should always be the FIRST unit listed in the  }
{ uses declaration area of the main program.                                 }
{ Requires DOS 3.3 or later.  Program must not be used with PKLite or LZExe  }
{ or any similar exe file compression programs.                              }
{ The stack size needed is at least 9,000 bytes.                             }

</i></font><font color="#FF0000"><b>interface

type
  </b></font>ExeDatatype    <font color="#000080">= </font><font color="#FF0000"><b>record
                     </b></font>IDStr      <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">8</font><font color="#000080">];
                     </font>FirstTime  <font color="#000080">: </font>boolean<font color="#000080">;
                     </font>Hsize      <font color="#000080">: </font>word<font color="#000080">;
                     </font>ExeSize    <font color="#000080">: </font>longint<font color="#000080">;
                     </font>CheckSum   <font color="#000080">: </font>longint<font color="#000080">;
                     </font>StartConst <font color="#000080">: </font>longint<font color="#000080">;
                   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>ExeData <font color="#000080">: </font>ExeDatatype <font color="#000080">= (</font>IDStr     <font color="#000080">: </font><font color="#800000">'IDSTRING'</font><font color="#000080">;
                           </font>FirstTime <font color="#000080">: </font>true<font color="#000080">;
                           </font>Hsize     <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
                           </font>ExeSize   <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
                           </font>CheckSum  <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
                           </font>StartConst<font color="#000080">: </font><font color="#800000">0</font><font color="#000080">);

</font><font color="#008000"><i>{ IMPORTANT: Put any config data typed constants here }

</i></font><font color="#FF0000"><b>procedure </b></font>Write2Exec<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>data<font color="#000080">; </font>size<font color="#000080">: </font>word<font color="#000080">);

</font><font color="#008000"><i>{============================================================================}

</i></font><font color="#FF0000"><b>implementation

procedure </b></font>InitConstants<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>f           <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
    </font>tbuff       <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>GetCheckSum <font color="#000080">: </font>longint<font color="#000080">;
    </font><font color="#008000"><i>{ Performs a checksum calculation on the exe file }
    </i></font><font color="#FF0000"><b>var
      </b></font>finished  <font color="#000080">: </font>boolean<font color="#000080">;
      </font>x<font color="#000080">,
      </font>CSum      <font color="#000080">: </font>longint<font color="#000080">;
      </font>BytesRead <font color="#000080">: </font>word<font color="#000080">;
      </font>buffer    <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4095</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      </b></font><font color="#008000"><i>{$I-}
      </i></font>seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font>finished <font color="#000080">:= </font>false<font color="#000080">;  </font>CSum <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;  </font>x <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>BlockRead<font color="#000080">(</font>f<font color="#000080">,</font>buffer<font color="#000080">,</font>sizeof<font color="#000080">(</font>buffer<font color="#000080">),</font>BytesRead<font color="#000080">);
      </font><font color="#FF0000"><b>while not </b></font>finished <font color="#FF0000"><b>do begin             </b></font><font color="#008000"><i>{ do the checksum calculations }
        </i></font><font color="#FF0000"><b>repeat         </b></font><font color="#008000"><i>{ until file has been read up to start of config area }
          </i></font>inc<font color="#000080">(</font>CSum<font color="#000080">,</font>buffer<font color="#000080">[</font>x <font color="#FF0000"><b>mod </b></font><font color="#800000">4096</font><font color="#000080">]);
          </font>inc<font color="#000080">(</font>x<font color="#000080">);
          </font>finished <font color="#000080">:= ((</font>x <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">) &gt;= </font>ExeData<font color="#000080">.</font>StartConst<font color="#000080">);
        </font><font color="#FF0000"><b>until </b></font><font color="#000080">((</font>x <font color="#FF0000"><b>mod </b></font><font color="#800000">4096</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>finished<font color="#000080">;
        </font><font color="#FF0000"><b>if not </b></font>finished <font color="#FF0000"><b>then                </b></font><font color="#008000"><i>{ data area has not been reached }
          </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">,</font>buffer<font color="#000080">,</font>sizeof<font color="#000080">(</font>buffer<font color="#000080">),</font>BytesRead<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>GetCheckSum <font color="#000080">:= </font>CSum<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font>assign<font color="#000080">(</font>f<font color="#000080">, </font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">));
    </font><font color="#008000"><i>{$I-} </i></font>Reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>with </b></font>ExeData <font color="#FF0000"><b>do begin
      if </b></font>FirstTime <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>IOResult <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font>Seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);                  </font><font color="#008000"><i>{ this location has the executable size }
        </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">,</font>tbuff<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
        </font>ExeSize <font color="#000080">:= </font>tbuff<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]+(</font>pred<font color="#000080">(</font>tbuff<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">9</font><font color="#000080">);
        </font>seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">8</font><font color="#000080">);                                   </font><font color="#008000"><i>{  get the header size }
        </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">,</font>hsize<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
        </font>FirstTime <font color="#000080">:= </font>false<font color="#000080">;
        </font>StartConst <font color="#000080">:= </font>longint<font color="#000080">(</font>hsize<font color="#000080">+</font>Seg<font color="#000080">(</font>ExeData<font color="#000080">)-</font>PrefixSeg<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4 </font><font color="#000080">+
                      </font>Ofs<font color="#000080">(</font>ExeData<font color="#000080">) - </font><font color="#800000">256</font><font color="#000080">;
        </font>CheckSum <font color="#000080">:= </font>GetCheckSum<font color="#000080">;
        </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>StartConst<font color="#000080">);
        </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">,</font>ExeData<font color="#000080">,</font>sizeof<font color="#000080">(</font>ExeData<font color="#000080">));
        </font>seek<font color="#000080">(</font>f<font color="#000080">,</font>FileSize<font color="#000080">(</font>f<font color="#000080">));
        </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">,</font>StartConst<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
      </font><font color="#FF0000"><b>end
      else
        if </b></font>GetCheckSum <font color="#000080">&lt;&gt; </font>CheckSum <font color="#FF0000"><b>then begin
          </b></font>writeln<font color="#000080">;
          </font>writeln<font color="#000080">(</font><font color="#800000">#7</font><font color="#000080">,</font><font color="#800000">#7</font><font color="#000080">,</font><font color="#800000">'Program file has been UNLAWFULLY modified!'</font><font color="#000080">,</font><font color="#800000">#7</font><font color="#000080">,</font><font color="#800000">#7</font><font color="#000080">);
          </font>writeln<font color="#000080">;
          </font>writeln<font color="#000080">(</font><font color="#800000">'It may have a Virus attached or someone may have made'</font><font color="#000080">);
          </font>writeln<font color="#000080">(</font><font color="#800000">'an attempt to HACK it. You should check your system for'</font><font color="#000080">);
          </font>writeln<font color="#000080">(</font><font color="#800000">'virus'' before continuing....'</font><font color="#000080">);
          </font>writeln<font color="#000080">;
          </font>writeln<font color="#000080">(</font><font color="#800000">'Please reinstall the .EXE file from the original archive.'</font><font color="#000080">);
          </font>writeln<font color="#000080">(</font><font color="#800000">'Aborting....'</font><font color="#000080">);
          </font>halt<font color="#000080">(</font><font color="#800000">255</font><font color="#000080">);
        </font><font color="#FF0000"><b>end
        else
          begin
            </b></font>writeln<font color="#000080">;
            </font>writeln<font color="#000080">(</font><font color="#800000">'Integrity Validated.'</font><font color="#000080">);
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ with }
    </i></font>Close<font color="#000080">(</font>f<font color="#000080">); </font><font color="#008000"><i>{$I+}
    </i></font><font color="#FF0000"><b>if </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'Unable to initialise program'</font><font color="#000080">);
      </font>halt<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ InitConstants }

</i></font><font color="#FF0000"><b>procedure </b></font>Write2Exec<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>data<font color="#000080">; </font>size<font color="#000080">: </font>word<font color="#000080">);
 </font><font color="#008000"><i>{ writes a new typed constant into the executable file. }
  </i></font><font color="#FF0000"><b>var
     </b></font>f          <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>assign<font color="#000080">(</font>f<font color="#000080">, </font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">));
    </font><font color="#008000"><i>{$I-} </i></font>Reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>longint<font color="#000080">(</font>ExeData<font color="#000080">.</font>Hsize<font color="#000080">+</font>Seg<font color="#000080">(</font>data<font color="#000080">)-</font>PrefixSeg<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4 </font><font color="#000080">+ </font>Ofs<font color="#000080">(</font>data<font color="#000080">)- </font><font color="#800000">256</font><font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">,</font>data<font color="#000080">,</font>size<font color="#000080">);
    </font>Close<font color="#000080">(</font>f<font color="#000080">); </font><font color="#008000"><i>{$I+}
    </i></font><font color="#FF0000"><b>if </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Write2Exec }

</i></font><font color="#FF0000"><b>begin
  </b></font>writeln<font color="#000080">(</font><font color="#800000">'Please Standby...'</font><font color="#000080">);
  </font>InitConstants<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p></body>
</html>
