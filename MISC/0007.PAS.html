<html>
<head><title> "Doing a LONGJUMP in memory" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Unit </b></font>LongJump<font color="#000080">;

</font><font color="#008000"><i>{ This Unit permits a long jump from deeply nested Procedures/Functions back }
{ to a predetermined starting point.                                         }

{ Whilst the purists may shudder at such a practice there are times when such}
{ an ability can be exceedingly useful.  An example of such a time is in a   }
{ BBS Program when the carrier may be lost unexpectedly whilst a user is on  }
{ line and the requirement is to &quot;back out&quot; to the initialisation reoutines  }
{ at the start of the Program.                                               }

{ to use the facility, it is required that a call be made to the SetJump     }
{ Function at the point to where you wish the execution to resume after a    }
{ long jump. When the time comes to return to that point call FarJump.       }

{ if you are an inexperienced Programmer, I do not recommend that this Unit  }
{ be used For other than experimentation.  Usually there are better ways to  }
{ achieve what you want to do by proper planning and structuring.  It is     }
{ rare to find a well written Program that will need such and ability.       }

</i></font><font color="#FF0000"><b>Interface

Const
  </b></font>normal <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">;                         </font><font color="#008000"><i>{ return was not from a LongJump call }
</i></font><font color="#FF0000"><b>Type
  </b></font>jumpType <font color="#000080">= </font><font color="#FF0000"><b>Record                        </b></font><font color="#008000"><i>{ the data need For a return jump }
                </i></font>bp<font color="#000080">,</font>sp<font color="#000080">,</font>cs<font color="#000080">,</font>ip <font color="#000080">: </font>Word<font color="#000080">;
             </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>SetJump<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>JumpData <font color="#000080">: </font>jumpType<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>FarJump<font color="#000080">(</font>JumpData <font color="#000080">: </font>jumpType<font color="#000080">; </font>IDInfo <font color="#000080">: </font>Integer<font color="#000080">);

</font><font color="#FF0000"><b>Implementation

Type
  </b></font>WordPtr <font color="#000080">= ^</font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SetJump<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>JumpData <font color="#000080">: </font>jumpType<font color="#000080">): </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin                     </b></font><font color="#008000"><i>{ store the return address (the old bp register) }
    </i></font>JumpData<font color="#000080">.</font>bp <font color="#000080">:= </font>WordPtr<font color="#000080">(</font>ptr<font color="#000080">(</font>SSeg<font color="#000080">,</font>SPtr<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">))^;
    </font>JumpData<font color="#000080">.</font>ip <font color="#000080">:= </font>WordPtr<font color="#000080">(</font>ptr<font color="#000080">(</font>SSeg<font color="#000080">,</font>SPtr<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">))^;
    </font>JumpData<font color="#000080">.</font>cs <font color="#000080">:= </font>WordPtr<font color="#000080">(</font>ptr<font color="#000080">(</font>SSeg<font color="#000080">,</font>SPtr<font color="#000080">+</font><font color="#800000">6</font><font color="#000080">))^;
    </font>JumpData<font color="#000080">.</font>SP <font color="#000080">:= </font>SPtr<font color="#000080">;
    </font>SetJump <font color="#000080">:= </font>normal<font color="#000080">;                </font><font color="#008000"><i>{ show that this is not a FarJump call }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ SetJump }

</i></font><font color="#FF0000"><b>Procedure </b></font>FarJump<font color="#000080">(</font>JumpData <font color="#000080">: </font>jumpType<font color="#000080">; </font>IDInfo <font color="#000080">: </font>Integer <font color="#000080">);
  </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{ change the return address of the calling routine of the stack so that  }
    { a return can be made to the caller of SetJump                          }
    { Use IDInfo as an identifier of the routine the jump occurred from      }
    </i></font>WordPtr<font color="#000080">(</font>ptr<font color="#000080">(</font>SSeg<font color="#000080">,</font>JumpData<font color="#000080">.</font>SP<font color="#000080">))^   := </font>JumpData<font color="#000080">.</font>bp<font color="#000080">;
    </font>WordPtr<font color="#000080">(</font>ptr<font color="#000080">(</font>SSeg<font color="#000080">,</font>JumpData<font color="#000080">.</font>SP<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">))^ := </font>JumpData<font color="#000080">.</font>ip<font color="#000080">;
    </font>WordPtr<font color="#000080">(</font>ptr<font color="#000080">(</font>SSeg<font color="#000080">,</font>JumpData<font color="#000080">.</font>SP<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">))^ := </font>JumpData<font color="#000080">.</font>cs<font color="#000080">;
    </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$8b</font><font color="#000080">/</font><font color="#800000">$46</font><font color="#000080">/</font><font color="#800000">$06</font><font color="#000080">);                                     </font><font color="#008000"><i>{ mov ax,[bp+6] }
    </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$8b</font><font color="#000080">/</font><font color="#800000">$ae</font><font color="#000080">/</font><font color="#800000">$fa</font><font color="#000080">/</font><font color="#800000">$ff</font><font color="#000080">);                                 </font><font color="#008000"><i>{ mov bp,[bp-6] }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ FarJump }

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.  </font><font color="#008000"><i>{ LongJump }


</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p></body>
</html>
