<html>
<head><title> "Writing To EXE File" by DAVID DOTY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; How are you saaving the CFG into the .EXE?? Mind posting some code that wil
&gt; save the CFG to the EXE?(When you get all your bugs fixed!)

I use these routines in my self-modifying .EXE's. They work pretty good.
}

</i></font><font color="#FF0000"><b>Unit </b></font>WritExec<font color="#000080">;

  </font><font color="#008000"><i>{ ==================================================================

                               Unit: WritExec
                             Author: David Doty
                                     Skipjack Software
                                     Columbia, Maryland
               CompuServe User I.D.: 76244,1043

    This Unit is based on a previously published Program:

                            Program: AutoInst v2.0
                             Author: David Dubois
                                     Zelkop Software
                                     Halifax, Nova Scotia
               CompuServe User I.D.: 71401,747
                  Date last revised: 1988.04.24

    ==================================================================

    This source code is released to the public domain.  if further changes
    are made, please include the above credits in the distributed code.

    This Unit allows a Program to change the value of a Typed Constant in its
    own .EXE File.  When the Program is run again, the data will be initialized
    to the new value.  No external configuration Files are necessary.

    Uses

    Examples of the usefulness of this technique would be:

    o   A Program that allows the user to change default display colors.

    o   A Program that keeps track of a passWord that the user can change.

    HOW IT WORKS

    You don't have to understand all the details in order to use this
    technique, but here they are.

    The data to be changed must be stored in a TurboPascal Typed
    Constant.  In all effect, a Typed Constant is actually a pre-
    initialized Variable.  It is always stored in the Program's Data
    Segment.  The data can be of any Type.

    First, the Procedure finds the .EXE File by examining the Dos command
    line, stored With the copy of the Dos environment For the Program.  This
    allows the Program to find itself no matter where is resides on disk and
    no matter how its name is changed by the user.

    The unTyped File is opened With a Record size of 1. This allows us
    to read or Write a String of Bytes using BlockRead and BlockWrite.

    As documented in the Dos Technical Reference, the size of the .EXE
    header, in paraGraphs (a paraGraph is 16 Bytes), is stored as a
    two-Byte Word at position 8 of the File.  This is read into the
    Variable HeaderSize.

    The next step is to find the position of the Typed Constant in the
    .EXE File. This requires an understanding of the Turbo Pascal 4.0
    memory map, documented on the first and second pages of the Inside
    Turbo Pascal chapter. (That's chapter 26, pages 335 and 336 in my
    manual.)

    First, find the address in memory where the Typed Constant is
    stored. This can be done in Turbo Pascal by using the Seg and Ofs
    Functions. Next find the segment of the PSP (Program segment
    prefix). This should always be the value returned by PrefixSeg.
    That will mark the beginning of the Program in memory. The
    position of the Typed Constant in the .EXE image should be the
    number of Bytes between these two places in memory. But ...

    But, two corrections must be made. First, the PSP is not stored in
    the .EXE File. As mentioned on page 335, the PSP is always 256
    Bytes. We must subtract that out. Secondly, there is the .EXE File
    header. The size of this has already been read in and must be
    added in to our calculations.

    Once the position has been determined, the data stored in the
    Typed Constant is written in one fell swoop using a BlockWrite.
    This replaces the original data, so that the next time the Program
    is run, the new values will used.

    LIMITATIONS

    You cannot use MicroSoft's EXEPACK on the .EXE File, or any other
    packing method I know of. This may change the position, or even
    the size of the Typed Constant in the File image.

    NOTES

    Since Typed Constants are always stored in the data segment, the
    Function call to Seg( ObjectToWrite ) can be replaced With DSeg. I
    prefer using Seg since it is more descriptive.

    One might think that Cseg can used as an alternative to using
    PrefixSeg and subtracting 256. This will work only if the code
    resides in the main Program. If, on the other hand, the code is
    used in a Unit, PrefixSeg must be used as described here. You
    might as well use PrefixSeg and save yourself some headaches.

    if you have any comments or questions we would be glad to hear
    them. if you're on CompuServe, you can EasyPlex a letter to
    76244,1043 or 71401,747. Or leave a message on the Borland Programmer's A
    Forum (GO BPROGA). Or, you can Write to

                         Skipjack Software
                         P. O. Box 61
                         Simpsonville Maryland 21150

                            or

                         Zelkop Software
                         P.O. Box 5177
                         Armdale, N.S.
                         Canada
                         B3L 4M7

    ==================================================================}


</i></font><font color="#FF0000"><b>Interface

Function </b></font>GetExecutableName <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#008000"><i>{  This Function returns the full drive, path, and File name of the application
   Program that is running.  This Function is of more general interest than
   just For writing into the EXE File.

   NOTE: THIS Function WILL ONLY WORK UNDER Dos 3.X + !!! }

</i></font><font color="#FF0000"><b>Function </b></font>WriteToExecutable<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>ObjectToWrite<font color="#000080">; </font>ObjectSize <font color="#000080">: </font>Word<font color="#000080">) : </font>Integer<font color="#000080">;
</font><font color="#008000"><i>{  This Procedure modifies the EXE File on disk to contain changes to Typed
   Constants.  NOTE - the Object MUST be a Typed Constant.  It may be found
   in any part of the Program (i.e., main Program or any Unit).  The call is
   made by unTyped address, to allow any kind of Object to be written.  The
   Function returns the Dos error code from the I/O operation that failed
   (if any did); if all operations were successful, the Function returns 0. }

</i></font><font color="#FF0000"><b>Implementation

Function </b></font>GetExecutableName <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Type
  </b></font>Environment <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">32766</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
</font><font color="#FF0000"><b>Const
  </b></font>NullChar <font color="#000080">: </font>Char <font color="#000080">= </font><font color="#800000">#0</font><font color="#000080">;
  </font>SearchFailed <font color="#000080">= </font><font color="#800000">$FFFF</font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>MyEnviron   <font color="#000080">: ^</font>Environment<font color="#000080">;
  </font>Loop        <font color="#000080">: </font>Word<font color="#000080">;
  </font>TempWord    <font color="#000080">: </font>Word<font color="#000080">;
  </font>EnvironPos  <font color="#000080">: </font>Word<font color="#000080">;
  </font>FilenamePos <font color="#000080">: </font>Word<font color="#000080">;
  </font>TempString  <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{ Function GetExecutableName }
  { Get Pointer to Dos environment }
  </i></font>MyEnviron <font color="#000080">:= </font>Ptr<font color="#000080">(</font>MemW<font color="#000080">[</font>PrefixSeg <font color="#000080">: </font><font color="#800000">$2C</font><font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);

  </font><font color="#008000"><i>{ Look For end of environment }
  </i></font>EnvironPos <font color="#000080">:= </font>SearchFailed<font color="#000080">;
  </font>Loop <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#FF0000"><b>While </b></font>Loop <font color="#000080">&lt;= </font><font color="#800000">32767 </font><font color="#FF0000"><b>DO
  begin
    if </b></font>MyEnviron<font color="#000080">^[ </font>Loop <font color="#000080">] = </font>NullChar <font color="#FF0000"><b>then
      if </b></font>MyEnviron<font color="#000080">^[ </font>Loop <font color="#000080">+ </font><font color="#800000">1 </font><font color="#000080">] = </font>NullChar <font color="#FF0000"><b>then
      begin </b></font><font color="#008000"><i>{ found two nulls - this is end of environment }
        </i></font>EnvironPos <font color="#000080">:= </font>Loop<font color="#000080">;
        </font>Loop <font color="#000080">:= </font><font color="#800000">32767
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ found two nulls }
    </i></font>Inc<font color="#000080">(</font>Loop<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ While Loop }

  </i></font><font color="#FF0000"><b>if </b></font>EnvironPos <font color="#000080">= </font>SearchFailed <font color="#FF0000"><b>then
    </b></font>GetExecutableName <font color="#000080">:= </font><font color="#800000">''
  </font><font color="#FF0000"><b>else
  begin </b></font><font color="#008000"><i>{ found end of environment - now look For path/File of exec }
    </i></font>EnvironPos  <font color="#000080">:= </font>EnvironPos <font color="#000080">+ </font><font color="#800000">4</font><font color="#000080">;
    </font>FilenamePos <font color="#000080">:= </font>SearchFailed<font color="#000080">;
    </font>TempWord    <font color="#000080">:= </font>EnvironPos<font color="#000080">;
    </font>Loop <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

    </font><font color="#FF0000"><b>While </b></font>Loop <font color="#000080">&lt;= </font><font color="#800000">127 </font><font color="#FF0000"><b>DO
    begin
      if </b></font>MyEnviron<font color="#000080">^[</font>TempWord<font color="#000080">] = </font>NullChar <font color="#FF0000"><b>then
      begin </b></font><font color="#008000"><i>{ found a null - this is end of path/File of exec }
        </i></font>FilenamePos <font color="#000080">:= </font>Loop<font color="#000080">;
        </font>Loop <font color="#000080">:= </font><font color="#800000">127
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ found a null }
      </i></font>Inc<font color="#000080">(</font>Loop<font color="#000080">);
      </font>Inc<font color="#000080">(</font>TempWord<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ While Loop }

    </i></font><font color="#FF0000"><b>if </b></font>FilenamePos <font color="#000080">= </font>SearchFailed <font color="#FF0000"><b>then
      </b></font>GetExecutableName <font color="#000080">:= </font><font color="#800000">''
    </font><font color="#FF0000"><b>else
    begin </b></font><font color="#008000"><i>{ found executable name - move into return String }
      </i></font>TempString<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>Chr<font color="#000080">(</font>FilenamePos<font color="#000080">);
      </font>Move<font color="#000080">(</font>MyEnviron<font color="#000080">^[</font>EnvironPos<font color="#000080">], </font>TempString<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>FilenamePos<font color="#000080">);
      </font>GetExecutableName <font color="#000080">:= </font>TempString<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ found executable name }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ found environment end }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Function GetExecutableName }


</i></font><font color="#FF0000"><b>Function </b></font>WriteToExecutable<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>ObjectToWrite<font color="#000080">; </font>ObjectSize <font color="#000080">: </font>Word <font color="#000080">) : </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Const
  </b></font>PrefixSize <font color="#000080">= </font><font color="#800000">256</font><font color="#000080">; </font><font color="#008000"><i>{ number of Bytes in the Program Segment Prefix }
</i></font><font color="#FF0000"><b>Var
  </b></font>Executable <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>HeaderSize <font color="#000080">: </font>Word<font color="#000080">;
  </font>ErrorCode  <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>Executable<font color="#000080">, </font>GetExecutableName<font color="#000080">);
  </font><font color="#008000"><i>{$I-}
  </i></font>Reset<font color="#000080">(</font>Executable<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>ErrorCode <font color="#000080">:= </font>IOResult<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>ErrorCode <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin </b></font><font color="#008000"><i>{ seek position of header size in EXE File }
    </i></font>Seek<font color="#000080">(</font>Executable<font color="#000080">, </font><font color="#800000">8</font><font color="#000080">);
    </font>ErrorCode <font color="#000080">:= </font>IOResult<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ seek header }

  </i></font><font color="#FF0000"><b>if </b></font>ErrorCode <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin </b></font><font color="#008000"><i>{ read header size in EXE File }
    </i></font>BlockRead<font color="#000080">(</font>Executable<font color="#000080">, </font>HeaderSize<font color="#000080">, </font>SizeOf<font color="#000080">(</font>HeaderSize<font color="#000080">));
    </font>ErrorCode <font color="#000080">:= </font>IOResult<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ read header }

  </i></font><font color="#FF0000"><b>if </b></font>ErrorCode <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin </b></font><font color="#008000"><i>{ seek position of Object in EXE File }
    </i></font>Seek<font color="#000080">(</font>Executable<font color="#000080">,
         </font>LongInt<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">) * (</font>HeaderSize <font color="#000080">+ </font>Seg<font color="#000080">(</font>ObjectToWrite<font color="#000080">) - </font>PrefixSeg<font color="#000080">) +
         </font>Ofs<font color="#000080">(</font>ObjectToWrite<font color="#000080">) - </font>PrefixSize<font color="#000080">);
    </font>ErrorCode <font color="#000080">:= </font>IOResult<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Seek Object position in File }

  </i></font><font color="#FF0000"><b>if </b></font>ErrorCode <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin </b></font><font color="#008000"><i>{ Write new passWord in EXE File }
    </i></font>BlockWrite<font color="#000080">(</font>Executable<font color="#000080">, </font>ObjectToWrite<font color="#000080">, </font>ObjectSize<font color="#000080">);
    </font>ErrorCode <font color="#000080">:= </font>IOResult<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Write new passWord }

  </i></font>Close<font color="#000080">(</font>Executable<font color="#000080">);
  </font>WriteToExecutable <font color="#000080">:= </font>ErrorCode<font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Function WriteToExecutable }

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">. </font><font color="#008000"><i>{ Unit WritExec }
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p></body>
</html>
