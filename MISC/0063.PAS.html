<html>
<head><title> "TRAP8087 Errors" by STEVE SCHAFER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0063.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here is how to trap errors on the 80X87.  I am not sure yet how it works with
the FP emulation library, but if you have a math coprocessor, you can trap
any FP exceptions:
}

{$N+,E+}
</i></font><font color="#FF0000"><b>program </b></font>FloatTest<font color="#000080">;
</font><font color="#008000"><i>{ compliments of Steve Schafer, Compuserve address 76711, 522 }
</i></font><font color="#FF0000"><b>const
  </b></font>feInvalidOp  <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;
  </font>feDenormalOp <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;
  </font>feZeroDivide <font color="#000080">= </font><font color="#800000">$04</font><font color="#000080">;
  </font>feOverFlow   <font color="#000080">= </font><font color="#800000">$08</font><font color="#000080">;
  </font>feUnderFlow  <font color="#000080">= </font><font color="#800000">$10</font><font color="#000080">;
  </font>fePrecision  <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetFpuExceptionMask <font color="#000080">(</font>MaskBits<font color="#000080">: </font>Byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Masks floating point exceptions so that they won't cause a crash }
</i></font><font color="#FF0000"><b>var
  </b></font>Temp<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">fstcw Temp
  fwait
  mov ax, Temp
  and al, $F0
  or al, MaskBits
  mov Temp, ax
  fldcw Temp
  fwait
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>GetFpuStatus<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ determines the status of a previous FP operation }
</i></font><font color="#FF0000"><b>var
  </b></font>Temp<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">fstsw Temp
  fwait
  mov ax, Temp
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>WriteStatus<font color="#000080">(</font>Status<font color="#000080">: </font>Byte<font color="#000080">);
</font><font color="#008000"><i>{ This procedure is not necessary, it simply illustrates how to determine
  what happenend }
</i></font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>Status <font color="#FF0000"><b>and </b></font>fePrecision<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Write<font color="#000080">(</font><font color="#800000">'P'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>Write<font color="#000080">(</font><font color="#800000">'-'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Status <font color="#FF0000"><b>and </b></font>feUnderflow<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Write<font color="#000080">(</font><font color="#800000">'U'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>Write<font color="#000080">(</font><font color="#800000">'-'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Status <font color="#FF0000"><b>and </b></font>feOverflow<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Write<font color="#000080">(</font><font color="#800000">'O'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>Write<font color="#000080">(</font><font color="#800000">'-'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Status <font color="#FF0000"><b>and </b></font>feZeroDivide<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Write<font color="#000080">(</font><font color="#800000">'Z'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>Write<font color="#000080">(</font><font color="#800000">'-'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Status <font color="#FF0000"><b>and </b></font>feDenormalOp<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Write<font color="#000080">(</font><font color="#800000">'D'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>Write<font color="#000080">(</font><font color="#800000">'-'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Status <font color="#FF0000"><b>and </b></font>feInvalidOp<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Write<font color="#000080">(</font><font color="#800000">'I'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else </b></font>Write<font color="#000080">(</font><font color="#800000">'-'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>X<font color="#000080">,</font>Y<font color="#000080">: </font>Single<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>SetFPUExceptionMask <font color="#000080">(</font>feInvalidOp <font color="#000080">+ </font>feDenormalOp <font color="#000080">+ </font>feZeroDivide
                     <font color="#000080">+ </font>feOverflow  <font color="#000080">+ </font>feUnderflow  <font color="#000080">+ </font>fePrecision<font color="#000080">);

  </font>X<font color="#000080">:= -</font><font color="#800000">1.0</font><font color="#000080">;
  </font>Y<font color="#000080">:= </font>Sqrt<font color="#000080">(</font>X<font color="#000080">);  </font><font color="#008000"><i>{ Invalid Operation }
  </i></font>WriteStatus<font color="#000080">(</font>GetFPUStatus<font color="#000080">);  
  </font>Writeln<font color="#000080">(</font><font color="#800000">'  '</font><font color="#000080">, </font>Y<font color="#000080">:</font><font color="#800000">12</font><font color="#000080">, </font><font color="#800000">'  '</font><font color="#000080">, </font>X<font color="#000080">:</font><font color="#800000">12</font><font color="#000080">);

  </font>X<font color="#000080">:= </font><font color="#800000">0.0</font><font color="#000080">;
  </font>Y<font color="#000080">:= </font><font color="#800000">1.0</font><font color="#000080">;
  </font>Y<font color="#000080">:= </font>Y<font color="#000080">/</font>X<font color="#000080">;  </font><font color="#008000"><i>{ divide by Zero }
  </i></font>WriteStatus<font color="#000080">(</font>GetFPUStatus<font color="#000080">);
  </font>Writeln<font color="#000080">(</font><font color="#800000">'  '</font><font color="#000080">, </font>Y<font color="#000080">:</font><font color="#800000">12</font><font color="#000080">, </font><font color="#800000">'  '</font><font color="#000080">, </font>X<font color="#000080">:</font><font color="#800000">12</font><font color="#000080">);

  </font>X<font color="#000080">:= </font><font color="#800000">1.0E</font><font color="#000080">-</font><font color="#800000">34</font><font color="#000080">;
  </font>Y<font color="#000080">:= </font><font color="#800000">1.0E</font><font color="#000080">-</font><font color="#800000">34</font><font color="#000080">;
  </font>Y<font color="#000080">:= </font>Y<font color="#000080">*</font>X<font color="#000080">;  </font><font color="#008000"><i>{ Underflow }
  </i></font>WriteStatus<font color="#000080">(</font>GetFPUStatus<font color="#000080">);
  </font>Writeln<font color="#000080">(</font><font color="#800000">'  '</font><font color="#000080">, </font>Y<font color="#000080">:</font><font color="#800000">12</font><font color="#000080">, </font><font color="#800000">'  '</font><font color="#000080">, </font>X<font color="#000080">:</font><font color="#800000">12</font><font color="#000080">);

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0063.PAS">Original</a><b>]</b></p></body>
</html>
