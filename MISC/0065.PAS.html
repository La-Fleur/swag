<html>
<head><title> "BP Bug" by ANDRES CVITKOVICH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0065.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
I'm not sure if the following bug in Contains() of STDDLG.PAS has been fixed
in 7.01 (since I still don't have it) so I decided to post it.

STDDLG.PAS, function Contains()
}
{ Contains returns true if S1 contains any characters in S2 }
</i></font><font color="#FF0000"><b>function Contains</b></font><font color="#000080">(</font>S1<font color="#000080">, </font>S2 <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>near</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">PUSH    DS
  CLD
  LDS     SI, S1
  LES     DI, S2
  MOV     DX, DI
&gt; INC     DX           </font><font color="#008000"><i>{ DX still pointed at len byte }
  </i></font><font color="#FF00FF">XOR     AH, AH
  LODSB
  MOV     BX, AX
  OR      BX, BX
  JZ      @@2
  MOV     AL, ES:[DI]
  XCHG    AX, CX
 @@1:
  PUSH    CX
  MOV     DI, DX
  LODSB
  REPNE   SCASB
  POP     CX
  JE      @@3
  DEC     BX
  JNZ     @@1
 @@2:
  XOR     AL, AL
  JMP     @@4
 @@3:
  MOV     AL, 1
 @@4:
  POP     DS
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{
BUT: fixing the bug reveals another bug  &lt;g&gt;

The function is used to determine whether a filename or path contains illegal
characters or not. The last character in the constant &quot;IllegalChars&quot; is the
backslash &quot;\&quot; that would have been ignored by the buggy version of Contains().
However, the corrected version returns TRUE for Contains('\MYPATH\',
IllegalChars) (as it's supposed to).  Since a path name created by FSplit
normally contains a &quot;\&quot; the filename is considered as FALSE by ValidFileName.
My solution is to add a second const named IllegalCharsFN for illegal chars in
the filename (but legal chars in path names) currently just containing '\'.
Furthermore, I removed space ' ' from the list of illegal characters (since it
isn't an illegal char!) and added '/' instead. But have a look at my final
correction suggestion:
}

</i></font><font color="#FF0000"><b>function </b></font>ValidFileName<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>FileName <font color="#000080">: </font>PathStr<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>IllegalCharsFN <font color="#000080">= </font><font color="#800000">'\'</font><font color="#000080">;
  </font>IllegalChars   <font color="#000080">= </font><font color="#800000">';,=+&lt;&gt;|&quot;[]/'</font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Dir  <font color="#000080">: </font>DirStr<font color="#000080">;
  </font>Name <font color="#000080">: </font>NameStr<font color="#000080">;
  </font>Ext  <font color="#000080">: </font>ExtStr<font color="#000080">;

  </font><font color="#008000"><i>{ Contains returns true if S1 contains any characters in S2 }
  </i></font><font color="#FF0000"><b>function Contains</b></font><font color="#000080">(</font>S1<font color="#000080">, </font>S2 <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>near</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
     </b></font><font color="#008000"><i>{...see above...}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>ValidFileName <font color="#000080">:= </font>True<font color="#000080">;
  </font>FSplit<font color="#000080">(</font>FileName<font color="#000080">, </font>Dir<font color="#000080">, </font>Name<font color="#000080">, </font>Ext<font color="#000080">);
  </font><font color="#FF0000"><b>if not </b></font><font color="#000080">((</font>Dir <font color="#000080">= </font><font color="#800000">''</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>PathValid<font color="#000080">(</font>Dir<font color="#000080">)) </font><font color="#FF0000"><b>or
     Contains</b></font><font color="#000080">(</font>Name<font color="#000080">, </font>IllegalChars <font color="#000080">+ </font>IllegalCharsFN<font color="#000080">) </font><font color="#FF0000"><b>or
     Contains</b></font><font color="#000080">(</font>Dir<font color="#000080">, </font>IllegalChars<font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font>ValidFileName <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0065.PAS">Original</a><b>]</b></p></body>
</html>
