<html>
<head><title> "HACKING in Pascal" by KAI ROHRBACHER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0049.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
KAI ROHRBACHER

I'm looking For a way to tell BorlandPascal that an allocated _data_
block should now be treated as an executable routine (in Protected Mode).
Here is a little example to show the problem; it runs w/o problems in
Real Mode, but results in a GP-fault (despite the use of the alias-selector!):
}

</i></font><font color="#FF0000"><b>Program </b></font>SelfModify<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>AnzNOPs <font color="#000080">= </font><font color="#800000">10</font><font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>TTestProc <font color="#000080">= </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>code <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>Run  <font color="#000080">: </font>TTestProc<font color="#000080">;
  </font>pb   <font color="#000080">: ^</font>Byte<font color="#000080">;
  </font>pw   <font color="#000080">: ^</font>Word <font color="#FF0000"><b>Absolute </b></font>pb<font color="#000080">;
  </font>i    <font color="#000080">: </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>GetMem<font color="#000080">(</font>code<font color="#000080">, </font>AnzNOPs <font color="#000080">+ </font><font color="#800000">7</font><font color="#000080">); </font><font color="#008000"><i>{7 Bytes For proc header &amp; end}
  </i></font>pb <font color="#000080">:= </font>code<font color="#000080">; </font><font color="#008000"><i>{pb = ^start of routine to build}

  </i></font>pb<font color="#000080">^ := </font><font color="#800000">$55</font><font color="#000080">;
  </font>INC<font color="#000080">(</font>pb<font color="#000080">);   </font><font color="#008000"><i>{push bp}
  </i></font>pw<font color="#000080">^ := </font><font color="#800000">$E589</font><font color="#000080">;
  </font>INC<font color="#000080">(</font>pw<font color="#000080">); </font><font color="#008000"><i>{mov bp,sp}
  </i></font><font color="#FF0000"><b>For </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>AnzNOPs <font color="#FF0000"><b>DO
  begin
    </b></font>pb<font color="#000080">^ := </font><font color="#800000">$90</font><font color="#000080">;
    </font>INC<font color="#000080">(</font>pb<font color="#000080">); </font><font color="#008000"><i>{nop's}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>pb<font color="#000080">^ := </font><font color="#800000">$5D</font><font color="#000080">;
  </font>INC<font color="#000080">(</font>pb<font color="#000080">);   </font><font color="#008000"><i>{pop bp}
  </i></font>pb<font color="#000080">^ := </font><font color="#800000">$CA</font><font color="#000080">;
  </font>INC<font color="#000080">(</font>pb<font color="#000080">);
  </font>pw<font color="#000080">^ := </font><font color="#800000">$0000</font><font color="#000080">;          </font><font color="#008000"><i>{retf 0}

  {$IFDEF DPMI}
  </i></font>WriteLN<font color="#000080">(</font><font color="#800000">'Protected Mode'</font><font color="#000080">);
  </font>code<font color="#000080">:= </font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>code<font color="#000080">) + </font>SelectorInc<font color="#000080">, </font>Ofs<font color="#000080">(</font>code<font color="#000080">)); </font><font color="#008000"><i>{alias-selector}
  {$else}
  </i></font>WriteLN<font color="#000080">(</font><font color="#800000">'Real Mode'</font><font color="#000080">);
  </font><font color="#008000"><i>{$endIF}

  </i></font>Run <font color="#000080">:= </font>TTestProc<font color="#000080">(</font>code<font color="#000080">); </font><font color="#008000"><i>{that's a Type-cast!}
  </i></font>Run<font color="#000080">; </font><font color="#008000"><i>{call routine}

  </i></font>FreeMem<font color="#000080">(</font>code<font color="#000080">, </font>AnzNOPs <font color="#000080">+ </font><font color="#800000">7</font><font color="#000080">);
  </font>WriteLN<font color="#000080">(</font><font color="#800000">'Alive and kicking!'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0049.PAS">Original</a><b>]</b></p></body>
</html>
