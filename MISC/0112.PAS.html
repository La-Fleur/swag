<html>
<head><title> "Patch TP's Runtime Library" by GEORGE KALEMANIS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0112.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
George Kalemanis &lt;usr5086a@tso.uc.edu&gt;
PATCH.PAS - Patching Turbo's Runtime Library On The Fly
}

</i></font><font color="#FF0000"><b>Unit </b></font>patch<font color="#000080">;

</font><font color="#FF0000"><b>Interface

</b></font><font color="#008000"><i>{$R-,S-,I- }

</i></font><font color="#FF0000"><b>Function </b></font>CPUOk <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>InLine</b></font><font color="#000080">(
           </font><font color="#008000"><i>{ Sort out 8086/8088 from 80286/i386/i486 }
  </i></font><font color="#800000">$31</font><font color="#000080">/</font><font color="#800000">$C0</font><font color="#000080">/               </font><font color="#008000"><i>{      XOR   AX, AX     }
  </i></font><font color="#800000">$50</font><font color="#000080">/                   </font><font color="#008000"><i>{      PUSH  AX         }
  </i></font><font color="#800000">$9D</font><font color="#000080">/                   </font><font color="#008000"><i>{      POPF             }
  </i></font><font color="#800000">$9C</font><font color="#000080">/                   </font><font color="#008000"><i>{      PUSHF            }
  </i></font><font color="#800000">$58</font><font color="#000080">/                   </font><font color="#008000"><i>{      POP   AX         }
           { If the flag register holds $F000, then it is a 8086/8088 }
  </i></font><font color="#800000">$25</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$F0</font><font color="#000080">/           </font><font color="#008000"><i>{      AND   AX, $F000  }
  </i></font><font color="#800000">$3D</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$F0</font><font color="#000080">/           </font><font color="#008000"><i>{      CMP   AX, $F000  }
  </i></font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">/               </font><font color="#008000"><i>{      JE    @@1        }
           { Sort out 80286 from 80386/80486 }
  </i></font><font color="#800000">$B8</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$F0</font><font color="#000080">/           </font><font color="#008000"><i>{      MOV   AX, $F000  }
  </i></font><font color="#800000">$50</font><font color="#000080">/                   </font><font color="#008000"><i>{      PUSH  AX         }
  </i></font><font color="#800000">$9D</font><font color="#000080">/                   </font><font color="#008000"><i>{      POPF             }
  </i></font><font color="#800000">$9C</font><font color="#000080">/                   </font><font color="#008000"><i>{      PUSHF            }
  </i></font><font color="#800000">$58</font><font color="#000080">/                   </font><font color="#008000"><i>{      POP   AX         }
           { If the flag register &lt;&gt; 2, then it is a 80286 }
  </i></font><font color="#800000">$25</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$F0</font><font color="#000080">/           </font><font color="#008000"><i>{      AND   AX, $F000  }
  </i></font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$04</font><font color="#000080">/               </font><font color="#008000"><i>{      JZ    @@1        }
  </i></font><font color="#800000">$B0</font><font color="#000080">/</font><font color="#800000">$01</font><font color="#000080">/               </font><font color="#008000"><i>{      MOV   AL, True   }
  </i></font><font color="#800000">$EB</font><font color="#000080">/</font><font color="#800000">$02</font><font color="#000080">/               </font><font color="#008000"><i>{      JMP   Short @@2  }
  </i></font><font color="#800000">$B0</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">);              </font><font color="#008000"><i>{ @@1: MOV   AL, False  }
                         { @@2: }
</i></font><font color="#FF0000"><b>Implementation

Const
  </b></font>dummy        <font color="#000080">: </font>LongInt <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>SystemProc   <font color="#000080">= </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;
  </font>SystemCall   <font color="#000080">= ^</font>SystemProc<font color="#000080">;      </font><font color="#008000"><i>{ Pointer to the caller's address }

</i></font><font color="#FF0000"><b>Var
  </b></font>CallAddr     <font color="#000080">: ^</font>SystemCall<font color="#000080">;      </font><font color="#008000"><i>{ Pointer to the procedure to be patched }

{ Copy instruction pointer of caller from the stack }

</i></font><font color="#FF0000"><b>Function </b></font>IPtr <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>InLine</b></font><font color="#000080">(
  </font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$46</font><font color="#000080">/</font><font color="#800000">$02</font><font color="#000080">);          </font><font color="#008000"><i>{      MOV   AX, [BP+2] }

{ This patch speeds up 4-byte signed integer division by 600% }

</i></font><font color="#FF0000"><b>Procedure </b></font>DivisionPatch<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>PatchCode    <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">21</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">= (
           </font><font color="#008000"><i>{ Push dividend on the stack, pop it in a 32-bits register
             To avoid division by zero errors, extend it to a quadword }
                   </i></font><font color="#800000">$52</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  DX        }
                   </i></font><font color="#800000">$50</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  AX        }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$58</font><font color="#000080">,       </font><font color="#008000"><i>{  POP   EAX       }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$99</font><font color="#000080">,       </font><font color="#008000"><i>{  CDQ             }
           { Push divisor on the stack, pop it in a 32-bit register.
             Perform the division }
                   </i></font><font color="#800000">$53</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  BX        }
                   </i></font><font color="#800000">$51</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  CX        }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$5E</font><font color="#000080">,       </font><font color="#008000"><i>{  POP   ESI       }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$FE</font><font color="#000080">,  </font><font color="#008000"><i>{  IDIV  ESI       }
           { Push remainder on the stack, pop it in 16-bits registers }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$52</font><font color="#000080">,       </font><font color="#008000"><i>{  PUSH  EDX       }
                   </i></font><font color="#800000">$59</font><font color="#000080">,            </font><font color="#008000"><i>{  POP   CX        }
                   </i></font><font color="#800000">$5B</font><font color="#000080">,            </font><font color="#008000"><i>{  POP   BX        }
           { Push quotient on the stack, pop it in 16-bits registers }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$50</font><font color="#000080">,       </font><font color="#008000"><i>{  PUSH  EAX       }
                   </i></font><font color="#800000">$58</font><font color="#000080">,            </font><font color="#008000"><i>{  POP   AX        }
                   </i></font><font color="#800000">$5A</font><font color="#000080">,            </font><font color="#008000"><i>{  POP   DX        }
                   </i></font><font color="#800000">$CB</font><font color="#000080">);           </font><font color="#008000"><i>{  RETF            }
</i></font><font color="#FF0000"><b>Begin
  </b></font>CallAddr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>CSeg<font color="#000080">, </font>IPtr<font color="#000080">-</font><font color="#800000">14</font><font color="#000080">);
  </font>Move<font color="#000080">(</font>PatchCode<font color="#000080">, </font>CallAddr<font color="#000080">^^, </font>SizeOf<font color="#000080">(</font>PatchCode<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ LongIntDivisionPatch }

{ Provided the product &gt; 2^16, this patch speeds up 4-byte signed integer
   multiplication by 5%  }

</i></font><font color="#FF0000"><b>Procedure </b></font>MultiplyPatch<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>PatchCode    <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">= (
           </font><font color="#008000"><i>{ Push first operand on the stack, pop it in a 32-bits register }
                   </i></font><font color="#800000">$52</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  DX        }
                   </i></font><font color="#800000">$50</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  AX        }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$58</font><font color="#000080">,       </font><font color="#008000"><i>{  POP   EAX       }
           { Push second operand on the stack, pop it in a 32-bits register
             Perform the multiplication }
                   </i></font><font color="#800000">$53</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  BX        }
                   </i></font><font color="#800000">$51</font><font color="#000080">,            </font><font color="#008000"><i>{  PUSH  CX        }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$5A</font><font color="#000080">,       </font><font color="#008000"><i>{  POP   EDX       }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$EA</font><font color="#000080">,  </font><font color="#008000"><i>{  IMUL  EDX       }
           { Push product on the stack, pop it in 16-bits registers }
                   </i></font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$50</font><font color="#000080">,       </font><font color="#008000"><i>{  PUSH  EAX       }
                   </i></font><font color="#800000">$58</font><font color="#000080">,            </font><font color="#008000"><i>{  POP   AX        }
                   </i></font><font color="#800000">$5A</font><font color="#000080">,            </font><font color="#008000"><i>{  POP   DX        }
                   </i></font><font color="#800000">$CB</font><font color="#000080">);           </font><font color="#008000"><i>{  RETF            }
</i></font><font color="#FF0000"><b>Begin
  </b></font>CallAddr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>CSeg<font color="#000080">, </font>IPtr<font color="#000080">-</font><font color="#800000">14</font><font color="#000080">);
  </font>Move<font color="#000080">(</font>PatchCode<font color="#000080">, </font>CallAddr<font color="#000080">^^, </font>SizeOf<font color="#000080">(</font>PatchCode<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ MultiplyPatch }

{ Shift directly across multiple words, rather than in a loop }

</i></font><font color="#FF0000"><b>Procedure </b></font>ShiftLeftPatch<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>PatchCode    <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">= (
                   </font><font color="#800000">$0F</font><font color="#000080">, </font><font color="#800000">$A5</font><font color="#000080">, </font><font color="#800000">$C2</font><font color="#000080">,  </font><font color="#008000"><i>{  SHLD DX, AX, CL }
                   </i></font><font color="#800000">$CB</font><font color="#000080">);           </font><font color="#008000"><i>{  RETF            }
</i></font><font color="#FF0000"><b>Begin
  </b></font>CallAddr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>CSeg<font color="#000080">, </font>IPtr<font color="#000080">-</font><font color="#800000">14</font><font color="#000080">);
  </font>Move<font color="#000080">(</font>PatchCode<font color="#000080">, </font>CallAddr<font color="#000080">^^, </font>SizeOf<font color="#000080">(</font>PatchCode<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ ShiftLeftPatch }

{ Shift directly across multiple words, rather than in a loop }

</i></font><font color="#FF0000"><b>Procedure </b></font>ShiftRightPatch<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>PatchCode    <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">= (
                   </font><font color="#800000">$0F</font><font color="#000080">, </font><font color="#800000">$AD</font><font color="#000080">, </font><font color="#800000">$C2</font><font color="#000080">,  </font><font color="#008000"><i>{  SHRD DX, AX, CL }
                   </i></font><font color="#800000">$CB</font><font color="#000080">);           </font><font color="#008000"><i>{  RETF            }
</i></font><font color="#FF0000"><b>Begin
  </b></font>CallAddr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>CSeg<font color="#000080">, </font>IPtr<font color="#000080">-</font><font color="#800000">14</font><font color="#000080">);
  </font>Move<font color="#000080">(</font>PatchCode<font color="#000080">, </font>CallAddr<font color="#000080">^^, </font>SizeOf<font color="#000080">(</font>PatchCode<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ ShiftRightPatch }

</i></font><font color="#FF0000"><b>Begin  </b></font><font color="#008000"><i>{ Patch }
  </i></font><font color="#FF0000"><b>If </b></font>CPUOk <font color="#FF0000"><b>Then                        </b></font><font color="#008000"><i>{ It's a 32-bitter }
    </i></font><font color="#FF0000"><b>Begin
      </b></font>dummy <font color="#000080">:= </font>dummy <font color="#FF0000"><b>div </b></font>dummy<font color="#000080">;
      </font>DivisionPatch<font color="#000080">;
      </font>dummy <font color="#000080">:= </font>dummy<font color="#000080">*</font>dummy<font color="#000080">;
      </font>MultiplyPatch<font color="#000080">;
      </font>dummy <font color="#000080">:= </font>dummy <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
      </font>ShiftLeftPatch<font color="#000080">;
      </font>dummy <font color="#000080">:= </font>dummy <font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">;
      </font>ShiftRightPatch<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.  </font><font color="#008000"><i>{ Patch }

</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0112.PAS">Original</a><b>]</b></p></body>
</html>
