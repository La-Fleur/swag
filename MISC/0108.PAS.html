<html>
<head><title> "Smooth Thermobar display" by WIM VAN DER VEGT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0108.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here a sample program which shows a smoothly (graphics mode like)
animation of a thermobar display. It works (I think) only on VGA cards

The trick is done by animating one character by changing it's
bitpattern. }


{---------------------------------------------------------}
{  Project : Textmode thermometer bar                     }
{  Unit    : Main Program                                 }
{  By      : Wim van der Vegt                             }
{---------------------------------------------------------}
{  This program shows a thermometer bar display similar   }
{  to the ones in many installation programs. This one    }
{  however is in textmode, but smoothly animated as if in }
{  graphics mode. It is only tested on one (S)VGA card.   }
{---------------------------------------------------------}
{  Date  .Time  Revision                                  }
{  940620.1450  Creation.                                 }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">,
  </font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>c <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">16</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte <font color="#000080">= (</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,
                              </font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,
                              </font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,
                              </font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">);

</font><font color="#008000"><i>{---------------------------------------------------------}
{---Procedure to turn cursor on/off.                      }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>Cursor<font color="#000080">(</font><font color="#FF0000"><b>on </b></font><font color="#000080">: </font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>VAR
  </b></font>r <font color="#000080">: </font>registers<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>r<font color="#000080">.</font>ah<font color="#000080">:=</font><font color="#800000">$03</font><font color="#000080">;
  </font>r<font color="#000080">.</font>bh<font color="#000080">:=</font><font color="#800000">$00</font><font color="#000080">;
  </font>Intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>r<font color="#000080">);

  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">((</font>r<font color="#000080">.</font>cx<font color="#000080">&lt; </font><font color="#800000">$2020</font><font color="#000080">) </font><font color="#FF0000"><b>AND NOT</b></font><font color="#000080">(</font><font color="#FF0000"><b>on</b></font><font color="#000080">)) </font><font color="#FF0000"><b>OR
     </b></font><font color="#000080">((</font>r<font color="#000080">.</font>cx<font color="#000080">&gt;=</font><font color="#800000">$2020</font><font color="#000080">) </font><font color="#FF0000"><b>AND on</b></font><font color="#000080">)
    </font><font color="#FF0000"><b>THEN
      BEGIN
        </b></font>r<font color="#000080">.</font>ah<font color="#000080">:=</font><font color="#800000">$01</font><font color="#000080">;
        </font>r<font color="#000080">.</font>cx<font color="#000080">:=</font>r<font color="#000080">.</font>cx <font color="#FF0000"><b>XOR </b></font><font color="#800000">$2020</font><font color="#000080">;
        </font>Intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>r<font color="#000080">);
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{of Cursor}

{---------------------------------------------------------}
{---Procedure to wait for the vertical retrace of the VGA }
{   display. This minimizes screen flickering when the    }
{   CRTC gets reprogrammed.                               }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>Wait4Retrace<font color="#000080">;

</font><font color="#FF0000"><b>begin
  while </b></font><font color="#000080">((</font>Port<font color="#000080">[</font><font color="#800000">$3DA</font><font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">8</font><font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font><font color="#000080">((</font>Port<font color="#000080">[</font><font color="#800000">$3DA</font><font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">8</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{of Wait4Retrace;}

{---------------------------------------------------------}
{---Procedure to generate an animation scene for character}
{   #1. The cursor is turned off every time the procedure }
{   is called because the cursor keeps showing up when the}
{   CRTC is reprogrammed. And a cursor behind a smoothly  }
{   animated thermobar just doesn't feel right.           }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>Reprogram<font color="#000080">(</font>i<font color="#000080">,</font>bperc <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>VAR
  </b></font>j <font color="#000080">: </font>integer<font color="#000080">;
  </font>r <font color="#000080">: </font>registers<font color="#000080">;
  </font>w <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin
</b></font><font color="#008000"><i>{----calculate bittpattern. It goes like
     0
     128
     128+64
     128+64+32
     128+64+32+16
     128+64+32+16+8
     128+64+32+16+8+4
     128+64+32+16+8+4+2
     128+64+32+16+8+4+2+1 (This is equivalent to character 219 '&Ucirc;')
     }

   </i></font>w<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>FOR </b></font>j<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>i <font color="#FF0000"><b>DO </b></font>w<font color="#000080">:=</font>w<font color="#000080">+</font>BYTE<font color="#000080">(</font><font color="#800000">256 </font><font color="#FF0000"><b>SHR </b></font>j<font color="#000080">);
   </font><font color="#FF0000"><b>For </b></font>j<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>bperc <font color="#FF0000"><b>Do </b></font>c<font color="#000080">[</font>j<font color="#000080">]:=</font>w<font color="#000080">;

 </font><font color="#008000"><i>{----reprogram character #1,
      but wait for retrace so there's no flickering}
   </i></font>r<font color="#000080">.</font>ah<font color="#000080">:=</font><font color="#800000">$11</font><font color="#000080">;
   </font>r<font color="#000080">.</font>al<font color="#000080">:=</font><font color="#800000">$10</font><font color="#000080">;
   </font>r<font color="#000080">.</font>bh<font color="#000080">:=</font>bperc<font color="#000080">;
   </font>r<font color="#000080">.</font>bl<font color="#000080">:=</font><font color="#800000">$00</font><font color="#000080">;
   </font>r<font color="#000080">.</font>cx<font color="#000080">:=</font><font color="#800000">$01</font><font color="#000080">;
   </font>r<font color="#000080">.</font>dx<font color="#000080">:=</font><font color="#800000">$01</font><font color="#000080">;
   </font>r<font color="#000080">.</font>bp<font color="#000080">:=</font>Ofs<font color="#000080">(</font>c<font color="#000080">);
   </font>r<font color="#000080">.</font>es<font color="#000080">:=</font>Seg<font color="#000080">(</font>c<font color="#000080">);
   </font>Wait4Retrace<font color="#000080">;
   </font>Intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>r<font color="#000080">);
  </font>Cursor<font color="#000080">(</font>false<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of Reprogram}

{---------------------------------------------------------}
{---Main program, btw the character #1 isn't restored     }
{   because it's seldomly used by application.            }
{   a TEXTMODE(LASTMODE) statement will clear the screen  }
{   and restore character #1. So put that at the end of   }
{   program                                               }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Var
  </b></font>r     <font color="#000080">: </font>registers<font color="#000080">;
  </font>i<font color="#000080">,</font>k   <font color="#000080">: </font>Byte<font color="#000080">;
  </font>bperc <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Clrscr<font color="#000080">;

  </font>GotoXY<font color="#000080">(</font><font color="#800000">20</font><font color="#000080">,</font><font color="#800000">5</font><font color="#000080">);
  </font>Write<font color="#000080">(</font><font color="#800000">'0%                50%               100%'</font><font color="#000080">);
  </font>GotoXY<font color="#000080">(</font><font color="#800000">20</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);

</font><font color="#008000"><i>{----get bytes per character of current font,
     by requesting font data on font #0 (INT 1F)}
  </i></font>r<font color="#000080">.</font>ah<font color="#000080">:=</font><font color="#800000">$11</font><font color="#000080">;
  </font>r<font color="#000080">.</font>al<font color="#000080">:=</font><font color="#800000">$30</font><font color="#000080">;
  </font>r<font color="#000080">.</font>bh<font color="#000080">:=</font><font color="#800000">$00</font><font color="#000080">;
  </font>Intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>r<font color="#000080">);
  </font>bperc<font color="#000080">:=</font>r<font color="#000080">.</font>cx<font color="#000080">;

  </font>textcolor<font color="#000080">(</font>yellow<font color="#000080">);

</font><font color="#008000"><i>{----Do a 30 character bar}
  </i></font><font color="#FF0000"><b>For </b></font>k<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font><font color="#800000">40 </font><font color="#FF0000"><b>Do
    Begin
    </b></font><font color="#008000"><i>{----Use chr(1) to animate, however wipe it before writing it}
      </i></font>Reprogram<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font>bperc<font color="#000080">);
      </font>Write<font color="#000080">(</font><font color="#800000">#01</font><font color="#000080">);

    </font><font color="#008000"><i>{----Animate character #1}
      </i></font><font color="#FF0000"><b>For </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>To </b></font><font color="#800000">7 </font><font color="#FF0000"><b>Do
        Begin
        </b></font><font color="#008000"><i>{----calc bit new patterns,
             bit patterns are reversed in character generator,
             bit 7 is on the left side of a character}
          </i></font>Reprogram<font color="#000080">(</font>i<font color="#000080">,</font>bperc<font color="#000080">);
          </font>Delay<font color="#000080">(</font><font color="#800000">25</font><font color="#000080">);
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

   </font><font color="#008000"><i>{----Replace fully animated characters by a full block from
        the line drawing set because animation of character #1
        will be started all over}
     </i></font>GotoXY<font color="#000080">(</font>WhereX<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">,</font>WhereY<font color="#000080">);
     </font>Write<font color="#000080">(</font><font color="#800000">'&Ucirc;'</font><font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>GotoXY<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">);
  </font>Cursor<font color="#000080">(</font>true<font color="#000080">);

 </font><font color="#008000"><i>{textmode(lastmode);}
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">. </font><font color="#008000"><i>{of Main program}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0108.PAS">Original</a><b>]</b></p></body>
</html>
