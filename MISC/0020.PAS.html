<html>
<head><title> "Hi Resolution Timer" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>UNIT </b></font>Timer<font color="#000080">;

</font><font color="#008000"><i>{ TIMER - Fine resolution timer functions              }

</i></font><font color="#FF0000"><b>INTERFACE
USES </b></font>Crt<font color="#000080">,</font>Dos<font color="#000080">;
</font><font color="#FF0000"><b>CONST
   </b></font>TixSec  <font color="#000080">= </font><font color="#800000">18.20648193</font><font color="#000080">;
   </font>TixMin  <font color="#000080">= </font>TixSec <font color="#000080">* </font><font color="#800000">60.0</font><font color="#000080">;
   </font>TixHour <font color="#000080">= </font>TixMin <font color="#000080">* </font><font color="#800000">60.0</font><font color="#000080">;
   </font>TixDay  <font color="#000080">= </font>TixHour <font color="#000080">* </font><font color="#800000">24.0</font><font color="#000080">;
</font><font color="#FF0000"><b>TYPE
   </b></font>DiffType <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">16</font><font color="#000080">];
</font><font color="#FF0000"><b>VAR
   </b></font>tGet       <font color="#000080">: </font>Longint <font color="#FF0000"><b>ABSOLUTE </b></font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>tStart<font color="#000080">: </font>Longint<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>tDiff<font color="#000080">(</font>StartTime<font color="#000080">,</font>EndTime<font color="#000080">: </font>Longint<font color="#000080">) : </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>tFormat<font color="#000080">(</font>T1<font color="#000080">,</font>T2<font color="#000080">:</font>Longint<font color="#000080">): </font>DiffType<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>GetTime<font color="#000080">(</font>H<font color="#000080">,</font>M<font color="#000080">,</font>S<font color="#000080">,</font>S100<font color="#000080">:</font>Word<font color="#000080">);

</font><font color="#FF0000"><b>IMPLEMENTATION

VAR
   </b></font>TimeDiff   <font color="#000080">: </font>DiffType<font color="#000080">;

</font><font color="#008000"><i>{ tStart - wait for a new tick, and return the
  tick number to the caller.  The wait allows
  us to be sure the user gets a start at the
  beginning of the second.                             }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>tStart<font color="#000080">: </font>Longint<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>StartTime <font color="#000080">: </font>Longint<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
          </b></font>StartTime <font color="#000080">:= </font>tGet<font color="#000080">;
   </font><font color="#FF0000"><b>WHILE </b></font>StartTime <font color="#000080">= </font>tGet <font color="#FF0000"><b>DO</b></font><font color="#000080">;
          </font>tStart <font color="#000080">:= </font>tGet
<font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{ tDiff - compute the difference between two
  timepoints (in seconds). }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>tDiff<font color="#000080">(</font>StartTime<font color="#000080">,</font>EndTime<font color="#000080">: </font>Longint<font color="#000080">) : </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>tDiff <font color="#000080">:= (</font>EndTime<font color="#000080">-</font>StartTime<font color="#000080">)/</font>TixSec<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>GetTime<font color="#000080">(</font>H<font color="#000080">,</font>M<font color="#000080">,</font>S<font color="#000080">,</font>S100<font color="#000080">:</font>Word<font color="#000080">);
</font><font color="#FF0000"><b>VAR
   </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$2C</font><font color="#000080">;
   </font>MsDos<font color="#000080">(</font>Regs<font color="#000080">);
   </font>H <font color="#000080">:= </font>Regs<font color="#000080">.</font>CH<font color="#000080">;
   </font>M <font color="#000080">:= </font>Regs<font color="#000080">.</font>CL<font color="#000080">;
   </font>S <font color="#000080">:= </font>Regs<font color="#000080">.</font>DH<font color="#000080">;
   </font>S100 <font color="#000080">:= </font>Regs<font color="#000080">.</font>DL
<font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{ tFormat - given two times, return a pointer
  to a (static) string that is the difference
  in the times, formatted HH:MM:SS }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>tFormat<font color="#000080">(</font>T1<font color="#000080">,</font>T2<font color="#000080">:</font>Longint<font color="#000080">): </font>DiffType<font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>rMod<font color="#000080">(</font>P1<font color="#000080">,</font>P2<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>rMod <font color="#000080">:= </font>Frac<font color="#000080">(</font>P1<font color="#000080">/</font>P2<font color="#000080">) * </font>P2
<font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
        </b></font>Temp <font color="#000080">: </font>Real<font color="#000080">;
   </font>tStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
   </font>TempStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
   </font>TimeValue <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Longint<font color="#000080">;
   </font>I <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Temp <font color="#000080">:= </font>t2<font color="#000080">-</font>t1<font color="#000080">;           </font><font color="#008000"><i>{ Time diff. }
   {Adj midnight crossover}
   </i></font><font color="#FF0000"><b>IF </b></font>Temp <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
          </b></font>Temp <font color="#000080">:= </font>Temp <font color="#000080">+ </font>TixDay<font color="#000080">;
          </font>TimeValue<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>Trunc<font color="#000080">(</font>Temp<font color="#000080">/</font>TixHour<font color="#000080">);  </font><font color="#008000"><i>{hours}
          </i></font>Temp <font color="#000080">:= </font>rMod<font color="#000080">(</font>Temp<font color="#000080">,</font>TixHour<font color="#000080">);
   </font>TimeValue<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>Trunc<font color="#000080">(</font>Temp<font color="#000080">/</font>TixMin<font color="#000080">); </font><font color="#008000"><i>{minutes}
   </i></font>Temp <font color="#000080">:= </font>rMod<font color="#000080">(</font>Temp<font color="#000080">,</font>TixMin<font color="#000080">);
   </font>TimeValue<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">] := </font>Trunc<font color="#000080">(</font>Temp<font color="#000080">/</font>TixSec<font color="#000080">); </font><font color="#008000"><i>{seconds}
   </i></font>Temp <font color="#000080">:= </font>rMod<font color="#000080">(</font>Temp<font color="#000080">,</font>TixSec<font color="#000080">);     </font><font color="#008000"><i>{milliseconds}
   </i></font>TimeValue<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">] := </font>Trunc<font color="#000080">(</font>Temp<font color="#000080">*</font><font color="#800000">100.0</font><font color="#000080">/</font>TixSec<font color="#000080">+</font><font color="#800000">0.5</font><font color="#000080">);
   </font>STR<font color="#000080">(</font>TimeValue<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:</font><font color="#800000">2</font><font color="#000080">,</font>tStr<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>tStr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">' ' </font><font color="#FF0000"><b>THEN </b></font>tStr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">'0'</font><font color="#000080">;
   </font><font color="#FF0000"><b>FOR </b></font>I <font color="#000080">:= </font><font color="#800000">2 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">3 </font><font color="#FF0000"><b>DO
      BEGIN
         </b></font>STR<font color="#000080">(</font>TimeValue<font color="#000080">[</font>I<font color="#000080">]:</font><font color="#800000">2</font><font color="#000080">,</font>TempStr<font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>TempStr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]=</font><font color="#800000">' ' </font><font color="#FF0000"><b>THEN
                            </b></font>TempStr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:=</font><font color="#800000">'0'</font><font color="#000080">;
         </font>tStr <font color="#000080">:= </font>tStr <font color="#000080">+ </font><font color="#800000">':'</font><font color="#000080">+ </font>TempStr
      <font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font>STR<font color="#000080">(</font>TimeValue<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">]:</font><font color="#800000">2</font><font color="#000080">,</font>TempStr<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>TempStr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]=</font><font color="#800000">' ' </font><font color="#FF0000"><b>THEN </b></font>TempStr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:=</font><font color="#800000">'0'</font><font color="#000080">;
   </font>tStr <font color="#000080">:= </font>tStr <font color="#000080">+ </font><font color="#800000">'.' </font><font color="#000080">+ </font>TempStr<font color="#000080">;
   </font>tFormat <font color="#000080">:= </font>tStr
<font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p></body>
</html>
