<html>
<head><title> "Detecting $G+ Compiler Directive" by ALFONS HOOGERVORST</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0116.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
&gt; I have now added the {$IFOPT G+} to most of my current sources, but I
&gt; would like default detection code in my libraries (often used TPUs)
&gt; Even if my TPUs are compiled in G- (which they always are, because
&gt; I update them with TPC from a batch file), but if my 'main' source
&gt; files are accidentally G+ I would like that detected by my library
&gt; code.
*)

{$X+}{&lt;&lt;&lt; Need this and strings unit }
{===========================================================================
 Copyrighted by Alfons Hoogervorst 1994 AD.
 Well. Ok. It's dumped in the public domain.
 ==========================================================================}

</i></font><font color="#FF0000"><b>program </b></font>Test8086<font color="#000080">;

</font><font color="#FF0000"><b>uses
  </b></font>WinCrt<font color="#000080">, </font>Strings<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font><font color="#008000"><i>{ My firstname expressed in bytes, I guess. Use same bytes if possible
    to overcome the byte ordering on PC's }
  </i></font>SEARCHID <font color="#000080">= </font><font color="#800000">$A2A2A2A2</font><font color="#000080">;
  </font>SEARCHBYTE <font color="#000080">= </font>Byte<font color="#000080">(</font>SEARCHID<font color="#000080">); </font><font color="#008000"><i>{ LoByte }
  </i></font>PUSHINT  <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>CallInOne<font color="#000080">(</font>int<font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ So I return }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>CheckThisOut<font color="#000080">;
</font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">jmp @Continue
    dd SEARCHID                 </font><font color="#008000"><i>{ Bytes we're looking for }
  </i></font><font color="#FF00FF">@continue:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ if G+:  push 0x02
    else  mov ax,02;  push ax
  }
  </i></font>CallInOne<font color="#000080">(</font>PUSHINT<font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TGOption <font color="#000080">= (</font>Error<font color="#000080">, </font>Goff<font color="#000080">, </font>Gon<font color="#000080">);

</font><font color="#FF0000"><b>function </b></font>IsOptionGOn<font color="#000080">: </font>TGOption<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>PDword <font color="#000080">= ^</font>Longint<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Opcodes<font color="#000080">: </font>PChar<font color="#000080">;
  </font>i<font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#008000"><i>{ Say 50 bytes }
</i></font><font color="#FF0000"><b>begin
  </b></font>IsOptionGOn <font color="#000080">:= </font>Error<font color="#000080">;
  </font>OpCodes <font color="#000080">:= </font>PChar<font color="#000080">(@</font>CheckThisOut<font color="#000080">);

  </font><font color="#008000"><i>{ Find our ID }
  </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">49 </font><font color="#FF0000"><b>do </b></font><font color="#008000"><i>{ search some 50 bytes, must be enough }
  </i></font><font color="#FF0000"><b>begin
    if </b></font>PDword<font color="#000080">(</font>OpCodes<font color="#000080">)^ = </font>SEARCHID <font color="#FF0000"><b>then
    begin </b></font><font color="#008000"><i>{ Found our bytes }
      </i></font>OpCodes <font color="#000080">:= </font>OpCodes <font color="#000080">+ </font>sizeof<font color="#000080">(</font>Longint<font color="#000080">); </font><font color="#008000"><i>{ Next instruction }

      { Check if it's PUSH PUSHINT instruction }
      </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>OpCodes<font color="#000080">^ = </font><font color="#800000">#$6A</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">((</font>OpCodes<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">)^ = </font>Char<font color="#000080">(</font>PUSHINT<font color="#000080">)) </font><font color="#FF0000"><b>then
        </b></font>IsOptionGOn <font color="#000080">:= </font>Gon
      <font color="#FF0000"><b>else </b></font>IsOptionGOn <font color="#000080">:= </font>Goff<font color="#000080">;
      </font>exit
    <font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>OpCodes <font color="#000080">:= </font>OpCodes <font color="#000080">+ </font><font color="#800000">1 </font><font color="#008000"><i>{ Try next }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'I Call You Call Me? Ok!'</font><font color="#000080">);

  </font><font color="#FF0000"><b>case </b></font>IsOptionGOn <font color="#FF0000"><b>of
    </b></font>Error<font color="#000080">:
    </font><font color="#FF0000"><b>begin
      </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Error... Borland Pascal code generation changed dramatically'</font><font color="#000080">);
      </font>WriteLn<font color="#000080">(</font><font color="#800000">'The world is collapsing, all programs have become
</font>incompatible<font color="#800000">');      WriteLn('</font>The Horror <font color="#FF0000"><b>of </b></font>It<font color="#000080">! </font>Get me some <font color="#FF0000"><b>assembler and </b></font>I<font color="#800000">''</font>ll
fix it<font color="#000080">!</font><font color="#800000">')    end;
    </font>Gon<font color="#000080">:
    </font><font color="#FF0000"><b>begin
      </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'''t Was On'</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>Goff<font color="#000080">:
    </font><font color="#FF0000"><b>begin
      </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'''t Was Off'</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>(*
What am I doing here? Just looking for a push instruction. If {$G} on
constants are pushed with an immediate push instruction. Sounds
dificult? Well, just forget it, implement these functions in a unit
and you have your long-awaited test function.

I have some notes on my own code. If you're using my check-80X86 function
NEVER do the following things:
*)

</i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>OptionGOn <font color="#000080">= </font>Goff<font color="#000080">) </font><font color="#FF0000"><b>then
begin
  </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'This code is compiled with $G+'</font><font color="#000080">);
  </font>Halt<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">) </font><font color="#008000"><i>{&lt;&lt;&lt;&lt;&lt; PROBLEMS!!! }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>(*
Why?

If $G has been enabled you'll get:

push 2
call far HALT

And (as you noted) an 808X does not accept this.

Instead use this:
*)

</i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>OptionGOn <font color="#000080">= </font>GOn<font color="#000080">) </font><font color="#FF0000"><b>then
begin
  </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Option $G enabled message'</font><font color="#000080">);
  </font>Halt<font color="#000080">(</font>Integer<font color="#000080">(</font>OptionGOn<font color="#000080">)) </font><font color="#008000"><i>{ Or pass a variable }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>(*
In plain words: after checking the G-state with my function, don't call a
function with constant parameters. Always pass variables/function-results as
parameters.
This is not &quot;portable&quot;:
*)

</i></font><font color="#FF0000"><b>const
  </b></font>ERROR_GERROR  <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
  </font>ANOTHER_CONST <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;

</font><font color="#FF0000"><b>if </b></font><font color="#008000"><i>{ my test } </i></font><font color="#FF0000"><b>then
begin
  </b></font>IWantToExitRightNow<font color="#000080">(</font>ERROR_GERROR<font color="#000080">, </font>ANOTHER_CONST<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">, </font><font color="#800000">6</font><font color="#000080">, </font><font color="#800000">7</font><font color="#000080">);

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Instead try this: }

</i></font><font color="#FF0000"><b>if </b></font><font color="#008000"><i>{ my test } </i></font><font color="#FF0000"><b>then
begin
  </b></font>IWantToExitRightNow<font color="#000080">(</font>VarIndicatingError<font color="#000080">, </font>VarForAnotherConst<font color="#000080">,
     </font>FunctionCall4<font color="#000080">, </font>FunctionCall6<font color="#000080">, </font>VarContaining7<font color="#000080">)

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{
This is _only_ necessary in the &quot;code&quot; block immediately following my
function, not in your other code. By the way: I have written a unit for
detecting this $G-state. It's partly written in asm. This unit does not
require the &quot;use&quot; of other units.
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0116.PAS">Original</a><b>]</b></p></body>
</html>
