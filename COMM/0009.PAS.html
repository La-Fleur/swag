<html>
<head><title> "ASYNC Routines" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;doors. But, i have one little problem: I don't know how to hang-up the modem
&gt;- I am using a ready-made TPU that does all the port tasks, but it just can'
&gt;hang up!

Here is some code I pulled out of this conference a While ago:
}

</i></font><font color="#FF0000"><b>Unit </b></font>EtAsync<font color="#000080">;

</font><font color="#008000"><i>{****************************************************************************}
{* EtAsync V.1.04, 9/4 1992 Et-Soft                                         *}
{*                                                                          *}
{* Turbo Pascal Unit With support For up to 8 serial ports.                 *}
{****************************************************************************}

{$A-}                              {- Word alignment -}
{$B-}                              {- Complete Boolean evaluation -}
{$D-}                              {- Debug inFormation -}
{$E-}                              {- Coprocessor emulation -}
{$F+}                              {- Force Far calls -}
{$I-}                              {- I/O checking -}
{$L-}                              {- Local debug symbols -}
{$N-}                              {- Coprocessor code generation -}
{$O-}                              {- Overlayes allowed -}
{$R-}                              {- Range checking -}
{$S-}                              {- Stack checking -}
{$V-}                              {- Var-String checking -}
{$M 16384,0,655360}                {- Stack size, min heap, max heap -}
{****************************************************************************}
                                   </i></font><font color="#FF0000"><b>Interface
</b></font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
  {- Standard baudrates: -}
  {- 50, 75, 110, 134 (134.5), 150, 300, 600, 1200, 1800, 2000, 2400, 3600, -}
  {- 4800, 7200, 9600, 19200, 38400, 57600, 115200 -}

</i></font><font color="#FF0000"><b>Function </b></font>OpenCOM            <font color="#008000"><i>{- Open a COMport For communication -}
  </i></font><font color="#000080">(</font>Nr         <font color="#000080">: </font>Byte<font color="#000080">;       </font><font color="#008000"><i>{- Internal portnumber: 0-7 -}
   </i></font>Address    <font color="#000080">: </font>Word<font color="#000080">;       </font><font color="#008000"><i>{- Port address in hex: 000-3F8 -}
   </i></font>IrqNum     <font color="#000080">: </font>Byte<font color="#000080">;       </font><font color="#008000"><i>{- Port Irq number: 0-7  (255 For no Irq) -}
   </i></font>Baudrate   <font color="#000080">: </font>LongInt<font color="#000080">;    </font><font color="#008000"><i>{- Baudrate: (see table) -}
   </i></font>ParityBit  <font color="#000080">: </font>Char<font color="#000080">;       </font><font color="#008000"><i>{- Parity  : 'O','E' or 'N' -}
   </i></font>Databits   <font color="#000080">: </font>Byte<font color="#000080">;       </font><font color="#008000"><i>{- Databits: 5-8 -}
   </i></font>Stopbits   <font color="#000080">: </font>Byte<font color="#000080">;       </font><font color="#008000"><i>{- Stopbits: 1-2 -}
   </i></font>BufferSize <font color="#000080">: </font>Word<font color="#000080">;       </font><font color="#008000"><i>{- Size of input buffer: 0-65535 -}
   </i></font>Handshake  <font color="#000080">: </font>Boolean<font color="#000080">)    </font><font color="#008000"><i>{- True to use hardware handshake -}
     </i></font><font color="#000080">: </font>Boolean<font color="#000080">;             </font><font color="#008000"><i>{- Returns True if ok -}

</i></font><font color="#FF0000"><b>Procedure </b></font>CloseCOM          <font color="#008000"><i>{- Close a open COMport -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">);              </font><font color="#008000"><i>{- Internal portnumber: 0-7 -}

</i></font><font color="#FF0000"><b>Procedure </b></font>ResetCOM          <font color="#008000"><i>{- Reset a open COMport incl. buffer -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">);              </font><font color="#008000"><i>{- Internal portnumber: 0-7 -}

</i></font><font color="#FF0000"><b>Procedure </b></font>COMSettings       <font color="#008000"><i>{- Change settings For a open COMport -}
  </i></font><font color="#000080">(</font>Nr        <font color="#000080">: </font>Byte<font color="#000080">;        </font><font color="#008000"><i>{- Internal portnumber: 0-7 -}
   </i></font>Baudrate  <font color="#000080">: </font>LongInt<font color="#000080">;     </font><font color="#008000"><i>{- Baudrate: (see table) -}
   </i></font>Paritybit <font color="#000080">: </font>Char<font color="#000080">;        </font><font color="#008000"><i>{- Parity  : 'O','E' or 'N' -}
   </i></font>Databits  <font color="#000080">: </font>Byte<font color="#000080">;        </font><font color="#008000"><i>{- Databits: 5-8 -}
   </i></font>Stopbits  <font color="#000080">: </font>Byte<font color="#000080">;        </font><font color="#008000"><i>{- Stopbits: 1-2 -}
   </i></font>Handshake <font color="#000080">: </font>Boolean<font color="#000080">);    </font><font color="#008000"><i>{- True to use hardware handshake -}

</i></font><font color="#FF0000"><b>Function </b></font>COMAddress         <font color="#008000"><i>{- Return the address For a COMport (BIOS) -}
  </i></font><font color="#000080">(</font>COMport <font color="#000080">: </font>Byte<font color="#000080">)          </font><font color="#008000"><i>{- COMport: 1-8 -}
    </i></font><font color="#000080">: </font>Word<font color="#000080">;                 </font><font color="#008000"><i>{- Address found For COMport (0 if none) -}

</i></font><font color="#FF0000"><b>Function </b></font>WriteCOM           <font color="#008000"><i>{- Writes a Character to a port -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">;               </font><font color="#008000"><i>{- Internal portnumber: 0-7 -}
   </i></font>Ch <font color="#000080">: </font>Char<font color="#000080">)               </font><font color="#008000"><i>{- Character to be written to port -}
    </i></font><font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{- True if Character send -}

</i></font><font color="#FF0000"><b>Function </b></font>WriteCOMString     <font color="#008000"><i>{- Writes a String to a port -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">;               </font><font color="#008000"><i>{- Internal portnumber: 0-7 -}
   </i></font>St <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">)             </font><font color="#008000"><i>{- String to be written to port -}
    </i></font><font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{- True if String send -}

</i></font><font color="#FF0000"><b>Function </b></font>CheckCOM           <font color="#008000"><i>{- Check if any Character is arrived -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">;               </font><font color="#008000"><i>{- Internal portnumber: 0-7 -}
   </i></font><font color="#FF0000"><b>Var </b></font>Ch <font color="#000080">: </font>Char<font color="#000080">)           </font><font color="#008000"><i>{- Character arrived -}
    </i></font><font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{- Returns True and Character if any -}

</i></font><font color="#FF0000"><b>Function </b></font>COMError           <font color="#008000"><i>{- Returns status of the last operation -}
    </i></font><font color="#000080">: </font>Integer<font color="#000080">;              </font><font color="#008000"><i>{- 0 = Ok -}
                            {- 1 = not enough memory -}
                            {- 2 = Port not open -}
                            {- 3 = Port already used once -}
                            {- 4 = Selected Irq already used once -}
                            {- 5 = Invalid port -}
                            {- 6 = Timeout -}
                            {- 7 = Port failed loopback test -}
                            {- 8 = Port failed IRQ test -}

</i></font><font color="#FF0000"><b>Function </b></font>TestCOM            <font color="#008000"><i>{- PerForms a loopback and IRQ test on a port -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">)               </font><font color="#008000"><i>{- Internal port number: 0-7 -}
    </i></font><font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{- True if port test ok -}
                            {- note: This is perFormed during OpenCOM -}
                            {- if enabled (TestCOM is by default enabled -}
                            {- during OpenCOM, but can be disabled With -}
                            {- the DisableTestCOM routine) -}

</i></font><font color="#FF0000"><b>Procedure </b></font>EnableTestCOM<font color="#000080">;    </font><font color="#008000"><i>{- Enable TestCOM during Openport (Default On) }

</i></font><font color="#FF0000"><b>Procedure </b></font>DisableTestCOM<font color="#000080">;   </font><font color="#008000"><i>{- Disable TestCOM during Openport -}

</i></font><font color="#FF0000"><b>Function </b></font>COMUsed            <font color="#008000"><i>{- Check whether or not a port is open -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">)               </font><font color="#008000"><i>{- Internal port number: 0-7 -}
    </i></font><font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{- True if port is open and in use -}
                            {- note: This routine can not test -}
                            {- whether or not a COMport is used by
                            {- another application -}

</i></font><font color="#FF0000"><b>Function </b></font>IrqUsed            <font color="#008000"><i>{- Check whether or not an Irq is used -}
  </i></font><font color="#000080">(</font>IrqNum <font color="#000080">: </font>Byte<font color="#000080">)           </font><font color="#008000"><i>{- Irq number: 0-7 -}
    </i></font><font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{- True if Irq is used -}
                            {- note: This routine can not test -}
                            {- whether or not an IRQ is used by -}
                            {- another application -}

</i></font><font color="#FF0000"><b>Function </b></font>IrqInUse           <font color="#008000"><i>{- Test IRQ in use on the PIC -}
  </i></font><font color="#000080">(</font>IrqNum <font color="#000080">: </font>Byte<font color="#000080">)           </font><font color="#008000"><i>{- Irq number: 0-7 -}
    </i></font><font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{- True if Irq is used -}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetIrqPriority    <font color="#008000"><i>{- Set the Irq priority level on the PIC -}
  </i></font><font color="#000080">(</font>IrqNum <font color="#000080">: </font>Byte<font color="#000080">);          </font><font color="#008000"><i>{- Irq number: 0-7 -}
                            {- The IrqNum specified will get the highest -}
                            {- priority, the following Irq number will
                            {- then have the next highest priority -}
                            {- and so on -}

</i></font><font color="#FF0000"><b>Procedure </b></font>ClearBuffer       <font color="#008000"><i>{- Clear the input buffer For a open port -}
  </i></font><font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">);              </font><font color="#008000"><i>{- Internal port number: 0-7 -}


{****************************************************************************}
                                 </i></font><font color="#FF0000"><b>Implementation
</b></font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Type
  </b></font>Buffer <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">65535</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;  </font><font color="#008000"><i>{- Dummy Type For Interrupt buffer -}
  </i></font>PortRec <font color="#000080">= </font><font color="#FF0000"><b>Record                   </b></font><font color="#008000"><i>{- Portdata Type -}
    </i></font>InUse   <font color="#000080">: </font>Boolean<font color="#000080">;               </font><font color="#008000"><i>{- True if port is used -}
    </i></font>Addr    <font color="#000080">: </font>Word<font color="#000080">;                  </font><font color="#008000"><i>{- Selected address -}
    </i></font>Irq     <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Selected Irq number -}
    </i></font>OldIrq  <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Status of Irq beFore InitCOM -}
    </i></font>HShake  <font color="#000080">: </font>Boolean<font color="#000080">;               </font><font color="#008000"><i>{- Hardware handshake on/off -}
    </i></font>Buf     <font color="#000080">: ^</font>Buffer<font color="#000080">;               </font><font color="#008000"><i>{- Pointer to allocated buffer -}
    </i></font>BufSize <font color="#000080">: </font>Word<font color="#000080">;                  </font><font color="#008000"><i>{- Size of allocated buffer -}
    </i></font>OldVec  <font color="#000080">: </font>Pointer<font color="#000080">;               </font><font color="#008000"><i>{- Saved old interrupt vector -}
    </i></font>Baud    <font color="#000080">: </font>LongInt<font color="#000080">;               </font><font color="#008000"><i>{- Selected baudrate -}
    </i></font>Parity  <font color="#000080">: </font>Char<font color="#000080">;                  </font><font color="#008000"><i>{- Selected parity -}
    </i></font>Databit <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Selected number of databits -}
    </i></font>Stopbit <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Selected number of stopbits -}
    </i></font>InPtr   <font color="#000080">: </font>Word<font color="#000080">;                  </font><font color="#008000"><i>{- Pointer to buffer input index -}
    </i></font>OutPtr  <font color="#000080">: </font>Word<font color="#000080">;                  </font><font color="#008000"><i>{- Pointer to buffer output index -}
    </i></font>Reg0    <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Saved UART register 0 -}
    </i></font>Reg1    <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;   </font><font color="#008000"><i>{- Saved UART register 1's -}
    </i></font>Reg2    <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Saved UART register 2 -}
    </i></font>Reg3    <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Saved UART register 3 -}
    </i></font>Reg4    <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Saved UART register 4 -}
    </i></font>Reg6    <font color="#000080">: </font>Byte<font color="#000080">;                  </font><font color="#008000"><i>{- Saved UART register 6 -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>COMResult   <font color="#000080">: </font>Integer<font color="#000080">;                    </font><font color="#008000"><i>{- Last Error (Call COMError) -}
  </i></font>ExitChainP  <font color="#000080">: </font>Pointer<font color="#000080">;                    </font><font color="#008000"><i>{- Saved Exitproc Pointer -}
  </i></font>OldPort21   <font color="#000080">: </font>Byte<font color="#000080">;                       </font><font color="#008000"><i>{- Saved PIC status -}
  </i></font>Ports       <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>PortRec<font color="#000080">;     </font><font color="#008000"><i>{- The 8 ports supported -}

</i></font><font color="#FF0000"><b>Const
  </b></font>PIC <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;                                </font><font color="#008000"><i>{- PIC control address -}
  </i></font>EOI <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;                                </font><font color="#008000"><i>{- PIC control Byte -}
  </i></font>TestCOMEnabled <font color="#000080">: </font>Boolean <font color="#000080">= </font>True<font color="#000080">;          </font><font color="#008000"><i>{- Test port during OpenCOM -}

{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>DisableInterrupts<font color="#000080">;                </font><font color="#008000"><i>{- Disable interrupt -}
</i></font><font color="#FF0000"><b>begin
  Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);                            </font><font color="#008000"><i>{- CLI (Clear Interruptflag) -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>EnableInterrupts<font color="#000080">;                 </font><font color="#008000"><i>{- Enable interrupts -}
</i></font><font color="#FF0000"><b>begin
  Inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);                            </font><font color="#008000"><i>{- STI (Set interrupt flag) -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port0Int<font color="#000080">; </font>Interrupt<font color="#000080">;              </font><font color="#008000"><i>{- Interrupt rutine port 0 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];             </font><font color="#008000"><i>{- Read data from port -}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                            </font><font color="#008000"><i>{- Count one step Forward.. }
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;    </font><font color="#008000"><i>{  .. in buffer -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                          </font><font color="#008000"><i>{- Send EOI to PIC -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port1Int<font color="#000080">; </font>Interrupt<font color="#000080">;                 </font><font color="#008000"><i>{- Interrupt rutine port 1 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];             </font><font color="#008000"><i>{- Read data from port -}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                            </font><font color="#008000"><i>{- Count one step Forward.. }
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;    </font><font color="#008000"><i>{  .. in buffer -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                          </font><font color="#008000"><i>{- Send EOI to PIC -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port2Int<font color="#000080">; </font>Interrupt<font color="#000080">;                 </font><font color="#008000"><i>{- Interrupt rutine port 2 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];             </font><font color="#008000"><i>{- Read data from port -}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                            </font><font color="#008000"><i>{- Count one step Forward.. }
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;    </font><font color="#008000"><i>{  .. in buffer -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                          </font><font color="#008000"><i>{- Send EOI to PIC -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port3Int<font color="#000080">; </font>Interrupt<font color="#000080">;                 </font><font color="#008000"><i>{- Interrupt rutine port 3 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];            </font><font color="#008000"><i>{- Read data from port -}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                           </font><font color="#008000"><i>{- Count one step Forward.. }
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;   </font><font color="#008000"><i>{  .. in buffer -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                         </font><font color="#008000"><i>{- Send EOI to PIC -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port4Int<font color="#000080">; </font>Interrupt<font color="#000080">;                </font><font color="#008000"><i>{- Interrupt rutine port 4 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];            </font><font color="#008000"><i>{- Read data from port -}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                           </font><font color="#008000"><i>{- Count one step Forward.. }
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;   </font><font color="#008000"><i>{  .. in buffer -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                         </font><font color="#008000"><i>{- Send EOI to PIC -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port5Int<font color="#000080">; </font>Interrupt<font color="#000080">;                </font><font color="#008000"><i>{- Interrupt rutine port 5 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">5</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];            </font><font color="#008000"><i>{- Read data from port -}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                           </font><font color="#008000"><i>{- Count one step Forward.. }
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;   </font><font color="#008000"><i>{  .. in buffer -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                         </font><font color="#008000"><i>{- Send EOI to PIC -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port6Int<font color="#000080">; </font>Interrupt<font color="#000080">;                </font><font color="#008000"><i>{- Interrupt rutine port 6 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];            </font><font color="#008000"><i>{- Read data from port -}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                           </font><font color="#008000"><i>{- Count one step Forward.. }
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;   </font><font color="#008000"><i>{  .. in buffer -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                         </font><font color="#008000"><i>{- Send EOI to PIC -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Port7Int<font color="#000080">; </font>Interrupt<font color="#000080">;                </font><font color="#008000"><i>{- Interrupt rutine port 7 -}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>Buf<font color="#000080">^[</font>InPtr<font color="#000080">] := </font>Port<font color="#000080">[</font>Addr<font color="#000080">];            </font><font color="#008000"><i>{- Read data from port-}
    </i></font>Inc<font color="#000080">(</font>InPtr<font color="#000080">);                           </font><font color="#008000"><i>{- Count one step Forward..}
    </i></font><font color="#FF0000"><b>if </b></font>InPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
      </b></font>InPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;   </font><font color="#008000"><i>{  .. in buffer-}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font>EOI<font color="#000080">;                         </font><font color="#008000"><i>{- Send EOI to PIC-}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>InitPort<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">; </font>SaveStatus <font color="#000080">: </font>Boolean<font color="#000080">);     </font><font color="#008000"><i>{- Port initialize -}

</i></font><font color="#FF0000"><b>Var
  </b></font>divider  <font color="#000080">: </font>Word<font color="#000080">;                               </font><font color="#008000"><i>{- Baudrate divider number -}
  </i></font>CtrlBits <font color="#000080">: </font>Byte<font color="#000080">;                                     </font><font color="#008000"><i>{- UART control Byte -}

</i></font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    </b></font>divider <font color="#000080">:= </font><font color="#800000">115200 </font><font color="#FF0000"><b>div </b></font>Baud<font color="#000080">;                </font><font color="#008000"><i>{- Calc baudrate divider -}

    </i></font>CtrlBits <font color="#000080">:= </font>DataBit <font color="#000080">- </font><font color="#800000">5</font><font color="#000080">;                    </font><font color="#008000"><i>{- Insert databits -}

    </i></font><font color="#FF0000"><b>if </b></font>Parity <font color="#000080">&lt;&gt; </font><font color="#800000">'N' </font><font color="#FF0000"><b>then
    begin
      </b></font>CtrlBits <font color="#000080">:= </font>CtrlBits <font color="#FF0000"><b>or </b></font><font color="#800000">$08</font><font color="#000080">;            </font><font color="#008000"><i>{- Insert parity enable -}
      </i></font><font color="#FF0000"><b>if </b></font>Parity <font color="#000080">= </font><font color="#800000">'E' </font><font color="#FF0000"><b>then                    </b></font><font color="#008000"><i>{- Enable even parity -}
        </i></font>CtrlBits <font color="#000080">:= </font>CtrlBits <font color="#FF0000"><b>or </b></font><font color="#800000">$10</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font>Stopbit <font color="#000080">= </font><font color="#800000">2 </font><font color="#FF0000"><b>then
      </b></font>CtrlBits <font color="#000080">:= </font>CtrlBits <font color="#FF0000"><b>or </b></font><font color="#800000">$04</font><font color="#000080">;              </font><font color="#008000"><i>{- Insert stopbits -}

    </i></font><font color="#FF0000"><b>if </b></font>SaveStatus <font color="#FF0000"><b>then
      </b></font>Reg3 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$03</font><font color="#000080">];    </font><font color="#008000"><i>{- Save register 3 -}
    </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$03</font><font color="#000080">] := </font><font color="#800000">$80</font><font color="#000080">;                        </font><font color="#008000"><i>{- Baudrate change -}

    </i></font><font color="#FF0000"><b>if </b></font>SaveStatus <font color="#FF0000"><b>then
      </b></font>Reg0 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">];    </font><font color="#008000"><i>{- Save Lo Baud -}
    </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>divider<font color="#000080">);                </font><font color="#008000"><i>{- Set Lo Baud -}

    </i></font><font color="#FF0000"><b>if </b></font>SaveStatus <font color="#FF0000"><b>then
      </b></font>Reg1<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">]; </font><font color="#008000"><i>{- Save Hi Baud -}
    </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>divider<font color="#000080">);                </font><font color="#008000"><i>{- Set Hi Baud -}

    </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$03</font><font color="#000080">] := </font>CtrlBits<font color="#000080">;                   </font><font color="#008000"><i>{- Set control reg. -}
    </i></font><font color="#FF0000"><b>if </b></font>SaveStatus <font color="#FF0000"><b>then
      </b></font>Reg6 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">];    </font><font color="#008000"><i>{- Save register 6 -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>IrqUsed<font color="#000080">(</font>IrqNum <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Count <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Found <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Found <font color="#000080">:= </font>False<font color="#000080">;                                 </font><font color="#008000"><i>{- Irq not found -}
  </i></font>Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                                     </font><font color="#008000"><i>{- Start With port 0 -}

  </i></font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>Count <font color="#000080">&lt;= </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>and not </b></font>Found <font color="#FF0000"><b>Do             </b></font><font color="#008000"><i>{- Count the 8 ports -}
    </i></font><font color="#FF0000"><b>With </b></font>Ports<font color="#000080">[</font>Count<font color="#000080">] </font><font color="#FF0000"><b>Do
    begin
      if </b></font>InUse <font color="#FF0000"><b>then
        </b></font>Found <font color="#000080">:= </font>IrqNum <font color="#000080">= </font>Irq<font color="#000080">;                  </font><font color="#008000"><i>{- Check Irq match -}
      </i></font>Inc<font color="#000080">(</font>Count<font color="#000080">);                               </font><font color="#008000"><i>{- Next port -}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>IrqUsed <font color="#000080">:= </font>Found<font color="#000080">;                               </font><font color="#008000"><i>{- Return Irq found -}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>EnableTestCOM<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TestCOMEnabled <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>DisableTestCOM<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TestCOMEnabled <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>TestCOM<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>OldReg0   <font color="#000080">: </font>Byte<font color="#000080">;
  </font>OldReg1   <font color="#000080">: </font>Byte<font color="#000080">;
  </font>OldReg4   <font color="#000080">: </font>Byte<font color="#000080">;
  </font>OldReg5   <font color="#000080">: </font>Byte<font color="#000080">;
  </font>OldReg6   <font color="#000080">: </font>Byte<font color="#000080">;
  </font>OldInPtr  <font color="#000080">: </font>Word<font color="#000080">;
  </font>OldOutPtr <font color="#000080">: </font>Word<font color="#000080">;
  </font>TimeOut   <font color="#000080">: </font>Integer<font color="#000080">;

  </font><font color="#FF0000"><b>begin

  </b></font>TestCOM <font color="#000080">:= </font>False<font color="#000080">;

  </font><font color="#FF0000"><b>With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    if </b></font>InUse <font color="#FF0000"><b>then
    begin
      </b></font>OldInPtr  <font color="#000080">:= </font>InPtr<font color="#000080">;
      </font>OldOutPtr <font color="#000080">:= </font>OutPtr<font color="#000080">;
      </font>OldReg1 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">];
      </font>OldReg4 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">];
      </font>OldReg5 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$05</font><font color="#000080">];
      </font>OldReg6 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">];

      </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$05</font><font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">;
      </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] := </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$10</font><font color="#000080">;

      </font>OldReg0 <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">];
      </font>OutPtr  <font color="#000080">:= </font>InPtr<font color="#000080">;

      </font>TimeOut <font color="#000080">:= </font>MaxInt<font color="#000080">;
      </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">] := </font>OldReg0<font color="#000080">;

      </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$05</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$01 </font><font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>TimeOut <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Do
        </b></font>Dec<font color="#000080">(</font>TimeOut<font color="#000080">);

      </font><font color="#FF0000"><b>if </b></font>TimeOut <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        if </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">] = </font>OldReg0 <font color="#FF0000"><b>then
        begin
          if </b></font>IRQ <font color="#FF0000"><b>In </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>then
          begin
            </b></font>TimeOut <font color="#000080">:= </font>MaxInt<font color="#000080">;
            </font>OutPtr <font color="#000080">:= </font>InPtr<font color="#000080">;

            </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">] := </font><font color="#800000">$08</font><font color="#000080">;
            </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] := </font><font color="#800000">$08</font><font color="#000080">;
            </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">] := </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$01</font><font color="#000080">;

            </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>InPtr <font color="#000080">= </font>OutPtr<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>TimeOut <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Do
              </b></font>Dec<font color="#000080">(</font>TimeOut<font color="#000080">);

            </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">] := </font>OldReg1<font color="#000080">;

            </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>InPtr <font color="#000080">&lt;&gt; </font>OutPtr<font color="#000080">) </font><font color="#FF0000"><b>then
              </b></font>TestCOM <font color="#000080">:= </font>True
            <font color="#FF0000"><b>else
              </b></font>COMResult <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
          </font><font color="#FF0000"><b>end
          else
            </b></font>TestCOM <font color="#000080">:= </font>True<font color="#000080">;
        </font><font color="#FF0000"><b>end
        else
          </b></font>COMResult <font color="#000080">:= </font><font color="#800000">7</font><font color="#000080">;            </font><font color="#008000"><i>{- Loopback test failed -}
      </i></font><font color="#FF0000"><b>end
      else
        </b></font>COMResult <font color="#000080">:= </font><font color="#800000">6</font><font color="#000080">;                </font><font color="#008000"><i>{- Timeout -}

      </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] := </font>OldReg4<font color="#000080">;
      </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$05</font><font color="#000080">] := </font>OldReg5<font color="#000080">;
      </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">] := </font>OldReg6<font color="#000080">;

      </font><font color="#FF0000"><b>For </b></font>TimeOut <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>MaxInt <font color="#FF0000"><b>Do</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">] = </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font><font color="#000080">;

      </font>InPtr  <font color="#000080">:= </font>OldInPtr<font color="#000080">;
      </font>OutPtr <font color="#000080">:= </font>OldOutPtr<font color="#000080">;
    </font><font color="#FF0000"><b>end
    else
      </b></font>COMResult <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;                    </font><font color="#008000"><i>{- Port not open -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>CloseCOM<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    if </b></font>InUse <font color="#FF0000"><b>then
    begin
      </b></font>InUse <font color="#000080">:= </font>False<font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font>Irq <font color="#000080">&lt;&gt; </font><font color="#800000">255 </font><font color="#FF0000"><b>then                         </b></font><font color="#008000"><i>{- if Interrupt used -}
      </i></font><font color="#FF0000"><b>begin
        </b></font>FreeMem<font color="#000080">(</font>Buf<font color="#000080">,</font>BufSize<font color="#000080">);                  </font><font color="#008000"><i>{- Deallocate buffer -}
        </i></font>DisableInterrupts<font color="#000080">;
        </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font><font color="#800000">$01 </font><font color="#FF0000"><b>Shl </b></font>Irq<font color="#000080">) </font><font color="#FF0000"><b>and </b></font>OldIrq<font color="#000080">;
</font><font color="#008000"><i>{-restore-}
        </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] := </font>Reg4<font color="#000080">;              </font><font color="#008000"><i>{- Disable UART OUT2 -}
        </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">] := </font>Reg1<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">];           </font><font color="#008000"><i>{- Disable UART Int. -}
        </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">+</font>Irq<font color="#000080">,</font>OldVec<font color="#000080">);            </font><font color="#008000"><i>{- Restore Int.Vector -}
        </i></font>EnableInterrupts<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$03</font><font color="#000080">] := </font><font color="#800000">$80</font><font color="#000080">;                    </font><font color="#008000"><i>{- UART Baud set -}
      </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">] := </font>Reg0<font color="#000080">;                   </font><font color="#008000"><i>{- Reset Lo Baud -}
      </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">] := </font>Reg1<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];                </font><font color="#008000"><i>{- Reset Hi Baud -}
      </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$03</font><font color="#000080">] := </font>Reg3<font color="#000080">;                </font><font color="#008000"><i>{- Restore UART ctrl. -}
      </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">] := </font>Reg6<font color="#000080">;                  </font><font color="#008000"><i>{- Restore UART reg6 -}
    </i></font><font color="#FF0000"><b>end
    else
      </b></font>COMResult <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;                               </font><font color="#008000"><i>{- Port not in use -}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>OpenCOM
 <font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">; </font>Address  <font color="#000080">: </font>Word<font color="#000080">; </font>IrqNum <font color="#000080">: </font>Byte<font color="#000080">; </font>Baudrate <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>ParityBit <font color="#000080">: </font>Char<font color="#000080">; </font>Databits<font color="#000080">, </font>Stopbits <font color="#000080">: </font>Byte<font color="#000080">; </font>BufferSize <font color="#000080">: </font>Word<font color="#000080">;
  </font>HandShake <font color="#000080">: </font>Boolean<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>IntVec <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>OldErr <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>OpenCOM <font color="#000080">:= </font>False<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>IrqNum <font color="#000080">= </font><font color="#800000">255</font><font color="#000080">) </font><font color="#FF0000"><b>or
  </b></font><font color="#000080">((</font>IrqNum <font color="#FF0000"><b>In </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">]) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>MaxAvail <font color="#000080">&gt;= </font>LongInt<font color="#000080">(</font>BufferSize<font color="#000080">))
                      </font><font color="#FF0000"><b>and not </b></font>IrqUsed<font color="#000080">(</font>IrqNum<font color="#000080">)) </font><font color="#FF0000"><b>then
    With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
    begin
      if not </b></font>InUse <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Address <font color="#000080">&lt;= </font><font color="#800000">$3F8</font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>InUse   <font color="#000080">:= </font>True<font color="#000080">;                    </font><font color="#008000"><i>{- Port now in use -}

        </i></font>Addr    <font color="#000080">:= </font>Address<font color="#000080">;                 </font><font color="#008000"><i>{- Save parameters -}
        </i></font>Irq     <font color="#000080">:= </font>IrqNum<font color="#000080">;
        </font>HShake  <font color="#000080">:= </font>HandShake<font color="#000080">;
        </font>BufSize <font color="#000080">:= </font>BufferSize<font color="#000080">;
        </font>Baud    <font color="#000080">:= </font>Baudrate<font color="#000080">;
        </font>Parity  <font color="#000080">:= </font>Paritybit<font color="#000080">;
        </font>Databit <font color="#000080">:= </font>Databits<font color="#000080">;
        </font>Stopbit <font color="#000080">:= </font>Stopbits<font color="#000080">;

        </font>InPtr   <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;                       </font><font color="#008000"><i>{- Reset InputPointer -}
        </i></font>OutPtr  <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;                       </font><font color="#008000"><i>{- Reset OutputPointer -}

        </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Irq <font color="#FF0000"><b>In </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">]) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>BufSize <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
        begin
          </b></font>GetMem<font color="#000080">(</font>Buf<font color="#000080">,</font>BufSize<font color="#000080">);            </font><font color="#008000"><i>{- Allocate buffer -}
          </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">+</font>Irq<font color="#000080">,</font>OldVec<font color="#000080">);      </font><font color="#008000"><i>{- Save Interrupt vector -}

          </i></font><font color="#FF0000"><b>Case </b></font>Nr <font color="#FF0000"><b>of                    </b></font><font color="#008000"><i>{- Find the interrupt proc. -}
            </i></font><font color="#800000">0 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port0Int<font color="#000080">;
            </font><font color="#800000">1 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port1Int<font color="#000080">;
            </font><font color="#800000">2 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port2Int<font color="#000080">;
            </font><font color="#800000">3 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port3Int<font color="#000080">;
            </font><font color="#800000">4 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port4Int<font color="#000080">;
            </font><font color="#800000">5 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port5Int<font color="#000080">;
            </font><font color="#800000">6 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port6Int<font color="#000080">;
            </font><font color="#800000">7 </font><font color="#000080">: </font>IntVec <font color="#000080">:= @</font>Port7Int<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

          </font>Reg1<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">];    </font><font color="#008000"><i>{- Save register 1 -}
          </i></font>Reg4    <font color="#000080">:= </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">];    </font><font color="#008000"><i>{- Save register 4 -}
          </i></font>OldIrq  <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>or not </b></font><font color="#000080">(</font><font color="#800000">$01 </font><font color="#FF0000"><b>Shl </b></font>Irq<font color="#000080">);</font><font color="#008000"><i>{- Save PIC Irq -}

          </i></font>DisableInterrupts<font color="#000080">;              </font><font color="#008000"><i>{- Disable interrupts -}
          </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">+</font>Irq<font color="#000080">,</font>IntVec<font color="#000080">);    </font><font color="#008000"><i>{- Set the interrupt vector -}
          </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] := </font><font color="#800000">$08</font><font color="#000080">;        </font><font color="#008000"><i>{- Enable OUT2 on port -}
          </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$01</font><font color="#000080">] := </font><font color="#800000">$01</font><font color="#000080">;      </font><font color="#008000"><i>{- Set port data avail.int. -}
          </i></font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] </font><font color="#FF0000"><b>and not </b></font><font color="#000080">(</font><font color="#800000">$01 </font><font color="#FF0000"><b>Shl </b></font>Irq<font color="#000080">);</font><font color="#008000"><i>{- Enable Irq-}
          </i></font>EnableInterrupts<font color="#000080">;         </font><font color="#008000"><i>{- Enable interrupts again -}
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>InitPort<font color="#000080">(</font>Nr<font color="#000080">,</font>True<font color="#000080">);                  </font><font color="#008000"><i>{- Initialize port -}

        </i></font><font color="#FF0000"><b>if </b></font>TestCOMEnabled <font color="#FF0000"><b>then
        begin
          if not </b></font>TestCOM<font color="#000080">(</font>Nr<font color="#000080">) </font><font color="#FF0000"><b>then
          begin
            </b></font>OldErr <font color="#000080">:= </font>COMResult<font color="#000080">;
            </font>CloseCOM<font color="#000080">(</font>Nr<font color="#000080">);
            </font>COMResult <font color="#000080">:= </font>OldErr<font color="#000080">;
          </font><font color="#FF0000"><b>end
          else
            </b></font>OpenCOM <font color="#000080">:= </font>True<font color="#000080">;
        </font><font color="#FF0000"><b>end
        else
          </b></font>OpenCOM <font color="#000080">:= </font>True<font color="#000080">;

        </font><font color="#FF0000"><b>if </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">] = </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font><font color="#000080">;  </font><font color="#008000"><i>{- Remove any pending Character-}
        </i></font><font color="#FF0000"><b>if </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$05</font><font color="#000080">] = </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font><font color="#000080">;  </font><font color="#008000"><i>{- Reset line status register-}

        </i></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] := </font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$01</font><font color="#000080">;     </font><font color="#008000"><i>{- Enable DTR-}
      </i></font><font color="#FF0000"><b>end
      else if </b></font>InUse <font color="#FF0000"><b>then
        </b></font>COMResult <font color="#000080">:= </font><font color="#800000">3                        </font><font color="#008000"><i>{- Port already in use-}
      </i></font><font color="#FF0000"><b>else if </b></font><font color="#000080">(</font>Address <font color="#000080">&gt; </font><font color="#800000">$3F8</font><font color="#000080">) </font><font color="#FF0000"><b>then
        </b></font>COMResult <font color="#000080">:= </font><font color="#800000">5</font><font color="#000080">;                       </font><font color="#008000"><i>{- Invalid port address-}
    </i></font><font color="#FF0000"><b>end
  else if </b></font><font color="#000080">(</font>MaxAvail <font color="#000080">&gt;= </font>BufferSize<font color="#000080">) </font><font color="#FF0000"><b>then         </b></font><font color="#008000"><i>{- not enough memory-}
    </i></font>COMResult <font color="#000080">:= </font><font color="#800000">1
  </font><font color="#FF0000"><b>else if </b></font>IrqUsed<font color="#000080">(</font>IrqNum<font color="#000080">) </font><font color="#FF0000"><b>then                  </b></font><font color="#008000"><i>{- Irq already used -}
    </i></font>COMResult <font color="#000080">:= </font><font color="#800000">4</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>ResetCOM<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    if </b></font>InUse <font color="#FF0000"><b>then                        </b></font><font color="#008000"><i>{- Is port defined ?-}
    </i></font><font color="#FF0000"><b>begin
      </b></font>InPtr  <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;                     </font><font color="#008000"><i>{- Reset buffer Pointers-}
      </i></font>OutPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font>InitPort<font color="#000080">(</font>Nr<font color="#000080">,</font>False<font color="#000080">);              </font><font color="#008000"><i>{- Reinitialize the port-}

      </i></font><font color="#FF0000"><b>if </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$00</font><font color="#000080">] = </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font><font color="#000080">;    </font><font color="#008000"><i>{- Remove any pending Character-}
      </i></font><font color="#FF0000"><b>if </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$05</font><font color="#000080">] = </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font><font color="#000080">;    </font><font color="#008000"><i>{- Reset line status register-}
    </i></font><font color="#FF0000"><b>end
    else
      </b></font>COMResult <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;                    </font><font color="#008000"><i>{- Port not open-}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>COMSettings<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">; </font>Baudrate <font color="#000080">: </font>LongInt<font color="#000080">; </font>ParityBit <font color="#000080">: </font>Char<font color="#000080">;
  </font>Databits<font color="#000080">, </font>Stopbits <font color="#000080">: </font>Byte<font color="#000080">; </font>HandShake <font color="#000080">: </font>Boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    if </b></font>InUse <font color="#FF0000"><b>then                                     </b></font><font color="#008000"><i>{- Is port in use-}
    </i></font><font color="#FF0000"><b>begin
      </b></font>Baud    <font color="#000080">:= </font>Baudrate<font color="#000080">;                          </font><font color="#008000"><i>{- Save parameters-}
      </i></font>Parity  <font color="#000080">:= </font>Paritybit<font color="#000080">;
      </font>Databit <font color="#000080">:= </font>Databits<font color="#000080">;
      </font>Stopbit <font color="#000080">:= </font>Stopbits<font color="#000080">;
      </font>HShake  <font color="#000080">:= </font>HandShake<font color="#000080">;

      </font>InitPort<font color="#000080">(</font>Nr<font color="#000080">,</font>False<font color="#000080">);                           </font><font color="#008000"><i>{- ReInit port-}
    </i></font><font color="#FF0000"><b>end
    else
      </b></font>COMResult <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;                                 </font><font color="#008000"><i>{- Port not in use-}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>COMAddress<font color="#000080">(</font>COMport <font color="#000080">: </font>Byte<font color="#000080">) : </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>begin
  if </b></font>Comport <font color="#FF0000"><b>In </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>then
    </b></font>COMAddress <font color="#000080">:= </font>MemW<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">:(</font>Pred<font color="#000080">(</font>Comport<font color="#000080">) </font><font color="#FF0000"><b>Shl </b></font><font color="#800000">1</font><font color="#000080">)]       </font><font color="#008000"><i>{- BIOS data table-}
  </i></font><font color="#FF0000"><b>else
    </b></font>COMResult <font color="#000080">:= </font><font color="#800000">5</font><font color="#000080">;                                     </font><font color="#008000"><i>{- Invalid port-}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>WriteCOM<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">; </font>Ch <font color="#000080">: </font>Char<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Count <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>WriteCom <font color="#000080">:= </font>True<font color="#000080">;

  </font><font color="#FF0000"><b>With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
    if </b></font>InUse <font color="#FF0000"><b>then
    begin
      While </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$05</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$20 </font><font color="#000080">= </font><font color="#800000">$00 </font><font color="#FF0000"><b>Do</b></font><font color="#000080">;   </font><font color="#008000"><i>{- Wait Until Char send-}
      </i></font><font color="#FF0000"><b>if not </b></font>HShake <font color="#FF0000"><b>then
        </b></font>Port<font color="#000080">[</font>Addr<font color="#000080">] := </font>ord<font color="#000080">(</font>Ch<font color="#000080">)                    </font><font color="#008000"><i>{- Send Char to port-}
      </i></font><font color="#FF0000"><b>else
      begin
        </b></font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$04</font><font color="#000080">] := </font><font color="#800000">$0B</font><font color="#000080">;               </font><font color="#008000"><i>{- OUT2, DTR, RTS-}
        </i></font>Count <font color="#000080">:= </font>MaxInt<font color="#000080">;

        </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>Addr <font color="#000080">+ </font><font color="#800000">$06</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$10 </font><font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Count <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Do
          </b></font>Dec<font color="#000080">(</font>Count<font color="#000080">);                          </font><font color="#008000"><i>{- Wait For CTS-}

        </i></font><font color="#FF0000"><b>if </b></font>Count <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then                     </b></font><font color="#008000"><i>{- if not timeout-}
          </i></font>Port<font color="#000080">[</font>Addr<font color="#000080">] := </font>ord<font color="#000080">(</font>Ch<font color="#000080">)                </font><font color="#008000"><i>{- Send Char to port-}
        </i></font><font color="#FF0000"><b>else
        begin
          </b></font>COMResult <font color="#000080">:= </font><font color="#800000">6</font><font color="#000080">;                    </font><font color="#008000"><i>{- Timeout error-}
          </i></font>WriteCom  <font color="#000080">:= </font>False<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end
    else
    begin
      </b></font>COMResult <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;                            </font><font color="#008000"><i>{- Port not in use-}
      </i></font>WriteCom  <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>WriteCOMString<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">; </font>St <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Ok <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>Count <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  if </b></font>Length<font color="#000080">(</font>St<font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then                           </b></font><font color="#008000"><i>{- Any Chars to send ?-}
  </i></font><font color="#FF0000"><b>begin
    </b></font>Ok    <font color="#000080">:= </font>True<font color="#000080">;
    </font>Count <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>Count <font color="#000080">&lt;= </font>Length<font color="#000080">(</font>St<font color="#000080">)) </font><font color="#FF0000"><b>and </b></font>Ok <font color="#FF0000"><b>Do        </b></font><font color="#008000"><i>{- Count Chars-}
    </i></font><font color="#FF0000"><b>begin
      </b></font>Ok <font color="#000080">:= </font>WriteCOM<font color="#000080">(</font>Nr<font color="#000080">,</font>St<font color="#000080">[</font>Count<font color="#000080">]);            </font><font color="#008000"><i>{- Send Char-}
      </i></font>Inc<font color="#000080">(</font>Count<font color="#000080">);                              </font><font color="#008000"><i>{- Next Character-}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>WriteCOMString <font color="#000080">:= </font>Ok<font color="#000080">;                        </font><font color="#008000"><i>{- Return status-}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>CheckCOM<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Ch <font color="#000080">: </font>Char<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
  begin
    if </b></font>InPtr <font color="#000080">&lt;&gt; </font>OutPtr <font color="#FF0000"><b>then                      </b></font><font color="#008000"><i>{- Any Char in buffer ?-}
    </i></font><font color="#FF0000"><b>begin
      </b></font>Ch <font color="#000080">:= </font>Chr<font color="#000080">(</font>Buf<font color="#000080">^[</font>OutPtr<font color="#000080">]);                 </font><font color="#008000"><i>{- Get Char from buffer-}
      </i></font>Inc<font color="#000080">(</font>OutPtr<font color="#000080">);                             </font><font color="#008000"><i>{- Count outPointer up-}
      </i></font><font color="#FF0000"><b>if </b></font>OutPtr <font color="#000080">&gt; </font>BufSize <font color="#FF0000"><b>then
        </b></font>OutPtr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font>CheckCOM <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end
    else
      </b></font>CheckCOM <font color="#000080">:= </font>False<font color="#000080">;                         </font><font color="#008000"><i>{- No Char in buffer-}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>COMError <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>COMError <font color="#000080">:= </font>COMResult<font color="#000080">;                           </font><font color="#008000"><i>{- Return last error-}
  </i></font>COMResult <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>COMUsed<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>COMUsed <font color="#000080">:= </font>Ports<font color="#000080">[</font>Nr<font color="#000080">].</font>InUse<font color="#000080">;                      </font><font color="#008000"><i>{- Return used status-}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Function </b></font>IrqInUse<font color="#000080">(</font>IrqNum <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>IrqOn <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Mask  <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>IrqInUse <font color="#000080">:= </font>False<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>IrqNum <font color="#FF0000"><b>In </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>then
  begin
    </b></font>IrqOn <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">];         </font><font color="#008000"><i>{-1111 0100-}
    </i></font>Mask  <font color="#000080">:= (</font><font color="#800000">$01 </font><font color="#FF0000"><b>Shl </b></font>IrqNum<font color="#000080">);
    </font>IrqInUse <font color="#000080">:= </font>IrqOn <font color="#FF0000"><b>or not </b></font>Mask <font color="#000080">= </font><font color="#FF0000"><b>not </b></font>Mask<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>SetIrqPriority<font color="#000080">(</font>IrqNum <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>begin
  if </b></font>IrqNum <font color="#FF0000"><b>In </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>then
  begin
    if </b></font>IrqNum <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Dec<font color="#000080">(</font>IrqNum<font color="#000080">)
    </font><font color="#FF0000"><b>else </b></font>IrqNum <font color="#000080">:= </font><font color="#800000">7</font><font color="#000080">;

    </font>DisableInterrupts<font color="#000080">;
    </font>Port<font color="#000080">[</font>PIC<font color="#000080">] := </font><font color="#800000">$C0 </font><font color="#000080">+ </font>IrqNum<font color="#000080">;
    </font>EnableInterrupts<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>ClearBuffer<font color="#000080">(</font>Nr <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>begin
  With </b></font>Ports<font color="#000080">[</font>Nr<font color="#000080">] </font><font color="#FF0000"><b>Do
    if </b></font>InUse <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>BufSize <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>OutPtr <font color="#000080">:= </font>InPtr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>DeInit<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Count <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  For </b></font>Count <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">7 </font><font color="#FF0000"><b>Do
    </b></font>CloseCOM<font color="#000080">(</font>Count<font color="#000080">);          </font><font color="#008000"><i>{- Close open ports-}

  </i></font>DisableInterrupts<font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">] := </font>OldPort21<font color="#000080">;                          </font><font color="#008000"><i>{- Restore PIC status-}
  </i></font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$C7</font><font color="#000080">;                                </font><font color="#008000"><i>{- IRQ0 1. priority-}
  </i></font>EnableInterrupts<font color="#000080">;

  </font>ExitProc <font color="#000080">:= </font>ExitChainP<font color="#000080">;                          </font><font color="#008000"><i>{- Restore ExitProc-}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{****************************************************************************}
</i></font><font color="#FF0000"><b>Procedure </b></font>Init<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Count <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>COMResult  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>ExitChainP <font color="#000080">:= </font>ExitProc<font color="#000080">;                          </font><font color="#008000"><i>{- Save ExitProc-}
  </i></font>ExitProc   <font color="#000080">:= @</font>DeInit<font color="#000080">;                           </font><font color="#008000"><i>{- Set ExitProc-}

  </i></font><font color="#FF0000"><b>For </b></font>Count <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">7 </font><font color="#FF0000"><b>Do
    </b></font>Ports<font color="#000080">[</font>Count<font color="#000080">].</font>InUse <font color="#000080">:= </font>False<font color="#000080">;                   </font><font color="#008000"><i>{- No ports open-}

  </i></font>OldPort21 <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">];                          </font><font color="#008000"><i>{- Save PIC status-}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{****************************************************************************}

</i></font><font color="#FF0000"><b>begin
  </b></font>Init<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p></body>
</html>
