<html>
<head><title> "Sending Chars to the COM" by ASGDC@ACVAX.INRE.ASU.EDU</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I have a Turbo Pascal &quot;interrupt&quot; routine which &quot;catches&quot; incoming
&gt; characters from a COM port and stashes them in a circular buffer.
&gt; While it seems to work OK most of the time, occasionally it misses
&gt; a character (it can NOT keep up with 600 baud, but Kermit does quite
&gt; well at 9600 baud, so I know it can be &quot;fixed&quot;).  Here is the code:
&gt; (Please ignore the BEGINPROCEDURE, ENDIF, etc.; I use a pre-processor
&gt; to translate Pascal-as-it-ought-to-be-IMHO into Turbo Pascal.)
&gt;
I don't know what the trouble is with your interrupt routine, but I wrote one
about 6 months ago for a friend to use and it works fine on my machine (386
33) at 2400 and on my friends machine (486 66) at 9600.  Here it is, hope it
helps.

This unit is an array implementation of a queue, used to store incoming
characters.  An array is used instead of a linked list because I believed it
would be faster, and less overhead.
}
</i></font><font color="#FF0000"><b>UNIT </b></font>QPak<font color="#000080">;
</font><font color="#008000"><i>{$R-}
{Range checking must be turned off, so as to permit the little trick with
the array}

</i></font><font color="#FF0000"><b>INTERFACE

TYPE
  </b></font>ElementType <font color="#000080">= </font>Char<font color="#000080">;

  </font>ElementArray <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">0</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Char<font color="#000080">;

  </font>QUEUE   <font color="#000080">= </font><font color="#FF0000"><b>RECORD
    </b></font>Front<font color="#000080">,
    </font>Rear  <font color="#000080">: </font>Word<font color="#000080">;
    </font>EL    <font color="#000080">: ^</font>ElementArray<font color="#000080">;
    </font>Size  <font color="#000080">: </font>Word<font color="#000080">;
    </font>Count <font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>MakeQueueEmpty<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Q <font color="#000080">: </font>Queue<font color="#000080">;
                         </font>QSize <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>FUNCTION  </b></font>QueueIsEmpty<font color="#000080">(</font>Q <font color="#000080">: </font>Queue<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION  </b></font>QueueIsFull<font color="#000080">(</font>Q <font color="#000080">: </font>Queue<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Enqueue<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Q   <font color="#000080">: </font>Queue<font color="#000080">;
                  </font>Element <font color="#000080">: </font>ElementType<font color="#000080">);

</font><font color="#FF0000"><b>PROCEDURE </b></font>Dequeue<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Q       <font color="#000080">: </font>Queue<font color="#000080">;
                  </font><font color="#FF0000"><b>VAR </b></font>Element <font color="#000080">: </font>ElementType<font color="#000080">);

</font><font color="#FF0000"><b>IMPLEMENTATION


PROCEDURE </b></font>MakeQueueEmpty<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Q <font color="#000080">: </font>Queue<font color="#000080">; </font>QSize <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
  </b></font>GetMem<font color="#000080">(</font>Q<font color="#000080">.</font>EL<font color="#000080">,</font>QSize<font color="#000080">);
  </font>Q<font color="#000080">.</font>Front <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>Q<font color="#000080">.</font>Rear  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Q<font color="#000080">.</font>Size  <font color="#000080">:= </font>QSize<font color="#000080">;
  </font>Q<font color="#000080">.</font>Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>QueueIsEmpty<font color="#000080">(</font>Q <font color="#000080">: </font>Queue<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>QueueIsEmpty <font color="#000080">:= (</font>Q<font color="#000080">.</font>Count <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>QueueIsFull<font color="#000080">(</font>Q <font color="#000080">: </font>Queue<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>QueueIsFull <font color="#000080">:= (</font>Q<font color="#000080">.</font>Count <font color="#000080">= </font>Q<font color="#000080">.</font>Size<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>Enqueue<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Q <font color="#000080">: </font>Queue<font color="#000080">; </font>Element <font color="#000080">: </font>ElementType<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
  WITH </b></font>Q <font color="#FF0000"><b>Do BEGIN
    </b></font>Rear <font color="#000080">:= (</font>Rear <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>MOD </b></font>Size<font color="#000080">;
    </font>EL<font color="#000080">^[</font>Rear<font color="#000080">] := </font>Element<font color="#000080">;
    </font>Inc<font color="#000080">(</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Dequeue<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Q <font color="#000080">: </font>Queue<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>Element <font color="#000080">: </font>ElementType<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
  WITH </b></font>Q <font color="#FF0000"><b>DO BEGIN
    </b></font>Element <font color="#000080">:= </font>EL<font color="#000080">^[</font>Front<font color="#000080">];
    </font>Front <font color="#000080">:= (</font>Front <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>MOD </b></font>Size<font color="#000080">;
    </font>Dec<font color="#000080">(</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font><font color="#008000"><i>{
-----------------------CUT HERE--------------------

Here is the com unit.  I've commented about everyline (since it was for a
friend) so hopefilly my comments are understandable.

-----------------------CUT HERE---------------------
}
</i></font><font color="#FF0000"><b>UNIT </b></font>ComUnit<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

USES </b></font>DOS<font color="#000080">, </font>CRT<font color="#000080">, </font>QPak<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>InitPort<font color="#000080">(</font>ComPort<font color="#000080">,
                   </font>Parity<font color="#000080">,
                   </font>Stop<font color="#000080">,
                   </font>WLength <font color="#000080">: </font>Byte<font color="#000080">;
                   </font>Speed   <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>FUNCTION </b></font>CharReady<font color="#000080">(</font>ComPort <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#008000"><i>{This procedure  writes a char to desired port}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>SendChar<font color="#000080">(</font>Ch <font color="#000080">: </font>Char<font color="#000080">; </font>ComPort <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#008000"><i>{This function reads a char from the serial port by dequeueing and element}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>GetChar<font color="#000080">(</font>ComPort <font color="#000080">: </font>Byte<font color="#000080">) : </font>Char<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>ShutDown<font color="#000080">(</font>ComPort <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>TYPE
  </b></font>UART <font color="#000080">= </font><font color="#FF0000"><b>RECORD
     </b></font>THR <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#008000"><i>{Transmit Holding Register}
     </i></font>RBR <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#008000"><i>{Receive Holding Register}
     </i></font>IER <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#008000"><i>{Interrupt enable Regeister}
     </i></font>LCR <font color="#000080">: </font>Word<font color="#000080">;    </font><font color="#008000"><i>{Line Control Register}
     </i></font>MCR <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#008000"><i>{Modem Control Register}
     </i></font>LSR <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#008000"><i>{Line Status Register}
     </i></font>MSR <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#008000"><i>{Modem Status Register}
     </i></font>IRQ <font color="#000080">: </font>Integer<font color="#000080">;
     </font>DLL <font color="#000080">: </font>Word<font color="#000080">;
     </font>DLM <font color="#000080">: </font>WOrd<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#008000"><i>{This array holds the buffers for each port}
  </i></font>BufferArray  <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Queue<font color="#000080">;
  </font><font color="#008000"><i>{Here is where we save the old interrupt vectors}
  </i></font>PointerArray <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Pointer<font color="#000080">;


</font><font color="#FF0000"><b>CONST
</b></font><font color="#008000"><i>{The following are constants used in initialization, and for port adressing}
  </i></font>COM1 <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>COM2 <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
  </font>COM3 <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;
  </font>COM4 <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;

</font><font color="#008000"><i>{Baud rate divisors}
  </i></font>B600  <font color="#000080">= </font><font color="#800000">192</font><font color="#000080">;
  </font>B1200 <font color="#000080">= </font><font color="#800000">96</font><font color="#000080">;
  </font>B2400 <font color="#000080">= </font><font color="#800000">48</font><font color="#000080">;
  </font>B4800 <font color="#000080">= </font><font color="#800000">24</font><font color="#000080">;
  </font>B9600 <font color="#000080">= </font><font color="#800000">12</font><font color="#000080">;
  </font>B19200 <font color="#000080">= </font><font color="#800000">6</font><font color="#000080">;
  </font>B38400 <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;  </font><font color="#008000"><i>{If your really feeling frisky}

{Parity masks}
  </i></font>NoParity   <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>OddParity  <font color="#000080">= </font><font color="#800000">$8</font><font color="#000080">;
  </font>EvenParity <font color="#000080">= </font><font color="#800000">$18</font><font color="#000080">;

</font><font color="#008000"><i>{Stop bit masks}
  </i></font>OneStopBit <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>TwoStopBit <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;

</font><font color="#008000"><i>{OR-Mask to set divisor latch in line control register}
  </i></font>DLatch      <font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">;

</font><font color="#008000"><i>{Port address for interrupt mask port of 8259A}
  </i></font>IntMaskPort <font color="#000080">= </font><font color="#800000">$21</font><font color="#000080">;

</font><font color="#008000"><i>{Port address for 8259 interrupt control, used to send EOI}
  </i></font>IntCtlPort  <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;

</font><font color="#008000"><i>{Masks for different word lengths}
  </i></font>Word5 <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>Word6 <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>Word7 <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
  </font>Word8 <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;

</font><font color="#FF0000"><b>IMPLEMENTATION

CONST
</b></font><font color="#008000"><i>{Typed constant that contains all registers addresses for Com1..Com4}
  </i></font>RS232 <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>UART <font color="#000080">=

((</font>THR<font color="#000080">:</font><font color="#800000">$3F8</font><font color="#000080">;</font>RBR<font color="#000080">:</font><font color="#800000">$3F8</font><font color="#000080">;</font>IER<font color="#000080">:</font><font color="#800000">$3F9</font><font color="#000080">;</font>LCR<font color="#000080">:</font><font color="#800000">$3FB</font><font color="#000080">;</font>MCR<font color="#000080">:</font><font color="#800000">$3FC</font><font color="#000080">;</font>LSR<font color="#000080">:</font><font color="#800000">$3FD</font><font color="#000080">;</font>MSR<font color="#000080">:</font><font color="#800000">$3FE</font><font color="#000080">;</font>IRQ<font color="#000080">:</font><font color="#800000">4</font><font color="#000080">;</font>DLL<font color="#000080">:</font><font color="#800000">$3F8
</font><font color="#000080">;
</font>LM<font color="#000080">:</font><font color="#800000">$3F9</font><font color="#000080">),

(</font>THR<font color="#000080">:</font><font color="#800000">$2F8</font><font color="#000080">;</font>RBR<font color="#000080">:</font><font color="#800000">$2F8</font><font color="#000080">;</font>IER<font color="#000080">:</font><font color="#800000">$2F9</font><font color="#000080">;</font>LCR<font color="#000080">:</font><font color="#800000">$2FB</font><font color="#000080">;</font>MCR<font color="#000080">:</font><font color="#800000">$2FC</font><font color="#000080">;</font>LSR<font color="#000080">:</font><font color="#800000">$2FD</font><font color="#000080">;</font>MSR<font color="#000080">:</font><font color="#800000">$2FE</font><font color="#000080">;</font>IRQ<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">;</font>DLL<font color="#000080">:</font><font color="#800000">$2F8</font><font color="#000080">;
</font>LM<font color="#000080">:</font><font color="#800000">$2F9</font><font color="#000080">),
 
(</font>THR<font color="#000080">:</font><font color="#800000">$3E8</font><font color="#000080">;</font>RBR<font color="#000080">:</font><font color="#800000">$3E8</font><font color="#000080">;</font>IER<font color="#000080">:</font><font color="#800000">$3E9</font><font color="#000080">;</font>LCR<font color="#000080">:</font><font color="#800000">$3EB</font><font color="#000080">;</font>MCR<font color="#000080">:</font><font color="#800000">$3EC</font><font color="#000080">;</font>LSR<font color="#000080">:</font><font color="#800000">$3ED</font><font color="#000080">;</font>MSR<font color="#000080">:</font><font color="#800000">$3EE</font><font color="#000080">;</font>IRQ<font color="#000080">:</font><font color="#800000">4</font><font color="#000080">;</font>DLL<font color="#000080">:</font><font color="#800000">$3E8</font><font color="#000080">;
</font>LM<font color="#000080">:</font><font color="#800000">$3E9</font><font color="#000080">),
 
(</font>THR<font color="#000080">:</font><font color="#800000">$2E8</font><font color="#000080">;</font>RBR<font color="#000080">:</font><font color="#800000">$2E8</font><font color="#000080">;</font>IER<font color="#000080">:</font><font color="#800000">$2E9</font><font color="#000080">;</font>LCR<font color="#000080">:</font><font color="#800000">$2EB</font><font color="#000080">;</font>MCR<font color="#000080">:</font><font color="#800000">$2EC</font><font color="#000080">;</font>LSR<font color="#000080">:</font><font color="#800000">$2ED</font><font color="#000080">;</font>MSR<font color="#000080">:</font><font color="#800000">$2EE</font><font color="#000080">;</font>IRQ<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">;</font>DLL<font color="#000080">:</font><font color="#800000">$2E8</font><font color="#000080">;
</font>LM<font color="#000080">:</font><font color="#800000">$2E9</font><font color="#000080">));


</font><font color="#FF0000"><b>VAR
  </b></font>Buffers     <font color="#000080">: </font>BufferArray<font color="#000080">;
  </font>IntVecsSave <font color="#000080">: </font>PointerArray<font color="#000080">;

</font><font color="#008000"><i>{Inline Macros}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>DisableInterrupts <font color="#000080">;   </font><font color="#FF0000"><b>inline</b></font><font color="#000080">( </font><font color="#800000">$FA </font><font color="#008000"><i>{cli} </i></font><font color="#000080">) ;
</font><font color="#FF0000"><b>PROCEDURE </b></font>EnableInterrupts <font color="#000080">;    </font><font color="#FF0000"><b>inline</b></font><font color="#000080">( </font><font color="#800000">$FB </font><font color="#008000"><i>{sti} </i></font><font color="#000080">) ;

</font><font color="#008000"><i>{Here is the interrupt procedure for com3, its address is put int the int
 Vec table by InitPort}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>Com13ISR<font color="#000080">; </font>INTERRUPT<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
</b></font><font color="#008000"><i>{Read the character from the port and put it in the queue}
  </i></font>Enqueue<font color="#000080">(</font>Buffers<font color="#000080">[</font>Com3<font color="#000080">],</font>Char<font color="#000080">(</font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>Com3<font color="#000080">].</font>RBR<font color="#000080">]));
  </font>Port<font color="#000080">[</font>IntCtlPort<font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;  </font><font color="#008000"><i>{Non-specific EOI}
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Com24ISR<font color="#000080">; </font>INTERRUPT<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
</b></font><font color="#008000"><i>{Read the character from the port and put it in the queue}
  </i></font>Enqueue<font color="#000080">(</font>Buffers<font color="#000080">[</font>Com3<font color="#000080">],</font>Char<font color="#000080">(</font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>Com3<font color="#000080">].</font>RBR<font color="#000080">]));
  </font>Port<font color="#000080">[</font>IntCtlPort<font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;  </font><font color="#008000"><i>{Non-specific EOI}
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------------------}
{                        +++InitPort+++                         }
{                                                               }
{  ComPort: A byte specifying the comport to use Range 1..4     }
{  Speed  : This is really the baud rate divisor The predefined }
{           constants are the correct divisors for those speeds }
{  Parity,                                                      }
{  Stop,                                                        }
{  WLength: These are all bit-masks used to build               }
{           the line format byte                                }
{---------------------------------------------------------------}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>InitPort<font color="#000080">(</font>ComPort<font color="#000080">,
                   </font>Parity<font color="#000080">,
                   </font>Stop<font color="#000080">,
                   </font>WLength <font color="#000080">: </font>Byte<font color="#000080">;
                   </font>Speed   <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>VAR
  </b></font>LineFormat <font color="#000080">: </font>Byte<font color="#000080">;


</font><font color="#FF0000"><b>BEGIN
  </b></font>MakeQueueEmpty<font color="#000080">(</font>Buffers<font color="#000080">[</font>ComPort<font color="#000080">],</font><font color="#800000">2048</font><font color="#000080">);
  </font>LineFormat <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#008000"><i>{Build the line format byte}
  </i></font>LineFormat <font color="#000080">:= </font>LineFormat <font color="#FF0000"><b>OR </b></font>WLength <font color="#FF0000"><b>OR </b></font>Stop <font color="#FF0000"><b>OR </b></font>Parity<font color="#000080">;
</font><font color="#008000"><i>{Set divisor latch so we can set baud rate}
  </i></font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>LCR<font color="#000080">] := </font>LineFormat <font color="#FF0000"><b>AND </b></font>DLatch<font color="#000080">;
</font><font color="#008000"><i>{Now we set baud rate, least sig part of divisor sent first then most sig}
  </i></font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>DLL<font color="#000080">] := </font>Low<font color="#000080">(</font>Speed<font color="#000080">);
  </font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>DLM<font color="#000080">] := </font>Hi<font color="#000080">(</font>Speed<font color="#000080">);
</font><font color="#008000"><i>{Now set line format}
  </i></font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>LCR<font color="#000080">] := </font>LineFormat<font color="#000080">;
</font><font color="#008000"><i>{Must set out2 of modem control reg for interrupts, so we do it here}
  </i></font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>MCR<font color="#000080">] := </font><font color="#800000">$0B</font><font color="#000080">;
</font><font color="#008000"><i>{Save interrupt vector so we can restore it later, then set vector to
 point at our ISR}

{Now we must unmask appropriate int line in 8259A interrupt controller
 We are using IRQ4 for com1 and 3, and IRQ3 for com2 and 4, use of any
 other IRQ line will require changes to the code}
  </i></font><font color="#FF0000"><b>IF </b></font>ODD<font color="#000080">(</font>ComPort<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>GetIntVec<font color="#000080">(</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>IRQ<font color="#000080">+</font><font color="#800000">8</font><font color="#000080">,</font>IntVecsSave<font color="#000080">[</font>ComPort<font color="#000080">]);
    </font>SetIntVec<font color="#000080">(</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>IRQ<font color="#000080">+</font><font color="#800000">8</font><font color="#000080">,@</font>Com13ISR<font color="#000080">);
    </font>Port<font color="#000080">[</font>IntMaskPort<font color="#000080">] := </font>Port<font color="#000080">[</font>IntMaskPort<font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$EF
  </font><font color="#FF0000"><b>END ELSE BEGIN
    </b></font>GetIntVec<font color="#000080">(</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>IRQ<font color="#000080">+</font><font color="#800000">8</font><font color="#000080">,</font>IntVecsSave<font color="#000080">[</font>ComPort<font color="#000080">]);
    </font>SetIntVec<font color="#000080">(</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>IRQ<font color="#000080">+</font><font color="#800000">8</font><font color="#000080">,@</font>Com24ISR<font color="#000080">);
    </font>Port<font color="#000080">[</font>IntMaskPort<font color="#000080">] := </font>Port<font color="#000080">[</font>IntMaskPort<font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$F7</font><font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{Here we tell 8250 UART to interrupt on received chars}
  </i></font>DisableInterrupts<font color="#000080">;
    </font>Port<font color="#000080">[</font>Rs232<font color="#000080">[</font>ComPort<font color="#000080">].</font>IER<font color="#000080">] := </font><font color="#800000">1</font><font color="#000080">;
  </font>EnableInterrupts<font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{This function returns true if there are any chars in the buffer}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>CharReady<font color="#000080">(</font>ComPort <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>CharReady <font color="#000080">:= </font><font color="#FF0000"><b>NOT </b></font>QueueIsEmpty<font color="#000080">(</font>Buffers<font color="#000080">[</font>ComPort<font color="#000080">]);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{This procedure  writes a char to desired port}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>SendChar<font color="#000080">(</font>Ch <font color="#000080">: </font>Char<font color="#000080">; </font>ComPort <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
  </b></font><font color="#008000"><i>{Loop until transmit holding register empty}
  </i></font><font color="#FF0000"><b>WHILE </b></font><font color="#000080">(</font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>LSR<font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$20</font><font color="#000080">) &lt;&gt; </font><font color="#800000">$20 </font><font color="#FF0000"><b>DO
    </b></font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>Port<font color="#000080">[</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>THR<font color="#000080">] := </font>Byte<font color="#000080">(</font>Ch<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{This function reads a char from the serial port by dequeueing and element}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>GetChar<font color="#000080">(</font>ComPort <font color="#000080">: </font>Byte<font color="#000080">) : </font>Char<font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>Ch <font color="#000080">: </font>Char<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>Dequeue<font color="#000080">(</font>Buffers<font color="#000080">[</font>ComPort<font color="#000080">],</font>Ch<font color="#000080">);
  </font>GetChar <font color="#000080">:= </font>Ch<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>ShutDown<font color="#000080">(</font>ComPort <font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
  </b></font>SetIntVec<font color="#000080">(</font>RS232<font color="#000080">[</font>ComPort<font color="#000080">].</font>IRQ<font color="#000080">+</font><font color="#800000">8</font><font color="#000080">,</font>IntVecsSave<font color="#000080">[</font>ComPort<font color="#000080">]);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font><font color="#008000"><i>{
------------------CUT HERE---------------------

One remark is probably appropriate here.  My friend had the need to read two
ports simultaneously so that is why there are two interrupt rountine, one com
1 and 3 and one for com 2 and 4, since they use the same IRQ lines.

Here is a little test program I used.

-----------------CUT HERE----------------------
}
</i></font><font color="#FF0000"><b>USES </b></font>CRT<font color="#000080">, </font>ComUnit<font color="#000080">;
</font><font color="#FF0000"><b>VAR
 </b></font>Ch   <font color="#000080">: </font>Char<font color="#000080">;
 </font>Done <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>Done <font color="#000080">:= </font>FALSE<font color="#000080">;
  </font>InitPort<font color="#000080">(</font>Com3<font color="#000080">,</font>NoParity<font color="#000080">,</font>OneStopBit<font color="#000080">,</font>Word8<font color="#000080">,</font>B2400<font color="#000080">);
  </font>ClrScr<font color="#000080">;
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Com test in progress.  F1 to exit'</font><font color="#000080">);
  </font><font color="#FF0000"><b>REPEAT
    IF </b></font>CharReady<font color="#000080">(</font>Com3<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Ch <font color="#000080">:= </font>GetChar<font color="#000080">(</font>Com3<font color="#000080">);
      </font>Write<font color="#000080">(</font>Ch<font color="#000080">);
    </font><font color="#FF0000"><b>END
    ELSE IF </b></font>Keypressed <font color="#FF0000"><b>THEN BEGIN
      </b></font>Ch <font color="#000080">:= </font>ReadKey<font color="#000080">;
      </font><font color="#FF0000"><b>IF </b></font>CH <font color="#000080">= </font><font color="#800000">#0 </font><font color="#FF0000"><b>THEN BEGIN </b></font><font color="#008000"><i>{Extended key scan code}
        </i></font>Ch <font color="#000080">:= </font>Readkey<font color="#000080">;
        </font><font color="#FF0000"><b>IF </b></font>Ch <font color="#000080">= </font><font color="#800000">#59 </font><font color="#FF0000"><b>THEN  </b></font><font color="#008000"><i>{F1}
          </i></font>Done <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>END ELSE
        </b></font>SendChar<font color="#000080">(</font>Ch<font color="#000080">,</font>Com3<font color="#000080">);
    </font><font color="#FF0000"><b>END
 UNTIL </b></font>Done<font color="#000080">;
 </font>ShutDown<font color="#000080">(</font>Com3<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font><font color="#008000"><i>{

I hope this helps.  It does work, although there could some thing wrong given
I'm no expert.  I also wrote some routines in assember about a year and a
half ago, so if you really want assembly code I'd be happy to did them out.
}

</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p></body>
</html>
