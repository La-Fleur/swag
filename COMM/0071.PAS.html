<html>
<head><title> "Serial Communications in Pascal" by DAVE JARVIS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0071.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
&gt;     Ok... I have fifty million different modem units, sources, docs
&gt; I have not been able to get any where with any of them....  All i want

I remember being in your shoes a long time ago, my friend.  I haven't
a Unit, per se, but here is _WORKING_ Pascal source (excuse the
documentation style, I originally wrote the code in C) that compiles under
TP 6.0.

  Written by Dave Jarvis.
  
  The purpose of this program is to do a simple communications protocol and 
  demonstrate how Serial communications can be Serially driven. 
} 
 
</i></font><font color="#FF0000"><b>USES </b></font>DOS<font color="#000080">, </font>Crt<font color="#000080">; 
 
</font><font color="#FF0000"><b>CONST 
  </b></font>COM1      <font color="#000080">= </font><font color="#800000">$3F8</font><font color="#000080">;    </font><font color="#008000"><i>{ Communications port 1 address.     } 
  </i></font>COM2      <font color="#000080">= </font><font color="#800000">$2F8</font><font color="#000080">;    </font><font color="#008000"><i>{ Communications port 2 address.     } 
  </i></font>THR       <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;     </font><font color="#008000"><i>{ Transmitter holding register.      } 
  </i></font>RDR       <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;     </font><font color="#008000"><i>{ Receiver data register.            } 
  </i></font>BRDL      <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;     </font><font color="#008000"><i>{ Baud rate low divisor register.    } 
  </i></font>BRDH      <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;     </font><font color="#008000"><i>{ Baud rate high divisor register.   } 
  </i></font>IER       <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;     </font><font color="#008000"><i>{ Interrupt enable register.         } 
  </i></font>IIR       <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;     </font><font color="#008000"><i>{ Interrupt identIFication register. } 
  </i></font>LCR       <font color="#000080">= </font><font color="#800000">$03</font><font color="#000080">;     </font><font color="#008000"><i>{ Line control register.             } 
  </i></font>MCR       <font color="#000080">= </font><font color="#800000">$04</font><font color="#000080">;     </font><font color="#008000"><i>{ Modem control register.            } 
  </i></font>LSR       <font color="#000080">= </font><font color="#800000">$05</font><font color="#000080">;     </font><font color="#008000"><i>{ Line status register.              } 
  </i></font>MSR       <font color="#000080">= </font><font color="#800000">$06</font><font color="#000080">;     </font><font color="#008000"><i>{ Modem status register.             } 
 
  </i></font>SET_BAUD  <font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">;     </font><font color="#008000"><i>{ DLAB.                              } 
  </i></font>CTS_DSR   <font color="#000080">= </font><font color="#800000">$30</font><font color="#000080">;     </font><font color="#008000"><i>{ Check for DSR and CTS in MSR.      } 
  </i></font>THREMPTY  <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;     </font><font color="#008000"><i>{ Check for THR empty in LSR.        } 
 
  </i></font>WORD7      <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;    </font><font color="#008000"><i>{ Bits 0 and 1 when setting LCR.     } 
  </i></font>WORD8      <font color="#000080">= </font><font color="#800000">$03</font><font color="#000080">; 
  </font>BIT1       <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;    </font><font color="#008000"><i>{ Bit 3 when setting LCR.            } 
  </i></font>BIT2       <font color="#000080">= </font><font color="#800000">$04</font><font color="#000080">; 
  </font>NONE       <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;    </font><font color="#008000"><i>{ Bits 4, 5, and 6 when setting LCR. } 
  </i></font>EVEN       <font color="#000080">= </font><font color="#800000">$30</font><font color="#000080">; 
  </font>ODD        <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">; 
 
  </font>INT_ENABL  <font color="#000080">= </font><font color="#800000">$0B</font><font color="#000080">;    </font><font color="#008000"><i>{ Tell UART to perform interrupts.   } 
  </i></font>PIC        <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;    </font><font color="#008000"><i>{ Address of PIC.                    } 
  </i></font>PIC_CNTL   <font color="#000080">= </font><font color="#800000">$21</font><font color="#000080">;    </font><font color="#008000"><i>{ Address of PIC control register.   } 
  </i></font>IRQ4_MASK  <font color="#000080">= </font><font color="#800000">$EF</font><font color="#000080">;    </font><font color="#008000"><i>{ Mask for IRQ4.                     } 
  </i></font>COM_INT    <font color="#000080">= </font><font color="#800000">$0C</font><font color="#000080">;    </font><font color="#008000"><i>{ Communications interrupt to tap.   } 
  </i></font>EOI        <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;    </font><font color="#008000"><i>{ End of interrupt signal for PIC.   } 
  </i></font>DATA_REC   <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;    </font><font color="#008000"><i>{ Interrupt on data received.        } 
  </i></font>WRITE_CH   <font color="#000080">= </font><font color="#800000">$0E</font><font color="#000080">;    </font><font color="#008000"><i>{ Write character function.          } 
 
  </i></font>XON_CH     <font color="#000080">= </font><font color="#800000">#$11</font><font color="#000080">;   </font><font color="#008000"><i>{ XON protocol control character.    } 
  </i></font>XOFF_CH    <font color="#000080">= </font><font color="#800000">#$13</font><font color="#000080">;   </font><font color="#008000"><i>{ XOFF protocol control character.   } 
  </i></font>EOT        <font color="#000080">= </font><font color="#800000">#$04</font><font color="#000080">;   </font><font color="#008000"><i>{ End of transmission character.     }

  </i></font>MAX_BUFF   <font color="#000080">= </font><font color="#800000">256</font><font color="#000080">;     </font><font color="#008000"><i>{ Maximum characters in the buffer.  }
  </i></font>BUFF_FULL  <font color="#000080">= </font><font color="#800000">0.75</font><font color="#000080">;    </font><font color="#008000"><i>{ Buffer full @ 75% of MAX_BUFF.     }
  </i></font>BUFF_EMPT  <font color="#000080">= </font><font color="#800000">0.50</font><font color="#000080">;    </font><font color="#008000"><i>{ Buffer empty @ 50% of MAX_BUFF.    }

  </i></font>ERR        <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">;

</font><font color="#FF0000"><b>TYPE
  </b></font>RecLinkPtr <font color="#000080">= ^</font>Receive<font color="#000080">;

  </font>Receive <font color="#000080">= </font><font color="#FF0000"><b>RECORD
              </b></font>rec_char <font color="#000080">: </font>CHAR<font color="#000080">;
              </font>Next     <font color="#000080">: </font>RecLinkPtr<font color="#000080">;
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>rec_buff<font color="#000080">,                  </font><font color="#008000"><i>{ Global linked list. } 
  </i></font>to_write   <font color="#000080">: </font>RecLinkPtr<font color="#000080">; 
  </font>buff_Count <font color="#000080">: </font>INTEGER<font color="#000080">;      </font><font color="#008000"><i>{ Number of characters in buffer.    } 
  </i></font>xon        <font color="#000080">: </font>BOOLEAN<font color="#000080">;      </font><font color="#008000"><i>{ Enable send ability.               } 
 
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ShowUsage<font color="#000080">; 
</font><font color="#FF0000"><b>Begin 
   </b></font>WriteLn<font color="#000080">( </font><font color="#800000">'Usage : TERMINAL &lt;baud&gt; &lt;parity&gt; &lt;data bits&gt; &lt;stop bits&gt;' </font><font color="#000080">); 
   </font>WriteLn<font color="#000080">( </font><font color="#800000">'Where : &lt;baud&gt; is any of 300, 1200, 2400, 9600;' </font><font color="#000080">); 
   </font>WriteLn<font color="#000080">( </font><font color="#800000">'        &lt;parity&gt; is any of N, O, E;' </font><font color="#000080">); 
   </font>WriteLn<font color="#000080">( </font><font color="#800000">'        &lt;data bits&gt; is either 7 or 8;' </font><font color="#000080">); 
   </font>WriteLn<font color="#000080">( </font><font color="#800000">'        &lt;stop bits&gt; is either 1 or 2.' </font><font color="#000080">); 
 
   </font>Halt<font color="#000080">( </font><font color="#800000">0 </font><font color="#000080">);

</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
</font><font color="#FF0000"><b>PROCEDURE </b></font>setup<font color="#000080">( </font>baud<font color="#000080">, </font>parity<font color="#000080">, </font>data_bits<font color="#000080">, </font>stop_bits <font color="#000080">: </font>INTEGER <font color="#000080">); 
</font><font color="#FF0000"><b>VAR 
  </b></font>setup <font color="#000080">: </font>INTEGER<font color="#000080">; 
 
</font><font color="#FF0000"><b>Begin 
  </b></font>setup <font color="#000080">:= </font>parity<font color="#000080">;

 
  </font><font color="#008000"><i>{ Set DLAB such that baud rate can be changed/set. } 
  </i></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>LCR <font color="#000080">] := </font>SET_BAUD<font color="#000080">; 
 
  </font><font color="#FF0000"><b>CASE </b></font>baud <font color="#FF0000"><b>OF 
     </b></font><font color="#800000">300 </font><font color="#000080">: </font><font color="#FF0000"><b>Begin 
             </b></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDL <font color="#000080">] := </font><font color="#800000">$80</font><font color="#000080">; 
             </font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDH <font color="#000080">] := </font><font color="#800000">$01</font><font color="#000080">; 
           </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
    </font><font color="#800000">1200 </font><font color="#000080">: </font><font color="#FF0000"><b>Begin 
             </b></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDL <font color="#000080">] := </font><font color="#800000">$60</font><font color="#000080">; 
             </font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDH <font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">; 
           </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
    </font><font color="#800000">2400 </font><font color="#000080">: </font><font color="#FF0000"><b>Begin 
             </b></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDL <font color="#000080">] := </font><font color="#800000">$30</font><font color="#000080">; 
             </font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDH <font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">; 
           </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
    </font><font color="#800000">9600 </font><font color="#000080">: </font><font color="#FF0000"><b>Begin 
             </b></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDL <font color="#000080">] := </font><font color="#800000">$0C</font><font color="#000080">; 
             </font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>BRDH <font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">; 
           </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>ELSE
      </b></font>ShowUsage<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>CASE </b></font>data_bits <font color="#FF0000"><b>OF
    </b></font><font color="#800000">7  </font><font color="#000080">: </font>setup <font color="#000080">:= </font>setup <font color="#FF0000"><b>OR </b></font>WORD7<font color="#000080">;
    </font><font color="#800000">8  </font><font color="#000080">: </font>setup <font color="#000080">:= </font>setup <font color="#FF0000"><b>OR </b></font>WORD8<font color="#000080">;
    </font><font color="#FF0000"><b>ELSE
      </b></font>ShowUsage<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>CASE </b></font>stop_bits <font color="#FF0000"><b>OF
    </b></font><font color="#800000">1  </font><font color="#000080">: </font>setup <font color="#000080">:= </font>setup <font color="#FF0000"><b>OR </b></font>BIT1<font color="#000080">;
    </font><font color="#800000">2  </font><font color="#000080">: </font>setup <font color="#000080">:= </font>setup <font color="#FF0000"><b>OR </b></font>BIT2<font color="#000080">;
    </font><font color="#FF0000"><b>ELSE
      </b></font>ShowUsage<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Send final (calculated) setup Value to the communications port. }
  </i></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>LCR <font color="#000080">] := </font>setup<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>add_char<font color="#000080">( </font>ch <font color="#000080">: </font>CHAR <font color="#000080">);
</font><font color="#FF0000"><b>Begin 
  </b></font><font color="#008000"><i>{ IF the buffer is full, then sound the speaker twice -- toss char. } 
  </i></font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>buff_Count <font color="#000080">= </font>MAX_BUFF <font color="#000080">) </font><font color="#FF0000"><b>THEN 
  Begin 
    </b></font>Sound<font color="#000080">( </font><font color="#800000">1000 </font><font color="#000080">); 
    </font>Sound<font color="#000080">( </font><font color="#800000">900 </font><font color="#000080">); 
    </font>NoSound<font color="#000080">; 
 
    </font>Exit<font color="#000080">; 
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
  </font><font color="#008000"><i>{ Store character in buffer. } 
  </i></font>rec_buff<font color="#000080">^.</font>rec_char <font color="#000080">:= </font>ch<font color="#000080">; 
 
  </font><font color="#008000"><i>{ Point to next storage position. } 
  </i></font>rec_buff <font color="#000080">:= </font>rec_buff<font color="#000080">^.</font>next<font color="#000080">; 
 
  </font><font color="#008000"><i>{ Increment number of characters in buffer. } 
  </i></font>INC<font color="#000080">( </font>buff_Count <font color="#000080">); 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
</font><font color="#008000"><i>{$F+} 
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>receive_ch<font color="#000080">; </font>INTERRUPT<font color="#000080">; 
</font><font color="#FF0000"><b>VAR 
  </b></font>ch <font color="#000080">: </font>CHAR<font color="#000080">; 
 
</font><font color="#FF0000"><b>Begin 
  </b></font>ch <font color="#000080">:= </font>CHAR<font color="#000080">(</font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>RDR <font color="#000080">]); 
 
  </font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>ch <font color="#000080">= </font>XON_CH <font color="#000080">) </font><font color="#FF0000"><b>THEN 
    </b></font>xon <font color="#000080">:= </font>TRUE 
  <font color="#FF0000"><b>ELSE IF</b></font><font color="#000080">( </font>ch <font color="#000080">= </font>XOFF_CH <font color="#000080">) </font><font color="#FF0000"><b>THEN 
    </b></font>xon <font color="#000080">:= </font>FALSE 
  <font color="#FF0000"><b>ELSE 
    </b></font>add_char<font color="#000080">( </font>CHAR<font color="#000080">(</font>ch<font color="#000080">) ); 
 
  </font><font color="#008000"><i>{ Send End of interrupt signal to PIC chip. } 
  </i></font>Port<font color="#000080">[ </font>PIC <font color="#000080">] := </font>EOI<font color="#000080">; 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
</font><font color="#008000"><i>{$F-} 
 
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>xmit<font color="#000080">( </font>ch <font color="#000080">: </font>CHAR <font color="#000080">); 
</font><font color="#FF0000"><b>Begin 
  </b></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>THR <font color="#000080">] := </font>INTEGER<font color="#000080">(</font>ch<font color="#000080">); 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>can_xmit <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font><font color="#008000"><i>{  IF input characters can be sent, and the DSR, CTS and THREMPTY are
     all set high, then the character read from keyboard can be sent.
  }
  </i></font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>xon <font color="#FF0000"><b>AND </b></font><font color="#000080">((</font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>MSR <font color="#000080">] </font><font color="#FF0000"><b>AND </b></font>CTS_DSR<font color="#000080">)  = </font>CTS_DSR<font color="#000080">) </font><font color="#FF0000"><b>AND
             </b></font><font color="#000080">((</font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>LSR <font color="#000080">] </font><font color="#FF0000"><b>AND </b></font>THREMPTY<font color="#000080">) = </font>THREMPTY<font color="#000080">) ) </font><font color="#FF0000"><b>THEN
    </b></font>can_xmit <font color="#000080">:= </font>TRUE
  <font color="#FF0000"><b>ELSE
    </b></font>can_xmit <font color="#000080">:= </font>FALSE<font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>writech<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>Write<font color="#000080">( </font>to_write<font color="#000080">^.</font>rec_char <font color="#000080">);

  </font><font color="#008000"><i>{ Decrement the number of actual elements in the buffer. }
  </i></font>DEC<font color="#000080">( </font>buff_Count <font color="#000080">);

  </font><font color="#008000"><i>{ Point to the next character to write (IF any are left). }
  </i></font>to_write <font color="#000080">:= </font>to_write<font color="#000080">^.</font>next<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>send_string<font color="#000080">( </font>s <font color="#000080">: </font><font color="#FF0000"><b>STRING </b></font><font color="#000080">);
</font><font color="#FF0000"><b>VAR 
  </b></font>Count <font color="#000080">: </font>INTEGER<font color="#000080">; 
 
</font><font color="#FF0000"><b>Begin 
  FOR </b></font>Count <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>Length<font color="#000080">( </font>S <font color="#000080">) </font><font color="#FF0000"><b>DO 
  Begin 
    WHILE</b></font><font color="#000080">( </font><font color="#FF0000"><b>NOT </b></font>can_xmit <font color="#000080">) </font><font color="#FF0000"><b>DO 
      </b></font><font color="#000080">; 
 
    </font>xmit<font color="#000080">( </font>s<font color="#000080">[ </font>Count <font color="#000080">] ); 
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
</font><font color="#FF0000"><b>PROCEDURE </b></font>Serial<font color="#000080">; 
</font><font color="#FF0000"><b>VAR 
  </b></font>ch       <font color="#000080">: </font>CHAR<font color="#000080">;       </font><font color="#008000"><i>{ Character read from the keyboard.    } 
  </i></font>done<font color="#000080">,                  </font><font color="#008000"><i>{ Loop until done = TRUE.              } 
  </i></font>send_xon <font color="#000080">: </font>BOOLEAN<font color="#000080">;    </font><font color="#008000"><i>{ TRUE IF XON character has been sent. } 
 
</i></font><font color="#FF0000"><b>Begin 
  </b></font>done     <font color="#000080">:= </font>FALSE<font color="#000080">; 
  </font>send_xon <font color="#000080">:= </font>TRUE<font color="#000080">; 
 
  </font><font color="#FF0000"><b>Repeat 
    </b></font><font color="#008000"><i>{  IF a character is in the keyboard buffer, and it can be sent to the 
       UART, then read it from the keyboard buffer, and transmit it. 
    } 
    </i></font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>can_xmit <font color="#FF0000"><b>AND </b></font>KeyPressed <font color="#000080">) </font><font color="#FF0000"><b>THEN 
    Begin 
      </b></font>ch <font color="#000080">:= </font>ReadKey<font color="#000080">; 
 
      </font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>ch <font color="#000080">= </font>EOT <font color="#000080">) </font><font color="#FF0000"><b>THEN 
        </b></font>done <font color="#000080">:= </font>TRUE 
      <font color="#FF0000"><b>ELSE 
        </b></font>xmit<font color="#000080">( </font>ch <font color="#000080">); 
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
    </font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>buff_Count <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>THEN 
    Begin 
      </b></font><font color="#008000"><i>{ Display a character from the buffer. } 
      </i></font>writech<font color="#000080">; 
 
      </font><font color="#008000"><i>{ IF the buffer is more than 75% full, then send XOFF char ASAP. } 
      </i></font><font color="#FF0000"><b>IF</b></font><font color="#000080">( (</font>buff_Count <font color="#000080">/ (</font>MAX_BUFF <font color="#000080">* </font><font color="#800000">1.0</font><font color="#000080">)) &gt; </font>BUFF_FULL <font color="#000080">) </font><font color="#FF0000"><b>THEN 
      Begin
        </b></font><font color="#008000"><i>{ Wait until a character can be sent. } 
        </i></font><font color="#FF0000"><b>WHILE</b></font><font color="#000080">( </font><font color="#FF0000"><b>NOT </b></font>can_xmit <font color="#000080">) </font><font color="#FF0000"><b>DO 
          </b></font><font color="#000080">; 
 
        </font><font color="#008000"><i>{ Send the XOFF control code. } 
        </i></font>xmit<font color="#000080">( </font>XOFF_CH <font color="#000080">); 
 
        </font><font color="#008000"><i>{ Indicate that an XON can be sent anytime. } 
        </i></font>send_xon <font color="#000080">:= </font>FALSE<font color="#000080">; 
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
      </font><font color="#008000"><i>{ IF the buffer is less than 50% full, then send XON char ASAP. } 
      </i></font><font color="#FF0000"><b>IF</b></font><font color="#000080">( ((</font>buff_Count <font color="#000080">/ (</font>MAX_BUFF <font color="#000080">* </font><font color="#800000">1.0</font><font color="#000080">)) &lt; </font>BUFF_EMPT<font color="#000080">) </font><font color="#FF0000"><b>AND 
           </b></font><font color="#000080">(</font><font color="#FF0000"><b>NOT </b></font>send_xon<font color="#000080">) ) </font><font color="#FF0000"><b>THEN 
      Begin 
        </b></font><font color="#008000"><i>{ Wait until a character can be sent. } 
        </i></font><font color="#FF0000"><b>WHILE</b></font><font color="#000080">( </font><font color="#FF0000"><b>NOT </b></font>can_xmit <font color="#000080">) </font><font color="#FF0000"><b>DO 
          </b></font><font color="#000080">; 
 
        </font><font color="#008000"><i>{ Send the XON control code. } 
        </i></font>xmit<font color="#000080">( </font>XON_CH <font color="#000080">); 
 
        </font><font color="#008000"><i>{ An XON control code has been sent. } 
        </i></font>send_xon <font color="#000080">:= </font>TRUE<font color="#000080">; 
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
  </font><font color="#FF0000"><b>Until</b></font><font color="#000080">( </font>done <font color="#000080">); 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 

</font><font color="#FF0000"><b>FUNCTION </b></font>Value<font color="#000080">( </font>NumS <font color="#000080">: </font><font color="#FF0000"><b>STRING </b></font><font color="#000080">) : </font>LONGINT<font color="#000080">;
</font><font color="#FF0000"><b>VAR 
  </b></font>O<font color="#000080">, </font>M<font color="#000080">, </font>S<font color="#000080">, </font>C <font color="#000080">: </font>LONGINT<font color="#000080">; 
 
</font><font color="#FF0000"><b>Begin 
  </b></font>S <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; 
  </font>M <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">; 
 
  </font><font color="#FF0000"><b>FOR </b></font>C <font color="#000080">:= </font>Length<font color="#000080">(</font>NumS<font color="#000080">) </font><font color="#FF0000"><b>DOWNTO </b></font><font color="#800000">1 </font><font color="#FF0000"><b>DO 
  Begin 
    </b></font>O <font color="#000080">:= </font>Ord<font color="#000080">( </font>NumS<font color="#000080">[</font>C<font color="#000080">] ); 
 
    </font><font color="#FF0000"><b>IF </b></font>NumS<font color="#000080">[</font>C<font color="#000080">] </font><font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">'0'</font><font color="#000080">..</font><font color="#800000">'9'</font><font color="#000080">] </font><font color="#FF0000"><b>THEN 
    Begin 
      </b></font>INC<font color="#000080">( </font>S<font color="#000080">, </font>M <font color="#000080">* (</font>O <font color="#000080">- </font><font color="#800000">48</font><font color="#000080">) ); 
      </font>M <font color="#000080">:= </font>M <font color="#000080">* </font><font color="#800000">10</font><font color="#000080">; 
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
  </font>Value <font color="#000080">:= </font>S<font color="#000080">; 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
</font><font color="#FF0000"><b>FUNCTION </b></font>UCase<font color="#000080">( </font>S <font color="#000080">: </font><font color="#FF0000"><b>STRING </b></font><font color="#000080">) : </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">; 
</font><font color="#FF0000"><b>VAR 
  </b></font>C <font color="#000080">: </font>BYTE<font color="#000080">; 
 
</font><font color="#FF0000"><b>Begin 
  FOR </b></font>C <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>Length<font color="#000080">(</font>S<font color="#000080">) </font><font color="#FF0000"><b>DO 
    </b></font>S<font color="#000080">[</font>C<font color="#000080">] := </font>UpCase<font color="#000080">( </font>S<font color="#000080">[</font>C<font color="#000080">] ); 
 
  </font>UCase <font color="#000080">:= </font>S<font color="#000080">; 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
</font><font color="#FF0000"><b>VAR 
  </b></font>Count<font color="#000080">,                </font><font color="#008000"><i>{ Simple Counter.                    } 
  </i></font>baud<font color="#000080">,                 </font><font color="#008000"><i>{ Baud rate.                         } 
  </i></font>parity<font color="#000080">,               </font><font color="#008000"><i>{ Parity    - NONE, EVEN, ODD.       } 
  </i></font>data_bits<font color="#000080">,            </font><font color="#008000"><i>{ Data bits - 7, 8.                  } 
  </i></font>stop_bits  <font color="#000080">: </font>INTEGER<font color="#000080">; </font><font color="#008000"><i>{ Stop bits - 1, 2.                  } 
  </i></font>temp<font color="#000080">, 
  </font>current    <font color="#000080">: </font>RecLinkPtr<font color="#000080">; 
  </font>SecParam   <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">; 
  </font>save_int   <font color="#000080">: </font>POINTER<font color="#000080">; 
 
</font><font color="#FF0000"><b>Begin 
  </b></font>buff_Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>xon        <font color="#000080">:= </font>TRUE<font color="#000080">;

  </font><font color="#008000"><i>{ 4 command line arguments (include program name) are required. }
  </i></font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>ParamCount <font color="#000080">&lt;&gt; </font><font color="#800000">4 </font><font color="#000080">) </font><font color="#FF0000"><b>THEN
    </b></font>ShowUsage<font color="#000080">;

  </font><font color="#008000"><i>{ The first command line argument is specified to be the baud rate. }
  </i></font>baud <font color="#000080">:= </font>Value<font color="#000080">( </font>ParamStr<font color="#000080">( </font><font color="#800000">1 </font><font color="#000080">) );

  </font><font color="#008000"><i>{ Convert second argument to upper case so first letter can be checked
    for parity. }
  </i></font>SecParam <font color="#000080">:= </font>ParamStr<font color="#000080">( </font><font color="#800000">2 </font><font color="#000080">);
  </font>SecParam <font color="#000080">:= </font>UCase<font color="#000080">( </font>SecParam <font color="#000080">);

  </font><font color="#008000"><i>{ Check first character of 2nd command line parameter for parity. }
  </i></font><font color="#FF0000"><b>CASE </b></font>SecParam<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>OF
    </b></font><font color="#800000">'N' </font><font color="#000080">: </font>parity <font color="#000080">:= </font>NONE<font color="#000080">;
    </font><font color="#800000">'O' </font><font color="#000080">: </font>parity <font color="#000080">:= </font>ODD<font color="#000080">;
    </font><font color="#800000">'E' </font><font color="#000080">: </font>parity <font color="#000080">:= </font>EVEN<font color="#000080">;
  </font><font color="#FF0000"><b>ELSE
    </b></font>ShowUsage<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font>rec_buff <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
  </font><font color="#008000"><i>{  Allocate enough memory for MAX_BUFF characters (New is not re-entrant).
  } 
  </i></font><font color="#FF0000"><b>FOR </b></font>Count <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font>MAX_BUFF <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>DO 
  Begin 
    </b></font>New<font color="#000080">( </font>temp <font color="#000080">); 
 
    </font>temp<font color="#000080">^.</font>next     <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">; 
    </font>temp<font color="#000080">^.</font>rec_char <font color="#000080">:= </font><font color="#800000">#0</font><font color="#000080">; 
 
    </font><font color="#FF0000"><b>IF</b></font><font color="#000080">( </font>rec_buff <font color="#000080">= </font><font color="#FF0000"><b>NIL </b></font><font color="#000080">) </font><font color="#FF0000"><b>THEN 
      </b></font>rec_buff <font color="#000080">:= </font>temp 
    <font color="#FF0000"><b>ELSE 
    Begin 
      </b></font>current <font color="#000080">:= </font>rec_buff<font color="#000080">; 
 
      </font><font color="#FF0000"><b>WHILE</b></font><font color="#000080">( </font>current<font color="#000080">^.</font>next <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>NIL </b></font><font color="#000080">) </font><font color="#FF0000"><b>DO 
        </b></font>current <font color="#000080">:= </font>current<font color="#000080">^.</font>next<font color="#000080">; 
 
      </font>current<font color="#000080">^.</font>next <font color="#000080">:= </font>temp<font color="#000080">; 
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
 
  </font><font color="#008000"><i>{  Create a circular buffer by pointing the last element in the list to 
     the start (head) of the list. 
  } 
  </i></font>temp<font color="#000080">^.</font>next <font color="#000080">:= </font>rec_buff<font color="#000080">; 
 
  </font><font color="#008000"><i>{ Point to the first character to write within the buffer. } 
  </i></font>to_write <font color="#000080">:= </font>rec_buff<font color="#000080">; 
 
  </font>data_bits <font color="#000080">:= </font>Value<font color="#000080">( </font>ParamStr<font color="#000080">( </font><font color="#800000">3 </font><font color="#000080">) );

  </font>stop_bits <font color="#000080">:= </font>Value<font color="#000080">( </font>ParamStr<font color="#000080">( </font><font color="#800000">4 </font><font color="#000080">) ); 
 
  </font>getintvec<font color="#000080">( </font>COM_INT<font color="#000080">, </font>save_int <font color="#000080">); 
 
  </font><font color="#008000"><i>{ Set vector = $0C to new interrupt routine. } 
  </i></font>SetIntVec<font color="#000080">( </font>COM_INT<font color="#000080">, </font>Addr<font color="#000080">( </font>receive_ch <font color="#000080">) ); 
 
  </font><font color="#008000"><i>{ Initialize the modem according to the command line parameters. } 
  </i></font>setup<font color="#000080">( </font>baud<font color="#000080">, </font>parity<font color="#000080">, </font>data_bits<font color="#000080">, </font>stop_bits <font color="#000080">); 
 
  </font><font color="#008000"><i>{ Interrupt on received character. } 
  </i></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>IER <font color="#000080">] := </font>DATA_REC<font color="#000080">; 
 
  </font><font color="#008000"><i>{ Enable interrupts }
  </i></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>MCR <font color="#000080">] := </font>INT_ENABL<font color="#000080">; 
 
  </font><font color="#008000"><i>{ Set PIC control register to enable IRQ4. } 
  </i></font>Port<font color="#000080">[ </font>PIC_CNTL <font color="#000080">] := </font>Port<font color="#000080">[ </font>PIC_CNTL <font color="#000080">] </font><font color="#FF0000"><b>AND </b></font>IRQ4_MASK<font color="#000080">; 
 
  </font><font color="#008000"><i>{ Set MSR such that CTS and DSR are high. } 
  </i></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>MSR <font color="#000080">] := </font>CTS_DSR<font color="#000080">; 
 
  </font>ClrScr<font color="#000080">; 
  </font>WriteLn<font color="#000080">( </font><font color="#800000">'Type Control-D at any time to quit.' </font><font color="#000080">); 
 
  </font><font color="#008000"><i>{ Repeat Serial communications. } 
  </i></font>Serial<font color="#000080">; 
 
  </font><font color="#008000"><i>{ Disable interrupts } 
  </i></font>Port<font color="#000080">[ </font>COM1 <font color="#000080">+ </font>IER <font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">; 
 
  </font><font color="#008000"><i>{ Set PIC control register to disable IRQ4. } 
  </i></font>Port<font color="#000080">[ </font>PIC_CNTL <font color="#000080">] := </font>Port<font color="#000080">[ </font>PIC_CNTL <font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font><font color="#FF0000"><b>NOT </b></font>IRQ4_MASK<font color="#000080">); 
 
  </font><font color="#008000"><i>{ Set vector = $0C to old interrupt routine. } 
  </i></font>SetIntVec<font color="#000080">( </font>COM_INT<font color="#000080">, </font>save_int <font color="#000080">); 
 
  </font><font color="#008000"><i>{ Deallocate all the memory used in the buffer. } 
  </i></font><font color="#FF0000"><b>FOR </b></font>Count <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font>MAX_BUFF <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>DO 
  Begin 
    </b></font>temp     <font color="#000080">:= </font>rec_buff<font color="#000080">; 
    </font>rec_buff <font color="#000080">:= </font>rec_buff<font color="#000080">^.</font>next<font color="#000080">; 
 
    </font>Dispose<font color="#000080">( </font>temp <font color="#000080">); 
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">; 
</font><font color="#FF0000"><b>End</b></font><font color="#000080">. 
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0071.PAS">Original</a><b>]</b></p></body>
</html>
