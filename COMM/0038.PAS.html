<html>
<head><title> "Simple COM I/O" by ELAD NACHMAN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0038.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: ELAD NACHMAN
Subj: High Speed COM I/O
---------------------------------------------------------------------------
 RL&gt; Dose anyone know how a humble young TP programmer can access
 RL&gt; modems at speeds of say 57,600 baud rates? I would love even
 RL&gt; 14,400 routines. I had a set of simple I/O routines, but speeds
 RL&gt; over 2400 term programs would lose characters. I would like to
 RL&gt; write some doors for a BBS but can't break the 2400 limit.

You probably use a very simple way, which doesn't envolves capturing the
modem's Com port IRQ. That's why you use chars over faster transmitions.
To make sure the program will be fast, optimize it to assembler, or at least
use I/O Ports manipulations (If you odn't use it already).
A cut from a source I have here (Design for com1, if you need support for other
ports use a guide such as Helppc. If you want To write Doors for BBSes you
better use Fossil functions, For that either use Fsildoc.??? (It's in several
FTP sites) or Ralf Brown's Interrupt list):
}

</i></font><font color="#FF0000"><b>const

</b></font><font color="#008000"><i>{ 8250 IRQ Registers }

</i></font>Data<font color="#000080">=</font><font color="#800000">$03f8</font><font color="#000080">; </font><font color="#008000"><i>{ Contains 8 bits for send/receive }

</i></font>IER<font color="#000080">=</font><font color="#800000">$03f9</font><font color="#000080">; </font><font color="#008000"><i>{ Enables Serial Port when set to 1 }

</i></font>LCR<font color="#000080">=</font><font color="#800000">$03fb</font><font color="#000080">; </font><font color="#008000"><i>{ Sets communication Parameters }

</i></font>MCR<font color="#000080">=</font><font color="#800000">$03FC</font><font color="#000080">; </font><font color="#008000"><i>{ bits 1,2,4 are turned on to ready modems }

</i></font>LSR<font color="#000080">=</font><font color="#800000">$3FD</font><font color="#000080">; </font><font color="#008000"><i>{ when bit 6 is on, it is safe to send a byte }

</i></font>MDMMSR<font color="#000080">=</font><font color="#800000">$03FE</font><font color="#000080">; </font><font color="#008000"><i>{ initialized to $80 when starting }

</i></font>ENBLRDY<font color="#000080">=</font><font color="#800000">$01</font><font color="#000080">; </font><font color="#008000"><i>{ initial value for port[IER] }

</i></font>MDMMOD<font color="#000080">=</font><font color="#800000">$0b</font><font color="#000080">; </font><font color="#008000"><i>{ initial value for port[MCR] }

</i></font>MDMCD<font color="#000080">=</font><font color="#800000">$80</font><font color="#000080">; </font><font color="#008000"><i>{ initial value for port[MDMMSR] }

</i></font>INTCTLR<font color="#000080">=</font><font color="#800000">$21</font><font color="#000080">; </font><font color="#008000"><i>{ port for 8259 interrupt controller }

</i></font><font color="#FF0000"><b>var

</b></font>mybyte<font color="#000080">:</font>byte<font color="#000080">;
</font>vector<font color="#000080">:</font>pointer<font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>asyncint<font color="#000080">; </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>begin
inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">); </font><font color="#008000"><i>{STI}
</i></font>mybyte<font color="#000080">:=</font>port<font color="#000080">[</font>dataport<font color="#000080">];
</font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">); </font><font color="#008000"><i>{CLI}

</i></font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>setmodem<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>regs<font color="#000080">: </font>registers<font color="#000080">;
</font>parm <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin

</b></font>parm<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">+</font><font color="#800000">4</font><font color="#000080">+</font><font color="#800000">0</font><font color="#000080">+</font><font color="#800000">$d0</font><font color="#000080">;
</font><font color="#008000"><i>{8 databits,1 stopbit,no parity,9600 baud}
{databits: values 0,1,2,3 represent 5,6,7,8 databits
stopbits: value 4 is for 1 stopbits, 0 for none
parity: value 0 or $10 for none, $8 for odd, $18 for even
baud: $d0 for 9600, $b0 for 4800, $a0 for 2400, $80 for 1200, $60 for 600, $40
for 300 add all this values and get the correct byte parameter}

</i></font><font color="#FF0000"><b>with </b></font>regs <font color="#FF0000"><b>do
begin
</b></font>dx<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font><font color="#008000"><i>{ comport -1 }
</i></font>ah<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font>al<font color="#000080">:=</font>parm<font color="#000080">;
</font>flags<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font>intr<font color="#000080">(</font><font color="#800000">$14</font><font color="#000080">,</font>regs<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>EnablePorts<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>b<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>getintvec<font color="#000080">(</font><font color="#800000">$0c</font><font color="#000080">,</font>Vector<font color="#000080">); </font><font color="#008000"><i>{ $0c is for com1/com3 - IRQ 4 }
</i></font>setintvec<font color="#000080">(</font><font color="#800000">$0c</font><font color="#000080">,@</font>AsyncInt<font color="#000080">);
</font>b<font color="#000080">:=</font>port<font color="#000080">[</font>INTCTLR<font color="#000080">];
</font>b<font color="#000080">:=</font>b <font color="#FF0000"><b>and </b></font><font color="#800000">$0ef</font><font color="#000080">;
</font>port<font color="#000080">[</font>INTCTLR<font color="#000080">]:=</font>b<font color="#000080">;
</font>b<font color="#000080">:=</font>port<font color="#000080">[</font>LCR<font color="#000080">];
</font>b<font color="#000080">:=</font>b <font color="#FF0000"><b>and </b></font><font color="#800000">$7f</font><font color="#000080">;

</font>port<font color="#000080">[</font>lcr<font color="#000080">]:=</font>b<font color="#000080">;
</font>port<font color="#000080">[</font>ier<font color="#000080">]:=</font>enblrdy<font color="#000080">;
</font>port<font color="#000080">[</font>mcr<font color="#000080">]:=</font><font color="#800000">$08 </font><font color="#FF0000"><b>or </b></font>MDMMOD<font color="#000080">;
</font>port<font color="#000080">[</font>mdmmsr<font color="#000080">]:=</font>mdmcd<font color="#000080">;
</font>port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;

</font><font color="#008000"><i>{ when: port[MDMMSR] and $80 = $80 then there's carrier }

</i></font><font color="#FF0000"><b>procedure </b></font>sendchartoport<font color="#000080">(</font>b<font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
while </b></font><font color="#000080">( (</font>port<font color="#000080">[</font>lsr<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$20</font><font color="#000080">) &lt;&gt; </font><font color="#800000">$20 </font><font color="#000080">) </font><font color="#FF0000"><b>do
begin
end</b></font><font color="#000080">;
</font>port<font color="#000080">[</font>dataport<font color="#000080">]:=</font>b<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>sendstringtoport<font color="#000080">(</font>s<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
</b></font>i<font color="#000080">:</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>s<font color="#000080">) </font><font color="#FF0000"><b>do
</b></font>sendchartoport<font color="#000080">(</font>ord<font color="#000080">(</font>S<font color="#000080">[</font>i<font color="#000080">]));
</font>snedchartoport<font color="#000080">(</font><font color="#800000">13</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>disableports<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>b<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>sendstringtoport<font color="#000080">(</font><font color="#800000">'ATC0'</font><font color="#000080">);
</font>b<font color="#000080">:=</font>port<font color="#000080">[</font>intctlr<font color="#000080">];
</font>b<font color="#000080">:=</font>b <font color="#FF0000"><b>or </b></font><font color="#800000">$10</font><font color="#000080">;
</font>port<font color="#000080">[</font>intctlr<font color="#000080">]:=</font>b<font color="#000080">;
</font>b<font color="#000080">:=</font>port<font color="#000080">[</font>lcr<font color="#000080">];
</font>b<font color="#000080">:=</font>b <font color="#FF0000"><b>and </b></font><font color="#800000">$7f</font><font color="#000080">;
</font>port<font color="#000080">[</font>lcr<font color="#000080">]:=</font>b<font color="#000080">;
</font>port<font color="#000080">[</font>ier<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;

</font>port<font color="#000080">[</font>mcr<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;
</font>port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
</font>setintvec<font color="#000080">(</font><font color="#800000">$0c</font><font color="#000080">,</font>vector<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ How the program itself should generally be }

</i></font><font color="#FF0000"><b>begin

</b></font>setmodem<font color="#000080">;
</font>enableports<font color="#000080">;
</font>send strings <font color="#FF0000"><b>or </b></font>chars
disableports<font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0038.PAS">Original</a><b>]</b></p></body>
</html>
