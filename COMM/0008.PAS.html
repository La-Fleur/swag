<html>
<head><title> "EMSI" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
TERRY GRANT

Here is a Unit I posted some time ago For use With EMSI Sessions. Hope it
helps some of you out. You will require a fossil or Async Interface for
this to compile!
}

</i></font><font color="#FF0000"><b>Program </b></font>Emsi<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Dos <font color="#000080">, </font>Crt<font color="#000080">, </font>Fossil<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>HexString <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];

</font><font color="#FF0000"><b>Const
  </b></font>FingerPrint          <font color="#000080">= </font><font color="#800000">'{EMSI}'</font><font color="#000080">;
  </font>System_Address       <font color="#000080">= </font><font color="#800000">'1:210/20.0'</font><font color="#000080">;      </font><font color="#008000"><i>{ Your address }
  </i></font>PassWord             <font color="#000080">= </font><font color="#800000">'PASSWord'</font><font color="#000080">;        </font><font color="#008000"><i>{ Session passWord }
  </i></font>Link_Codes           <font color="#000080">= </font><font color="#800000">'{8N1}'</font><font color="#000080">;           </font><font color="#008000"><i>{ Modem setup }
  </i></font>Compatibility_Codes  <font color="#000080">= </font><font color="#800000">'{JAN}'</font><font color="#000080">;           </font><font color="#008000"><i>{ Janis }
  </i></font>Mailer_Product_Code  <font color="#000080">= </font><font color="#800000">'{00}'</font><font color="#000080">;
  </font>Mailer_Name          <font color="#000080">= </font><font color="#800000">'MagicMail'</font><font color="#000080">;
  </font>Mailer_Version       <font color="#000080">= </font><font color="#800000">'1.00'</font><font color="#000080">;
  </font>Mailer_Serial_Number <font color="#000080">= </font><font color="#800000">'{Alpha}'</font><font color="#000080">;
  </font>EMSI_INQ <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_INQC816'</font><font color="#000080">;
  </font>EMSI_REQ <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_REQA77E'</font><font color="#000080">;
  </font>EMSI_ACK <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_ACKA490'</font><font color="#000080">;
  </font>EMSI_NAK <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_NAKEEC3'</font><font color="#000080">;
  </font>EMSI_CLI <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_CLIFA8C'</font><font color="#000080">;
  </font>EMSI_ICI <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_ICI2D73'</font><font color="#000080">;
  </font>EMSI_HBT <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_HBTEAEE'</font><font color="#000080">;
  </font>EMSI_IRQ <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">= </font><font color="#800000">'**EMSI_IRQ8E08'</font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>EMSI_DAT <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;            </font><font color="#008000"><i>{ NOTE : EMSI_DAT has no maximum length }
  </i></font>Length_EMSI_DAT <font color="#000080">: </font>HexString<font color="#000080">;  </font><font color="#008000"><i>{ Expressed in Hexidecimal }
  </i></font>Packet <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>Rec_EMSI_DAT <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;        </font><font color="#008000"><i>{ EMSI_DAT sent by the answering system }
  </i></font>Len_Rec_EMSI_DAT <font color="#000080">: </font>Word<font color="#000080">;

  </font>Len<font color="#000080">,
  </font>CRC <font color="#000080">: </font>HexString<font color="#000080">;

  </font>R <font color="#000080">: </font>Registers<font color="#000080">;
  </font>C <font color="#000080">: </font>Char<font color="#000080">;
  </font>Loop<font color="#000080">,</font>ComPort<font color="#000080">,</font>TimeOut<font color="#000080">,</font>Tries <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Temp <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Up_Case<font color="#000080">(</font>St <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  For </b></font>Loop <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Length<font color="#000080">(</font>St<font color="#000080">) </font><font color="#FF0000"><b>do
    </b></font>St<font color="#000080">[</font>Loop<font color="#000080">] := </font>Upcase<font color="#000080">(</font>St<font color="#000080">[</font>Loop<font color="#000080">]);

  </font>Up_Case <font color="#000080">:= </font>St<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Hex<font color="#000080">(</font>i <font color="#000080">: </font>Word<font color="#000080">) : </font>HexString<font color="#000080">;
</font><font color="#FF0000"><b>Const
  </b></font>hc <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char <font color="#000080">= </font><font color="#800000">'0123456789ABCDEF'</font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>l<font color="#000080">, </font>h <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>l <font color="#000080">:= </font>Lo<font color="#000080">(</font>i<font color="#000080">);
  </font>h <font color="#000080">:= </font>Hi<font color="#000080">(</font>i<font color="#000080">);
  </font>Hex<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font><font color="#800000">#4</font><font color="#000080">;          </font><font color="#008000"><i>{ Length of String = 4 }
  </i></font>Hex<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>hc<font color="#000080">[</font>h <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">];
  </font>Hex<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>hc<font color="#000080">[</font>h <font color="#FF0000"><b>and </b></font><font color="#800000">$F</font><font color="#000080">];
  </font>Hex<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">] := </font>hc<font color="#000080">[</font>l <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">];
  </font>Hex<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">] := </font>hc<font color="#000080">[</font>l <font color="#FF0000"><b>and </b></font><font color="#800000">$F</font><font color="#000080">];
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{Hex} </i></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Power<font color="#000080">(</font>Base<font color="#000080">,</font>E <font color="#000080">: </font>Byte<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Power <font color="#000080">:= </font>Round<font color="#000080">(</font>Exp<font color="#000080">(</font>E <font color="#000080">* </font>Ln<font color="#000080">(</font>Base<font color="#000080">) ));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Hex2Dec<font color="#000080">(</font>HexStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">,</font>HexBit <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Temp <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>Code <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Temp <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font>Length<font color="#000080">(</font>HexStr<font color="#000080">) </font><font color="#FF0000"><b>downto </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do
  begin
    If </b></font>HexStr<font color="#000080">[</font>I<font color="#000080">] </font><font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">'A'</font><font color="#000080">,</font><font color="#800000">'a'</font><font color="#000080">,</font><font color="#800000">'B'</font><font color="#000080">,</font><font color="#800000">'b'</font><font color="#000080">,</font><font color="#800000">'C'</font><font color="#000080">,</font><font color="#800000">'c'</font><font color="#000080">,</font><font color="#800000">'D'</font><font color="#000080">,</font><font color="#800000">'d'</font><font color="#000080">,</font><font color="#800000">'E'</font><font color="#000080">,</font><font color="#800000">'e'</font><font color="#000080">,</font><font color="#800000">'F'</font><font color="#000080">,</font><font color="#800000">'f'</font><font color="#000080">] </font><font color="#FF0000"><b>then
      </b></font>Val<font color="#000080">(</font><font color="#800000">'$' </font><font color="#000080">+ </font>HexStr<font color="#000080">[</font>I<font color="#000080">],</font>HexBit<font color="#000080">,</font>Code<font color="#000080">)
    </font><font color="#FF0000"><b>else
      </b></font>Val<font color="#000080">(</font>HexStr<font color="#000080">[</font>I<font color="#000080">],</font>HexBit<font color="#000080">,</font>Code<font color="#000080">);
    </font>Temp <font color="#000080">:= </font>Temp <font color="#000080">+ </font>HexBit <font color="#000080">* </font>Power<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">,</font>Length<font color="#000080">(</font>HexStr<font color="#000080">) - </font>I<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Hex2Dec <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Bin2Dec<font color="#000080">(</font>BinStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>LongInt<font color="#000080">;

</font><font color="#008000"><i>{ Maximum is 16 bits, though a requirement For more would be   }
{ easy to accomodate.  Leading zeroes are not required. There  }
{ is no error handling - any non-'1's are taken as being zero. }

</i></font><font color="#FF0000"><b>Var
  </b></font>I <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Temp <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>BinArray <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;

</font><font color="#FF0000"><b>begin
  For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">15 </font><font color="#FF0000"><b>do
    </b></font>BinArray<font color="#000080">[</font>I<font color="#000080">] := </font><font color="#800000">'0'</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Pred<font color="#000080">(</font>Length<font color="#000080">(</font>BinStr<font color="#000080">)) </font><font color="#FF0000"><b>do
    </b></font>BinArray<font color="#000080">[</font>I<font color="#000080">] := </font>BinStr<font color="#000080">[</font>Length<font color="#000080">(</font>BinStr<font color="#000080">) - </font>I<font color="#000080">];
  </font>Temp <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">15 </font><font color="#FF0000"><b>do
  If </b></font>BinArray<font color="#000080">[</font>I<font color="#000080">] = </font><font color="#800000">'1' </font><font color="#FF0000"><b>then
    </b></font>inc<font color="#000080">(</font>Temp<font color="#000080">,</font>Round<font color="#000080">(</font>Exp<font color="#000080">(</font>I <font color="#000080">* </font>Ln<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">))));
  </font>Bin2Dec <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>CRC16<font color="#000080">(</font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Word<font color="#000080">;  </font><font color="#008000"><i>{ By Kevin Cooney }
</i></font><font color="#FF0000"><b>Var
  </b></font>crc <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>t<font color="#000080">,</font>r <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>crc<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>t<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>s<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>crc<font color="#000080">:=(</font>crc <font color="#FF0000"><b>xor </b></font><font color="#000080">(</font>ord<font color="#000080">(</font>s<font color="#000080">[</font>t<font color="#000080">]) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">8</font><font color="#000080">));
    </font><font color="#FF0000"><b>For </b></font>r<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">8 </font><font color="#FF0000"><b>do
    if </b></font><font color="#000080">(</font>crc <font color="#FF0000"><b>and </b></font><font color="#800000">$8000</font><font color="#000080">)&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>crc<font color="#000080">:=((</font>crc <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>xor </b></font><font color="#800000">$1021</font><font color="#000080">)
    </font><font color="#FF0000"><b>else
      </b></font>crc<font color="#000080">:=(</font>crc <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>CRC16<font color="#000080">:=(</font>crc <font color="#FF0000"><b>and </b></font><font color="#800000">$FFFF</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{**** FOSSIL Routines ****}
{**** Removed from Code ***}

</i></font><font color="#FF0000"><b>Procedure </b></font>Hangup<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Write2Port<font color="#000080">(</font><font color="#800000">'+++'</font><font color="#000080">+</font><font color="#800000">#13</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{**** EMSI Handshake Routines ****}

</i></font><font color="#FF0000"><b>Procedure </b></font>Create_EMSI_DAT<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FillChar<font color="#000080">(</font>EMSI_DAT<font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font><font color="#800000">' '</font><font color="#000080">);

  </font>EMSI_DAT <font color="#000080">:= </font>FingerPrint <font color="#000080">+ </font><font color="#800000">'{' </font><font color="#000080">+ </font>System_Address <font color="#000080">+ </font><font color="#800000">'}{'</font><font color="#000080">+ </font>PassWord <font color="#000080">+ </font><font color="#800000">'}' </font><font color="#000080">+
              </font>Link_Codes <font color="#000080">+ </font>Compatibility_Codes <font color="#000080">+ </font>Mailer_Product_Code <font color="#000080">+
              </font><font color="#800000">'{' </font><font color="#000080">+ </font>Mailer_Name <font color="#000080">+ </font><font color="#800000">'}{' </font><font color="#000080">+ </font>Mailer_Version <font color="#000080">+ </font><font color="#800000">'}' </font><font color="#000080">+
              </font>Mailer_Serial_Number<font color="#000080">;

  </font>Length_EMSI_DAT <font color="#000080">:= </font>Hex<font color="#000080">(</font>Length<font color="#000080">(</font>EMSI_DAT<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Carrier_Detected <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TimeOut <font color="#000080">:= </font><font color="#800000">20</font><font color="#000080">;   </font><font color="#008000"><i>{ Wait approximately 20 seconds }
  </i></font><font color="#FF0000"><b>Repeat
    </b></font>Delay<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">);
    </font>Dec<font color="#000080">(</font>TimeOut<font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>TimeOut <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Lo<font color="#000080">(</font>StatusReq<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$80 </font><font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font>Timeout <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>Carrier_Detected <font color="#000080">:= </font>False
  <font color="#FF0000"><b>else
    </b></font>Carrier_Detected <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Get_EMSI_REQ <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Temp <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font>Purge_Input<font color="#000080">;

  </font><font color="#FF0000"><b>Repeat
    </b></font>C <font color="#000080">:= </font>ReadKeyfromPort<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>C <font color="#000080">&lt;&gt; </font><font color="#800000">#10</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>C <font color="#000080">&lt;&gt; </font><font color="#800000">#13</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Temp <font color="#000080">:= </font>Temp <font color="#000080">+ </font>C<font color="#000080">;
  </font><font color="#FF0000"><b>Until </b></font>Length<font color="#000080">(</font>Temp<font color="#000080">) = </font>Length<font color="#000080">(</font>EMSI_REQ<font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font>Up_Case<font color="#000080">(</font>Temp<font color="#000080">) = </font>EMSI_REQ <font color="#FF0000"><b>then
    </b></font>get_EMSI_REQ <font color="#000080">:= </font>True
  <font color="#FF0000"><b>else
    </b></font>get_EMSI_REQ <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Send_EMSI_DAT<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CRC <font color="#000080">:= </font>Hex<font color="#000080">(</font>CRC16<font color="#000080">(</font><font color="#800000">'EMSI_DAT' </font><font color="#000080">+ </font>Length_EMSI_DAT <font color="#000080">+ </font>EMSI_DAT<font color="#000080">));
  </font>Write2Port<font color="#000080">(</font><font color="#800000">'**EMSI_DAT' </font><font color="#000080">+ </font>Length_EMSI_DAT <font color="#000080">+ </font>EMSI_DAT <font color="#000080">+ </font>CRC<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Get_EMSI_ACK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Temp <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;

  </font><font color="#FF0000"><b>Repeat
    </b></font>C <font color="#000080">:= </font>ReadKeyfromPort<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>C <font color="#000080">&lt;&gt; </font><font color="#800000">#10</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>C <font color="#000080">&lt;&gt; </font><font color="#800000">#13</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Temp <font color="#000080">:= </font>Temp <font color="#000080">+ </font>C<font color="#000080">;
  </font><font color="#FF0000"><b>Until </b></font>Length<font color="#000080">(</font>Temp<font color="#000080">) = </font>Length<font color="#000080">(</font>EMSI_ACK<font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font>Up_Case<font color="#000080">(</font>Temp<font color="#000080">) = </font>EMSI_ACK <font color="#FF0000"><b>then
    </b></font>get_EMSI_ACK <font color="#000080">:= </font>True
  <font color="#FF0000"><b>else
    </b></font>get_EMSI_ACK <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Get_EMSI_DAT<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Temp <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>Loop <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">10 </font><font color="#FF0000"><b>do                  </b></font><font color="#008000"><i>{ Read in '**EMSI_DAT' }
    </i></font>Temp <font color="#000080">:= </font>Temp <font color="#000080">+ </font>ReadKeyfromPort<font color="#000080">;

  </font>Delete<font color="#000080">(</font>Temp<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);                       </font><font color="#008000"><i>{ Remove the '**'      }

  </i></font>Len <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>Loop <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">4 </font><font color="#FF0000"><b>do                   </b></font><font color="#008000"><i>{ Read in the length   }
    </i></font>Len <font color="#000080">:= </font>Len <font color="#000080">+ </font>ReadKeyFromPort<font color="#000080">;

  </font>Temp <font color="#000080">:= </font>Temp <font color="#000080">+ </font>Len<font color="#000080">;

  </font>Len_Rec_EMSI_DAT <font color="#000080">:= </font>Hex2Dec<font color="#000080">(</font>Len<font color="#000080">);

  </font>Packet <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>Loop <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Len_Rec_EMSI_DAT <font color="#FF0000"><b>do    </b></font><font color="#008000"><i>{ Read in the packet   }
    </i></font>Packet <font color="#000080">:= </font>Packet <font color="#000080">+ </font>ReadKeyfromPort<font color="#000080">;

  </font>Temp <font color="#000080">:= </font>Temp <font color="#000080">+ </font>Packet<font color="#000080">;

  </font>CRC <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>Loop <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">4 </font><font color="#FF0000"><b>do                   </b></font><font color="#008000"><i>{ Read in the CRC      }
    </i></font>CRC <font color="#000080">:= </font>CRC <font color="#000080">+ </font>ReadKeyFromPort<font color="#000080">;

  </font>Rec_EMSI_DAT <font color="#000080">:= </font>Packet<font color="#000080">;

  </font>Writeln<font color="#000080">(</font><font color="#800000">'Rec_EMSI_DAT = '</font><font color="#000080">,</font>Rec_EMSI_DAT<font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font>Hex<font color="#000080">(</font>CRC16<font color="#000080">(</font>Temp<font color="#000080">)) &lt;&gt; </font>CRC <font color="#FF0000"><b>then
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'The recieved EMSI_DAT is corrupt!!!!'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Assumes connection has been made at this point }

  </i></font>Tries <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>Repeat
    </b></font>Write2Port<font color="#000080">(</font>EMSI_INQ<font color="#000080">);
    </font>Delay<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">);
    </font>Inc<font color="#000080">(</font>Tries<font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Get_EMSI_REQ <font color="#000080">= </font>True<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Tries <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font>Tries <font color="#000080">= </font><font color="#800000">5 </font><font color="#FF0000"><b>then
  begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Host system failed to acknowledge the inquiry sequence.'</font><font color="#000080">);
    </font>Hangup<font color="#000080">;
    </font>Halt<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Used For debugging }
  </i></font>Writeln<font color="#000080">(</font><font color="#800000">'Boss has acknowledged receipt of EMSI_INQ'</font><font color="#000080">);

  </font>Send_EMSI_DAT<font color="#000080">;

  </font>Tries <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>Repeat
    </b></font>Inc<font color="#000080">(</font>Tries<font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Get_EMSI_ACK <font color="#000080">= </font>True<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Tries <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font>Tries <font color="#000080">= </font><font color="#800000">5 </font><font color="#FF0000"><b>then
  begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Host system failed to acknowledge the EMSI_DAT packet.'</font><font color="#000080">);
    </font>Hangup<font color="#000080">;
    </font>halt<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>Writeln<font color="#000080">(</font><font color="#800000">'Boss has acknowledged receipt of EMSI_DAT'</font><font color="#000080">);

  </font>Get_EMSI_DAT<font color="#000080">;
  </font>Write2Port<font color="#000080">(</font>EMSI_ACK<font color="#000080">);

  </font><font color="#008000"><i>{ Normally the File transfers would start at this point }
  </i></font>Hangup<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
 This DOES not include all the possibilities in an EMSI Session.
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p></body>
</html>
