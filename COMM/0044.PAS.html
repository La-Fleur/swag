<html>
<head><title> "UART" by JONAS MALMSTEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
I've read some questions latelly with questions about how to use a com-port in
pascal. I've written a couple of procedures for doing this. The following
routines can be improved, for example they can be satt to run on interrupts
and a few other thing, but... I'm not supposed to do all the job for you, am
I??
}

</i></font><font color="#FF0000"><b>USES </b></font>CRT<font color="#000080">,</font>DOS<font color="#000080">;


</font><font color="#FF0000"><b>CONST
     </b></font>Com1 <font color="#000080">: </font>WORD <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
     </font>Com2 <font color="#000080">: </font>WORD <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;

</font><font color="#FF0000"><b>type
    </b></font>port <font color="#000080">= </font><font color="#FF0000"><b>object
       </b></font>port<font color="#000080">: </font>byte<font color="#000080">;
       </font>base<font color="#000080">: </font>word<font color="#000080">;
       </font>baud<font color="#000080">: </font>longint<font color="#000080">;
       </font>inter<font color="#000080">: </font>byte<font color="#000080">;
       </font><font color="#FF0000"><b>function </b></font>init<font color="#000080">(</font>comport<font color="#000080">: </font>word<font color="#000080">; </font>baudrate<font color="#000080">: </font>longint<font color="#000080">): </font>boolean<font color="#000080">;
       </font><font color="#FF0000"><b>function </b></font>sendchar<font color="#000080">(</font>c<font color="#000080">: </font>char<font color="#000080">): </font>boolean<font color="#000080">;
       </font><font color="#FF0000"><b>function </b></font>getchar<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>c<font color="#000080">: </font>char<font color="#000080">): </font>boolean<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>port<font color="#000080">.</font>init<font color="#000080">(</font>comport<font color="#000080">: </font>word<font color="#000080">; </font>baudrate<font color="#000080">: </font>longint<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>tmp<font color="#000080">: </font>word<font color="#000080">;
   </font>bas<font color="#000080">: </font>word<font color="#000080">;
   </font>test<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
     if </b></font>odd<font color="#000080">(</font>comport<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>inter<font color="#000080">:=</font><font color="#800000">$C </font><font color="#FF0000"><b>else </b></font>inter<font color="#000080">:=</font><font color="#800000">$B</font><font color="#000080">;
                          </font><font color="#008000"><i>{This is for later use with interrupts...}
     </i></font>init<font color="#000080">:=</font>false<font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>comport<font color="#000080">&lt;</font><font color="#800000">5 </font><font color="#FF0000"><b>then
     begin
          asm </b></font><font color="#008000"><i>{get port base address}
             </i></font><font color="#FF00FF">mov bx,40h
             mov es,bx
             mov bx,comport
             dec bx
             shl bx,1
             mov ax,es:[bx]
             mov bas,ax
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>bas<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
          begin
               </b></font>writeln<font color="#000080">(</font><font color="#800000">'Could''n find selected com-port!'</font><font color="#000080">);
               </font>exit<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>end
     else
     begin
          case </b></font>comport <font color="#FF0000"><b>of </b></font><font color="#008000"><i>{don't know where to find ps/2 etd
                           bios, standard base is supposed}
            </i></font><font color="#800000">5</font><font color="#000080">: </font>bas<font color="#000080">:=</font><font color="#800000">$4220</font><font color="#000080">;
            </font><font color="#800000">6</font><font color="#000080">: </font>bas<font color="#000080">:=</font><font color="#800000">$4228</font><font color="#000080">;
            </font><font color="#800000">7</font><font color="#000080">: </font>bas<font color="#000080">:=</font><font color="#800000">$5220</font><font color="#000080">;
            </font><font color="#800000">8</font><font color="#000080">: </font>bas<font color="#000080">:=</font><font color="#800000">$5228</font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>base<font color="#000080">:=</font>bas<font color="#000080">;
     </font>tmp<font color="#000080">:=</font><font color="#800000">115200 </font><font color="#FF0000"><b>div </b></font>baudrate<font color="#000080">; </font><font color="#008000"><i>{baudrate divisor}
     </i></font><font color="#FF0000"><b>asm </b></font><font color="#008000"><i>{lower DTS and DSR}
        </i></font><font color="#FF00FF">mov dx,bas
        add dx,4
        xor al,al
        out dx,al
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>delay<font color="#000080">(</font><font color="#800000">50</font><font color="#000080">);
     </font><font color="#FF0000"><b>asm </b></font><font color="#008000"><i>{raise DTS and DSR}
        </i></font><font color="#FF00FF">mov dx,bas
        add dx,4
        mov al,11b
        out dx,al
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>asm </b></font><font color="#008000"><i>{set baudrate and N,8,1}
        </i></font><font color="#FF00FF">mov dx,bas
        add dx,3
        mov al,10000011b </font><font color="#008000"><i>{N,8,1, set baudrate divisor}
        </i></font><font color="#FF00FF">out dx,al
        mov ax,tmp </font><font color="#008000"><i>{baudrate divisor}
        </i></font><font color="#FF00FF">mov dx,bas
        out dx,al
        inc dx
        mov al,ah
        out dx,al
        mov dx,bas
        add dx,3
        mov al,00000011b </font><font color="#008000"><i>{N,8,1}
        </i></font><font color="#FF00FF">out dx,al
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>asm </b></font><font color="#008000"><i>{interrupt enable, no interrupts enabled --&gt; gain time}
        </i></font><font color="#FF00FF">mov dx,bas
        inc dx
        xor al,al
        out dx,al
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>asm </b></font><font color="#008000"><i>{raise DTS and DSR}
        </i></font><font color="#FF00FF">mov dx,bas
        add dx,4
        mov al,11b
        out dx,al
        in al,dx
        and al,11b
        mov test,al
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>test<font color="#000080">&lt;&gt;</font><font color="#800000">3 </font><font color="#FF0000"><b>then
     begin
          </b></font>writeln<font color="#000080">(</font><font color="#800000">'Some error....'</font><font color="#000080">);
          </font>exit<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>init<font color="#000080">:=</font>true<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>port<font color="#000080">.</font>sendchar<font color="#000080">(</font>c<font color="#000080">: </font>char<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>bas<font color="#000080">: </font>word<font color="#000080">;
   </font>cts<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>label
     </b></font>no_send<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>cts<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
     </font>bas<font color="#000080">:=</font>base<font color="#000080">;
     </font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov dx,bas
        add dx,5
        in al,dx
        and al,00100000b </font><font color="#008000"><i>{test CTS (Clear To Send status)}
        </i></font><font color="#FF00FF">jz no_send
        mov cts,1
        mov dx,bas
        mov al,c
        out dx,al
     no_send:
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>cts<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>sendchar<font color="#000080">:=</font>false <font color="#FF0000"><b>else </b></font>sendchar<font color="#000080">:=</font>true<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>port<font color="#000080">.</font>getchar<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>c<font color="#000080">: </font>char<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>bas<font color="#000080">: </font>word<font color="#000080">;
   </font>rts<font color="#000080">: </font>byte<font color="#000080">;
   </font>c2<font color="#000080">: </font>char<font color="#000080">;
</font><font color="#FF0000"><b>label
     </b></font>no_data<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>rts<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
     </font>bas<font color="#000080">:=</font>base<font color="#000080">;
     </font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov dx,bas
        add dx,5
        in al,dx
        and al,00000001b </font><font color="#008000"><i>{test for data ready}
        </i></font><font color="#FF00FF">jz no_data
        mov rts,1
        mov dx,bas
        in al,dx
     no_data:
        mov c2,al
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>c<font color="#000080">:=</font>c2<font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>rts<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>getchar<font color="#000080">:=</font>false <font color="#FF0000"><b>else </b></font>getchar<font color="#000080">:=</font>true<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>var
   </b></font>modem<font color="#000080">: </font>port<font color="#000080">;
   </font>s<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
   </font>a<font color="#000080">: </font>byte<font color="#000080">;
   </font>c <font color="#000080">: </font>Char<font color="#000080">;

</font><font color="#FF0000"><b>begin
     if not </b></font>modem<font color="#000080">.</font>init<font color="#000080">(</font>com2<font color="#000080">,</font><font color="#800000">38400</font><font color="#000080">) </font><font color="#FF0000"><b>then
     begin
          </b></font>writeln<font color="#000080">(</font><font color="#800000">'Couldn''t initialize modem...'</font><font color="#000080">);
          </font>halt<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>s<font color="#000080">:=</font><font color="#800000">'atz'</font><font color="#000080">+</font><font color="#800000">#13</font><font color="#000080">;
     </font><font color="#FF0000"><b>for </b></font>a<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>s<font color="#000080">) </font><font color="#FF0000"><b>do </b></font>modem<font color="#000080">.</font>sendchar<font color="#000080">(</font>s<font color="#000080">[</font>a<font color="#000080">]);

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font><font color="#FF0000"><b>If </b></font>you think these routines are just great <font color="#FF0000"><b>and </b></font>you decide <font color="#FF0000"><b>to </b></font>use them <font color="#FF0000"><b>as </b></font>they
are I wouldn<font color="#800000">'t mind if you gave me a credit.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p></body>
</html>
