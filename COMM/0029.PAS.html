<html>
<head><title> "UART Detection" by DAVID CRUGER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0029.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{-------------------------------------------------------------------------
 !                                                                       !
 !  UARD.PAS   : Uart Detection Program        Ver 1.0                   !
 !                                                                       !
 !  Created    : 09-23-93        Changed: 09-23-93                       !
 !                                                                       !
 !  Converted To Turbo Pascal 6.0 By: David D. Cruger                    !
 !                                                                       !
 !  Original Program By:      National Semiconductor Corporation         !
 !  NS1655.ZIP                Microcomputer Systems Division             !
 !                            Microcontroller Applications Group         !
 !                            Written By: Louis Shay / 01/11/89          !
 !                            Originaly Written in some form of 'C'.     !
 !                            This program only does the 'detection'.    !
 !                            The original program ran some tests on     !
 !                            the Uarts.                                 !
 !                                                                       !
 !  SAVE/RESTORE Uart Registers Routines from Form Message #195739       !
 !  by Michael Day (TeamB)                                               !
 !                                                                       !
 !  *NOTE*  This program is just an example of how to detect Uarts and   !
 !          is not intended to be a stand alone program.  I here by      !
 !          release this program to the public domain.  Use at your own  !
 !          risk.                                                        !
 !                                                                       !
 !   0: No Uart at Port Address                                          !
 !   1: INS8250, INS8250-B                                               !
 !   2: INS8250A, INS82C50A, NS16450, NS16C450                           !
 !   3: NS16550A                                                         !
 !   4: NS16C552                                                         !
 !                                                                       !
 !------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Program </b></font>UartD<font color="#000080">;

  </font><font color="#008000"><i>{
     A =  Align Data
     B =  Boolean Short
     D =  Debug On
     E =  Emulate 80287
     F =  Far Calls
     G =  Generate 286 Code
     L =  Local Symbol Information
     N =  Numeric Processing Switch
     O =  Overlay
     R =  Range Checking On
     S =  Stack-Overflow
     V =  Var-String Checking
  }

{$a+,b-,d-,e-,f-,g-,l-,n-,o-,r-,s-,v-}                                 {}
{$M 2500,0,0}

</i></font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Type </b></font>Uart_Registers<font color="#000080">=</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Byte<font color="#000080">;  </font><font color="#008000"><i>{ Uart Registers              }

</i></font><font color="#FF0000"><b>Var  </b></font>URegs<font color="#000080">: </font>Uart_Registers<font color="#000080">;      </font><font color="#008000"><i>{ Uart Register Array                  }
     </i></font>PA   <font color="#000080">: </font>Word<font color="#000080">;                </font><font color="#008000"><i>{ Port Address Com1=$3F8  Com2=$2F8..  }

     </i></font>RBR<font color="#000080">,</font>THR<font color="#000080">,</font>IER<font color="#000080">,</font>IIR<font color="#000080">,</font>FCR<font color="#000080">,</font>LCR<font color="#000080">,</font>MCR<font color="#000080">,</font>LSR<font color="#000080">,</font>MSR<font color="#000080">,</font>SCR<font color="#000080">,</font>DLL<font color="#000080">,</font>DLM<font color="#000080">,</font>AFR<font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#008000"><i>{-------- Save Uart Registers --------}
</i></font><font color="#FF0000"><b>Procedure </b></font>Save_Uart_Registers<font color="#000080">(</font>BaseAdd<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>URegs<font color="#000080">: </font>Uart_Registers<font color="#000080">);
</font><font color="#FF0000"><b>Var </b></font>I<font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  ASM </b></font><font color="#FF00FF">CLI; </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">6 </font><font color="#FF0000"><b>Do </b></font>URegs<font color="#000080">[</font>I<font color="#000080">]:=</font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font>I<font color="#000080">];
  </font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">]:=</font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$80</font><font color="#000080">;
  </font>URegs<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">]:=</font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">0</font><font color="#000080">];
  </font>URegs<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">]:=</font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">];
  </font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">]:=</font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$7F</font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM </b></font><font color="#FF00FF">STI; </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ End Procedure }

{------ Restore Uart Registers --------}
</i></font><font color="#FF0000"><b>Procedure </b></font>Restore_Uart_Registers<font color="#000080">(</font>BaseAdd<font color="#000080">: </font>Word<font color="#000080">; </font>URegs<font color="#000080">: </font>Uart_Registers<font color="#000080">);
</font><font color="#FF0000"><b>Var </b></font>I<font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  ASM </b></font><font color="#FF00FF">CLI; </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">]:=</font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$80</font><font color="#000080">;
  </font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">0</font><font color="#000080">]:=</font>URegs<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">];
  </font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]:=</font>URegs<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">];
  </font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">]:=</font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$7F</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">6 </font><font color="#FF0000"><b>Do </b></font>Port<font color="#000080">[</font>BaseAdd<font color="#000080">+</font>I<font color="#000080">]:=</font>URegs<font color="#000080">[</font>I<font color="#000080">];
  </font><font color="#FF0000"><b>ASM </b></font><font color="#FF00FF">STI; </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ End Procedure }

</i></font><font color="#FF0000"><b>Procedure </b></font>Return_Code<font color="#000080">(</font>C<font color="#000080">: </font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Begin

  Case </b></font>C <font color="#FF0000"><b>of
   </b></font><font color="#800000">0</font><font color="#000080">:</font>Writeln<font color="#000080">(</font><font color="#800000">'No Uart at Port Address'</font><font color="#000080">);
   </font><font color="#800000">1</font><font color="#000080">:</font>Writeln<font color="#000080">(</font><font color="#800000">'INS8250, INS8250-B'</font><font color="#000080">);
   </font><font color="#800000">2</font><font color="#000080">:</font>Writeln<font color="#000080">(</font><font color="#800000">'INS8250A, INS82C50A, NS16450, NS16C450'</font><font color="#000080">);
   </font><font color="#800000">3</font><font color="#000080">:</font>Writeln<font color="#000080">(</font><font color="#800000">'NS16550A'</font><font color="#000080">);
   </font><font color="#800000">4</font><font color="#000080">:</font>Writeln<font color="#000080">(</font><font color="#800000">'NS16C552'</font><font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

   </font>Restore_Uart_Registers<font color="#000080">(</font>PA<font color="#000080">,</font>URegs<font color="#000080">);

   </font>Halt<font color="#000080">(</font>C<font color="#000080">);  </font><font color="#008000"><i>{ Halt with Errorlevel of Uart }

</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ End Procedure }

</i></font><font color="#FF0000"><b>Procedure </b></font>Set_Uart_Register_Values<font color="#000080">(</font>PA<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Begin

</b></font>RBR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">0</font><font color="#000080">;         </font><font color="#008000"><i>{ Receive Buffer Registers          (R  ) (DLAB=0)     }
</i></font>THR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">0</font><font color="#000080">;         </font><font color="#008000"><i>{ Transmitter Holding Register      (  W) (DLAB=0)     }
</i></font>IER<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;         </font><font color="#008000"><i>{ Interrupt Enable Register         (R/W) (DLAB=0)     }
</i></font>IIR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">;         </font><font color="#008000"><i>{ Interrupt Ident. Register         (R  )              }
</i></font>FCR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">;         </font><font color="#008000"><i>{ FIFO Control Register             (  W)              }
</i></font>LCR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">;         </font><font color="#008000"><i>{ Line Control Register             (R/W)              }
</i></font>MCR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">;         </font><font color="#008000"><i>{ MODEM Control Register            (R/W)              }
</i></font>LSR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">5</font><font color="#000080">;         </font><font color="#008000"><i>{ Line Status Register              (R  )              }
</i></font>MSR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">6</font><font color="#000080">;         </font><font color="#008000"><i>{ MODEM Status Register             (R/W)              }
</i></font>SCR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">7</font><font color="#000080">;         </font><font color="#008000"><i>{ Scratch Register                  (R/W)              }
</i></font>DLL<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">0</font><font color="#000080">;         </font><font color="#008000"><i>{ Divisor Latch (LSB)               (R/W) (DLAB=1)     }
</i></font>DLM<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;         </font><font color="#008000"><i>{ Divisor Latch (MSB)               (R/W) (DLAB=1)     }
</i></font>AFR<font color="#000080">:=</font>PA<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">;         </font><font color="#008000"><i>{ Alternate Function Register       (R/W)              }

</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ End Procedure }

</i></font><font color="#FF0000"><b>Begin  </b></font><font color="#008000"><i>{ Main Section of Program }

</i></font>PA<font color="#000080">:=</font><font color="#800000">$3F8</font><font color="#000080">; </font><font color="#008000"><i>{ Com1/ This can be changed to any port address you want }
</i></font>Write<font color="#000080">(</font><font color="#800000">'Com1: $3F8 : Uart:='</font><font color="#000080">);

</font>Save_Uart_Registers<font color="#000080">(</font>PA<font color="#000080">,</font>URegs<font color="#000080">);  </font><font color="#008000"><i>{ Saves State of Current Uart Registers    }
</i></font>Set_Uart_Register_Values<font color="#000080">(</font>PA<font color="#000080">);   </font><font color="#008000"><i>{ Return_Code() Restores Uart Registers    }

</i></font>Port<font color="#000080">[</font>LCR<font color="#000080">]:=</font><font color="#800000">$AA</font><font color="#000080">;                         </font><font color="#008000"><i>{ Test LCR Registers               }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$AA</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>LCR<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);

</font>Port<font color="#000080">[</font>DLM<font color="#000080">]:=</font><font color="#800000">$55</font><font color="#000080">;                         </font><font color="#008000"><i>{ Test DLM Present 8-bits          }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$55</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>DLM<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);

</font>Port<font color="#000080">[</font>LCR<font color="#000080">]:=</font><font color="#800000">$55</font><font color="#000080">;                         </font><font color="#008000"><i>{ LCR/ DLAB=0                      }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$55</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>LCR<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);

</font>Port<font color="#000080">[</font>IER<font color="#000080">]:=</font><font color="#800000">$55</font><font color="#000080">;                         </font><font color="#008000"><i>{ Test IER Present 4-bits          }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$05</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>IER<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);

</font>Port<font color="#000080">[</font>FCR<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;                          </font><font color="#008000"><i>{ FIFO's Off, If Present           }
</i></font>Port<font color="#000080">[</font>IER<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;                          </font><font color="#008000"><i>{ Interrupts Off, IIR Should be 01 }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$1</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>IIR<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);

</font><font color="#008000"><i>{----- Test Modem Control Register Address. Should be 5-bits Wide -----}
</i></font>Port<font color="#000080">[</font>MCR<font color="#000080">]:=</font><font color="#800000">$F5</font><font color="#000080">;                         </font><font color="#008000"><i>{ 8-bit Write                      }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$15</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>MCR<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);

</font><font color="#008000"><i>{------ Test MCR/MSR Loopback Functions ------}

</i></font>Port<font color="#000080">[</font>MCR<font color="#000080">]:=</font><font color="#800000">$10</font><font color="#000080">;                         </font><font color="#008000"><i>{ Set Loop Mode                    }
</i></font>Port<font color="#000080">[</font>MSR<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;                          </font><font color="#008000"><i>{ Clear out Delta Bits             }
</i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font><font color="#800000">$F0 </font><font color="#FF0000"><b>and </b></font>Port<font color="#000080">[</font>MSR<font color="#000080">])&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">); </font><font color="#008000"><i>{ Check State Bits          }

</i></font>Port<font color="#000080">[</font>MCR<font color="#000080">]:=</font><font color="#800000">$1F</font><font color="#000080">;                         </font><font color="#008000"><i>{ Toggle Modem Control Lines       }
</i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font><font color="#800000">$F0 </font><font color="#FF0000"><b>and </b></font>Port<font color="#000080">[</font>MSR<font color="#000080">])&lt;&gt;</font><font color="#800000">$F0 </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">); </font><font color="#008000"><i>{ Check State Bits        }

</i></font>Port<font color="#000080">[</font>MCR<font color="#000080">]:=</font><font color="#800000">$03</font><font color="#000080">;                         </font><font color="#008000"><i>{ Exit Loop Mode, DTR, RTS Active  }

{---- Port Id Successful at this point. determine port type ----}

</i></font>Port<font color="#000080">[</font>SCR<font color="#000080">]:=</font><font color="#800000">$55</font><font color="#000080">;                         </font><font color="#008000"><i>{ Is There a Scratch Register?    }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$55</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>SCR<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);  </font><font color="#008000"><i>{ No SCR, Type = INS8250          }

</i></font>Port<font color="#000080">[</font>FCR<font color="#000080">]:=</font><font color="#800000">$CF</font><font color="#000080">;                         </font><font color="#008000"><i>{ Enable FIFO's, If Present       }
</i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font><font color="#800000">$C0 </font><font color="#FF0000"><b>and </b></font>Port<font color="#000080">[</font>IIR<font color="#000080">])&lt;&gt;</font><font color="#800000">$C0 </font><font color="#FF0000"><b>Then </b></font>Return_Code<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">); </font><font color="#008000"><i>{ Check FIFO ID bits     }
</i></font>Port<font color="#000080">[</font>FCR<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;                          </font><font color="#008000"><i>{ Turn Off FIFO's                 }

</i></font>Port<font color="#000080">[</font>LCR<font color="#000080">]:=</font><font color="#800000">$80</font><font color="#000080">;                         </font><font color="#008000"><i>{ Set DLAB                        }
</i></font>Port<font color="#000080">[</font>AFR<font color="#000080">]:=</font><font color="#800000">$07</font><font color="#000080">;                         </font><font color="#008000"><i>{ Write to AFR                    }
</i></font><font color="#FF0000"><b>If </b></font><font color="#800000">$07</font><font color="#000080">&lt;&gt;</font>Port<font color="#000080">[</font>AFR<font color="#000080">] </font><font color="#FF0000"><b>Then                  </b></font><font color="#008000"><i>{ Read AFR                        }
  </i></font><font color="#FF0000"><b>Begin
    </b></font>Port<font color="#000080">[</font>LCR<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;                      </font><font color="#008000"><i>{ Reset DLAB                      }
    </i></font>Return_Code<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">);                     </font><font color="#008000"><i>{ If Not Type=NS16550A            }
  </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font>Port<font color="#000080">[</font>AFR<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;                          </font><font color="#008000"><i>{ Clear AFR                       }
</i></font>Port<font color="#000080">[</font>LCR<font color="#000080">]:=</font><font color="#800000">$0</font><font color="#000080">;                          </font><font color="#008000"><i>{ Reset DLAB                      }
</i></font>Return_Code<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">);

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0029.PAS">Original</a><b>]</b></p></body>
</html>
