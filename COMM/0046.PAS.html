<html>
<head><title> "Windows ASYNC unit" by WIM VAN DER VEGT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0046.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{---------------------------------------------------------}
{  Project : Async12 for Windows                          }
{  By      : Ir. G.W van der Vegt                         }
{---------------------------------------------------------}
{  Based on the following TP product :                    }
{                                                         }
{  ASYNC12 - Interrupt-driven asyncronous                 }
{            communications for Turbo Pascal.             }
{                                                         }
{            Version 1.2 - Wedensday June 14, 1989        }
{            Copyright (C) 1989, Rising Edge Data Services}
{                                                         }
{            Permission is granted for non-commercial     }
{            use and distribution.                        }
{                                                         }
{            Author : Mark Schultz                        }
{                                                         }
{---------------------------------------------------------}
{                                                         }
{ -Because of the complex nature of serial I/O not all    }
{  routines are 100% tested. I don't feel/am/will ever be }
{  responsible for any damage caused by this routines.    }
{                                                         }
{ -Some routines don't work (yet) because some fields are }
{  mentioned in the BP7 help file but are missing in      }
{  Wintypes. The routines are SetCTSmode, SetRTSMode &amp;    }
{  SoftHandshake.                                         }
{                                                         }
{ -Some routines can't be implemented in windows. They    }
{  are listed behind the end.                             }
{                                                         }
{ -From the original ASYNC12 code, only the syntax, some  }
{  high level pascal code and pieces of comment are used. }
{  Due to the different way windows handels devices, all  }
{  assembly codes couldn't be reused and was rewritten in }
{  Borland Pascal. I used parts of ASYNC12 because I find }
{  it a very complete package for Serial I/O and it works }
{  very well too. Sources were supplied and documented    }
{  very well.                                             }
{                                                         }
{---------------------------------------------------------}
{  Date   .Time  Revision                                 }
{  ------- ----  ---------------------------------------- }
{  9406017.1200  Creation.                                }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Library </b></font>Async12w<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Winprocs<font color="#000080">,
  </font>Wintypes<font color="#000080">;

</font><font color="#008000"><i>{****************************************************************************}

{----Public definition section}

</i></font><font color="#FF0000"><b>TYPE
  </b></font>T_eoln     <font color="#000080">= (</font>C_cr<font color="#000080">,</font>C_lf<font color="#000080">);

</font><font color="#FF0000"><b>CONST
  </b></font>C_MaxCom   <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;                   </font><font color="#008000"><i>{----Supports COM1..COM4}
  </i></font>C_MinBaud  <font color="#000080">= </font><font color="#800000">110</font><font color="#000080">;
  </font>C_MaxBaud  <font color="#000080">= </font><font color="#800000">256000</font><font color="#000080">;

</font><font color="#FF0000"><b>TYPE
  </b></font>C_ports      <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">;       </font><font color="#008000"><i>{----Subrange type to minimize programming errors}

{****************************************************************************}

{----Private definition section}

</i></font><font color="#FF0000"><b>CONST
  </b></font>portopen   <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font>C_ports<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Boolean <font color="#000080">= (</font>false<font color="#000080">,</font>false<font color="#000080">,</font>false<font color="#000080">,</font>false<font color="#000080">);   </font><font color="#008000"><i>{----Open port flags    }
  </i></font>cids       <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font>C_ports<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Integer <font color="#000080">= (-</font><font color="#800000">1</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">,-</font><font color="#800000">1</font><font color="#000080">);               </font><font color="#008000"><i>{----Device ID's        }
  </i></font>inbs       <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font>C_ports<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Word    <font color="#000080">= ( </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);               </font><font color="#008000"><i>{----Input  buffer sizes}
  </i></font>outbs      <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font>C_ports<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Word    <font color="#000080">= ( </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);               </font><font color="#008000"><i>{----Output buffer sizes}
  </i></font>txdir      <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;                                                       </font><font color="#008000"><i>{----Used for FlushCom  }
  </i></font>rxdir      <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;                                                       </font><font color="#008000"><i>{----Used for FlushCom  }
  </i></font>fon        <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;                                                       </font><font color="#008000"><i>{----Used for Handshakes}
  </i></font>foff       <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;                                                       </font><font color="#008000"><i>{----Used for Handshakes}
  </i></font>eolns      <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font>C_ports<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>T_eoln  <font color="#000080">= (</font>C_cr<font color="#000080">,</font>C_cr<font color="#000080">,</font>C_cr<font color="#000080">,</font>C_cr<font color="#000080">);       </font><font color="#008000"><i>{----Eoln characters    }

</i></font><font color="#FF0000"><b>VAR
</b></font><font color="#008000"><i>{----Don't seem to be declared in Wintypes, neccesary to fake}
  </i></font>foutx<font color="#000080">,
  </font>foutxCTSflow<font color="#000080">,
  </font>fRTSflow   <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#008000"><i>{****************************************************************************}
{*                                                                          *}
{*  Procedure ComReadCh(ComPort:Byte) : Char; External;                     *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*                                                                          *}
{*  Returns character from input buffer of specified port.  If the buffer   *}
{*  is empty, the port # invalid or not opened, a Chr(0) is returned.       *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>ComReadCh<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">) : </font>Char<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>stat <font color="#000080">: </font>TComStat<font color="#000080">;
  </font>ch   <font color="#000080">: </font>Char<font color="#000080">;
  </font>cid  <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ComReadCh<font color="#000080">:=</font><font color="#800000">#0</font><font color="#000080">;

  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

      </font><font color="#008000"><i>{----See how many characters are in the rx buffer}
        </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>GetCommError<font color="#000080">(</font>cid<font color="#000080">,</font>stat<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>AND
           </b></font><font color="#000080">(</font>stat<font color="#000080">.</font>cbInQue<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">)           </font><font color="#FF0000"><b>AND
           </b></font><font color="#000080">(</font>ReadComm<font color="#000080">(</font>cid<font color="#000080">,@</font>ch<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">)=</font><font color="#800000">1</font><font color="#000080">)
          </font><font color="#FF0000"><b>THEN </b></font>ComReadCh<font color="#000080">:=</font>ch<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComReadCh}

{****************************************************************************}
{*                                                                          *}
{*  Function ComReadChW(ComPort:Byte) : Char; External;                     *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*                                                                          *}
{*  Works like ComReadCh, but will wait until at least 1 character is       *}
{*  present in the specified input buffer before exiting.  Thus, ComReadChW *}
{*  works much like the ReadKey predefined function.                        *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>ComReadChW<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">) : </font>Char<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>stat <font color="#000080">: </font>TComStat<font color="#000080">;
  </font>ch   <font color="#000080">: </font>Char<font color="#000080">;
  </font>ok   <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>cid  <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ComReadChW<font color="#000080">:=</font><font color="#800000">#00</font><font color="#000080">;

  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];
        </font>ok <font color="#000080">:=</font>false<font color="#000080">;

      </font><font color="#008000"><i>{----See how many characters are in the rx buffer}
        </i></font><font color="#FF0000"><b>REPEAT
          IF </b></font><font color="#000080">(</font>GetCommError<font color="#000080">(</font>cid<font color="#000080">,</font>stat<font color="#000080">)&lt;&gt;</font><font color="#800000">0</font><font color="#000080">)
            </font><font color="#FF0000"><b>THEN </b></font>ok<font color="#000080">:=</font>True
            <font color="#FF0000"><b>ELSE
              BEGIN
                IF </b></font><font color="#000080">(</font>stat<font color="#000080">.</font>cbInQue<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">)       </font><font color="#FF0000"><b>AND
                   </b></font><font color="#000080">(</font>ReadComm<font color="#000080">(</font>cid<font color="#000080">,@</font>ch<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">)=</font><font color="#800000">1</font><font color="#000080">)
                  </font><font color="#FF0000"><b>THEN </b></font>ComReadChW<font color="#000080">:=</font>ch<font color="#000080">;
                </font>ok<font color="#000080">:=</font>true<font color="#000080">;
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>UNTIL </b></font>ok<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComReadChW}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComWriteCh(ComPort:Byte; Ch:Char); External                   *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*  Ch:Char       -&gt;  Character to send                                     *}
{*                                                                          *}
{*  Places the character [Ch] in the transmit buffer of the specified port. *}
{*  If the port specified is not open or nonexistent, or if the buffer is   *}
{*  filled, the character is discarded.                                     *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComWriteCh<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">; </font>Ch<font color="#000080">:</font>Char<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>stat <font color="#000080">: </font>TComStat<font color="#000080">;
  </font>cid  <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

        </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>GetCommError<font color="#000080">(</font>cid<font color="#000080">,</font>stat<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">)   </font><font color="#FF0000"><b>AND
           </b></font><font color="#000080">(</font>stat<font color="#000080">.</font>cbOutQue<font color="#000080">&lt;</font>outbs<font color="#000080">[</font>comport<font color="#000080">])
          </font><font color="#FF0000"><b>THEN </b></font>TransmitCommChar<font color="#000080">(</font>cid<font color="#000080">,</font>ch<font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{of CommWriteCh}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComWriteChW(ComPort:Byte; Ch:Char); External;                 *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*  Ch:Char       -&gt;  Character to send                                     *}
{*                                                                          *}
{*  Works as ComWriteCh, but will wait until at least 1 free position is    *}
{*  available in the output buffer before attempting to place the character *}
{*  [Ch] in it.  Allows the programmer to send characters without regard to *}
{*  available buffer space.                                                 *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComWriteChW<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">; </font>Ch<font color="#000080">:</font>Char<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>stat <font color="#000080">: </font>TComStat<font color="#000080">;
  </font>cid  <font color="#000080">: </font>Integer<font color="#000080">;
  </font>rdy  <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];
        </font>rdy<font color="#000080">:=</font>False<font color="#000080">;

        </font><font color="#FF0000"><b>REPEAT
          IF </b></font><font color="#000080">(</font>GetCommError<font color="#000080">(</font>cid<font color="#000080">,</font>stat<font color="#000080">)&lt;&gt;</font><font color="#800000">0</font><font color="#000080">)
            </font><font color="#FF0000"><b>THEN </b></font>rdy<font color="#000080">:=</font>true
            <font color="#FF0000"><b>ELSE
              IF </b></font><font color="#000080">(</font>stat<font color="#000080">.</font>cbOutQue<font color="#000080">&lt;</font>outbs<font color="#000080">[</font>comport<font color="#000080">])
                </font><font color="#FF0000"><b>THEN </b></font>rdy<font color="#000080">:=</font>TransmitCommChar<font color="#000080">(</font>cid<font color="#000080">,</font>ch<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">;
        </font><font color="#FF0000"><b>UNTIL </b></font>rdy<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComWriteChW}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ClearCom(ComPort:Byte); IO:Char)                              *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Request ignored if out of range or unopened.          *}
{*  IO:Char       -&gt;  Action code; I=Input, O=Output, B=Both                *}
{*                    No action taken if action code unrecognized.          *}
{*                                                                          *}
{*  ClearCom allows the user to completely clear the contents of either     *}
{*  the input (receive) and/or output (transmit) buffers.  The &quot;action      *}
{*  code&quot; passed in &lt;IO&gt; determines if the input (I) or output (O) buffer   *}
{*  is cleared.  Action code (B) will clear both buffers.  This is useful   *}
{*  if you wish to cancel a transmitted message or ignore part of a         *}
{*  received message.                                                       *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ClearCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_Ports<font color="#000080">;</font>IO<font color="#000080">:</font>Char<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>cid  <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

        </font><font color="#FF0000"><b>Case </b></font>Upcase<font color="#000080">(</font>IO<font color="#000080">) </font><font color="#FF0000"><b>OF
          </b></font><font color="#800000">'I' </font><font color="#000080">: </font>FlushComm<font color="#000080">(</font>cid<font color="#000080">,</font>rxdir<font color="#000080">);
          </font><font color="#800000">'B' </font><font color="#000080">: </font><font color="#FF0000"><b>Begin
                  </b></font>FlushComm<font color="#000080">(</font>cid<font color="#000080">,</font>rxdir<font color="#000080">);
                  </font>FlushComm<font color="#000080">(</font>cid<font color="#000080">,</font>txdir<font color="#000080">);
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
          </font><font color="#800000">'O' </font><font color="#000080">: </font>FlushComm<font color="#000080">(</font>cid<font color="#000080">,</font>txdir<font color="#000080">);
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ClearComm}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComBufferLeft(ComPort:Byte; IO:Char) : Word                   *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Returns 0 if Port # invalid or unopened.              *}
{*  IO:Char       -&gt;  Action code; I=Input, O=Output                        *}
{*                    Returns 0 if action code unrecognized.                *}
{*                                                                          *}
{*  ComBufferLeft will return a number (bytes) indicating how much space    *}
{*  remains in the selected buffer.  The INPUT buffer is checked if &lt;IO&gt; is *}
{*  (I), and the output buffer is interrogated when &lt;IO&gt; is (O).  Any other *}
{*  &quot;action code&quot; will return a result of 0.  Use this function when it is  *}
{*  important to avoid program delays due to calls to output procedures or  *}
{*  to prioritize the reception of data (to prevent overflows).             *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>ComBufferLeft<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>IO<font color="#000080">:</font>Char<font color="#000080">) : </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>stat <font color="#000080">: </font>TComStat<font color="#000080">;
  </font>cid  <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ComBufferLeft <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

        </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>GetCommError<font color="#000080">(</font>cid<font color="#000080">,</font>stat<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">)
          </font><font color="#FF0000"><b>THEN
            CASE </b></font>Upcase<font color="#000080">(</font>IO<font color="#000080">) </font><font color="#FF0000"><b>OF
              </b></font><font color="#800000">'I' </font><font color="#000080">: </font>ComBufferLeft<font color="#000080">:=</font>inbs <font color="#000080">[</font>comport<font color="#000080">]-</font>stat<font color="#000080">.</font>cbInQue<font color="#000080">;
              </font><font color="#800000">'O' </font><font color="#000080">: </font>ComBufferLeft<font color="#000080">:=</font>outbs<font color="#000080">[</font>comport<font color="#000080">]-</font>stat<font color="#000080">.</font>cbOutQue<font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ComBufferLeft}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComWaitForClear(ComPort:Byte)                                 *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Exits immediately if out of range or port unopened.   *}
{*                                                                          *}
{*  A call to ComWaitForClear will stop processing until the selected out-  *}
{*  put buffer is completely emptied.  Typically used just before a call    *}
{*  to the CloseCom procedure to prevent premature cut-off of messages in   *}
{*  transit.                                                                *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComWaitForClear<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>stat  <font color="#000080">: </font>TComStat<font color="#000080">;
  </font>cid   <font color="#000080">: </font>Integer<font color="#000080">;
  </font>Empty <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid  <font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];
        </font>empty<font color="#000080">:=</font>false<font color="#000080">;

        </font><font color="#FF0000"><b>REPEAT
          IF </b></font><font color="#000080">(</font>GetCommError<font color="#000080">(</font>cid<font color="#000080">,</font>stat<font color="#000080">)&lt;&gt;</font><font color="#800000">0</font><font color="#000080">)
            </font><font color="#FF0000"><b>THEN </b></font>empty<font color="#000080">:=</font>true
            <font color="#FF0000"><b>ELSE </b></font>empty<font color="#000080">:=</font>stat<font color="#000080">.</font>cbOutQue<font color="#000080">=</font><font color="#800000">0
        </font><font color="#FF0000"><b>UNTIL </b></font>empty<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ComWaitForClear}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComWrite(ComPort:Byte; St:String)                             *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Exits immediately if out of range or port unopened.   *}
{*  St:String     -&gt;  String to send                                        *}
{*                                                                          *}
{*  Sends string &lt;St&gt; out communications port &lt;ComPort&gt;.                    *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComWrite<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>X <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      For </b></font>X <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>Length<font color="#000080">(</font>St<font color="#000080">) </font><font color="#FF0000"><b>Do
        </b></font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,</font>St<font color="#000080">[</font>X<font color="#000080">]);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComWrite}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComWriteln(ComPort:Byte; St:String);                          *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Exits immediately if out of range or port unopened.   *}
{*  St:String     -&gt;  String to send                                        *}
{*                                                                          *}
{*  Sends string &lt;St&gt; with a CR and LF appended.                            *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComWriteln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>X <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        For </b></font>X <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>Length<font color="#000080">(</font>St<font color="#000080">) </font><font color="#FF0000"><b>Do
          </b></font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,</font>St<font color="#000080">[</font>X<font color="#000080">]);
        </font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,</font><font color="#800000">#13</font><font color="#000080">);
        </font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,</font><font color="#800000">#10</font><font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComWriteln}

{****************************************************************************}
{*                                                                          *}
{*  Procedure Delay(ms:word);                                               *}
{*                                                                          *}
{*  ms:word       -&gt;  Number of msec to wait.                               *}
{*                                                                          *}
{*  A substitute for CRT's Delay under DOS. This one will wait for at least *}
{*  the amount of msec specified, probably even more because of the task-   *)
{*  switching nature of Windows. So a msec can end up as a second if ALT-TAB*}
{*  or something like is pressed. Minumum delays are guaranteed independend *}
{*  of task-switches.                                                       *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>Delay<font color="#000080">(</font>ms <font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>theend<font color="#000080">,
  </font>marker  <font color="#000080">: </font>Longint<font color="#000080">;

</font><font color="#FF0000"><b>Begin
</b></font><font color="#008000"><i>{----Potentional overflow if windows runs for 49 days without a stop}
  </i></font>marker<font color="#000080">:=</font>GetTickCount<font color="#000080">;
</font><font color="#008000"><i>{$R-}
  </i></font>theend<font color="#000080">:=</font>Longint<font color="#000080">(</font>marker<font color="#000080">+</font>ms<font color="#000080">);
</font><font color="#008000"><i>{$R+}

{----First see if timer overrun will occure and wait for this,
     then test as usual}
  </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>theend<font color="#000080">&lt;</font>marker<font color="#000080">)
    </font><font color="#FF0000"><b>Then
      While </b></font><font color="#000080">(</font>GetTickCount<font color="#000080">&gt;=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>DO</b></font><font color="#000080">;

</font><font color="#008000"><i>{----Wait for projected time to pass}
  </i></font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>theend<font color="#000080">&gt;=</font>GettickCount<font color="#000080">) </font><font color="#FF0000"><b>Do</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of Delay}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComWriteWithDelay(ComPort:Byte; St:String; Dly:Word);         *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Exits immediately if out of range or port unopened.   *}
{*  St:String     -&gt;  String to send                                        *}
{*  Dly:Word      -&gt;  Time, in milliseconds, to delay between each char.    *}
{*                                                                          *}
{*  ComWriteWithDelay will send string &lt;St&gt; to port &lt;ComPort&gt;, delaying     *}
{*  for &lt;Dly&gt; milliseconds between each character.  Useful for systems that *}
{*  cannot keep up with transmissions sent at full speed.                   *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComWriteWithDelay<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Dly<font color="#000080">:</font>Word<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>X   <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>ComWaitForClear<font color="#000080">(</font>ComPort<font color="#000080">);
        </font><font color="#FF0000"><b>For </b></font>X <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>Length<font color="#000080">(</font>St<font color="#000080">) </font><font color="#FF0000"><b>Do
          Begin
            </b></font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,</font>St<font color="#000080">[</font>X<font color="#000080">]);
            </font>ComWaitForClear<font color="#000080">(</font>ComPort<font color="#000080">);
            </font>Delay<font color="#000080">(</font>dly<font color="#000080">);
          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComWriteWithDelay}

{****************************************************************************}
{*                                                                          *}
{* Procedure ComReadln(ComPort:Byte; Var St:String; Size:Byte; Echo:Boolean)*}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Exits immediately if out of range or port unopened.   *}
{*  St:String     &lt;-  Edited string from remote                             *}
{*  Size:Byte;    -&gt;  Maximum allowable length of input                     *}
{*  Echo:Boolean; -&gt;  Set TRUE to echo received characters                  *}
{*                                                                          *}
{*  ComReadln is the remote equivalent of the standard Pascal READLN pro-   *}
{*  cedure with some enhancements.  ComReadln will accept an entry of up to *}
{*  40 printable ASCII characters, supporting ^H and ^X editing commands.   *}
{*  Echo-back of the entry (for full-duplex operation) is optional.  All    *}
{*  control characters, as well as non-ASCII (8th bit set) characters are   *}
{*  stripped.  If &lt;Echo&gt; is enabled, ASCII BEL (^G) characters are sent     *}
{*  when erroneous characters are intercepted.  Upon receipt of a ^M (CR),  *}
{*  the procedure is terminated and the final string result returned.       *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComReadln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Size<font color="#000080">:</font>Byte<font color="#000080">; </font>Echo<font color="#000080">:</font>Boolean<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Len<font color="#000080">,</font>X <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Ch    <font color="#000080">: </font>Char<font color="#000080">;
  </font>Done  <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>St<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>Done <font color="#000080">:= </font>False<font color="#000080">;
        </font><font color="#FF0000"><b>Repeat
          </b></font>Len<font color="#000080">:=</font>Length<font color="#000080">(</font>St<font color="#000080">);
          </font>Ch <font color="#000080">:=</font>Chr<font color="#000080">(</font>Ord<font color="#000080">(</font>ComReadChW<font color="#000080">(</font>ComPort<font color="#000080">)) </font><font color="#FF0000"><b>And </b></font><font color="#800000">$7F</font><font color="#000080">);

          </font><font color="#FF0000"><b>Case </b></font>Ch <font color="#FF0000"><b>Of
            </b></font><font color="#000080">^</font>H <font color="#000080">: </font><font color="#FF0000"><b>If </b></font>Len<font color="#000080">&gt;</font><font color="#800000">0
                  </font><font color="#FF0000"><b>Then
                    Begin
                      </b></font>Dec<font color="#000080">(</font>Len<font color="#000080">);
                      </font>St<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>Chr<font color="#000080">(</font>Len<font color="#000080">);
                      </font><font color="#FF0000"><b>If </b></font>Echo <font color="#FF0000"><b>Then </b></font>ComWrite<font color="#000080">(</font>ComPort<font color="#000080">,</font><font color="#800000">#8#32#8</font><font color="#000080">);
                    </font><font color="#FF0000"><b>End
                  Else </b></font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,^</font>G<font color="#000080">);
            ^</font>J <font color="#000080">: </font><font color="#FF0000"><b>If </b></font>eolns<font color="#000080">[</font>comport<font color="#000080">]=</font>C_lf
                   <font color="#FF0000"><b>Then
                     Begin
                       </b></font>Done<font color="#000080">:=</font>True<font color="#000080">;
                       </font><font color="#FF0000"><b>If </b></font>Echo <font color="#FF0000"><b>Then </b></font>ComWrite<font color="#000080">(</font>ComPort<font color="#000080">,</font><font color="#800000">#13#10</font><font color="#000080">);
                     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
            ^</font>M <font color="#000080">: </font><font color="#FF0000"><b>If </b></font>eolns<font color="#000080">[</font>comport<font color="#000080">]=</font>C_cr
                   <font color="#FF0000"><b>Then
                     Begin
                       </b></font>Done<font color="#000080">:=</font>True<font color="#000080">;
                       </font><font color="#FF0000"><b>If </b></font>Echo <font color="#FF0000"><b>Then </b></font>ComWrite<font color="#000080">(</font>ComPort<font color="#000080">,</font><font color="#800000">#13#10</font><font color="#000080">);
                     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
            ^</font>X <font color="#000080">: </font><font color="#FF0000"><b>Begin
                   </b></font>St<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
                   </font><font color="#FF0000"><b>If </b></font>Len<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>ComWriteCh<font color="#000080">(</font>ComPort<font color="#000080">,^</font>G<font color="#000080">);
                   </font><font color="#FF0000"><b>If </b></font>Echo
                     <font color="#FF0000"><b>Then
                       For </b></font>X<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Len <font color="#FF0000"><b>Do
                         </b></font>ComWrite<font color="#000080">(</font>ComPort<font color="#000080">,</font><font color="#800000">#8#32#8</font><font color="#000080">);
                 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
          </font><font color="#800000">#32</font><font color="#000080">..
          </font><font color="#800000">#127 </font><font color="#000080">: </font><font color="#FF0000"><b>If </b></font>Len<font color="#000080">&lt;</font>Size
                   <font color="#FF0000"><b>Then
                     Begin
                       </b></font>Inc<font color="#000080">(</font>Len<font color="#000080">);
                       </font>St<font color="#000080">[</font>Len<font color="#000080">]:=</font>Ch<font color="#000080">;
                       </font>St<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>Chr<font color="#000080">(</font>Len<font color="#000080">);
                       </font><font color="#FF0000"><b>If </b></font>Echo <font color="#FF0000"><b>Then </b></font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,</font>Ch<font color="#000080">);
                     </font><font color="#FF0000"><b>End
                   Else
                     If </b></font>Echo <font color="#FF0000"><b>Then </b></font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,^</font>G<font color="#000080">);
          </font><font color="#FF0000"><b>Else
            If </b></font>Echo <font color="#FF0000"><b>Then </b></font>ComWriteChW<font color="#000080">(</font>ComPort<font color="#000080">,^</font>G<font color="#000080">)
          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>Until </b></font>Done<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComReadln}

{****************************************************************************}
{*                                                                          *}
{*  Procedure SetRTSMode(ComPort:Byte; Mode:Boolean; RTSOn,RTSOff:Word)     *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Request ignored if out of range or unopened.          *}
{*  Mode:Boolean  -&gt;  TRUE to enable automatic RTS handshake                *}
{*  RTSOn:Word    -&gt;  Buffer-usage point at which the RTS line is asserted  *}
{*  RTSOff:Word   -&gt;  Buffer-usage point at which the RTS line is dropped   *}
{*                                                                          *}
{*  SetRTSMode enables or disables automated RTS handshaking.  If [MODE] is *}
{*  TRUE, automated RTS handshaking is enabled.  If enabled, the RTS line   *}
{*  will be DROPPED when the # of buffer bytes used reaches or exceeds that *}
{*  of [RTSOff].  The RTS line will then be re-asserted when the buffer is  *}
{*  emptied down to the [RTSOn] usage point.  If either [RTSOn] or [RTSOff] *}
{*  exceeds the input buffer size, they will be forced to (buffersize-1).   *}
{*  If [RTSOn] &gt; [RTSOff] then [RTSOn] will be the same as [RTSOff].        *}
{*  The actual handshaking control is located in the interrupt driver for   *}
{*  the port (see ASYNC12.ASM).                                             *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetRTSmode<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">; </font>RTSOn<font color="#000080">,</font>RTSOff<font color="#000080">:</font>Word<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>dcb <font color="#000080">: </font>tdcb<font color="#000080">;
  </font>cid <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

        </font><font color="#FF0000"><b>If </b></font>GetCommState<font color="#000080">(</font>cid<font color="#000080">,</font>dcb<font color="#000080">)=</font><font color="#800000">0
          </font><font color="#FF0000"><b>Then
            Begin
              With </b></font>dcb <font color="#FF0000"><b>Do
                Case </b></font>mode <font color="#FF0000"><b>of
                  </b></font>True  <font color="#000080">: </font><font color="#FF0000"><b>Begin
                            </b></font>fRTSflow<font color="#000080">:=</font>fon<font color="#000080">;
                            </font>Xonlim  <font color="#000080">:=</font>inbs<font color="#000080">[</font>comport<font color="#000080">]-</font>RTSon <font color="#000080">;
                            </font>Xofflim <font color="#000080">:=</font>inbs<font color="#000080">[</font>comport<font color="#000080">]-</font>RTSoff<font color="#000080">;
                          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
                  </font>False <font color="#000080">: </font><font color="#FF0000"><b>Begin
                            </b></font>fRTSflow<font color="#000080">:=</font>foff<font color="#000080">;
                          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
              </font>SetCommState<font color="#000080">(</font>dcb<font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of SetRTSmode}

{****************************************************************************}
{*                                                                          *}
{*  Procedure SetCTSMode(ComPort:Byte; Mode:Boolean)                        *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Request ignored if out of range or unopened.          *}
{*  Mode:Boolean  -&gt;  Set to TRUE to enable automatic CTS handshake.        *}
{*                                                                          *}
{*  SetCTSMode allows the enabling or disabling of automated CTS handshak-  *}
{*  ing.  If [Mode] is TRUE, CTS handshaking is enabled, which means that   *}
{*  if the remote drops the CTS line, the transmitter will be disabled      *}
{*  until the CTS line is asserted again.  Automatic handshake is disabled  *}
{*  if [Mode] is FALSE.  CTS handshaking and &quot;software&quot; handshaking (pro-   *}
{*  vided by the SoftHandshake procedure) ARE compatable and may be used    *}
{*  in any combination.                                                     *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetCTSMode<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>dcb <font color="#000080">: </font>tdcb<font color="#000080">;
  </font>cid <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

        </font><font color="#FF0000"><b>If </b></font>GetCommState<font color="#000080">(</font>cid<font color="#000080">,</font>dcb<font color="#000080">)=</font><font color="#800000">0
          </font><font color="#FF0000"><b>Then
            Begin
              Case </b></font>mode <font color="#FF0000"><b>of
                </b></font>True  <font color="#000080">: </font>foutxCTSflow<font color="#000080">:=</font>fon<font color="#000080">;
                </font>False <font color="#000080">: </font>foutxCTSflow<font color="#000080">:=</font>foff<font color="#000080">;
              </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
              </font>SetCommState<font color="#000080">(</font>dcb<font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of SetCTSmode}

{****************************************************************************}
{*                                                                          *}
{*  Procedure SoftHandshake(ComPort:Byte; Mode:Boolean; Start,Stop:Char)    *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom).                         *}
{*                    Request ignored if out of range or unopened.          *}
{*  Mode:Boolean  -&gt;  Set to TRUE to enable transmit software handshake     *}
{*  Start:Char    -&gt;  START control character (usually ^Q)                  *}
{*                    Defaults to ^Q if character passed is &gt;= &lt;Space&gt;      *}
{*  Stop:Char     -&gt;  STOP control character (usually ^S)                   *}
{*                    Defaults to ^S if character passed is &gt;= &lt;Space&gt;      *}
{*                                                                          *}
{*  SoftHandshake controls the usage of &quot;Software&quot; (control-character)      *}
{*  handshaking on transmission.  If &quot;software handshake&quot; is enabled        *}
{*  ([Mode] is TRUE), transmission will be halted if the character in       *}
{*  [Stop] is received.  Transmission is re-enabled if the [Start] char-    *}
{*  acter is received.  Both the [Start] and [Stop] characters MUST be      *}
{*  CONTROL characters (i.e. Ord(Start) and Ord(Stop) must both be &lt; 32).   *}
{*  Also, &lt;Start&gt; and &lt;Stop&gt; CANNOT be the same character.  If either one   *}
{*  of these restrictions are violated, the defaults (^Q for &lt;Start&gt; and ^S *}
{*  for &lt;Stop&gt;) will be used.                                               *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>SoftHandshake<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">; </font>Start<font color="#000080">,</font>Stop<font color="#000080">:</font>Char<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>dcb <font color="#000080">: </font>tdcb<font color="#000080">;
  </font>cid <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

        </font><font color="#FF0000"><b>If </b></font>GetCommState<font color="#000080">(</font>cid<font color="#000080">,</font>dcb<font color="#000080">)=</font><font color="#800000">0
          </font><font color="#FF0000"><b>Then
            Begin
              Case </b></font>mode <font color="#FF0000"><b>of
                </b></font>True  <font color="#000080">: </font><font color="#FF0000"><b>Begin
                          </b></font>foutx<font color="#000080">:=</font>fon<font color="#000080">;
                          </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>start <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">#00</font><font color="#000080">..</font><font color="#800000">#31</font><font color="#000080">]) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>start<font color="#000080">&lt;&gt;</font>stop<font color="#000080">)
                            </font><font color="#FF0000"><b>Then </b></font>dcb<font color="#000080">.</font>Xonchar<font color="#000080">:=</font>start
                            <font color="#FF0000"><b>Else </b></font>dcb<font color="#000080">.</font>Xonchar<font color="#000080">:=^</font>Q<font color="#000080">;
                          </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>stop  <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">#00</font><font color="#000080">..</font><font color="#800000">#31</font><font color="#000080">]) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>start<font color="#000080">&lt;&gt;</font>stop<font color="#000080">)
                            </font><font color="#FF0000"><b>Then </b></font>dcb<font color="#000080">.</font>Xoffchar<font color="#000080">:=</font>stop
                            <font color="#FF0000"><b>Else </b></font>dcb<font color="#000080">.</font>Xoffchar<font color="#000080">:=^</font>S<font color="#000080">;
                        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
                </font>False <font color="#000080">: </font>foutx<font color="#000080">:=</font>foff<font color="#000080">;
              </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
              </font>SetCommState<font color="#000080">(</font>dcb<font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of Softhandshake}

{****************************************************************************}
{*                                                                          *}
{*  Function ComExist(ComPort:Byte) : Boolean                               *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*                    Returns FALSE if out of range                         *}
{*  Returns TRUE if hardware for selected port is detected &amp; tests OK       *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>ComExist<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">) : </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>mode <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>dcb  <font color="#000080">: </font>tdcb<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>mode<font color="#000080">:=</font><font color="#800000">'COM'</font><font color="#000080">+</font>Chr<font color="#000080">(</font>Comport<font color="#000080">+</font>Ord<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">))+</font><font color="#800000">' 19200,N,8,1'#0</font><font color="#000080">;
        </font>ComExist<font color="#000080">:=(</font>BuildCommDCB<font color="#000080">(@</font>mode<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>dcb<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>End
    Else </b></font>ComExist<font color="#000080">:=</font>false<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of Comexist}

{****************************************************************************}
{*                                                                          *}
{*  Function ComTrueBaud(Baud:Longint) : Real                               *}
{*                                                                          *}
{*  Baud:Longint  -&gt;  User baud rate to test.                               *}
{*                    Should be between C_MinBaud and C_MaxBaud.            *}
{*  Returns the actual baud rate based on the accuracy of the 8250 divider. *}
{*                                                                          *}
{*  The ASYNC12 communications package allows the programmer to select ANY  *}
{*  baud rate, not just those that are predefined by the BIOS or other      *}
{*  agency.  Since the 8250 uses a divider/counter chain to generate it's   *}
{*  baud clock, many non-standard baud rates can be generated.  However,    *}
{*  the binary counter/divider is not always capable of generating the      *}
{*  EXACT baud rate desired by a user.  This function, when passed a valid  *}
{*  baud rate, will return the ACTUAL baud rate that will be generated.     *}
{*  The baud rate is based on a 8250 input clock rate of 1.73728 MHz.       *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>ComTrueBaud<font color="#000080">(</font>Baud<font color="#000080">:</font>Longint<font color="#000080">) : </font>Real<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>X <font color="#000080">: </font>Real<font color="#000080">;
  </font>Y <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>X <font color="#000080">:= </font>Baud<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>X <font color="#000080">&lt; </font>C_MinBaud <font color="#FF0000"><b>Then </b></font>X <font color="#000080">:= </font>C_MinBaud<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>X <font color="#000080">&gt; </font>C_MaxBaud <font color="#FF0000"><b>Then </b></font>X <font color="#000080">:= </font>C_MaxBaud<font color="#000080">;
  </font>ComTrueBaud <font color="#000080">:= </font>C_MaxBaud <font color="#000080">/ </font>Round<font color="#000080">(</font><font color="#800000">$900</font><font color="#000080">/(</font>X<font color="#000080">/</font><font color="#800000">50</font><font color="#000080">));
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComTrueBaud}

{****************************************************************************}
{*                                                                          *}
{* Function Lstr(l : Longint) : String;                                     *}
{*                                                                          *}
{* l:Longint       -&gt;  Number converted to a string                         *}
{*                                                                          *}
{* This function converts longint l to a string.                            *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>Lstr<font color="#000080">(</font>l <font color="#000080">: </font>Longint<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Str<font color="#000080">(</font>l<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">,</font>s<font color="#000080">);
  </font>Lstr<font color="#000080">:=</font>s<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of Lstr}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComParams(ComPort:Byte; Baud:Longint;                         *}
{*                      WordSize:Byte; Parity:Char; StopBits:Byte);         *}
{*                                                                          *}
{*  ComPort:Byte   -&gt;  Port # to initialize.  Must be (1 - C_MaxCom)        *}
{*                     Procedure aborted if port # invalid or unopened.     *}
{*  Baud:Longint   -&gt;  Desired baud rate.  Should be (C_MinBaud - C_MaxBaud)*}
{*                     C_MinBaud or C_MaxBaud used if out of range.         *}
{*  WordSize:Byte  -&gt;  Word size, in bits.  Must be 5 - 8 bits.             *}
{*                     8-bit word used if out of range.                     *}
{*  Parity:Char    -&gt;  Parity classification.                               *}
{*                     May be N)one, E)ven, O)dd, M)ark or S)pace.          *}
{*                     N)one selected if classification unknown.            *}
{*  StopBits:Byte  -&gt;  # of stop bits to pad character with.  Range (1-2)   *}
{*                     1 stop bit used if out of range.                     *}
{*                                                                          *}
{*  ComParams is used to configure an OPEN'ed port for the desired comm-    *}
{*  unications parameters, namely baud rate, word size, parity form and     *}
{*  # of stop bits.  A call to this procedure will set up the port approp-  *}
{*  riately, as well as assert the DTR, RTS and OUT2 control lines and      *}
{*  clear all buffers.                                                      *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComParams<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>Baud<font color="#000080">:</font>LongInt<font color="#000080">; </font>WordSize<font color="#000080">:</font>Byte<font color="#000080">; </font>Parity<font color="#000080">:</font>Char<font color="#000080">; </font>StopBits<font color="#000080">:</font>Byte<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>mode <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>cid  <font color="#000080">: </font>Integer<font color="#000080">;
  </font>dcb  <font color="#000080">: </font>tdcb<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];

      </font><font color="#008000"><i>{----Like COM1 9600,N,8,1}
        </i></font>mode<font color="#000080">:=</font><font color="#800000">'COM'</font><font color="#000080">+</font>Chr<font color="#000080">(</font>Comport<font color="#000080">+</font>Ord<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">))+</font><font color="#800000">' '</font><font color="#000080">+</font>Lstr<font color="#000080">(</font>baud<font color="#000080">)+</font><font color="#800000">','</font><font color="#000080">+</font>Upcase<font color="#000080">(</font>Parity<font color="#000080">)+</font><font color="#800000">','</font><font color="#000080">+</font>Lstr<font color="#000080">(</font>Wordsize<font color="#000080">)+</font><font color="#800000">','</font><font color="#000080">+</font>Lstr<font color="#000080">(</font>stopbits<font color="#000080">)+</font><font color="#800000">#0</font><font color="#000080">;
        </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>BuildCommDCB<font color="#000080">(@</font>mode<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>dcb<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">)
          </font><font color="#FF0000"><b>Then
            Begin
              </b></font>dcb<font color="#000080">.</font>id<font color="#000080">:=</font>cid<font color="#000080">;
              </font>SetCommState<font color="#000080">(</font>dcb<font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComParams}

{****************************************************************************}
{*                                                                          *}
{*  Function OpenCom(ComPort:Byte; InBufferSize,OutBufferSize:Word):Boolean *}
{*                                                                          *}
{*  ComPort:Byte        -&gt;  Port # to OPEN (1 - C_MaxCom)                   *}
{*                          Request will fail if out of range or port OPEN  *}
{*  InBufferSize:Word   -&gt;  Requested size of input (receive) buffer        *}
{*  OutBufferSize:Word  -&gt;  Requested size of output (transmit) buffer      *}
{*  Returns success/fail status of OPEN request (TRUE if OPEN successful)   *}
{*                                                                          *}
{*  OpenCom must be called before any activity (other than existence check, *}
{*  see the ComExist function) takes place.  OpenCom initializes the        *}
{*  interrupt drivers and serial communications hardware for the selected   *}
{*  port, preparing it for I/O. Once a port has been OPENed, a call to      *}
{*  ComParams should be made to set up communications parameters (baud rate,*}
{*  parity and the like).  Once this is done, I/O can take place on the     *}
{*  port. OpenCom will return a TRUE value if the opening procedure was     *}
{*  successful, or FALSE if it is not.                                      *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>OpenCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>InBufferSize<font color="#000080">,</font>OutBufferSize<font color="#000080">:</font>Word<font color="#000080">) : </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>cid  <font color="#000080">: </font>Integer<font color="#000080">;
  </font>comp <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>OpenCom <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>If    </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     Not</b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])      </font><font color="#FF0000"><b>And
         </b></font>ComExist<font color="#000080">(</font>comport<font color="#000080">)
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>comp<font color="#000080">:=</font><font color="#800000">'COM'</font><font color="#000080">+</font>Chr<font color="#000080">(</font>comport<font color="#000080">+</font>Ord<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">))+</font><font color="#800000">#0</font><font color="#000080">;
        </font>cid<font color="#000080">:=</font>OpenComm<font color="#000080">(@</font>comp<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>InBufferSize<font color="#000080">,</font>OutBufferSize<font color="#000080">);
        </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>cid<font color="#000080">&gt;=</font><font color="#800000">0</font><font color="#000080">)
          </font><font color="#FF0000"><b>Then
            Begin
              </b></font>cids <font color="#000080">[</font>comport<font color="#000080">]     :=</font>cid<font color="#000080">;
              </font>inbs <font color="#000080">[</font>comport<font color="#000080">]     :=</font>InBufferSize<font color="#000080">;
              </font>outbs<font color="#000080">[</font>comport<font color="#000080">]     :=</font>OutBufferSize<font color="#000080">;
              </font>portopen<font color="#000080">[</font>comport<font color="#000080">]:=</font>true<font color="#000080">;
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font>OpenCom<font color="#000080">:=(</font>cid<font color="#000080">&gt;=</font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of OpenCom}

{****************************************************************************}
{*                                                                          *}
{*  Procedure CloseCom(ComPort:Byte)                                        *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to close                                       *}
{*                    Request ignored if port closed or out of range.       *}
{*                                                                          *}
{*  CloseCom will un-link the interrupt drivers for a port, deallocate it's *}
{*  buffers and drop the DTR and RTS signal lines for a port opened with    *}
{*  the OpenCom function.  It should be called before exiting your program  *}
{*  to ensure that the port is properly shut down.                          *}
{*  NOTE:  CloseCom shuts down a communications channel IMMEDIATELY,        *}
{*         even if there is data present in the input or output buffers.    *}
{*         Therefore, you may wish to call the ComWaitForClear procedure    *}
{*         before closing the ports.                                        *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>CloseCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>cid <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>cid<font color="#000080">:=</font>cids<font color="#000080">[</font>comport<font color="#000080">];
        </font>portopen<font color="#000080">[</font>comport<font color="#000080">]:=</font><font color="#FF0000"><b>Not</b></font><font color="#000080">(</font>CloseComm<font color="#000080">(</font>cid<font color="#000080">)=</font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of CloseCom}

{****************************************************************************}
{*                                                                          *}
{*  Procedure CloseAllComs                                                  *}
{*                                                                          *}
{*  CloseAllComs will CLOSE all currently OPENed ports.  See the CloseCom   *}
{*  procedure description for more details.                                 *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>CloseAllComs<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>X <font color="#000080">: </font>C_ports<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  For </b></font>X <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>C_MaxCom <font color="#FF0000"><b>Do
    If </b></font>portopen<font color="#000080">[</font>X<font color="#000080">] </font><font color="#FF0000"><b>Then </b></font>CloseCom<font color="#000080">(</font>X<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of CloseAllComs}

{****************************************************************************}
{*                                                                          *}
{*  Procedure ComSetEoln(ComPort:C_ports;EolnCh : T_eoln)                 *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # for which to alter the eoln character          *}
{*                    Request ignored if port closed or out of range.       *}
{*  EolnCh:T_eoln -&gt;  Eoln character needed                                 *}
{*                                                                          *}
{*  With this function one can toggle the eoln character between cr and lf. *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>ComSetEoln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">;</font>EolnCh <font color="#000080">: </font>T_eoln<font color="#000080">); </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then </b></font>eolns<font color="#000080">[</font>comport<font color="#000080">]:=</font>EolnCh<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComSetEoln}

{****************************************************************************}
{*                                                                          *}
{*  Function  ComGetBufsize(ComPort:C_ports;IO : char)                      *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # for which to retrieve the buffersize           *}
{*                    Request ignored if port closed or out of range.       *}
{*  IO:Char       -&gt;  Action code; I=Input, O=Output                        *}
{*                    Returns 0 if action code unrecognized.                *}
{*                                                                          *}
{*  This function will return the buffer size defined for a serial port.    *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>ComGetBufsize<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">;</font>IO <font color="#000080">: </font>Char<font color="#000080">) : </font>WORD<font color="#000080">; </font><font color="#FF0000"><b>Export</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ComGetBufSize<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ComPort <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">]) </font><font color="#FF0000"><b>And
     </b></font><font color="#000080">(</font>portopen<font color="#000080">[</font>ComPort<font color="#000080">])
    </font><font color="#FF0000"><b>Then
      CASE </b></font>Upcase<font color="#000080">(</font>IO<font color="#000080">) </font><font color="#FF0000"><b>OF
        </b></font><font color="#800000">'I' </font><font color="#000080">: </font>ComgetBufSize<font color="#000080">:=</font>inbs <font color="#000080">[</font>comport<font color="#000080">];
        </font><font color="#800000">'O' </font><font color="#000080">: </font>ComgetBufSize<font color="#000080">:=</font>outbs<font color="#000080">[</font>comport<font color="#000080">];
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of ComGetBufferSize}

{****************************************************************************}

</i></font><font color="#FF0000"><b>Exports
  </b></font>ComReadCh         <font color="#FF0000"><b>index  </b></font><font color="#800000">1</font><font color="#000080">,
  </font>ComReadChW        <font color="#FF0000"><b>index  </b></font><font color="#800000">2</font><font color="#000080">,
  </font>ComWriteCh        <font color="#FF0000"><b>index  </b></font><font color="#800000">3</font><font color="#000080">,
  </font>ComWriteChW       <font color="#FF0000"><b>index  </b></font><font color="#800000">4</font><font color="#000080">,
  </font>ClearCom          <font color="#FF0000"><b>index  </b></font><font color="#800000">5</font><font color="#000080">,
  </font>ComBufferLeft     <font color="#FF0000"><b>index  </b></font><font color="#800000">6</font><font color="#000080">,
  </font>ComWaitForClear   <font color="#FF0000"><b>index  </b></font><font color="#800000">7</font><font color="#000080">,
  </font>ComWrite          <font color="#FF0000"><b>index  </b></font><font color="#800000">8</font><font color="#000080">,
  </font>ComWriteln        <font color="#FF0000"><b>index  </b></font><font color="#800000">9</font><font color="#000080">,
  </font>ComWriteWithDelay <font color="#FF0000"><b>index </b></font><font color="#800000">10</font><font color="#000080">,
  </font>ComReadln         <font color="#FF0000"><b>index </b></font><font color="#800000">11</font><font color="#000080">,
  </font>SetRTSmode        <font color="#FF0000"><b>index </b></font><font color="#800000">12</font><font color="#000080">,
  </font>SetCTSMode        <font color="#FF0000"><b>index </b></font><font color="#800000">13</font><font color="#000080">,
  </font>SoftHandshake     <font color="#FF0000"><b>index </b></font><font color="#800000">14</font><font color="#000080">,
  </font>ComExist          <font color="#FF0000"><b>index </b></font><font color="#800000">15</font><font color="#000080">,
  </font>ComTrueBaud       <font color="#FF0000"><b>index </b></font><font color="#800000">16</font><font color="#000080">,
  </font>ComParams         <font color="#FF0000"><b>index </b></font><font color="#800000">17</font><font color="#000080">,
  </font>OpenCom           <font color="#FF0000"><b>index </b></font><font color="#800000">18</font><font color="#000080">,
  </font>CloseCom          <font color="#FF0000"><b>index </b></font><font color="#800000">19</font><font color="#000080">,
  </font>CloseAllComs      <font color="#FF0000"><b>index </b></font><font color="#800000">20</font><font color="#000080">,
  </font>ComSetEoln        <font color="#FF0000"><b>index </b></font><font color="#800000">21</font><font color="#000080">,
  </font>ComGetBufSize     <font color="#FF0000"><b>index </b></font><font color="#800000">22</font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">.

</font><font color="#008000"><i>{----The following procedures/functions from the async12 }
{    package are not available                           }

{****************************************************************************}
{*                                                                          *}
{*  Procedure SetDTR(ComPort:Byte; Assert:Boolean);                         *}
{*                                                                          *}
{*  ComPort:Byte    -&gt;  Port # to use (1 - C_MaxCom)                        *}
{*                      Call ignored if out-of-range                        *}
{*  Assert:Boolean  -&gt;  DTR assertion flag (TRUE to assert DTR)             *}
{*                                                                          *}
{*  Provides a means to control the port's DTR (Data Terminal Ready) signal *}
{*  line.  When [Assert] is TRUE, the DTR line is placed in the &quot;active&quot;    *}
{*  state, signalling to a remote system that the host is &quot;on-line&quot;         *}
{*  (although not nessesarily ready to receive data - see SetRTS).          *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetDTR<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Assert<font color="#000080">:</font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">; </font><font color="#008000"><i>{of SetDTR}

{****************************************************************************}
{*                                                                          *}
{*  Procedure SetRTS(ComPort:Byte; Assert:Boolean)                          *}
{*                                                                          *}
{*  ComPort:Byte    -&gt;  Port # to use (1 - C_MaxCom)                        *}
{*                      Call ignored if out-of-range                        *}
{*  Assert:Boolean  -&gt;  RTS assertion flag (Set TRUE to assert RTS)         *}
{*                                                                          *}
{*  SetRTS allows a program to manually control the Request-To-Send (RTS)   *}
{*  signal line.  If RTS handshaking is disabled (see C_Ctrl definition     *}
{*  and the the SetRTSMode procedure), this procedure may be used.  SetRTS  *}
{*  should NOT be used if RTS handshaking is enabled.                       *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetRTS<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Assert<font color="#000080">:</font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">; </font><font color="#008000"><i>{of SetRTS}

{****************************************************************************}
{*                                                                          *}
{*  Procedure SetOUT1(ComPort:Byte; Assert:Boolean)                         *}
{*                                                                          *}
{*  ComPort:Byte    -&gt;  Port # to use (1 - C_MaxCom)                        *}
{*                      Call ignored if out-of-range                        *}
{*  Assert:Boolean  -&gt;  OUT1 assertion flag (set TRUE to assert OUT1 line)  *}
{*                                                                          *}
{*  SetOUT1 is provided for reasons of completeness only, since the         *}
{*  standard PC/XT/AT configurations do not utilize this control signal.    *}
{*  If [Assert] is TRUE, the OUT1 signal line on the 8250 will be set to a  *}
{*  LOW logic level (inverted logic).  The OUT1 signal is present on pin 34 *}
{*  of the 8250 (but not on the port itself).                               *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetOUT1<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Assert<font color="#000080">:</font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">;  </font><font color="#008000"><i>{of SetOUT1}

{****************************************************************************}
{*                                                                          *}
{*  Procedure SetOUT2(ComPort:Byte; Assert:Boolean)                         *}
{*                                                                          *}
{*  ComPort:Byte    -&gt;  Port # to use (1 - C_MaxCom)                        *}
{*                      Call ignored if out-of-range                        *}
{*  Assert:Boolean  -&gt;  OUT2 assertion flag (set TRUE to assert OUT2 line)  *}
{*                                                                          *}
{*  The OUT2 signal line, although not available on the port itself, is     *}
{*  used to gate the 8250 &lt;INTRPT&gt; (interrupt) line and thus acts as a      *}
{*  redundant means of controlling 8250 interrupts.  When [Assert] is TRUE, *}
{*  the /OUT2 line on the 8250 is lowered, which allows the passage of the  *}
{*  &lt;INTRPT&gt; signal through a gating arrangement, allowing the 8250 to      *}
{*  generate interrupts.  Int's can be disabled bu unASSERTing this line.   *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetOUT2<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Assert<font color="#000080">:</font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">; </font><font color="#008000"><i>{of SetOUT2}

{****************************************************************************}
{*                                                                          *}
{*  Function CTSStat(ComPort:Byte) : Boolean                                *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*                    Call ignored if out-of-range                          *}
{*  Returns status of Clear-To-Send line (TRUE if CTS asserted)             *}
{*                                                                          *}
{*  CTSStat provides a means to interrogate the Clear-To-Send hardware      *}
{*  handshaking line.  In a typical arrangement, when CTS is asserted, this *}
{*  signals the host (this computer) that the receiver is ready to accept   *}
{*  data (in contrast to the DSR line, which signals the receiver as        *}
{*  on-line but not nessesarily ready to accept data).  An automated mech-  *}
{*  ansim (see CTSMode) is provided to do this, but in cases where this is  *}
{*  undesirable or inappropriate, the CTSStat function can be used to int-  *}
{*  terrogate this line manually.                                           *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>CTSStat<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">; </font><font color="#008000"><i>{of CTSstat}

{****************************************************************************}
{*                                                                          *}
{*  Function DSRStat(ComPort:Byte) : Boolean                                *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*                    Call ignored if out-of-range                          *}
{*  Returns status of Data Set Ready (DSR) signal line.                     *}
{*                                                                          *}
{*  The Data Set Ready (DSR) line is typically used by a remote station     *}
{*  to signal the host system that it is on-line (although not nessesarily  *}
{*  ready to receive data yet - see CTSStat).  A remote station has the DSR *}
{*  line asserted if DSRStat returns TRUE.                                  *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>DSRStat<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">; </font><font color="#008000"><i>{of DSRstat}

{****************************************************************************}
{*                                                                          *}
{*  Function RIStat(ComPort:Byte) : Boolean                                 *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*                    Call ignored if out-of-range                          *}
{*                                                                          *}
{*  Returns the status of the Ring Indicator (RI) line.  This line is       *}
{*  typically used only by modems, and indicates that the modem has detect- *}
{*  ed an incoming call if RIStat returns TRUE.                             *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>RIStat<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">; </font><font color="#008000"><i>{of RIstat}

{****************************************************************************}
{*                                                                          *}
{*  Function DCDStat(ComPort:Byte) : Boolean                                *}
{*                                                                          *}
{*  ComPort:Byte  -&gt;  Port # to use (1 - C_MaxCom)                          *}
{*                    Call ignored if out-of-range                          *}
{*                                                                          *}
{*  Returns the status of the Data Carrier Detect (DCD) line from the rem-  *}
{*  ote device, typically a modem.  When asserted (DCDStat returns TRUE),   *}
{*  the modem indicates that it has successfuly linked with another modem   *}
{*  device at another site.                                                 *}
{*                                                                          *}
{****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>DCDStat<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">; </font><font color="#008000"><i>{of DCDstat}

{ ---------------    WINDOWS INTERFACE UNIT -------------------- }

</i></font><font color="#FF0000"><b>Unit </b></font>WinAsync<font color="#000080">;

</font><font color="#FF0000"><b>Interface

CONST
  </b></font>C_MaxCom   <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;             </font><font color="#008000"><i>{----supports COM1..COM4                        }
  </i></font>C_MinBaud  <font color="#000080">= </font><font color="#800000">110</font><font color="#000080">;           </font><font color="#008000"><i>{----min baudrate supported by windows 3.1      }
  </i></font>C_MaxBaud  <font color="#000080">= </font><font color="#800000">256000</font><font color="#000080">;        </font><font color="#008000"><i>{----max baudrate supported by windows 3.1      }

</i></font><font color="#FF0000"><b>TYPE
  </b></font>T_eoln     <font color="#000080">= (</font>C_cr<font color="#000080">,</font>C_lf<font color="#000080">);   </font><font color="#008000"><i>{----used to change EOLN character from cr to lf}
  </i></font>C_ports    <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">..</font>C_MaxCom<font color="#000080">;   </font><font color="#008000"><i>{----subrange type to minimize programming errors}


</i></font><font color="#FF0000"><b>Function  </b></font>ComReadCh<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">)  : </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>ComReadChW<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">) : </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComReadln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Size<font color="#000080">:</font>Byte<font color="#000080">; </font>Echo<font color="#000080">:</font>Boolean<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>ComWriteCh<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">; </font>Ch<font color="#000080">:</font>Char<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>ComWriteChW<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">; </font>Ch<font color="#000080">:</font>Char<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>ComWrite<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>ComWriteln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>ComWriteWithDelay<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Dly<font color="#000080">:</font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>ClearCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_Ports<font color="#000080">;</font>IO<font color="#000080">:</font>Char<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>ComBufferLeft<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>IO<font color="#000080">:</font>Char<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComWaitForClear<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>SetRTSmode<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">; </font>RTSOn<font color="#000080">,</font>RTSOff<font color="#000080">:</font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>SetCTSMode<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>SoftHandshake<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">; </font>Start<font color="#000080">,</font>Stop<font color="#000080">:</font>Char<font color="#000080">);

</font><font color="#FF0000"><b>Function  </b></font>ComExist<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComParams<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>Baud<font color="#000080">:</font>LongInt<font color="#000080">; </font>WordSize<font color="#000080">:</font>Byte<font color="#000080">; </font>Parity<font color="#000080">:</font>Char<font color="#000080">; </font>StopBits<font color="#000080">:</font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>ComTrueBaud<font color="#000080">(</font>Baud<font color="#000080">:</font>Longint<font color="#000080">) : </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>OpenCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>InBufferSize<font color="#000080">,</font>OutBufferSize<font color="#000080">:</font>Word<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>CloseCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>CloseAllComs<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComSetEoln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">;</font>EolnCh <font color="#000080">: </font>T_eoln<font color="#000080">);

</font><font color="#FF0000"><b>Function </b></font>ComGetBufsize<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">;</font>IO <font color="#000080">: </font>Char<font color="#000080">) : </font>WORD<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Function  </b></font>ComReadCh<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">)  : </font>Char<font color="#000080">;                                  </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>ComReadChW<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">) : </font>Char<font color="#000080">;                                  </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComWriteCh<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">; </font>Ch<font color="#000080">:</font>Char<font color="#000080">);                                </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComWriteChW<font color="#000080">(</font>comport<font color="#000080">:</font>C_ports<font color="#000080">; </font>Ch<font color="#000080">:</font>Char<font color="#000080">);                               </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ClearCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_Ports<font color="#000080">;</font>IO<font color="#000080">:</font>Char<font color="#000080">);                                   </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>ComBufferLeft<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>IO<font color="#000080">:</font>Char<font color="#000080">) : </font>Word<font color="#000080">;                      </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComWaitForClear<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">);                                    </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComWrite<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);                                </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComWriteln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);                              </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComWriteWithDelay<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Dly<font color="#000080">:</font>Word<font color="#000080">);             </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComReadln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>St<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">;</font>Size<font color="#000080">:</font>Byte<font color="#000080">; </font>Echo<font color="#000080">:</font>Boolean<font color="#000080">);   </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SetRTSmode<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">; </font>RTSOn<font color="#000080">,</font>RTSOff<font color="#000080">:</font>Word<font color="#000080">);        </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SetCTSMode<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">);                              </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SoftHandshake<font color="#000080">(</font>ComPort<font color="#000080">:</font>Byte<font color="#000080">; </font>Mode<font color="#000080">:</font>Boolean<font color="#000080">; </font>Start<font color="#000080">,</font>Stop<font color="#000080">:</font>Char<font color="#000080">);          </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>ComExist<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">) : </font>Boolean<font color="#000080">;                                 </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>ComTrueBaud<font color="#000080">(</font>Baud<font color="#000080">:</font>Longint<font color="#000080">) : </font>Real<font color="#000080">;                                    </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComParams<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>Baud<font color="#000080">:</font>LongInt<font color="#000080">; </font>WordSize<font color="#000080">:</font>Byte<font color="#000080">;
                                     </font>Parity<font color="#000080">:</font>Char<font color="#000080">; </font>StopBits<font color="#000080">:</font>Byte<font color="#000080">);              </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>OpenCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">; </font>InBufferSize<font color="#000080">,</font>OutBufferSize<font color="#000080">:</font>Word<font color="#000080">) : </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>CloseCom<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">);                                           </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>CloseAllComs<font color="#000080">;                                                        </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>ComSetEoln<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">;</font>EolnCh <font color="#000080">: </font>T_eoln<font color="#000080">);                         </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>ComGetBufsize<font color="#000080">(</font>ComPort<font color="#000080">:</font>C_ports<font color="#000080">;</font>IO <font color="#000080">: </font>Char<font color="#000080">) : </font>WORD<font color="#000080">;                      </font><font color="#FF0000"><b>external </b></font><font color="#800000">'async12w'</font><font color="#000080">;


</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font><font color="#008000"><i>{ ------------------------------   TEST PROGRAM  ----------------------- }

</i></font><font color="#FF0000"><b>Program </b></font>Asynctst<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Wincrt<font color="#000080">,
  </font>Asyncwin<font color="#000080">;

</font><font color="#008000"><i>{----Demo main program for Async12w}

</i></font><font color="#FF0000"><b>Var
  </b></font>p <font color="#000080">: </font>Byte<font color="#000080">;
  </font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>i <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Write<font color="#000080">(</font><font color="#800000">'Enter serial port number [1..4] : '</font><font color="#000080">); </font>readln<font color="#000080">(</font>p<font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font>ComExist<font color="#000080">(</font>p<font color="#000080">) </font><font color="#FF0000"><b>And </b></font>OpenCom<font color="#000080">(</font>p<font color="#000080">,</font><font color="#800000">1024</font><font color="#000080">,</font><font color="#800000">1024</font><font color="#000080">)
    </font><font color="#FF0000"><b>Then
      Begin
        </b></font>ComParams<font color="#000080">(</font>p<font color="#000080">,</font><font color="#800000">9600</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">'N'</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);

      </font><font color="#008000"><i>{----Hayes modems echo a cr,lf so lf as eoln char is easier to program.
           The cr is skipped also. Default eoln character is cr, equivalent
           to BP's readln procedure}
        </i></font>ComSetEoln<font color="#000080">(</font>p<font color="#000080">,</font>c_lf<font color="#000080">);
        </font>Writeln<font color="#000080">(</font><font color="#800000">'Enter a Hayes Command, like ATX1'</font><font color="#000080">);
        </font>Readln<font color="#000080">(</font>s<font color="#000080">);
        </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>s<font color="#000080">&lt;&gt;</font><font color="#800000">''</font><font color="#000080">)
          </font><font color="#FF0000"><b>THEN
            BEGIN
              </b></font>Write<font color="#000080">(</font><font color="#800000">'Sending...'</font><font color="#000080">);
              </font>ComWriteWithDelay<font color="#000080">(</font>p<font color="#000080">,</font>s<font color="#000080">+</font><font color="#800000">#13#10</font><font color="#000080">,</font><font color="#800000">500</font><font color="#000080">);
              </font>Writeln<font color="#000080">(</font><font color="#800000">' ok, press &lt;enter&gt; to continue.'</font><font color="#000080">);

              </font>Readln<font color="#000080">;
              </font><font color="#FF0000"><b>Repeat
                </b></font>Write<font color="#000080">(</font><font color="#800000">'['</font><font color="#000080">,</font>CombufferLeft<font color="#000080">(</font>p<font color="#000080">,</font><font color="#800000">'I'</font><font color="#000080">):</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">']'</font><font color="#000080">);
                </font>ComReadln<font color="#000080">(</font>p<font color="#000080">,</font>s<font color="#000080">,</font><font color="#800000">255</font><font color="#000080">,</font>false<font color="#000080">);
                </font>Writeln<font color="#000080">(</font><font color="#800000">'['</font><font color="#000080">,</font>ComBufferLeft<font color="#000080">(</font>p<font color="#000080">,</font><font color="#800000">'I'</font><font color="#000080">):</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">']'</font><font color="#000080">,</font>s<font color="#000080">);
              </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>ComBufferLeft<font color="#000080">(</font>p<font color="#000080">,</font><font color="#800000">'I'</font><font color="#000080">)=</font><font color="#800000">1024</font><font color="#000080">);
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font>CloseCom<font color="#000080">(</font>p<font color="#000080">);
      </font><font color="#FF0000"><b>End
    Else </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Error opening COM'</font><font color="#000080">,</font>p<font color="#000080">,</font><font color="#800000">' port'</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.


</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0046.PAS">Original</a><b>]</b></p></body>
</html>
