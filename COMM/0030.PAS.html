<html>
<head><title> "Very GOOD Async package" by CHRISTIAN PHILIPPS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0030.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
FRANCK DUMONT

------------------------------------------ ASM ------------------------------

;//////////////////////////////////////////////////////////////////////////
;///                                                                    ///
;///           Turbo-Pascal V24-Interrupt-Support      V2.00            ///
;///                                                                    ///
;///                 (c) Christian Philipps, Moers                      ///
;///                    June 1988 / West-Germany                        ///
;///                                                                    ///
;///                Turbo Pascal 4.0 or above required                  ///
;///                                                                    ///
;//////////////////////////////////////////////////////////////////////////

; This module is hereby donated to the public domain.

;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
;                    Datensegment
;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;

DATA     SEGMENT BYTE PUBLIC

         ; Turbo-Pascal Variable
         EXTRN V24HP      : WORD
         EXTRN V24TP      : WORD
         EXTRN V24BuffEnd : WORD
         EXTRN V24Buff    : BYTE
         EXTRN ComBase    : WORD

DATA     ENDS

;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
;                        Codesegment
;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;

CODE     SEGMENT BYTE PUBLIC

         ASSUME CS:CODE, DS:DATA

         PUBLIC V24Int

;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;

;CS-relative Daten

_Turbo_DS DW  DATA                              ; Turbo data segment
      ; (inserted by linkage editor)

;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
;                    Codebereich
;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;
;PROCEDURE V24Int; interrupt;
;  this routine is executed whenever a character arrives

V24Int   PROC  FAR                               ; Interrupt-Routine


V24Int   ENDP

  push ds                                 ; save registers
         push ax
         push bx
         push dx
  mov  ds,CS:_Turbo_DS                    ; set Turbo DS

  mov  bx,V24TP                           ; ds:bx -&gt; next free slot
  mov  dx,ComBase                         ; dx = port base-address
         in   al,dx                              ; RBR -&gt; al
  mov  byte ptr [bx],al                   ; move byte into buffer
  inc  bx                                 ; pointer to next slot
  cmp  bx,V24BuffEnd                      ; past the end of the buffer?
  jle  L1                                 ; no
  mov  bx,OFFSET V24Buff                  ; yes, so wrap around

L1:      cmp  bx,V24HP                           ; TP=HP --&gt; overflow!
  jz   L2                                 ; yes, ignore character
  mov  V24TP,bx                           ; no, save new tail pointer

L2:      mov  al,20H                             ; EOI -&gt; 8259
         out  20H,al
  pop  dx                                 ; restore registers
         pop  bx
         pop  ax
         pop  ds
         iret

CODE     ENDS

END
}
(*////////////////////////////////////////////////////////////////////////////
///                                                                        ///
///         T U R B O  -  P A S C A L  V24-Interrupt-Support V2.00         ///
///                (c) Copyright June 1988 by C.Philipps                   ///
///                                                                        ///
///               (Turbo Pascal V4.0  or higher required)                  ///
///                                                                        ///
//////////////////////////////////////////////////////////////////////////////
///                                                                        ///
///            Low-level interrupt-handling for the serial ports. Speeds   ///
///            up to 115200 bps are supportet, one port at a time.         ///
///            Parts of the basics were taken from Mike Halliday's pop-    ///
///            ular ASYNC-package (Turbo Pascal 3.0, PD).                  ///
///                                                                        ///
///       This module is hereby donated to the public domain.              ///
///                                                                        ///
///       Christian Philipps                                               ///
///       DÅsseldorfer Str. 316                                            ///
///       4130 Moers 1                                                     ///
///       West-Germany                                                     ///
///                                                                        ///
///       Last modified: 07/89                                             ///
///                                                                        ///
////////////////////////////////////////////////////////////////////////////*)

{$R-,S-,I-,D-,F-,V-,B-,N-,L- }

</i></font><font color="#FF0000"><b>UNIT </b></font>V24<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

USES
  </b></font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>TYPE
  </b></font>ComType      <font color="#000080">= (</font>com1<font color="#000080">, </font>com2<font color="#000080">, </font>com3<font color="#000080">, </font>com4<font color="#000080">, </font>com5<font color="#000080">, </font>com6<font color="#000080">);
  </font>BaudType     <font color="#000080">= (</font>b110<font color="#000080">, </font>b150<font color="#000080">, </font>b300<font color="#000080">, </font>b600<font color="#000080">, </font>b1200<font color="#000080">, </font>b2400<font color="#000080">, </font>b4800<font color="#000080">,
                  </font>b9600<font color="#000080">, </font>b19200<font color="#000080">, </font>b38400<font color="#000080">, </font>b57600<font color="#000080">, </font>b115200<font color="#000080">);
  </font>ParityType   <font color="#000080">= (</font>Space<font color="#000080">, </font>Odd<font color="#000080">, </font>Mark<font color="#000080">, </font>Even<font color="#000080">, </font>None<font color="#000080">);
  </font>DataBitsType <font color="#000080">= (</font>d5<font color="#000080">, </font>d6<font color="#000080">, </font>d7<font color="#000080">, </font>d8<font color="#000080">);
  </font>StopBitsType <font color="#000080">= (</font>s1<font color="#000080">, </font>s2<font color="#000080">);

</font><font color="#FF0000"><b>CONST
  </b></font>V24Timeout <font color="#000080">: </font>BOOLEAN <font color="#000080">= </font>FALSE<font color="#000080">;  </font><font color="#008000"><i>{SendByte-Timeout}
  </i></font>IntMasks   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>Com1<font color="#000080">..</font>Com6<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>WORD <font color="#000080">= (</font><font color="#800000">$EF</font><font color="#000080">,</font><font color="#800000">$F7</font><font color="#000080">,</font><font color="#800000">$EF</font><font color="#000080">,</font><font color="#800000">$F7</font><font color="#000080">,</font><font color="#800000">$EF</font><font color="#000080">,</font><font color="#800000">$F7</font><font color="#000080">);
  </font>IntVect    <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>Com1<font color="#000080">..</font>Com6<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE <font color="#000080">= (</font><font color="#800000">$0C</font><font color="#000080">,</font><font color="#800000">$0B</font><font color="#000080">,</font><font color="#800000">$0C</font><font color="#000080">,</font><font color="#800000">$0B</font><font color="#000080">,</font><font color="#800000">$0C</font><font color="#000080">,</font><font color="#800000">$0B</font><font color="#000080">);

</font><font color="#FF0000"><b>VAR
  </b></font>V24TP      <font color="#000080">: </font>WORD<font color="#000080">; </font><font color="#008000"><i>{Buffer Tail-Pointer Im Interface-Teil, da zur
                      Ereignis-steuerung im Multi-Tasking benîtigt.}
  </i></font>ComBaseAdr <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>Com1<font color="#000080">..</font>Com6<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>WORD<font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION  </b></font>V24DataAvail <font color="#000080">: </font>BOOLEAN<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>V24GetByte <font color="#000080">: </font>BYTE<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>InitCom<font color="#000080">(</font>ComPort <font color="#000080">: </font>ComType<font color="#000080">; </font>Baudrate <font color="#000080">: </font>BaudType<font color="#000080">; </font>Parity <font color="#000080">: </font>ParityType<font color="#000080">;
                  </font>Bits <font color="#000080">: </font>DataBitsType<font color="#000080">; </font>Stop <font color="#000080">: </font>StopBitsType<font color="#000080">);
</font><font color="#FF0000"><b>PROCEDURE </b></font>DisableCom<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>SendByte<font color="#000080">(</font>Data <font color="#000080">: </font>BYTE<font color="#000080">);


</font><font color="#FF0000"><b>IMPLEMENTATION

CONST
  </b></font>Regs <font color="#000080">: </font>Registers <font color="#000080">=
    (</font>AX <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>BX <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>CX <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>DX <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>BP <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
     </font>SI <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>DI <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>DS <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>ES <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">; </font>FLAGS <font color="#000080">: </font><font color="#800000">0</font><font color="#000080">);
  </font>RBR <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;          </font><font color="#008000"><i>{xF8 Receive Buffer Register            }
  </i></font>THR <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;          </font><font color="#008000"><i>{xF8 Transmitter Holding Register       }
  </i></font>IER <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;          </font><font color="#008000"><i>{xF9 Interrupt Enable Register          }
  </i></font>IIR <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;          </font><font color="#008000"><i>{xFA Interrupt Identification Register  }
  </i></font>LCR <font color="#000080">= </font><font color="#800000">$03</font><font color="#000080">;          </font><font color="#008000"><i>{xFB Line Control Register              }
  </i></font>MCR <font color="#000080">= </font><font color="#800000">$04</font><font color="#000080">;          </font><font color="#008000"><i>{xFC Modem Control Register             }
  </i></font>LSR <font color="#000080">= </font><font color="#800000">$05</font><font color="#000080">;          </font><font color="#008000"><i>{xFD Line Status Register               }
  </i></font>MSR <font color="#000080">= </font><font color="#800000">$06</font><font color="#000080">;          </font><font color="#008000"><i>{xFE Modem Status Register              }
                                  {--- if LCR Bit 7 = 1  ---              }
  </i></font>DLL <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;          </font><font color="#008000"><i>{xF8 Divisor Latch Low Byte             }
  </i></font>DLH <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;          </font><font color="#008000"><i>{xF9 Divisor Latch Hi  Byte             }
  </i></font>CMD8259 <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;      </font><font color="#008000"><i>{Interrupt Controller Command Register  }
  </i></font>IMR8259 <font color="#000080">= </font><font color="#800000">$21</font><font color="#000080">;      </font><font color="#008000"><i>{Interrupt Controller Mask Register     }
                      {Should be evaluated by any higher-level send-routine}
  </i></font>LoopLimit   <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">; </font><font color="#008000"><i>{When does a timeout-error occur        }
  </i></font>V24BuffSize <font color="#000080">= </font><font color="#800000">2048</font><font color="#000080">; </font><font color="#008000"><i>{ Ringpuffer 2 KB }

</i></font><font color="#FF0000"><b>VAR
  </b></font>BiosComBaseAdr <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>Com1<font color="#000080">..</font>Com2<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>WORD <font color="#FF0000"><b>ABSOLUTE </b></font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$0000</font><font color="#000080">;
  </font>ActivePort     <font color="#000080">: </font>ComType<font color="#000080">;
  </font><font color="#008000"><i>{ The Com-Port base adresses are taken from the BIOS data area }
  </i></font>ComBase        <font color="#000080">: </font>WORD<font color="#000080">;         </font><font color="#008000"><i>{Hardware Com-Port Base Adress          }
  </i></font>OldV24         <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>V24HP          <font color="#000080">: </font>WORD<font color="#000080">;         </font><font color="#008000"><i>{Buffer Head-Pointer                    }
  </i></font>V24BuffEnd     <font color="#000080">: </font>WORD<font color="#000080">;         </font><font color="#008000"><i>{Buffer End-Adress                      }
  </i></font>V24Buff        <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>V24BuffSize<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
  </font>OExitHandler   <font color="#000080">: </font>Pointer<font color="#000080">;    </font><font color="#008000"><i>{Save-Area fÅr Zeiger auf Org.-Exit-Proc}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>V24Int<font color="#000080">; </font><font color="#FF0000"><b>external</b></font><font color="#000080">;
</font><font color="#008000"><i>{$L v24.obj}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ClearPendingInterrupts<font color="#000080">;
</font><font color="#FF0000"><b>VAR
  </b></font>N <font color="#000080">: </font>BYTE<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  WHILE </b></font><font color="#000080">(</font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>IIR<font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">1</font><font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>DO  </b></font><font color="#008000"><i>{While Interrupts are pending}
  </i></font><font color="#FF0000"><b>BEGIN
    </b></font>N <font color="#000080">:= </font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>LSR<font color="#000080">];               </font><font color="#008000"><i>{Read Line Status}
    </i></font>N <font color="#000080">:= </font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>MSR<font color="#000080">];               </font><font color="#008000"><i>{Read Modem Status}
    </i></font>N <font color="#000080">:= </font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>RBR<font color="#000080">];               </font><font color="#008000"><i>{Read Receive Buffer Register}
    </i></font>PORT<font color="#000080">[</font>CMD8259<font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;                   </font><font color="#008000"><i>{End of Interrupt}
  </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>FUNCTION </b></font>V24DataAvail<font color="#000080">:</font>BOOLEAN<font color="#000080">;
</font><font color="#008000"><i>{ This function checks, whether there are characters in the buffer }
</i></font><font color="#FF0000"><b>BEGIN
  </b></font>V24DataAvail <font color="#000080">:= (</font>V24HP <font color="#000080">&lt;&gt; </font>V24TP<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>FUNCTION </b></font>V24GetByte<font color="#000080">:</font>BYTE<font color="#000080">;
</font><font color="#008000"><i>{ Take a byte out of the ring-buffer and return it to the caller.
  This function assumes, that the application has called V24DataAvail
  before to assure, that there are characters available!!!!
  The ISR only reads the current head-pointer value, so this routine
  may modify the head-pointer with interrupts enabled. }
</i></font><font color="#FF0000"><b>BEGIN
  </b></font>V24GetByte <font color="#000080">:= </font>Mem<font color="#000080">[</font>DSeg<font color="#000080">:</font>V24HP<font color="#000080">];
  </font>Inc<font color="#000080">(</font>V24HP<font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font>V24HP <font color="#000080">&gt; </font>V24BuffEnd <font color="#FF0000"><b>THEN
    </b></font>V24HP <font color="#000080">:= </font>Ofs<font color="#000080">(</font>V24Buff<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>SendByte<font color="#000080">(</font>Data<font color="#000080">:</font>BYTE<font color="#000080">);
</font><font color="#FF0000"><b>VAR
  </b></font>Count <font color="#000080">: </font>BYTE<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>Count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>V24Timeout <font color="#000080">:= </font>FALSE<font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>ComBase <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
  BEGIN
    REPEAT
      </b></font>Count <font color="#000080">:= </font>SUCC<font color="#000080">(</font>Count<font color="#000080">);
    </font><font color="#FF0000"><b>UNTIL </b></font><font color="#000080">((</font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>LSR<font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$20</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>Count <font color="#000080">&gt; </font>LoopLimit<font color="#000080">);
    </font><font color="#FF0000"><b>IF </b></font>Count <font color="#000080">&gt; </font>LoopLimit <font color="#FF0000"><b>THEN
      </b></font>V24Timeout <font color="#000080">:= </font>TRUE
    <font color="#FF0000"><b>ELSE
      </b></font>PORT<font color="#000080">[</font>ComBase<font color="#000080">+</font>THR<font color="#000080">] := </font>Data<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>InitCom<font color="#000080">(</font>ComPort <font color="#000080">: </font>ComType<font color="#000080">; </font>Baudrate <font color="#000080">: </font>BaudType<font color="#000080">; </font>Parity <font color="#000080">: </font>ParityType<font color="#000080">;
                  </font>Bits <font color="#000080">: </font>DataBitsType<font color="#000080">; </font>Stop <font color="#000080">: </font>StopBitsType<font color="#000080">);
</font><font color="#FF0000"><b>CONST
  </b></font>BaudConst   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>b110<font color="#000080">..</font>b115200<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>WORD <font color="#000080">=
    (</font><font color="#800000">$417</font><font color="#000080">,</font><font color="#800000">$300</font><font color="#000080">,</font><font color="#800000">$180</font><font color="#000080">,</font><font color="#800000">$C0</font><font color="#000080">,</font><font color="#800000">$60</font><font color="#000080">,</font><font color="#800000">$30</font><font color="#000080">,</font><font color="#800000">$18</font><font color="#000080">,</font><font color="#800000">$0C</font><font color="#000080">,</font><font color="#800000">$06</font><font color="#000080">,</font><font color="#800000">$03</font><font color="#000080">,</font><font color="#800000">$02</font><font color="#000080">,</font><font color="#800000">$01</font><font color="#000080">);
  </font>ParityConst <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>Space<font color="#000080">..</font>None<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE <font color="#000080">= (</font><font color="#800000">$38</font><font color="#000080">,</font><font color="#800000">$08</font><font color="#000080">,</font><font color="#800000">$28</font><font color="#000080">,</font><font color="#800000">$18</font><font color="#000080">,</font><font color="#800000">$00</font><font color="#000080">);
  </font>BitsConst   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>d5<font color="#000080">..</font>d8<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE <font color="#000080">= (</font><font color="#800000">$00</font><font color="#000080">,</font><font color="#800000">$01</font><font color="#000080">,</font><font color="#800000">$02</font><font color="#000080">,</font><font color="#800000">$03</font><font color="#000080">);
  </font>StopConst   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font>s1<font color="#000080">..</font>s2<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE <font color="#000080">= (</font><font color="#800000">$00</font><font color="#000080">,</font><font color="#800000">$04</font><font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  </b></font>V24HP       <font color="#000080">:= </font>Ofs<font color="#000080">(</font>V24Buff<font color="#000080">);
  </font>V24TP       <font color="#000080">:= </font>V24HP<font color="#000080">;
  </font>V24BuffEnd  <font color="#000080">:= </font>V24HP <font color="#000080">+ </font>V24BuffSize<font color="#000080">;
  </font>FillChar<font color="#000080">(</font>V24Buff<font color="#000080">, </font>Succ<font color="#000080">(</font>V24BuffSize<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);
  </font>V24Timeout <font color="#000080">:= </font>FALSE<font color="#000080">;                           </font><font color="#008000"><i>{Reset Timeout-Marker}
  </i></font>ComBase <font color="#000080">:= </font>ComBaseAdr<font color="#000080">[</font>ComPort<font color="#000080">];                </font><font color="#008000"><i>{Get Com-Port base adress}
  </i></font>ActivePort <font color="#000080">:= </font>ComPort<font color="#000080">;                         </font><font color="#008000"><i>{Keep Active-Port for EOI}
  </i></font>ClearPendingInterrupts<font color="#000080">;
  </font>GetIntVec<font color="#000080">(</font>IntVect<font color="#000080">[</font>ComPort<font color="#000080">], </font>OldV24<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font>IntVect<font color="#000080">[</font>ComPort<font color="#000080">], @</font>V24Int<font color="#000080">);
                                                 </font><font color="#008000"><i>{Install interrupt routine}
  </i></font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);                                   </font><font color="#008000"><i>{CLI}
  </i></font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>LCR<font color="#000080">] := </font><font color="#800000">$80</font><font color="#000080">;                    </font><font color="#008000"><i>{Adress Divisor Latch}
  </i></font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>DLH<font color="#000080">] := </font>Hi<font color="#000080">(</font>BaudConst<font color="#000080">[</font>Baudrate<font color="#000080">]);</font><font color="#008000"><i>{Set Baud rate}
  </i></font>PORT<font color="#000080">[</font>COMBase <font color="#000080">+ </font>DLL<font color="#000080">] := </font>Lo<font color="#000080">(</font>BaudConst<font color="#000080">[</font>Baudrate<font color="#000080">]);
  </font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>LCR<font color="#000080">] := (</font><font color="#800000">$00 </font><font color="#FF0000"><b>OR </b></font>ParityConst<font color="#000080">[</font>Parity<font color="#000080">] </font><font color="#008000"><i>{Setup Parity}
                            </i></font><font color="#FF0000"><b>OR </b></font>BitsConst<font color="#000080">[</font>Bits<font color="#000080">]   </font><font color="#008000"><i>{Setup number of databits}
                            </i></font><font color="#FF0000"><b>OR </b></font>StopConst<font color="#000080">[</font>Stop<font color="#000080">]); </font><font color="#008000"><i>{Setup number of stopbits}
  </i></font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>MCR<font color="#000080">] := </font><font color="#800000">$0B</font><font color="#000080">;                    </font><font color="#008000"><i>{Set RTS,DTR,OUT2}
(*
  PORT[ComBase+MCR] := $1B;                      {Set RTS,DTR,OUT2,Loop}
*)
  </i></font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>IER<font color="#000080">] := </font><font color="#800000">$01</font><font color="#000080">; </font><font color="#008000"><i>{Enable Data-Available Interrupts}
  </i></font>PORT<font color="#000080">[</font>IMR8259<font color="#000080">] := </font>PORT<font color="#000080">[</font>IMR8259<font color="#000080">] </font><font color="#FF0000"><b>AND </b></font>IntMasks<font color="#000080">[</font>ComPort<font color="#000080">]; </font><font color="#008000"><i>{Enable V24-Interrups}
  </i></font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);  </font><font color="#008000"><i>{STI}
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>PROCEDURE </b></font>DisableCom<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  IF </b></font>ComBase <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);                           </font><font color="#008000"><i>{CLI}
  </i></font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>MCR<font color="#000080">] := </font><font color="#800000">00</font><font color="#000080">;             </font><font color="#008000"><i>{Disable Interrupts, Reset MCR}
  </i></font>PORT<font color="#000080">[</font>IMR8259<font color="#000080">] := </font>PORT<font color="#000080">[</font>IMR8259<font color="#000080">] </font><font color="#FF0000"><b>OR </b></font><font color="#800000">$18</font><font color="#000080">; </font><font color="#008000"><i>{Disable Interrupt Level 3 and 4}
  </i></font>PORT<font color="#000080">[</font>ComBase <font color="#000080">+ </font>IER<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;              </font><font color="#008000"><i>{Disable 8250-Interrupts}
  </i></font>ClearPendingInterrupts<font color="#000080">;                </font><font color="#008000"><i>{Clean up}
  </i></font>ComBase <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                          </font><font color="#008000"><i>{Reset Combase}
  </i></font>SetIntVec<font color="#000080">(</font>IntVect<font color="#000080">[</font>ActivePort<font color="#000080">], </font>OldV24<font color="#000080">);</font><font color="#008000"><i>{Reset old IV}
  </i></font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);                           </font><font color="#008000"><i>{STI}
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{$F+}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>V24ExitProc<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{V24ExitProc}
  </i></font>DisableCom<font color="#000080">;
  </font>ExitProc <font color="#000080">:= </font>OExitHandler<font color="#000080">;                 </font><font color="#008000"><i>{ alten Exit-Handler reaktivieren }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;  </font><font color="#008000"><i>{V24ExitProc}
{$F-}


</i></font><font color="#FF0000"><b>BEGIN
  </b></font><font color="#008000"><i>{Grund-Init, damit irrtÅmliche Aufrufe von V24DataAvail nicht zu
   endlosen Ausgaben von Speicherschrott fÅhren!}
  </i></font>Move<font color="#000080">(</font>BiosComBaseAdr<font color="#000080">, </font>ComBaseAdr<font color="#000080">[</font>Com1<font color="#000080">], </font>SizeOf<font color="#000080">(</font>BiosComBaseAdr<font color="#000080">));
  </font>Move<font color="#000080">(</font>BiosComBaseAdr<font color="#000080">, </font>ComBaseAdr<font color="#000080">[</font>Com3<font color="#000080">], </font>SizeOf<font color="#000080">(</font>BiosComBaseAdr<font color="#000080">));
  </font>Move<font color="#000080">(</font>BiosComBaseAdr<font color="#000080">, </font>ComBaseAdr<font color="#000080">[</font>Com5<font color="#000080">], </font>SizeOf<font color="#000080">(</font>BiosComBaseAdr<font color="#000080">));
  </font>ComBase    <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>V24HP      <font color="#000080">:= </font>Ofs<font color="#000080">(</font>V24Buff<font color="#000080">);
  </font>V24TP      <font color="#000080">:= </font>V24HP<font color="#000080">;
  </font>V24BuffEnd <font color="#000080">:= </font>V24HP <font color="#000080">+ </font>V24BuffSize<font color="#000080">;

  </font>OExitHandler <font color="#000080">:= </font>ExitProc<font color="#000080">;
  </font>ExitProc     <font color="#000080">:= @</font>V24ExitProc<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COMM SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0030.PAS">Original</a><b>]</b></p></body>
</html>
