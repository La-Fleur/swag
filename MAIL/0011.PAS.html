<html>
<head><title> "Reading QWK Files" by WILLIAM MCBRINE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MAIL SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0011.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
WILLIAM MCBRINE

&gt;I have this File here that tells me the format of QWK stuff, and it
&gt;says that the messages.dat File is a whole bunch of Strings of length 128...

This is wrong. They aren't Pascal Strings, simply 128-Byte blocks.
Within the Text blocks, each line is terminated by a &quot;pi&quot; Character
($E3).

&gt;I dont know if I did this right but what I load the data into is
&gt;this:  (I have an Array[1..100] of messagedata).

&gt;Type
&gt;  MessageData = Record
&gt;    Rec : String[128];
&gt;  end;

For blocks of Text, you want someting like this:

Type
  messagedata = Array[0..127] of Char;

For the message HEADER, you need something more complex. Here's the
structure I use in my QWK door:
}
</i></font>qwkhead <font color="#000080">= </font><font color="#FF0000"><b>Record
  </b></font>status   <font color="#000080">: </font>Char<font color="#000080">;
  </font>messnum  <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>date     <font color="#000080">: </font><font color="#FF0000"><b>Record
    </b></font>month <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
    </font>dash1 <font color="#000080">: </font>Char<font color="#000080">;
    </font>day   <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
    </font>dash2 <font color="#000080">: </font>Char<font color="#000080">;
    </font>year  <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char
  <font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>time     <font color="#000080">: </font><font color="#FF0000"><b>Record
    </b></font>hour   <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
    </font>colon  <font color="#000080">: </font>Char<font color="#000080">;
    </font>minute <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char
  <font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>toname   <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">25</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>from     <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">25</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>subject  <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">25</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>passwd   <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">12</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>refnum   <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>length   <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>killflag <font color="#000080">: </font>Byte<font color="#000080">;
  </font>confnum  <font color="#000080">: </font>Word<font color="#000080">;
  </font>null     <font color="#000080">: </font>Word<font color="#000080">;
  </font>nettag   <font color="#000080">: </font>Char
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{
This is also 128 Bytes.

&gt;1).  A tiny little thing that's not too important right now, but it's
&gt;bugging me.  When I try to load the first Record (which is supposed
&gt;to be a packet header) from messages.dat, I seem to be not reading in
&gt;the first Character... Like, Constantly it'll skip the first
&gt;Character... it'll say &quot;roduced by Qmail...&quot; instead of &quot;Produced by
&gt;Qmail...&quot;

The first Character is going into the length field of the String.
Position [0] of the String contains the length.

Your &quot;problem 2&quot; is the same thing. 128 Bytes are actually read, but
only the erroneous length's worth of them are printed out.

Here's some pseudocode to read a whole packet:

 Open MESSAGES.DAT
 Skip the first Record (128 Bytes)
 While not EOF do
  begin
   Read a message header
   Get length of Text in blocks from qwkhead.length (in ASCII) -1
   Reserve memory For 128 Bytes*number of blocks
   Read Text blocks
   Parse Text
   Release memory
  end
 Close MESSAGES.DAT, cleanup

&quot;Parse Text&quot; is the hard part. I wrote an Asm routine to convert the
pi-delimited Text into Strings, pointed to by an Array of Pointers.
(This is the format used by the Searchlight Programmer's Library message
routines; pretty easy to work With.) Pointer &quot;a&quot; points to this:

 msgType = Record
            msglen:Word;
            msglin:Array[1..400] of Pointer
           end;

The &quot;raw data&quot; (Pointer b) below starts one Byte before the actual QWK
data. The purpose of this is to hold the first String length after
conversion. &quot;d&quot; should be the maximum number of lines to convert (400,
in this case); &quot;e&quot; should be about 79 (though it can be set all the way
up to 255 if desired).
}

</i></font><font color="#FF0000"><b>Procedure </b></font>mangle<font color="#000080">(</font>a<font color="#000080">, </font>b <font color="#000080">: </font>Pointer<font color="#000080">; </font>c<font color="#000080">, </font>d<font color="#000080">, </font>e <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">push ds
  mov  ax,c           </font><font color="#008000"><i>{# of blocks loaded (maximum length)}
  </i></font><font color="#FF00FF">les  di,b           </font><font color="#008000"><i>{raw data; lines terminated With pi Chars}
  </i></font><font color="#FF00FF">lds  si,a           </font><font color="#008000"><i>{msgType: Word:linecount, 1..400:Pointers}
  </i></font><font color="#FF00FF">xor  bx,bx          </font><font color="#008000"><i>{line count=0}
  </i></font><font color="#FF00FF">inc  si             </font><font color="#008000"><i>{to first line Pointer}
  </i></font><font color="#FF00FF">inc  si
  mov  dx,di
  mov  cl,7
  shl  ax,cl          </font><font color="#008000"><i>{blocks * 128 = maximum Bytes in message}
  </i></font><font color="#FF00FF">mov  cx,ax
  cld
 @mloop:
  push  ax
  inc   di
  mov   al, $E3       </font><font color="#008000"><i>{pi Character; QWK packet line delimiter}
  </i></font><font color="#FF00FF">repnz scasb         </font><font color="#008000"><i>{find one}
  </i></font><font color="#FF00FF">pop   ax            </font><font color="#008000"><i>{ax = length before search, cx = length left}
  </i></font><font color="#FF00FF">jnz   @notfound     </font><font color="#008000"><i>{if there aren't any, done With message}
  </i></font><font color="#FF00FF">sub   ax, cx
  dec   ax            </font><font color="#008000"><i>{length of line}
  </i></font><font color="#FF00FF">cmp   ax, e
  jle   @placelen
  mov   ax, e         </font><font color="#008000"><i>{limit line length}
 </i></font><font color="#FF00FF">@placelen:
  xchg  di, dx        </font><font color="#008000"><i>{beginning of String in raw data}
  </i></font><font color="#FF00FF">seges mov [di], al  </font><font color="#008000"><i>{wow, now it's a Pascal String!}
  </i></font><font color="#FF00FF">mov   [si], di
  mov   [si+2], es
  add   si, 4         </font><font color="#008000"><i>{set the Pointer to it}
  </i></font><font color="#FF00FF">dec   dx            </font><font color="#008000"><i>{DX was at $E3 + 1}
  </i></font><font color="#FF00FF">mov   di, dx
  mov   ax, cx
  inc   bx
  cmp   bx, d         </font><font color="#008000"><i>{maximum number of lines}
  </i></font><font color="#FF00FF">jle   @mloop        </font><font color="#008000"><i>{start next line/String}
 </i></font><font color="#FF00FF">@notfound:
  lds   si, a         </font><font color="#008000"><i>{line counter in msgType}
  </i></font><font color="#FF00FF">mov   [si], bx      </font><font color="#008000"><i>{store # of lines}
  </i></font><font color="#FF00FF">pop   ds            </font><font color="#008000"><i>{magically a message!}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{then, to print this Text, you'd do something like this: }

</i></font><font color="#FF0000"><b>Procedure </b></font>dump<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>i <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  For </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>a<font color="#000080">^.</font>msglen <font color="#FF0000"><b>do
    </b></font>Writeln<font color="#000080">(</font>a<font color="#000080">^.</font>msglin<font color="#000080">[</font>i<font color="#000080">]^);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MAIL SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0011.PAS">Original</a><b>]</b></p></body>
</html>
