<html>
<head><title> "Writing JAM Base Messages" by MARCO MILTENBURG</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MAIL SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Is there somebody who can give me an example of
&gt; how to write an JAM Base message (RemoteAccess) ?

&gt; I already have JAMAPI and MKMSG I'll need just an simple unit how to
&gt; write fast and simple an message to the JAM base..

Try this... It should work with the standard JAMAPI (I think, at least I
can't remember changing anything in it). It's a little piece of testcode
I wrote to play around with JAM :
}
</i></font><font color="#FF0000"><b>Program </b></font>JAMTest<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>JAM<font color="#000080">, </font>JAMmb<font color="#000080">, </font>JAMcrc32<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>JAMMsg     <font color="#000080">: </font>JAMAPIPTR<font color="#000080">;
  </font>ToUsername <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">100</font><font color="#000080">];
  </font>Position   <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>S          <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>MsgNo      <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>Error      <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>FileLength <font color="#000080">(</font>Handle<font color="#000080">:</font>INTEGER<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Position <font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>Position   <font color="#000080">:= </font>JAMMsg<font color="#000080">^.</font>SeekFile <font color="#000080">(</font>Handle<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>FileLength <font color="#000080">:= </font>JAMMsg<font color="#000080">^.</font>SeekFile <font color="#000080">(</font>Handle<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>JAMMsg<font color="#000080">^.</font>SeekFile <font color="#000080">(</font>Handle<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>Position<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ FileLength }


</i></font><font color="#FF0000"><b>Begin
  </b></font>New <font color="#000080">(</font>JAMMsg<font color="#000080">, </font>Init<font color="#000080">);
  </font>New <font color="#000080">(</font>JAMMsg<font color="#000080">^.</font>WorkBuf<font color="#000080">);
  </font><font color="#FF0000"><b>With </b></font>JAMMsg<font color="#000080">^ </font><font color="#FF0000"><b>Do
  Begin
    If </b></font><font color="#000080">(</font>WorkBuf <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">) </font><font color="#FF0000"><b>Then
    Begin
      </b></font>WorkLen  <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>JAMBUF<font color="#000080">);
      </font>BaseName <font color="#000080">:= </font><font color="#800000">'ANOTHER'</font><font color="#000080">;

      </font>Error <font color="#000080">:= </font><font color="#FF0000"><b>Not </b></font>OpenMB<font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font>Error <font color="#FF0000"><b>Then </b></font>Error <font color="#000080">:= </font><font color="#FF0000"><b>Not </b></font>CreateMB<font color="#000080">;
      </font><font color="#FF0000"><b>If Not </b></font>Error <font color="#FF0000"><b>Then
      Begin
        If </b></font>LockMB<font color="#000080">(</font>True<font color="#000080">) </font><font color="#FF0000"><b>Then
        Begin

          </b></font>MsgNo <font color="#000080">:= (</font>FileLength<font color="#000080">(</font>IdxHandle<font color="#000080">) </font><font color="#FF0000"><b>Div </b></font>SizeOf<font color="#000080">(</font>JAMIDXREC<font color="#000080">)) +
                   </font>HdrInfo<font color="#000080">.</font>BaseMsgNum<font color="#000080">;
          </font>Hdr<font color="#000080">.</font>MsgNum <font color="#000080">:= </font>MsgNo<font color="#000080">;

          </font><font color="#008000"><i>(* Add an index record *)
          </i></font>ToUsername <font color="#000080">:= </font><font color="#800000">'Marco Miltenburg'</font><font color="#000080">;
          </font><font color="#FF0000"><b>With </b></font>Idx <font color="#FF0000"><b>Do
          Begin
            </b></font>S <font color="#000080">:= </font>ToUsername<font color="#000080">;
            </font>LowCaseBuf <font color="#000080">(</font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>Length<font color="#000080">(</font>S<font color="#000080">));
            </font>UserCRC   <font color="#000080">:= </font>crc32<font color="#000080">(</font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>Length<font color="#000080">(</font>S<font color="#000080">), -</font><font color="#800000">1</font><font color="#000080">);
            </font>HdrOffset <font color="#000080">:= </font>FileLength <font color="#000080">(</font>JAMMsg<font color="#000080">^.</font>HdrHandle<font color="#000080">);
          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
          </font>StoreMsgIdx<font color="#000080">(</font>MsgNo<font color="#000080">);

          </font>Position <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
          </font>FillChar <font color="#000080">(</font>Workbuf<font color="#000080">^, </font>SizeOf<font color="#000080">(</font>WorkLen<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);
          </font>S <font color="#000080">:= </font><font color="#800000">'This is a test in JAM.'#13#10</font><font color="#000080">;
          </font>AddField <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>FALSE<font color="#000080">, </font>Length<font color="#000080">(</font>S<font color="#000080">), </font>Position<font color="#000080">, </font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
          </font>S <font color="#000080">:= </font><font color="#800000">'--- WhatEver/386 v0.0'#13#10</font><font color="#000080">;
          </font>AddField <font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>FALSE<font color="#000080">, </font>Length<font color="#000080">(</font>S<font color="#000080">), </font>Position<font color="#000080">, </font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
          </font>Hdr<font color="#000080">.</font>TxtLen <font color="#000080">:= </font>Position <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
          </font>Hdr<font color="#000080">.</font>TxtOffset <font color="#000080">:= </font>FileLength<font color="#000080">(</font>TxtHandle<font color="#000080">);
          </font>StoreMsgTxt<font color="#000080">;

          </font>FillChar <font color="#000080">(</font>Workbuf<font color="#000080">^, </font>SizeOf<font color="#000080">(</font>WorkLen<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);
          </font>S <font color="#000080">:= </font><font color="#800000">'WhatEven/386 v0.0'</font><font color="#000080">; </font>Position <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
          </font>AddField <font color="#000080">(</font><font color="#800000">2</font><font color="#000080">, </font>TRUE<font color="#000080">, </font>Length<font color="#000080">(</font>S<font color="#000080">), </font>Position<font color="#000080">, </font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
          </font>S <font color="#000080">:= </font>ToUserName<font color="#000080">;
          </font>AddField <font color="#000080">(</font><font color="#800000">3</font><font color="#000080">, </font>TRUE<font color="#000080">, </font>Length<font color="#000080">(</font>S<font color="#000080">), </font>Position<font color="#000080">, </font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
          </font>S <font color="#000080">:= </font><font color="#800000">'Just a message'</font><font color="#000080">;
          </font>AddField <font color="#000080">(</font><font color="#800000">6</font><font color="#000080">, </font>TRUE<font color="#000080">, </font>Length<font color="#000080">(</font>S<font color="#000080">), </font>Position<font color="#000080">, </font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
          </font>S <font color="#000080">:= </font><font color="#800000">'WhatEver/386 v0.0'</font><font color="#000080">;
          </font>AddField <font color="#000080">(</font><font color="#800000">7</font><font color="#000080">, </font>TRUE<font color="#000080">, </font>Length<font color="#000080">(</font>S<font color="#000080">), </font>Position<font color="#000080">, </font>S<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);

          </font><font color="#FF0000"><b>With </b></font>Hdr <font color="#FF0000"><b>Do
          Begin
            </b></font>ReservedWord <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>SubfieldLen    <font color="#000080">:= </font>Position<font color="#000080">;
            </font>TimesRead    <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>MsgIdCRC     <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
            </font>ReplyCRC     <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
            </font>ReplyTo      <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>Reply1st     <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>ReplyNext    <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>DateWritten    <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>DateReceived <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>DateProcessed<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>Attribute    <font color="#000080">:= </font>MSG_LOCAL <font color="#FF0000"><b>Or </b></font>MSG_PRIVATE <font color="#FF0000"><b>Or </b></font>MSG_TYPEECHO<font color="#000080">;
            </font>Attribute2   <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font>PasswordCRC  <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
            </font>Cost         <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ With }

          </i></font>StoreMsgHdr<font color="#000080">(</font>MsgNo<font color="#000080">);
          </font>WriteFile<font color="#000080">(</font>HdrHandle<font color="#000080">, </font>WorkBuf<font color="#000080">^, </font>Position<font color="#000080">);

          </font>Inc<font color="#000080">(</font>HdrInfo<font color="#000080">.</font>ActiveMsgs<font color="#000080">);
          </font>UpdHdrInfo<font color="#000080">(</font>True<font color="#000080">);

        </font><font color="#FF0000"><b>End </b></font><font color="#008000"><i>{ If }
        </i></font><font color="#FF0000"><b>Else
          </b></font>WriteLn <font color="#000080">(</font><font color="#800000">'Unable to lock JAM base '''</font><font color="#000080">, </font>BaseName<font color="#000080">,</font><font color="#800000">''''</font><font color="#000080">);

      </font><font color="#FF0000"><b>End </b></font><font color="#008000"><i>{ If }
      </i></font><font color="#FF0000"><b>Else
        </b></font>WriteLn <font color="#000080">(</font><font color="#800000">'Unable to open JAM base '''</font><font color="#000080">, </font>BaseName<font color="#000080">,</font><font color="#800000">''''</font><font color="#000080">);

      </font>Dispose <font color="#000080">(</font>WorkBuf<font color="#000080">);
      </font>Dispose <font color="#000080">(</font>JAMMsg<font color="#000080">);
    </font><font color="#FF0000"><b>End </b></font><font color="#008000"><i>{ If }
    </i></font><font color="#FF0000"><b>Else
      </b></font>WriteLn <font color="#000080">(</font><font color="#800000">'Unable to allocate Work Buffer memory'</font><font color="#000080">);
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ With }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MAIL SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p></body>
</html>
