<html>
<head><title> "Record Locking with Share" by BRAD ZAVITSKY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0088.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
You may be unlocking the records incorrectly, it may be your system, or
it may be bad code (I only found one good proc in AllSwags and that
needed some tweaking to get it to work right).  Here is a program that
has been tested and works fine, I had ~7 copies running at once under
Win95 and it was still pretty fast:

{NOTE: IT generates the dat file if one is not found}

{$M 4000, 0,0}

</i></font><font color="#FF0000"><b>program </b></font>Test<font color="#000080">;

</font><font color="#FF0000"><b>uses </b></font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font><font color="#008000"><i>{File mode def's}
  </i></font>fmReadOnly  <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;
  </font>fmWriteOnly <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">; </font><font color="#008000"><i>{Use one of these}
  </i></font>fmReadWrite <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;

  </font>fmDenyAll   <font color="#000080">= </font><font color="#800000">$10</font><font color="#000080">; </font><font color="#008000"><i>{with one of these}
  </i></font>fmDenyWrite <font color="#000080">= </font><font color="#800000">$20</font><font color="#000080">;
  </font>fmDenyRead  <font color="#000080">= </font><font color="#800000">$30</font><font color="#000080">;
  </font>fmDenyNone  <font color="#000080">= </font><font color="#800000">$40</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>LockAction <font color="#000080">= (</font>Lock<font color="#000080">, </font>Unlock<font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>Err<font color="#000080">: </font>Integer<font color="#000080">;
  </font>Timer<font color="#000080">: </font>Longint <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$6C</font><font color="#000080">;
  </font>Buffer<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4991</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>Data<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">127</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>F<font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>I<font color="#000080">: </font>Integer<font color="#000080">;
  </font>FPos<font color="#000080">: </font>Longint<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ShareIn<font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax, 1000h  </font><font color="#008000"><i>{Test for share}
  </i></font><font color="#FF00FF">int 2fh        </font><font color="#008000"><i>{Call multiplex interrupt}
  </i></font><font color="#FF00FF">cmp al, 0ffh   </font><font color="#008000"><i>{ShareIn = AL=$FF}
  </i></font><font color="#FF00FF">xor al, al     </font><font color="#008000"><i>{Default is false}
  </i></font><font color="#FF00FF">jne @@Done     </font><font color="#008000"><i>{False}
  </i></font><font color="#FF00FF">mov al, 01h    </font><font color="#008000"><i>{True}
</i></font><font color="#FF00FF">@@Done:
  mov ax, 01h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>FLock<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">; </font>Action<font color="#000080">: </font>LockAction<font color="#000080">; </font>FPos<font color="#000080">,</font>Len<font color="#000080">: </font>Longint<font color="#000080">): </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">je @@</font><font color="#FF0000"><b>End
  </b></font>mov al<font color="#000080">, </font>Action  <font color="#008000"><i>{0=Lock,1=Unlock}
  </i></font>mov ah<font color="#000080">, </font><font color="#800000">$5C     </font><font color="#008000"><i>{Dos lock function}
  </i></font>les si<font color="#000080">, </font>F       <font color="#008000"><i>{Load F}
  </i></font>mov bx<font color="#000080">, </font>es<font color="#000080">:[</font>si<font color="#000080">] </font><font color="#008000"><i>{Get file handle}
  </i></font>les dx<font color="#000080">, </font>Fpos
  mov cx<font color="#000080">, </font>es      <font color="#008000"><i>{CX:DI=Begin position}
  </i></font>les di<font color="#000080">, </font>len
  mov si<font color="#000080">, </font>es      <font color="#008000"><i>{SI:DI length lock area}
  </i></font>int <font color="#800000">21</font>h         <font color="#008000"><i>{MS-DOS}
  </i></font>jc <font color="#000080">@@</font><font color="#FF0000"><b>End        </b></font><font color="#008000"><i>{If error, return AX}
  </i></font><font color="#FF0000"><b>xor </b></font>ax<font color="#000080">, </font>ax      <font color="#008000"><i>{Else, return 0}
</i></font><font color="#000080">@@</font><font color="#FF0000"><b>End</b></font><font color="#000080">:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  if not </b></font>ShareIn <font color="#FF0000"><b>then
  begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Either run under Win95 or install SHARE'</font><font color="#000080">);
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{$I-}
  </i></font>assign<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">'Test.dat'</font><font color="#000080">);
  </font>filemode <font color="#000080">:= </font>fmDenyNone <font color="#FF0000"><b>and </b></font>fmReadWrite<font color="#000080">;
  </font>Reset<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">128</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>IOResult <font color="#000080">= </font><font color="#800000">2 </font><font color="#FF0000"><b>then
  begin
    </b></font>FileMode <font color="#000080">:= </font><font color="#800000">$02</font><font color="#000080">;
    </font>Rewrite<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>F<font color="#000080">,</font>Buffer<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Buffer<font color="#000080">));
    </font>Close<font color="#000080">(</font>F<font color="#000080">);
    </font>FileMode <font color="#000080">:= </font>fmDenyNone <font color="#000080">+ </font>fmReadWrite<font color="#000080">;
    </font>Reset<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">128</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>repeat
    </b></font>I <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>while not </b></font>EOf<font color="#000080">(</font>F<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>inc<font color="#000080">(</font>I<font color="#000080">);
    </font>FPos <font color="#000080">:= </font>FilePos<font color="#000080">(</font>F<font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>Err <font color="#000080">:= </font>Flock<font color="#000080">(</font>F<font color="#000080">,</font>Lock<font color="#000080">,</font>FPos<font color="#000080">,</font>FPos<font color="#000080">+</font>SizeOf<font color="#000080">(</font>Data<font color="#000080">));
    </font><font color="#FF0000"><b>until </b></font>Err <font color="#000080">&lt;&gt; </font><font color="#800000">33</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Err <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Error locking!'</font><font color="#000080">);
      </font>Halt<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>BlockRead<font color="#000080">(</font>F<font color="#000080">, </font>Data<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>Flock<font color="#000080">(</font>F<font color="#000080">,</font>unLock<font color="#000080">,</font>FPos<font color="#000080">,</font>FPos<font color="#000080">+</font>SizeOf<font color="#000080">(</font>Data<font color="#000080">));
    </font>Writeln<font color="#000080">(</font>I<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Seek<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>KeyPressed<font color="#000080">;
  </font>Close<font color="#000080">(</font>F<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0088.PAS">Original</a><b>]</b></p></body>
</html>
