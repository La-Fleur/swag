<html>
<head><title> "Self Modify EXE File" by KELD R. HANSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000080">===========================================================================
 </font>BBS<font color="#000080">: </font>Canada Remote Systems
Date<font color="#000080">: </font><font color="#800000">07</font><font color="#000080">-</font><font color="#800000">03</font><font color="#000080">-</font><font color="#800000">93 </font><font color="#000080">(</font><font color="#800000">11</font><font color="#000080">:</font><font color="#800000">56</font><font color="#000080">)             </font>Number<font color="#000080">: </font><font color="#800000">29412
</font>From<font color="#000080">: </font>KELD R<font color="#000080">. </font>HANSEN               Refer<font color="#800000">#</font><font color="#000080">: </font>NONE
  <font color="#FF0000"><b>To</b></font><font color="#000080">: </font>JON JASIUNAS                  Recvd<font color="#000080">: </font>NO  
Subj<font color="#000080">: </font>Re<font color="#000080">: </font>Self<font color="#000080">-</font>modifying <font color="#000080">.</font>EXEs       Conf<font color="#000080">: (</font><font color="#800000">1221</font><font color="#000080">) </font>F<font color="#000080">-</font><font color="#FF0000"><b>PASCAL
</b></font><font color="#000080">---------------------------------------------------------------------------
</font><font color="#FF0000"><b>In </b></font>a <font color="#FF0000"><b>message </b></font>dated <font color="#800000">28 </font>Jun <font color="#800000">93</font><font color="#000080">, </font>Jon Jasiunas <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">:</font><font color="#800000">273</font><font color="#000080">/</font><font color="#800000">216.0</font><font color="#000080">) </font>wrote<font color="#000080">:

 &gt; </font>Here<font color="#800000">'s the code I use for my self-modifying .EXEs.  I'</font>ve used it
 <font color="#000080">&gt; </font>successfully <font color="#FF0000"><b>in </b></font>several applications<font color="#000080">.

</font>It works fine <font color="#000080">(</font>I have one similar <font color="#FF0000"><b>of </b></font>my own<font color="#000080">), </font>but it doesn<font color="#800000">'t take care of DPMI
</font>programs <font color="#FF0000"><b>and </b></font>won<font color="#800000">'t work if your &quot;customer&quot; PKLITEs the program.

</font><font color="#FF0000"><b>TYPE
  </b></font>ExeHeaderDOS          <font color="#000080">= </font><font color="#FF0000"><b>RECORD
                </b></font><font color="#008000"><i>{ 00 }      </i></font>Signature           <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>CHAR<font color="#000080">;
                </font><font color="#008000"><i>{ 02 }      </i></font>LastPageSize        <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 04 }      </i></font>Pages               <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 06 }      </i></font>RelocItems          <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 08 }      </i></font>HeaderSizePara      <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 0A }      </i></font>MinMemPara          <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 0C }      </i></font>MaxMemPara          <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 0E }      </i></font>EntrySS             <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 10 }      </i></font>EntrySP             <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 12 }      </i></font>CheckSum            <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 14 }      </i></font>EntryIP             <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 16 }      </i></font>EntryCS             <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 18 }      </i></font>FirstRelocItemOfs   <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 1A }      </i></font>OverlayNumber       <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>Reserved            <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">$1C</font><font color="#000080">..</font><font color="#800000">$23</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
                </font><font color="#008000"><i>{ 24 }      </i></font>IdentifierOEM       <font color="#000080">: </font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ 26 }      </i></font>InformationOEM      <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>ReservedToo         <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">$28</font><font color="#000080">..</font><font color="#800000">$3B</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
                </font><font color="#008000"><i>{ 3C }      </i></font>NewExeHeaderOfs     <font color="#000080">: </font>LONGINT
                          <font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>ExeHeaderOS2          <font color="#000080">= </font><font color="#FF0000"><b>RECORD
                            </b></font>Signature           <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>CHAR<font color="#000080">;
                            </font>LinkerMajorVers     <font color="#000080">: </font>BYTE<font color="#000080">;
                            </font>LinkerMinorVers     <font color="#000080">: </font>BYTE<font color="#000080">;
                            </font>EntryTableOfs       <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>EntryTableSize      <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>CRC                 <font color="#000080">: </font>LONGINT<font color="#000080">;
                            </font>ModuleFlags         <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>SegmentNoDGROUP     <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>HeapSize            <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>StackSize           <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>EntryIP             <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>EntryCS             <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>EntrySP             <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>EntrySS             <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>SegmentTableEntries <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>ModuleRefEntries    <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>NonResNameTableSize <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>SegTableOfs         <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>ResourceTableOfs    <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>ResNamesTableOfs    <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>ModuleRefTableOfs   <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>ImpNamesTableOfs    <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>NonResNamesTableOfs <font color="#000080">: </font>LONGINT<font color="#000080">;
                            </font>MovableEntryPoints  <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>AlignmentUnitPower  <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>ResourceTableEntries<font color="#000080">: </font>WORD<font color="#000080">;
                            </font>TargetOS            <font color="#000080">: </font>BYTE<font color="#000080">;
                            </font>WindowsFlags        <font color="#000080">: </font>BYTE<font color="#000080">;
                            </font>FastLoadStart       <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>FastLoadSize        <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>Reserved            <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>WindowsVers         <font color="#000080">: </font>WORD
                          <font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>SegTableRec           <font color="#000080">= </font><font color="#FF0000"><b>RECORD
                            </b></font>Start               <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>Size                <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>Flags               <font color="#000080">: </font>WORD<font color="#000080">;
                            </font>MinSize             <font color="#000080">: </font>WORD
                          <font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>FileOffset            <font color="#000080">= </font>LONGINT<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>ReadOnly<font color="#000080">;
  </font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(</font><font color="#800000">$C6</font><font color="#000080">/</font><font color="#800000">$06</font><font color="#000080">/</font>FileMode<font color="#000080">/</font><font color="#800000">$A0</font><font color="#000080">);

</font><font color="#FF0000"><b>PROCEDURE </b></font>ReadWrite<font color="#000080">;
  </font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(</font><font color="#800000">$C6</font><font color="#000080">/</font><font color="#800000">$06</font><font color="#000080">/</font>FileMode<font color="#000080">/</font><font color="#800000">$02</font><font color="#000080">);

</font><font color="#008000"><i>{ ExeOfs returns the offset of the item V in the .EXE file of the currently   }
{ running program. Use this to get the offset of a configuration record that  }
{ is located in the .EXE file (remember that you must declare it as a typed   }
{ constant to include it in the .EXE file)                                    }

{$IFDEF DPMI }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ExeOfs<font color="#000080">(</font><font color="#FF0000"><b>CONST </b></font>V<font color="#000080">) : </font>FileOffset<font color="#000080">;
  </font><font color="#FF0000"><b>VAR
    </b></font>HeaderDOS   <font color="#000080">: </font>ExeHeaderDOS<font color="#000080">;
    </font>HeaderOS2   <font color="#000080">: </font>ExeHeaderOS2<font color="#000080">;
    </font>FIL         <font color="#000080">: </font><font color="#FF0000"><b>FILE</b></font><font color="#000080">;
    </font>CodeSeg<font color="#000080">,</font>Seg <font color="#000080">: </font>WORD<font color="#000080">;
    </font>SegTab      <font color="#000080">: </font>SegTableRec<font color="#000080">;

  </font><font color="#FF0000"><b>BEGIN
    </b></font>ReadOnly<font color="#000080">;
    </font>ASSIGN<font color="#000080">(</font>FIL<font color="#000080">,</font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)); </font>RESET<font color="#000080">(</font>FIL<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>BLOCKREAD<font color="#000080">(</font>FIL<font color="#000080">,</font>HeaderDOS<font color="#000080">,</font>SizeOf<font color="#000080">(</font>ExeHeaderDOS<font color="#000080">));
    </font><font color="#FF0000"><b>IF </b></font>HeaderDOS<font color="#000080">.</font>Signature<font color="#000080">&lt;&gt;</font><font color="#800000">'MZ' </font><font color="#FF0000"><b>THEN
      </b></font>ExeOfs<font color="#000080">:=-</font><font color="#800000">1
    </font><font color="#FF0000"><b>ELSE BEGIN
      </b></font>SEEK<font color="#000080">(</font>FIL<font color="#000080">,</font>HeaderDOS<font color="#000080">.</font>NewExeHeaderOfs<font color="#000080">);
      </font>BLOCKREAD<font color="#000080">(</font>FIL<font color="#000080">,</font>HeaderOS2<font color="#000080">,</font>SizeOf<font color="#000080">(</font>ExeHeaderOS2<font color="#000080">));
      </font><font color="#FF0000"><b>IF </b></font>HeaderOS2<font color="#000080">.</font>Signature<font color="#000080">&lt;&gt;</font><font color="#800000">'NE' </font><font color="#FF0000"><b>THEN
        </b></font>ExeOfs<font color="#000080">:=-</font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE BEGIN
        ASM
                </b></font><font color="#FF00FF">MOV     BX,WORD PTR V+2
                MOV     CX,SS
                CMP     BX,CX
                JE      @STACK
                XOR     AX,AX
                VERW    BX
                JZ      @OUT
                MOV     ES,BX
                MOV     AX,ES:[0000h]
                JMP     @OUT
        @STACK: MOV     AX,HeaderOS2.EntrySS
        @OUT:   MOV     CodeSeg,AX
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>IF </b></font>CodeSeg<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
          </b></font>SEEK<font color="#000080">(</font>FIL<font color="#000080">,</font>HeaderDOS<font color="#000080">.</font>NewExeHeaderOfs<font color="#000080">+</font>HeaderOS2<font color="#000080">.</font>SegTableOfs<font color="#000080">+
            </font>PRED<font color="#000080">(</font>CodeSeg<font color="#000080">)*</font>SizeOf<font color="#000080">(</font>SegTableRec<font color="#000080">));
          </font>BLOCKREAD<font color="#000080">(</font>FIL<font color="#000080">,</font>SegTab<font color="#000080">,</font>SizeOf<font color="#000080">(</font>SegTableRec<font color="#000080">)) </font><font color="#FF0000"><b>END
        ELSE BEGIN
          </b></font>SEEK<font color="#000080">(</font>FIL<font color="#000080">,</font>HeaderDOS<font color="#000080">.</font>NewExeHeaderOfs<font color="#000080">+</font>HeaderOS2<font color="#000080">.</font>SegTableOfs<font color="#000080">);
          </font><font color="#FF0000"><b>FOR </b></font>Seg<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>HeaderOS2<font color="#000080">.</font>SegmentTableEntries <font color="#FF0000"><b>DO BEGIN
            </b></font>BLOCKREAD<font color="#000080">(</font>FIL<font color="#000080">,</font>SegTab<font color="#000080">,</font>SizeOf<font color="#000080">(</font>SegTableRec<font color="#000080">));
            </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>SegTab<font color="#000080">.</font>Start<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>SegTab<font color="#000080">.</font>Flags <font color="#FF0000"><b>AND </b></font><font color="#800000">$0001</font><font color="#000080">=</font><font color="#800000">$0001</font><font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>BREAK
          <font color="#FF0000"><b>END
        END</b></font><font color="#000080">;
        </font>ExeOfs<font color="#000080">:=</font>SegTab<font color="#000080">.</font>Start <font color="#FF0000"><b>SHL </b></font>HeaderOS2<font color="#000080">.</font>AlignmentUnitPower<font color="#000080">+</font>OFS<font color="#000080">(</font>V<font color="#000080">)
      </font><font color="#FF0000"><b>END
    END</b></font><font color="#000080">;
    </font>CLOSE<font color="#000080">(</font>FIL<font color="#000080">);
    </font>ReadWrite
  <font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ExeOfs<font color="#000080">(</font><font color="#FF0000"><b>CONST </b></font>V<font color="#000080">) : </font>FileOffset<font color="#000080">;
  </font><font color="#FF0000"><b>VAR
    </b></font>HeaderDOS   <font color="#000080">: </font>ExeHeaderDOS<font color="#000080">;
    </font>FIL         <font color="#000080">: </font><font color="#FF0000"><b>FILE</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>BEGIN
    </b></font>ReadOnly<font color="#000080">;
    </font>ASSIGN<font color="#000080">(</font>FIL<font color="#000080">,</font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)); </font>RESET<font color="#000080">(</font>FIL<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>BLOCKREAD<font color="#000080">(</font>FIL<font color="#000080">,</font>HeaderDOS<font color="#000080">,</font>SizeOf<font color="#000080">(</font>ExeHeaderDOS<font color="#000080">));
    </font>CLOSE<font color="#000080">(</font>FIL<font color="#000080">);
    </font>ExeOfs<font color="#000080">:=(</font>HeaderDOS<font color="#000080">.</font>HeaderSizePara<font color="#000080">+(</font>SEG<font color="#000080">(</font>V<font color="#000080">)-(</font>PrefixSeg<font color="#000080">+</font><font color="#800000">$0010</font><font color="#000080">)))*</font><font color="#800000">16</font><font color="#000080">+</font>OFS<font color="#000080">(</font>V<font color="#000080">)
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF }
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p></body>
</html>
