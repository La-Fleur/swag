<html>
<head><title> "File and Record Locks" by RONEN MAGID</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0053.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
This is a demonstration of a network unit capable of locking
pascal records or any set of bytes on a file.

Programmer: Ronen Magid, Qiyat-Ono Israel.
Contributed to the SWAG.
}

</i></font><font color="#FF0000"><b>Unit </b></font>Network<font color="#000080">;
</font><font color="#FF0000"><b>Interface
Uses </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Regs       <font color="#000080">: </font>Registers<font color="#000080">;
  </font>RegSize    <font color="#000080">: </font>Byte<font color="#000080">;
  </font>RecSize    <font color="#000080">: </font>Longint<font color="#000080">;
  </font>OffSet     <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>FileHandle <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>Const
 </b></font>SH_COMPAT   <font color="#000080">=  </font><font color="#800000">$0000</font><font color="#000080">;
 </font>SH_DENYRW   <font color="#000080">=  </font><font color="#800000">$0010</font><font color="#000080">;
 </font>SH_DENYWR   <font color="#000080">=  </font><font color="#800000">$0020</font><font color="#000080">;
 </font>SH_DENYRD   <font color="#000080">=  </font><font color="#800000">$0030</font><font color="#000080">;
 </font>SH_DENYNONE <font color="#000080">=        </font><font color="#800000">$0040</font><font color="#000080">;
 </font>SH_DENYNO   <font color="#000080">=  </font>SH_DENYNONE<font color="#000080">;
 </font>O_RDONLY    <font color="#000080">=  </font><font color="#800000">$0</font><font color="#000080">;
 </font>O_WRITE     <font color="#000080">=  </font><font color="#800000">$1</font><font color="#000080">;
 </font>O_RDWR      <font color="#000080">=  </font><font color="#800000">$2</font><font color="#000080">;

</font><font color="#FF0000"><b>function  </b></font>Lock<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Handle<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var  </b></font>Offset<font color="#000080">, </font>BufLen<font color="#000080">: </font>Longint<font color="#000080">): </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>function  </b></font>Unlock<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Handle<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>OffSet<font color="#000080">, </font>BufLen<font color="#000080">: </font>Longint<font color="#000080">): </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

function </b></font>Lock<font color="#000080">(</font><font color="#FF0000"><b>var  </b></font>handle<font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>var  </b></font>offset<font color="#000080">, </font>buflen<font color="#000080">: </font>longint<font color="#000080">): </font>word<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>TempOffset<font color="#000080">:</font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Lock <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>TempOffset<font color="#000080">:=</font><font color="#800000">1000000000</font><font color="#000080">+</font>Offset<font color="#000080">;
  </font>fillchar<font color="#000080">(</font>regs<font color="#000080">, </font>sizeof<font color="#000080">(</font>regs<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$5C</font><font color="#000080">; </font><font color="#008000"><i>{ Lock file access }
  </i></font>regs<font color="#000080">.</font>al <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>bx <font color="#000080">:= </font>handle<font color="#000080">;
  </font>regs<font color="#000080">.</font>cx <font color="#000080">:= </font>TempOffset <font color="#FF0000"><b>shr </b></font>RegSize<font color="#000080">; </font><font color="#008000"><i>{and $ffff;}
  </i></font>regs<font color="#000080">.</font>dx <font color="#000080">:= </font>TempOffset <font color="#FF0000"><b>and </b></font><font color="#800000">$ffff</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>si <font color="#000080">:= </font>buflen <font color="#FF0000"><b>shr </b></font>RegSize<font color="#000080">; </font><font color="#008000"><i>{and $ffff;}
  </i></font>regs<font color="#000080">.</font>di <font color="#000080">:= </font>buflen <font color="#FF0000"><b>and </b></font><font color="#800000">$ffff</font><font color="#000080">;
  </font>MsDos<font color="#000080">(</font>regs<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>regs<font color="#000080">.</font>Flags <font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  </b></font>Lock <font color="#000080">:= </font>regs<font color="#000080">.</font>ax<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Unlock<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>handle<font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>offset<font color="#000080">, </font>buflen<font color="#000080">: </font>longint<font color="#000080">): </font>word<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>TempOffset<font color="#000080">:</font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Unlock <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>TempOffset<font color="#000080">:=</font><font color="#800000">1000000000</font><font color="#000080">+</font>Offset<font color="#000080">;
  </font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$5C</font><font color="#000080">; </font><font color="#008000"><i>{ Unlock file access }
  </i></font>regs<font color="#000080">.</font>al <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>bx <font color="#000080">:= </font>handle<font color="#000080">;
  </font>regs<font color="#000080">.</font>cx <font color="#000080">:= </font>TempOffset <font color="#FF0000"><b>shr </b></font>RegSize<font color="#000080">; </font><font color="#008000"><i>{and $ffff;}
  </i></font>regs<font color="#000080">.</font>dx <font color="#000080">:= </font>TempOffset <font color="#FF0000"><b>and </b></font><font color="#800000">$ffff</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>si <font color="#000080">:= </font>buflen <font color="#FF0000"><b>shr </b></font>RegSize<font color="#000080">; </font><font color="#008000"><i>{and $ffff;}
  </i></font>regs<font color="#000080">.</font>di <font color="#000080">:= </font>buflen <font color="#FF0000"><b>and </b></font><font color="#800000">$ffff</font><font color="#000080">;
  </font>MsDos<font color="#000080">(</font>regs<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>regs<font color="#000080">.</font>Flags <font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  </b></font>Unlock <font color="#000080">:= </font>regs<font color="#000080">.</font>ax<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font><font color="#008000"><i>{ ---------------------     TEST CODE ...   CUT HERE -------------------}

{
This demonstartion will show how to use the NETWORK file-lock
unit to allow lock and lock-check of records in a regular
pascal database file.

Programmer: Ronen Magid, Qiyat-Ono Israel.
Contributed to the SWAG.
}

</i></font><font color="#FF0000"><b>Program </b></font>NetTest<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>Dos<font color="#000080">,</font>Network<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>PhoneRecord <font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>Name    <font color="#000080">:  </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">30</font><font color="#000080">];
    </font>Address <font color="#000080">:  </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">35</font><font color="#000080">];
    </font>Phone   <font color="#000080">:  </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">15</font><font color="#000080">];
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>PhoneRec   <font color="#000080">: </font>PhoneRecord<font color="#000080">;
  </font>PhoneFile  <font color="#000080">: </font><font color="#FF0000"><b>File of </b></font>PhoneRecord<font color="#000080">;
  </font>FileHandle <font color="#000080">: </font>word<font color="#000080">;
  </font>LockStatus <font color="#000080">: </font>Word<font color="#000080">;
  </font>I          <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Ok         <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>LockPhoneRec<font color="#000080">(</font>which<font color="#000080">: </font>LongInt<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>recsize <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>PhoneRec<font color="#000080">);
  </font>OffSet <font color="#000080">:=  </font>RecSize <font color="#000080">* </font>Which <font color="#000080">- </font>Recsize<font color="#000080">;
  </font>FileHandle <font color="#000080">:= </font>FileRec<font color="#000080">(</font>PhoneFile<font color="#000080">).</font>handle<font color="#000080">;
  </font>LockStatus <font color="#000080">:= </font>Lock<font color="#000080">(</font>FileHandle<font color="#000080">, </font>offset<font color="#000080">, </font>recsize<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>LockStatus <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>LockPhoneRec<font color="#000080">:=</font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end else
  begin
    </b></font>LockPhoneRec<font color="#000080">:=</font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>UnLockPhoneRec<font color="#000080">(</font>Which<font color="#000080">: </font>Byte<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>ok<font color="#000080">:   </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>recsize <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>PhoneRec<font color="#000080">);
  </font>OffSet <font color="#000080">:= </font>Which <font color="#000080">* </font>RecSize <font color="#000080">- </font>RecSize<font color="#000080">;
  </font>FileHandle <font color="#000080">:= </font>FileRec<font color="#000080">(</font>PhoneFile<font color="#000080">).</font>handle<font color="#000080">;
  </font>LockStatus <font color="#000080">:= </font>Unlock<font color="#000080">(</font>FileHandle<font color="#000080">, </font>offset<font color="#000080">, </font>recsize<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>LockStatus <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>UnlockPhoneRec <font color="#000080">:= </font>false<font color="#000080">;
  </font><font color="#FF0000"><b>end else
  begin
    </b></font>UnlockPhoneRec <font color="#000080">:= </font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>Phonefile<font color="#000080">,</font><font color="#800000">'PHONE.SMP'</font><font color="#000080">);
  </font>Rewrite<font color="#000080">(</font>Phonefile<font color="#000080">);
  </font><font color="#FF0000"><b>For </b></font>I<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">5 </font><font color="#FF0000"><b>do </b></font>Write<font color="#000080">(</font>Phonefile<font color="#000080">,</font>phoneRec<font color="#000080">);
  </font>Close<font color="#000080">(</font>Phonefile<font color="#000080">);

  </font>FileMode <font color="#000080">:= </font>SH_DENYNO <font color="#000080">+ </font>O_RDWR<font color="#000080">;    </font><font color="#008000"><i>{Important, Before RESET!}
  </i></font>Reset<font color="#000080">(</font>Phonefile<font color="#000080">);

  </font><font color="#008000"><i>{ And now lets begin to lock... }

  </i></font>Ok<font color="#000080">:=</font>LockPhoneRec<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#008000"><i>{Locking phone rec 2}

  {Now lets see if its locked... }

  </i></font>Ok<font color="#000080">:=</font>LockPhoneRec<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#008000"><i>{a record is already locked if we
   cant lock it. This locking procedure
   can be performed by other PCs &amp; other
   tasks.}

  </i></font><font color="#FF0000"><b>If Not </b></font>Ok <font color="#FF0000"><b>then </b></font>writeln<font color="#000080">(</font><font color="#800000">'#2 locked'</font><font color="#000080">);

  </font>Ok<font color="#000080">:=</font>UnlockPhoneRec<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#008000"><i>{ lets release it. This will enable
    other tasks or LAN PCs to lock
    (&amp; obtain) this record again...}

  </i></font><font color="#FF0000"><b>If </b></font>Ok <font color="#FF0000"><b>then </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Rec #2 unlocked'</font><font color="#000080">);

  </font><font color="#008000"><i>{thats it...}
  </i></font>Ok<font color="#000080">:=</font>LockPhoneRec<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>Ok <font color="#FF0000"><b>then </b></font>Writeln<font color="#000080">(</font><font color="#800000">'And since its free we can relock it !'</font><font color="#000080">);
  </font>Close<font color="#000080">(</font>phoneFile<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0053.PAS">Original</a><b>]</b></p></body>
</html>
