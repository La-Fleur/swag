<html>
<head><title> "Faster File Exists" by SEAN PALMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
SEAN PALMER

I just ran some timings, which are gonna be affected by SMARTDRV.EXE
being loaded, but I took that into account (ran multiple times on same
file, and took timings on second/subsequent runs, to make sure always
got cache hits)

What I got was that FileExists below and my modified version of that
fileExist3 function that's been floating around this echo for a while
(no bug) both run neck and neck... it's amazing... both are slightly
faster than FileExist2 and lots lots faster than the 'reset,
fileExist=(ioresult=0)' type thing that most people still seem to use...

I'd recommend using the first one below as it's really short...
}

</i></font><font color="#FF0000"><b>uses
  </b></font>dos<font color="#000080">;

</font><font color="#008000"><i>{ Tied for fastest }
</i></font><font color="#FF0000"><b>function </b></font>fileExists<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>fileExists <font color="#000080">:= </font>fSearch<font color="#000080">(</font>s<font color="#000080">, </font><font color="#800000">''</font><font color="#000080">) &lt;&gt; </font><font color="#800000">''</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ 2nd }
</i></font><font color="#FF0000"><b>function </b></font>fileExist2<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>r <font color="#000080">: </font>searchrec<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>findfirst<font color="#000080">(</font>s<font color="#000080">, </font>anyfile<font color="#000080">, </font>r<font color="#000080">);
  </font>fileExist2 <font color="#000080">:= (</font>dosError <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Tied for fastest }
</i></font><font color="#FF0000"><b>function </b></font>fileExist3<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
  lds  si, s        </font><font color="#008000"><i>{ need to make ASCIIZ }
  </i></font><font color="#FF00FF">cld
  lodsb             </font><font color="#008000"><i>{ get length; si now points to first char }
  </i></font><font color="#FF00FF">xor  ah, ah
  mov  bx, ax
  mov  al, [si+bx]  </font><font color="#008000"><i>{ save byte before placing terminating null }
  </i></font><font color="#FF00FF">push ax
  mov  byte ptr [si+bx],0
  mov  dx, si
  mov  ax, $4300    </font><font color="#008000"><i>{ get file attributes }
  </i></font><font color="#FF00FF">int  $21
  mov  al, 1        </font><font color="#008000"><i>{ if carry set, fail }
  </i></font><font color="#FF00FF">pop  dx
  mov  [si+bx], dl  </font><font color="#008000"><i>{ restore byte }
  </i></font><font color="#FF00FF">pop  ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Slowest }
</i></font><font color="#FF0000"><b>function </b></font>fileExist4<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>f <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>assign<font color="#000080">(</font>f<font color="#000080">,</font>s<font color="#000080">);
  </font><font color="#008000"><i>{$I-}
  </i></font>reset<font color="#000080">(</font>f<font color="#000080">);
  </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>if </b></font>ioresult <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>close<font color="#000080">(</font>f<font color="#000080">);
    </font>fileExist4 <font color="#000080">:= </font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else
    </b></font>fileExist4 <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p></body>
</html>
