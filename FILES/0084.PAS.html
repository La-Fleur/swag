<html>
<head><title> "Get File Size in ASM" by PETER LOUWEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0084.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 GH&gt; Here is what my Waite's group book says word for word, and I haven't
 GH&gt; an idea on how to do this.
 GH&gt; &quot;23H   Filesize. Prior to invoking this function, DS:DX is set to
 GH&gt; point to the segment: offset address of an unopened file control
 GH&gt; block(FCB).&quot;
 GH&gt; Now there is my problem, I need to know how to do the DS:DX thing to
 GH&gt; place a file name in it, so I can check that _certain_ file for its
 GH&gt; size.
 GH&gt; If anyone knows how to do this, could you lend a hand.

Refrain from using the old-style file access methods, i.e, those using
FCB's. Not only are they &quot;frowned upon&quot; by Microsoft, worse: they can
only work with files located in the current directory.
Use the file handle methods instead.
}

   </i></font><font color="#FF0000"><b>PROGRAM </b></font>The_Size_Of_Files<font color="#000080">;

   </font><font color="#FF0000"><b>USES </b></font>dos<font color="#000080">;

   </font><font color="#008000"><i>{ -- Both functions below wil return the size of a file. In case of an
     -- error, the return value is -1.
     -- Note that their parameters are of different types. }

   </i></font><font color="#FF0000"><b>FUNCTION </b></font>Size_of_file<font color="#000080">(</font><font color="#FF0000"><b>CONST </b></font>fn<font color="#000080">: </font>PathStr<font color="#000080">): </font>longint<font color="#000080">;
   </font><font color="#FF0000"><b>VAR </b></font>SR<font color="#000080">: </font>SearchRec<font color="#000080">;
   </font><font color="#FF0000"><b>BEGIN </b></font>findfirst<font color="#000080">(</font>fn<font color="#000080">, </font>AnyFile <font color="#000080">- </font>VolumeID <font color="#000080">- </font>Directory<font color="#000080">, </font>SR<font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>DosError <font color="#000080">= </font><font color="#800000">0
         </font><font color="#FF0000"><b>THEN </b></font>Size_of_file<font color="#000080">:=</font>SR<font color="#000080">.</font>Size
         <font color="#FF0000"><b>ELSE </b></font>Size_of_file<font color="#000080">:=-</font><font color="#800000">1
              </font><font color="#008000"><i>{ -- Or some other clearly nonsensical value. }
   </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>FUNCTION </b></font>AsmFilesize<font color="#000080">(</font><font color="#FF0000"><b>CONST </b></font>F<font color="#000080">): </font>longint<font color="#000080">;
   </font><font color="#008000"><i>{ -- F MUST be a Text or File-variable. }
   </i></font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
   </font><font color="#008000"><i>{ --  LSEEK &Auml;&Auml; Move file read/write pointer (Func 42)

     -- INT 21 - DOS 2+
     --    AH = 42h
     --    AL = method
     --       00h offset from beginning of file
     --       01h offset from present location
     --       02h offset from end of file
     --   BX = file handle
     --   CX:DX = offset in bytes

     -- Return: CF set on error
     --       AX = error code (01h,06h) (see AH=59h)
     --         CF clear if successful
     --       DX:AX = new absolute offset from beginning of file }
   </i></font><font color="#FF0000"><b>ASM </b></font><font color="#FF00FF">mov ah, $42
       mov al, 2

       les di, F         </font><font color="#008000"><i>{ -- Now ES:DI holds the address of F. }
       </i></font><font color="#FF00FF">mov bx, es:[di]   </font><font color="#008000"><i>{ -- BX now holds the filehandle of F; look up
                           -- types Dos.TextRec and Dos.FileRec for an
                           -- explanation. }

       </i></font><font color="#FF00FF">xor cx, cx
       xor dx, dx        </font><font color="#008000"><i>{ -- CX and DX are now both zero. }

                         { -- In effect, the file pointer is to be moved
                           -- to the end of the file. }

       </i></font><font color="#FF00FF">int $21
       jnc @@Exit        </font><font color="#008000"><i>{ -- Did we succeed ? }

       </i></font><font color="#FF00FF">mov dx, $FFFF     </font><font color="#008000"><i>{ -- NO: so make the functionresult (a Longint is }
       </i></font><font color="#FF00FF">mov ax, $FFFF     </font><font color="#008000"><i>{ --     returned in DX:AX) = -1.                 }

   </i></font><font color="#FF00FF">@@Exit:               </font><font color="#008000"><i>{ -- YES: quit without further ado. }
   </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

   </font><font color="#008000"><i>{ -- Main: }

   </i></font><font color="#FF0000"><b>VAR </b></font>fn<font color="#000080">: </font>PathStr<font color="#000080">;
       </font>F <font color="#000080">: </font><font color="#FF0000"><b>FILE</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>BEGIN </b></font>write<font color="#000080">(</font><font color="#800000">'PLease enter filename: '</font><font color="#000080">); </font>readln<font color="#000080">(</font>fn<font color="#000080">);
         </font>assign<font color="#000080">(</font>F<font color="#000080">, </font>fn<font color="#000080">); </font><font color="#008000"><i>{$I-} </i></font>reset<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{$I+}
         </i></font><font color="#FF0000"><b>IF </b></font>IOresult <font color="#000080">&lt;&gt; </font><font color="#800000">0
         </font><font color="#FF0000"><b>THEN BEGIN </b></font>writeln<font color="#000080">(</font><font color="#800000">#7'No such file ...'</font><font color="#000080">); </font>halt<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

         </font>writeln<font color="#000080">(</font><font color="#800000">'FileSize : '</font><font color="#000080">, </font>FileSize<font color="#000080">(</font>F<font color="#000080">));
         </font>writeln<font color="#000080">(</font><font color="#800000">'FindFirst: '</font><font color="#000080">, </font>Size_of_file<font color="#000080">(</font>fn<font color="#000080">));
         </font>writeln<font color="#000080">(</font><font color="#800000">'LSeek    : '</font><font color="#000080">, </font>AsmFilesize<font color="#000080">(</font>F<font color="#000080">))
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font>Perhaps it would be interesting <font color="#FF0000"><b>to </b></font>see which method <font color="#FF0000"><b>is </b></font>fastest<font color="#000080">.

</font>The ONLY situation <font color="#FF0000"><b>in </b></font>which you absolutely must use FCBs <font color="#FF0000"><b>is </b></font>setting the
volume <font color="#FF0000"><b>label on </b></font>a disk<font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0084.PAS">Original</a><b>]</b></p></body>
</html>
