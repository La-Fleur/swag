<html>
<head><title> "Erase File ABSOLUTE" by ERIK APPELDOORN & JAN DOGGEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0068.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Erik Appeldoorn

I've made a programm which erases a file absolutely and completely. Even when
it is undeleted it containes nothing.. So far so good.. But when I make a
sector-dump of the disk, it appears that there is still some text on the disk.
I don't get it. Nowhere in my programm I allocated text to memory, but the same
three sentences apear four times in the sector-dump. In the original file the
sentences begin at sentence number 1103. In the sector-dump the four blocks
appear at numbers 72 &amp; 130 &amp; 188 &amp; 248. The totall dump is 251 sentences.
The floppy was newly formatted. What could be happening? Here's part of the
code.
}

</i></font><font color="#FF0000"><b>var </b></font>ZapFile<font color="#000080">:</font><font color="#FF0000"><b>File</b></font><font color="#000080">;
    </font>ZapFileName<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font>ZapFilePos<font color="#000080">:</font>Longint<font color="#000080">;
    </font>Buffer<font color="#000080">:</font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">406</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>NumWritten<font color="#000080">, </font>BufferSize<font color="#000080">, </font>NumRead<font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>deleting<font color="#000080">(</font>ZapFileName<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>begin
    </b></font>Buffersize<font color="#000080">:=</font>SizeOf<font color="#000080">(</font>Buffer<font color="#000080">);
    </font>Assign<font color="#000080">(</font>ZapFile<font color="#000080">,</font>ZapFileName<font color="#000080">);
    </font><font color="#008000"><i>{$I-}
    </i></font>Reset<font color="#000080">(</font>ZapFile<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#008000"><i>{$I+}
    </i></font><font color="#FF0000"><b>repeat
        </b></font>ZapFilePos<font color="#000080">:=</font>FilePos<font color="#000080">(</font>ZapFile<font color="#000080">);
        </font>BlockRead<font color="#000080">(</font>ZapFile<font color="#000080">,</font>Buffer<font color="#000080">,</font>BufferSize<font color="#000080">,</font>NumRead<font color="#000080">);
        </font>FillChar<font color="#000080">(</font>Buffer<font color="#000080">,</font>BufferSize<font color="#000080">,</font><font color="#800000">#255</font><font color="#000080">);
        </font>Seek<font color="#000080">(</font>ZapFile<font color="#000080">,</font>ZapFilePos<font color="#000080">);
        </font>BlockWrite<font color="#000080">(</font>ZapFile<font color="#000080">,</font>Buffer<font color="#000080">,</font>NumRead<font color="#000080">,</font>NumWritten<font color="#000080">);
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>NumRead<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>NumWritten<font color="#000080">&lt;&gt;</font>NumRead<font color="#000080">);
    </font>close<font color="#000080">(</font>ZapFile<font color="#000080">);
    </font>Erase<font color="#000080">(</font>ZapFile<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{
Jan Doggen

I only had time to take a quick look; here are my suggestions:
- forget the reads
- make a CONST buffer, fill it with garbage or zeroes
  (*in* the proc, so that it takes only stack space)
- FS := FileSize(ZapFile)
  NrBlocks := FS DIV BufferSize
  LastBlockSize := FS MOD BufferSize
  For i:=1 to nrblocks blockwrite
  If lastblocksize&lt;&gt;0 write that amount (never mind that the buffer is
  larger)
  close the file
- forget the $I. You don't query IOResult after $I, so all subsequent
  I/O (on *all* files) goes wrong until you do. RTM.
- Instaed of this, use a FileExist function before you call your
  proc.
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0068.PAS">Original</a><b>]</b></p></body>
</html>
