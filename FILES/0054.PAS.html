<html>
<head><title> "Buffered Fileread" by MARTIN ISREALSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>(************************************************************************)
(*                                                                      *)
(*  Program ex. to      : &quot;Tips &amp; Tricks in Turbo Pascal&quot;, SysTime 1993 *)
(*                                                                      *)
(*  By                  : Martin Israelsen                              *)
(*                                                                      *)
(*  Title               : BUFFER.PAS                                    *)
(*                                                                      *)
(*  Chapter             : 5                                             *)
(*                                                                      *)
(*  Description         : Quicker than Turbo fileread                   *)
(*                                                                      *)
(************************************************************************)
(*$I-*)  (* Iocheck off         *)
(*$F+*)  (* Force FAR call      *)
(*$V-*)  (* Relaxed VAR check   *)
(*$R-*)  (* Range check off     *)
(*$S-*)  (* Stack check off     *)
(*$Q-*)  (* Overflow off        *)
(*$D-*)  (* Debug off           *)
(*$L-*)  (* Linenumber off      *)

</i></font><font color="#FF0000"><b>Unit
  </b></font>Buffer<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Type

  </b></font>PByte     <font color="#000080">= ^</font>Byte<font color="#000080">;
  </font>PWord     <font color="#000080">= ^</font>Word<font color="#000080">;
  </font>PLong     <font color="#000080">= ^</font>Longint<font color="#000080">;

  </font>PByteArr  <font color="#000080">= ^</font>TByteArr<font color="#000080">;
  </font>TByteArr  <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">64000</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte<font color="#000080">;
  </font>PfStr     <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">100</font><font color="#000080">];

  </font>PBuffer       <font color="#000080">= ^</font>TBuffer<font color="#000080">;
  </font>TBuffer       <font color="#000080">= </font><font color="#FF0000"><b>Record
                     </b></font>BufFil   <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
                     </font>BufPtr   <font color="#000080">: </font>PByteArr<font color="#000080">;

                     </font>BufSize<font color="#000080">,
                     </font>BufIndex<font color="#000080">,
                     </font>BufUsed  <font color="#000080">: </font>Word<font color="#000080">;

                     </font>BufFPos<font color="#000080">,
                     </font>BufFSize <font color="#000080">: </font>Longint<font color="#000080">;
                  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>BufferInit<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Br<font color="#000080">: </font>PBuffer<font color="#000080">; </font>MemSize<font color="#000080">: </font>Word<font color="#000080">;
                      </font>FilName<font color="#000080">: </font>PfStr<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>BufferClose<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Br<font color="#000080">: </font>PBuffer<font color="#000080">);

</font><font color="#FF0000"><b>Function  </b></font>BufferGetByte<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>BufferGetByteAsm<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>BufferGetWord<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>BufferGetBlock<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>ToAdr<font color="#000080">; </font>BlockSize<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>BufferGetStringAsm<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>BufferEof<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

</b></font><font color="#008000"><i>(*$I-,F+*)

</i></font><font color="#FF0000"><b>Function </b></font>BufferInit<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Br<font color="#000080">: </font>PBuffer<font color="#000080">; </font>MemSize<font color="#000080">: </font>Word<font color="#000080">;
                    </font>FilName<font color="#000080">: </font>PfStr<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>BufferInit<font color="#000080">:=</font>False<font color="#000080">;

   </font><font color="#008000"><i>(* Check if there's enough memory               *)

   </i></font><font color="#FF0000"><b>If </b></font>MemSize<font color="#000080">&lt;</font><font color="#800000">500 </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
   </font><font color="#FF0000"><b>If </b></font>MaxAvail<font color="#000080">&lt;</font>Sizeof<font color="#000080">(</font>TBuffer<font color="#000080">)+</font>MemSize<font color="#000080">+</font><font color="#800000">32 </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;

   </font>New<font color="#000080">(</font>Br<font color="#000080">);

   </font><font color="#FF0000"><b>With </b></font>BR<font color="#000080">^ </font><font color="#FF0000"><b>Do
   Begin
      </b></font>BufSize<font color="#000080">:=</font>MemSize<font color="#000080">; </font>BufIndex<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">; </font>BufFPos<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;

      </font><font color="#008000"><i>(* Open the filen. Exit if there's an error *)

      </i></font>Assign<font color="#000080">(</font>BufFil<font color="#000080">,</font>Filname<font color="#000080">); </font>Reset<font color="#000080">(</font>BufFil<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);

      </font><font color="#FF0000"><b>If </b></font>IoResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Then
      Begin
         </b></font>Dispose<font color="#000080">(</font>Br<font color="#000080">);
         </font>Exit<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

      </font><font color="#008000"><i>(* Ok, the file is there, and there's enough *)
      (* memory. So allocate the memory and read   *)
      (* as much as possible                       *)

      </i></font>GetMem<font color="#000080">(</font>BufPtr<font color="#000080">,</font>BufSize<font color="#000080">);
      </font>BlockRead<font color="#000080">(</font>BufFil<font color="#000080">,</font>BufPtr<font color="#000080">^,</font>BufSize<font color="#000080">,</font>BufUsed<font color="#000080">);

      </font>BufFSize<font color="#000080">:=</font>FileSize<font color="#000080">(</font>BufFil<font color="#000080">); </font>Inc<font color="#000080">(</font>BufFPos<font color="#000080">,</font>BufUsed<font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

   </font>BufferInit<font color="#000080">:=</font>True<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>BufferClose<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Br<font color="#000080">: </font>PBuffer<font color="#000080">);
</font><font color="#FF0000"><b>Begin
   With </b></font>Br<font color="#000080">^ </font><font color="#FF0000"><b>Do
   Begin
      </b></font>Close<font color="#000080">(</font>BufFil<font color="#000080">);
      </font>Freemem<font color="#000080">(</font>BufPtr<font color="#000080">,</font>BufSize<font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

   </font>Dispose<font color="#000080">(</font>Br<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>BufferCheck<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">; </font>ReqBytes<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Var
   </b></font>W<font color="#000080">,</font>Rest<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   With </b></font>Br<font color="#000080">^ </font><font color="#FF0000"><b>Do
   Begin
      If </b></font><font color="#000080">(</font>BufIndex<font color="#000080">+</font>ReqBytes<font color="#000080">&gt;</font>BufUsed<font color="#000080">) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>BufUsed<font color="#000080">=</font>BufSize<font color="#000080">) </font><font color="#FF0000"><b>Then
      Begin
         </b></font>Rest<font color="#000080">:=</font>Succ<font color="#000080">(</font>BufSize<font color="#000080">-</font>BufIndex<font color="#000080">);

         </font>Move<font color="#000080">(</font>BufPtr<font color="#000080">^[</font>BufIndex<font color="#000080">],</font>BufPtr<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">],</font>Rest<font color="#000080">);
         </font>BufIndex<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;

         </font>BlockRead<font color="#000080">(</font>BufFil<font color="#000080">,</font>BufPtr<font color="#000080">^[</font>Succ<font color="#000080">(</font>Rest<font color="#000080">)],</font>BufSize<font color="#000080">-</font>Rest<font color="#000080">,</font>W<font color="#000080">);
         </font>BufUsed<font color="#000080">:=</font>Rest<font color="#000080">+</font>W<font color="#000080">; </font>Inc<font color="#000080">(</font>BufFPos<font color="#000080">,</font>W<font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>BufferGetByte<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   With </b></font>Br<font color="#000080">^ </font><font color="#FF0000"><b>Do
   Begin
      </b></font>BufferCheck<font color="#000080">(</font>Br<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);

      </font>BufferGetByte<font color="#000080">:=</font>BufPtr<font color="#000080">^[</font>BufIndex<font color="#000080">];
      </font>Inc<font color="#000080">(</font>BufIndex<font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>BufferGetByteAsm<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">Les   Di,Br                              </font><font color="#008000"><i>(* ES:DI -&gt;  BRecPtr         *)

   </i></font><font color="#FF00FF">Mov   Ax,Es:[Di.TBuffer.BufIndex]        </font><font color="#008000"><i>(* Check wheather the buffer should be updated *)
   </i></font><font color="#FF00FF">Cmp   Ax,Es:[Di.TBuffer.BufUsed]
   Jle   @@NoBufCheck                       </font><font color="#008000"><i>(* If not jump on            *)

   </i></font><font color="#FF00FF">Push  Word Ptr Br[2]                     </font><font color="#008000"><i>(* Push BR to BufferCheck   *)
   </i></font><font color="#FF00FF">Push  Word Ptr Br
   Mov   Ax,0001                            </font><font color="#008000"><i>(* Check for one byte           *)
   </i></font><font color="#FF00FF">Push  Ax                                 </font><font color="#008000"><i>(* Push it                      *)
   </i></font><font color="#FF00FF">Push  CS                                 </font><font color="#008000"><i>(* Push CS, and make a          *)
   </i></font><font color="#FF00FF">Call  Near Ptr BufferCheck               </font><font color="#008000"><i>(* NEAR call - it's quicker     *)

   </i></font><font color="#FF00FF">Les   Di,Br                              </font><font color="#008000"><i>(* ES:DI-&gt; BRecPtr              *)

 </i></font><font color="#FF00FF">@@NoBufCheck:

   Mov   Bx,Es:[Di.TBuffer.BufIndex]        </font><font color="#008000"><i>(* BufferIndex in BX            *)
   </i></font><font color="#FF00FF">Inc   Es:[Di.TBuffer.BufIndex]           </font><font color="#008000"><i>(* Inc BufferIndex directly     *)
   </i></font><font color="#FF00FF">Les   Di,Es:[Di.TBuffer.BufPtr]          </font><font color="#008000"><i>(* ES:DI -&gt; BufPtr              *)

   </i></font><font color="#FF00FF">Xor   Ax,Ax                              </font><font color="#008000"><i>(* Now get the byte             *)
   </i></font><font color="#FF00FF">Mov   Al,Byte Ptr Es:[Di+Bx-1]
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>BufferGetWord<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   With </b></font>Br<font color="#000080">^ </font><font color="#FF0000"><b>Do
   Begin
      </b></font>BufferCheck<font color="#000080">(</font>Br<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);

      </font>BufferGetWord<font color="#000080">:=</font>PWord<font color="#000080">(@</font>BufPtr<font color="#000080">^[</font>BufIndex<font color="#000080">])^;
      </font>Inc<font color="#000080">(</font>BufIndex<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>BufferGetBlock<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>ToAdr<font color="#000080">; </font>BlockSize<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Begin
   With </b></font>Br<font color="#000080">^ </font><font color="#FF0000"><b>Do
   Begin
      </b></font>BufferCheck<font color="#000080">(</font>Br<font color="#000080">,</font>BlockSize<font color="#000080">);

      </font>Move<font color="#000080">(</font>BufPtr<font color="#000080">^[</font>BufIndex<font color="#000080">],</font>ToAdr<font color="#000080">,</font>BlockSize<font color="#000080">);
      </font>Inc<font color="#000080">(</font>BufIndex<font color="#000080">,</font>BlockSize<font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>BufferGetStringAsm<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">Push   Ds

   Les    Di,Br                        </font><font color="#008000"><i>(* es:di -&gt; Br *)
   </i></font><font color="#FF00FF">Mov    Bx,Es:[Di.TBuffer.BufUsed]   </font><font color="#008000"><i>(* check for buffercheck *)
   </i></font><font color="#FF00FF">Sub    Bx,Es:[Di.TBuffer.BufIndex]
   Cmp    Bx,257
   Jae    @NoBufCheck                  </font><font color="#008000"><i>(* Jump on if not        *)

   </i></font><font color="#FF00FF">Push   Word Ptr Br[2]
   Push   Word Ptr Br

   Mov    Ax,257
   Push   Ax

   Push   Cs
   Call   Near Ptr BufferCheck

   Les    Di,Br

 @NoBufCheck:

   Mov    Bx,Es:[Di.TBuffer.BufIndex]  </font><font color="#008000"><i>(* Get index in buffer     *)
   </i></font><font color="#FF00FF">Dec    Bx                           </font><font color="#008000"><i>(* Adjust for 0            *)

   </i></font><font color="#FF00FF">Les    Di,Es:[Di.TBuffer.BufPtr]    </font><font color="#008000"><i>(* Point to the buffer     *)
   </i></font><font color="#FF00FF">Add    Di,Bx                        </font><font color="#008000"><i>(* Add Index               *)
   </i></font><font color="#FF00FF">Push   Di                           </font><font color="#008000"><i>(* Save currect position   *)

   </i></font><font color="#FF00FF">Mov    Al,$0a                       </font><font color="#008000"><i>(* Search for CR = 0ah     *)
   </i></font><font color="#FF00FF">Mov    Cx,$ff                       </font><font color="#008000"><i>(* max. 255 chars          *)

   </i></font><font color="#FF00FF">Cld                                 </font><font color="#008000"><i>(* Remember                *)
   </i></font><font color="#FF00FF">RepNz  Scasb                        </font><font color="#008000"><i>(* and do the search       *)
   </i></font><font color="#FF00FF">Jz     @Fundet                      </font><font color="#008000"><i>(* Jump if we found one    *)

   </i></font><font color="#FF00FF">Mov    Cx,0                         </font><font color="#008000"><i>(* Otherwise set length to 0  *)
 </i></font><font color="#FF00FF">@Fundet:
   Sub    Cx,$ff                       </font><font color="#008000"><i>(* Which will be recalculated *)
   </i></font><font color="#FF00FF">Neg    Cx                           </font><font color="#008000"><i>(* to nomal length            *)
   </i></font><font color="#FF00FF">Dec    Cx                           </font><font color="#008000"><i>(* Dec, to avoid CR           *)

   </i></font><font color="#FF00FF">Push   Es                           </font><font color="#008000"><i>(* DS:SI-&gt;Buffer              *)
   </i></font><font color="#FF00FF">Pop    Ds
   Pop    Si

   Les    Di,@Result                   </font><font color="#008000"><i>(* ES:DI-&gt;result string        *)
   </i></font><font color="#FF00FF">Mov    Ax,Cx

   Stosb                               </font><font color="#008000"><i>(* Set length                  *)

   </i></font><font color="#FF00FF">Shr    Cx,1                         </font><font color="#008000"><i>(* Copy the string             *)
   </i></font><font color="#FF00FF">Rep    MovSw
   Adc    Cx,Cx
   Rep    MovSb

   Pop    Ds                           </font><font color="#008000"><i>(* Restore DS                  *)

   </i></font><font color="#FF00FF">Les    Di,Br                        </font><font color="#008000"><i>(* ES:DI-&gt;Br                   *)
   </i></font><font color="#FF00FF">Inc    Ax                           </font><font color="#008000"><i>(* Inc Ax, point to LF         *)

   </i></font><font color="#FF00FF">Add    Es:[Di.TBuffer.BufIndex],Ax  </font><font color="#008000"><i>(* and set BufferIndex         *)
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>BufferEof<font color="#000080">(</font>Br<font color="#000080">: </font>PBuffer<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   With </b></font>Br<font color="#000080">^ </font><font color="#FF0000"><b>Do
   </b></font>BufferEof<font color="#000080">:=(</font>BufIndex<font color="#000080">&gt;</font>BufUsed<font color="#000080">) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>BufFPos<font color="#000080">=</font>BufFSize<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p></body>
</html>
