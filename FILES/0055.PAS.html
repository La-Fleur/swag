<html>
<head><title> "Remove Records from File" by RAPHAEL VANNEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0055.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{ The following procedure physically removes record(s) from any file,
  then truncate the file. I use it to shrink log files and to remove
  index entries from Squish .SQI files, but many other uses may be found.  }

{ Donated to the public domain by Rapha‰l Vanney.                          }

</i></font><font color="#FF0000"><b>Uses </b></font>DOS <font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>DeleteRecs<font color="#000080">(    </font><font color="#FF0000"><b>Var </b></font>AFile <font color="#000080">;
                         </font>From      <font color="#000080">: </font>LongInt <font color="#000080">;
                         </font>Count     <font color="#000080">: </font>LongInt <font color="#000080">;
                         </font>BufSize   <font color="#000080">: </font>Word<font color="#000080">) : </font>Integer <font color="#000080">;

</font><font color="#008000"><i>{ AFile   : any typed or untyped file (not Text), must be opened           }
{ From    : number of 1st record to delete, 0-based                        }
{ Count   : number of record(s) to delete                                  }
{ BufSize : size of the buffer to allocate. Must be &gt; record size          }

</i></font><font color="#FF0000"><b>Var  </b></font>Buffer    <font color="#000080">: </font>Pointer <font color="#000080">;              </font><font color="#008000"><i>{ pointer to buffer                }
     </i></font>Src       <font color="#000080">: </font>LongInt <font color="#000080">;              </font><font color="#008000"><i>{ source record pointer            }
     </i></font>Cnt       <font color="#000080">: </font>LongInt <font color="#000080">;              </font><font color="#008000"><i>{ scratch                          }
     </i></font>Last      <font color="#000080">: </font>LongInt <font color="#000080">;              </font><font color="#008000"><i>{ last record to move              }
     </i></font>f         <font color="#000080">: </font><font color="#FF0000"><b>File Absolute </b></font>AFile <font color="#000080">;  </font><font color="#008000"><i>{ file we're going to work on      }
     </i></font>Err       <font color="#000080">: </font>Integer <font color="#000080">;              </font><font color="#008000"><i>{ error code                       }

</i></font><font color="#FF0000"><b>Label
     </b></font>Sortie <font color="#000080">;

</font><font color="#FF0000"><b>Begin
     </b></font>Last<font color="#000080">:=</font>FileSize<font color="#000080">(</font>f<font color="#000080">) ;
     </font>Src<font color="#000080">:=</font>From<font color="#000080">+</font>Count <font color="#000080">;
     </font><font color="#FF0000"><b>If </b></font>Count<font color="#000080">&gt;(</font>Last<font color="#000080">-</font>From<font color="#000080">) </font><font color="#FF0000"><b>Then </b></font>Count<font color="#000080">:=</font>Last<font color="#000080">-</font>From <font color="#000080">;

     </font><font color="#008000"><i>{ check BufSize against FileRec(f).RecSize }
     </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>BufSize<font color="#000080">&lt;</font>FileRec<font color="#000080">(</font>f<font color="#000080">).</font>RecSize<font color="#000080">) </font><font color="#FF0000"><b>Or
        </b></font><font color="#000080">(</font>MaxAvail<font color="#000080">&lt;</font>BufSize<font color="#000080">) </font><font color="#FF0000"><b>Then
     Begin
          </b></font>DeleteRecs<font color="#000080">:=</font><font color="#800000">1 </font><font color="#000080">; </font><font color="#008000"><i>{ error }
          </i></font>Exit <font color="#000080">;
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;

     </font>GetMem<font color="#000080">(</font>Buffer<font color="#000080">, </font>BufSize<font color="#000080">) ;

     </font><font color="#FF0000"><b>While </b></font>Src<font color="#000080">&lt;</font>Last <font color="#FF0000"><b>Do
     Begin
          </b></font>Cnt<font color="#000080">:=</font>BufSize <font color="#FF0000"><b>Div </b></font>FileRec<font color="#000080">(</font>f<font color="#000080">).</font>RecSize <font color="#000080">;
          </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>Src<font color="#000080">+</font>Cnt<font color="#000080">)&gt;</font>Last <font color="#FF0000"><b>Then </b></font>Cnt<font color="#000080">:=</font>Last<font color="#000080">-</font>Src <font color="#000080">;
          </font>Seek<font color="#000080">(</font>f<font color="#000080">, </font>Src<font color="#000080">) ;
          </font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>Buffer<font color="#000080">^, </font>Cnt<font color="#000080">) ;
          </font><font color="#008000"><i>{ error check }
          </i></font>Err<font color="#000080">:=</font>IOResult <font color="#000080">;
          </font><font color="#FF0000"><b>If </b></font>Err<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Then GoTo </b></font>Sortie <font color="#000080">;
          </font>Seek<font color="#000080">(</font>f<font color="#000080">, </font>From<font color="#000080">) ;
          </font>BlockWrite<font color="#000080">(</font>f<font color="#000080">, </font>Buffer<font color="#000080">^, </font>Cnt<font color="#000080">) ;
          </font><font color="#008000"><i>{ error check }
          </i></font>Err<font color="#000080">:=</font>IOResult <font color="#000080">;
          </font><font color="#FF0000"><b>If </b></font>Err<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Then GoTo </b></font>Sortie <font color="#000080">;
          </font>Inc<font color="#000080">(</font>Src<font color="#000080">, </font>Cnt<font color="#000080">) ;
          </font>Inc<font color="#000080">(</font>From<font color="#000080">, </font>Cnt<font color="#000080">) ;
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;

     </font>Seek<font color="#000080">(</font>f<font color="#000080">, </font>Last<font color="#000080">-</font>Count<font color="#000080">) ;
     </font>Truncate<font color="#000080">(</font>f<font color="#000080">) ;
</font>Sortie<font color="#000080">:
     </font>DeleteRecs<font color="#000080">:=</font>Err <font color="#000080">;
     </font>FreeMem<font color="#000080">(</font>Buffer<font color="#000080">, </font>BufSize<font color="#000080">) ;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
END</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FILES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0055.PAS">Original</a><b>]</b></p></body>
</html>
