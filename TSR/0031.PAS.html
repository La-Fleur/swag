<html>
<head><title> "Trapping Control C/Break/Alt-Del" by JOSE CAMPIONE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0031.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I am looking for some source code that will trap Control-Alt-Del,
&gt; Control-C, and Control-Break, prefered if it can be loaded into
&gt; the Config.sys, but autoexec.bat would work also.

  The compiled code can be loaded from the DOS prompt or
  from any batch. To avoid the message just redirect output
  to the nul device:

     breaknot &gt; nul
}

{$F+}  {Far procedures...}
{$M 2048,0,0}

</i></font><font color="#FF0000"><b>Program </b></font>BreakNot<font color="#000080">;
</font><font color="#008000"><i>{---------------------------------------------------------------}
{ This TSR code intercepts hardware interrupt $9 and checks for }
{ Ctrl-C, Ctrl-Break and Ctrl-Alt-Del. If none of these key     }
{ combinations has been pressed the preceeding Int 9 is chained,}
{ otherwise, the keyboard is reset without calling the previous }
{ keyboard vector. Interrupt vectors $1B and $23 are not        }
{ redirected. Rebooting is the only way to unload the TSR and   }
{ re-enable breaks.                                             }
{ Note: usual disclaimers apply: use at own risk, etc...        }
{ - Copyright (c) 1994 Jose Campione 1:163/513.3 -              }
{---------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Uses </b></font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>KbdStat<font color="#000080">: </font>byte <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0000</font><font color="#000080">:</font><font color="#800000">$0417</font><font color="#000080">;
  </font>KbdPort<font color="#000080">: </font>byte<font color="#000080">;
  </font>OldKBD <font color="#000080">: </font>pointer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>JmpOldISR<font color="#000080">(</font>OldISR<font color="#000080">: </font>pointer<font color="#000080">);
</font><font color="#008000"><i>{ ------------------------------------------------}
{ Standard Inline code to Jump from an ISR to the }
{ vector being passed. Origin: an old Critical    }
{ Interrupt handler. Note: Merely rewriting this  }
{ inline code as an Assembler procedure will not  }
{ work -Jose-                                     }
{-------------------------------------------------}
  </i></font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$5B</font><font color="#000080">/</font><font color="#800000">$58</font><font color="#000080">/</font><font color="#800000">$87</font><font color="#000080">/</font><font color="#800000">$5E</font><font color="#000080">/</font><font color="#800000">$0E</font><font color="#000080">/</font><font color="#800000">$87</font><font color="#000080">/</font><font color="#800000">$46</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">/</font><font color="#800000">$89</font><font color="#000080">/
         </font><font color="#800000">$EC</font><font color="#000080">/</font><font color="#800000">$5D</font><font color="#000080">/</font><font color="#800000">$07</font><font color="#000080">/</font><font color="#800000">$1F</font><font color="#000080">/</font><font color="#800000">$5F</font><font color="#000080">/</font><font color="#800000">$5E</font><font color="#000080">/</font><font color="#800000">$5A</font><font color="#000080">/</font><font color="#800000">$59</font><font color="#000080">/</font><font color="#800000">$CB</font><font color="#000080">);

</font><font color="#FF0000"><b>procedure </b></font>ResetKbd<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------------------------------------}
{ Standard code to reset the keyboard   }
{ Origin: N. Rubenking's book on TP 6.0 }
{---------------------------------------}
</i></font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">in     AL,$61     </font><font color="#008000"><i>{read keyboard controller}
  </i></font><font color="#FF00FF">mov    AH, AL
  or     AL,$80     </font><font color="#008000"><i>{set the &quot;reset bit&quot;}
  </i></font><font color="#FF00FF">out   $61, AL     </font><font color="#008000"><i>{send it out}
  </i></font><font color="#FF00FF">xchg   AH, AL     </font><font color="#008000"><i>{get original value}
  </i></font><font color="#FF00FF">out   $61, AL     </font><font color="#008000"><i>{send it out}
  </i></font><font color="#FF00FF">cli               </font><font color="#008000"><i>{disable interrupts}
  </i></font><font color="#FF00FF">mov    AL,$20     </font><font color="#008000"><i>{EOI, end-of-interrupt signal}
  </i></font><font color="#FF00FF">out   $20, AL     </font><font color="#008000"><i>{send EOI to programmable interrupt controller}
  </i></font><font color="#FF00FF">sti               </font><font color="#008000"><i>{enable interrupts}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Key_ISR<font color="#000080">; </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>KbdPort<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>KbdPort<font color="#000080">:= </font>port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">];
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(((</font>KbdStat <font color="#FF0000"><b>and  </b></font><font color="#800000">4</font><font color="#000080">) =  </font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>KbdPort <font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">46</font><font color="#000080">,</font><font color="#800000">70</font><font color="#000080">])) </font><font color="#FF0000"><b>or
     </b></font><font color="#000080">(((</font>KbdStat <font color="#FF0000"><b>and </b></font><font color="#800000">12</font><font color="#000080">) = </font><font color="#800000">12</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>KbdPort <font color="#000080">= </font><font color="#800000">83</font><font color="#000080">)) </font><font color="#FF0000"><b>then
    </b></font>ResetKbd             <font color="#008000"><i>{reset Kbd w/o chaining int 9}
  </i></font><font color="#FF0000"><b>else
  </b></font>JmpOldISR<font color="#000080">( </font>OldKBD <font color="#000080">);   </font><font color="#008000"><i>{jump to Old Keyboard handler }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
 </b></font>writeln<font color="#000080">(</font><font color="#800000">' BreakNot! Copyright (c) 1994, J.Campione'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">' Ctrl-C, Ctrl-Break and Ctrl-Alt-Del are now disabled'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">' To re-enable breaks, reset or restart the computer'</font><font color="#000080">);
 </font>GetIntVec<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">,</font>OldKBD<font color="#000080">);
 </font>SetIntVec<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">,@</font>Key_ISR<font color="#000080">);
 </font>Keep<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0031.PAS">Original</a><b>]</b></p></body>
</html>
