<html>
<head><title> "Tsr's in 1K!" by MATTHEW TAGG</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
I love it when people actually post there hard slaved code. I've
seen a number of people wanting to write tsr's, and all the examples
in BP that I've ever come across are pathetic and above 6K of mem!
So for those serious here is some flexible and easy to use code.
Drowning in comments ;-) It's extremely efficient on memory (1040)
bytes! I  can write it in pascal using 550 bytes put then I decided
to make it user friendly to a degree ;-) Shout if you need to know
more info on tsr writing eg. making it be polite to dos etc ;-))
Cheers.
Matt
}

{$A-}{$R-}{$S-}{$D-}{$F-}{$L-}{$Q-}{$T-}{$V-}{$X-}{$Y-}{$G+}
{$B-}{$N-}{$P-}
{$M 1024,0,0}
(* Ulti-Tsr-Demo-Proggie Coded: Matthew Tagg Jan '95                    *)

(* The beauty of this is that your init code, eg paramter parsing etc.  *)
(* does NOT effect the size in memory! Unlike crappy BP's attemp at a   *)
(* tsr! Another beautiful thing is that for you who hate the technical  *)
(* stuff can let the program work out what to keep in memory!           *)
(* USES *)                          (* There is no USES, so don't       *)
                                    (* use units, they suck. Use include*)
                                    (* files if you want but units      *)
                                    (* create new segments AARG         *)
                                    (* NOT for tsr's!                   *)
</i></font><font color="#FF0000"><b>Const
   </b></font>CharSEG  <font color="#000080">= </font><font color="#800000">$B800</font><font color="#000080">;                </font><font color="#008000"><i>(* $B800 = COLOUR or $B000 for Mono *)
   </i></font>DSegSize <font color="#000080">= </font><font color="#800000">128</font><font color="#000080">;                  </font><font color="#008000"><i>(* Data Segment Size                *)
   </i></font>SSegSize <font color="#000080">= </font><font color="#800000">256</font><font color="#000080">;                  </font><font color="#008000"><i>(* Stack Segmetn Size               *)
   </i></font>SSize    <font color="#000080">= </font>SSegSize<font color="#000080">-</font><font color="#800000">16</font><font color="#000080">;          </font><font color="#008000"><i>(* This is the value of the Stack   *)
                                    (* pointer (sp) and bp              *)
   </i></font>DSegOff  <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;                    </font><font color="#008000"><i>(* This is added to the value copied*)
                                    (* from cs and written to ds ie DS  *)
                                    (* points to 32 bytes ahead of CS   *)
                                    (* I do this so that that pointers  *)
                                    (* Are not overriden                *)
   </i></font>DatOffs  <font color="#000080">= </font>DSegOff<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">;           </font><font color="#008000"><i>(* Offset relocation number         *)
                                    (* Use this to reference your data  *)
                                    (* ie. say you want to move the var *)
                                    (* NUM int the ax &gt;                 *)
                                    (*   mov ax, CS:datoffs+NUM         *)
                                    (*           ^^^ Must use segment   *)
                                    (* override! OR easier to set       *)
                                    (*  DS = CS+DSegoff   default=2     *)
                                    (* When in a pascal routine you can *)
                                    (* reference it normally            *)

   </i></font>CodeOffs <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">;                   </font><font color="#008000"><i>(* Were OUR Code/Data starts, first *)
                                    (* 16 bytes of the int09 proc are   *)
                                    (* used for pushing stuff but we    *)
                                    (* don't need that crap!            *)

                                    (* PS Typed Constants use up memory *)
                                    (* They just another name for       *)
                                    (* initialised data.                *)
                                    (* Untyped are the same as EQU in   *)
                                    (* asm.  Untyped = No memory        *)

   </i></font>PSize <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;                       </font><font color="#008000"><i>(* The amount of bytes used by the  *)
                                    (* Pointers                         *)
   </i></font>NewSSegLoc <font color="#000080">= (</font>CodeOffs<font color="#000080">+</font>PSize<font color="#000080">+</font>DsegSize<font color="#000080">+</font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">16</font><font color="#000080">;
                                    </font><font color="#008000"><i>(* This says were the stack must    *)
                                    (* start (+16 so no code is over-   *)
                                    (* ridden)                          *)
</i></font><font color="#FF0000"><b>Var
</b></font><font color="#008000"><i>(* VARIABLES TO BE USED IN THE ACTUAL TSR                               *)
   </i></font>Bob            <font color="#000080">: </font>Byte<font color="#000080">;           </font><font color="#008000"><i>(* Just test variables              *)
   </i></font>Obo            <font color="#000080">: </font>Word<font color="#000080">;           </font><font color="#008000"><i>(* Used by the i.s.r (you can use   *)
                                    (* your own)      `                 *)

   </i></font>EndData        <font color="#000080">: </font>Word<font color="#000080">;           </font><font color="#008000"><i>(* Insert all data to be saved,     *)
                                    (* ie data use in the i.s.r,        *)
                                    (* BEFORE this statement all init   *)
                                    (* data can come after  Saves Mem!  *)

(* VARIABLES TO BE USED IN THE INIT PART                                *)
   </i></font>ProgSize       <font color="#000080">: </font>Word<font color="#000080">;           </font><font color="#008000"><i>(* Memory required in 16 byte       *)
                                    (* Paragraphs                       *)

   </i></font>ThisDoes       <font color="#000080">: </font>Byte<font color="#000080">;           </font><font color="#008000"><i>(* Eg....                           *)
   </i></font>NotGetSaved    <font color="#000080">: </font>Char<font color="#000080">;
   </font>ButCanBe       <font color="#000080">: </font>Pointer<font color="#000080">;
   </font>UsedInThe      <font color="#000080">: </font>Longint<font color="#000080">;
   </font>InitCode       <font color="#000080">: </font>PChar<font color="#000080">;

   </font>LastVar        <font color="#000080">: </font>Word<font color="#000080">;           </font><font color="#008000"><i>(* WARNING DO NOT CHANGE THIS       *)
                                    (* Do Not Insert Any Variable After *)
{$F+}
</i></font><font color="#FF0000"><b>Procedure </b></font>Int09<font color="#000080">; </font>Interrupt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">Dw 0,0                              </font><font color="#008000"><i>(* Pointers 4*2 bytes = 8     *)
   </i></font><font color="#FF00FF">Dw 0,0
</font><font color="#008000"><i>(* Data Seg (8*16=128bytes Not Bad) *) (* Bp7 Chews up the first 80  *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0  </font><font color="#008000"><i>(* bytes for whatever AAARG   *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0  </font><font color="#008000"><i>(* Change the size according  *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0  </font><font color="#008000"><i>(* to the amount of data your *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0  </font><font color="#008000"><i>(* prog uses                  *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
</font><font color="#008000"><i>(* Stack Seg (8*16=128*)            (* Temp Stack                 *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 </font><font color="#008000"><i>(* You can make the stack size    *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 </font><font color="#008000"><i>(* whatever you want, but remember*)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 </font><font color="#008000"><i>(* to change the const SSize,     *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 </font><font color="#008000"><i>(* Default=256                    *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
</font><font color="#008000"><i>(* Stack Seg (8*16+8*16=256) *)     (* Temp Stack                       *)
   </i></font><font color="#FF00FF">Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
   Db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

   Nop                              </font><font color="#008000"><i>(* Used for to ensure safety        *)
   </i></font><font color="#FF00FF">Sti                              </font><font color="#008000"><i>(* Interupts allowed                *)

   </i></font><font color="#FF00FF">Pushf                            </font><font color="#008000"><i>(* Pushf simulates and interrupt    *)
   </i></font><font color="#FF00FF">Call Dword Ptr CS:[CodeOffs]     </font><font color="#008000"><i>(* Calls the saved INT8             *)

   </i></font><font color="#FF00FF">Inc   CS:DatOffs+Bob             </font><font color="#008000"><i>(* Has a second passed? If not exit *)
   </i></font><font color="#FF00FF">Cmp   CS:DatOffs+Bob,18          </font><font color="#008000"><i>(* else call our interrupt WRT      *)
   </i></font><font color="#FF00FF">Jne @Finnish

   Mov   Cs:DatOffs+Bob,0           </font><font color="#008000"><i>(* Rests it for the next time       *)
   </i></font><font color="#FF00FF">Inc   Cs:DatOffs+Obo             </font><font color="#008000"><i>(* Obo is the number we write to the*)
                                    (* screen.                          *)
   </i></font><font color="#FF00FF">Pushf
   Call Dword Ptr Far [CS:Codeoffs+4]; </font><font color="#008000"><i>(* Call our routine              *)
   </i></font><font color="#FF00FF">Sti
@Finnish:
   iret
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>(* You can delete this procedure (for demo purposes only)               *)
</i></font><font color="#FF0000"><b>Procedure </b></font>PWord<font color="#000080">(</font>Num<font color="#000080">,</font>Pos<font color="#000080">,</font>Base<font color="#000080">:</font>Word<font color="#000080">); </font><font color="#008000"><i>(* Proc. to write a number in any   *)
                                    (* base                             *)
</i></font><font color="#FF0000"><b>Const
   </b></font>AlphaNum <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">35</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">=

(</font><font color="#800000">48</font><font color="#000080">,</font><font color="#800000">49</font><font color="#000080">,</font><font color="#800000">50</font><font color="#000080">,</font><font color="#800000">51</font><font color="#000080">,</font><font color="#800000">52</font><font color="#000080">,</font><font color="#800000">53</font><font color="#000080">,</font><font color="#800000">54</font><font color="#000080">,</font><font color="#800000">55</font><font color="#000080">,</font><font color="#800000">56</font><font color="#000080">,</font><font color="#800000">57</font><font color="#000080">,</font><font color="#800000">65</font><font color="#000080">,</font><font color="#800000">66</font><font color="#000080">,</font><font color="#800000">67</font><font color="#000080">,</font><font color="#800000">68</font><font color="#000080">,</font><font color="#800000">69</font><font color="#000080">,</font><font color="#800000">70</font><font color="#000080">,</font><font color="#800000">71</font><font color="#000080">,</font><font color="#800000">72</font><font color="#000080">,</font><font color="#800000">73</font><font color="#000080">,</font><font color="#800000">74</font><font color="#000080">,</font><font color="#800000">75</font><font color="#000080">,</font><font color="#800000">76</font><font color="#000080">,</font><font color="#800000">77</font><font color="#000080">,</font><font color="#800000">78</font><font color="#000080">,</font><font color="#800000">79</font><font color="#000080">,</font><font color="#800000">80</font><font color="#000080">,
</font><font color="#800000">81</font><font color="#000080">,</font><font color="#800000">82</font><font color="#000080">,</font><font color="#800000">83</font><font color="#000080">,</font><font color="#800000">84</font><font color="#000080">,</font><font color="#800000">85</font><font color="#000080">,</font><font color="#800000">86</font><font color="#000080">,</font><font color="#800000">87</font><font color="#000080">,</font><font color="#800000">88</font><font color="#000080">,</font><font color="#800000">89</font><font color="#000080">,</font><font color="#800000">90</font><font color="#000080">);</font><font color="#FF0000"><b>Begin   Asm
      </b></font><font color="#FF00FF">Push  CharSEG                 </font><font color="#008000"><i>(* Set ES to our text segment addr  *)
      </i></font><font color="#FF00FF">Pop   Es                      </font><font color="#008000"><i>(* Text Graphics segment            *)
      </i></font><font color="#FF00FF">Mov   Ax, Num                 </font><font color="#008000"><i>(* Ax to be divided                 *)
   </i></font><font color="#FF00FF">@l1:
      Xor   Dx, Dx                  </font><font color="#008000"><i>(* Clear                            *)
      </i></font><font color="#FF00FF">Div   Base                    </font><font color="#008000"><i>(* Dx = Remainder, Ax = Quotient    *)
      </i></font><font color="#FF00FF">Cmp   Dx,0                    </font><font color="#008000"><i>(* Remainder                        *)
      </i></font><font color="#FF00FF">Jnz   @l2                     </font><font color="#008000"><i>(* Finnished?                       *)
      </i></font><font color="#FF00FF">Cmp   Ax,0                    </font><font color="#008000"><i>(* Quotient                         *)
      </i></font><font color="#FF00FF">Jz    @Fin
   @l2:
      Mov   Si, Dx
      Mov   Di, Pos                 </font><font color="#008000"><i>(* Load offs                        *)
      </i></font><font color="#FF00FF">Mov   Dl, Byte Ptr [AlphaNum+Si]
      Mov   [Es:Di], Dl
      Sub   Pos,2                   </font><font color="#008000"><i>(* Inc bx by 2                      *)
      </i></font><font color="#FF00FF">Jmp   @l1
@Fin:
      Pop   Pos                     </font><font color="#008000"><i>(* Maintain stack                   *)
   </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Wrt<font color="#000080">;</font>Interrupt<font color="#000080">; </font><font color="#008000"><i>(* This Is Our Interrupt Service Routine       *)
</i></font><font color="#FF0000"><b>Begin
   Asm
      </b></font><font color="#FF00FF">Mov   Ax, Cs                  </font><font color="#008000"><i>(* ALWAYS include these three       *)
      </i></font><font color="#FF00FF">Add   Ax, DSegOff             </font><font color="#008000"><i>(* instructions if you want to use  *)
      </i></font><font color="#FF00FF">Mov   Ds, Ax                  </font><font color="#008000"><i>(* your pascal declared variables.  *)
   </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
   </font><font color="#008000"><i>(* DO WHAT YOU WANT HERE                                             *)
   </i></font>PWord<font color="#000080">(</font>Obo<font color="#000080">,</font><font color="#800000">158</font><font color="#000080">,</font><font color="#800000">10</font><font color="#000080">);               </font><font color="#008000"><i>(* Write a number in the top left   *)
                                    (* hand column, demo purposes only! *)
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}{ &lt;-----------------------------
                                    |                                   }
(* Init Procedures follow, note the {$f-} means these are now local     *)
(* BTW if you make your own init procedures make sure you place them    *)
(* after the Getvec or you can place them before the getvec but then    *)
(* change the line further down that needs the name of the first init   *)
(* procedure to your own name (currently the first init proc is GetVec  *)

</i></font><font color="#FF0000"><b>Procedure </b></font>GetVec<font color="#000080">(</font>VecNo <font color="#000080">:</font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>SavPoint <font color="#000080">:</font>Pointer<font color="#000080">); </font><font color="#008000"><i>(* DOS Sucks      *)
</i></font><font color="#FF0000"><b>Var
   </b></font>SavSeg<font color="#000080">, </font>SavOff <font color="#000080">:</font>Word<font color="#000080">;            </font><font color="#008000"><i>(* Temp variables for pointer       *)
</i></font><font color="#FF0000"><b>Begin
   Asm
      </b></font><font color="#FF00FF">Push  Es                      </font><font color="#008000"><i>(* Save Es                          *)
      </i></font><font color="#FF00FF">Shl   VecNo, 2                </font><font color="#008000"><i>(* Multiply num by 4 to get address *)
      </i></font><font color="#FF00FF">Mov   Es, Word Ptr 0h         </font><font color="#008000"><i>(* Zero Es. Vect Int's start at 0:0 *)
      </i></font><font color="#FF00FF">Mov   Di, VecNo               </font><font color="#008000"><i>(* Di = Num * 4                     *)
      </i></font><font color="#FF00FF">Mov   Ax, Word Ptr [Es:Di]    </font><font color="#008000"><i>(* Copy offset word of int,         *)
      </i></font><font color="#FF00FF">Mov   SavOff, Ax              </font><font color="#008000"><i>(* and save it                      *)
      </i></font><font color="#FF00FF">Add   Di, 2                   </font><font color="#008000"><i>(* Point to next word (segment)     *)
      </i></font><font color="#FF00FF">Mov   Ax, Word Ptr [Es:Di]    </font><font color="#008000"><i>(* Ax = Offset                      *)
      </i></font><font color="#FF00FF">Mov   SavSeg, Ax              </font><font color="#008000"><i>(* Save in temporary variable       *)
      </i></font><font color="#FF00FF">Pop   Es                      </font><font color="#008000"><i>(* Retrieved stored value           *)
   </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
   </font>SavPoint <font color="#000080">:= </font>Ptr<font color="#000080">(</font>SavSeg<font color="#000080">, </font>SavOff<font color="#000080">); </font><font color="#008000"><i>(* Convert Seg:Offset to pointer    *)
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetVec<font color="#000080">(</font>VecNo <font color="#000080">:</font>Word<font color="#000080">; </font>NewPoint <font color="#000080">:</font>Pointer<font color="#000080">);  </font><font color="#008000"><i>(* Don't use units   *)
</i></font><font color="#FF0000"><b>Type                                </b></font><font color="#008000"><i>(* Revectors the interrupts         *)
   </i></font>PType          <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
   </b></font>NtPoint        <font color="#000080">: ^</font>PType<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   Asm </b></font><font color="#FF00FF">Cli </font><font color="#FF0000"><b>End</b></font><font color="#000080">;                     </font><font color="#008000"><i>(* No interrupts can be generated   *)
   </i></font>NtPoint <font color="#000080">:= @</font>NewPoint<font color="#000080">;            </font><font color="#008000"><i>(* during the process               *)
   </i></font>MemW<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">:</font>VecNo<font color="#000080">*</font><font color="#800000">4</font><font color="#000080">] := </font>NtPoint<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">];
   </font>MemW<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">:</font>VecNo<font color="#000080">*</font><font color="#800000">4</font><font color="#000080">+</font><font color="#800000">2</font><font color="#000080">] := </font>NtPoint<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">];
   </font><font color="#FF0000"><b>Asm </b></font><font color="#FF00FF">Sti </font><font color="#FF0000"><b>End</b></font><font color="#000080">;                     </font><font color="#008000"><i>(* Enable Interrupts                *)
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
   If </b></font><font color="#000080">(</font>Ofs<font color="#000080">(</font>Int09<font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Then </b></font>Halt<font color="#000080">;  </font><font color="#008000"><i>(* Used to ensure the proc is       *)
                                    (* included                         *)
                                    (* If pascal doesn't see a reference*)
                                    (* to a proc. or var. it excludes   *)
                                    (* it!                              *)

   </i></font>EndData <font color="#000080">:= </font>Ofs<font color="#000080">(</font>EndData<font color="#000080">);         </font><font color="#008000"><i>(* Basicly finds the size of the    *)
                                    (* DS to be kept in memory          *)
   </i></font>GetVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">, </font>Pointer<font color="#000080">(</font>MemL<font color="#000080">[</font>Cseg<font color="#000080">:</font>CodeOffs<font color="#000080">]));
                                    </font><font color="#008000"><i>(* Vector 8 is the timer interrupt  *)
                                    (* generated every 18.2 times a sec *)
   </i></font>SetVec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">, </font>Ptr<font color="#000080">(</font>Cseg<font color="#000080">, </font>CodeOffs<font color="#000080">+</font>PSize<font color="#000080">+</font>DSegSize<font color="#000080">+</font>SSegSize<font color="#000080">));
   </font><font color="#008000"><i>(*                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^            *)
                                    (* This is where the CODE actually  *)
                                    (* starts in the code segment       *)
   </i></font>MemW<font color="#000080">[</font>Cseg<font color="#000080">:</font>Codeoffs<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">] := </font>Ofs<font color="#000080">( </font>WRT <font color="#000080">);
   </font>MemW<font color="#000080">[</font>Cseg<font color="#000080">:</font>Codeoffs<font color="#000080">+</font><font color="#800000">6</font><font color="#000080">] := </font>Seg<font color="#000080">( </font>WRt <font color="#000080">);
   </font><font color="#008000"><i>(*           -----------------^^^                                    *)
   (* Substitute your own i.s.r routine name over here, if you want     *)

   (* This next stuff copies the data we defined and places it in       *)
   (* our new data segment                                              *)
   </i></font><font color="#FF0000"><b>Asm
      </b></font><font color="#FF00FF">Mov   Ax, Cs                  </font><font color="#008000"><i>(* Seeing as you can't say          *)
      </i></font><font color="#FF00FF">Add   Ax, DSegOff             </font><font color="#008000"><i>(* Mov Es, Cs ..this is a way round *)
      </i></font><font color="#FF00FF">Mov   Es, Ax                  </font><font color="#008000"><i>(* Inc Ax, so no code overriden ;)  *)
      </i></font><font color="#FF00FF">Xor   Di, Di                  </font><font color="#008000"><i>(* Di = 0                           *)
      </i></font><font color="#FF00FF">Xor   Si, Si                  </font><font color="#008000"><i>(* Si = 0                           *)
      </i></font><font color="#FF00FF">Mov   Cx, EndData             </font><font color="#008000"><i>(* # of bytes to copy               *)
      </i></font><font color="#FF00FF">Rep   Movsb                   </font><font color="#008000"><i>(* ... and copy it                  *)
   </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

   </font><font color="#008000"><i>(* What I am actually doing is having all three segments in the code *)
   (* segment, risky if you don't be careful but worth the space (g)    *)
   </i></font><font color="#FF0000"><b>Asm
      </b></font><font color="#FF00FF">Mov   Ax, Cs                  </font><font color="#008000"><i>(* Get the current Code Seg         *)
      </i></font><font color="#FF00FF">Add   Ax, NewSSegLoc          </font><font color="#008000"><i>(* Add the New Stack Segment Locat  *)
      </i></font><font color="#FF00FF">Mov   Ss, Ax                  </font><font color="#008000"><i>(* Adjust SS                        *)
      </i></font><font color="#FF00FF">Mov   Sp, SSize               </font><font color="#008000"><i>(* The stack pointer, is SSegSize-16*)
      </i></font><font color="#FF00FF">Mov   Bp, SSize               </font><font color="#008000"><i>(*   (-16) to allow for segment     *)
                                    (* alignment.                       *)
      </i></font><font color="#FF00FF">Push  Bp
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

   </font><font color="#008000"><i>(* This allocates the amount of memory to be used in 16 byte         *)
   (* paragraphs. The variable progsize is the memory used by our prog. *)
   (* @GetVec is the FIRST of the init procdures so it gets that address*)
   (* and uses it as the size of our code, it adds 256 because of the   *)
   (* PSP (Program Segment Prefix) and then divides by 16 to get        *)
   (* paragraphs and adds on 1 more to to be safe.                      *)
   </i></font>ProgSize <font color="#000080">:= (</font>Ofs<font color="#000080">(</font>GetVec<font color="#000080">)+</font><font color="#800000">256</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">16 </font><font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>Asm                              </b></font><font color="#008000"><i>(* Uses dos int 31.. *KEEP*         *)
      </i></font><font color="#FF00FF">Mov   Dx, ProgSize
      Mov   Al, 0                   </font><font color="#008000"><i>(* Return code ei ERRORLEVEL        *)
      </i></font><font color="#FF00FF">Mov   Ah, 31h                 </font><font color="#008000"><i>(* Dos Func 31h                     *)
      </i></font><font color="#FF00FF">Int   21h
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p></body>
</html>
