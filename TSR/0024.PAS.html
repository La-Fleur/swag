<html>
<head><title> "Listing TSR's" by ALEX KARIPIDIS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Well, here it is, a program that lists TSRs loaded.
Anybody willing to enhance it so that it checks the HMA for TSRs too?

Oh, were do I send this so that it gets into the next SWAGS release?  I was
unable to find such a program in the all the SWAGS until (and inclusive) the
latest February '94 release...

{ ------------ Cut Here ----------- }

</i></font><font color="#FF0000"><b>Program </b></font>ListTSRs<font color="#000080">;

</font><font color="#008000"><i>{
   Written by Alex Karipidis on the 8th of March 1994.
   Donated to the public domain.  Use this code freely.

   You can contact me at:
     Fidonet  : 2:410/204.4
     Hellasnet: 7:2000/50.4
     SBCnet   : 14:2100/201.4
     Zyxelnet : 16:800/108.4
     Pascalnet: 115:3005/1.4

   If you enhance/improve this code in any way, I would appreciate it if you
   sent me a copy of your version.

   I will not be responsible for any damage caused by this code.

   This program will print a list of all programs currently loaded in
   memory.
}

</i></font><font color="#FF0000"><b>Type

  </b></font>pMCB_Rec <font color="#000080">= ^</font>MCB_Rec<font color="#000080">;
  </font>MCB_Rec <font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>ChainID    <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#008000"><i>{ 77 if part of MCB chain, 90 if last MCB allocated }
    </i></font>Owner      <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ PSP segment address of the MCB's owner }
    </i></font>Paragraphs <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ Paragraphs related to this MCB }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>MCB                  <font color="#000080">: </font>pMCB_Rec<font color="#000080">;
  </font>InVarsSeg<font color="#000080">, </font>InVarsOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>EnvSeg<font color="#000080">, </font>Counter      <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Dos service 52h returns the address of the DOS &quot;invars&quot; table in ES:BX }
           { !!! This is an undocumented DOS function !!! }
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">MOV   AH,52h
    INT   21h
    MOV   InVarsSeg,ES
    MOV   InVarsOfs,BX
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{
    The word before the &quot;invars&quot; table is the segment of the first MCB
    allocated by DOS.
  }
  </i></font>MCB <font color="#000080">:= </font>Ptr <font color="#000080">(</font>MemW <font color="#000080">[</font>InVarsSeg<font color="#000080">:</font>InVarsOfs<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);

  </font><font color="#FF0000"><b>While </b></font>MCB<font color="#000080">^.</font>ChainID <font color="#000080">&lt;&gt; </font><font color="#800000">90 </font><font color="#FF0000"><b>do  </b></font><font color="#008000"><i>{ While valid MCBs exist... }
  </i></font><font color="#FF0000"><b>begin

    If </b></font>MCB<font color="#000080">^.</font>Owner <font color="#000080">= </font>Seg <font color="#000080">(</font>MCB<font color="#000080">^) + </font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ If MCB owns itself, then... }
    </i></font><font color="#FF0000"><b>begin
      </b></font>Write <font color="#000080">(</font><font color="#800000">'In memory: '</font><font color="#000080">);  </font><font color="#008000"><i>{ We've found a program in memory }

      {
        The word at offset 2Ch of the program's PSP contains the value of
        the program's environment data area.  That's were the program's name
        is located.
      }
      </i></font>EnvSeg <font color="#000080">:= </font>MemW <font color="#000080">[</font>MCB<font color="#000080">^.</font>Owner<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">];

      </font><font color="#008000"><i>{
        The environment also contains the environment variables as ASCIIZ
        (null-terminated) strings.  Two consecutive null (0) bytes mean that
        the environment variables have ended and the program name follows
        after 4 bytes.  That is also an ASCIIZ string.
      }
      </i></font>Counter <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>Mem <font color="#000080">[</font>EnvSeg<font color="#000080">:</font>Counter  <font color="#000080">] &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or  </b></font><font color="#008000"><i>{ Find 2 consecutive }
            </i></font><font color="#000080">(</font>Mem <font color="#000080">[</font>EnvSeg<font color="#000080">:</font>Counter<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do  </b></font><font color="#008000"><i>{ null bytes.        }
        </i></font>inc <font color="#000080">(</font>counter<font color="#000080">);

      </font>inc <font color="#000080">(</font>counter<font color="#000080">,</font><font color="#800000">4</font><font color="#000080">); </font><font color="#008000"><i>{ Program name follows after 4 bytes }

      </i></font><font color="#FF0000"><b>While </b></font>Mem <font color="#000080">[</font>EnvSeg<font color="#000080">:</font>Counter<font color="#000080">] &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do </b></font><font color="#008000"><i>{ Print program name }
      </i></font><font color="#FF0000"><b>begin
        </b></font>Write <font color="#000080">(</font>Char <font color="#000080">(</font>Mem <font color="#000080">[</font>EnvSeg <font color="#000080">: </font>Counter<font color="#000080">]));
        </font>Inc <font color="#000080">(</font>counter<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>WriteLn<font color="#000080">;

    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{ Point to next MCB }
    </i></font>MCB <font color="#000080">:= </font>Ptr <font color="#000080">(</font>Seg <font color="#000080">(</font>MCB<font color="#000080">^) + </font>MCB<font color="#000080">^.</font>Paragraphs <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{
    Note: The last MCB is not processed!
          It is assumed that it is this program's MCB.
          In your programs, this may or may not be the case.
  }

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p></body>
</html>
