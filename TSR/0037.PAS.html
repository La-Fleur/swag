<html>
<head><title> "Unloading TSRs" by TOM MERTENS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0037.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I don't know. That's what I'd like to know - how to unload a
&gt; TSR! Ugh. I've been able to program a way to see if it's in
&gt; memory, and modify the current data in it, but nothing more.

Hmmm... Well.... have a look at this code, it is a part from my TSR, I have
marked the procedures that are just for my TSR, and have made a seperate
function in the new interrupt to unload the TSR.  The unload part is written
in July 94 by Luis Mezquita Raya.  It seems to work :)
It is a TSR player for HSC files (by Chicken yep).
}

{$F+}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>New78Int<font color="#000080">(</font>Flags<font color="#000080">,</font>cs<font color="#000080">,</font>ip<font color="#000080">,</font>ax<font color="#000080">,</font>bx<font color="#000080">,</font>cx<font color="#000080">,</font>dx<font color="#000080">,</font>si<font color="#000080">,</font>di<font color="#000080">,</font>ds<font color="#000080">,</font>es<font color="#000080">,</font>bp<font color="#000080">:</font>word<font color="#000080">); </font>Interrupt<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  IF </b></font>LO<font color="#000080">(</font>ax<font color="#000080">) = </font><font color="#800000">00 </font><font color="#FF0000"><b>THEN BEGIN             </b></font><font color="#008000"><i>{Installed?}
    </i></font>ax <font color="#000080">:= </font><font color="#800000">$6676</font><font color="#000080">; </font><font color="#008000"><i>{BL}
    </i></font>bx <font color="#000080">:= </font><font color="#800000">$7984</font><font color="#000080">; </font><font color="#008000"><i>{OT}
    </i></font><font color="#FF0000"><b>IF </b></font>Active <font color="#FF0000"><b>THEN
      </b></font>cx <font color="#000080">:= </font><font color="#800000">$0001                       </font><font color="#008000"><i>{Active}
    </i></font><font color="#FF0000"><b>ELSE
      </b></font>cx <font color="#000080">:= </font><font color="#800000">$0000</font><font color="#000080">;                      </font><font color="#008000"><i>{Inactive}
    </i></font>dx <font color="#000080">:= </font><font color="#800000">$0115                         </font><font color="#008000"><i>{Version &amp; Revision}
  </i></font><font color="#FF0000"><b>END ELSE
  IF </b></font>LO<font color="#000080">(</font>ax<font color="#000080">) = </font><font color="#800000">01 </font><font color="#FF0000"><b>THEN BEGIN             </b></font><font color="#008000"><i>{Play A File}
    </i></font><font color="#FF0000"><b>IF </b></font>Active <font color="#FF0000"><b>THEN BEGIN
     </b></font>FNamePTR <font color="#000080">:= </font>Ptr<font color="#000080">(</font>bx<font color="#000080">,</font>cx<font color="#000080">);
     </font>MOVE<font color="#000080">(</font>FNamePTR<font color="#000080">^, </font>Filename<font color="#000080">, </font><font color="#800000">256</font><font color="#000080">);
     </font><font color="#FF0000"><b>IF </b></font>Play<font color="#000080">(</font>Filename<font color="#000080">) </font><font color="#FF0000"><b>THEN
       </b></font>ax <font color="#000080">:= </font><font color="#800000">00                         </font><font color="#008000"><i>{Okay!}
     </i></font><font color="#FF0000"><b>ELSE </b></font>ax <font color="#000080">:= </font><font color="#800000">01</font><font color="#000080">;                     </font><font color="#008000"><i>{Problemo}
    </i></font><font color="#FF0000"><b>END ELSE
      </b></font>ax <font color="#000080">:= </font><font color="#800000">01                          </font><font color="#008000"><i>{Not Active!}
  </i></font><font color="#FF0000"><b>END ELSE
  IF </b></font>LO<font color="#000080">(</font>ax<font color="#000080">) = </font><font color="#800000">02 </font><font color="#FF0000"><b>THEN BEGIN             </b></font><font color="#008000"><i>{Quit playing}
     </i></font>StopPlay<font color="#000080">;
  </font><font color="#FF0000"><b>END ELSE
  IF </b></font>LO<font color="#000080">(</font>ax<font color="#000080">) = </font><font color="#800000">03 </font><font color="#FF0000"><b>THEN BEGIN             </b></font><font color="#008000"><i>{Set State}
    </i></font>cx <font color="#000080">:= </font>WORD<font color="#000080">(</font>Active<font color="#000080">);                 </font><font color="#008000"><i>{Former State Active}
    </i></font><font color="#FF0000"><b>IF </b></font>bx <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN </b></font>Bossil_Active <font color="#000080">:= </font>FALSE<font color="#000080">;
    </font><font color="#FF0000"><b>IF </b></font>bx <font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>THEN </b></font>Bossil_Active <font color="#000080">:= </font>TRUE<font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>LO<font color="#000080">(</font>ax<font color="#000080">) = </font><font color="#800000">04 </font><font color="#FF0000"><b>THEN BEGIN
      asm                               </b></font><font color="#008000"><i>{THIS IS THE UNLOAD PROC}
                </i></font><font color="#FF00FF">cli
                mov AH,49h
                mov ES,PrefixSeg
                push ES
                mov ES,ES:[2Ch]
                int 21h
                pop ES
                mov AH,49h
                int 21h
                sti
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}

</i></font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{MAIN PROGRAM TO ILLUSTRATE CHECKING IF INSTALLED OR NOT}
  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$78</font><font color="#000080">, </font>Old78hInt<font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">((</font>Old78hInt <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>ParamSTR<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) &lt;&gt; </font>stopparam<font color="#000080">)) </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WRITELN<font color="#000080">(</font><font color="#800000">'Interrupt Vector 78h Was Already Allocated!'</font><font color="#000080">);
    </font>HALT<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>END ELSE
  IF </b></font><font color="#000080">((</font>Old78hInt <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>ParamSTR<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) = </font>stopparam<font color="#000080">)) </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WRITELN<font color="#000080">(</font><font color="#800000">'Desactivated!'</font><font color="#000080">);
    </font><font color="#FF0000"><b>ASM
      </b></font><font color="#FF00FF">MOV AX,0004h
      INT 78h
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>SetIntVec<font color="#000080">(</font><font color="#800000">$78</font><font color="#000080">, </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">);
    </font>HALT<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>END ELSE
  IF </b></font>ParamSTR<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) = </font>stopparam <font color="#FF0000"><b>THEN BEGIN
    </b></font>WRITELN<font color="#000080">(</font><font color="#800000">'Not installed yet!  Could not desinstall!'</font><font color="#000080">);
    </font>HALT<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">MOV AX,0000h
    INT 78h
    MOV AX, ID1
    MOV BX, ID2
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>ID1 <font color="#000080">= </font><font color="#800000">$6676</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>ID2 <font color="#000080">= </font><font color="#800000">$7984</font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WRITELN<font color="#000080">(</font><font color="#800000">'Already installed!  Not reinstalled'</font><font color="#000080">)
    </font>HALT<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>SetIntVec<font color="#000080">(</font><font color="#800000">$78</font><font color="#000080">, @</font>New78Int<font color="#000080">);
  </font>WRITELN<font color="#000080">(</font><font color="#800000">'Installed                    (c) 1995, BLoT'</font><font color="#000080">);
  </font>Active <font color="#000080">:= </font>TRUE<font color="#000080">;
  </font>Keep<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font><font color="#008000"><i>{
I left out the VAR part, but I guess you are smart enough to reconstruct that
one...  Anyway, it seems to work perfectely at my side, so...
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0037.PAS">Original</a><b>]</b></p></body>
</html>
