<html>
<head><title> "TSR Writing Unit" by NIR SOFER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
TSRUNIT v1.10
Copyright (c) 1995 Nir Sofer, All rights reserved
For using with Turbo Pascal 6.0/7.0

You are allowed to copy, modify and share this program with others. But when
you give TSRUNIT source code to other people (or upload it to a BBS) always
give them the whole original files which is included in TSRUNIT package.

For questions, comments or bugs report: Send me a message by one of the
following ways:

1. Internet: nir@netvision.net.il
2. FidoNet:  Nir Sofer, at 2:403/138.0
3. Ordinary mail:

  Nir Sofer
  5 Shderot Hashoshanim St.
  52583 Ramat Gan
  ISRAEL

All mail will be answered. If you don't get a reply after a week, please
send it again. Mail may be lost somethimes...

READ TSRUNIT.DOC BEFORE USING THIS UNIT !

New in this version:

* Problems with MS-DOS 6.xx fixed by adding INT28 support.
* Check if the TSR has already installed before.
* The type of TsrProcedue variable is a procedure instead of pointer, so you
  don't have to add @ operator.
* Consts for all keyboard flags and keyboard scan codes.
* The TsrProcedure variable automatically assigned by InstallTsr procedure

}

</i></font><font color="#FF0000"><b>unit </b></font>tsrunit<font color="#000080">;
</font><font color="#008000"><i>{$s-,r-}

</i></font><font color="#FF0000"><b>interface
type
  </b></font>ProcedureType <font color="#000080">= </font><font color="#FF0000"><b>procedure</b></font><font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>TSRUNITsignature <font color="#000080">= </font><font color="#800000">$DAAD</font><font color="#000080">;
  </font>RightShift <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>LeftShift  <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
  </font>Ctrl       <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;
  </font>Alt        <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;

  </font>_esc  <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;     </font>_a    <font color="#000080">= </font><font color="#800000">30</font><font color="#000080">;     </font>_f7    <font color="#000080">= </font><font color="#800000">65</font><font color="#000080">;
  </font>_1    <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;     </font>_s    <font color="#000080">= </font><font color="#800000">31</font><font color="#000080">;     </font>_f8    <font color="#000080">= </font><font color="#800000">66</font><font color="#000080">;
  </font>_2    <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;     </font>_d    <font color="#000080">= </font><font color="#800000">32</font><font color="#000080">;     </font>_f9    <font color="#000080">= </font><font color="#800000">67</font><font color="#000080">;
  </font>_3    <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;     </font>_f    <font color="#000080">= </font><font color="#800000">33</font><font color="#000080">;     </font>_f10   <font color="#000080">= </font><font color="#800000">68</font><font color="#000080">;
  </font>_4    <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">;     </font>_g    <font color="#000080">= </font><font color="#800000">34</font><font color="#000080">;     </font>_numlock <font color="#000080">= </font><font color="#800000">69</font><font color="#000080">;
  </font>_5    <font color="#000080">= </font><font color="#800000">6</font><font color="#000080">;     </font>_h    <font color="#000080">= </font><font color="#800000">35</font><font color="#000080">;     </font>_scrlock <font color="#000080">= </font><font color="#800000">70</font><font color="#000080">;
  </font>_6    <font color="#000080">= </font><font color="#800000">7</font><font color="#000080">;     </font>_j    <font color="#000080">= </font><font color="#800000">36</font><font color="#000080">;     </font>_home    <font color="#000080">= </font><font color="#800000">71</font><font color="#000080">;
  </font>_7    <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;     </font>_k    <font color="#000080">= </font><font color="#800000">37</font><font color="#000080">;     </font>_up <font color="#000080">= </font><font color="#800000">72</font><font color="#000080">;
  </font>_8    <font color="#000080">= </font><font color="#800000">9</font><font color="#000080">;     </font>_l    <font color="#000080">= </font><font color="#800000">38</font><font color="#000080">;     </font>_pgup     <font color="#000080">= </font><font color="#800000">73</font><font color="#000080">;
  </font>_9    <font color="#000080">= </font><font color="#800000">10</font><font color="#000080">;    </font>_lshift <font color="#000080">= </font><font color="#800000">42</font><font color="#000080">;   </font>_left     <font color="#000080">= </font><font color="#800000">75</font><font color="#000080">;
  </font>_0    <font color="#000080">= </font><font color="#800000">11</font><font color="#000080">;    </font>_z    <font color="#000080">= </font><font color="#800000">44</font><font color="#000080">;     </font>_right    <font color="#000080">= </font><font color="#800000">77</font><font color="#000080">;
  </font>_minus <font color="#000080">= </font><font color="#800000">12</font><font color="#000080">;   </font>_x    <font color="#000080">= </font><font color="#800000">45</font><font color="#000080">;     </font>_end      <font color="#000080">= </font><font color="#800000">79</font><font color="#000080">;
  </font>_plus  <font color="#000080">= </font><font color="#800000">13</font><font color="#000080">;   </font>_c    <font color="#000080">= </font><font color="#800000">46</font><font color="#000080">;     </font>_down     <font color="#000080">= </font><font color="#800000">80</font><font color="#000080">;
  </font>_bksp  <font color="#000080">= </font><font color="#800000">14</font><font color="#000080">;   </font>_v    <font color="#000080">= </font><font color="#800000">47</font><font color="#000080">;     </font>_pgdn     <font color="#000080">= </font><font color="#800000">81</font><font color="#000080">;
  </font>_tab   <font color="#000080">= </font><font color="#800000">15</font><font color="#000080">;   </font>_b    <font color="#000080">= </font><font color="#800000">48</font><font color="#000080">;     </font>_insert   <font color="#000080">= </font><font color="#800000">82</font><font color="#000080">;
  </font>_q      <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">;  </font>_n    <font color="#000080">= </font><font color="#800000">49</font><font color="#000080">;     </font>_delete   <font color="#000080">= </font><font color="#800000">83</font><font color="#000080">;
  </font>_w      <font color="#000080">= </font><font color="#800000">17</font><font color="#000080">;  </font>_m    <font color="#000080">= </font><font color="#800000">50</font><font color="#000080">;
  </font>_e      <font color="#000080">= </font><font color="#800000">18</font><font color="#000080">;  </font>_rshift <font color="#000080">= </font><font color="#800000">54</font><font color="#000080">;
  </font>_r      <font color="#000080">= </font><font color="#800000">19</font><font color="#000080">;  </font>_alt    <font color="#000080">= </font><font color="#800000">56</font><font color="#000080">;
  </font>_t      <font color="#000080">= </font><font color="#800000">20</font><font color="#000080">;  </font>_space  <font color="#000080">= </font><font color="#800000">57</font><font color="#000080">;
  </font>_y      <font color="#000080">= </font><font color="#800000">21</font><font color="#000080">;  </font>_capslock <font color="#000080">= </font><font color="#800000">58</font><font color="#000080">;
  </font>_u      <font color="#000080">= </font><font color="#800000">22</font><font color="#000080">;  </font>_f1  <font color="#000080">= </font><font color="#800000">59</font><font color="#000080">;
  </font>_i      <font color="#000080">= </font><font color="#800000">23</font><font color="#000080">;  </font>_f2  <font color="#000080">= </font><font color="#800000">60</font><font color="#000080">;
  </font>_o      <font color="#000080">= </font><font color="#800000">24</font><font color="#000080">;  </font>_f3  <font color="#000080">= </font><font color="#800000">61</font><font color="#000080">;
  </font>_p      <font color="#000080">= </font><font color="#800000">25</font><font color="#000080">;  </font>_f4  <font color="#000080">= </font><font color="#800000">62</font><font color="#000080">;
  </font>_enter  <font color="#000080">= </font><font color="#800000">28</font><font color="#000080">;  </font>_f5  <font color="#000080">= </font><font color="#800000">63</font><font color="#000080">;
  </font>_ctrl   <font color="#000080">= </font><font color="#800000">29</font><font color="#000080">;  </font>_f6  <font color="#000080">= </font><font color="#800000">64</font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>keysc         <font color="#000080">: </font>byte<font color="#000080">;    </font><font color="#008000"><i>{Keyboard scan code variable}
  </i></font>keyflag       <font color="#000080">: </font>byte<font color="#000080">;  </font><font color="#008000"><i>{Keyboard flag variable}
  </i></font>TsrProcedure  <font color="#000080">: </font>ProcedureType<font color="#000080">;
  </font>UserSignature <font color="#000080">: </font>word<font color="#000080">;
  </font>SignatureReturn <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>SetUserSignature<font color="#000080">(</font>Check<font color="#000080">,</font>Return<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>InstallTsr<font color="#000080">(</font>tsrproc<font color="#000080">: </font>ProcedureType<font color="#000080">);  </font><font color="#008000"><i>{Make your program resident}
</i></font><font color="#FF0000"><b>procedure </b></font>RemoveTsr<font color="#000080">;   </font><font color="#008000"><i>{Remove your resident program}
</i></font><font color="#FF0000"><b>function </b></font>CheckIntVectors<font color="#000080">:</font>boolean<font color="#000080">; </font><font color="#008000"><i>{Check if interrupt vectors are still
                         ours, if yes you are allowed to remove your TSR}
</i></font><font color="#FF0000"><b>function </b></font>InstallationCheck<font color="#000080">:</font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>implementation
uses </b></font>dos<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>old08<font color="#000080">,</font>old09<font color="#000080">,</font>old10<font color="#000080">,</font>old1b<font color="#000080">,</font>old24<font color="#000080">,</font>old28<font color="#000080">,</font>turbo24<font color="#000080">:</font>pointer<font color="#000080">;
  </font>indosflag<font color="#000080">,</font>currint<font color="#000080">:</font>pointer<font color="#000080">;
  </font>active<font color="#000080">,</font>request<font color="#000080">,</font>idle<font color="#000080">:</font>byte<font color="#000080">;
  </font>savesp<font color="#000080">,</font>savess<font color="#000080">:</font>word<font color="#000080">;
  </font>busyflag<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#008000"><i>{$f+}
{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>int1b<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">iret   </font><font color="#008000"><i>{Cancel CTRL-BREAK interrupt}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>int10<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">jmp     @cont1
@localds:
                nop
                nop       </font><font color="#008000"><i>{Reserved for ds value}
</i></font><font color="#FF00FF">@localint10:
                nop
                nop
                nop
                nop       </font><font color="#008000"><i>{Reserved for old int10 address}

</i></font><font color="#FF00FF">@cont1:
                push    ds
                mov     ds,word ptr [cs:@localds]
                inc     busyflag
                pop     ds
                pushf
                call    dword ptr [cs:@localint10]  </font><font color="#008000"><i>{Call old interrupt}
                </i></font><font color="#FF00FF">push    ds
                mov     ds,word ptr [cs:@localds]
                cmp     ax,tsrunitsignature
                je      @TsrUnitCall
@cont100:
                dec     busyflag
                pop     ds
                iret
@TsrUnitCall:
                cmp     bx,UserSignature
                jne     @cont100
                mov     cx,SignatureReturn
                jmp     @cont100
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>swap1<font color="#000080">;
</font><font color="#FF0000"><b>begin     </b></font><font color="#008000"><i>{Swap vectors before running TsrProcedure}
  </i></font>getintvec<font color="#000080">(</font><font color="#800000">$1b</font><font color="#000080">,</font>old1b<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$1b</font><font color="#000080">,@</font>int1b<font color="#000080">);
  </font>getintvec<font color="#000080">(</font><font color="#800000">$24</font><font color="#000080">,</font>old24<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$24</font><font color="#000080">,</font>turbo24<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>swap2<font color="#000080">;
</font><font color="#FF0000"><b>begin     </b></font><font color="#008000"><i>{Swap vectors after running TsrProcedure}
  </i></font>setintvec<font color="#000080">(</font><font color="#800000">$24</font><font color="#000080">,</font>old24<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$1b</font><font color="#000080">,</font>old1b<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>activate<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">jmp     @start
@localss:
                nop
                nop   </font><font color="#008000"><i>{Reserved for ss value}
</i></font><font color="#FF00FF">@localsp:
                nop
                nop   </font><font color="#008000"><i>{Reserved for sp value}
</i></font><font color="#FF00FF">@start:
                cmp     request,1      </font><font color="#008000"><i>{Request by INT09 ?}
                </i></font><font color="#FF00FF">jne     @notrequested
                cmp     idle,1
                je      @cont500
                les     di,indosflag
                cmp     word ptr [es:di],0   </font><font color="#008000"><i>{Check indos flag}
                </i></font><font color="#FF00FF">jne     @notrequested
@cont500:
                cmp     busyflag,0           </font><font color="#008000"><i>{INT10 busy ?}
                </i></font><font color="#FF00FF">jne     @notrequested
                mov     active,1             </font><font color="#008000"><i>{The tsr is active now}
                </i></font><font color="#FF00FF">mov     request,0
                mov     savess,ss
                mov     savesp,sp
                cli
                mov     ss,word ptr [cs:@localss]
                mov     sp,word ptr [cs:@localsp]  </font><font color="#008000"><i>{Set ss and sp registers of TP}
                </i></font><font color="#FF00FF">sti
                push    bx
                push    cx
                push    dx
                push    si
                push    bp
                call    [swap1]  </font><font color="#008000"><i>{Swap CTRL-BREAK and critical error handler vectors}
                </i></font><font color="#FF00FF">call    [TsrProcedure]       </font><font color="#008000"><i>{call your procedure}
                </i></font><font color="#FF00FF">call    [swap2]  </font><font color="#008000"><i>{Swap CTRL-BREAK and critical error handler vectors}
                </i></font><font color="#FF00FF">pop     bp
                pop     si
                pop     dx
                pop     cx
                pop     bx
                cli
                mov     ss,savess
                mov     sp,savesp                  </font><font color="#008000"><i>{Set old ss and sp registers}
                </i></font><font color="#FF00FF">sti
                mov     active,0

@notrequested:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>int28<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">jmp     @cont1
@localds:
                nop
                nop
@localint28:
                nop
                nop
                nop
                nop
@cont1:
                push    es
                push    ds
                push    ax
                push    di

                push    ds
                mov     ds,word ptr [cs:@localds]
                inc     idle
                pop     ds
                pushf
                call    dword ptr [cs:@localint28]  </font><font color="#008000"><i>{Call old interrupt}
                </i></font><font color="#FF00FF">mov     ds,word ptr [cs:@localds]
                call    activate
                dec     idle
                pop     di
                pop     ax
                pop     ds
                pop     es
                iret

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>int08<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">jmp     @cont1
@localds:
                nop
                nop   </font><font color="#008000"><i>{Reserved for ds value}

</i></font><font color="#FF00FF">@cont1:
                push    es
                push    ds
                push    ax
                push    di
                mov     ds,word ptr [cs:@localds]
                pushf
                call    [old08]  </font><font color="#008000"><i>{Call old interrupt}
                </i></font><font color="#FF00FF">call    activate
                pop     di
                pop     ax
                pop     ds
                pop     es
                iret
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>int09<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">jmp     @cont1
@localds:
                nop
                nop       </font><font color="#008000"><i>{Reserved for ds value}

</i></font><font color="#FF00FF">@cont1:
                push    es
                push    ax
                push    ds
                mov     ds,word ptr [cs:@localds]
                pushf
                call    [old09]  </font><font color="#008000"><i>{Call old INT09}
                </i></font><font color="#FF00FF">in      al,60h
                cmp     al,keysc   </font><font color="#008000"><i>{Check scan code key}
                </i></font><font color="#FF00FF">jne     @notourkey
                xor     ax,ax
                mov     es,ax
                mov     al,[es:1047]
                and     al,keyflag
                cmp     al,keyflag   </font><font color="#008000"><i>{Check alt\ctrl\shift keys}
                </i></font><font color="#FF00FF">jne     @notourkey
                cmp     active,1   </font><font color="#008000"><i>{Check if already active}
                </i></font><font color="#FF00FF">je      @notourkey
                mov     request,1  </font><font color="#008000"><i>{Request activity}

</i></font><font color="#FF00FF">@notourkey:
                pop     ds
                pop     ax
                pop     es
                iret
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>InstallTsr<font color="#000080">(</font>tsrproc<font color="#000080">: </font>ProcedureType<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>TsrProcedure<font color="#000080">:=</font>tsrproc<font color="#000080">;
  </font>getintvec<font color="#000080">(</font><font color="#800000">$28</font><font color="#000080">,</font>old28<font color="#000080">);
  </font>getintvec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">,</font>old08<font color="#000080">);
  </font>getintvec<font color="#000080">(</font><font color="#800000">$9</font><font color="#000080">,</font>old09<font color="#000080">);
  </font>getintvec<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>old10<font color="#000080">);
  </font>getintvec<font color="#000080">(</font><font color="#800000">$24</font><font color="#000080">,</font>turbo24<font color="#000080">);  </font><font color="#008000"><i>{Get interrupt vectors}
  </i></font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int10<font color="#000080">):</font>ofs<font color="#000080">(</font>int10<font color="#000080">)+</font><font color="#800000">4</font><font color="#000080">]:=</font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>old10<font color="#000080">):</font>ofs<font color="#000080">(</font>old10<font color="#000080">)];
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int10<font color="#000080">):</font>ofs<font color="#000080">(</font>int10<font color="#000080">)+</font><font color="#800000">6</font><font color="#000080">]:=</font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>old10<font color="#000080">):</font>ofs<font color="#000080">(</font>old10<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">];
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int28<font color="#000080">):</font>ofs<font color="#000080">(</font>int28<font color="#000080">)+</font><font color="#800000">4</font><font color="#000080">]:=</font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>old28<font color="#000080">):</font>ofs<font color="#000080">(</font>old28<font color="#000080">)];
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int28<font color="#000080">):</font>ofs<font color="#000080">(</font>int28<font color="#000080">)+</font><font color="#800000">6</font><font color="#000080">]:=</font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>old28<font color="#000080">):</font>ofs<font color="#000080">(</font>old28<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">];
</font><font color="#008000"><i>{Put interrupt $10 address in INT10 procedure}
  </i></font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>activate<font color="#000080">):</font>ofs<font color="#000080">(</font>activate<font color="#000080">)+</font><font color="#800000">4</font><font color="#000080">]:=</font>sptr<font color="#000080">;
</font><font color="#008000"><i>{Save stack pointer for using when TSR is active}
  </i></font>setintvec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">,@</font>int08<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$9</font><font color="#000080">,@</font>int09<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,@</font>int10<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$28</font><font color="#000080">,@</font>int28<font color="#000080">);
</font><font color="#008000"><i>{Set new interrupt vectors}
  </i></font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">mov     dx,prefixseg
                mov     es,dx
                mov     ax,[es:$2c]
                cmp     ax,0
                jz      @cont
                mov     es,ax
                mov     ah,$49
                int     $21  </font><font color="#008000"><i>{Release environment block}
</i></font><font color="#FF00FF">@cont:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>swapvectors<font color="#000080">; </font><font color="#008000"><i>{Swap TP vectors with old vectors}
  </i></font>keep<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);  </font><font color="#008000"><i>{Terminate and stay resident}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>function </b></font>CheckIntVectors<font color="#000080">:</font>boolean<font color="#000080">;
</font><font color="#008000"><i>{If CheckIntVectors=false, do not remove the tsr !!}
</i></font><font color="#FF0000"><b>begin
  </b></font>CheckIntVectors<font color="#000080">:=</font>false<font color="#000080">;
  </font>getintvec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">,</font>currint<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>currint<font color="#000080">&lt;&gt;@</font>int08 <font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
  </font>getintvec<font color="#000080">(</font><font color="#800000">$9</font><font color="#000080">,</font>currint<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>currint<font color="#000080">&lt;&gt;@</font>int09 <font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
  </font>getintvec<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>currint<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>currint<font color="#000080">&lt;&gt;@</font>int10 <font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
  </font>CheckIntVectors<font color="#000080">:=</font>true<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>RemoveTsr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>setintvec<font color="#000080">(</font><font color="#800000">$8</font><font color="#000080">,</font>old08<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$9</font><font color="#000080">,</font>old09<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>old10<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$1b</font><font color="#000080">,</font>old1b<font color="#000080">);
  </font>setintvec<font color="#000080">(</font><font color="#800000">$28</font><font color="#000080">,</font>old28<font color="#000080">);
</font><font color="#008000"><i>{set old interrupt vectors}
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov    dx,prefixseg
    mov    es,dx
    mov    ah,$49
    int    $21    </font><font color="#008000"><i>{Release memory block}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov    ax,$4c00
    int    $21     </font><font color="#008000"><i>{Terminate program}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>procedure </b></font>SetUserSignature<font color="#000080">(</font>Check<font color="#000080">,</font>Return<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov   ax,check
  mov   UserSignature,ax </font><font color="#008000"><i>{The value to send to INT 10h}
  </i></font><font color="#FF00FF">mov   ax,return
  mov   SignatureReturn,ax  </font><font color="#008000"><i>{The value that INT 10h will return}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>function </b></font>InstallationCheck<font color="#000080">:</font>boolean<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov   ax,TSRUNITsignature
  mov   bx,UserSignature
  xor   cx,cx
  int   010h
  xor   al,al
  cmp   cx,SignatureReturn </font><font color="#008000"><i>{Did you get the return value}
  </i></font><font color="#FF00FF">jne   @tend
  mov   al,1               </font><font color="#008000"><i>{If yes, your TSR already installed !}
</i></font><font color="#FF00FF">@tend:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>begin
  </b></font>setusersignature<font color="#000080">(</font><font color="#800000">$eeaa</font><font color="#000080">,</font><font color="#800000">$aaff</font><font color="#000080">);
  </font>busyflag<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>idle<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int08<font color="#000080">):</font>ofs<font color="#000080">(</font>int08<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">]:=</font>dseg<font color="#000080">;
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int09<font color="#000080">):</font>ofs<font color="#000080">(</font>int09<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">]:=</font>dseg<font color="#000080">;
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int10<font color="#000080">):</font>ofs<font color="#000080">(</font>int10<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">]:=</font>dseg<font color="#000080">;
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>int28<font color="#000080">):</font>ofs<font color="#000080">(</font>int28<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">]:=</font>dseg<font color="#000080">;
  </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>activate<font color="#000080">):</font>ofs<font color="#000080">(</font>activate<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">]:=</font>sseg<font color="#000080">;
</font><font color="#008000"><i>{Set local data segments}
  </i></font>keysc<font color="#000080">:=</font>_a<font color="#000080">;
  </font>keyflag<font color="#000080">:=</font>Alt <font color="#000080">+ </font>Ctrl<font color="#000080">; </font><font color="#008000"><i>{Default key combination}
  </i></font>active<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>request<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov   ah,$34
    int   $21
    mov   ax,es
    sub   bx,1
    sbb   ax,0
    mov   word ptr [indosflag],bx
    mov   word ptr [indosflag+2],ax  </font><font color="#008000"><i>{Get indos flag address}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p></body>
</html>
