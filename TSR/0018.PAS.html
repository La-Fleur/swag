<html>
<head><title> "TSR Disk Writes" by DAVID BRAATEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0018.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;Does anybody know how to write to disk inside a TSR using
&gt;turbo pascal?  I know all about how to write a simple TSR,
&gt;cannot call Dos functions from within a hardware interrupt.

Here is parts of a tsr to write to disk when a hotkey is pressed
(Leftshift,left alt,right alt)
}

</i></font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">,</font>crt<font color="#000080">;
</font><font color="#FF0000"><b>const
 </b></font>hotkey <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">;
 </font>writekey <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">10</font><font color="#000080">; </font><font color="#008000"><i>{write to disk when this combo comes up }
</i></font><font color="#FF0000"><b>var
  </b></font>dat <font color="#000080">: </font><font color="#FF0000"><b>file of </b></font>word<font color="#000080">;  </font><font color="#008000"><i>{keep file definition on globals}

</i></font><font color="#FF0000"><b>procedure </b></font>diskit<font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>x<font color="#000080">,</font>y <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not </b></font>cracking <font color="#FF0000"><b>then
  begin
    </b></font>cracking <font color="#000080">:= </font>true<font color="#000080">;  </font><font color="#008000"><i>{disable checking for hotkey while writing}
    </i></font>assign<font color="#000080">(</font>dat<font color="#000080">,</font><font color="#800000">'a:\dump.scr'</font><font color="#000080">);
    </font>rewrite<font color="#000080">(</font>Dat<font color="#000080">);
    </font>display<font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>y <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">24 </font><font color="#FF0000"><b>do
      for </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">79 </font><font color="#FF0000"><b>do
      </b></font>write<font color="#000080">(</font>dat<font color="#000080">,</font>wind<font color="#000080">[</font>X<font color="#000080">,</font>y<font color="#000080">]);
    </font>close<font color="#000080">(</font>dat<font color="#000080">);
    </font>current <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;        </font><font color="#008000"><i>{Reset current to 0}
    </i></font>cracking <font color="#000080">:= </font>false<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>calloldint<font color="#000080">(</font>sub<font color="#000080">:</font>pointer<font color="#000080">);
</font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{calloldint}
</i></font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$9C</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$5E</font><font color="#000080">/</font><font color="#800000">$06</font><font color="#000080">);   </font><font color="#008000"><i>{Assembly to pop pointer off stack and call it}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{calloldint}
{-------------------------------------------------------------}

</i></font><font color="#FF0000"><b>procedure </b></font>tick<font color="#000080">(</font>flags<font color="#000080">,</font>cs<font color="#000080">,</font>ip<font color="#000080">,</font>ax<font color="#000080">,</font>bx<font color="#000080">,</font>cx<font color="#000080">,</font>dx<font color="#000080">,</font>si<font color="#000080">,</font>di<font color="#000080">,</font>ds<font color="#000080">,</font>es<font color="#000080">,</font>bp<font color="#000080">:</font>word<font color="#000080">); </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>regs<font color="#000080">:</font>registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>calloldint<font color="#000080">(</font>oldvec<font color="#000080">);
   </font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$12</font><font color="#000080">;
   </font>intr<font color="#000080">(</font><font color="#800000">$16</font><font color="#000080">, </font>regs<font color="#000080">);
   </font>statflags <font color="#000080">:= (</font>regs<font color="#000080">.</font>al <font color="#FF0000"><b>and  </b></font>regs<font color="#000080">.</font>ah<font color="#000080">) </font><font color="#FF0000"><b>and </b></font>hotkey<font color="#000080">;
   </font>regflags <font color="#000080">:= (</font>regs<font color="#000080">.</font>al <font color="#FF0000"><b>and  </b></font>regs<font color="#000080">.</font>ah<font color="#000080">) </font><font color="#FF0000"><b>and </b></font>writekey<font color="#000080">;
</font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>statflags <font color="#000080">= </font>hotkey<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>cnt <font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin
  </b></font>cnt <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>display<font color="#000080">;
  </font>cnt <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end
else if </b></font><font color="#000080">(</font>regflags <font color="#000080">= </font>writekey<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>cnt <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin
   </b></font>cnt <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font>diskit<font color="#000080">;     </font><font color="#008000"><i>{write to disk if hotkey}
   </i></font>cnt <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end
else inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{tick}
{-----------------------------------------------------}

</i></font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{MAIN}
</i></font>writeln<font color="#000080">(</font><font color="#800000">'Saving screens function activated'</font><font color="#000080">);
</font>current <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
</font>getintvec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">,</font>oldvec<font color="#000080">);
</font>setintvec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">,@</font>tick<font color="#000080">);
</font>getintvec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">,</font>oldkbdvec<font color="#000080">);
</font>setintvec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">,@</font>keyboard<font color="#000080">);
</font>cnt <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font>Cracking <font color="#000080">:= </font>false<font color="#000080">;
</font>keep<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">. </font><font color="#008000"><i>{MAIN}

{
This will work for writing to disk as long as no other disk activity is being
performed.
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0018.PAS">Original</a><b>]</b></p></body>
</html>
