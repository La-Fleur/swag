<html>
<head><title> "Overriding the Division By Zero Error" by ARNE DE.BRUIJN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0038.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I am trying to avoid the runtime error in case of an attempt
&gt; to divide by zero.

No divide by zero, Arne de Bruijn, 1994, PD
Works not for longints, they've a check inside the runtime lib,
and not for floating point math
}

</i></font><font color="#FF0000"><b>uses </b></font>Dos<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>NewInt0<font color="#000080">(</font>Flags<font color="#000080">, </font>CS<font color="#000080">, </font>IP<font color="#000080">, </font>AX<font color="#000080">, </font>BX<font color="#000080">,
  </font>CX<font color="#000080">, </font>DX<font color="#000080">, </font>SI<font color="#000080">, </font>DI<font color="#000080">, </font>DS<font color="#000080">, </font>ES<font color="#000080">, </font>BP<font color="#000080">: </font>Word<font color="#000080">); </font>interrupt<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>const
 </b></font>InsLen<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">=(</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">les di,dword ptr [IP]  </font><font color="#008000"><i>{ Get address of instruction }
 </i></font><font color="#FF00FF">xor ax,ax              </font><font color="#008000"><i>{ Test for 808x }
 </i></font><font color="#FF00FF">push ax
 popf
 pushf
 pop ax
 and ax,0f000h
 cmp ax,0f000h
 je @Fixed              </font><font color="#008000"><i>{ Jump if it's a 808x, no update needed }
 </i></font><font color="#FF00FF">mov bl,[es:di+1]       </font><font color="#008000"><i>{ Get address mode byte }
 </i></font><font color="#FF00FF">and bx,0c7h
 cmp bl,6
 jne @NoImm
 add IP,4
 jmp @Fixed
@NoImm:
 mov cl,6
 shr bx,cl
 mov bl,byte ptr [InsLen+bx]
 add IP,bx
@Fixed:
 </font><font color="#008000"><i>{ Change result to 0 }
 </i></font><font color="#FF00FF">mov &amp;AX,0
 cmp byte ptr [es:di],0f7h  </font><font color="#008000"><i>{Change DX only if word operand }
 </i></font><font color="#FF00FF">jne @NoWord
 mov &amp;DX,0
@NoWord:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>var
 </b></font>W<font color="#000080">:</font>word<font color="#000080">;
 </font>L<font color="#000080">:</font>longint<font color="#000080">;
 </font>R<font color="#000080">:</font>real<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font><font color="#008000"><i>{ No need to save Int 0, already done in RTL }
 </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,@</font>NewInt0<font color="#000080">);
 </font>W<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font>WriteLn<font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>div </b></font>W<font color="#000080">);  </font><font color="#008000"><i>{ Displays 0 }
 </i></font>L<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font>WriteLn<font color="#000080">(</font><font color="#800000">1 </font><font color="#FF0000"><b>div </b></font>L<font color="#000080">);  </font><font color="#008000"><i>{ Runtime error 200 .... }
 </i></font>R<font color="#000080">:=</font><font color="#800000">0.0</font><font color="#000080">;
 </font>WriteLn<font color="#000080">(</font><font color="#800000">1.0</font><font color="#000080">/</font>R<font color="#000080">);    </font><font color="#008000"><i>{ Runtime error 200 .... }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0038.PAS">Original</a><b>]</b></p></body>
</html>
