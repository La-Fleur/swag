<html>
<head><title> "Remove TSR" by LARRY HADLEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ok i would like some info on how to remove a tsr

Follow these steps:

   I tested out some TSR code today and came up With this. It's been
   debugged and Functions as advertised. not as clean as I'd like,
   but it works.
}

{**********************************************
 * CLICK.PAS by Larry Hadley  2-02-1993       *
 * donated to the public domain. if you use   *
 * this code or derive from it, credit would  *
 * be appreciated.                            *
 ********************************************** }

{$S-,N-}
{$M 1024, 0, 0}
</i></font><font color="#FF0000"><b>Program </b></font>CLICK<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Crt<font color="#000080">,</font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>SavedInt09h<font color="#000080">,
  </font>SavedInt66h  <font color="#000080">:</font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>keyClick<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Sound<font color="#000080">(</font><font color="#800000">50</font><font color="#000080">);
  </font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>NoSound<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Int09h<font color="#000080">; </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>keyClick<font color="#000080">;           </font><font color="#008000"><i>{ Sound click everytime called -
                        this is clumsy because key releases as
                        well as keypresses are signalled. Good
                        thing this is For demo only! :-) }
  </i></font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">pushf            </font><font color="#008000"><i>{ push flags to simulate &quot;int&quot; call }
    </i></font><font color="#FF00FF">call SavedInt09h </font><font color="#008000"><i>{ pass control to original int09 handler -
                       necessary to allow keyboard use. Also
                       demo's chaining of interrupts. }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Int66h<font color="#000080">(</font>AX<font color="#000080">, </font>BX<font color="#000080">, </font>CX<font color="#000080">, </font>DX<font color="#000080">, </font>SI<font color="#000080">, </font>DI<font color="#000080">, </font>DS<font color="#000080">, </font>ES<font color="#000080">, </font>BP<font color="#000080">:</font>Word<font color="#000080">); </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>int09new <font color="#000080">:</font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>AX<font color="#000080">&lt;&gt;</font><font color="#800000">$FFFF </font><font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;            </font><font color="#008000"><i>{ not our call, leave }

  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, </font>int09new<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>int09new<font color="#000080">&lt;&gt;@</font>int09h <font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;            </font><font color="#008000"><i>{ interrupt vectors have been changed. }

  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, </font>SavedInt09h<font color="#000080">); </font><font color="#008000"><i>{ restore interrupt vectors }
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$66</font><font color="#000080">, </font>SavedInt66h<font color="#000080">);

  </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$16</font><font color="#000080">] := </font>BX<font color="#000080">; </font><font color="#008000"><i>{ modify PSP to return to calling }
  </i></font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$0A</font><font color="#000080">] := </font>DI<font color="#000080">; </font><font color="#008000"><i>{ Program... }
  </i></font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$0C</font><font color="#000080">] := </font>ES<font color="#000080">;

  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov ah, $50
    mov bx, PrefixSeg
    push ds
    int $21            </font><font color="#008000"><i>{ set conText }
    </i></font><font color="#FF00FF">pop ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>AX <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;        </font><font color="#008000"><i>{ tell caller &quot;no error&quot; }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin   </b></font><font color="#008000"><i>{ main - t.s.r. init code }
  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, </font>SavedInt09h<font color="#000080">);
  </font>GetIntVec<font color="#000080">(</font><font color="#800000">$66</font><font color="#000080">, </font>SavedInt66h<font color="#000080">);

  </font>SetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">#</font>Int09h<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">$66</font><font color="#000080">, @</font>Int66h<font color="#000080">);

  </font>Writeln<font color="#000080">(</font><font color="#800000">'Click TSR installed.'</font><font color="#000080">);

  </font>Keep<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{************************************************
 * CLICKU.PAS by Larry Hadley  2-02-1993        *
 * CLICK T.S.R. removal Program                 *
 * released into the public domain. if you use  *
 * this code or derive from it, credit would be *
 * appreciated.                                 *
 ************************************************}

{$S-,N-}
</i></font><font color="#FF0000"><b>Program </b></font>CLICKU<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>rtn_seg<font color="#000080">,
  </font>rtn_ofs  <font color="#000080">: </font>Word<font color="#000080">;
  </font>return   <font color="#000080">: </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>Label </b></font>int66_error<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Exit_Label<font color="#000080">; </font><font color="#008000"><i>{ ...to provide an address For Dos return to }
</i></font><font color="#FF0000"><b>begin
  </b></font>Halt<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);  </font><font color="#008000"><i>{ I haven't been able to establish For sure that
              this code regains control here. BTW, Brian I have
              code to save DS and restore upon return to this
              Program if you're interested.  This would allow
              using global Variables to save SS:SP. Int 21h func
              $4C destroys DS (and just about everything else)
              on Exit...}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>return <font color="#000080">:= @</font>exit_Label<font color="#000080">;
  </font>rtn_seg <font color="#000080">:= </font>SEG<font color="#000080">(</font>return<font color="#000080">^);
  </font>rtn_ofs <font color="#000080">:= </font>ofS<font color="#000080">(</font>return<font color="#000080">^);
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov ax, $FFFF
    mov bx, PrefixSeg
    mov es, rtn_seg
    mov di, rtn_ofs      </font><font color="#008000"><i>{ pass parms in Registers ax, bx, es, di}
    </i></font><font color="#FF00FF">int $66              </font><font color="#008000"><i>{ call i.s.r. uninstall Function }
    </i></font><font color="#FF00FF">cmp ax, 0
    jne int66_error      </font><font color="#008000"><i>{ i.s.r. has returned error }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Click TSR uninstalled.'</font><font color="#000080">);
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov ah, $4C
    int $21              </font><font color="#008000"><i>{ Dos terminate }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>int66_error<font color="#000080">:
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Error removing TSR.'</font><font color="#000080">);
  </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p></body>
</html>
