<html>
<head><title> "Sample TSR Routine" by CHRIS PRIEDE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0011.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
CHRIS PRIEDE

&gt; Can anyone give me any samples of TSR routines?

    My old example of a generic keyboard TSR has mysteriously
disappeared, so I had to write a new one. This is as simple TSR as it
can be: no stack switching, no DOS reentrancy check. In the form
presented here it simply beeps when you press Shift-Esc. Set your own
hotkey and rewrite TsrMain to turn it into something useful.

    Use Crt unit for screen writes and don't try to access files. Since
it uses foreground program's stack, you shouldn't use deeply nested or
recursive function calls, or declare large local variables. This is more
on demo side, but will get you started.
}

</i></font><font color="#FF0000"><b>program </b></font>GenericKeyboardTSR<font color="#000080">;
</font><font color="#008000"><i>{$M 0, 0, 512}      { reduce memory size }
{$S-,R-}         { can't use stack or range checking in TSR }


</i></font><font color="#FF0000"><b>uses
  </b></font>Dos<font color="#000080">, </font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>RtShift       <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;
  </font>LtShift       <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;
  </font>AnyShift      <font color="#000080">= </font>RtShift <font color="#000080">+ </font>LtShift<font color="#000080">;
  </font>Ctrl          <font color="#000080">= </font><font color="#800000">$04</font><font color="#000080">;
  </font>Alt           <font color="#000080">= </font><font color="#800000">$08</font><font color="#000080">;

  </font>HotKey        <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;      </font><font color="#008000"><i>{ Hotkey scan code, Esc }
  </i></font>HotShiftState <font color="#000080">= </font>AnyShift<font color="#000080">; </font><font color="#008000"><i>{ Hotkey shift state }
  </i></font>FakeFlags     <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;        </font><font color="#008000"><i>{ Fake flags for interrupt call }

</i></font><font color="#FF0000"><b>type
  </b></font>IntProc <font color="#000080">= </font><font color="#FF0000"><b>procedure</b></font><font color="#000080">(</font>Flags <font color="#000080">: </font>word<font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>OldInt09 <font color="#000080">: </font>IntProc<font color="#000080">;
  </font>Popped   <font color="#000080">: </font>boolean<font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>Enable<font color="#000080">; </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);      </font><font color="#008000"><i>{ inline macro -- STI }

</i></font><font color="#FF0000"><b>procedure </b></font>TsrMain<font color="#000080">;      </font><font color="#008000"><i>{ TSR main procedure, executed on hotkey }
</i></font><font color="#FF0000"><b>begin
  </b></font>Sound<font color="#000080">(</font><font color="#800000">400</font><font color="#000080">);           </font><font color="#008000"><i>{ Make noise (replace with something useful) }
  </i></font>Delay<font color="#000080">(</font><font color="#800000">100</font><font color="#000080">);
  </font>NoSound<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>NewInt09<font color="#000080">; </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Enable<font color="#000080">;               </font><font color="#008000"><i>{ Allow other interrupts }
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>Popped<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">] = </font>HotKey<font color="#000080">) </font><font color="#FF0000"><b>and  </b></font><font color="#008000"><i>{ if not in TSR already }
     </i></font><font color="#000080">(</font>Mem<font color="#000080">[</font><font color="#800000">$40 </font><font color="#000080">: </font><font color="#800000">$17</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F </font><font color="#000080">= </font>HotShiftState<font color="#000080">) </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ and hotkey detected }
  </i></font><font color="#FF0000"><b>begin
    </b></font>Popped <font color="#000080">:= </font>true<font color="#000080">;     </font><font color="#008000"><i>{ set Popped to avoid re-entry }
    </i></font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$80</font><font color="#000080">;      </font><font color="#008000"><i>{ reset keyboard }
    </i></font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] := </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] </font><font color="#FF0000"><b>and not </b></font><font color="#800000">$80</font><font color="#000080">;
    </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;   </font><font color="#008000"><i>{ signal end of interrupt }
    </i></font>TsrMain<font color="#000080">;            </font><font color="#008000"><i>{ run TSR main procedure }
    </i></font>Popped <font color="#000080">:= </font>false<font color="#000080">;    </font><font color="#008000"><i>{ clear Popped and return }
  </i></font><font color="#FF0000"><b>end
  else
    </b></font>OldInt09<font color="#000080">(</font>FakeFlags<font color="#000080">); </font><font color="#008000"><i>{ call old handler }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin           </b></font><font color="#008000"><i>{ installation }
  </i></font>Popped <font color="#000080">:= </font>false<font color="#000080">;
  </font>GetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, </font>pointer<font color="#000080">(@</font>OldInt09<font color="#000080">)); </font><font color="#008000"><i>{ Install int. handler}
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, @</font>NewInt09<font color="#000080">);
  </font>Keep<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);    </font><font color="#008000"><i>{ stay resident }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TSR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0011.PAS">Original</a><b>]</b></p></body>
</html>
