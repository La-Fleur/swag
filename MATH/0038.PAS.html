<html>
<head><title> "Trapping 8087 Errors" by DEVEN HICKINGBOTHAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0038.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I know that in pascal there is some way to create the Program
&gt; from crashing if the users does something wrong.  I need to know how to
To prevent Type errors on input always use Strings and convert them
afterwards using the VAL Procedure.

Try this to trap arithmetic errors.
}

{$N+,G+}
</i></font><font color="#FF0000"><b>Unit </b></font>op8087<font color="#000080">;

</font><font color="#008000"><i>{ The routines below duplicate two Op8087 routines For use in TPW, +
  Exceptions8087 and Error8087.  These routines are helpful when +
  doing Real math and you don't want to explicitly check For divide +
  by zero, underflow, and overflow.  Need to use the compiler +
  directives N+ and G+.  See OPro or 8087 documentation For a complete +
  description of the 8087 status Word returned by Error8087.

  Do not embed Error8087 in a Write statement as the 8087 status Word +
  will be cleared, and the result meaningless.

  Version 1.00 09/17/92

  Deven Hickingbotham, Tamarack Associates, 72365,46

  -----------------------------------------------------------------
  Added infinity and NAN 'Constants' and created Unit December 1992
  Kevin Whitefoot, Aasgaten 45, N-3060 Svelvik, Norway.

  After this Unit has initialized 8087 exceptions will be OFF and the NAN
  and INF Variables set to NAN and INF respectively.  These Variables can be
  used in comparisons or to indicate uninitialized Variables.  The Variables
  are of Type extended but are compatible With singles and doubles too.  You
  cannot assign the value in INF or NAN to a Real because the Real cannot
  represent these values (if you do you will get error 105).
  -----------------------------------------------------------------

}


</i></font><font color="#FF0000"><b>Interface

Procedure </b></font>Exceptions8087<font color="#000080">(</font><font color="#FF0000"><b>On </b></font><font color="#000080">: </font>Boolean<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>Error8087 <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{Assumes $G+, 287 or better  }

</i></font><font color="#FF0000"><b>Function </b></font>isdoublenan<font color="#000080">(</font>r <font color="#000080">: </font>double<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>issinglenan<font color="#000080">(</font>r <font color="#000080">: </font>single<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#008000"><i>{These two Functions are used instead of direct comparisons With NANs as
all numbers are = to NAN; very strange}

</i></font><font color="#FF0000"><b>Const
  </b></font>nanpattern <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">=
    (</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">,</font><font color="#800000">$FF</font><font color="#000080">);
  </font><font color="#008000"><i>{ This is the bit pattern of an extended 'not a number'.  The +
    Variable NAN is overlaid on this as we cannot create a NAN in a +
    normal Constant declaration.}
</i></font><font color="#FF0000"><b>Var
  </b></font>nan <font color="#000080">: </font>extended <font color="#FF0000"><b>Absolute </b></font>nanpattern<font color="#000080">;
  </font><font color="#008000"><i>{ not a number'; this is convenient For uninitialized numbers, +
    errors and so on, parsers can be designed to return this when +
    the input is not a number so that the error remains visible even +
    if the user or Program takes no corrective action}
  </i></font>inf <font color="#000080">: </font>extended<font color="#000080">;
  </font><font color="#008000"><i>{ The initialization of this routine deliberately executes a +
    divide by zero so as to create and infinity and stores it here +
    For general use.}

  </i></font>singlenan <font color="#000080">: </font>single<font color="#000080">;
  </font>doublenan <font color="#000080">: </font>double<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Function </b></font>isdoublenan<font color="#000080">(</font>r <font color="#000080">: </font>double<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>l1 <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>LongInt <font color="#FF0000"><b>Absolute </b></font>singlenan<font color="#000080">;
  </font>l2 <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>LongInt <font color="#FF0000"><b>Absolute </b></font>r<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>isdoublenan <font color="#000080">:= (</font>l1<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] = </font>l2<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>l1<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font>l2<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>issinglenan<font color="#000080">(</font>r <font color="#000080">: </font>single<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>l1 <font color="#000080">: </font>LongInt <font color="#FF0000"><b>Absolute </b></font>singlenan<font color="#000080">;
  </font>l2 <font color="#000080">: </font>LongInt <font color="#FF0000"><b>Absolute </b></font>r<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>issinglenan <font color="#000080">:= </font>l1 <font color="#000080">= </font>l2<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Exceptions8087<font color="#000080">(</font><font color="#FF0000"><b>On </b></font><font color="#000080">: </font>Boolean<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>CtrlWord <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">MOV   AL, On
  or    AL, AL
  JZ    @ExceptionsOff

  MOV   CtrlWord, 0372H    </font><font color="#008000"><i>{ Unmask IM, ZM, OM }
  </i></font><font color="#FF00FF">JMP   #ExceptionsDone

 @ExceptionsOff:
  FSTCW CtrlWord           </font><font color="#008000"><i>{ Get current control Word }
  </i></font><font color="#FF00FF">or    CtrlWord, 00FFh    </font><font color="#008000"><i>{ Mask all exceptions }

 </i></font><font color="#FF00FF">@ExceptionsDone:
  FLDCW CtrlWord           </font><font color="#008000"><i>{ Change 8087 control Word }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>Error8087 <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;   </font><font color="#008000"><i>{Assumes $G+, 287 or better  }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">FSTSW AX        </font><font color="#008000"><i>{ Get current status Word  }
  </i></font><font color="#FF00FF">and   AX, 03Fh  </font><font color="#008000"><i>{ Just the exception indicators }
  </i></font><font color="#FF00FF">FCLEX           </font><font color="#008000"><i>{ Clear exception indicators  }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Exceptions8087<font color="#000080">(</font>False<font color="#000080">);
  </font>inf <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font><font color="#008000"><i>{ Use a Variable not a Constant or the expression will be
              resolved at compile time and the compiler will complain }
  </i></font>inf <font color="#000080">:= </font><font color="#800000">1 </font><font color="#000080">/ </font>inf<font color="#000080">;
  </font>singlenan <font color="#000080">:= </font>nan<font color="#000080">;
  </font>doublenan <font color="#000080">:= </font>nan<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0038.PAS">Original</a><b>]</b></p></body>
</html>
