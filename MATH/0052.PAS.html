<html>
<head><title> "Real Calculations" by SEAN PALMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0052.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;How about using fixed point math to speed things up even more - not
&gt;everyone has a math coproccesor (either my routines suck, or REAL
&gt;calculations aren't fast, BTW I got most of my routines from Flights of
&gt;Fantasy).

&gt; Well, its a combination, from my experience of flights of
&gt; fantasy, I'd say that it really isn't too speedy.  But then REAL
&gt; calculations are not notoriously quick either.  I think FOF is a Good
&gt; resource, it teaches 3d fundamentals well, and in general is pretty
&gt; nice, but the code is a little slow...  What I ended up doing is
&gt; reading through the book and writing from what they said. (for the most
&gt; part I skipped their code bits..)  I am not familiar with fixed point
&gt; math... I know what it is, but don't know how to implement it... Could
&gt; ya help a little?

Just (in this implementation) a longint, with the high 16 bits representing the
integer part, and the low 16 representing the binary fraction (to 16 binary
places). Basically a 32-bit binary number with the binary point fixed at the
16th position.

Adding and subtracting such numbers is just like working with straight
longints. No problem. But when multiplying and dividing the number must be
shifted so the binary point's still in the right place.

These are inline procedures, for speed, and only work on 386 or better,
to save me headaches while coding this sucker.
}

</i></font><font color="#FF0000"><b>type
  </b></font>fixed <font color="#000080">= </font><font color="#FF0000"><b>record
  case </b></font>byte <font color="#FF0000"><b>of
    </b></font><font color="#800000">0 </font><font color="#000080">: (</font>f <font color="#000080">: </font>word<font color="#000080">;
         </font>i <font color="#000080">: </font>integer<font color="#000080">);
    </font><font color="#800000">1 </font><font color="#000080">: (</font>l <font color="#000080">: </font>longint<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{typecast parms to longint, result to fixed}
</i></font><font color="#FF0000"><b>function </b></font>fixedDiv<font color="#000080">(</font>d1<font color="#000080">, </font>d2 <font color="#000080">: </font>longint<font color="#000080">) : </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>inline</b></font><font color="#000080">(
  </font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$59</font><font color="#000080">/               </font><font color="#008000"><i>{pop ecx}
  </i></font><font color="#800000">$58</font><font color="#000080">/                   </font><font color="#008000"><i>{pop ax}
  </i></font><font color="#800000">$5A</font><font color="#000080">/                   </font><font color="#008000"><i>{pop dx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$0F</font><font color="#000080">/</font><font color="#800000">$BF</font><font color="#000080">/</font><font color="#800000">$D2</font><font color="#000080">/       </font><font color="#008000"><i>{movsx edx,dx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$C1</font><font color="#000080">/</font><font color="#800000">$E0</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">/       </font><font color="#008000"><i>{shl eax,16}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$F7</font><font color="#000080">/</font><font color="#800000">$F9</font><font color="#000080">/           </font><font color="#008000"><i>{idiv ecx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$0F</font><font color="#000080">/</font><font color="#800000">$A4</font><font color="#000080">/</font><font color="#800000">$C2</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">);  </font><font color="#008000"><i>{shld edx,eax,16}   {no rounding}

{typecast parms to longint, result to fixed}
</i></font><font color="#FF0000"><b>function </b></font>fixedMul<font color="#000080">(</font>d1<font color="#000080">, </font>d2 <font color="#000080">: </font>longint<font color="#000080">) : </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>inline</b></font><font color="#000080">(
  </font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$59</font><font color="#000080">/               </font><font color="#008000"><i>{pop ecx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$58</font><font color="#000080">/               </font><font color="#008000"><i>{pop eax}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$F7</font><font color="#000080">/</font><font color="#800000">$E9</font><font color="#000080">/           </font><font color="#008000"><i>{imul ecx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$C1</font><font color="#000080">/</font><font color="#800000">$E8</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">);      </font><font color="#008000"><i>{shr eax,16}

</i></font><font color="#FF0000"><b>function </b></font>scaleFixed<font color="#000080">(</font>i<font color="#000080">, </font>m<font color="#000080">, </font>d <font color="#000080">: </font>longint<font color="#000080">) : </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>inline</b></font><font color="#000080">(  </font><font color="#008000"><i>{mul, then div, no ovfl}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$5B</font><font color="#000080">/               </font><font color="#008000"><i>{pop ebx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$59</font><font color="#000080">/               </font><font color="#008000"><i>{pop ecx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$58</font><font color="#000080">/               </font><font color="#008000"><i>{pop eax}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$F7</font><font color="#000080">/</font><font color="#800000">$E9</font><font color="#000080">/           </font><font color="#008000"><i>{imul ecx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$F7</font><font color="#000080">/</font><font color="#800000">$FB</font><font color="#000080">/           </font><font color="#008000"><i>{idiv ebx}
  </i></font><font color="#800000">$66</font><font color="#000080">/</font><font color="#800000">$0F</font><font color="#000080">/</font><font color="#800000">$A4</font><font color="#000080">/</font><font color="#800000">$C2</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">);  </font><font color="#008000"><i>{shld edx,eax,16}

</i></font><font color="#FF0000"><b>var
  </b></font>a<font color="#000080">, </font>b <font color="#000080">: </font>fixed<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>a<font color="#000080">.</font>l <font color="#000080">:= </font><font color="#800000">$30000</font><font color="#000080">;
  </font>outputFixed<font color="#000080">(</font>a<font color="#000080">.</font>l <font color="#000080">+ </font>fixedDiv<font color="#000080">(</font>a<font color="#000080">.</font>l<font color="#000080">, </font><font color="#800000">$20000</font><font color="#000080">));
  </font>b<font color="#000080">.</font>l <font color="#000080">:= </font>fixedMul<font color="#000080">(</font>a<font color="#000080">.</font>l<font color="#000080">, </font><font color="#800000">$48000</font><font color="#000080">);
  </font>outputFixed<font color="#000080">(</font>b<font color="#000080">.</font>l<font color="#000080">);
  </font>outputFixed<font color="#000080">(</font>fixedDiv<font color="#000080">(</font>b<font color="#000080">.</font>l<font color="#000080">, </font><font color="#800000">$60000 </font><font color="#000080">+ </font>a<font color="#000080">.</font>l<font color="#000080">));
  </font>outputFixed<font color="#000080">(</font>scaleFixed<font color="#000080">(</font><font color="#800000">$30000</font><font color="#000080">, </font><font color="#800000">$48000</font><font color="#000080">, </font><font color="#800000">$60000</font><font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>I<font color="#800000">'ll let you figure out outputFixed for yourself.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0052.PAS">Original</a><b>]</b></p></body>
</html>
