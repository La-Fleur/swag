<html>
<head><title> "Nice Expression Parser" by LARS FOSDAL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>PROGRAM </b></font>Expr<font color="#000080">;

</font><font color="#008000"><i>{
  Simple recursive expression parser based on the TCALC example of TP3.
  Written by Lars Fosdal 1987
  Released to the public domain 1993
}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>Eval<font color="#000080">(</font>Formula <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;    </font><font color="#008000"><i>{ Expression to be evaluated}
               </i></font><font color="#FF0000"><b>VAR </b></font>Value   <font color="#000080">: </font>Real<font color="#000080">;      </font><font color="#008000"><i>{ Return value }
               </i></font><font color="#FF0000"><b>VAR </b></font>ErrPos  <font color="#000080">: </font>Integer<font color="#000080">);  </font><font color="#008000"><i>{ error position }
  </i></font><font color="#FF0000"><b>CONST
    </b></font>Digit<font color="#000080">: </font><font color="#FF0000"><b>Set of </b></font>Char <font color="#000080">= [</font><font color="#800000">'0'</font><font color="#000080">..</font><font color="#800000">'9'</font><font color="#000080">];
  </font><font color="#FF0000"><b>VAR
    </b></font>Posn  <font color="#000080">: </font>Integer<font color="#000080">;   </font><font color="#008000"><i>{ Current position in Formula}
    </i></font>CurrChar   <font color="#000080">: </font>Char<font color="#000080">;      </font><font color="#008000"><i>{ character at Posn in Formula }


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ParseNext<font color="#000080">; </font><font color="#008000"><i>{ returnerer neste tegn i Formulaen  }
</i></font><font color="#FF0000"><b>BEGIN
  REPEAT
    </b></font>Posn<font color="#000080">:=</font>Posn<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>IF </b></font>Posn<font color="#000080">&lt;=</font>Length<font color="#000080">(</font>Formula<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>CurrChar<font color="#000080">:=</font>Formula<font color="#000080">[</font>Posn<font color="#000080">]
     </font><font color="#FF0000"><b>ELSE </b></font>CurrChar<font color="#000080">:=^</font>M<font color="#000080">;
  </font><font color="#FF0000"><b>UNTIL </b></font>CurrChar<font color="#000080">&lt;&gt;</font><font color="#800000">' '</font><font color="#000080">;
</font><font color="#FF0000"><b>END  </b></font><font color="#008000"><i>{ ParseNext }</i></font><font color="#000080">;


</font><font color="#FF0000"><b>FUNCTION </b></font>add_subt<font color="#000080">: </font>Real<font color="#000080">;
  </font><font color="#FF0000"><b>VAR
    </b></font>E   <font color="#000080">: </font>Real<font color="#000080">;
    </font>Opr <font color="#000080">: </font>Char<font color="#000080">;

  </font><font color="#FF0000"><b>FUNCTION </b></font>mult_DIV<font color="#000080">: </font>Real<font color="#000080">;
    </font><font color="#FF0000"><b>VAR
      </b></font>S   <font color="#000080">: </font>Real<font color="#000080">;
      </font>Opr <font color="#000080">: </font>Char<font color="#000080">;

    </font><font color="#FF0000"><b>FUNCTION </b></font>Power<font color="#000080">: </font>Real<font color="#000080">;
      </font><font color="#FF0000"><b>VAR
        </b></font>T <font color="#000080">: </font>Real<font color="#000080">;

      </font><font color="#FF0000"><b>FUNCTION </b></font>SignedOp<font color="#000080">: </font>Real<font color="#000080">;

        </font><font color="#FF0000"><b>FUNCTION </b></font>UnsignedOp<font color="#000080">: </font>Real<font color="#000080">;
          </font><font color="#FF0000"><b>TYPE
            </b></font>StdFunc <font color="#000080">= (</font>fabs<font color="#000080">,    </font>fsqrt<font color="#000080">, </font>fsqr<font color="#000080">, </font>fsin<font color="#000080">, </font>fcos<font color="#000080">,
                       </font>farctan<font color="#000080">, </font>fln<font color="#000080">,   </font>flog<font color="#000080">, </font>fexp<font color="#000080">, </font>ffact<font color="#000080">);
            </font>StdFuncList <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font>StdFunc<font color="#000080">] </font><font color="#FF0000"><b>of String</b></font><font color="#000080">[</font><font color="#800000">6</font><font color="#000080">];

          </font><font color="#FF0000"><b>CONST
            </b></font>StdFuncName<font color="#000080">: </font>StdFuncList <font color="#000080">=
            (</font><font color="#800000">'ABS'</font><font color="#000080">,</font><font color="#800000">'SQRT'</font><font color="#000080">,</font><font color="#800000">'SQR'</font><font color="#000080">,</font><font color="#800000">'SIN'</font><font color="#000080">,</font><font color="#800000">'COS'</font><font color="#000080">,
            </font><font color="#800000">'ARCTAN'</font><font color="#000080">,</font><font color="#800000">'LN'</font><font color="#000080">,</font><font color="#800000">'LOG'</font><font color="#000080">,</font><font color="#800000">'EXP'</font><font color="#000080">,</font><font color="#800000">'FACT'</font><font color="#000080">);
          </font><font color="#FF0000"><b>VAR
            </b></font>E<font color="#000080">, </font>L<font color="#000080">, </font>Start    <font color="#000080">: </font>Integer<font color="#000080">;
            </font>Funnet         <font color="#000080">: </font>Boolean<font color="#000080">;
            </font>F              <font color="#000080">: </font>Real<font color="#000080">;
            </font>Sf             <font color="#000080">: </font>StdFunc<font color="#000080">;

              </font><font color="#FF0000"><b>FUNCTION </b></font>Fact<font color="#000080">(</font>I<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
              </font><font color="#FF0000"><b>BEGIN
                IF </b></font>I <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN </b></font>Fact<font color="#000080">:=</font>I<font color="#000080">*</font>Fact<font color="#000080">(</font>I<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">); </font><font color="#FF0000"><b>END
                ELSE </b></font>Fact<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
              </font><font color="#FF0000"><b>END  </b></font><font color="#008000"><i>{ Fact }</i></font><font color="#000080">;

          </font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{ FUNCTION UnsignedOp }
            </i></font><font color="#FF0000"><b>IF </b></font>CurrChar <font color="#FF0000"><b>in </b></font>Digit <font color="#FF0000"><b>THEN
            BEGIN
              </b></font>Start<font color="#000080">:=</font>Posn<font color="#000080">;
              </font><font color="#FF0000"><b>REPEAT </b></font>ParseNext <font color="#FF0000"><b>UNTIL not </b></font><font color="#000080">(</font>CurrChar <font color="#FF0000"><b>in </b></font>Digit<font color="#000080">);
              </font><font color="#FF0000"><b>IF </b></font>CurrChar<font color="#000080">=</font><font color="#800000">'.' </font><font color="#FF0000"><b>THEN REPEAT </b></font>ParseNext <font color="#FF0000"><b>UNTIL not </b></font><font color="#000080">(</font>CurrChar <font color="#FF0000"><b>in </b></font>Digit<font color="#000080">);
              </font><font color="#FF0000"><b>IF </b></font>CurrChar<font color="#000080">=</font><font color="#800000">'E' </font><font color="#FF0000"><b>THEN
              BEGIN
                </b></font>ParseNext<font color="#000080">;
                </font><font color="#FF0000"><b>REPEAT </b></font>ParseNext <font color="#FF0000"><b>UNTIL not </b></font><font color="#000080">(</font>CurrChar <font color="#FF0000"><b>in </b></font>Digit<font color="#000080">);
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
              </font>Val<font color="#000080">(</font>Copy<font color="#000080">(</font>Formula<font color="#000080">,</font>Start<font color="#000080">,</font>Posn<font color="#000080">-</font>Start<font color="#000080">),</font>F<font color="#000080">,</font>ErrPos<font color="#000080">);
            </font><font color="#FF0000"><b>END ELSE
            IF </b></font>CurrChar<font color="#000080">=</font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN
            BEGIN
              </b></font>ParseNext<font color="#000080">;
              </font>F<font color="#000080">:=</font>add_subt<font color="#000080">;
              </font><font color="#FF0000"><b>IF </b></font>CurrChar<font color="#000080">=</font><font color="#800000">')' </font><font color="#FF0000"><b>THEN </b></font>ParseNext <font color="#FF0000"><b>ELSE </b></font>ErrPos<font color="#000080">:=</font>Posn<font color="#000080">;
            </font><font color="#FF0000"><b>END ELSE
            BEGIN
              </b></font>Funnet<font color="#000080">:=</font>False<font color="#000080">;
              </font><font color="#FF0000"><b>FOR </b></font>sf<font color="#000080">:=</font>fabs <font color="#FF0000"><b>TO </b></font>ffact <font color="#FF0000"><b>DO
              IF not </b></font>Funnet <font color="#FF0000"><b>THEN
              BEGIN
                </b></font>l<font color="#000080">:=</font>Length<font color="#000080">(</font>StdFuncName<font color="#000080">[</font>sf<font color="#000080">]);
                </font><font color="#FF0000"><b>IF </b></font>Copy<font color="#000080">(</font>Formula<font color="#000080">,</font>Posn<font color="#000080">,</font>l<font color="#000080">)=</font>StdFuncName<font color="#000080">[</font>sf<font color="#000080">] </font><font color="#FF0000"><b>THEN
                BEGIN
                  </b></font>Posn<font color="#000080">:=</font>Posn<font color="#000080">+</font>l<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">; </font>ParseNext<font color="#000080">;
                  </font>f<font color="#000080">:=</font>UnsignedOp<font color="#000080">;
                  </font><font color="#FF0000"><b>CASE </b></font>sf <font color="#FF0000"><b>of
                    </b></font>fabs<font color="#000080">:     </font>f<font color="#000080">:=</font>abs<font color="#000080">(</font>f<font color="#000080">);
                    </font>fsqrt<font color="#000080">:    </font>f<font color="#000080">:=</font>SqrT<font color="#000080">(</font>f<font color="#000080">);
                    </font>fsqr<font color="#000080">:     </font>f<font color="#000080">:=</font>Sqr<font color="#000080">(</font>f<font color="#000080">);
                    </font>fsin<font color="#000080">:     </font>f<font color="#000080">:=</font>Sin<font color="#000080">(</font>f<font color="#000080">);
                    </font>fcos<font color="#000080">:     </font>f<font color="#000080">:=</font>Cos<font color="#000080">(</font>f<font color="#000080">);
                    </font>farctan<font color="#000080">:  </font>f<font color="#000080">:=</font>ArcTan<font color="#000080">(</font>f<font color="#000080">);
                    </font>fln <font color="#000080">:     </font>f<font color="#000080">:=</font>LN<font color="#000080">(</font>f<font color="#000080">);
                    </font>flog<font color="#000080">:     </font>f<font color="#000080">:=</font>LN<font color="#000080">(</font>f<font color="#000080">)/</font>LN<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">);
                    </font>fexp<font color="#000080">:     </font>f<font color="#000080">:=</font>EXP<font color="#000080">(</font>f<font color="#000080">);
                    </font>ffact<font color="#000080">:    </font>f<font color="#000080">:=</font>fact<font color="#000080">(</font>Trunc<font color="#000080">(</font>f<font color="#000080">));
                  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
                  </font>Funnet<font color="#000080">:=</font>True<font color="#000080">;
                </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
              </font><font color="#FF0000"><b>IF not </b></font>Funnet <font color="#FF0000"><b>THEN
              BEGIN
                </b></font>ErrPos<font color="#000080">:=</font>Posn<font color="#000080">;
                </font>f<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
            </font>UnsignedOp<font color="#000080">:=</font>F<font color="#000080">;
          </font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{ UnsignedOp}</i></font><font color="#000080">;

        </font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{ SignedOp }
          </i></font><font color="#FF0000"><b>IF </b></font>CurrChar<font color="#000080">=</font><font color="#800000">'-' </font><font color="#FF0000"><b>THEN
          BEGIN
            </b></font>ParseNext<font color="#000080">; </font>SignedOp<font color="#000080">:=-</font>UnsignedOp<font color="#000080">;
          </font><font color="#FF0000"><b>END ELSE </b></font>SignedOp<font color="#000080">:=</font>UnsignedOp<font color="#000080">;
        </font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{ SignedOp }</i></font><font color="#000080">;

      </font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{ Power }
        </i></font>T<font color="#000080">:=</font>SignedOp<font color="#000080">;
        </font><font color="#FF0000"><b>WHILE </b></font>CurrChar<font color="#000080">=</font><font color="#800000">'^' </font><font color="#FF0000"><b>DO
        BEGIN
          </b></font>ParseNext<font color="#000080">;
          </font><font color="#FF0000"><b>IF </b></font>t<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>THEN </b></font>t<font color="#000080">:=</font>EXP<font color="#000080">(</font>LN<font color="#000080">(</font>abs<font color="#000080">(</font>t<font color="#000080">))*</font>SignedOp<font color="#000080">) </font><font color="#FF0000"><b>ELSE </b></font>t<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font>Power<font color="#000080">:=</font>t<font color="#000080">;
      </font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{ Power }</i></font><font color="#000080">;


    </font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{ mult_DIV }
      </i></font>s<font color="#000080">:=</font>Power<font color="#000080">;
      </font><font color="#FF0000"><b>WHILE </b></font>CurrChar <font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">'*'</font><font color="#000080">,</font><font color="#800000">'/'</font><font color="#000080">] </font><font color="#FF0000"><b>DO
      BEGIN
        </b></font>Opr<font color="#000080">:=</font>CurrChar<font color="#000080">; </font>ParseNext<font color="#000080">;
        </font><font color="#FF0000"><b>CASE </b></font>Opr <font color="#FF0000"><b>of
          </b></font><font color="#800000">'*'</font><font color="#000080">: </font>s<font color="#000080">:=</font>s<font color="#000080">*</font>Power<font color="#000080">;
          </font><font color="#800000">'/'</font><font color="#000080">: </font>s<font color="#000080">:=</font>s<font color="#000080">/</font>Power<font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font>mult_DIV<font color="#000080">:=</font>s<font color="#000080">;
    </font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{ mult_DIV }</i></font><font color="#000080">;

  </font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{ add_subt }
    </i></font>E<font color="#000080">:=</font>mult_DIV<font color="#000080">;
    </font><font color="#FF0000"><b>WHILE </b></font>CurrChar <font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">'+'</font><font color="#000080">,</font><font color="#800000">'-'</font><font color="#000080">] </font><font color="#FF0000"><b>DO
    BEGIN
      </b></font>Opr<font color="#000080">:=</font>CurrChar<font color="#000080">; </font>ParseNext<font color="#000080">;
      </font><font color="#FF0000"><b>CASE </b></font>Opr <font color="#FF0000"><b>of
        </b></font><font color="#800000">'+'</font><font color="#000080">: </font>e<font color="#000080">:=</font>e<font color="#000080">+</font>mult_DIV<font color="#000080">;
        </font><font color="#800000">'-'</font><font color="#000080">: </font>e<font color="#000080">:=</font>e<font color="#000080">-</font>mult_DIV<font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>add_subt<font color="#000080">:=</font>E<font color="#000080">;
  </font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{ add_subt }</i></font><font color="#000080">;

</font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{PROC Eval}
  </i></font><font color="#FF0000"><b>IF </b></font>Formula<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]=</font><font color="#800000">'.'
  </font><font color="#FF0000"><b>THEN </b></font>Formula<font color="#000080">:=</font><font color="#800000">'0'</font><font color="#000080">+</font>Formula<font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>Formula<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]=</font><font color="#800000">'+'
  </font><font color="#FF0000"><b>THEN </b></font>Delete<font color="#000080">(</font>Formula<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>FOR </b></font>Posn<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>Length<font color="#000080">(</font>Formula<font color="#000080">)
  </font><font color="#FF0000"><b>DO </b></font>Formula<font color="#000080">[</font>Posn<font color="#000080">] := </font>Upcase<font color="#000080">(</font>Formula<font color="#000080">[</font>Posn<font color="#000080">]);
  </font>Posn<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>ParseNext<font color="#000080">;
  </font>Value<font color="#000080">:=</font>add_subt<font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>CurrChar<font color="#000080">=^</font>M <font color="#FF0000"><b>THEN </b></font>ErrPos<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>ELSE </b></font>ErrPos<font color="#000080">:=</font>Posn<font color="#000080">;
</font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{PROC Eval}</i></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>Formula <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>Value   <font color="#000080">: </font>Real<font color="#000080">;
  </font>i<font color="#000080">, </font>Err  <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  REPEAT
    </b></font>Writeln<font color="#000080">;
    </font>Write<font color="#000080">(</font><font color="#800000">'Enter formula (empty exits): '</font><font color="#000080">); </font>Readln<font color="#000080">(</font>Formula<font color="#000080">);
    </font><font color="#FF0000"><b>IF </b></font>Formula<font color="#000080">=</font><font color="#800000">'' </font><font color="#FF0000"><b>THEN </b></font>Exit<font color="#000080">;
    </font>Eval<font color="#000080">(</font>Formula<font color="#000080">, </font>Value<font color="#000080">, </font>Err<font color="#000080">);
    </font>Write<font color="#000080">(</font>Formula<font color="#000080">);
    </font><font color="#FF0000"><b>IF </b></font>Err<font color="#000080">=</font><font color="#800000">0
    </font><font color="#FF0000"><b>THEN </b></font>Writeln<font color="#000080">(</font><font color="#800000">' = '</font><font color="#000080">,</font>Value<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">5</font><font color="#000080">)
    </font><font color="#FF0000"><b>ELSE BEGIN
      </b></font>Writeln<font color="#000080">;
      </font><font color="#FF0000"><b>FOR </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>Err<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>DO </b></font>Write<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">);
      </font>Writeln<font color="#000080">(</font><font color="#800000">'^-- Error in formula'</font><font color="#000080">);
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>UNTIL </b></font>False<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p></body>
</html>
