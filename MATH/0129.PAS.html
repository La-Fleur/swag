<html>
<head><title> "EXTENDED Extended MATH" by PASWIZ</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0129.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{   +----------------------------------------------------------------------+
    |                                                                      |
    |   PasWiz  (C) Copyright 1996 Charon Software, All Rights Reserved    |
    |                                                                      |
    +----------------------------------------------------------------------+



Extended math:

   This unit contains procedures and functions that implement extensions to
   Pascal's built-in math (new trig functions, et al) and an arithmetic
   expression evaluator.  The latter is loosely based on EXPR.C from Dr.
   Dobb's Journal, Sept 1985, p.25.

}

</i></font><font color="#FF0000"><b>UNIT </b></font>ExtMath<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

FUNCTION </b></font>ArcCos <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcCosH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcCot <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcCotH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcCsc <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcCscH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcSec <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcSecH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcSin <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcSinH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ArcTanH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Ceil <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CosH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Cot <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CotH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Csc <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>CscH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Deg2Rad <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>e<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Erf <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Fact <font color="#000080">(</font>Number<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Floor <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Log <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Rad2Deg <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION Raise </b></font><font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">; </font>Power<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Sec <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>SecH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>SgnI <font color="#000080">(</font>Number<font color="#000080">: </font>Integer<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>SgnR <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>SinH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Tan <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>TanH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Evaluate <font color="#000080">(</font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>Result<font color="#000080">: </font>Real<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">);



</font><font color="#008000"><i>{ --------------------------------------------------------------------------- }



</i></font><font color="#FF0000"><b>IMPLEMENTATION

</b></font><font color="#008000"><i>{ forward declarations for the Evaluate procedure }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Eval <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">; </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Factor <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">; </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>IsDigit <font color="#000080">(</font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Locase <font color="#000080">(</font>Ch<font color="#000080">: </font>Char<font color="#000080">): </font>Char<font color="#000080">; </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>ParensOk <font color="#000080">(</font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Term <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">; </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>AddParen <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Posn<font color="#000080">, </font>WhichWay<font color="#000080">: </font>Integer<font color="#000080">); </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>FixPrecedence <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#FF0000"><b>FORWARD</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Ceiling ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Ceil <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Number <font color="#000080">= </font>INT<font color="#000080">(</font>Number<font color="#000080">) </font><font color="#FF0000"><b>THEN
      </b></font>Ceil <font color="#000080">:= </font>Number
   <font color="#FF0000"><b>ELSE
      </b></font>Ceil <font color="#000080">:= </font>INT<font color="#000080">(</font>Number<font color="#000080">) + </font><font color="#800000">1.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Floor ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Floor <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Number <font color="#000080">= </font>INT<font color="#000080">(</font>Number<font color="#000080">) </font><font color="#FF0000"><b>THEN
      </b></font>Floor <font color="#000080">:= </font>Number
   <font color="#FF0000"><b>ELSE
      </b></font>Floor <font color="#000080">:= </font>INT<font color="#000080">(</font>Number<font color="#000080">) - </font><font color="#800000">1.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse cosine ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcCos <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font><font color="#000080">(</font>Number <font color="#000080">&lt; -</font><font color="#800000">1.0</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>Number <font color="#000080">&gt; </font><font color="#800000">1.0</font><font color="#000080">) </font><font color="#FF0000"><b>THEN      </b></font><font color="#008000"><i>{ error }
      </i></font>ArcCos <font color="#000080">:= </font><font color="#800000">99999.0
   </font><font color="#FF0000"><b>ELSE
      </b></font>ArcCos <font color="#000080">:= </font>PI <font color="#000080">/ </font><font color="#800000">2.0 </font><font color="#000080">- </font>ArcSin<font color="#000080">(</font>Number<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse hyperbolic cosine ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcCosH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcCosH <font color="#000080">:= </font>Log<font color="#000080">(</font>Number <font color="#000080">+ </font>SQRT<font color="#000080">(</font>SQR<font color="#000080">(</font>Number<font color="#000080">) - </font><font color="#800000">1.0</font><font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse cotangent ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcCot <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcCot <font color="#000080">:= -</font>ARCTAN<font color="#000080">(</font>Number<font color="#000080">) + </font>PI <font color="#000080">/ </font><font color="#800000">2.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse hyperbolic cotangent ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcCotH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcCotH <font color="#000080">:= </font>LN<font color="#000080">((</font>Number <font color="#000080">+ </font><font color="#800000">1.0</font><font color="#000080">) / (</font>Number <font color="#000080">- </font><font color="#800000">1.0</font><font color="#000080">)) / </font><font color="#800000">2.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse cosecant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcCsc <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcCsc <font color="#000080">:= </font>ARCTAN<font color="#000080">(</font><font color="#800000">1.0 </font><font color="#000080">/ </font>SQRT<font color="#000080">(</font><font color="#800000">1.0 </font><font color="#000080">- </font>SQR<font color="#000080">(</font>Number<font color="#000080">)))
      + (</font>SgnR<font color="#000080">(</font>Number<font color="#000080">) - </font><font color="#800000">1.0</font><font color="#000080">) * (</font>PI <font color="#000080">/ </font><font color="#800000">2.0</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse hyperbolic cosecant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcCscH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcCscH <font color="#000080">:= </font>LN<font color="#000080">((</font>SgnR<font color="#000080">(</font>Number<font color="#000080">) * </font>SQRT<font color="#000080">(</font>SQR<font color="#000080">(</font>Number<font color="#000080">) + </font><font color="#800000">1.0</font><font color="#000080">) + </font><font color="#800000">1.0</font><font color="#000080">) / </font>Number<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse secant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcSec <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcSec <font color="#000080">:= </font>ARCTAN<font color="#000080">(</font>Number <font color="#000080">/ </font>SQRT<font color="#000080">(</font><font color="#800000">1.0 </font><font color="#000080">- </font>SQR<font color="#000080">(</font>Number<font color="#000080">)))
      + (</font>SgnR<font color="#000080">(</font>Number<font color="#000080">) - </font><font color="#800000">1.0</font><font color="#000080">) * (</font>PI <font color="#000080">/ </font><font color="#800000">2.0</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse hyperbolic secant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcSecH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcSecH <font color="#000080">:= </font>LN<font color="#000080">((</font>SQRT<font color="#000080">(</font><font color="#800000">1.0 </font><font color="#000080">- </font>SQR<font color="#000080">(</font>Number<font color="#000080">)) + </font><font color="#800000">1.0</font><font color="#000080">) / </font>Number<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse sine ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcSin <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Negate<font color="#000080">: </font>Boolean<font color="#000080">;
   </font>tmp<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Number <font color="#000080">&lt; </font><font color="#800000">0.0 </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Number <font color="#000080">:= -</font>Number<font color="#000080">;
      </font>Negate <font color="#000080">:= </font>TRUE<font color="#000080">;
   </font><font color="#FF0000"><b>END
   ELSE
      </b></font>Negate <font color="#000080">:= </font>FALSE<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">1.0 </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>tmp <font color="#000080">:= </font><font color="#800000">99999.0</font><font color="#000080">;
      </font>Negate <font color="#000080">:= </font>FALSE<font color="#000080">;
   </font><font color="#FF0000"><b>END
   ELSE BEGIN
      </b></font>tmp <font color="#000080">:= </font>SQRT<font color="#000080">(</font><font color="#800000">1.0 </font><font color="#000080">- </font>SQR<font color="#000080">(</font>Number<font color="#000080">));
      </font><font color="#FF0000"><b>IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">0.7 </font><font color="#FF0000"><b>THEN
         </b></font>tmp <font color="#000080">:= </font>PI <font color="#000080">/ </font><font color="#800000">2.0 </font><font color="#000080">- </font>ARCTAN<font color="#000080">(</font>tmp <font color="#000080">/ </font>Number<font color="#000080">)
      </font><font color="#FF0000"><b>ELSE
         </b></font>tmp <font color="#000080">:= </font>ARCTAN<font color="#000080">(</font>Number <font color="#000080">/ </font>tmp<font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Negate <font color="#FF0000"><b>THEN
      </b></font>ArcSin <font color="#000080">:= -</font>tmp
   <font color="#FF0000"><b>ELSE
      </b></font>ArcSin <font color="#000080">:= </font>tmp<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse hyperbolic sine ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcSinH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcSinH <font color="#000080">:= </font>Log<font color="#000080">(</font>Number <font color="#000080">+ </font>SQRT<font color="#000080">(</font>SQR<font color="#000080">(</font>Number<font color="#000080">) + </font><font color="#800000">1.0</font><font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Inverse hyperbolic tangent ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ArcTanH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ArcTanH <font color="#000080">:= </font>Log<font color="#000080">((</font><font color="#800000">1.0 </font><font color="#000080">+ </font>Number<font color="#000080">) / (</font><font color="#800000">1.0 </font><font color="#000080">- </font>Number<font color="#000080">)) / </font><font color="#800000">2.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Convert degrees to radians ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Deg2Rad <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Deg2Rad <font color="#000080">:= </font>Number <font color="#000080">* </font>PI <font color="#000080">/ </font><font color="#800000">180.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- e (base of the natural logarithms) ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>e<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>e <font color="#000080">:= </font><font color="#800000">2.7182818284590452353602874713526624977572470936999595749669676</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Hyperbolic cosine ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>CosH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Number <font color="#000080">&lt; </font><font color="#800000">0.0 </font><font color="#FF0000"><b>THEN
      </b></font>Number <font color="#000080">:= - </font>Number<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">21.0 </font><font color="#FF0000"><b>THEN
      </b></font>CosH <font color="#000080">:= </font>Exp<font color="#000080">(</font>Number<font color="#000080">) / </font><font color="#800000">2.0
   </font><font color="#FF0000"><b>ELSE
      </b></font>CosH <font color="#000080">:= (</font>Exp<font color="#000080">(</font>Number<font color="#000080">) + </font>Exp<font color="#000080">(-</font>Number<font color="#000080">)) / </font><font color="#800000">2.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Cotangent ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Cot <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Cot <font color="#000080">:= </font><font color="#800000">1.0 </font><font color="#000080">/ </font>Tan<font color="#000080">(</font>Number<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Hyperbolic cotangent ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>CotH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>tmp<font color="#000080">: </font>REAL<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>tmp <font color="#000080">:= </font>EXP<font color="#000080">(-</font>Number<font color="#000080">);
   </font>CotH <font color="#000080">:= </font>tmp <font color="#000080">/ (</font>EXP<font color="#000080">(</font>Number<font color="#000080">) - </font>tmp<font color="#000080">) * </font><font color="#800000">2.0 </font><font color="#000080">+ </font><font color="#800000">1.0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Cosecant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Csc <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Csc <font color="#000080">:= </font><font color="#800000">1.0 </font><font color="#000080">/ </font>Sin<font color="#000080">(</font>Number<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Hyperbolic cosecant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>CscH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>CscH <font color="#000080">:= </font><font color="#800000">2.0 </font><font color="#000080">/ (</font>EXP<font color="#000080">(</font>Number<font color="#000080">) - </font>EXP<font color="#000080">(-</font>Number<font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Error Function ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Erf <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>J<font color="#000080">, </font>N<font color="#000080">: </font>Integer<font color="#000080">;
   </font>S<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>N <font color="#000080">:= </font>Trunc<font color="#000080">(</font><font color="#800000">14.0 </font><font color="#000080">* </font>Number <font color="#000080">+ </font><font color="#800000">3.0</font><font color="#000080">);
   </font>S <font color="#000080">:= </font><font color="#800000">1.0 </font><font color="#000080">/ (</font><font color="#800000">2.0 </font><font color="#000080">* </font>N <font color="#000080">- </font><font color="#800000">1.0</font><font color="#000080">);
   </font><font color="#FF0000"><b>FOR </b></font>J <font color="#000080">:= </font>N <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>DOWNTO </b></font><font color="#800000">1 </font><font color="#FF0000"><b>DO
      </b></font>S <font color="#000080">:= </font><font color="#800000">1.0 </font><font color="#000080">/ (</font><font color="#800000">2.0 </font><font color="#000080">* </font>J <font color="#000080">- </font><font color="#800000">1.0</font><font color="#000080">) - </font>SQR<font color="#000080">(</font>Number<font color="#000080">) / </font>J <font color="#000080">* </font>S<font color="#000080">;
   </font>Erf <font color="#000080">:= </font>Number <font color="#000080">/ </font><font color="#800000">0.8862269254527581 </font><font color="#000080">* </font>S<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Factorial ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Fact <font color="#000080">(</font>Number<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Result<font color="#000080">: </font>Real<font color="#000080">;
   </font>tmp<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Result <font color="#000080">:= </font><font color="#800000">1.0</font><font color="#000080">;
   </font><font color="#FF0000"><b>FOR </b></font>tmp <font color="#000080">:= </font><font color="#800000">2 </font><font color="#FF0000"><b>TO </b></font>Number <font color="#FF0000"><b>DO
      </b></font>Result <font color="#000080">:= </font>Result <font color="#000080">* </font>tmp<font color="#000080">;
   </font>Fact <font color="#000080">:= </font>Result<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Logarithm (base 10) ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Log <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Log <font color="#000080">:= </font>Ln<font color="#000080">(</font>Number<font color="#000080">) / </font>Ln<font color="#000080">(</font><font color="#800000">10.0</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Convert radians to degrees ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Rad2Deg <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Rad2Deg <font color="#000080">:= </font>Number <font color="#000080">* </font><font color="#800000">180.0 </font><font color="#000080">/ </font>PI<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Raise a number to a power (a feature oddly lacking in Pascal). }
</i></font><font color="#FF0000"><b>FUNCTION Raise </b></font><font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">; </font>Power<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>tmp<font color="#000080">: </font>Integer<font color="#000080">;
   </font>Result<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Result <font color="#000080">:= </font><font color="#800000">1.0</font><font color="#000080">;
   </font><font color="#FF0000"><b>FOR </b></font>tmp <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>Power <font color="#FF0000"><b>DO
      </b></font>Result <font color="#000080">:= </font>Result <font color="#000080">* </font>Number<font color="#000080">;
   </font><font color="#FF0000"><b>Raise </b></font><font color="#000080">:= </font>Result<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ Raise }



{ ----- Secant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Sec <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Sec <font color="#000080">:= </font><font color="#800000">1.0 </font><font color="#000080">/ </font>Cos<font color="#000080">(</font>Number<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Hyperbolic secant ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>SecH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>SecH <font color="#000080">:= </font><font color="#800000">2.0 </font><font color="#000080">/ (</font>EXP<font color="#000080">(</font>Number<font color="#000080">) + </font>EXP<font color="#000080">(-</font>Number<font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Signum (integer) ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>SgnI <font color="#000080">(</font>Number<font color="#000080">: </font>Integer<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Number <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      </b></font>SgnI <font color="#000080">:= -</font><font color="#800000">1
   </font><font color="#FF0000"><b>ELSE IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      </b></font>SgnI <font color="#000080">:= </font><font color="#800000">1
   </font><font color="#FF0000"><b>ELSE
      </b></font>SgnI <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Signum (real) ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>SgnR <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Number <font color="#000080">&lt; </font><font color="#800000">0.0 </font><font color="#FF0000"><b>THEN
      </b></font>SgnR <font color="#000080">:= -</font><font color="#800000">1
   </font><font color="#FF0000"><b>ELSE IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">0.0 </font><font color="#FF0000"><b>THEN
      </b></font>SgnR <font color="#000080">:= </font><font color="#800000">1
   </font><font color="#FF0000"><b>ELSE
      </b></font>SgnR <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Hyperbolic sine ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>SinH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Negate<font color="#000080">: </font>Boolean<font color="#000080">;
   </font>p0<font color="#000080">, </font>p1<font color="#000080">, </font>p2<font color="#000080">, </font>p3<font color="#000080">, </font>q0<font color="#000080">, </font>q1<font color="#000080">, </font>q2<font color="#000080">, </font>tmp<font color="#000080">, </font>tmp1<font color="#000080">, </font>tmp2<font color="#000080">, </font>tmpsq<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>p0 <font color="#000080">:= -</font><font color="#800000">630767.3640497716991184787251</font><font color="#000080">;
   </font>p1 <font color="#000080">:= -</font><font color="#800000">89912.72022039509355398013511</font><font color="#000080">;
   </font>p2 <font color="#000080">:= -</font><font color="#800000">2894.211355989563807284660366</font><font color="#000080">;
   </font>p3 <font color="#000080">:= -</font><font color="#800000">26.30563213397497062819489</font><font color="#000080">;
   </font>q0 <font color="#000080">:= -</font><font color="#800000">630767.3640497716991212077277</font><font color="#000080">;
   </font>q1 <font color="#000080">:= </font><font color="#800000">15215.17378790019070696485176</font><font color="#000080">;
   </font>q2 <font color="#000080">:= -</font><font color="#800000">173.678953558233699533450911</font><font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Number <font color="#000080">&lt; </font><font color="#800000">0.0 </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Number <font color="#000080">:= -</font>Number<font color="#000080">;
      </font>Negate <font color="#000080">:= </font>TRUE<font color="#000080">;
   </font><font color="#FF0000"><b>END
   ELSE
      </b></font>Negate <font color="#000080">:= </font>FALSE<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">21.0 </font><font color="#FF0000"><b>THEN
      </b></font>tmp <font color="#000080">:= </font>Exp<font color="#000080">(</font>Number<font color="#000080">) / </font><font color="#800000">2.0
   </font><font color="#FF0000"><b>ELSE IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">0.5 </font><font color="#FF0000"><b>THEN
      </b></font>tmp <font color="#000080">:= (</font>Exp<font color="#000080">(</font>Number<font color="#000080">) - </font>Exp<font color="#000080">(-</font>Number<font color="#000080">)) / </font><font color="#800000">2.0
   </font><font color="#FF0000"><b>ELSE BEGIN
      </b></font>tmpsq <font color="#000080">:= </font>SQR<font color="#000080">(</font>Number<font color="#000080">);
      </font>tmp1 <font color="#000080">:= (((</font>tmpsq <font color="#000080">* </font>p3 <font color="#000080">+ </font>p2<font color="#000080">) * </font>tmpsq <font color="#000080">+ </font>p1<font color="#000080">) * </font>tmpsq <font color="#000080">+ </font>p0<font color="#000080">) * </font>Number<font color="#000080">;
      </font>tmp2 <font color="#000080">:= ((</font>tmpsq <font color="#000080">+ </font>q2<font color="#000080">) * </font>tmpsq <font color="#000080">+ </font>q1<font color="#000080">) * </font>tmpsq <font color="#000080">+ </font>q0<font color="#000080">;
      </font>tmp <font color="#000080">:= </font>tmp1 <font color="#000080">/ </font>tmp2<font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Negate <font color="#FF0000"><b>THEN
      </b></font>SinH <font color="#000080">:= -</font>tmp
   <font color="#FF0000"><b>ELSE
      </b></font>SinH <font color="#000080">:= </font>tmp<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Tangent ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Tan <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Tan <font color="#000080">:= </font>Sin<font color="#000080">(</font>Number<font color="#000080">) / </font>Cos<font color="#000080">(</font>Number<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ ----- Hyperbolic tangent ----- }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>TanH <font color="#000080">(</font>Number<font color="#000080">: </font>Real<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Negate<font color="#000080">: </font>Boolean<font color="#000080">;
   </font>tmp<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Number <font color="#000080">&lt; </font><font color="#800000">0.0 </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Number <font color="#000080">:= -</font>Number<font color="#000080">;
      </font>Negate <font color="#000080">:= </font>TRUE<font color="#000080">;
   </font><font color="#FF0000"><b>END
   ELSE
      </b></font>Negate <font color="#000080">:= </font>FALSE<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Number <font color="#000080">&gt; </font><font color="#800000">21.0 </font><font color="#FF0000"><b>THEN     </b></font><font color="#008000"><i>{ error }
      </i></font>TanH <font color="#000080">:= </font><font color="#800000">99999
   </font><font color="#FF0000"><b>ELSE BEGIN
      </b></font>tmp <font color="#000080">:= </font>SinH<font color="#000080">(</font>Number<font color="#000080">) / </font>CosH<font color="#000080">(</font>Number<font color="#000080">);
      </font><font color="#FF0000"><b>IF </b></font>Negate <font color="#FF0000"><b>THEN
         </b></font>TanH <font color="#000080">:= -</font>tmp
      <font color="#FF0000"><b>ELSE
         </b></font>TanH <font color="#000080">:= </font>tmp<font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;



</font><font color="#008000"><i>{ =========================================================================== }



{ ----- This is the main evaluation routine ----- }
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>Evaluate <font color="#000080">(</font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>Result<font color="#000080">: </font>Real<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>VAR
   </b></font>tmp<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   WHILE </b></font><font color="#000080">(</font>Pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">, </font>Expr<font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>DO
      </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font>Pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">, </font>Expr<font color="#000080">), </font><font color="#800000">1</font><font color="#000080">);
   </font><font color="#FF0000"><b>WHILE </b></font><font color="#000080">(</font>Pos<font color="#000080">(</font><font color="#800000">'**'</font><font color="#000080">, </font>Expr<font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>DO BEGIN
      </b></font>tmp <font color="#000080">:= </font>Pos<font color="#000080">(</font><font color="#800000">'**'</font><font color="#000080">, </font>Expr<font color="#000080">);
      </font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font>tmp<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
      </font>Expr<font color="#000080">[</font>tmp<font color="#000080">] := </font><font color="#800000">'^'</font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Length<font color="#000080">(</font>Expr<font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      IF </b></font>ParensOk<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
         FOR </b></font>tmp <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>Length<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>DO
            </b></font>Expr<font color="#000080">[</font>tmp<font color="#000080">] := </font>Upcase<font color="#000080">(</font>Expr<font color="#000080">[</font>tmp<font color="#000080">]);
         </font>ErrCode <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
         </font>FixPrecedence<font color="#000080">(</font>Expr<font color="#000080">);
         </font>Result <font color="#000080">:= </font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
      </font><font color="#FF0000"><b>END
      ELSE
         </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">4
   </font><font color="#FF0000"><b>ELSE
      </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ Evaluate }



{ ----- This adds parentheses to force evaluation by normal algebraic
        precedence (negation, exponentiation, multiplication and division,
        addition and subtraction) }
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>AddParen <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Posn<font color="#000080">, </font>WhichWay<font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>VAR
   </b></font>Done<font color="#000080">: </font>Boolean<font color="#000080">;
   </font>ch<font color="#000080">: </font>Char<font color="#000080">;
   </font>Depth<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Done <font color="#000080">:= </font>FALSE<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>WhichWay <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
      REPEAT
         </b></font>Dec<font color="#000080">(</font>Posn<font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>Posn <font color="#000080">&lt; </font><font color="#800000">1 </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Expr <font color="#000080">:= </font><font color="#800000">'(' </font><font color="#000080">+ </font>Expr<font color="#000080">;
            </font>Done <font color="#000080">:= </font>TRUE<font color="#000080">;
         </font><font color="#FF0000"><b>END
         ELSE BEGIN
            </b></font>ch <font color="#000080">:= </font>Expr<font color="#000080">[</font>Posn<font color="#000080">];
            </font><font color="#FF0000"><b>IF </b></font>Pos<font color="#000080">(</font>ch<font color="#000080">, </font><font color="#800000">'^*/+-'</font><font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
               </b></font>Insert<font color="#000080">(</font><font color="#800000">'('</font><font color="#000080">, </font>Expr<font color="#000080">, </font>Posn <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
               </font>Done <font color="#000080">:= </font>TRUE<font color="#000080">;
            </font><font color="#FF0000"><b>END
            ELSE IF </b></font>ch <font color="#000080">= </font><font color="#800000">')' </font><font color="#FF0000"><b>THEN BEGIN
               </b></font>Depth <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
               </font><font color="#FF0000"><b>REPEAT
                  </b></font>Dec<font color="#000080">(</font>Posn<font color="#000080">);
                  </font><font color="#FF0000"><b>IF </b></font>Posn <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
                     </b></font>ch <font color="#000080">:= </font>Expr<font color="#000080">[</font>Posn<font color="#000080">];
                     </font><font color="#FF0000"><b>IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN
                        </b></font>Dec<font color="#000080">(</font>Depth<font color="#000080">)
                     </font><font color="#FF0000"><b>ELSE IF </b></font>ch <font color="#000080">= </font><font color="#800000">')' </font><font color="#FF0000"><b>THEN
                        </b></font>Inc<font color="#000080">(</font>Depth<font color="#000080">);
                  </font><font color="#FF0000"><b>END
                  ELSE
                     </b></font>Depth <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
               </font><font color="#FF0000"><b>UNTIL </b></font>Depth <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
               </font><font color="#FF0000"><b>IF </b></font>Posn <font color="#000080">&lt; </font><font color="#800000">1 </font><font color="#FF0000"><b>THEN
                  </b></font>Posn <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
               </font>Insert<font color="#000080">(</font><font color="#800000">'('</font><font color="#000080">, </font>Expr<font color="#000080">, </font>Posn <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
               </font>Done <font color="#000080">:= </font>TRUE<font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>UNTIL </b></font>Done<font color="#000080">;
   </font><font color="#FF0000"><b>END
   ELSE
      REPEAT
         </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>Posn <font color="#000080">&gt; </font>Length<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Expr <font color="#000080">:= </font>Expr <font color="#000080">+ </font><font color="#800000">')'</font><font color="#000080">;
            </font>Done <font color="#000080">:= </font>TRUE<font color="#000080">;
         </font><font color="#FF0000"><b>END
         ELSE BEGIN
            </b></font>ch <font color="#000080">:= </font>Expr<font color="#000080">[</font>Posn<font color="#000080">];
            </font><font color="#FF0000"><b>IF </b></font>Pos<font color="#000080">(</font>ch<font color="#000080">, </font><font color="#800000">'^*/+-'</font><font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
               </b></font>Insert<font color="#000080">(</font><font color="#800000">')'</font><font color="#000080">, </font>Expr<font color="#000080">, </font>Posn<font color="#000080">);
               </font>Done <font color="#000080">:= </font>TRUE<font color="#000080">;
            </font><font color="#FF0000"><b>END
            ELSE IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
               </b></font>Depth <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
               </font><font color="#FF0000"><b>REPEAT
                  </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">);
                  </font><font color="#FF0000"><b>IF </b></font>Posn <font color="#000080">&lt;= </font>Length<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
                     </b></font>ch <font color="#000080">:= </font>Expr<font color="#000080">[</font>Posn<font color="#000080">];
                     </font><font color="#FF0000"><b>IF </b></font>ch <font color="#000080">= </font><font color="#800000">')' </font><font color="#FF0000"><b>THEN
                        </b></font>Dec<font color="#000080">(</font>Depth<font color="#000080">)
                     </font><font color="#FF0000"><b>ELSE IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN
                        </b></font>Inc<font color="#000080">(</font>Depth<font color="#000080">);
                  </font><font color="#FF0000"><b>END
                  ELSE
                     </b></font>Depth <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
               </font><font color="#FF0000"><b>UNTIL </b></font>Depth <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
               </font><font color="#FF0000"><b>IF </b></font>Posn <font color="#000080">&gt; </font>Length<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>THEN
                  </b></font>Posn <font color="#000080">:= </font>Length<font color="#000080">(</font>Expr<font color="#000080">);
               </font>Insert<font color="#000080">(</font><font color="#800000">')'</font><font color="#000080">, </font>Expr<font color="#000080">, </font>Posn<font color="#000080">);
               </font>Done <font color="#000080">:= </font>TRUE<font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>UNTIL </b></font>Done<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;    </font><font color="#008000"><i>{ AddParen }



{ ----- This recursive function is the heart of the expression evaluator. }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Eval <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>LVal<font color="#000080">, </font>tmp<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>LVal <font color="#000080">:= </font>Factor<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>ErrCode <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      CASE </b></font>Expr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>OF
         </b></font><font color="#800000">'+'</font><font color="#000080">: </font><font color="#FF0000"><b>BEGIN
                 </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
                 </font>LVal <font color="#000080">:= </font>LVal <font color="#000080">+ </font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#800000">'-'</font><font color="#000080">: </font><font color="#FF0000"><b>BEGIN
                 </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
                 </font>LVal <font color="#000080">:= </font>LVal <font color="#000080">- </font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#800000">'*'</font><font color="#000080">: </font><font color="#FF0000"><b>BEGIN
                 </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
                 </font>LVal <font color="#000080">:= </font>LVal <font color="#000080">* </font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#800000">'/'</font><font color="#000080">: </font><font color="#FF0000"><b>BEGIN
                 </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
                 </font>tmp <font color="#000080">:= </font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
                 </font><font color="#FF0000"><b>IF </b></font>ErrCode <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
                    IF </b></font>tmp <font color="#000080">= </font><font color="#800000">0.0 </font><font color="#FF0000"><b>THEN
                       </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">9
                    </font><font color="#FF0000"><b>ELSE
                       </b></font>LVal <font color="#000080">:= </font>LVal <font color="#000080">/ </font>tmp<font color="#000080">;
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#800000">'^'</font><font color="#000080">: </font><font color="#FF0000"><b>BEGIN
                 </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
                 </font>LVal <font color="#000080">:= </font><font color="#FF0000"><b>Raise</b></font><font color="#000080">(</font>LVal<font color="#000080">, </font>Trunc<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">)));
              </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#800000">')'</font><font color="#000080">: </font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ CASE }
   </i></font>Eval <font color="#000080">:= </font>LVal<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ Eval }



{ ----- A recursive evaluation helper, this function gets the leftmost term
        that can be dealt with at this point in the evaluation. }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Factor <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Negate<font color="#000080">: </font>Boolean<font color="#000080">;
   </font>RVal<font color="#000080">: </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>RVal <font color="#000080">:= </font><font color="#800000">0.0</font><font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Expr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">'-' </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Negate <font color="#000080">:= </font>TRUE<font color="#000080">;
      </font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
   </font><font color="#FF0000"><b>END
   ELSE
      </b></font>Negate <font color="#000080">:= </font>FALSE<font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Expr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN
      </b></font>RVal <font color="#000080">:= </font>Term<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">)
   </font><font color="#FF0000"><b>ELSE BEGIN
      </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
      </font>RVal <font color="#000080">:= </font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>IF </b></font>Negate <font color="#FF0000"><b>THEN
      </b></font>Factor <font color="#000080">:= -</font>RVal
   <font color="#FF0000"><b>ELSE
      </b></font>Factor <font color="#000080">:= </font>RVal<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ Factor }



{ ----- Since the evaluation function doesn't naturally evaluate expressions
        using algebraic precedence, but does understand parentheses...
        This routine adds parentheses to force the proper precedence. }
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>FixPrecedence <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>VAR
   </b></font>Posn<font color="#000080">, </font>tmp<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Expr <font color="#000080">:= </font><font color="#800000">'(' </font><font color="#000080">+ </font>Expr <font color="#000080">+ </font><font color="#800000">')'</font><font color="#000080">;
   </font>Posn <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
   </font><font color="#FF0000"><b>REPEAT
      IF </b></font>Expr<font color="#000080">[</font>Posn<font color="#000080">] = </font><font color="#800000">'-' </font><font color="#FF0000"><b>THEN
         IF NOT</b></font><font color="#000080">(</font>Expr<font color="#000080">[</font>Posn <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">'0'</font><font color="#000080">..</font><font color="#800000">'9'</font><font color="#000080">,</font><font color="#800000">'A'</font><font color="#000080">..</font><font color="#800000">'Z'</font><font color="#000080">]) </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">);
            </font>Inc<font color="#000080">(</font>Posn<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">)
      </font><font color="#FF0000"><b>ELSE
         </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">);
   </font><font color="#FF0000"><b>UNTIL </b></font>Posn <font color="#000080">&gt; </font>Length<font color="#000080">(</font>Expr<font color="#000080">);
   </font>Posn <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>REPEAT
      IF </b></font>Expr<font color="#000080">[</font>Posn<font color="#000080">] &lt;&gt; </font>Locase<font color="#000080">(</font>Expr<font color="#000080">[</font>Posn<font color="#000080">]) </font><font color="#FF0000"><b>THEN BEGIN
         </b></font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
         </font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">);
         </font>Inc<font color="#000080">(</font>Posn<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
      </font><font color="#FF0000"><b>END
      ELSE
         </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">);
   </font><font color="#FF0000"><b>UNTIL </b></font>Posn <font color="#000080">&gt; </font>Length<font color="#000080">(</font>Expr<font color="#000080">);
   </font>Posn <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>REPEAT
      IF </b></font>Expr<font color="#000080">[</font>Posn<font color="#000080">] = </font><font color="#800000">'^' </font><font color="#FF0000"><b>THEN BEGIN
         </b></font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
         </font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">);
         </font>Inc<font color="#000080">(</font>Posn<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
      </font><font color="#FF0000"><b>END
      ELSE
         </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">);
   </font><font color="#FF0000"><b>UNTIL </b></font>Posn <font color="#000080">&gt; </font>Length<font color="#000080">(</font>Expr<font color="#000080">);
   </font>Posn <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>REPEAT
      IF </b></font>Pos<font color="#000080">(</font>Expr<font color="#000080">[</font>Posn<font color="#000080">], </font><font color="#800000">'*/'</font><font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
         </b></font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
         </font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">);
         </font>Inc<font color="#000080">(</font>Posn<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
      </font><font color="#FF0000"><b>END
      ELSE
         </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">);
   </font><font color="#FF0000"><b>UNTIL </b></font>Posn <font color="#000080">&gt; </font>Length<font color="#000080">(</font>Expr<font color="#000080">);
   </font>Posn <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>REPEAT
      IF </b></font>Pos<font color="#000080">(</font>Expr<font color="#000080">[</font>Posn<font color="#000080">], </font><font color="#800000">'+-'</font><font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
         </b></font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
         </font>AddParen<font color="#000080">(</font>Expr<font color="#000080">, </font>Posn<font color="#000080">, -</font><font color="#800000">1</font><font color="#000080">);
         </font>Inc<font color="#000080">(</font>Posn<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
      </font><font color="#FF0000"><b>END
      ELSE
         </b></font>Inc<font color="#000080">(</font>Posn<font color="#000080">);
   </font><font color="#FF0000"><b>UNTIL </b></font>Posn <font color="#000080">&gt; </font>Length<font color="#000080">(</font>Expr<font color="#000080">);
   </font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
   </font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font>Length<font color="#000080">(</font>Expr<font color="#000080">), </font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ FixPrecedence }



{ ----- Determine whether a character may be construed as being numeric. }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>IsDigit <font color="#000080">(</font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>Length<font color="#000080">(</font>Expr<font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      </b></font>IsDigit <font color="#000080">:= (</font>Pos<font color="#000080">(</font>Expr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font><font color="#800000">'0123456789.'</font><font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">)
   </font><font color="#FF0000"><b>ELSE
      </b></font>IsDigit <font color="#000080">:= </font>FALSE<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ IsDigit }



{ ----- Convert a character to lowercase. }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>LoCase <font color="#000080">(</font>ch<font color="#000080">: </font>Char<font color="#000080">): </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   IF </b></font>ch <font color="#FF0000"><b>IN </b></font><font color="#000080">[</font><font color="#800000">'A'</font><font color="#000080">..</font><font color="#800000">'Z'</font><font color="#000080">] </font><font color="#FF0000"><b>THEN
      </b></font>LoCase <font color="#000080">:= </font>CHR<font color="#000080">(</font>ORD<font color="#000080">(</font>ch<font color="#000080">) </font><font color="#FF0000"><b>XOR </b></font><font color="#800000">32</font><font color="#000080">)
   </font><font color="#FF0000"><b>ELSE
      </b></font>LoCase <font color="#000080">:= </font>ch
<font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ LoCase }



{ ----- Check to make sure parentheses are balanced. }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ParensOk <font color="#000080">(</font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>Parens<font color="#000080">, </font>Posn<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>Parens <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>FOR </b></font>Posn <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>Length<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>DO
      IF </b></font>Expr<font color="#000080">[</font>Posn<font color="#000080">] = </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN
         </b></font>Inc<font color="#000080">(</font>Parens<font color="#000080">)
      </font><font color="#FF0000"><b>ELSE IF </b></font>Expr<font color="#000080">[</font>Posn<font color="#000080">] = </font><font color="#800000">')' </font><font color="#FF0000"><b>THEN
         </b></font>Dec<font color="#000080">(</font>Parens<font color="#000080">);
   </font>ParensOk <font color="#000080">:= (</font>Parens <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ ParensOk }



{ ----- This grabs a number from the expression. }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Term <font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Expr<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrCode<font color="#000080">: </font>Integer<font color="#000080">): </font>Real<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>junk<font color="#000080">: </font>Integer<font color="#000080">;
   </font>RVal<font color="#000080">: </font>Real<font color="#000080">;
   </font>ch<font color="#000080">: </font>char<font color="#000080">;
   </font>tmp<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>RVal <font color="#000080">:= </font><font color="#800000">0.0</font><font color="#000080">;
   </font>ch <font color="#000080">:= </font>Upcase<font color="#000080">(</font>Expr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
   </font><font color="#FF0000"><b>IF </b></font>ch <font color="#000080">&lt;&gt; </font>Locase<font color="#000080">(</font>ch<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>tmp <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font><font color="#FF0000"><b>REPEAT
         </b></font>tmp <font color="#000080">:= </font>tmp <font color="#000080">+ </font>ch<font color="#000080">;
         </font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
         </font>ch <font color="#000080">:= </font>Upcase<font color="#000080">(</font>Expr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
      </font><font color="#FF0000"><b>UNTIL </b></font><font color="#000080">(</font>ch <font color="#000080">= </font>Locase<font color="#000080">(</font>ch<font color="#000080">)) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>Length<font color="#000080">(</font>Expr<font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'ABS' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>ABS<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'ACOS' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>ArcCos<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'ASIN' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>ArcSin<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'ATAN' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>ARCTAN<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'COS' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>COS<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'FRAC' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">);
            </font>RVal <font color="#000080">:= </font>RVal <font color="#000080">- </font>INT<font color="#000080">(</font>RVal<font color="#000080">);
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'INT' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>INT<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'LOG' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>LOG<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'PI' </font><font color="#FF0000"><b>THEN
         </b></font>RVal <font color="#000080">:= </font><font color="#800000">3.141593
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'SIN' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>SIN<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'SQRT' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>SQRT<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE IF </b></font>tmp <font color="#000080">= </font><font color="#800000">'TAN' </font><font color="#FF0000"><b>THEN
         IF </b></font>ch <font color="#000080">= </font><font color="#800000">'(' </font><font color="#FF0000"><b>THEN BEGIN
            </b></font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
            </font>RVal <font color="#000080">:= </font>TAN<font color="#000080">(</font>Eval<font color="#000080">(</font>Expr<font color="#000080">, </font>ErrCode<font color="#000080">))
         </font><font color="#FF0000"><b>END
         ELSE
            </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">1
      </font><font color="#FF0000"><b>ELSE
         </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">3
   </font><font color="#FF0000"><b>END
   ELSE IF </b></font>IsDigit<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>tmp <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font><font color="#FF0000"><b>WHILE </b></font>IsDigit<font color="#000080">(</font>Expr<font color="#000080">) </font><font color="#FF0000"><b>DO BEGIN
         </b></font>tmp <font color="#000080">:= </font>tmp <font color="#000080">+ </font>Expr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">];
         </font>Delete<font color="#000080">(</font>Expr<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font>Val<font color="#000080">(</font>tmp<font color="#000080">, </font>RVal<font color="#000080">, </font>junk<font color="#000080">);
   </font><font color="#FF0000"><b>END
   ELSE
      </b></font>ErrCode <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
   </font>Term <font color="#000080">:= </font>RVal<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;     </font><font color="#008000"><i>{ Term }



</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">.     </font><font color="#008000"><i>{ ExtMath UNIT }
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0129.PAS">Original</a><b>]</b></p></body>
</html>
