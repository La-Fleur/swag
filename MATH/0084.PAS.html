<html>
<head><title> "Pentium-Optimized Permutations" by TERJE MATHISEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0084.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Just for fun, I sat down last night and generated an inline asm version
of the C code I posted that permuted character strings.  This version
uses about 90 clock cycles/call on a 486 and 60 on a Pentium, i.e.
one microsecond/call on my P5-60:  (The average time is very nearly
independent of the length of the string.)

From: terjem@hda.hydro.com (Terje Mathisen)
}

{$R-,S-}
</i></font><font color="#FF0000"><b>Program </b></font>Permutate<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Permute<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>a<font color="#000080">; </font>alen <font color="#000080">: </font>word<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds         </font><font color="#008000"><i>{ BX -&gt; beginning of array }
  </i></font><font color="#FF00FF">lds bx,[a]
  mov di,[alen]   </font><font color="#008000"><i>{ Array length }
  </i></font><font color="#FF00FF">xor cx,cx       </font><font color="#008000"><i>{ Return value = False }
  </i></font><font color="#FF00FF">lea si,[di+bx-2]</font><font color="#008000"><i>{ SI -&gt; one character before last }
  </i></font><font color="#FF00FF">lea di,[di+bx-1]</font><font color="#008000"><i>{ DI -&gt; last position in a[] }

</i></font><font color="#FF00FF">@loop1:
  cmp si,bx       </font><font color="#008000"><i>{ Check if we've gotten to the beginning of the array!}
   </i></font><font color="#FF00FF">jb @reverse    </font><font color="#008000"><i>{ Yes, so no permutation found, return reversed array!}
  </i></font><font color="#FF00FF">mov ax,[si]     </font><font color="#008000"><i>{ Get another pair of bytes from the end }
  </i></font><font color="#FF00FF">dec si
  cmp al,ah
   jae @loop1     </font><font color="#008000"><i>{ Loop until a[si] &lt; a[si+1] }

{ We have found a pair of bytes where the first is less than
  the second, which means that there exists at least one more
  permutation of the a[] array.
}

  </i></font><font color="#FF00FF">mov bx,di       </font><font color="#008000"><i>{ BX -&gt; Last byte in a[] }
  </i></font><font color="#FF00FF">inc si          </font><font color="#008000"><i>{ SI was decremented one extra time, adjust back }
  </i></font><font color="#FF00FF">mov cl,True     </font><font color="#008000"><i>{ Return value = True }

{ Find the last byte which is &gt; al (a[si]) }

</i></font><font color="#FF00FF">@loop2:
  mov dl,[bx]
  dec bx
  cmp dl,al
   jbe @loop2

</font><font color="#008000"><i>{ Swap the two positions found: }

  </i></font><font color="#FF00FF">mov [si],dl
  mov [bx+1],al
   jmp @reverse   </font><font color="#008000"><i>{ Reverse the rest of the array! }

</i></font><font color="#FF00FF">@loop3:
  mov al,[si]
  mov dl,[di]
  mov [di],al
  dec di
  mov [si],dl
@reverse:
  inc si
  cmp si,di
   jb @loop3

  mov ax,cx
  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>test<font color="#000080">, </font>org <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>n <font color="#000080">: </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>org <font color="#000080">:= </font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font>test <font color="#000080">:= </font>org<font color="#000080">;
  </font>n <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>ParamCount <font color="#000080">&gt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then begin </b></font><font color="#008000"><i>{Verbose version }
    </i></font><font color="#FF0000"><b>repeat
      </b></font>WriteLn<font color="#000080">(</font>n<font color="#000080">:</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">' '</font><font color="#000080">,</font>test<font color="#000080">);
      </font>Inc<font color="#000080">(</font>n<font color="#000080">);
    </font><font color="#FF0000"><b>until not </b></font>Permute<font color="#000080">(</font>test<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>Length<font color="#000080">(</font>test<font color="#000080">));
    </font>WriteLn<font color="#000080">(</font>n<font color="#000080">:</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">' '</font><font color="#000080">,</font>test<font color="#000080">);
  </font><font color="#FF0000"><b>end
  else begin
    repeat
      </b></font>Inc<font color="#000080">(</font>n<font color="#000080">);
    </font><font color="#FF0000"><b>until not </b></font>Permute<font color="#000080">(</font>test<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>Length<font color="#000080">(</font>test<font color="#000080">));
    </font>WriteLn<font color="#000080">(</font>n<font color="#000080">,</font><font color="#800000">' permutations of '</font><font color="#000080">,</font>org<font color="#000080">,</font><font color="#800000">' found!'</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MATH SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0084.PAS">Original</a><b>]</b></p></body>
</html>
