<html>
<head><title> "Get Run-time addr of virtual methods" by EGOR EGOROV</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0093.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>PROGRAM </b></font>Tst_VMT<font color="#000080">;

</font><font color="#FF0000"><b>Type   </b></font>TAObject <font color="#000080">= </font><font color="#FF0000"><b>object
                   constructor </b></font>Init<font color="#000080">;
                   </font><font color="#FF0000"><b>procedure   </b></font>MethodA<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                   </font><font color="#FF0000"><b>procedure   </b></font>MethodB<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Type   </b></font>TBObject <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TAObject<font color="#000080">)
                   </font><font color="#FF0000"><b>procedure   </b></font>MethodA<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var    </b></font>MethodAOffsetInVMT<font color="#000080">,
       </font>MethodBOffsetInVMT  <font color="#000080">: </font>integer<font color="#000080">;
       </font>ItIsAObject         <font color="#000080">: </font>TAObject<font color="#000080">;
       </font>ItIsBObject         <font color="#000080">: </font>TBObject<font color="#000080">;

</font><font color="#008000"><i>{--- TAObject -------------------------------------------------------}

</i></font><font color="#FF0000"><b>Constructor </b></font>TAObject<font color="#000080">.</font>Init<font color="#000080">;

</font><font color="#FF0000"><b>Begin
End</b></font><font color="#000080">;

</font><font color="#008000"><i>{--------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>TAObject<font color="#000080">.</font>MethodA<font color="#000080">;

</font><font color="#FF0000"><b>Begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'It is method A !!!'</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{--------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>TAObject<font color="#000080">.</font>MethodB<font color="#000080">;

</font><font color="#FF0000"><b>Begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'It is method B !!!'</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{--- TAObject -------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>TBObject<font color="#000080">.</font>MethodA<font color="#000080">;

</font><font color="#FF0000"><b>Begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'It is method A (some changed) !!!'</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{--------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Function </b></font>GetOffsetInVMT<font color="#000080">(</font>VMTAddr <font color="#000080">: </font>pointer<font color="#000080">; </font>MethodAddr <font color="#000080">: </font>pointer<font color="#000080">): </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>Type   </b></font>TAddrRec       <font color="#000080">= </font><font color="#FF0000"><b>record  </b></font>Offs<font color="#000080">,</font>Segm <font color="#000080">: </font>word  <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Const  </b></font>VMTHeaderSize  <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;     </font><font color="#008000"><i>{ This is a size of VMT header     }
       </i></font>MaxMethodsOffs <font color="#000080">= </font><font color="#800000">100 </font><font color="#000080">* </font>SizeOf<font color="#000080">(</font>pointer<font color="#000080">) + </font>VMTHeaderSize<font color="#000080">;
                       </font><font color="#008000"><i>{ Maximal offset of method in VMT (abstract) }

</i></font><font color="#FF0000"><b>Var    </b></font>VMTOffs        <font color="#000080">: </font>word<font color="#000080">;
       </font>CurAddr        <font color="#000080">: ^</font>pointer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
    </b></font>VMTOffs <font color="#000080">:= </font>VMTHeaderSize<font color="#000080">;
    </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>VMTOffs <font color="#000080">&lt; </font>MaxMethodsOffs<font color="#000080">) </font><font color="#FF0000"><b>and
          </b></font><font color="#000080">(</font>pointer<font color="#000080">( </font>Ptr<font color="#000080">(</font>TAddrRec<font color="#000080">(</font>VMTAddr<font color="#000080">).</font>Segm<font color="#000080">,
                        </font>TAddrRec<font color="#000080">(</font>VMTAddr<font color="#000080">).</font>Offs <font color="#000080">+ </font>VMTOffs<font color="#000080">)^
                  ) &lt;&gt; </font>MethodAddr<font color="#000080">) </font><font color="#FF0000"><b>do
     </b></font>Inc<font color="#000080">(</font>VMTOffs<font color="#000080">, </font>SizeOf<font color="#000080">(</font>pointer<font color="#000080">));
    </font><font color="#FF0000"><b>If </b></font>VMTOffs <font color="#000080">&gt;= </font>MaxMethodsOffs
     <font color="#FF0000"><b>then  </b></font>GetOffsetInVMT <font color="#000080">:= </font><font color="#800000">0   </font><font color="#008000"><i>{ Damn, there is no such method! }
     </i></font><font color="#FF0000"><b>else  </b></font>GetOffsetInVMT <font color="#000080">:= </font>VMTOffs<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{--------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Begin
    </b></font>ItIsAObject<font color="#000080">.</font>Init<font color="#000080">;
    </font>ItIsBObject<font color="#000080">.</font>Init<font color="#000080">;
    </font>ItIsAObject<font color="#000080">.</font>MethodA<font color="#000080">;
    </font>ItIsAObject<font color="#000080">.</font>MethodB<font color="#000080">;
    </font>MethodAOffsetInVMT <font color="#000080">:= </font>GetOffsetInVMT<font color="#000080">(</font>TypeOf<font color="#000080">(</font>TAObject<font color="#000080">),
                                         @</font>TAObject<font color="#000080">.</font>MethodA<font color="#000080">);
    </font>MethodBOffsetInVMT <font color="#000080">:= </font>GetOffsetInVMT<font color="#000080">(</font>TypeOf<font color="#000080">(</font>TAObject<font color="#000080">),
                                         @</font>TAObject<font color="#000080">.</font>MethodB<font color="#000080">);
    </font>Writeln<font color="#000080">(</font>MethodAOffsetInVMT<font color="#000080">);
    </font>Writeln<font color="#000080">(</font>MethodBOffsetInVMT<font color="#000080">);

    </font><font color="#008000"><i>{ --- Let's call TBObject.MethodA  }
    </i></font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov  di,offset ItIsBObject
      push ds              </font><font color="#008000"><i>{ Pushing @Self for object in stack }
      </i></font><font color="#FF00FF">push di
      mov  di,[di]         </font><font color="#008000"><i>{ VMT offset in data segment }
      </i></font><font color="#FF00FF">add  di,[MethodAOffsetInVMT]  </font><font color="#008000"><i>{ Adding method offset in VMT }
      </i></font><font color="#FF00FF">call dword ptr [di]
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0093.PAS">Original</a><b>]</b></p></body>
</html>
