<html>
<head><title> "Help on XMS use !!!" by HERMAN DULLINK</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0094.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>program </b></font>XMS<font color="#000080">;

</font><font color="#008000"><i>{ Functions to get to the XMS API }

</i></font><font color="#FF0000"><b>var </b></font>XMS_Driver <font color="#000080">: </font>pointer<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>XMS_get_state <font color="#000080">: </font>byte<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax,4300h; int 2Fh </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>XMS_get_entry_point <font color="#000080">: </font>pointer<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ax,4310h; int 2Fh; mov ax,bx; mov dx,es </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ XMS API }

</i></font><font color="#FF0000"><b>type </b></font>MoveStruct <font color="#000080">= </font><font color="#FF0000"><b>record
 </b></font>length    <font color="#000080">: </font>longint<font color="#000080">;
 </font>srcHandle <font color="#000080">: </font>word<font color="#000080">;
 </font>srcOffset <font color="#000080">: </font>longint<font color="#000080">;
 </font>dstHandle <font color="#000080">: </font>word<font color="#000080">;
 </font>dstOffset <font color="#000080">: </font>longint
<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>XMS_get_version <font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ah,00h; call XMS_Driver </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>XMS_query <font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ah,08h; call XMS_Driver </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>XMS_alloc<font color="#000080">(</font>size <font color="#000080">: </font>word<font color="#000080">) : </font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ah,09h; call XMS_Driver; mul dx </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>XMS_free<font color="#000080">(</font>handle <font color="#000080">: </font>word<font color="#000080">) : </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ah,0Ah; mov dx,handle; call XMS_Driver </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>XMS_move<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>MoveStructPtr <font color="#000080">: </font>MoveStruct<font color="#000080">) : </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">mov ah,0Bh; push ds; push ds; pop es; lds si,MoveStructPtr; call
es:XMS_Driver; pop ds </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Main program }

</i></font><font color="#FF0000"><b>var </b></font>XMS_version<font color="#000080">, </font>XMS_handle  <font color="#000080">: </font>word<font color="#000080">;

    </font>a <font color="#000080">: </font>word<font color="#000080">;
    </font>b <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1999</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>real<font color="#000080">;
    </font>c <font color="#000080">: </font>MoveStruct<font color="#000080">;
    </font>d <font color="#000080">: </font>boolean<font color="#000080">;

    </font>x<font color="#000080">,</font>y <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>begin
 if </b></font>XMS_get_state <font color="#000080">= </font><font color="#800000">$80 </font><font color="#FF0000"><b>then begin
  </b></font>XMS_driver <font color="#000080">:= </font>XMS_get_entry_point<font color="#000080">;

  </font>XMS_version <font color="#000080">:= </font>XMS_get_version<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'XMS version           : '</font><font color="#000080">, </font>hi<font color="#000080">(</font>XMS_version<font color="#000080">), </font><font color="#800000">'.'</font><font color="#000080">, </font>lo<font color="#000080">(</font>XMS_version<font color="#000080">));

  </font>writeln<font color="#000080">(</font><font color="#800000">'Largest available EMB : '</font><font color="#000080">, </font>XMS_query<font color="#000080">, </font><font color="#800000">'KB'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>XMS_query <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin

   </b></font>a <font color="#000080">:= </font>longint<font color="#000080">(</font>XMS_query<font color="#000080">) * </font><font color="#800000">1024 </font><font color="#FF0000"><b>div </b></font>sizeof<font color="#000080">(</font>b<font color="#000080">);
   </font>XMS_handle <font color="#000080">:= </font>XMS_alloc<font color="#000080">(</font>XMS_query<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>XMS_handle <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin

    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Number of arrays      : '</font><font color="#000080">, </font>a<font color="#000080">);

    </font>c<font color="#000080">.</font>length <font color="#000080">:= </font>sizeof<font color="#000080">(</font>b<font color="#000080">);
    </font>c<font color="#000080">.</font>srcHandle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>c<font color="#000080">.</font>srcOffset <font color="#000080">:= </font>longint<font color="#000080">(</font>Addr<font color="#000080">(</font>b<font color="#000080">));
    </font>c<font color="#000080">.</font>dstHandle <font color="#000080">:= </font>XMS_handle<font color="#000080">;

    </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>pred<font color="#000080">(</font>a<font color="#000080">) </font><font color="#FF0000"><b>do begin
     </b></font>write<font color="#000080">(</font><font color="#800000">'Filling array #       : '</font><font color="#000080">, </font>x<font color="#000080">, </font><font color="#800000">#13</font><font color="#000080">);
     </font><font color="#FF0000"><b>for </b></font>y <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">1999 </font><font color="#FF0000"><b>do
      </b></font>b<font color="#000080">[</font>y<font color="#000080">] := </font>x <font color="#000080">* </font>y<font color="#000080">;
     </font>c<font color="#000080">.</font>dstOffset <font color="#000080">:= </font>longint<font color="#000080">(</font>x<font color="#000080">) * </font>sizeof<font color="#000080">(</font>b<font color="#000080">);
     </font>XMS_move<font color="#000080">(</font>c<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>writeln<font color="#000080">;

    </font>c<font color="#000080">.</font>srcHandle <font color="#000080">:= </font>XMS_handle<font color="#000080">;
    </font>c<font color="#000080">.</font>dstHandle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>c<font color="#000080">.</font>dstOffset <font color="#000080">:= </font>longint<font color="#000080">(</font>Addr<font color="#000080">(</font>b<font color="#000080">));

    </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>pred<font color="#000080">(</font>a<font color="#000080">) </font><font color="#FF0000"><b>do begin
     </b></font>write<font color="#000080">(</font><font color="#800000">'Checking array #      : '</font><font color="#000080">, </font>x<font color="#000080">, </font><font color="#800000">#13</font><font color="#000080">);
     </font>c<font color="#000080">.</font>srcOffset <font color="#000080">:= </font>longint<font color="#000080">(</font>x<font color="#000080">) * </font>sizeof<font color="#000080">(</font>b<font color="#000080">);
     </font>XMS_move<font color="#000080">(</font>c<font color="#000080">);
     </font>d <font color="#000080">:= </font>true<font color="#000080">;
     </font><font color="#FF0000"><b>for </b></font>y <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">1999 </font><font color="#FF0000"><b>do
      </b></font>d <font color="#000080">:= </font>d <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>b<font color="#000080">[</font>y<font color="#000080">] = </font>x <font color="#000080">* </font>y<font color="#000080">);
     </font><font color="#FF0000"><b>if not </b></font>d <font color="#FF0000"><b>then
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'Error in array #      : '</font><font color="#000080">, </font>x<font color="#000080">)
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>if not </b></font>XMS_free<font color="#000080">(</font>XMS_handle<font color="#000080">) </font><font color="#FF0000"><b>then
     </b></font>writeln<font color="#000080">(</font><font color="#800000">'Error freeing EMB!'</font><font color="#000080">)

   </font><font color="#FF0000"><b>end else
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Error Allocating EMB!'</font><font color="#000080">)

  </font><font color="#FF0000"><b>end else
   </b></font>writeln<font color="#000080">(</font><font color="#800000">'No free XMS memory!'</font><font color="#000080">)

 </font><font color="#FF0000"><b>end else
  </b></font>writeln<font color="#000080">(</font><font color="#800000">'No XMS driver found!'</font><font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0094.PAS">Original</a><b>]</b></p></body>
</html>
