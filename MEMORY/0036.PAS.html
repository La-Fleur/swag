<html>
<head><title> "DOS Memory" by WIM VAN DER VEGT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here a small piece of code to determine the DOS memory (that
would be available at the DOS prompt) from within a TP program. It
doesn't account for UMB and heap limited programs (the $M directive).
It returns (almost) the value chkdsk and mem return for largest
available block of dos memory.
}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>Dosmem <font color="#000080">: </font>LONGINT<font color="#000080">;

</font><font color="#008000"><i>{----Returns Largest Free DOS memory as seen on the dos prompt by          }
{    CHKDSK and MEM.                                                       }

{----Records from The Programmer's PC Sourcebook by Thom Hogan, 1st Edition}

{    Only relevant field commented. Tuned by be equal to DR-DOS's 6.0}
{    MEM command. Works only if programs allocates all memory available}
{    so no max heaplimits to enable TP's Exec.}

</i></font><font color="#FF0000"><b>Type
  </b></font>MCBrec <font color="#000080">= </font><font color="#FF0000"><b>RECORD
             </b></font>location   <font color="#000080">: </font>Char<font color="#000080">; </font><font color="#008000"><i>{----'M' is normal block, 'Z' is last block }
             </i></font>ProcessID<font color="#000080">,
             </font>allocation <font color="#000080">: </font>WORD<font color="#000080">; </font><font color="#008000"><i>{----Number of 16 Bytes paragraphs allocated}
             </i></font>reserved   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">11</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Byte<font color="#000080">;
           </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font>PSPrec <font color="#000080">= </font><font color="#FF0000"><b>RECORD
             </b></font>int20h<font color="#000080">,
             </font>EndofMem        <font color="#000080">: </font>WORD<font color="#000080">;
             </font>Reserved1       <font color="#000080">: </font>BYTE<font color="#000080">;
             </font>Dosdispatcher   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">5</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
             </font>Int22h<font color="#000080">,
             </font>Int23h<font color="#000080">,
             </font>INT24h          <font color="#000080">: </font>POINTER<font color="#000080">;
             </font>ParentPSP       <font color="#000080">: </font>WORD<font color="#000080">;
             </font>HandleTable     <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">20</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
             </font>EnvSeg          <font color="#000080">: </font>WORD<font color="#000080">; </font><font color="#008000"><i>{----Segment of Environment}
             </i></font>Reserved2       <font color="#000080">: </font>LONGINT<font color="#000080">;
             </font>HandleTableSize <font color="#000080">: </font>WORD<font color="#000080">;
             </font>HandleTableAddr <font color="#000080">: </font>POINTER<font color="#000080">;
             </font>Reserved3       <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">23</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
             </font>Int21           <font color="#000080">: </font>WORD<font color="#000080">;
             </font>RetFar          <font color="#000080">: </font>BYTE<font color="#000080">;
             </font>Reserved4       <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
             </font>DefFCB1         <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">36</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
             </font>DefFCB2         <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">20</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
             </font>Cmdlength       <font color="#000080">: </font>BYTE<font color="#000080">;
             </font>Cmdline         <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">127</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
           </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>pmcb   <font color="#000080">: ^</font>MCBrec<font color="#000080">;
  </font>emcb   <font color="#000080">: ^</font>MCBrec<font color="#000080">;
  </font>psp    <font color="#000080">: ^</font>PSPrec<font color="#000080">;
  </font>dmem   <font color="#000080">: </font>LONGINT<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>psp<font color="#000080">:=</font>PTR<font color="#000080">(</font>PrefixSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);      </font><font color="#008000"><i>{----PSP given by TP var                }
  </i></font>pmcb<font color="#000080">:=</font>Ptr<font color="#000080">(</font>PrefixSeg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);    </font><font color="#008000"><i>{----Programs MCB 1 paragraph before PSP}
  </i></font>emcb<font color="#000080">:=</font>Ptr<font color="#000080">(</font>psp<font color="#000080">^.</font>envseg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);  </font><font color="#008000"><i>{----Environment MCB 1 paragraph before
                                    envseg                             }
  </i></font>dosmem<font color="#000080">:=</font>LONGINT<font color="#000080">(</font>pmcb<font color="#000080">^.</font>allocation<font color="#000080">+</font>emcb<font color="#000080">^.</font>allocation<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">16</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of DOSmem}

</i></font><font color="#FF0000"><b>Begin
  </b></font>Writeln<font color="#000080">(</font>Dosmem<font color="#000080">,</font><font color="#800000">' Bytes available.'</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p></body>
</html>
