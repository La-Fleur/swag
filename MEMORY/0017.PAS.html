<html>
<head><title> "DPMI Memory Swap" by GUY MCLOUGHLIN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0017.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{===========================================================================
 BBS: Canada Remote Systems
Date: 05-30-93 (02:30)             Number: 25203
From: GUY MCLOUGHLIN               Refer#: NONE
  To: ALL                           Recvd: NO
Subj: BP7 DPMI SWAP-FILE #1          Conf: (552) R-TP
---------------------------------------------------------------------------

  Hi to All:

  ...I saw this source-code posted by one of the support people in
  the Borland Pascal conference on Compuserve. For those of you
  who are writing DPMI apps, this could come in quite handy as
  a means of obtaining &quot;virtual&quot; DPMI HEAP space.

  *** NOTE: This unit is ONLY for BORLAND PASCAL 7, and cannot be
            compiled with any version of Turbo Pascal. &lt;sorry&gt;
------------------------------------------------------------------------}

 {.$DEFINE DebugMode}

 {$IFDEF DebugMode}
   {$A+,B-,D+,E-,F-,G+,I+,L+,N-,O-,P+,Q+,R+,S+,T+,V+,X+,Y+}
 {$ELSE}
   {$A+,B-,D-,E-,F-,G+,I-,L-,N-,O-,P-,Q-,R-,S-,T-,V-,X+,Y-}
 {$ENDIF}

 {$IFNDEF DPMI}
   </i></font>ERROR<font color="#000080">!!! </font><font color="#FF0000"><b>UNIT </b></font>MUST BE COMPILED <font color="#FF0000"><b>FOR PROTECTED </b></font>MODE TARGET<font color="#000080">!!!
 </font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>unit </b></font>RTMswap<font color="#000080">;

</font><font color="#FF0000"><b>interface

const
  </b></font>rtmOK          <font color="#000080">= </font><font color="#800000">$0</font><font color="#000080">;
  </font>rtmNoMemory    <font color="#000080">= </font><font color="#800000">$1</font><font color="#000080">;
  </font>rtmFileIOError <font color="#000080">= </font><font color="#800000">$22</font><font color="#000080">;

  </font><font color="#008000"><i>(***** Opens a swapfile of the specified size. If a swapfile        *)
  (*     already exists, and the new size is larger, the swapfile     *)
  (*     will grow, otherwise the previous swap file parameters       *)
  (*     are used.                                                    *)
  (*                                                                  *)
  (*    Returns:   rtmOK           - Successful                       *)
  (*               rtmNoMemory     - Not enough disk space            *)
  (*               rtmFileIOError  - Could not open/grow file         *)
  (*                                                                  *)
  </i></font><font color="#FF0000"><b>function </b></font>MemInitSwapFile<font color="#000080">(</font><font color="#008000"><i>{input } </i></font>FileName <font color="#000080">: </font>pchar<font color="#000080">;
                                    </font>FileSize <font color="#000080">: </font>longint<font color="#000080">) :
                           </font><font color="#008000"><i>{output} </i></font>integer<font color="#000080">;

  </font><font color="#008000"><i>(***** Closes the swapfile if it was created by the current task.   *)
  (*     If the value returned in &quot;Delete&quot; is non-zero, the swapfile  *)
  (*     was deleted.                                                 *)
  (*                                                                  *)
  (*    Returns:   rtmOK           - Successful                       *)
  (*               rtmNoMemory     - Not enough physical memory to    *)
  (*                                 run without the swap file.       *)
  (*               rtmFileIOError  - Could not close/delete the file. *)
  (*                                                                  *)
  </i></font><font color="#FF0000"><b>function </b></font>MemCloseSwapFile<font color="#000080">(</font><font color="#008000"><i>{update} </i></font><font color="#FF0000"><b>var </b></font>Delete <font color="#000080">: </font>integer<font color="#000080">) :
                            </font><font color="#008000"><i>{output} </i></font>integer<font color="#000080">;

 </font><font color="#FF0000"><b>implementation

   function </b></font>MemInitSwapFile<font color="#000080">; </font><font color="#FF0000"><b>external </b></font><font color="#800000">'RTM' </font>index <font color="#800000">35</font><font color="#000080">;

   </font><font color="#FF0000"><b>function </b></font>MemCloseSwapFile<font color="#000080">; </font><font color="#FF0000"><b>external </b></font><font color="#800000">'RTM' </font>index <font color="#800000">36</font><font color="#000080">;

 </font><font color="#FF0000"><b>END</b></font><font color="#000080">.


</font><font color="#008000"><i>{------------------------------------------------------------------------

  ...I still can't figure out what to do with the value returned in
  the &quot;Delete&quot; parameter passed to &quot;MemCloseSwapFile&quot;, as it doesn't
  seem to return any specific value for me??? (Maybe it has to fail
  to return a value???)

  ...The next message is a demo program using this &quot;RTMswap&quot; unit.


                               - Guy                                }

 {.$DEFINE DebugMode}

 {$IFDEF DebugMode}
   {$A+,B-,D+,E-,F-,G+,I+,L+,N-,O-,P+,Q+,R+,S+,T+,V+,X+,Y+}
 {$ELSE}
   {$A+,B-,D-,E-,F-,G+,I-,L-,N-,O-,P-,Q-,R-,S-,T-,V-,X+,Y-}
 {$ENDIF}

 {$IFNDEF DPMI}
   </i></font>ERROR<font color="#000080">!!! </font><font color="#FF0000"><b>PROGRAM </b></font>MUST BE COMPILED <font color="#FF0000"><b>FOR PROTECTED </b></font>MODE TARGET<font color="#000080">!!!
 </font><font color="#008000"><i>{$ENDIF}

              (* Program to demonstrate how to create/delete DPMI     *)
              (* HEAP swap-file.                                      *)
</i></font><font color="#FF0000"><b>program </b></font>RTMswap_Demo<font color="#000080">;
</font><font color="#FF0000"><b>uses
  </b></font>RTMswap<font color="#000080">;

</font><font color="#FF0000"><b>const         </b></font><font color="#008000"><i>(* Maximum size for DPMI HEAP in bytes.                 *)
   </i></font>DPMI_HeapMax <font color="#000080">= </font><font color="#800000">16000 </font><font color="#000080">* </font><font color="#800000">1024</font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>SwapError<font color="#000080">,
  </font>DeleteStatus <font color="#000080">: </font>integer<font color="#000080">;
  </font>SwapSize     <font color="#000080">: </font>longint<font color="#000080">;
  </font>SwapFilename <font color="#000080">: </font>pchar<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
              </b></font><font color="#008000"><i>(* Calculate required DPMI HEAP swap-file size.         *)
  </i></font>SwapSize <font color="#000080">:= (</font>DPMI_HeapMax <font color="#000080">- </font>memavail<font color="#000080">);

              </font><font color="#008000"><i>(* Display current DPMI HEAP size.                      *)
  </i></font>writeln<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'Current DPMI HEAP size = '</font><font color="#000080">, (</font>memavail <font color="#FF0000"><b>div </b></font><font color="#800000">1024</font><font color="#000080">), </font><font color="#800000">' K'</font><font color="#000080">);
  </font>writeln<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'Increasing DPMI HEAP to 16,000 K via swap-file'</font><font color="#000080">);
  </font>writeln<font color="#000080">;

              </font><font color="#008000"><i>(* Assign DPMI HEAP swap-file name.                     *)
  </i></font>SwapFilename <font color="#000080">:= </font><font color="#800000">'SWAPDEMO.$$$'</font><font color="#000080">;

              </font><font color="#008000"><i>(* Attempt to create DPMI HEAP swap-file.               *)
  </i></font>SwapError <font color="#000080">:= </font>MemInitSwapFile<font color="#000080">(</font>SwapFilename<font color="#000080">, </font>SwapSize<font color="#000080">);

              </font><font color="#008000"><i>(* Check for errors in creating DPMI HEAP swap-file.    *)
  </i></font><font color="#FF0000"><b>case </b></font>SwapError <font color="#FF0000"><b>of
    </b></font>rtmOK          <font color="#000080">: </font><font color="#FF0000"><b>begin
                       </b></font>writeln<font color="#000080">((</font>SwapSize <font color="#FF0000"><b>div </b></font><font color="#800000">1024</font><font color="#000080">), </font><font color="#800000">' K DPMI HEAP ' </font><font color="#000080">+
                               </font><font color="#800000">'swap file created'</font><font color="#000080">);
                       </font>writeln<font color="#000080">;
                       </font>writeln<font color="#000080">(</font><font color="#800000">'Total DPMI HEAP size now = '</font><font color="#000080">,
                               (</font>memavail <font color="#FF0000"><b>div </b></font><font color="#800000">1024</font><font color="#000080">), </font><font color="#800000">' K'</font><font color="#000080">);
                       </font>writeln
                     <font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>rtmNoMemory    <font color="#000080">: </font>writeln<font color="#000080">(</font><font color="#800000">'ERROR!!! Not enough disk space to ' </font><font color="#000080">+
                             </font><font color="#800000">'create DPMI HEAP swap-file'</font><font color="#000080">);
    </font>rtmFileIOerror <font color="#000080">: </font>writeln<font color="#000080">(</font><font color="#800000">'ERROR!!! Could not open/grow DPMI ' </font><font color="#000080">+
                             </font><font color="#800000">'HEAP swapfile'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'UNKNOWN RTM ERROR!!!'</font><font color="#000080">)
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

              </font><font color="#008000"><i>(* If DPMI HEAP swap-file was created, then close it.   *)
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>SwapError <font color="#000080">= </font>rtmOK<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'Closing DPMI HEAP swap-file'</font><font color="#000080">); </font>writeln<font color="#000080">;

              </font><font color="#008000"><i>(* Attempt to close DPMI HEAP swap-file.                *)
      </i></font>SwapError <font color="#000080">:= </font>MemCloseSwapFile<font color="#000080">(</font>DeleteStatus<font color="#000080">);

              </font><font color="#008000"><i>(* Check for errors in closing DPMI HEAP swap-file.     *)
      </i></font><font color="#FF0000"><b>case </b></font>SwapError <font color="#FF0000"><b>of
        </b></font>rtmOK          <font color="#000080">: </font><font color="#FF0000"><b>begin
                           </b></font>writeln<font color="#000080">(</font><font color="#800000">'DPMI HEAP swap-file is closed'</font><font color="#000080">);
                           </font>writeln<font color="#000080">;
                           </font>writeln<font color="#000080">(</font><font color="#800000">'Current DPMI HEAP size now = '</font><font color="#000080">,
                                   (</font>memavail <font color="#FF0000"><b>div </b></font><font color="#800000">1024</font><font color="#000080">), </font><font color="#800000">' K'</font><font color="#000080">)
                         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>rtmNoMemory    <font color="#000080">: </font>writeln<font color="#000080">(</font><font color="#800000">'ERROR!!! Not enough RAM to run ' </font><font color="#000080">+
                                 </font><font color="#800000">'without swap-file'</font><font color="#000080">);
        </font>rtmFileIOerror <font color="#000080">: </font>writeln<font color="#000080">(</font><font color="#800000">'ERROR!!! Could not close/delete ' </font><font color="#000080">+
                                 </font><font color="#800000">'swapfile'</font><font color="#000080">)
      </font><font color="#FF0000"><b>else
        </b></font>writeln<font color="#000080">(</font><font color="#800000">'UNKNOWN RTM ERROR!!!'</font><font color="#000080">)
      </font><font color="#FF0000"><b>end
    end
END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0017.PAS">Original</a><b>]</b></p></body>
</html>
