<html>
<head><title> "UMB Heap" by JASON ROTHSTEIN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0074.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
    Here is the UMB_Heap unit i found in a copy of PC Magazine a while back..
This code works on my 486DX/2 66mhz with 4meg ram...    so it should (i hope)
run on yourz too....    All you need to do to use this is just call
Extend_Heap in your program someplace to get the extra heap memory, and
GetBlockSizes if you wish to know how large the UMB blocks are that were
allocated...


}

</i></font><font color="#FF0000"><b>Unit
  </b></font>UMB_Heap<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Const
  </b></font>Max_Blocks      <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>UMBDataType <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>Max_Blocks<font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Extend_Heap<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>GetBlockSizes<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>US <font color="#000080">: </font>UMBDataType<font color="#000080">);

</font><font color="#FF0000"><b>Implementation

Type
  </b></font>PFreeRec        <font color="#000080">= ^</font>TFreeRec<font color="#000080">;
  </font>TFreeRec        <font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>Next          <font color="#000080">: </font>PFreeRec<font color="#000080">;
    </font>Size          <font color="#000080">: </font>Pointer<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Block_Segments  <font color="#000080">: </font>UMBDataType<font color="#000080">;
  </font>Block_Sizes     <font color="#000080">: </font>UMBDataType<font color="#000080">;
  </font>SaveExitProc    <font color="#000080">: </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>UMB_Driver_Present <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Flag            <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Flag <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov   AX, $4300
    Int   $2F
    CMP   AL, $80
    JNE   @Done
    Inc   [Flag]
  @Done:
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>UMB_Driver_Present <font color="#000080">:= </font>Flag<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Allocate_UMB<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">,
  </font>Save_Strategy<font color="#000080">,
  </font>Block_Segment<font color="#000080">,
  </font>Block_Size      <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  For </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>Max_Blocks <font color="#FF0000"><b>Do
    Begin
      </b></font>Block_Segments<font color="#000080">[</font>I<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
      </font>Block_Sizes<font color="#000080">[</font>I<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov   AX, $5801
    Mov   BX, $0FFFF
    Int   $21
    Mov   AX, $5803
    Mov   BX, $0001
    Int   $21
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>Max_Blocks <font color="#FF0000"><b>Do
    Begin
      </b></font>Block_Segment <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>Block_Size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>Asm
        </b></font><font color="#FF00FF">Mov   AX, $4800
        Mov   BX, $0FFFF
        Int   $21
        CMP   BX, 0
        JE    @Fail
        Mov   AX, $4800
        Int   $21
        JC    @Fail
        Mov   [Block_Segment], AX
        Mov   [Block_Size], BX
      @Fail:
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font>Block_Segments<font color="#000080">[</font>I<font color="#000080">] := </font>Block_Segment<font color="#000080">;
      </font>Block_Sizes<font color="#000080">[</font>I<font color="#000080">] := </font>Block_Size<font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Release_UMB<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">,
  </font>Segment <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ExitProc <font color="#000080">:= </font>SaveExitProc<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov   AX, $5803
    Mov   BX, $0000
    Int   $21
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>Max_Blocks <font color="#FF0000"><b>Do
    Begin
      </b></font>Segment <font color="#000080">:= </font>Block_Segments<font color="#000080">[</font>I<font color="#000080">];
      </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>Segment <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Then
        Asm
          </b></font><font color="#FF00FF">Mov   AX, $4901
          Mov   BX, [Segment]
          Mov   ES, BX
          Int   $21
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Pointer_To_LongInt<font color="#000080">(</font>p <font color="#000080">: </font>Pointer<font color="#000080">) : </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>PtrRec          <font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>Lo<font color="#000080">, </font>Hi        <font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Pointer_To_LongInt <font color="#000080">:= </font>LongInt<font color="#000080">(</font>PtrRec<font color="#000080">(</font>P<font color="#000080">).</font>Hi <font color="#000080">* </font><font color="#800000">16 </font><font color="#000080">+ </font>PtrRec<font color="#000080">(</font>P<font color="#000080">).</font>Lo<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Extend_Heap<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>I               <font color="#000080">: </font>Word<font color="#000080">;
  </font>Temp            <font color="#000080">: </font>PFreeRec<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>UMB_Driver_Present <font color="#FF0000"><b>then
    Begin
      </b></font>Allocate_UMB<font color="#000080">;
      </font>Temp <font color="#000080">:= </font>HeapPtr<font color="#000080">;
      </font>I <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>While </b></font><font color="#000080">((</font>Block_Sizes<font color="#000080">[</font>I<font color="#000080">] &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>And
             </b></font><font color="#000080">(</font>I <font color="#000080">&lt;= </font>Max_Blocks<font color="#000080">)) </font><font color="#FF0000"><b>Do
        Begin
          </b></font>Temp<font color="#000080">^.</font>Next <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Block_Segments<font color="#000080">[</font>I<font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);
          </font>Temp       <font color="#000080">:= </font>Temp<font color="#000080">^.</font>Next<font color="#000080">;
          </font>Temp<font color="#000080">^.</font>Next <font color="#000080">:= </font>HeapPtr<font color="#000080">;
          </font>Move<font color="#000080">(</font>Block_Sizes<font color="#000080">[</font>I<font color="#000080">], </font>Temp<font color="#000080">^.</font>Size<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Word<font color="#000080">));
          </font>Temp<font color="#000080">^.</font>Size <font color="#000080">:= </font>Pointer<font color="#000080">(</font>LongInt<font color="#000080">(</font>Temp<font color="#000080">^.</font>Size<font color="#000080">) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">16</font><font color="#000080">);
          </font>Inc<font color="#000080">(</font>I<font color="#000080">);
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>Block_Sizes<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
        </b></font>FreeList <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Block_Segments<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>GetBlockSizes<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>US <font color="#000080">: </font>UMBDataType<font color="#000080">);

</font><font color="#FF0000"><b>Begin
  </b></font>US <font color="#000080">:= </font>Block_Sizes<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>FillChar<font color="#000080">(</font>Block_Sizes<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Block_Sizes<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font>SaveExitProc <font color="#000080">:= </font>ExitProc<font color="#000080">;
  </font>ExitProc <font color="#000080">:= @</font>Release_UMB<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0074.PAS">Original</a><b>]</b></p></body>
</html>
