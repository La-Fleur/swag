<html>
<head><title> "Available DOS Memory" by ANDREW EIGUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0071.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
  From: Andrew Eigus                                 Read: Yes    Replied: No

&gt; Well, the subject says it, how can I get a 65536 Bytes hunk of memory?
&gt; There has to be another way, maybe a dos call or something?

Yes. The following are routines to allocate memory using DOS functions,
the limitation is that HeapMin and HeapMax should be set both to zero like
this: {$M 8192,0,0}

</i></font><font color="#FF0000"><b>Function </b></font>DosMaxAvail <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#008000"><i>{$IFNDEF ProtectedMode}
</i></font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Returns the size of the largest contiguous free memory block
  This function should be called ONLY when both HeapMin/HeapMax
  memory allocation parameters set to zero }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov bx,0FFFFh
  mov ah,48h
  int 21h
  mov ax,bx
  mov bx,16
  mul BX
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
</i></font><font color="#FF0000"><b>Begin
  </b></font>DosMaxAvail <font color="#000080">:= </font>GetFreeSpace<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">) </font><font color="#008000"><i>{ uses WinAPI for DPMI }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ DosMaxAvail }
{$ENDIF}

</i></font><font color="#FF0000"><b>Function </b></font>DosGetMem<font color="#000080">(</font>Size <font color="#000080">: </font>longint<font color="#000080">) : </font>pointer<font color="#000080">;
</font><font color="#008000"><i>{ Creates a dynamic variable of the specified size and returns the pointer
  to it. This function should be called ONLY when both HeapMin/HeapMax
  memory allocation parameters set to zero. This function returns a pointer to
  allocated data buffer which can lie in different segments, or it returns
  a nil pointer if the dos call was unsuccessful; in that case, the
Dos.DosError variable keeps error code }{$IFNDEF ProtectedMode}
</i></font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
</b></font><font color="#FF00FF">@@1:
  mov DosError,0 </font><font color="#008000"><i>{ uses Dos }
  </i></font><font color="#FF00FF">mov ax,word ptr [Size]
  mov dx,word ptr [Size+2]
  mov cx,16
  div cx
  inc ax
  mov bx,ax
  mov ah,48h
  int 21h
  jnc @@2
  mov DosError,ax </font><font color="#008000"><i>{ save error code in Dos.DosError variable }
  </i></font><font color="#FF00FF">xor ax,ax </font><font color="#008000"><i>{ return nil pointer }
</i></font><font color="#FF00FF">@@2:
  mov dx,ax </font><font color="#008000"><i>{ save segment }
  </i></font><font color="#FF00FF">xor ax,ax </font><font color="#008000"><i>{ offset allways zero }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
</i></font><font color="#FF0000"><b>Begin
  </b></font>DosGetMem <font color="#000080">:= </font>GlobalAllocPtr<font color="#000080">(</font>gmem_ZeroInit <font color="#FF0000"><b>or </b></font>gmem_Moveable<font color="#000080">, </font>Size<font color="#000080">) </font><font color="#008000"><i>{ WinAPI }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ DosGetMem }
{$ENDIF}

</i></font><font color="#FF0000"><b>Function </b></font>DosFreeMem<font color="#000080">(</font>P <font color="#000080">: </font>pointer<font color="#000080">) : </font>integer<font color="#000080">;
</font><font color="#008000"><i>{ Disposes of a given dynamic variable. This function should be called ONLY
  when both HeapMin/HeapMax memory allocation parameters set to zero. This
  function returns non-zero DOS error code if the function failed, or zero
  if the call was successful }
{$IFNDEF ProtectedMode}
</i></font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov DosError,0 </font><font color="#008000"><i>{ set Dos.DosError to noerror }
  </i></font><font color="#FF00FF">mov es,word ptr [P+2]
  mov ah,49h
  int 21h
  jnc @@1
  mov DosError,ax
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
</i></font><font color="#FF0000"><b>Begin
  </b></font>DosFreeMem <font color="#000080">:= </font>GlobalFreePtr<font color="#000080">(</font>P<font color="#000080">)
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ DosFreeMem }
{$ENDIF}

</i></font><font color="#FF0000"><b>Function </b></font>DosRegetMem<font color="#000080">(</font>P <font color="#000080">: </font>pointer<font color="#000080">; </font>NewSize <font color="#000080">: </font>longint<font color="#000080">) : </font>pointer<font color="#000080">;
</font><font color="#008000"><i>{ Changes the size of an existing memory block. This function should be called
  ONLY when both HeapMin/HeapMax memory allocation parameters set to zero.
  It returns a nil pointer, if the call was unsuccessful, otherwise it returns
  a pointer to reallocated data buffer }
{$IFNDEF ProtectedMode}
</i></font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
</b></font><font color="#FF00FF">@@1:
  mov DosError,0 </font><font color="#008000"><i>{ using Dos unit still :) }
  </i></font><font color="#FF00FF">mov ax,word ptr [NewSize]
  mov dx,word ptr [NewSize+2]
  mov cx,16
  div cx
  inc ax
  mov bx,ax
  mov ah,4Ah
  int 21h
  jnc @@2
  mov DorError,ax </font><font color="#008000"><i>{ save error code in DosError }
  </i></font><font color="#FF00FF">xor ax,ax </font><font color="#008000"><i>{ return a nil pointer }
</i></font><font color="#FF00FF">@@2:
  mov dx,ax
  xor ax,ax
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
</i></font><font color="#FF0000"><b>Begin
  </b></font>DosRegetMem <font color="#000080">:= </font>GlobalReallocPtr<font color="#000080">(</font>P<font color="#000080">, </font>NewSize<font color="#000080">, </font>gmem_ZeroInit <font color="#FF0000"><b>or </b></font>gmem_Moveable<font color="#000080">)
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ DosRegetMem }
{$ENDIF}

</i></font>Example<font color="#000080">:

  </font><font color="#008000"><i>{$M 4096,0,0}
  </i></font><font color="#FF0000"><b>var </b></font>P <font color="#000080">: </font>pointer<font color="#000080">;

  </font><font color="#FF0000"><b>Begin
    </b></font>P <font color="#000080">:= </font>DosGetMem<font color="#000080">(</font><font color="#800000">128 </font><font color="#FF0000"><b>shl </b></font><font color="#800000">10</font><font color="#000080">); </font><font color="#008000"><i>{ allocate 128k }
    </i></font><font color="#FF0000"><b>if </b></font>P <font color="#000080">= </font><font color="#FF0000"><b>nil then
      </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'It seems that you haven''t enough memory, eh?'</font><font color="#000080">)
    </font><font color="#FF0000"><b>else
    begin
      </b></font>P <font color="#000080">:= </font>DosRegetMem<font color="#000080">(</font><font color="#800000">256 </font><font color="#FF0000"><b>shl </b></font><font color="#800000">10</font><font color="#000080">); </font><font color="#008000"><i>{ reallocate this block to 256k }
      </i></font><font color="#FF0000"><b>if </b></font>P <font color="#000080">= </font><font color="#FF0000"><b>nil then
        </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'No, 256k is too much! :-)'</font><font color="#000080">)
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>DosFreeMem<font color="#000080">(</font>P<font color="#000080">)
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0071.PAS">Original</a><b>]</b></p></body>
</html>
