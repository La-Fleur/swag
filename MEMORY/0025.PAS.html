<html>
<head><title> "Shrink/Expand the Heap" by KENT BRIGGS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0025.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
KENT BRIGGS

Here is what I came up with regarding my problem of needing a large
heap (temporarily) and needing memory for an EXEC routine:
}

</i></font><font color="#FF0000"><b>procedure </b></font>heap_shrink<font color="#000080">;    </font><font color="#008000"><i>{free up all unused heap}
</i></font><font color="#FF0000"><b>begin
  </b></font>reg<font color="#000080">.</font>bx <font color="#000080">:= </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>heapptr<font color="#000080">) : </font>ofs<font color="#000080">(</font>heapptr<font color="#000080">) + </font><font color="#800000">2</font><font color="#000080">] - </font>prefixseg<font color="#000080">;
  </font>reg<font color="#000080">.</font>es <font color="#000080">:= </font>prefixseg<font color="#000080">;
  </font>reg<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$4a</font><font color="#000080">;            </font><font color="#008000"><i>{dos memory alloc. interrupt}
  </i></font>msdos<font color="#000080">(</font>reg<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>heap_expand<font color="#000080">;    </font><font color="#008000"><i>{reclaim unused heap}
</i></font><font color="#FF0000"><b>begin
  </b></font>reg<font color="#000080">.</font>bx <font color="#000080">:= </font>memw<font color="#000080">[</font>seg<font color="#000080">(</font>heapend<font color="#000080">) : </font>ofs<font color="#000080">(</font>heapend<font color="#000080">) + </font><font color="#800000">2</font><font color="#000080">] - </font>prefixseg<font color="#000080">;
  </font>reg<font color="#000080">.</font>es <font color="#000080">:= </font>prefixseg<font color="#000080">;
  </font>reg<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$4a</font><font color="#000080">;
  </font>msdos<font color="#000080">(</font>reg<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{
Leave the default heapmax at 655360.  Dispose of all temporary pointers
and call heap_shrink right before exec(my_prgm) and heap_expand right
after.  The memw's get the segment addresses for the heapend and heapptr
variables (see memory map in manual).  Subtract the PSP segment and that
gets you the number of paragraphs (16 byte blocks) to allocate.

Anyone see any dangers with this scheme?  I instantly freed up 110K for
DOS shells in my application.  No problems so far.
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0025.PAS">Original</a><b>]</b></p></body>
</html>
