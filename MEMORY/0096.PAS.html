<html>
<head><title> "Move 32bits" by PATRICK VAN OOSTERWIJCK</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>program </b></font>move32_test<font color="#000080">;

</font><font color="#FF0000"><b>USES </b></font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>count<font color="#000080">=</font><font color="#800000">1000</font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>block1<font color="#000080">,</font>block2<font color="#000080">:</font>pointer<font color="#000080">;
    </font>i<font color="#000080">,</font>time<font color="#000080">:</font>longint<font color="#000080">;
    </font>timer<font color="#000080">:</font>longint <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$6C</font><font color="#000080">;
    </font>size<font color="#000080">:</font>word<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Move32<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>source<font color="#000080">,</font>dest<font color="#000080">;</font>count<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">PUSH    DS
                LDS     SI,source
                LES     DI,dest
                MOV     CX,count
                SHR     CX,1
                JNC     @@1
                MOVSB
@@1:            SHR     CX,1
                JNC     @@2
                MOVSW
@@2:            DB      66h
                REP     MOVSW
                POP     DS
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ --- Mainprog --- }
</i></font><font color="#FF0000"><b>begin

  </b></font>clrScr<font color="#000080">;
  </font>getmem<font color="#000080">(</font>block1<font color="#000080">,</font><font color="#800000">65010</font><font color="#000080">);
  </font>getmem<font color="#000080">(</font>block2<font color="#000080">,</font><font color="#800000">65010</font><font color="#000080">);

  </font><font color="#FF0000"><b>for </b></font>size<font color="#000080">:=</font><font color="#800000">65000 </font><font color="#FF0000"><b>to </b></font><font color="#800000">65003 </font><font color="#FF0000"><b>do
    begin

     </b></font>writeln<font color="#000080">(</font><font color="#800000">'Timing blocks of '</font><font color="#000080">,</font>size<font color="#000080">,</font><font color="#800000">' bytes :'</font><font color="#000080">);

     </font>writeln<font color="#000080">(</font><font color="#800000">'  Timing Move ...'</font><font color="#000080">);
     </font>time<font color="#000080">:=</font>timer<font color="#000080">;
     </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>count <font color="#FF0000"><b>do
       </b></font>move<font color="#000080">(</font>block1<font color="#000080">^,</font>block2<font color="#000080">^,</font>size<font color="#000080">);
     </font>writeln<font color="#000080">(</font><font color="#800000">'  Time for '</font><font color="#000080">,</font>count<font color="#000080">,</font><font color="#800000">' Move''s   : '</font><font color="#000080">,(</font>timer<font color="#000080">-</font>time<font color="#000080">)/</font><font color="#800000">18.2</font><font color="#000080">:</font><font color="#800000">8</font><font color="#000080">:</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">' s'</font><font color="#000080">);

     </font>writeln<font color="#000080">(</font><font color="#800000">'  Timing Move32 ...'</font><font color="#000080">);
     </font>time<font color="#000080">:=</font>timer<font color="#000080">;
     </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>count <font color="#FF0000"><b>do
       </b></font>move32<font color="#000080">(</font>block1<font color="#000080">^,</font>block2<font color="#000080">^,</font>size<font color="#000080">);
     </font>writeln<font color="#000080">(</font><font color="#800000">'  Time for '</font><font color="#000080">,</font>count<font color="#000080">,</font><font color="#800000">' Move32''s : '</font><font color="#000080">,(</font>timer<font color="#000080">-</font>time<font color="#000080">)/</font><font color="#800000">18.2</font><font color="#000080">:</font><font color="#800000">8</font><font color="#000080">:</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">' s'</font><font color="#000080">);

    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font><font color="#008000"><i>{ -------------------------------------------------------- }

</i></font><font color="#FF0000"><b>If </b></font>you can<font color="#800000">'t find anything wrong in it, test it !
</font>Here are the results <font color="#FF0000"><b>on </b></font>a <font color="#800000">486</font>DX4<font color="#000080">-</font><font color="#800000">100 </font><font color="#000080">:

</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65000 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     11.0 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      3.6 s
</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65001 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     11.0 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      6.0 s
</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65002 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     11.0 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      6.0 s
</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65003 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     11.0 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      6.0 s

3 </font>times faster <font color="#FF0000"><b>on </b></font>a <font color="#800000">4 </font>byte boundary <font color="#FF0000"><b>and </b></font>still almost twice <font color="#FF0000"><b>as </b></font>fast <font color="#FF0000"><b>on </b></font>other
addresses <font color="#000080">! </font>I think that<font color="#800000">'s a nice score...
 </font>EH<font color="#000080">&gt; </font><font color="#FF0000"><b>For </b></font>REP MOVSD <font color="#FF0000"><b>to </b></font>work faster the values <font color="#FF0000"><b>to </b></font>be moved have <font color="#FF0000"><b>to </b></font>be <font color="#FF0000"><b>on </b></font><font color="#000080">&quot;</font><font color="#800000">32
</font>bit<font color="#000080">&quot; </font>EH<font color="#000080">&gt; </font>addresses<font color="#000080">, </font>that <font color="#FF0000"><b>is</b></font><font color="#000080">: </font>both SI <font color="#FF0000"><b>and </b></font>DI have <font color="#FF0000"><b>to </b></font>be a multiple <font color="#FF0000"><b>of </b></font><font color="#800000">4.
 </font>EH<font color="#000080">&gt; </font>You didn<font color="#800000">'t test for that and with the extra MOVSB and MOVSW it might well
 </font>EH<font color="#000080">&gt; </font>be they are <font color="#FF0000"><b>on </b></font>a multiple <font color="#FF0000"><b>of </b></font><font color="#800000">4 </font><font color="#000080">+ </font><font color="#800000">1 </font><font color="#FF0000"><b>or </b></font><font color="#800000">3 </font><font color="#000080">(</font><font color="#FF0000"><b>as </b></font>the aligment <font color="#FF0000"><b>of </b></font>TP normally
<font color="#FF0000"><b>is </b></font>EH<font color="#000080">&gt; </font><font color="#FF0000"><b>on </b></font>EVEN addresses<font color="#000080">).

</font>You<font color="#800000">'re right about that, maybe I'</font>ll work <font color="#FF0000"><b>on </b></font>it<font color="#000080">... </font>some day<font color="#000080">. ;-)

 </font>EH<font color="#000080">&gt; </font>Apart from that you didn<font color="#800000">'t test for overlap (does the move partially
 </font>EH<font color="#000080">&gt; </font>overwrite the bytes <font color="#FF0000"><b>TO </b></font>be moved<font color="#000080">, </font>because <font color="#FF0000"><b>then </b></font>those bytes have <font color="#FF0000"><b>to </b></font>be
moved EH<font color="#000080">&gt; </font>first<font color="#000080">)

</font>I hadn<font color="#800000">'t tought about that. I'</font>m <font color="#FF0000"><b>not </b></font>often moving overlapping blocks though<font color="#000080">.
</font>Are you sure the TP Move checks <font color="#FF0000"><b>for </b></font>that <font color="#000080">? (</font>I mean<font color="#000080">, </font><font color="#FF0000"><b>do </b></font>you <font color="#FF0000"><b>not </b></font>only assume<font color="#000080">,
</font>but have you tested it <font color="#000080">? :-))
 </font>EH<font color="#000080">&gt; </font><font color="#FF0000"><b>and </b></font>you didn<font color="#800000">'t set a direction flag so it just MIGHT be you'</font>re
 EH<font color="#000080">&gt; </font>moving the wrong bytes <font color="#000080">(</font>mostly the direction flag <font color="#FF0000"><b>IS </b></font>upwards<font color="#000080">, </font>but it just
 EH<font color="#000080">&gt; </font>might be downwards<font color="#000080">, </font>which means you<font color="#800000">'re moving the bytes BELOW &quot;ds:si&quot; to
 </font>EH<font color="#000080">&gt; &quot;</font>es<font color="#000080">:</font>di<font color="#000080">&quot;).

</font>The direction flag <font color="#FF0000"><b>is </b></font>assumed <font color="#FF0000"><b>to </b></font>be cleared <font color="#FF0000"><b>in </b></font>TP<font color="#000080">. </font>Every procudere that
changes it<font color="#000080">, </font>should clear it again<font color="#000080">. </font>But it<font color="#800000">'s not forbidden to do a CLD of
</font>course<font color="#000080">...
 </font>EH<font color="#000080">&gt; </font>A complete Move32 has <font color="#FF0000"><b>to </b></font>be much more complicated than this <font color="#000080">(</font><font color="#FF0000"><b>and </b></font>much
 EH<font color="#000080">&gt; </font>bigger<font color="#000080">, </font>thus<font color="#000080">). </font>Further Move <font color="#FF0000"><b>is </b></font>most often used <font color="#FF0000"><b>to</b></font><font color="#000080">/</font>from screen memory <font color="#FF0000"><b>and
 </b></font>EH<font color="#000080">&gt; </font>unless you got a PCI screen card <font color="#800000">32</font><font color="#000080">-</font>bits moves are <font color="#FF0000"><b>not </b></font>possible <font color="#FF0000"><b>to </b></font>screen
 EH<font color="#000080">&gt; </font>memory <font color="#000080">(</font>the cpu will automatically <font color="#FF0000"><b>do </b></font>each <font color="#800000">32</font><font color="#000080">-</font>bit doubleword <font color="#FF0000"><b>as </b></font><font color="#800000">2 16</font><font color="#000080">-</font>bits
 EH<font color="#000080">&gt; </font>words<font color="#000080">, </font><font color="#FF0000"><b>as </b></font>the bus <font color="#FF0000"><b>is </b></font>only <font color="#800000">16 </font>bits<font color="#000080">).

</font>PCI <font color="#000080">(</font><font color="#FF0000"><b>and </b></font>VLB<font color="#000080">) </font>are becoming more common today<font color="#000080">, </font>so I don<font color="#800000">'t see the problem...
</font>I tested this <font color="#FF0000"><b>with </b></font>mapping the <font color="#800000">2'nd block to $A000 in mode 13h. And I'</font>ve found
these _strange_ results <font color="#FF0000"><b>with </b></font>a VLB card <font color="#000080">:
</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65000 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     10.7 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      3.4 s
</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65001 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     10.7 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      5.8 s
</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65002 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     10.6 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      5.8 s
</font>Timing blocks <font color="#FF0000"><b>of </b></font><font color="#800000">65003 </font>bytes <font color="#000080">:
  </font>Timing Move <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move<font color="#800000">'s   :     10.6 s
  </font>Timing Move32 <font color="#000080">...
  </font>Time <font color="#FF0000"><b>for </b></font><font color="#800000">1000 </font>Move32<font color="#800000">'s :      5.8 s

</font>I always tought videoRAM was SLOWER than normal RAM <font color="#000080">???
</font><font color="#FF0000"><b>Do </b></font>you have an explanation <font color="#FF0000"><b>for </b></font>this <font color="#000080">?

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p></body>
</html>
