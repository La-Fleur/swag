<html>
<head><title> "Checking for Cache" by FRANCOIS THUNUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
FRANCOIS THUNUS

&gt; Would it be possible to throw a [Ctrl-Alt-Del] into the keyboard buffer,
&gt; causing Smartdrv to Write its data and warm boot the computer? if so, any
&gt; ideal how a person would do this?

trap keyboard info
if ctr-alt-del then begin
            check For smrtdrv
            if smrtdrv then flush cache
            reboot
            end;

Flush cache: (was posted here but since it is more than a month old, i guess
it's ok to repost ?):
}

</i></font><font color="#FF0000"><b>Unit </b></font>SfeCache<font color="#000080">;
</font><font color="#008000"><i>{

Max Maischein                                  Sunday,  7.03.1993
2:249/6.17                                         Frankfurt, GER

This  Unit  implements   an   automatic   flush   For   installed
Write-behind caches like SmartDrive and PC-Cache. It's  based  on
cache detection code by Norbert Igl, I added the calls  to  flush
the buffers. The stuff is only tested For SMARTDRV.EXE, the  rest
relies on Norbert and the INTERRUP.LST from Ralf Brown.

Al says : &quot;Save early, save often !&quot;

The Unit exports one  Procedure,  FlushCache,  this  flushes  the
first cache found. It  could  be  good  to  flush  everything  on
Program termination, since users are likely to switch  off  their
computers directly upon Exit from the Program.

This piece of code is donated to the public domain, but I request
that, if you use this code, you mention me in the DOCs somewhere.
                                                           -max
}
</i></font><font color="#FF0000"><b>Interface

Implementation

Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>AktCache <font color="#000080">: </font>Byte <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>FlushProc <font color="#000080">= </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>FlushCache <font color="#000080">: </font>FlushProc<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SmartDrv_exe <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Found <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Found <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push    bp
    stc
    mov     ax, 4A10h
    xor     bx, bx
    int     2Fh
    pop     bp
    jc      @NoSmartDrive
    cmp     ax, 0BABEh
    jne     @NoSmartDrive
    mov     Found, True
   @NoSmartDrive:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>SmartDrv_exe <font color="#000080">:= </font>Found<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SmartDrv_sys <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>F  <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>B  <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">$27</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{ return Buffer }
  </i></font>OK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Const
  </b></font>S <font color="#000080">= </font>SizeOf<font color="#000080">( </font>B <font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>SmartDrv_sys <font color="#000080">:= </font>False<font color="#000080">;
  </font>OK <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#008000"><i>{ -------Check For SmartDrv.SYS----------- }
  </i></font>Assign<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">'SMARTAAR'</font><font color="#000080">);
  </font><font color="#008000"><i>{$I-}
  </i></font>Reset<font color="#000080">( </font>F <font color="#000080">);
  </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>if </b></font>IoResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">; </font><font color="#008000"><i>{ No SmartDrv }
  </i></font>FillChar<font color="#000080">( </font>B<font color="#000080">, </font>Sizeof<font color="#000080">(</font>B<font color="#000080">), </font><font color="#800000">0 </font><font color="#000080">);
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push    ds
    mov     ax, 4402h
    mov     bx, TextRec( F ).Handle
    mov     cx, S
    mov     dx, seg B
    mov     ds, dx
    mov     dx, offset B
    int     21h
    jc      @Error
    mov     OK, 1
   @Error:
    pop     ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>close<font color="#000080">(</font>f<font color="#000080">);
  </font>SmartDrv_sys <font color="#000080">:= </font>OK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>CompaqPro <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>OK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CompaqPro <font color="#000080">:= </font>False<font color="#000080">;
  </font>OK <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov     ax, 0F400h
    int     16h
    cmp     ah, 0E2h
    jne     @NoCache
    or      al, al
    je      @NoCache
    cmp     al, 2
    ja      @NoCache
    mov     OK, 1
   @NoCache:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>CompaqPro <font color="#000080">:= </font>OK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>PC6 <font color="#000080">: </font>Boolean<font color="#000080">;   </font><font color="#008000"><i>{ PCTools v6, v5 }
</i></font><font color="#FF0000"><b>Var
  </b></font>OK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>PC6 <font color="#000080">:= </font>False<font color="#000080">;
  </font>OK <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov     ax, 0FFA5h
    mov     cx, 01111h
    int     16h
    or      ch, ch
    jne     @NoCache
    mov     OK, 1
   @NoCache:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>PC6 <font color="#000080">:= </font>OK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>PC5 <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>OK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>PC5 <font color="#000080">:= </font>False<font color="#000080">;
  </font>OK <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov     ax, 02BFFh
    mov     cx, 'CX';
    int     21h
    or      al, al
    jne     @NoCache
    mov     ok, 1
   @NoCache:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>PC5 <font color="#000080">:= </font>OK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>HyperDsk <font color="#000080">: </font>Boolean<font color="#000080">;   </font><font color="#008000"><i>{ 4.20+ ... }
</i></font><font color="#FF0000"><b>Var
  </b></font>OK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Hyperdsk <font color="#000080">:= </font>False<font color="#000080">;
  </font>OK <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov     ax, 0DF00h
    mov     bx, 'DH'
    int     02Fh
    cmp     al, 0FFh
    jne     @NoCache
    cmp     cx, 05948h
    jne     @NoCache
    mov     OK, 1
   @NoCache:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>HyperDSK <font color="#000080">:= </font>OK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>QCache <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>OK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>QCache <font color="#000080">:= </font>False<font color="#000080">;
  </font>OK <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov     ah, 027h
    xor     bx, bx
    int     013h
    or      bx, bx
    je      @NoCache
    mov     OK, 1
   @NoCache:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>QCache <font color="#000080">:= </font>OK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FlushSD_sys<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>F <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>B <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">'SMARTAAR'</font><font color="#000080">);
  </font>Reset<font color="#000080">(</font>F<font color="#000080">);
  </font>B <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push    ds
    mov     ax, 04403h
    mov     bx, FileRec(F).Handle
    mov     cx, 1
    int     21h
    pop     ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FlushSD_exe<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov     ax, 04A10h
  mov     bx, 1
  int     2Fh
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FlushPC6<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov     ax, 0F5A5h
  mov     cx, -1
  int     16h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FlushPC5<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov     ah, 0A1h
  mov     si, 04358h
  int     13h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FlushNoCache<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  if </b></font>SmartDrv_exe <font color="#FF0000"><b>then
    </b></font>FlushCache <font color="#000080">:= </font>FlushSD_exe
  <font color="#FF0000"><b>else
  if </b></font>SmartDrv_sys <font color="#FF0000"><b>then
    </b></font>FlushCache <font color="#000080">:= </font>FlushSD_sys
  <font color="#FF0000"><b>else
  if </b></font>PC6 <font color="#FF0000"><b>then
    </b></font>FlushCache <font color="#000080">:= </font>FlushPC6
  <font color="#FF0000"><b>else
  if </b></font>PC5 <font color="#FF0000"><b>then
    </b></font>FlushCache <font color="#000080">:= </font>FlushPC5
  <font color="#FF0000"><b>else
    </b></font>FlushCache <font color="#000080">:= </font>FlushNoCache<font color="#000080">;

  </font>FlushCache<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p></body>
</html>
