<html>
<head><title> "Re: 32bit Move() and Fillchar() replacem" by JOSHUA SHAGAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0090.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; &gt;If anyone wants to see my &quot;improved&quot; move() and fillchar() which I put
&gt; &gt;into a unit which I almost always link in I'd be happy to post it.  (I
&gt; &gt;know that TCA has an even better one though, in case he'd like to post
&gt; &gt;his version as well)
&gt;
&gt; Oh, fine.  Now that the world knows, I suppose I have to post it ;)
&gt;
Thank you for so graciously accepting the terms before anyone wanted me
to post my much more elementary 16-bit version as below:
}
</i></font><font color="#FF0000"><b>procedure </b></font>move <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>src<font color="#000080">, </font>dest<font color="#000080">; </font>count <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">push ds
    mov bx, count
    mov cx, bx
    shr cx, 1

    les di, src
    lds si, dest
    rep movsw

    and bx, 1
    jz @NoMovsB
    movsb
   @NoMovsB: 

  pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

&gt; </font>This <font color="#FF0000"><b>is </b></font>a <font color="#800000">32</font>bit move<font color="#000080">() </font>replacement<font color="#000080">.  </font>Just throw the <font color="#FF0000"><b>procedure in </b></font>at the 
<font color="#000080">&gt; </font>top <font color="#FF0000"><b>of </b></font>your <font color="#FF0000"><b>program</b></font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>all your move<font color="#000080">() </font>calls will work a little faster
<font color="#000080">&gt; (</font>about <font color="#800000">4 </font>times faster <font color="#FF0000"><b>for </b></font>counts above <font color="#800000">128 </font>bytes<font color="#000080">).
&gt; 
&gt; </font><font color="#FF0000"><b>procedure </b></font>move<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Source<font color="#000080">,</font>Dest<font color="#000080">; </font>Count<font color="#000080">:</font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
&gt; </font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">&gt;</font> 	<font color="#FF00FF">push</font>	<font color="#FF00FF">ds
&gt;</font> 	<font color="#FF00FF">les</font>	<font color="#FF00FF">di,Dest
&gt;</font> 	<font color="#FF00FF">lds</font>	<font color="#FF00FF">si,Source
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">cx,count
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,cx
&gt;</font> 	<font color="#FF00FF">shr</font>	<font color="#FF00FF">cx,2
&gt;</font> 	<font color="#FF00FF">db 66h;</font>	<font color="#FF00FF">rep movsw
&gt;</font> 	<font color="#FF00FF">and</font>	<font color="#FF00FF">bx,3
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">cx,bx
&gt;</font> 	<font color="#FF00FF">rep</font>	<font color="#FF00FF">movsb
&gt;</font> 	<font color="#FF00FF">pop</font>	<font color="#FF00FF">ds
&gt; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
&gt;
</font>I remember yours looking a little different <font color="#FF0000"><b>then </b></font>that<font color="#000080">, </font>maybe I<font color="#800000">'m thinking 
</font><font color="#FF0000"><b>of </b></font>fillchar <font color="#000080">(</font>later <font color="#FF0000"><b>on</b></font><font color="#000080">)... </font>but <font color="#FF0000"><b>not to </b></font>be picky<font color="#000080">, </font>since dx isn<font color="#800000">'t used, 
</font>couldn<font color="#800000">'t you use mov dx, ds and mov ds, dx instead of push and pop 
</font>respectively<font color="#000080">?

&gt; </font>The fillchar<font color="#000080">() </font>replacement isn<font color="#800000">'t as nice, since with fillchar you can do 
</font><font color="#000080">&gt; </font>things like<font color="#000080">: </font>fillchar<font color="#000080">(</font>foo<font color="#000080">,</font><font color="#800000">128</font><font color="#000080">,</font><font color="#800000">'H'</font><font color="#000080">); </font><font color="#FF0000"><b>or </b></font>fillchar<font color="#000080">(</font>foo<font color="#000080">,</font><font color="#800000">128</font><font color="#000080">,</font>TRUE<font color="#000080">);  
&gt; </font>That makes conversions more difficult<font color="#000080">.  </font>Still<font color="#000080">, </font><font color="#FF0000"><b>for </b></font>those <font color="#FF0000"><b>of </b></font>you who don<font color="#800000">'t 
</font><font color="#000080">&gt; </font><font color="#FF0000"><b>do </b></font>that<font color="#000080">:
&gt; 
&gt; </font><font color="#FF0000"><b>procedure </b></font>fillchar<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>X<font color="#000080">; </font>Count<font color="#000080">:</font>word<font color="#000080">; </font>Value<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
&gt; </font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">&gt;</font> 	<font color="#FF00FF">les</font>	<font color="#FF00FF">di,X
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">cx,count
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">al,value
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ah,al
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,ax
&gt;</font> 	<font color="#FF00FF">db 66h;</font>	<font color="#FF00FF">shl ax,16
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">ax,bx
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">bx,cx
&gt;</font> 	<font color="#FF00FF">shr</font>	<font color="#FF00FF">cx,2
&gt;</font> 	<font color="#FF00FF">db 66h; rep stosw
&gt;</font> 	<font color="#FF00FF">and</font>	<font color="#FF00FF">bx,3
&gt;</font> 	<font color="#FF00FF">mov</font>	<font color="#FF00FF">cx,bx
&gt;</font> 	<font color="#FF00FF">rep</font>	<font color="#FF00FF">stosb
&gt; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
&gt; 
</font>Hmmm<font color="#000080">... </font>you must have rewritten both <font color="#FF0000"><b>of </b></font>them since I last saw them<font color="#000080">, </font><font color="#FF0000"><b>as </b></font>I 
remember something utilizing adc <font color="#FF0000"><b>in </b></font>one <font color="#FF0000"><b>of </b></font>those<font color="#000080">... </font>oh well<font color="#000080">, </font>thse look 
more logical anyway <font color="#000080">:)

&gt; </font><font color="#FF0000"><b>To </b></font>get around the character <font color="#FF0000"><b>or </b></font>boolean types<font color="#000080">, </font><font color="#FF0000"><b>do </b></font>ord<font color="#000080">(</font><font color="#800000">'H'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>ord<font color="#000080">(</font>TRUE<font color="#000080">).
&gt; (</font>It all compiles <font color="#FF0000"><b>to </b></font>the same code<font color="#000080">).
&gt; 
&gt; </font>This <font color="#FF0000"><b>procedure </b></font>will only increase the speed <font color="#FF0000"><b>of </b></font>fillchar<font color="#000080">() </font>calls when the 
<font color="#000080">&gt; </font>Count <font color="#FF0000"><b>is </b></font>above <font color="#800000">128 </font><font color="#FF0000"><b>or </b></font>so<font color="#000080">.  </font>It will also fillchar <font color="#FF0000"><b>to </b></font>pointers faster than 
<font color="#000080">&gt; </font>arrays <font color="#000080">(</font>since pointers are aligned<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>arrays are <font color="#000080">[</font>usually<font color="#000080">] </font><font color="#FF0000"><b>not</b></font><font color="#000080">).  </font>I 
<font color="#000080">&gt; </font>just wrote the fillchar<font color="#000080">() </font><font color="#FF0000"><b>procedure</b></font><font color="#000080">, </font>so it <font color="#FF0000"><b>is not as </b></font>optimized <font color="#FF0000"><b>as </b></font>it
<font color="#000080">&gt; </font>could be<font color="#000080">.
&gt; 
</font>How about I put up my fillchar <font color="#FF0000"><b>as </b></font>well<font color="#000080">, </font>just <font color="#FF0000"><b>for </b></font>comparison<font color="#800000">'s sake (it'</font>s<font color="#000080">, 
</font>once again<font color="#000080">, </font>only <font color="#800000">16</font><font color="#000080">-</font>bit<font color="#000080">, </font>but it seems <font color="#FF0000"><b>to </b></font>work just fine anyway <font color="#000080">:)

</font><font color="#FF0000"><b>procedure </b></font>FillChar <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>src<font color="#000080">, </font>dest<font color="#000080">; </font>count <font color="#000080">: </font>word<font color="#000080">; </font>value <font color="#000080">: </font>byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov bx, count
  mov cx, bx
  shr cx, 1

  mov al, value
  mov ah, al

  les di, dest
  rep stosw

  and bx, 1
  jz @NoStosB
  stosb
 @NoStosB:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>In </b></font>other words it<font color="#800000">'s my move() only with ax = 257*value and, well, a fill
</font>instead <font color="#FF0000"><b>of </b></font>a move<font color="#000080">. :)

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0090.PAS">Original</a><b>]</b></p></body>
</html>
