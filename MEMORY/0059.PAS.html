<html>
<head><title> "256k Memory in BASM" by ANDREW EIGUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0059.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 CF&gt; Ok I know in pascal you can basiclly us up t0 64k for varibles.... But how
 CF&gt; can I set it up to use... lets say 256k for varibles.  I mean, -XMS-
 CF&gt; memeory?                                 =- Chris Forbis

First, you may allocate 256k without XMS. Just using the following routines:


function DosMaxAvail : longint;
function MemAlloc(Size : longint) : pointer;
function MemFree(P : pointer) : integer;
function MemRealloc(P : pointer; NewSize : longint) : integer;
}

</i></font><font color="#FF0000"><b>Function </b></font>DosMaxAvail <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Returns the size of the largest contiguous free memory block
  This function should be called ONLY when both HeapMin/HeapMax
  memory allocation parameters set to zero }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">MOV BX,0FFFFh
  MOV AH,48h
  INT 21h
  MOV AX,BX
  MOV BX,16
  MUL BX
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ DosMaxAvail }

</i></font><font color="#FF0000"><b>Function </b></font>MemAlloc<font color="#000080">(</font>Size <font color="#000080">: </font>longint<font color="#000080">) : </font>pointer<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Creates a dynamic variable of the specified size and returns the pointer
  to it. This function should be called ONLY when both HeapMin/HeapMax
  memory allocation parameters set to zero }
</i></font><font color="#FF0000"><b>Asm
</b></font><font color="#FF00FF">@@1:
  MOV AX,WORD PTR [Size]
  MOV DX,WORD PTR [Size+2]
  MOV CX,16
  DIV CX
  INC AX
  MOV BX,AX
  MOV AH,48h
  INT 21h
  JNC @@2
  XOR AX,AX
@@2:
  MOV DX,AX
  XOR AX,AX
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ MemAlloc }

</i></font><font color="#FF0000"><b>Procedure </b></font>MemFree<font color="#000080">(</font>P <font color="#000080">: </font>pointer<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Disposes of a given dynamic variable. This function should be called ONLY
  when both HeapMin/HeapMax memory allocation parameters set to zero }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">MOV ES,WORD PTR [P+2]
  MOV AH,49h
  INT 21h
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ MemFree }

</i></font><font color="#FF0000"><b>Function </b></font>MemRealloc<font color="#000080">(</font>P <font color="#000080">: </font>pointer<font color="#000080">; </font>NewSize <font color="#000080">: </font>longint<font color="#000080">) : </font>pointer<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Changes the size of en existed memory block. This function should be called
  ONLY when both HeapMin/HeapMax memory allocation parameters set to zero }
</i></font><font color="#FF0000"><b>Asm
</b></font><font color="#FF00FF">@@1:
  MOV AX,WORD PTR [NewSize]
  PUSH AX
  MOV DX,WORD PTR [NewSize+2]
  PUSH DX
  MOV CX,16
  DIV CX
  INC AX
  MOV BX,AX
  MOV AH,4Ah
  INT 21h
  POP DX
  POP AX
  JNC @@2
  XOR DX,DX
  XOR AX,AX
@@2:
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{ MemRealloc }

{ Okey, the main program: }

{$M 4096,0,0}

</i></font><font color="#FF0000"><b>const </b></font>MemToAlloc <font color="#000080">= </font><font color="#800000">256 </font><font color="#000080">* </font><font color="#800000">1024</font><font color="#000080">; </font><font color="#008000"><i>{ 256k }
</i></font><font color="#FF0000"><b>var </b></font>MemoryBlock <font color="#000080">: </font>pointer<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  if </b></font>DosMaxAvail <font color="#000080">&gt;= </font>MemToAlloc <font color="#FF0000"><b>then
  begin
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Dos free memory before allocating '</font><font color="#000080">,
      </font>MemToAlloc <font color="#FF0000"><b>shr </b></font><font color="#800000">10</font><font color="#000080">, </font><font color="#800000">'kb: '</font><font color="#000080">, </font>DosMaxAvail <font color="#FF0000"><b>shr </b></font><font color="#800000">10</font><font color="#000080">, </font><font color="#800000">'kb.'</font><font color="#000080">);
    </font>MemoryBlock <font color="#000080">:= </font>MemAlloc<font color="#000080">(</font>MemToAlloc<font color="#000080">);
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'Dos free memory after allocating '</font><font color="#000080">,
      </font>MemToAlloc <font color="#FF0000"><b>shr </b></font><font color="#800000">10</font><font color="#000080">, </font><font color="#800000">'kb: '</font><font color="#000080">, </font>DosMaxAvail <font color="#FF0000"><b>shr </b></font><font color="#800000">10</font><font color="#000080">, </font><font color="#800000">'kb.'</font><font color="#000080">);
    </font><font color="#008000"><i>{ if MemoryBlock = nil then report an error... }
    </i></font>MemFree<font color="#000080">(</font>MemoryBlock<font color="#000080">)
  </font><font color="#FF0000"><b>end else </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Not enough memory. '</font><font color="#000080">,
    (</font>MemToAlloc <font color="#000080">- </font>DosMaxAvail<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">10</font><font color="#000080">, </font><font color="#800000">'kb more needed.'</font><font color="#000080">)
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0059.PAS">Original</a><b>]</b></p></body>
</html>
