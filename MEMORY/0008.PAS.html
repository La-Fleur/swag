<html>
<head><title> "MALLOC.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$S-,R-,V-,I-,N-,B-,F-}

{$IFNDEF Ver40}
{Allow overlays}
{$F+,O-,X+,A-}
{$ENDIF}

</i></font><font color="#FF0000"><b>UNIT </b></font>MemAlloc<font color="#000080">;

  </font><font color="#008000"><i>{ Purpose is to provide the ability to create (destroy) dynamic variables  }
  { without needing to reserve heap space at compile time.                   }

</i></font><font color="#FF0000"><b>INTERFACE

FUNCTION </b></font>Malloc<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Ptr<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{ Allocate free memory and return a pointer to it.  The amount of memory      }
  { requested from DOS is calculated as (Size/4)+1 paragraphs.  If the          }
  { allocation is successful, the untyped VAR parameter Ptr will be populated   }
  { with the address of the allocated memory block, and the function will return}
  { a zero result.  Should the request to DOS fail, Ptr will be populated with  }
  { the value NIL, and the function will return the appropriate DOS error code. }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>Dalloc<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Ptr<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{ Deallocate the memory pointed to by the untyped VAR parameter Ptr           }

</i></font><font color="#FF0000"><b>IMPLEMENTATION

  FUNCTION </b></font>Malloc<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Ptr<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>BEGIN
    INLINE</b></font><font color="#000080">(
      </font><font color="#800000">$8B </font><font color="#000080">/ </font><font color="#800000">$46 </font><font color="#000080">/ &lt;</font>Size <font color="#000080">/         </font><font color="#008000"><i>{            mov         ax,[bp+&lt;Size]}
      </i></font><font color="#800000">$B9 </font><font color="#000080">/ </font><font color="#800000">$04 </font><font color="#000080">/ </font><font color="#800000">$00 </font><font color="#000080">/           </font><font color="#008000"><i>{            mov         cx,4}
      </i></font><font color="#800000">$D3 </font><font color="#000080">/ </font><font color="#800000">$E8 </font><font color="#000080">/                 </font><font color="#008000"><i>{            shr         ax,cl}
      </i></font><font color="#800000">$40 </font><font color="#000080">/                       </font><font color="#008000"><i>{            inc         ax}
      </i></font><font color="#800000">$89 </font><font color="#000080">/ </font><font color="#800000">$C3 </font><font color="#000080">/                 </font><font color="#008000"><i>{            mov         bx,ax}
      </i></font><font color="#800000">$B4 </font><font color="#000080">/ </font><font color="#800000">$48 </font><font color="#000080">/                 </font><font color="#008000"><i>{            mov         ah,$48}
      </i></font><font color="#800000">$CD </font><font color="#000080">/ </font><font color="#800000">$21 </font><font color="#000080">/                 </font><font color="#008000"><i>{            int         $21             ;Allocate memory}
      </i></font><font color="#800000">$72 </font><font color="#000080">/ </font><font color="#800000">$07 </font><font color="#000080">/                 </font><font color="#008000"><i>{            jc          AllocErr        ;If any errors ....}
      </i></font><font color="#800000">$C7 </font><font color="#000080">/ </font><font color="#800000">$46 </font><font color="#000080">/ </font><font color="#800000">$FE </font><font color="#000080">/ </font><font color="#800000">$00 </font><font color="#000080">/ </font><font color="#800000">$00 </font><font color="#000080">/ </font><font color="#008000"><i>{NoErrors:   mov word    [bp-2],0        ;Return 0 for successful allocation}
      </i></font><font color="#800000">$EB </font><font color="#000080">/ </font><font color="#800000">$05 </font><font color="#000080">/                 </font><font color="#008000"><i>{            jmp short   Exit}
      </i></font><font color="#800000">$89 </font><font color="#000080">/ </font><font color="#800000">$46 </font><font color="#000080">/ </font><font color="#800000">$FE </font><font color="#000080">/           </font><font color="#008000"><i>{AllocErr:   mov         [bp-2],ax       ;Return error code}
      </i></font><font color="#800000">$31 </font><font color="#000080">/ </font><font color="#800000">$C0 </font><font color="#000080">/                 </font><font color="#008000"><i>{            xor         ax,ax           ;Store a NIL value into the ptr}
      </i></font><font color="#800000">$C4 </font><font color="#000080">/ </font><font color="#800000">$7E </font><font color="#000080">/ &lt;</font>Ptr <font color="#000080">/          </font><font color="#008000"><i>{Exit:       les         di,[bp+&lt;Ptr]    ;Address of pointer into es:di}
      </i></font><font color="#800000">$50 </font><font color="#000080">/                       </font><font color="#008000"><i>{            push        ax              ;Save the Segment part}
      </i></font><font color="#800000">$31 </font><font color="#000080">/ </font><font color="#800000">$C0 </font><font color="#000080">/                 </font><font color="#008000"><i>{            xor         ax,ax           ;Offset is always 0}
      </i></font><font color="#800000">$FC </font><font color="#000080">/                       </font><font color="#008000"><i>{            cld                         ;Make sure direction is upward}
      </i></font><font color="#800000">$AB </font><font color="#000080">/                       </font><font color="#008000"><i>{            stosw                       ;Store offset of memory block}
      </i></font><font color="#800000">$58 </font><font color="#000080">/                       </font><font color="#008000"><i>{            pop         ax              ;Get back segment part}
      </i></font><font color="#800000">$AB</font><font color="#000080">);                       </font><font color="#008000"><i>{            stosw                       ;Store segment of memory block}
    
  </i></font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{Malloc} </i></font><font color="#000080">;

  </font><font color="#FF0000"><b>FUNCTION </b></font>Dalloc<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Ptr<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>BEGIN
    IF </b></font>Pointer<font color="#000080">(</font>Ptr<font color="#000080">) &lt;&gt; </font><font color="#FF0000"><b>NIL THEN BEGIN
      INLINE</b></font><font color="#000080">(
        </font><font color="#800000">$B4 </font><font color="#000080">/ </font><font color="#800000">$49 </font><font color="#000080">/               </font><font color="#008000"><i>{            mov         ah,$49}
        </i></font><font color="#800000">$C4 </font><font color="#000080">/ </font><font color="#800000">$7E </font><font color="#000080">/ &lt;</font>Ptr <font color="#000080">/        </font><font color="#008000"><i>{            les         di,[bp+&lt;Ptr]}
        </i></font><font color="#800000">$26 </font><font color="#000080">/ </font><font color="#800000">$C4 </font><font color="#000080">/ </font><font color="#800000">$3D </font><font color="#000080">/         </font><font color="#008000"><i>{        es: les         di,[di]}
        </i></font><font color="#800000">$CD </font><font color="#000080">/ </font><font color="#800000">$21 </font><font color="#000080">/               </font><font color="#008000"><i>{            int         $21}
        </i></font><font color="#800000">$72 </font><font color="#000080">/ </font><font color="#800000">$02 </font><font color="#000080">/               </font><font color="#008000"><i>{            jc          Exit}
        </i></font><font color="#800000">$31 </font><font color="#000080">/ </font><font color="#800000">$C0 </font><font color="#000080">/               </font><font color="#008000"><i>{NoError:    xor         ax,ax}
        </i></font><font color="#800000">$89 </font><font color="#000080">/ </font><font color="#800000">$46 </font><font color="#000080">/ </font><font color="#800000">$FE</font><font color="#000080">);         </font><font color="#008000"><i>{Exit:       mov         [bp-2],ax}
      </i></font>Pointer<font color="#000080">(</font>Ptr<font color="#000080">) := </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{if} </i></font><font color="#000080">;
  </font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{Dealloc} </i></font><font color="#000080">;

</font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{Unit MemAlloc} </i></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p></body>
</html>
