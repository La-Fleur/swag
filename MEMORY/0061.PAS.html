<html>
<head><title> "Free Stack Space" by JACK NOMSSI</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0061.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here is some code I use to find out how many stack space is used after a
run. I guess it won't work in protected mode. Be aware
it isn't byte-resolution ! I'd like to hear about enhancements.
}

</i></font><font color="#FF0000"><b>unit </b></font>Stack<font color="#000080">;
</font><font color="#FF0000"><b>interface
  procedure </b></font>InitStack<font color="#000080">;
  </font><font color="#FF0000"><b>procedure </b></font>TestStack<font color="#000080">;
</font><font color="#FF0000"><b>implementation

</b></font><font color="#008000"><i>(*
Routinen zum Pruefen des Stackbedarfs
Wilfried F?rber, Isar Software GmbH
Ringeisstr. 2a, 8000 Muenchen 2
August 1991

Routinen zum Pruefen, wieviel Stack wirklich benoetigt wird.
Willfried F?rber, Isar Software GmbH, August 1991
Port von C nach Pascal: Jacques NOMSSI NZALI,
email: nomssi@physikus.physik.tu-chemnitz.de
*)
</i></font><font color="#FF0000"><b>Var </b></font>STKHQQ <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>stacktext <font color="#000080">: </font><font color="#FF0000"><b>packed array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#000080">= </font><font color="#800000">'STAC'</font><font color="#000080">;
  </font>MAXSTACK <font color="#000080">= (</font><font color="#800000">1024 </font><font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">)*</font><font color="#800000">64</font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>atopsp <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax, sp
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>InitStack<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>AktStack<font color="#000080">,
  </font>Anzahl <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>STKHQQ <font color="#000080">:= </font>StackLimit<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov AktStack, bp
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Anzahl <font color="#000080">:= (</font>AktStack <font color="#000080">- </font>STKHQQ<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">4</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov cx, [Anzahl]
    mov di, [STKHQQ]
    mov ax, ss

    mov es, ax
    mov ax, Offset StackText
    @L1:
    mov si, ax
    movsw
    movsw
    loop @L1
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>StackSize <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>StackSize <font color="#000080">:= - </font>STKHQQ <font color="#000080">+ </font>atopsp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>StackUsed <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>StackFrei<font color="#000080">,
  </font>StackMax <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>StackMax <font color="#000080">:= </font>StackSize<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov cx, MAXSTACK
    mov di, [STKHQQ]
    mov ax, ss

    mov es, ax
    mov ax, Offset Stacktext
  @L1:
    mov si, ax
    cmpsw
    jnz @L2
    cmpsw
    loope @L1
  @L2:
    sub cx, MAXSTACK
    not cx
    mov [StackFrei], cx
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>StackFrei <font color="#000080">:= </font>StackFrei<font color="#000080">*</font><font color="#800000">4</font><font color="#000080">;
  </font>StackUsed <font color="#000080">:= </font>StackMax <font color="#000080">- </font>StackFrei<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TestStack<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>StackVerb<font color="#000080">, </font>_MaxStack <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>_MaxStack <font color="#000080">:= </font>StackSize<font color="#000080">;
  </font>StackVerb <font color="#000080">:= </font>StackUsed<font color="#000080">;
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'STACK-VERBRAUCHSTEST ---------------------- '</font><font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Programmstack :'</font><font color="#000080">, </font>_MaxStack<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Es wurden ca. '</font><font color="#000080">,</font>StackVerb<font color="#000080">,</font><font color="#800000">' Bytes benoetigt.'</font><font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Stack-Reserve :'</font><font color="#000080">,</font>MaxStack<font color="#000080">-</font>StackVerb<font color="#000080">,</font><font color="#800000">' Bytes.'</font><font color="#000080">);
  </font>ReadLn<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>InitStack<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0061.PAS">Original</a><b>]</b></p></body>
</html>
