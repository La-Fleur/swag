<html>
<head><title> "Clear ALL Memory" by DJ MURDOCH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0049.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*

CLEARMEM - A Turbo Pascal unit to automatically initialize the heap, stack, or
data segment to a fixed value.

Written by D.J. Murdoch for the public domain.

Interface:

  const
    filler : byte = 0;

This byte is used as the initial value.  A good choice for turning up
uninitialized variables is $FF - this will often cause a range check, and will
cause runtime error 207 if you try to use an uninitialized single, double or
extended.

  procedure clear_heap;

This procedure fills the heap with filler bytes.  Automatically called in the
initialization section.

  procedure clear_globals;

This procedure fills all global variables (except those in the system unit) with
filler bytes.  Very dangerous!  *Not* called in the initialization section
(unless you change it).  Written for TP 6.0; the source code gives hints on how
to change it for other versions.

  procedure clear_stack;

This procedure fills the unused part of the stack with filler bytes.

SAFETY

It's safe to call clear_heap any time; it'll fill all free blocks of 6 bytes or
more on the heap with the filler byte.  It won't necessarily do a perfect fill
if the heap is fragmented, because the free list will overwrite the filler.

It's also safe to call clear_stack any time, but is a bit less effective.  Any
interrupts that happen after your call will mess up the stack that you've just
cleared, so local variables won't necessarily be properly initialized.  It
doesn't touch anything already allocated.

It's definitely *NOT* safe to call clear_globals any time except at the very
beginning of your program, and only then from the initialization section of this
unit, and only if this is the very first unit that you Use in the main program.

*)

  </i></font><font color="#FF0000"><b>unit </b></font>clearmem<font color="#000080">;

  </font><font color="#008000"><i>{ Unit to clear all memory to a fixed value at the start of the program }
  { Written by D.J. Murdoch for the public domain. }

  </i></font><font color="#FF0000"><b>interface

  const
    </b></font>filler <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>clear_heap<font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>clear_globals<font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>clear_stack<font color="#000080">;

  </font><font color="#FF0000"><b>implementation

  type
    </b></font>block_rec_ptr <font color="#000080">= ^</font>block_rec<font color="#000080">;
    </font>block_rec <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>next <font color="#000080">: </font>block_rec_ptr<font color="#000080">;
      </font>size <font color="#000080">: </font>word<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>clear_heap<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>prev<font color="#000080">,
    </font>current <font color="#000080">: </font>block_rec_ptr<font color="#000080">;
    </font>howmuch <font color="#000080">: </font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{ First grab as much as possible and link it into a list }
    </i></font>prev <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font>maxavail <font color="#000080">&gt;= </font>sizeof<font color="#000080">(</font>block_rec<font color="#000080">)  </font><font color="#FF0000"><b>do
    begin
      if </b></font>maxavail <font color="#000080">&lt; </font><font color="#800000">65520 </font><font color="#FF0000"><b>then
        </b></font>howmuch <font color="#000080">:= </font>maxavail
      <font color="#FF0000"><b>else
        </b></font>howmuch <font color="#000080">:= </font><font color="#800000">65520</font><font color="#000080">;
      </font>getmem<font color="#000080">(</font>current<font color="#000080">,</font>howmuch<font color="#000080">);
      </font>current<font color="#000080">^.</font>next <font color="#000080">:= </font>prev<font color="#000080">;
      </font>current<font color="#000080">^.</font>size <font color="#000080">:= </font>howmuch<font color="#000080">;
      </font>prev <font color="#000080">:= </font>current<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{ Now fill all those blocks with filler }
    </i></font><font color="#FF0000"><b>while </b></font>prev <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil do
    begin
      </b></font>current <font color="#000080">:= </font>prev<font color="#000080">;
      </font>prev <font color="#000080">:= </font>current<font color="#000080">^.</font>next<font color="#000080">;
      </font>howmuch <font color="#000080">:= </font>current<font color="#000080">^.</font>size<font color="#000080">;
      </font>fillchar<font color="#000080">(</font>current<font color="#000080">^,</font>howmuch<font color="#000080">,</font>filler<font color="#000080">);
      </font>freemem<font color="#000080">(</font>current<font color="#000080">,</font>howmuch<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>clear_globals<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>where <font color="#000080">: </font>pointer<font color="#000080">;
    </font>howmuch <font color="#000080">: </font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>where <font color="#000080">:= @</font>test8087<font color="#000080">;                </font><font color="#008000"><i>{ The last const in the system unit }
    </i></font>inc<font color="#000080">(</font>word<font color="#000080">(</font>where<font color="#000080">),</font>sizeof<font color="#000080">(</font>test8087<font color="#000080">)); </font><font color="#008000"><i>{ Just past that }
    </i></font>howmuch <font color="#000080">:= </font>ofs<font color="#000080">(</font>input<font color="#000080">)              </font><font color="#008000"><i>{ The first var in the system unit }
               </i></font><font color="#000080">- </font>ofs<font color="#000080">(</font>where<font color="#000080">^);
    </font>fillchar<font color="#000080">(</font>where<font color="#000080">^,</font>howmuch<font color="#000080">,</font>filler<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>clear_stack<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>where <font color="#000080">: </font>pointer<font color="#000080">;
    </font>howmuch <font color="#000080">: </font>word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>where <font color="#000080">:= </font>ptr<font color="#000080">(</font>sseg<font color="#000080">,</font>stacklimit<font color="#000080">);
    </font>howmuch <font color="#000080">:= </font>sptr<font color="#000080">-</font>stacklimit<font color="#000080">-</font><font color="#800000">14</font><font color="#000080">;   </font><font color="#008000"><i>{ leave room for the fillchar parameters
                                       and return address }
    </i></font>fillchar<font color="#000080">(</font>where<font color="#000080">^,</font>howmuch<font color="#000080">,</font>filler<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font>clear_heap<font color="#000080">;
    </font>clear_stack<font color="#000080">;
    </font><font color="#008000"><i>{  clear_globals;  }  { Uncomment this only if this unit is the first one
                            in the main program's Uses list!!! }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0049.PAS">Original</a><b>]</b></p></body>
</html>
