<html>
<head><title> "Huge Memory Allocation" by DUNCAN MURDOCH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0067.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here are the routines I wrote.  The PtrToLong routine is from TurboPower's
OPINLINE unit; it just converts a pointer to a linear address, using
16*seg + ofs (in longint arithmetic, of course).  Other than that, I think
everything should be obvious.

From: dmurdoch@mast.queensu.ca (Duncan Murdoch)
}

{$ifndef dpmi}

</i></font><font color="#FF0000"><b>type
  </b></font>PFreeRec <font color="#000080">= ^</font>TFreeRec<font color="#000080">;
  </font>TFreeRec <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>next<font color="#000080">: </font>PFreeRec<font color="#000080">;
    </font>size<font color="#000080">: </font>Pointer<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>HugePtr<font color="#000080">;</font>size<font color="#000080">:</font>Longint<font color="#000080">);
</font><font color="#FF0000"><b>const
  </b></font>blocksize <font color="#000080">= </font><font color="#800000">$FFF0</font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>prev<font color="#000080">,</font>free <font color="#000080">: </font>PFreeRec<font color="#000080">;
  </font>save<font color="#000080">,</font>temp <font color="#000080">: </font>pointer<font color="#000080">;
  </font>block <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Handle the easy cases first }
  </i></font><font color="#FF0000"><b>if </b></font>size <font color="#000080">&gt; </font>maxavail <font color="#FF0000"><b>then
    </b></font>p <font color="#000080">:= </font><font color="#FF0000"><b>nil
  else if </b></font>size <font color="#000080">&lt; </font><font color="#800000">65521 </font><font color="#FF0000"><b>then
    </b></font>getmem<font color="#000080">(</font>p<font color="#000080">,</font>size<font color="#000080">)
  </font><font color="#FF0000"><b>else
  begin
</b></font><font color="#008000"><i>{$ifndef ver60}
   {$ifndef ver70}
    </i></font>The code below <font color="#FF0000"><b>is </b></font>extremely version specific <font color="#FF0000"><b>to </b></font>the TP <font color="#800000">6</font><font color="#000080">/</font><font color="#800000">7 </font>heap manager<font color="#000080">!!
   </font><font color="#008000"><i>{$endif}
{$endif}
    { Find the block that has enough space }
    </i></font>prev <font color="#000080">:= </font>PFreeRec<font color="#000080">(@</font>freeList<font color="#000080">);
    </font>free <font color="#000080">:= </font>prev<font color="#000080">^.</font>next<font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>free <font color="#000080">&lt;&gt; </font>heapptr<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PtrToLong<font color="#000080">(</font>free<font color="#000080">^.</font>size<font color="#000080">) &lt; </font>size<font color="#000080">) </font><font color="#FF0000"><b>do
    begin
      </b></font>prev <font color="#000080">:= </font>free<font color="#000080">;
      </font>free <font color="#000080">:= </font>prev<font color="#000080">^.</font>next<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{ Now free points to a region with enough space; make it the first one
      and multiple allocations will be contiguous. }

    </i></font>save <font color="#000080">:= </font>freelist<font color="#000080">;
    </font>freelist <font color="#000080">:= </font>free<font color="#000080">;
    </font><font color="#008000"><i>{ In TP 6, this works; check against other heap managers }
    </i></font><font color="#FF0000"><b>while </b></font>size <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
    begin
      </b></font>block <font color="#000080">:= </font>minlong<font color="#000080">(</font>blocksize<font color="#000080">,</font>size<font color="#000080">);
      </font>dec<font color="#000080">(</font>size<font color="#000080">,</font>block<font color="#000080">);
      </font>getmem<font color="#000080">(</font>temp<font color="#000080">,</font>block<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{ We've got what we want now; just sort things out and restore the
      free list to normal }

    </i></font>p <font color="#000080">:= </font>free<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>prev<font color="#000080">^.</font>next <font color="#000080">&lt;&gt; </font>freelist <font color="#FF0000"><b>then
    begin
      </b></font>prev<font color="#000080">^.</font>next <font color="#000080">:= </font>freelist<font color="#000080">;
      </font>freelist <font color="#000080">:= </font>save<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>FreeMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>HugePtr<font color="#000080">;</font>size <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#FF0000"><b>const
  </b></font>blocksize <font color="#000080">= </font><font color="#800000">$FFF0</font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>block <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  while </b></font>size <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    </b></font>block <font color="#000080">:= </font>minlong<font color="#000080">(</font>blocksize<font color="#000080">,</font>size<font color="#000080">);
    </font>dec<font color="#000080">(</font>size<font color="#000080">,</font>block<font color="#000080">);
    </font>freemem<font color="#000080">(</font>p<font color="#000080">,</font>block<font color="#000080">);
    </font>p <font color="#000080">:= </font>Normalized<font color="#000080">(</font>AddWordToPtr<font color="#000080">(</font>p<font color="#000080">,</font>block<font color="#000080">));
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$else}

</i></font><font color="#FF0000"><b>Procedure </b></font>GetMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p <font color="#000080">: </font>HugePtr<font color="#000080">; </font>Size<font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Size <font color="#000080">&lt; </font><font color="#800000">65521 </font><font color="#FF0000"><b>then
    </b></font>GetMem<font color="#000080">(</font>p<font color="#000080">,</font>size<font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>p <font color="#000080">:= </font>GlobalAllocPtr<font color="#000080">(</font>gmem_moveable<font color="#000080">,</font>Size<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FreeMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p <font color="#000080">: </font>HugePtr<font color="#000080">; </font>Size<font color="#000080">: </font>Longint<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>h <font color="#000080">: </font>THandle<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Size <font color="#000080">&lt; </font><font color="#800000">65521 </font><font color="#FF0000"><b>then
    </b></font>Freemem<font color="#000080">(</font>p<font color="#000080">,</font>size<font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>h <font color="#000080">:= </font>GlobalFreePtr<font color="#000080">(</font>p<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$endif}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0067.PAS">Original</a><b>]</b></p></body>
</html>
