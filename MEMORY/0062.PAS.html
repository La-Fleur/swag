<html>
<head><title> "386 copy/move" by ROBERT ROTHENBUR</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0062.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
I wrote some substitutes for Move and Copy in Turbo Pascal 7.0 that use
386-instructions (sort of).  Some initial tests showed 30-40% improve-
ment in speed.

I am posting these here for the public domain, and hance I make no
guarantees for how well they work.  If you find bugs or make any
optimizations, drop me a line...
}

(* XFUNC.PAS v0.01 by Robert Rothenburg Walking-Owl, June 1, 1994 *)
(* 32-bit &quot;X-Functions&quot; for Turbo Pascal 7.0                      *)

{$DEFINE USE386}

{ if you $UNDEF USE386, normal 8086 instructions will be used; this
  way the only change that needs to be made if you want to write '86
  and '386 versions is to recompile this unit with the appropriate
  define... }

</i></font><font color="#FF0000"><b>unit </b></font>XFunc<font color="#000080">;

</font><font color="#FF0000"><b>interface

procedure </b></font>XMove<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>source<font color="#000080">, </font>dest<font color="#000080">; </font>size<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>function </b></font>XCopy<font color="#000080">(</font>source<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>soffs<font color="#000080">, </font>size<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

          </b></font><font color="#008000"><i>{ Works the same as Move(source,dest,size); }

</i></font><font color="#FF0000"><b>procedure </b></font>XMove<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>source<font color="#000080">, </font>dest<font color="#000080">; </font>size<font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">push    ds
        push    es
        lds     si, source
        les     di, dest
        mov     cx, size
        cld
        shr     cx, 1
        jnc     @word1
        movsb
@word1:
</font><font color="#008000"><i>{$IFDEF USE386}
        </i></font><font color="#FF00FF">shr     cx, 1
        jnc     @word2
        movsw
@word2: db      0f3h, 066h, 0a5h  </font><font color="#008000"><i>{ rep movsd }
{$ELSE}
        </i></font><font color="#FF00FF">rep     movsw
</font><font color="#008000"><i>{$ENDIF}
        </i></font><font color="#FF00FF">pop     es
        pop     ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#008000"><i>{ works the same as Copy(str, index, len); }


</i></font><font color="#FF0000"><b>function </b></font>XCopy<font color="#000080">(</font>source<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>soffs<font color="#000080">, </font>size<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">push    ds
        push    es
        lds     si, source
        les     di, @result
        xor     ax, ax
        mov     bx, ax
        mov     cx, ax
        mov     bl, soffs
        mov     cl, size
        cld
        stosb
        lodsb
        cmp     ax, bx
        jb      @done
        add     si, bx
        dec     si
        sub     ax, bx
        cmp     ax, cx
        jnb     @docop
        xchg    ax, cx
        inc     cx
@docop: push    cx
        shr     cx, 1
        jnc     @word1
        movsb
@word1:
</font><font color="#008000"><i>{$IFDEF USE386}
        </i></font><font color="#FF00FF">shr     cx, 1
        jnc     @word2
        movsw
@word2: db      0f3h, 066h, 0a5h  </font><font color="#008000"><i>{ rep movsd }
{$ELSE}
        </i></font><font color="#FF00FF">rep     movsw
</font><font color="#008000"><i>{$ENDIF}
        </i></font><font color="#FF00FF">pop     ax
        les     di, @result
        stosb
@done:
        pop     es
        pop     ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0062.PAS">Original</a><b>]</b></p></body>
</html>
