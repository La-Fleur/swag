<html>
<head><title> "Another XMS Unit" by WILLIAM CONROY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
JD3GTRCW.TRANSCOM@transcom.safb.af.mil (CONROY WILLIAM F)

I have seen numerous requests for XMS routines.  Here are some I have
written for a programming effort I headed.
Feel free to use in any way fit.
}

{$O+,F+}
</i></font><font color="#FF0000"><b>UNIT </b></font>XMSUnit<font color="#000080">;
</font><font color="#008000"><i>{    Programmer:  Major William F. Conroy III                             }
{    Last Mod:    3/12/93                                                 }
{    Touched:     File date set to coorespond to baseline date            }
{                 for Computer Aided Aircrew Scheduling System            }
{                                                                         }
{ This unit is written to give access to the XMS memory Specification for }
{ the IBM PC.  Do not alter this unit without an excellent understanding  }
{ of the PC internal architecture, the Extended Memory Specification(XMS) }
{ and the Borland Inline Assembler.  For a much more in depth discussion  }
{ of the XMS memory standard and how to implement it on a PC class
  computer }
{ Refer to &quot;Extending Dos&quot; by Ray Duncan, Published by Addison Wesley     }

</i></font><font color="#FF0000"><b>INTERFACE

TYPE
  </b></font>PHandlePtrArray <font color="#000080">= ^</font>THandlePtrArray<font color="#000080">;
  </font>THandlePtrArray <font color="#000080">= </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">10</font><font color="#000080">]</font><font color="#FF0000"><b>OF </b></font>WORD<font color="#000080">;
  </font><font color="#008000"><i>{  This type definition is used by the graphics system as a way   }
  {  to dynamically allocate space to hold the handles required to  }
  {  access the extended memory.                                    }

  </i></font>PXMSParamBlock  <font color="#000080">= ^</font>TXMSParamBlock<font color="#000080">;
  </font>TXMSParamBlock  <font color="#000080">= </font><font color="#FF0000"><b>RECORD
    </b></font>LengthOfBlock   <font color="#000080">: </font>LONGINT<font color="#000080">;   </font><font color="#008000"><i>{ Size of block to move }
    </i></font>SourceEMBHandle <font color="#000080">: </font>WORD<font color="#000080">;
    </font><font color="#008000"><i>{ 0 if source is in conventional memory,       }
    { handle returned by AllocateEMB otherwise     }
    </i></font>SourceOffset    <font color="#000080">: </font>LONGINT<font color="#000080">;
    </font><font color="#008000"><i>{ if SourceEMBHandle= 0 SourceOffset contains  }
    { a far pointer in Intel standard format else  }
    { SourceOffset indicates offset from the base  }
    { of the block.                                }
    </i></font>DestEMBHandle   <font color="#000080">: </font>WORD<font color="#000080">;
    </font><font color="#008000"><i>{ 0 if source is in conventional memory,       }
    { handle returned by AllocateEMB otherwise     }
    </i></font>DestOffset      <font color="#000080">: </font>LONGINT<font color="#000080">;
    </font><font color="#008000"><i>{ if DestEMBHandle= 0 DestOffset contains      }
    { a far pointer in Intel standard format else  }
    { DestOffset indicates offset from the base    }
    { of the block.                                }
  </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ This type definition is used by the XMM memory manager for      }
  { block memory moves. As required by the xms specification.       }

</i></font><font color="#FF0000"><b>VAR
  </b></font>XMSExists <font color="#000080">: </font>BOOLEAN<font color="#000080">;

  </font><font color="#008000"><i>{ Function AllocateEMB allocates an Extended Memory Block in Extended }
  { memory.  It requests the block via the Extended Memory Manager(XMM) }
  { It returns True if it was successful False otherwise.  If true, if  }
  { EMB_Handle will contain the Extended Memory Block Handle.  If       }
  {returning false, the errorcode is in the ErrorCode parameter.        }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>AllocateEMB<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>EMB_Handle<font color="#000080">, </font>ParRequested<font color="#000080">, </font>ErrorCode <font color="#000080">: </font>WORD<font color="#000080">) : </font>BOOLEAN<font color="#000080">;

  </font><font color="#008000"><i>{ Function FreeEMB releases an Extended Memory Block in Extended Memory }
  { allocated by the AllocateEMB function call.  It requests the XMM      }
  { remove the block.  It returns True if it was successful False         }
  { otherwise.  If true, if block was released correctly.  If returning   }
  { false, the errorcode is in the ErrorCode parameter.                   }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>FreeEMB<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>EMB_Handle<font color="#000080">, </font>ErrorCode <font color="#000080">: </font>WORD<font color="#000080">) : </font>BOOLEAN<font color="#000080">;

  </font><font color="#008000"><i>{ Function MoveEMB allows memory tranfers between conventional and XMS  }
  { Memory.  This function requires a filled in TXMSParamBlock record.    }
  { It returns True if it was successful False otherwise.  If true, the   }
  { memory block was successfully moved.  If returning false, the         }
  { errorcode is in the ErrorCode parameter.                   }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>MoveEMB<font color="#000080">(</font>PParamBlock <font color="#000080">: </font>PXMSParamBlock<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>ErrorCode <font color="#000080">: </font>WORD<font color="#000080">) : </font>BOOLEAN<font color="#000080">;



</font><font color="#FF0000"><b>IMPLEMENTATION

VAR
  </b></font>XMMAddress        <font color="#000080">: </font>POINTER<font color="#000080">;
  </font>XMS_Version       <font color="#000080">: </font>WORD<font color="#000080">;
  </font>XMM_DriverVersion <font color="#000080">: </font>WORD<font color="#000080">;
  </font>HMA_Exists        <font color="#000080">: </font>BOOLEAN<font color="#000080">;
  </font>LastErrorCode     <font color="#000080">: </font>WORD<font color="#000080">;


</font><font color="#008000"><i>{---------------------------------------------------------------------------}
{                                                                         }
{                             Local Procedure                             }
{                            function XMSPresent                          }
{                                                                         }
{  This function return true if there is an Extended memory manager present }
{  in the system capable of supporting our XMS requests.  It uses a DOS   }
{  multiplexing interrupt request to determine if the driver signiture is }
{  present in the system.  This is the Microsoft recomended method of     }
{  determining the presence of this driver.                               }
{                                                                         }
{---------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSPresent <font color="#000080">: </font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">MOV AX, 4300h                  </font><font color="#008000"><i>{ MultiPlexing interrupt request number  }
  </i></font><font color="#FF00FF">INT 2fh                       </font><font color="#008000"><i>{ Dos Multiplexing Interrupt             }
  </i></font><font color="#FF00FF">CMP AL, 80h                    </font><font color="#008000"><i>{ was the signature byte returned in AL  }
  </i></font><font color="#FF00FF">JZ  @1                         </font><font color="#008000"><i>{ yes?, jump to @1                       }
  </i></font><font color="#FF00FF">MOV AX, 00h                    </font><font color="#008000"><i>{ set false for return                   }
  </i></font><font color="#FF00FF">JMP @2                        </font><font color="#008000"><i>{ unconditional jump to end of function  }
 </i></font><font color="#FF00FF">@1:
  MOV AX, 01h                    </font><font color="#008000"><i>{ set True for return then fall thru to  }
                                { exit.                                  }
 </i></font><font color="#FF00FF">@2:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------------------------------- --}
{                                                                          }
{                            Local Procedure                               }
{                      function ReturnDriverAddress                        }
{                                                                          }
{  This function return true if it could determine the device driver entry  }
{  point.  This information is required to call any XMS functions. It uses  }
{  a DOS multiplexing interrupt request to get this address. This is the }
{  Microsoft recomended method of getting the base address of this driver.  }
{  This address is required to setup an indirect call to the driver by the  }
{  XMS functions.                                                           }
{                                                                           }
{---------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ReturnDriverAddress <font color="#000080">: </font>POINTER<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#008000"><i>{  This function returns the address for the XMM memory manager  }
  {  This value is required to later call the driver for XMS calls }

</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">MOV AX, 4310h                  </font><font color="#008000"><i>{ MultiPlexing interrupt request number }
  </i></font><font color="#FF00FF">INT 2fh                       </font><font color="#008000"><i>{ Dos Multiplexing Interrupt            }
                                { Set Registers up for Return of Pointer }
  </i></font><font color="#FF00FF">MOV AX, BX                     </font><font color="#008000"><i>{ Set Offset Value                      }
  </i></font><font color="#FF00FF">MOV DX, ES                     </font><font color="#008000"><i>{ Set Segment Value                     }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{-------------------------------------------------------------------------}
{                                                                         }
{                               Local Procedure                           }
{                            function GetXMSVersion                       }
{                                                                         }
{-------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>GetXMSVersion<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>XMS_Version<font color="#000080">, </font>XMM_DriverVersion <font color="#000080">: </font>WORD<font color="#000080">;
                       </font><font color="#FF0000"><b>VAR </b></font>HMA_Exists <font color="#000080">: </font>BOOLEAN<font color="#000080">;
                       </font><font color="#FF0000"><b>VAR </b></font>ErrorCode <font color="#000080">: </font>WORD<font color="#000080">) : </font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ This function loads the version numbers into the unit global }
  { variables. The information is coded in binary Coded Decimal. }

</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">XOR  AX, AX                     </font><font color="#008000"><i>{ set ax to zero                        }
  </i></font><font color="#FF00FF">CALL XMMAddress               </font><font color="#008000"><i>{ indirect call to XMM driver           }
  </i></font><font color="#FF00FF">CMP  AX, 00h                    </font><font color="#008000"><i>{ error set ?                           }
  </i></font><font color="#FF00FF">JZ   @1                         </font><font color="#008000"><i>{ Jump error finish                     }

  </i></font><font color="#FF00FF">LES  DI, XMS_Version            </font><font color="#008000"><i>{ Load XMS_Version Address into es:di   }
  </i></font><font color="#FF00FF">MOV  ES:[DI],AX                </font><font color="#008000"><i>{ Load variable indirect                }

  </i></font><font color="#FF00FF">LES  DI, XMM_DriverVersion      </font><font color="#008000"><i>{ Load XMM_DriverVrsn Address in es:di  }
  </i></font><font color="#FF00FF">MOV  ES:[DI],BX                </font><font color="#008000"><i>{ Load variable Indirect                }

  </i></font><font color="#FF00FF">LES  DI, HMA_Exists             </font><font color="#008000"><i>{ Load HMA_Exists Address in es:di      }
  </i></font><font color="#FF00FF">MOV  ES:[DI],DX                </font><font color="#008000"><i>{ Load variable Indirect                }

  </i></font><font color="#FF00FF">LES  DI,ErrorCode              </font><font color="#008000"><i>{ Load ErrorCode Address into es:di     }
  </i></font><font color="#FF00FF">MOV  WORD PTR ES:[DI],00h      </font><font color="#008000"><i>{ Clear Error Code                      }
  </i></font><font color="#FF00FF">MOV  AX, 01h                    </font><font color="#008000"><i>{ set function return to true           }
  </i></font><font color="#FF00FF">JMP  @2                        </font><font color="#008000"><i>{ Jump to finish                        }

 </i></font><font color="#FF00FF">@1:
  LES DI, ErrorCode              </font><font color="#008000"><i>{ Load error code address in es:di      }
  </i></font><font color="#FF00FF">MOV WORD PTR ES:[DI],00h      </font><font color="#008000"><i>{ copy 0  into ErrorCode                }
 </i></font><font color="#FF00FF">@2:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{-------------------------------------------------------------------------}
{                                                                         }
{                             Exported Procedure                          }
{                            function AllocateEMB                         }
{                                                                         }
{                                                                         }
{    Function AllocateEMB allocates an Extended Memory Block in Extended  }
{    memory.  It requests the block via the Extended Memory Manager(XMM)  }
{    It returns True if it was successful False otherwise.  If true, if   }
{    EMB_Handle will contain the Extended Memory Block Handle.  If        }
{    returning false, the errorcode is in the ErrorCode parameter.        }
{                                                                         }
{-------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>AllocateEMB<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>EMB_Handle<font color="#000080">, </font>ParRequested<font color="#000080">,
                         </font>ErrorCode <font color="#000080">: </font>WORD<font color="#000080">) : </font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">MOV  AH, 09h                    </font><font color="#008000"><i>{ set ax for Allocate EMB call       }
  </i></font><font color="#FF00FF">LES  DI, ParRequested           </font><font color="#008000"><i>{ load ParRequested address in es:di }
  </i></font><font color="#FF00FF">MOV  DX, ES:[DI]                </font><font color="#008000"><i>{ copy parRequested value in DX      }
  </i></font><font color="#FF00FF">CALL XMMAddress               </font><font color="#008000"><i>{ indirect call to XMM driver        }
  </i></font><font color="#FF00FF">CMP  AX, 00h                    </font><font color="#008000"><i>{ error set ?                        }
  </i></font><font color="#FF00FF">JZ   @1                         </font><font color="#008000"><i>{ Jump error finish                  }
  </i></font><font color="#FF00FF">LES  DI, EMB_Handle             </font><font color="#008000"><i>{ load EMB_Handle in es:di           }
  </i></font><font color="#FF00FF">MOV  ES:[DI],DX                </font><font color="#008000"><i>{ copy DX into EMB_Handle            }
  </i></font><font color="#FF00FF">MOV  AX, 01h                    </font><font color="#008000"><i>{ Return True                        }
  </i></font><font color="#FF00FF">LES  DI, ErrorCode              </font><font color="#008000"><i>{ Load error code address in es:di   }
  </i></font><font color="#FF00FF">MOV  WORD PTR ES:[DI],00h      </font><font color="#008000"><i>{ copy 0  into ErrorCode             }
  </i></font><font color="#FF00FF">JMP  @2                        </font><font color="#008000"><i>{ unconditional jump to finish       }
  { Error Finish                       }
 </i></font><font color="#FF00FF">@1:
  LES  DI, ErrorCode              </font><font color="#008000"><i>{ load ErrorCode in es:di            }
  </i></font><font color="#FF00FF">MOV  BYTE PTR ES:[DI],BL       </font><font color="#008000"><i>{ copy BL into ErrorCode             }
 </i></font><font color="#FF00FF">@2:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{-------------------------------------------------------------------------}
{                                                                         }
{                           Exported Procedure                            }
{                            function FreeEMB                             }
{                                                                         }
{  Function FreeEMB releases an Extended Memory Block in Extended Memory  }
{  allocated by the AllocateEMB function call.  It requests the XMM       }
{  remove the block.  It returns True if it was successful False          }
{  otherwise.  If true, if block was released correctly.  If returning    }
{  false, the errorcode is in the ErrorCode parameter.                    }
{                                                                         }
{-------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>FreeEMB<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>EMB_Handle<font color="#000080">, </font>ErrorCode <font color="#000080">: </font>WORD<font color="#000080">) : </font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">XOR  AX, AX                     </font><font color="#008000"><i>{ clear AX to zero                 }
  </i></font><font color="#FF00FF">MOV  AH, 0Ah                    </font><font color="#008000"><i>{ set ax for Free EMB call         }
  </i></font><font color="#FF00FF">LES  DI, EMB_Handle             </font><font color="#008000"><i>{ load EMB_Handle address in es:di }
  </i></font><font color="#FF00FF">MOV  DX, ES:[DI]                </font><font color="#008000"><i>{ load EMB_Handle value in DX      }
  </i></font><font color="#FF00FF">CALL XMMAddress               </font><font color="#008000"><i>{ indirect call to XMM driver      }
  </i></font><font color="#FF00FF">CMP  AX, 00h                    </font><font color="#008000"><i>{ error set ?                      }
  </i></font><font color="#FF00FF">JZ   @1                         </font><font color="#008000"><i>{ Jump error finish                }
  </i></font><font color="#FF00FF">MOV  AX, 01H                    </font><font color="#008000"><i>{ Set True                         }
  </i></font><font color="#FF00FF">LES  DI, ErrorCode              </font><font color="#008000"><i>{ Load error code address in es:di }
  </i></font><font color="#FF00FF">MOV  WORD PTR ES:[DI],00h      </font><font color="#008000"><i>{ copy 0  into ErrorCode           }
  </i></font><font color="#FF00FF">JMP  @2                        </font><font color="#008000"><i>{ unconditional jump to finish     }
                                { Error Finish                     }
 </i></font><font color="#FF00FF">@1:
  LES  DI, ErrorCode              </font><font color="#008000"><i>{ load ErrorCode in es:di          }
  </i></font><font color="#FF00FF">MOV  BYTE PTR ES:[DI],BL       </font><font color="#008000"><i>{ copy BL into ErrorCode           }
 </i></font><font color="#FF00FF">@2:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{-------------------------------------------------------------------------}
{                                                                         }
{                           Exported Procedure                            }
{                            function MoveEMB                             }
{                                                                         }
{  Function MoveEMB allows memory tranfers between conventional and XMS   }
{  Memory.  This function requires a filled in TXMSParamBlock record.     }
{  It returns True if it was successful False otherwise.  If true, the    }
{  memory block was successfully moved.  If returning false, the          }
{  errorcode is in the ErrorCode parameter.                               }
{                                                                         }
{-------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>MoveEMB<font color="#000080">(</font>PParamBlock <font color="#000080">: </font>PXMSParamBlock<font color="#000080">;
                 </font><font color="#FF0000"><b>VAR </b></font>ErrorCode <font color="#000080">: </font>WORD<font color="#000080">) : </font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">MOV  AX, DS                     </font><font color="#008000"><i>{ move DS to AX register                }
  </i></font><font color="#FF00FF">MOV  ES, AX                     </font><font color="#008000"><i>{ move AX to ES register                }
  </i></font><font color="#FF00FF">MOV  AH, 0Bh                    </font><font color="#008000"><i>{ set ax for Move EMB call              }
  </i></font><font color="#FF00FF">PUSH DS                       </font><font color="#008000"><i>{ push DS to Stack                      }
  </i></font><font color="#FF00FF">LDS  SI, PParamBlock            </font><font color="#008000"><i>{ load PParamBlock Address to ds:si     }
  </i></font><font color="#FF00FF">MOV  DI, OFFSET XMMAddress      </font><font color="#008000"><i>{ move XMMAddress offset to di          }
  </i></font><font color="#FF00FF">CALL DWORD PTR ES:[DI]        </font><font color="#008000"><i>{ indirect call to XMMdriver via es:di  }
  </i></font><font color="#FF00FF">POP  DS                        </font><font color="#008000"><i>{ save TP's data segment                }
  </i></font><font color="#FF00FF">CMP  AX, 00h                    </font><font color="#008000"><i>{ error set ?                           }
  </i></font><font color="#FF00FF">JZ   @1                         </font><font color="#008000"><i>{ Jump error finish                     }
  </i></font><font color="#FF00FF">MOV  AX, 01H                    </font><font color="#008000"><i>{ Set True                              }
  </i></font><font color="#FF00FF">LES  DI, ErrorCode              </font><font color="#008000"><i>{ Load error code address in es:di      }
  </i></font><font color="#FF00FF">MOV  WORD PTR ES:[DI],00h      </font><font color="#008000"><i>{ copy 0  into ErrorCode                }
  </i></font><font color="#FF00FF">JMP  @2                        </font><font color="#008000"><i>{ unconditional jump to finish          }
                                { Error Finish                          }
 </i></font><font color="#FF00FF">@1:
  LES  DI, ErrorCode              </font><font color="#008000"><i>{ load ErrorCode in es:di               }
  </i></font><font color="#FF00FF">MOV  WORD PTR ES:[DI],AX       </font><font color="#008000"><i>{ Clear ErrorCode prior to load         }
  </i></font><font color="#FF00FF">MOV  BYTE PTR ES:[DI],BL       </font><font color="#008000"><i>{ copy BL into ErrorCode                }
  </i></font><font color="#FF00FF">MOV  AX, 01h                    </font><font color="#008000"><i>{ Return False                          }
 </i></font><font color="#FF00FF">@2:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>XMSExists <font color="#000080">:= </font>XMSPresent<font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>XMSExists <font color="#FF0000"><b>THEN
  BEGIN
    </b></font>XMMAddress <font color="#000080">:= </font>ReturnDriverAddress<font color="#000080">;
    </font>GetXMSVersion<font color="#000080">(</font>XMS_Version<font color="#000080">, </font>XMM_DriverVersion<font color="#000080">, </font>HMA_Exists<font color="#000080">, </font>LastErrorCode<font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0032.PAS">Original</a><b>]</b></p></body>
</html>
