<html>
<head><title> "Creating a temporary stack" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0095.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
The following code shows how to create a temporary stack
for use during ISRs and in other situations where the
default stack might not be big enough.

The following program intentionally creates a very small
default stack by using the $M compiler directive. It then
calls a function which pushes $2000 bytes onto the stack,
thereby setting up a situation which should cause a 202 error.

To avoid the error, the program creates a temporary stack
by allocating $4000 bytes on the heap and moving this value
into SS. It then sets SP to point at the end of this new
stack and proceeds to call the function, which does not
fail because of the new temporary stack.

This code has been tested in both real and protected mode.
}


{$M $800, 0, $12000}

</i></font><font color="#FF0000"><b>procedure </b></font>BreakDefaultStack<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>a<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">$2000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Hello'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>aSS<font color="#000080">, </font>aSP<font color="#000080">: </font>Word<font color="#000080">;
  </font>Stck<font color="#000080">: </font>pointer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>getmem<font color="#000080">(</font>Stck<font color="#000080">, </font><font color="#800000">$4000</font><font color="#000080">);
  </font>Word <font color="#000080">(</font>Stck<font color="#000080">^) := </font><font color="#800000">1</font><font color="#000080">;

  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov aSP, sp
    mov ax, ss
    mov aSS, ax
    mov ax, word ptr [Stck]
    mov bx, word ptr [stck+2]
    add ax, $4000-2
    cli
    mov ss, bx
    mov sp, ax
    sti
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>BreakDefaultStack<font color="#000080">;

  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax, aSS
    mov ss, ax
    mov sp, aSP
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>freemem<font color="#000080">(</font>Stck<font color="#000080">, </font><font color="#800000">$4000</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0095.PAS">Original</a><b>]</b></p></body>
</html>
