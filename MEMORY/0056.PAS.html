<html>
<head><title> "PROTECTED MODE" by ROB SPOREN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0056.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
 SM&gt; I have a bit of a problem with pascal 7 protected mode,
 SM&gt; I have a TSR (assembly) that does my comms work for me.
 SM&gt; I use intr(regs) with various settings to the registers to collect
 SM&gt; data from the TSR. However when in protected mode my TSR seems
 SM&gt; to be unavailable.

I had the same problem, it seems that the DOS unit does not support protected
mode interrupt handling. I solved it by looking though some documentation I
found on protected mode, below is a simple unit to set and get protected
mode interrupts.

In my case the interrupt goes about 22Khz so it kept switching into real mode
and back just to handle the interrupt, the result it crashed.

 SM&gt; Do I need to switch to real mode from the app.
 SM&gt; (if so how, I can't find it in the manual).

No, see above.

 SM&gt; Do I need to modify my TSR.
 SM&gt; I presume not because I'm sure that the mouse drivers can be got
 SM&gt; to work.

The MOUSE is handled by the DOS extender.

Cheers
  Rob

P.S. I noticed that you use the same BBS, if you have any problems drop
me a note.
}

</i></font><font color="#FF0000"><b>Unit </b></font>DPMIDos<font color="#000080">;  </font><font color="#008000"><i>{ This code was a quick hack job to solve my problem }
               { don't expect it to be neat!                        }

</i></font><font color="#FF0000"><b>INTERFACE

Function </b></font>RealMode <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>AllocateLDT<font color="#000080">(</font>NumberDescriptors <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>FreeLDT<font color="#000080">(</font>Selector <font color="#000080">: </font>Word<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>SegmentToDescriptor<font color="#000080">(</font>Segment <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>GetNextSelectorInc <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>GetDPMIntVec<font color="#000080">(</font>IntNumber <font color="#000080">: </font>Byte<font color="#000080">) : </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SetDPMIntVec<font color="#000080">(</font>IntNumber <font color="#000080">: </font>Byte<font color="#000080">; </font>IntVec <font color="#000080">: </font>Pointer<font color="#000080">);

</font><font color="#FF0000"><b>IMPLEMENTATION

Function </b></font>RealMode <font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov     ax, 01686h
  int     02Fh
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>AllocateLDT<font color="#000080">(</font>NumberDescriptors <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov     ax, 0000h
   mov     ax, NumberDescriptors
   int     031h
   jnc     @Ok
   mov     ax, 0
 @Ok:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>FreeLDT<font color="#000080">(</font>Selector <font color="#000080">: </font>Word<font color="#000080">) : </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov     ax, 0001h
   mov     bx, Selector
   int     031h
   mov     ax, 1
   jnc     @Ok
   mov     ax, 0
 @Ok:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SegmentToDescriptor<font color="#000080">(</font>Segment <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov     ax, 0002h
   mov     bx, Segment
   int     31h
   jnc     @Ok
   mov     ax, 0
 @Ok:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetNextSelectorInc <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov     ax, 0003h
   int     031h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>GetDPMIntVec<font color="#000080">(</font>IntNumber <font color="#000080">: </font>Byte<font color="#000080">) : </font>Pointer<font color="#000080">; </font><font color="#008000"><i>{assembler;}
</i></font><font color="#FF0000"><b>Var </b></font>S<font color="#000080">, </font>O <font color="#000080">: </font>Word<font color="#000080">;    </font><font color="#008000"><i>{ Too lazy to look in the manual! }
</i></font><font color="#FF0000"><b>Begin
  asm
     </b></font><font color="#FF00FF">mov    ax, 0204h
     mov    bl, IntNumber
     int    031h
     mov    S, cx
     mov    O, dx
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>GetDPMIntVec <font color="#000080">:= </font>Ptr<font color="#000080">(</font>S<font color="#000080">, </font>O<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>SetDPMIntVec<font color="#000080">(</font>IntNumber <font color="#000080">: </font>Byte<font color="#000080">; </font>IntVec <font color="#000080">: </font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">mov    ax, 0205h
   mov    bl, IntNumber

   les    dx, IntVec
   mov    cx, es

   int    031h
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0056.PAS">Original</a><b>]</b></p></body>
</html>
