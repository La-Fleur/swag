<html>
<head><title> "EMS Addressing" by HENRIK SCHMIDT-MOELLER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
HENRIK SCHMIDT-MOELLER

I've made some procedures for EMS addressing in TP. EMS uses a technic called
bank switching. It reserves a 64k area (EmmSeg) in memory for EMS and maps/
unmaps 16k EMS-pages in this area. Look at interrupt 67h for a complete list of
EMS commands. I haven't had time to comment on these procedures, so if you
don't understand them, feel free to ask. OK, here goes nothing...

Oh, by the way, REMEMBER to DEallocate!!!
}

</i></font><font color="#FF0000"><b>VAR
  </b></font>EmmSeg<font color="#000080">,
  </font>EmmHandle <font color="#000080">: </font>Word<font color="#000080">;
  </font>Err       <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>DeallocateMem<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>Forward</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Error<font color="#000080">(</font>E <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  </b></font>DeallocateMem<font color="#000080">(</font>Emmhandle<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">#7 </font><font color="#000080">+ </font>E<font color="#000080">);
  </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>AllocateMem<font color="#000080">(</font>LogPages <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  ASM
    </b></font><font color="#FF00FF">MOV  AH, 43h
    MOV  BX, LogPages
    INT  67h
    MOV  Err, AH
    MOV  EmmHandle, DX
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>CASE </b></font>Err <font color="#FF0000"><b>OF
    </b></font><font color="#800000">$80 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'AllocateMem: Internal error in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$81 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'AllocateMem: Malfunction in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$84 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'AllocateMem: Undefined function'</font><font color="#000080">);
    </font><font color="#800000">$85 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'AllocateMem: No more handles available'</font><font color="#000080">);
    </font><font color="#800000">$87 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'AllocateMem: Allocation requested more pages than are' </font><font color="#000080">+ </font><font color="#800000">#13#10 </font><font color="#000080">+
                </font><font color="#800000">'             physically available; no pages allocated'</font><font color="#000080">);
    </font><font color="#800000">$88 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'AllocateMem: Specified more logical pages than are'</font><font color="#000080">+ </font><font color="#800000">#13#10 </font><font color="#000080">+
                </font><font color="#800000">' currently available; no pages allocated'</font><font color="#000080">);
    </font><font color="#800000">$89 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'AllocateMem: Zero pages requested'</font><font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>MapEmm<font color="#000080">(</font>PsyPage <font color="#000080">: </font>Byte<font color="#000080">; </font>LogPage <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  ASM
    </b></font><font color="#FF00FF">MOV  AH, 44h
    MOV  AL, PsyPage
    MOV  BX, LogPage
    MOV  DX, EmmHandle
    INT  67h
    MOV  Err, AH;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>CASE </b></font>Err <font color="#FF0000"><b>OF
    </b></font><font color="#800000">$80 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'MapEmm: Internal error in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$81 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'MapEmm: Malfunction in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$83 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'MapEmm: Invalid handle'</font><font color="#000080">);
    </font><font color="#800000">$84 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'MapEmm: Undefined function'</font><font color="#000080">);
    </font><font color="#800000">$8A </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'MapEmm: Logical page not assigned to this handle'</font><font color="#000080">);
    </font><font color="#800000">$8B </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'MapEmm: Physical page number invalid'</font><font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>DeallocateMem<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  ASM
    </b></font><font color="#FF00FF">MOV  AH, 45h
    MOV  DX, Handle
    INT  67h
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>GetPageSeg<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  ASM
    </b></font><font color="#FF00FF">MOV  AH, 41h
    INT  67h
    MOV  EmmSeg, BX
    MOV  Err, AH;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>CASE </b></font>Err <font color="#FF0000"><b>OF
    </b></font><font color="#800000">$80 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'GetPageSeg: Internal error in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$81 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'GetPageSeg: Malfunction in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$84 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'GetPageSeg: Undefined function'</font><font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>GetMaxPages<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>Num <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>VAR
  </b></font>Dummy <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  ASM
    </b></font><font color="#FF00FF">MOV  AH, 42h
    INT  67h
    MOV  Dummy, BX
    MOV  Err, AH;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>Num <font color="#000080">:= </font>Dummy<font color="#000080">;
  </font><font color="#FF0000"><b>CASE </b></font>Err <font color="#FF0000"><b>OF
    </b></font><font color="#800000">$80 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'GetMaxPages: Internal error in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$81 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'GetMaxPages: Malfunction in EMS software'</font><font color="#000080">);
    </font><font color="#800000">$84 </font><font color="#000080">: </font>Error<font color="#000080">(</font><font color="#800000">'GetMaxPages: Undefined function'</font><font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>WriteMem<font color="#000080">(</font>Page <font color="#000080">: </font>Byte<font color="#000080">; </font>Pos <font color="#000080">: </font>Integer<font color="#000080">; </font>Ch <font color="#000080">: </font>Char<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  </b></font>Mem<font color="#000080">[</font>EmmSeg <font color="#000080">: </font>Page <font color="#000080">* </font><font color="#800000">$4000 </font><font color="#000080">+ </font>Pos<font color="#000080">] := </font>Ord<font color="#000080">(</font>Ch<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>ReadMem<font color="#000080">(</font>Page <font color="#000080">: </font>Byte<font color="#000080">; </font>Pos <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>Ch <font color="#000080">: </font>Char<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  </b></font>Ch <font color="#000080">:= </font>Chr<font color="#000080">(</font>Mem<font color="#000080">[</font>EmmSeg <font color="#000080">: </font>Page <font color="#000080">* </font><font color="#800000">$4000 </font><font color="#000080">+ </font>Pos<font color="#000080">]);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p></body>
</html>
