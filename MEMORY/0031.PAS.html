<html>
<head><title> "Nice XMS unit" by PETER BEFFTINK</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0031.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
PETER BEEFTINK

See below an XMS Unit I picked up somewhere.  I must admit that I have never
been successful at using it, but maybe you have more luck.
}

</i></font><font color="#FF0000"><b>Unit </b></font>MegaXMS<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Var
  </b></font>Present  <font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#008000"><i>{True if XMM driver is installed}
  </i></font>XMSError <font color="#000080">: </font>Byte<font color="#000080">;    </font><font color="#008000"><i>{Error number. if 0 -&gt; no error}

</i></font><font color="#FF0000"><b>Function  </b></font>XMMPresent <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>XMSErrorString<font color="#000080">(</font>Error <font color="#000080">: </font>Byte<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>XMSMemAvail <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>XMSMaxAvail <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>GetXMMVersion <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>GetXMSVersion <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>MoveFromEMB<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Dest<font color="#000080">; </font>BlockLength <font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>MoveToEMB<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Source<font color="#000080">; </font>Handle <font color="#000080">: </font>Word<font color="#000080">; </font>BlockLength <font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>EMBGetMem<font color="#000080">(</font>Size <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>EMBFreeMem<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>EMBResize<font color="#000080">(</font>Handle<font color="#000080">, </font>Size <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>GetAvailEMBHandles <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>GetEMBLock<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">) : </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>GetEMBSize<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>LockEMB<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>UnlockEMB<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>UMBGetMem<font color="#000080">(</font>Size <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Segment <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>UMBFreeMem<font color="#000080">(</font>Segment <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>GetA20Status <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>DisableLocalA20<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>EnableLocalA20<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>DisableGlobalA20<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>EnableGlobalA20<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>HMAGetMem<font color="#000080">(</font>Size <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>HMAFreeMem<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>GetHMA <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>High <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>Low  <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
  </font>NumberOfErrors <font color="#000080">= </font><font color="#800000">27</font><font color="#000080">;

  </font>ErrorNumber <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>NumberOfErrors<font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Byte <font color="#000080">=
    (</font><font color="#800000">$80</font><font color="#000080">,</font><font color="#800000">$81</font><font color="#000080">,</font><font color="#800000">$82</font><font color="#000080">,</font><font color="#800000">$8E</font><font color="#000080">,</font><font color="#800000">$8F</font><font color="#000080">,</font><font color="#800000">$90</font><font color="#000080">,</font><font color="#800000">$91</font><font color="#000080">,</font><font color="#800000">$92</font><font color="#000080">,</font><font color="#800000">$93</font><font color="#000080">,</font><font color="#800000">$94</font><font color="#000080">,</font><font color="#800000">$A0</font><font color="#000080">,</font><font color="#800000">$A1</font><font color="#000080">,</font><font color="#800000">$A2</font><font color="#000080">,</font><font color="#800000">$A3</font><font color="#000080">,
     </font><font color="#800000">$A4</font><font color="#000080">,</font><font color="#800000">$A5</font><font color="#000080">,</font><font color="#800000">$A6</font><font color="#000080">,</font><font color="#800000">$A7</font><font color="#000080">,</font><font color="#800000">$A8</font><font color="#000080">,</font><font color="#800000">$A9</font><font color="#000080">,</font><font color="#800000">$AA</font><font color="#000080">,</font><font color="#800000">$AB</font><font color="#000080">,</font><font color="#800000">$AC</font><font color="#000080">,</font><font color="#800000">$AD</font><font color="#000080">,</font><font color="#800000">$B0</font><font color="#000080">,</font><font color="#800000">$B1</font><font color="#000080">,</font><font color="#800000">$B2</font><font color="#000080">);

  </font>ErrorString <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>NumberOfErrors<font color="#000080">] </font><font color="#FF0000"><b>Of String </b></font><font color="#000080">= (
    </font><font color="#800000">'Unknown error'</font><font color="#000080">,
    </font><font color="#800000">'Function no implemented'</font><font color="#000080">,
    </font><font color="#800000">'VDISK device driver was detected'</font><font color="#000080">,
    </font><font color="#800000">'A20 error occured'</font><font color="#000080">,
    </font><font color="#800000">'General driver errror'</font><font color="#000080">,
    </font><font color="#800000">'Unrecoverable driver error'</font><font color="#000080">,
    </font><font color="#800000">'High memory area does not exist'</font><font color="#000080">,
    </font><font color="#800000">'High memory area is already in use'</font><font color="#000080">,
    </font><font color="#800000">'DX is less than the ninimum of KB that Program may use'</font><font color="#000080">,
    </font><font color="#800000">'High memory area not allocated'</font><font color="#000080">,
    </font><font color="#800000">'A20 line still enabled'</font><font color="#000080">,
    </font><font color="#800000">'All extended memory is allocated'</font><font color="#000080">,
    </font><font color="#800000">'Extended memory handles exhausted'</font><font color="#000080">,
    </font><font color="#800000">'Invalid handle'</font><font color="#000080">,
    </font><font color="#800000">'Invalid source handle'</font><font color="#000080">,
    </font><font color="#800000">'Invalid source offset'</font><font color="#000080">,
    </font><font color="#800000">'Invalid destination handle'</font><font color="#000080">,
    </font><font color="#800000">'Invalid destination offset'</font><font color="#000080">,
    </font><font color="#800000">'Invalid length'</font><font color="#000080">,
    </font><font color="#800000">'Invalid overlap in move request'</font><font color="#000080">,
    </font><font color="#800000">'Parity error detected'</font><font color="#000080">,
    </font><font color="#800000">'Block is not locked'</font><font color="#000080">,
    </font><font color="#800000">'Block is locked'</font><font color="#000080">,
    </font><font color="#800000">'Lock count overflowed'</font><font color="#000080">,
    </font><font color="#800000">'Lock failed'</font><font color="#000080">,
    </font><font color="#800000">'Smaller UMB is available'</font><font color="#000080">,
    </font><font color="#800000">'No UMBs are available'</font><font color="#000080">,
    </font><font color="#800000">'Inavlid UMB segment number'</font><font color="#000080">);

</font><font color="#FF0000"><b>Type
  </b></font>XMSParamBlock<font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>Length  <font color="#000080">: </font>LongInt<font color="#000080">;
    </font>SHandle <font color="#000080">: </font>Word<font color="#000080">;
    </font>SOffset <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font>High<font color="#000080">..</font>Low<font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Word<font color="#000080">;
    </font>DHandle <font color="#000080">: </font>Word<font color="#000080">;
    </font>DOffset <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font>High<font color="#000080">..</font>Low<font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>XMSAddr <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font>High<font color="#000080">..</font>Low<font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Word<font color="#000080">; </font><font color="#008000"><i>{XMM driver address 1=Low,2=High}

</i></font><font color="#FF0000"><b>Function </b></font>XMMPresent<font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">$4300</font><font color="#000080">;
  </font>Intr<font color="#000080">(</font><font color="#800000">$2F</font><font color="#000080">, </font>Regs<font color="#000080">);
  </font>XMMPresent <font color="#000080">:= </font>Regs<font color="#000080">.</font>AL <font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>XMSErrorString<font color="#000080">(</font>Error <font color="#000080">: </font>Byte<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>I<font color="#000080">, </font>Index <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Index <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>To </b></font>NumberOfErrors <font color="#FF0000"><b>Do
    if </b></font>ErrorNumber<font color="#000080">[</font>I<font color="#000080">] = </font>Error <font color="#FF0000"><b>Then
      </b></font>Index <font color="#000080">:= </font>I<font color="#000080">;
  </font>XMSErrorString <font color="#000080">:= </font>ErrorString<font color="#000080">[</font>Index<font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>XMSMemAvail <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Memory <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 8
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Memory, DX
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>XMSMemAvail <font color="#000080">:= </font>Memory<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>XMSMaxAvail <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 8
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Temp, AX
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>XMSMaxAvail <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>EMBGetMem<font color="#000080">(</font>Size <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 9
    Mov  DX, Size
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Temp, DX
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>EMBGetMem <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EMBFreeMem<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0Ah
    Mov  DX, Handle
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EMBResize<font color="#000080">(</font>Handle<font color="#000080">, </font>Size <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0Fh
    Mov  DX, Handle
    Mov  BX, Size
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>MoveToEMB<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Source<font color="#000080">; </font>Handle <font color="#000080">: </font>Word<font color="#000080">; </font>BlockLength <font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>ParamBlock <font color="#000080">: </font>XMSParamBlock<font color="#000080">;
  </font>XSeg<font color="#000080">, </font>PSeg<font color="#000080">,
  </font>POfs       <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>With </b></font>ParamBlock <font color="#FF0000"><b>Do
  begin
    </b></font>Length        <font color="#000080">:= </font>BlockLength<font color="#000080">;
    </font>SHandle       <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>SOffset<font color="#000080">[</font>High<font color="#000080">] := </font>Ofs<font color="#000080">(</font>Source<font color="#000080">);
    </font>SOffset<font color="#000080">[</font>Low<font color="#000080">]  := </font>Seg<font color="#000080">(</font>Source<font color="#000080">);
    </font>DHandle       <font color="#000080">:= </font>Handle<font color="#000080">;
    </font>DOffset<font color="#000080">[</font>High<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
    </font>DOffset<font color="#000080">[</font>Low<font color="#000080">]  := </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>PSeg <font color="#000080">:= </font>Seg<font color="#000080">(</font>ParamBlock<font color="#000080">);
  </font>POfs <font color="#000080">:= </font>Ofs<font color="#000080">(</font>ParamBlock<font color="#000080">);
  </font>XSeg <font color="#000080">:= </font>Seg<font color="#000080">(</font>XMSAddr<font color="#000080">);

  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Push DS
    Mov  AH, 0Bh
    Mov  SI, POfs
    Mov  BX, XSeg
    Mov  ES, BX
    Mov  BX, PSeg
    Mov  DS, BX
    Call [ES:XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
    Pop  DS
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>MoveFromEMB<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Dest<font color="#000080">; </font>BlockLength <font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>ParamBlock <font color="#000080">: </font>XMSParamBlock<font color="#000080">;
  </font>XSeg<font color="#000080">, </font>PSeg<font color="#000080">,
  </font>POfs       <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>With </b></font>ParamBlock <font color="#FF0000"><b>Do
  begin
    </b></font>Length        <font color="#000080">:= </font>BlockLength<font color="#000080">;
    </font>SHandle       <font color="#000080">:= </font>Handle<font color="#000080">;
    </font>SOffset<font color="#000080">[</font>High<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
    </font>SOffset<font color="#000080">[</font>Low<font color="#000080">]  := </font><font color="#800000">0</font><font color="#000080">;
    </font>DHandle       <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>DOffset<font color="#000080">[</font>High<font color="#000080">] := </font>Ofs<font color="#000080">(</font>Dest<font color="#000080">);
    </font>DOffset<font color="#000080">[</font>Low<font color="#000080">]  := </font>Seg<font color="#000080">(</font>Dest<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>PSeg <font color="#000080">:= </font>Seg<font color="#000080">(</font>ParamBlock<font color="#000080">);
  </font>POfs <font color="#000080">:= </font>Ofs<font color="#000080">(</font>ParamBlock<font color="#000080">);
  </font>XSeg <font color="#000080">:= </font>Seg<font color="#000080">(</font>XMSAddr<font color="#000080">);

  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Push DS
    Mov  AH, 0Bh
    Mov  SI, POfs
    Mov  BX, XSeg;
    Mov  ES, BX
    Mov  BX, PSeg
    Mov  DS, BX
    Call [ES:XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
    Pop  DS
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetXMSVersion <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>HighB<font color="#000080">, </font>LowB <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  HighB, AH
    Mov  LowB, AL
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>GetXMSVersion <font color="#000080">:= (</font>HighB <font color="#000080">* </font><font color="#800000">100</font><font color="#000080">) + </font>LowB<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetXMMVersion <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>HighB<font color="#000080">, </font>LowB <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  HighB, BH
    Mov  LowB, BL
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>GetXMMVersion <font color="#000080">:= (</font>HighB <font color="#000080">* </font><font color="#800000">100</font><font color="#000080">) + </font>LowB<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetHMA <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font>Temp <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Cmp  DX, 0
    Je   @@2
    Mov  Temp, 1
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>GetHMA <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>HMAGetMem<font color="#000080">(</font>Size <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 1
    Mov  DX, Size
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>HMAFreeMem<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 2
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EnableGlobalA20<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 3
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>DisableGlobalA20<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 4
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EnableLocalA20<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 5
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DisableLocalA20<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 6
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetA20Status <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font>Temp <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 6
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Or   AX, AX
    Jne  @@1
    Or   BL, BL
    Jne  @@2
    Mov  Temp, 0
    Jmp  @@1
   @@2:
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>LockEMB<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp1<font color="#000080">,
  </font>Temp2 <font color="#000080">: </font>Word<font color="#000080">;
  </font>Temp  <font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0Ch
    Mov  DX, Handle
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Temp1, DX
    Mov  Temp2, BX
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Temp <font color="#000080">:= </font>Temp1<font color="#000080">;
  </font>LockEMB <font color="#000080">:= (</font>Temp <font color="#FF0000"><b>Shl </b></font><font color="#800000">4</font><font color="#000080">) + </font>Temp2<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>UnlockEMB<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0Dh
    Mov  DX, Handle
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetEMBSize<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0Eh
    Mov  DX, Handle
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Temp, DX
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>GetEMBSize <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetEMBLock<font color="#000080">(</font>Handle <font color="#000080">: </font>Word<font color="#000080">) : </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0Eh
    Mov  DX, Handle
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Temp, BH
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>GetEMBLock <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetAvailEMBHandles <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 0Eh
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Temp, BL
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>GetAvailEMBHandles <font color="#000080">:= </font>Temp<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>UMBGetMem<font color="#000080">(</font>Size <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Segment <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">; </font><font color="#008000"><i>{Actual size}
</i></font><font color="#FF0000"><b>Var
  </b></font>Temp1<font color="#000080">, </font>Temp2 <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 10h
    Mov  DX, Size
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
    Jmp  @@2
   @@1:
    Mov  Temp2, BX
   @@2:
    Mov  Temp1, DX
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Segment <font color="#000080">:= </font>Temp2<font color="#000080">;
  </font>UMBGetMem <font color="#000080">:= </font>Temp1<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>UMBFreeMem<font color="#000080">(</font>Segment <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>XMSError <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if Not</b></font><font color="#000080">(</font>Present<font color="#000080">) </font><font color="#FF0000"><b>Then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov  AH, 10h
    Mov  DX, Segment
    Call [XMSAddr]
    Or   AX, AX
    Jne  @@1
    Mov  XMSError, BL
   @@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if Not</b></font><font color="#000080">(</font>XMMPresent<font color="#000080">) </font><font color="#FF0000"><b>Then
  begin
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'XMS not supported!'</font><font color="#000080">);
    </font>Present <font color="#000080">:= </font>False<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Present <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>With </b></font>Regs <font color="#FF0000"><b>Do
  begin
    </b></font>AX <font color="#000080">:= </font><font color="#800000">$4310</font><font color="#000080">;
    </font>Intr<font color="#000080">(</font><font color="#800000">$2F</font><font color="#000080">, </font>Regs<font color="#000080">);
    </font>XMSAddr<font color="#000080">[</font>High<font color="#000080">] := </font>BX<font color="#000080">;
    </font>XMSAddr<font color="#000080">[</font>Low<font color="#000080">]  := </font>ES<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0031.PAS">Original</a><b>]</b></p></body>
</html>
