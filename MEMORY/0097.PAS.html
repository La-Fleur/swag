<html>
<head><title> "ELLIB's Memory engine" by JOHAN LARSSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0097.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{ Borland Pascal Extended Function Library - EFLIB (C) Johan Larsson, 1996
  Memory engine; handles allocation of data blocks; rewritten Usenet version

  EFLIB IS PROTECTED BY THE COPYRIGHT LAW AND MAY NOT BE COPIED, SOLD OR
  MANIPULATED. FOR MORE INFORMATION, SEE PROGRAM MANUAL!

  THIS IS A SPECIAL RELEASE OF EFLIBS MEMORY ENGINE TO BE PUBLISHED
  IN USENET / SWAGS. THE SOURCE CODE MAY FREELY BE USED NON-COMMERCIALY AS
  LONG AS CREDIT IS GIVEN TO THE PROGRAMMER. THIS UNIT IS INDEPENDENT OF
  OTHER EFLIB COMPONENTS AND DO NOT CONTAIN ALL THE FEATURES INCLUDED
  IN THE REAL VERSION.

  EFLIB is a free OOP toolkit for Borland Pascal. It's free for non-
  commerical use only, and not for business or educational use. EFLIB
  is available through Internet at http://www.ts.umu.se/~jola/EFLIB/.
  Johan Larsson can be reached via E-MAIL (jola@ts.umu.se) or common
  mail (Istidsgatan 33, 2tr., S-906 55 UMEA, Sweden). }


</i></font><font color="#FF0000"><b>unit </b></font>EFLIBMEM<font color="#000080">;


</font><font color="#FF0000"><b>INTERFACE

type </b></font><font color="#008000"><i>{ Object that handles a dynamic DOS memory allocation }
     </i></font>AllocationObjectPointerType       <font color="#000080">= ^</font>AllocationObjectType<font color="#000080">;
     </font>AllocationObjectType              <font color="#000080">= </font><font color="#FF0000"><b>object
                                             public
                                               </b></font><font color="#008000"><i>{ Constructors and destructors }
                                               </i></font><font color="#FF0000"><b>constructor </b></font>Initialize <font color="#000080">(</font>ThisSize <font color="#000080">: </font>word<font color="#000080">);           </font><font color="#008000"><i>{ Initializes object }
                                               </i></font><font color="#FF0000"><b>constructor </b></font>InitializeEmpty<font color="#000080">;                        </font><font color="#008000"><i>{ Initializes empty object }
                                               </i></font><font color="#FF0000"><b>destructor </b></font>Intercept<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;                      </font><font color="#008000"><i>{ Intercepts object }
                                               { Miscellaneous methods }
                                               </i></font><font color="#FF0000"><b>procedure </b></font>Allocate <font color="#000080">(</font>ThisSize <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;      </font><font color="#008000"><i>{ Allocates memory (bytes) }
                                               </i></font><font color="#FF0000"><b>procedure </b></font>Dispose<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;                         </font><font color="#008000"><i>{ Disposes memory }
                                               { Transferration methods }
                                               </i></font><font color="#FF0000"><b>procedure </b></font>MoveIn <font color="#000080">(</font>Source <font color="#000080">: </font>pointer<font color="#000080">; </font>SourceSize<font color="#000080">,
                                                         </font>Position <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;                </font><font color="#008000"><i>{ Moves data into object }
                                               </i></font><font color="#FF0000"><b>procedure </b></font>MoveOut <font color="#000080">(</font>Destination <font color="#000080">: </font>pointer<font color="#000080">;
                                                         </font>DestinationSize<font color="#000080">, </font>Position <font color="#000080">: </font>word<font color="#000080">);
                                                         </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;                                  </font><font color="#008000"><i>{ Moves data out of object }
                                               { Data access methods }
                                               </i></font><font color="#FF0000"><b>function </b></font>DataPointer <font color="#000080">(</font>Position <font color="#000080">: </font>word<font color="#000080">) : </font>pointer<font color="#000080">;   </font><font color="#008000"><i>{ Returns a data pointer }
                                                        </i></font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                                               </font><font color="#FF0000"><b>function </b></font>DataSize <font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;                  </font><font color="#008000"><i>{ Returns the data size }
                                               { Status methods }
                                               </i></font><font color="#FF0000"><b>function </b></font>IsAllocated <font color="#000080">: </font>boolean<font color="#000080">;                     </font><font color="#008000"><i>{ Is memory allocated? }
                                             </i></font><font color="#FF0000"><b>private
                                               </b></font><font color="#008000"><i>{ Fields }
                                               </i></font>Data             <font color="#000080">: </font>pointer<font color="#000080">;                         </font><font color="#008000"><i>{ Data allocation pointer }
                                               </i></font>Size             <font color="#000080">: </font>word<font color="#000080">;                            </font><font color="#008000"><i>{ Data size in bytes }
                                               { Internal methods }
                                               </i></font><font color="#FF0000"><b>procedure </b></font>Clear<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;                           </font><font color="#008000"><i>{ Clear memory }
                                               </i></font><font color="#FF0000"><b>procedure </b></font>Error<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;                           </font><font color="#008000"><i>{ Error handler }
                                         </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ This unit should compile in both real mode and protected mode Borland
  Pascal, but in protected mode, the following procedures must be
  replaced; }

</i></font><font color="#FF0000"><b>procedure </b></font>MoveFAST <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Source<font color="#000080">, </font>Target<font color="#000080">; </font>Size <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>procedure </b></font>FillWord <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Destination<font color="#000080">; </font>Count<font color="#000080">, </font>Data <font color="#000080">: </font>word<font color="#000080">);


</font><font color="#FF0000"><b>IMPLEMENTATION

</b></font><font color="#008000"><i>{$B-} {$IFNDEF DEBUG} {$I-} {$S-} {$R-} {$Q-} {$ENDIF}


{ *** AllocationObjectType *** }

{ Initializes object and allocate specified bytes of memory }
</i></font><font color="#FF0000"><b>constructor </b></font>AllocationObjectType<font color="#000080">.</font>Initialize <font color="#000080">(</font>ThisSize <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{ Prepare object (reset fields) }
     </i></font>InitializeEmpty<font color="#000080">;
     </font><font color="#008000"><i>{ Allocate ThisSize number of bytes on the heap }
     </i></font>Allocate <font color="#000080">(</font>ThisSize<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Initializes object without any data }
</i></font><font color="#FF0000"><b>constructor </b></font>AllocationObjectType<font color="#000080">.</font>InitializeEmpty<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{ Clear allocation variable and reset links }
     </i></font>Data <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">; </font>Size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Intercepts object }
</i></font><font color="#FF0000"><b>destructor </b></font>AllocationObjectType<font color="#000080">.</font>Intercept<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{ Dispose allocated data }
     </i></font><font color="#FF0000"><b>if </b></font>IsAllocated <font color="#FF0000"><b>then </b></font>Dispose<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Allocate memory into AllocationObjectType }
</i></font><font color="#FF0000"><b>procedure </b></font>AllocationObjectType<font color="#000080">.</font>Allocate <font color="#000080">(</font>ThisSize <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{ Allocate memory on the heap }
     </i></font>GetMem <font color="#000080">(</font>Data<font color="#000080">, </font>ThisSize<font color="#000080">);
     </font>Size <font color="#000080">:= </font>ThisSize<font color="#000080">; </font><font color="#008000"><i>{ Adjust size variable }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Dispose memory from AllocationObjectType }
</i></font><font color="#FF0000"><b>procedure </b></font>AllocationObjectType<font color="#000080">.</font>Dispose<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{ Dispose memory from the heap }
     </i></font><font color="#FF0000"><b>if </b></font>Assigned<font color="#000080">(</font>Data<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>FreeMem <font color="#000080">(</font>Data<font color="#000080">, </font>Size<font color="#000080">);
     </font><font color="#008000"><i>{ Reset fields }
     </i></font>Data <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">; </font>Size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Move a data block into object data block }
</i></font><font color="#FF0000"><b>procedure </b></font>AllocationObjectType<font color="#000080">.</font>MoveIn <font color="#000080">(</font>Source <font color="#000080">: </font>pointer<font color="#000080">; </font>SourceSize<font color="#000080">, </font>Position <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
     </b></font><font color="#008000"><i>{ Check that data pointer isn't NIL }
     </i></font><font color="#FF0000"><b>if </b></font>Assigned<font color="#000080">(</font>Source<font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font><font color="#008000"><i>{ Allocate data if no allocation exists }
        </i></font><font color="#FF0000"><b>if not </b></font>IsAllocated <font color="#FF0000"><b>then </b></font>Allocate <font color="#000080">(</font>SourceSize<font color="#000080">);

        </font><font color="#008000"><i>{ Move data from source to current object (prevent overflow) }
        </i></font><font color="#FF0000"><b>if </b></font>IsAllocated <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Size <font color="#000080">&gt;= </font>SourceSize <font color="#000080">+ </font>Position<font color="#000080">) </font><font color="#FF0000"><b>then
           </b></font>MoveFAST <font color="#000080">(</font>Source<font color="#000080">^, </font>DataPointer<font color="#000080">(</font>Position<font color="#000080">)^, </font>SourceSize<font color="#000080">)
           </font><font color="#FF0000"><b>else </b></font>Error<font color="#000080">; </font><font color="#008000"><i>{ Error; fatal memory allocation error }
      </i></font><font color="#FF0000"><b>end else </b></font>Error<font color="#000080">; </font><font color="#008000"><i>{ Error; couldn't access data resource }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Move data out of object data block }
</i></font><font color="#FF0000"><b>procedure </b></font>AllocationObjectType<font color="#000080">.</font>MoveOut <font color="#000080">(</font>Destination <font color="#000080">: </font>pointer<font color="#000080">; </font>DestinationSize<font color="#000080">, </font>Position <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
     if </b></font>Assigned<font color="#000080">(</font>Destination<font color="#000080">) </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ Check that destination is valid }
        </i></font>MoveFAST <font color="#000080">(</font>DataPointer<font color="#000080">(</font>Position<font color="#000080">)^, </font>Destination<font color="#000080">^, </font>DestinationSize<font color="#000080">)
     </font><font color="#FF0000"><b>else </b></font>Error<font color="#000080">; </font><font color="#008000"><i>{ Error; couldn't access data resource }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Returns a pointer to a byte inside allocated data or NIL if no allocation
  exists. }
</i></font><font color="#FF0000"><b>function </b></font>AllocationObjectType<font color="#000080">.</font>DataPointer <font color="#000080">(</font>Position <font color="#000080">: </font>word<font color="#000080">) : </font>pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
     if </b></font>IsAllocated <font color="#FF0000"><b>then </b></font>DataPointer <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>Data<font color="#000080">^), </font>Ofs<font color="#000080">(</font>Data<font color="#000080">^) + </font>Position<font color="#000080">)
        </font><font color="#FF0000"><b>else </b></font>DataPointer <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">; </font><font color="#008000"><i>{ No allocation exists! }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns the size of the allocated data }
</i></font><font color="#FF0000"><b>function </b></font>AllocationObjectType<font color="#000080">.</font>DataSize <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
     if </b></font>IsAllocated <font color="#FF0000"><b>then </b></font>DataSize <font color="#000080">:= </font>Size <font color="#FF0000"><b>else </b></font>DataSize <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Returns TRUE if AllocationObjectType contains an allocated pointer }
</i></font><font color="#FF0000"><b>function </b></font>AllocationObjectType<font color="#000080">.</font>IsAllocated <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>IsAllocated <font color="#000080">:= </font>Assigned<font color="#000080">(</font>Data<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Size <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Clear allocated memory (set all bytes to zero) }
</i></font><font color="#FF0000"><b>procedure </b></font>AllocationObjectType<font color="#000080">.</font>Clear<font color="#000080">;
</font><font color="#FF0000"><b>begin
     if </b></font>IsAllocated <font color="#FF0000"><b>then </b></font>FillChar <font color="#000080">(</font>Data<font color="#000080">, </font>Size<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">)
        </font><font color="#FF0000"><b>else </b></font>Error<font color="#000080">; </font><font color="#008000"><i>{ Error; no allocation exists }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Method for memory allocation error handling }
</i></font><font color="#FF0000"><b>procedure </b></font>AllocationObjectType<font color="#000080">.</font>Error<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>RunError <font color="#000080">(</font><font color="#800000">203</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Fast 16-bit memory moving routine with overlap protection. Performance
  is about 36% better than Borland Pascal 7.0's internal memory moving
  routine. }
</i></font><font color="#FF0000"><b>procedure </b></font>MoveFAST <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Source<font color="#000080">, </font>Target<font color="#000080">; </font>Size <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">PUSH    DS
   PUSH    ES
   LDS     SI, Source
   LES     DI, Target
   MOV     CX, Size
   CLD
   </font><font color="#008000"><i>{ If an overlap of source and target occurs, copy data backwards }
   </i></font><font color="#FF00FF">CMP     SI, DI
   JAE     @2
   ADD     SI, CX
   ADD     DI, CX
   DEC     SI
   DEC     DI
   STD
   SHR     CX, 1
   JAE     @1
   MOVSB
   @1:
   DEC     SI
   DEC     DI
   JMP     @3
   @2:
   SHR     CX, 1
   JNC     @3
   MOVSB
   @3:
   REP     MOVSW
   POP     ES
   POP     DS
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Fills a variable with word-sized data }
</i></font><font color="#FF0000"><b>procedure </b></font>FillWord <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Destination<font color="#000080">; </font>Count<font color="#000080">, </font>Data <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
   </b></font><font color="#FF00FF">LES  DI, Destination
   MOV  CX, Count
   MOV  AX, Data
   CLD
   REP  STOSW
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>end</b></font><font color="#000080">. </font><font color="#008000"><i>{ unit }


</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0097.PAS">Original</a><b>]</b></p></body>
</html>
