<html>
<head><title> "DPMI IO Problem Solve" by DARRYL LUFF</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0081.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{

&gt;&gt; I'm not sure about I/O accesses in protected mode, I haven't had to
&gt;&gt; fiddle with it. It should work I think, the DPMI server should give the
&gt;&gt; program access to all ports?

&gt; Through virtual emulation? Otherwise, they simply don't work...
&gt; I can post some code here if you'd like to look into it.

I'd like to have a look. To at least see if it does the same on my system.
You could try this program:
}

</i></font><font color="#FF0000"><b>Program </b></font>TestIO<font color="#000080">;

</font><font color="#FF0000"><b>TYPE
  </b></font>TDescriptor <font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>Limit0015 <font color="#000080">: </font>Word<font color="#000080">;
    </font>Base0015  <font color="#000080">: </font>Word<font color="#000080">;
    </font>Base1623  <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Rights    <font color="#000080">: </font>Byte<font color="#000080">;   </font><font color="#008000"><i>{ 7=Prsnt, 6-5=Dpl, 4=App,  }
                        { 3-0=Type                  }
    </i></font>Rights386 <font color="#000080">: </font>Byte<font color="#000080">;   </font><font color="#008000"><i>{ 7=Gran, 6=Size32, 5=0,    }
                        { 4=Avail, 3-0=Limit1619    }
    </i></font>Base2431  <font color="#000080">: </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>GetDPL<font color="#000080">(</font>Sel<font color="#000080">: </font>Word<font color="#000080">): </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Buffer <font color="#000080">: </font>TDescriptor<font color="#000080">;
  </font>p      <font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>p <font color="#000080">:= @</font>buffer<font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#008000"><i>{ load descriptor }
    </i></font><font color="#FF00FF">mov ax, 000Bh
    mov bx, [sel]
    les di, [p]
    int 31h

    Mov   Ax,[Word Ptr Buffer+5]
    shr ax, 5
    and ax, 3
    mov [@result], ax
  </font><font color="#FF0000"><b>END
End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>GetIOPL<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  ASM
    </b></font><font color="#FF00FF">pushf
    pop ax

    mov cl, 12
    shr ax, cl
    and ax, 3
    mov [@result], ax
  </font><font color="#FF0000"><b>END
END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>VAR
  </b></font>dpl<font color="#000080">, </font>iopl <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>dpl <font color="#000080">:= </font>GetDPL<font color="#000080">(</font>CSeg<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Your current privilege level (DPL)  = '</font><font color="#000080">, </font>dpl<font color="#000080">);
  </font>iopl <font color="#000080">:= </font>GetIOPL<font color="#000080">;
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'The required privilege level (IOPL) = '</font><font color="#000080">, </font>iopl<font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>dpl <font color="#000080">&lt;= </font>iopl<font color="#000080">) </font><font color="#FF0000"><b>THEN
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'You have direct access to all IO ports'</font><font color="#000080">)
  </font><font color="#FF0000"><b>ELSE
  BEGIN
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'You do not have rights to IN/OUT instructions,'</font><font color="#000080">);
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'unless it is allowed for the particular port'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'in the IO Permission bitmap.'</font><font color="#000080">)
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">mov dx, 3F8h
    in al, dx
    inc dx
    in al, dx
  </font><font color="#FF0000"><b>END
End</b></font><font color="#000080">.

</font><font color="#008000"><i>{
If the DPL and IOPL are the same (both are 3 on my system) you should have
direct access to the ports. If the IOPL is less than 3, the DPMI server isn't
giving you access for some reason. The 'IN's at the end run fine on my PC.

 &gt; I know, i know, but where can i find the list of
 &gt; interrupts *not automatically translated* by the DPMI server?

    I'm sure I've seen it in the manual somewhere, but can't find it now. Most
documented DOS/BIOS interrupts should be covered, but anything else most likely
isn't. The DPMI 0.9 Spec says:
&quot;In general, any software interrupt interface that passes parameters in the
EAX, EBX, ECX, EDX, ESI, EDI and EBP registers will work as long as none of the
registers contains a segment value. In other words, if a software interrupt
interface is completely register based without any pointers, segment register,
or stack parameters, that API could work under any DPMI implementation.&quot;

    I THINK automatic translation of common functions is provided by RTM, and
not the DPMI server directly, which at least means that it should work the same
whether you're using Borlands DPMI server or one in a Dos box etc.
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0081.PAS">Original</a><b>]</b></p></body>
</html>
