<html>
<head><title> "Calls to EMS Manager" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{*************************** EMS.PAS ************************
*** Demonstrate calls to Extended memory manager          ***
************************************************************}

</i></font><font color="#FF0000"><b>USES

  </b></font>Crt<font color="#000080">,</font>Dos<font color="#000080">;

</font><font color="#008000"><i>{***************************************************************}

</i></font><font color="#FF0000"><b>TYPE
  </b></font>PtrType <font color="#000080">= </font><font color="#FF0000"><b>RECORD                  </b></font><font color="#008000"><i>{Define a pointer record    }
    </i></font>Offset  <font color="#000080">: </font>Word<font color="#000080">;                 </font><font color="#008000"><i>{  type so we can access the}
    </i></font>Segment <font color="#000080">: </font>Word                  <font color="#008000"><i>{  individual pointer fields}
    </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>DeviceName <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Char<font color="#000080">; </font><font color="#008000"><i>{Defined to test device Name}

</i></font><font color="#FF0000"><b>CONST

  </b></font>EmsInt      <font color="#000080">= </font><font color="#800000">$67</font><font color="#000080">;                </font><font color="#008000"><i>{EMS Interrupt number       }
  </i></font>IOCtlFunc   <font color="#000080">= </font><font color="#800000">$44</font><font color="#000080">;                </font><font color="#008000"><i>{IOCtl DOS Function number  }
  </i></font>PageLen     <font color="#000080">= </font><font color="#800000">16384</font><font color="#000080">;              </font><font color="#008000"><i>{Length of memory page      }
  </i></font>MsgLen      <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">;                 </font><font color="#008000"><i>{Message len plus len byte  }
  </i></font>MsgsPerPage <font color="#000080">= </font>PageLen <font color="#FF0000"><b>DIV </b></font>MsgLen<font color="#000080">; </font><font color="#008000"><i>{Number of messages in page }
  </i></font>NumMsgs     <font color="#000080">= </font><font color="#800000">5000</font><font color="#000080">;               </font><font color="#008000"><i>{Number EMS messages        }

  {*** Emm functions ***}

  </i></font>GetStatus        <font color="#000080">= </font><font color="#800000">$40</font><font color="#000080">;
  </font>GetPageFrameAddr <font color="#000080">= </font><font color="#800000">$41</font><font color="#000080">;
  </font>GetUnallocPages  <font color="#000080">= </font><font color="#800000">$42</font><font color="#000080">;
  </font>GetEmmVersion    <font color="#000080">= </font><font color="#800000">$46</font><font color="#000080">;
  </font>AllocatePages    <font color="#000080">= </font><font color="#800000">$43</font><font color="#000080">;
  </font>MapHandlePage    <font color="#000080">= </font><font color="#800000">$44</font><font color="#000080">;
  </font>DeallocatePages  <font color="#000080">= </font><font color="#800000">$45</font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>P0<font color="#000080">, </font>P1<font color="#000080">, </font>P2<font color="#000080">, </font>P3 <font color="#000080">: </font>Pointer<font color="#000080">;     </font><font color="#008000"><i>{Pointers to physical pages     }
  </i></font>EmmHandle      <font color="#000080">: </font>Integer<font color="#000080">;     </font><font color="#008000"><i>{Handle for EMM allocated pages }
  </i></font>Tmp            <font color="#000080">: </font><font color="#FF0000"><b>FILE</b></font><font color="#000080">;        </font><font color="#008000"><i>{Temp file to test if EMM exists}
  </i></font>MsgBuf         <font color="#000080">: </font>Pointer<font color="#000080">;     </font><font color="#008000"><i>{Pointer into mapped memory     }
  </i></font>Buff           <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">15</font><font color="#000080">];  </font><font color="#008000"><i>{Buffer for msg stored in EM    }
  </i></font>I              <font color="#000080">: </font>Integer<font color="#000080">;     </font><font color="#008000"><i>{Dummy variable                 }
  </i></font>EmmRegs        <font color="#000080">: </font>Registers<font color="#000080">;   </font><font color="#008000"><i>{Registers for interrupt calls  }
  </i></font>Page<font color="#000080">,</font>Index     <font color="#000080">: </font>Integer<font color="#000080">;     </font><font color="#008000"><i>{Used to address page frame     }
  </i></font>EmsVector      <font color="#000080">: </font>Pointer<font color="#000080">;     </font><font color="#008000"><i>{EMM address from Int $67       }
  </i></font>StrNum         <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];   </font><font color="#008000"><i>{Holds record # for EMM msg     }

{******** Function to convert word value to Hex string *********}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>Hex<font color="#000080">(</font>IntNbr <font color="#000080">: </font>Word<font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>CONST
  </b></font>HexDigit <font color="#000080">:</font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Char <font color="#000080">= </font><font color="#800000">'0123456789ABCDEF'</font><font color="#000080">;
</font><font color="#FF0000"><b>VAR
  </b></font>S        <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];         </font><font color="#008000"><i>{Temporary String}
  </i></font>TempByte <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>TempByte <font color="#000080">:= </font>Hi<font color="#000080">(</font>IntNbr<font color="#000080">);                  </font><font color="#008000"><i>{Convert upper nibble}
  </i></font>S <font color="#000080">:= </font>HexDigit<font color="#000080">[</font>TempByte <font color="#FF0000"><b>DIV </b></font><font color="#800000">16</font><font color="#000080">] +
       </font>HexDigit<font color="#000080">[</font>TempByte <font color="#FF0000"><b>MOD </b></font><font color="#800000">16</font><font color="#000080">];
  </font>TempByte <font color="#000080">:= </font>Lo<font color="#000080">(</font>IntNbr<font color="#000080">);                  </font><font color="#008000"><i>{Convert lower nibble}
  </i></font>Hex <font color="#000080">:= </font>S <font color="#000080">+ </font>HexDigit<font color="#000080">[</font>TempByte <font color="#FF0000"><b>DIV </b></font><font color="#800000">16</font><font color="#000080">] +
             </font>HexDigit<font color="#000080">[</font>TempByte <font color="#FF0000"><b>MOD </b></font><font color="#800000">16</font><font color="#000080">];
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{******** Create a string that contains a pointer value ********}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>PrintPointer<font color="#000080">(</font>P <font color="#000080">: </font>Pointer<font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>PrintPointer <font color="#000080">:= </font>Hex<font color="#000080">(</font>PtrType<font color="#000080">(</font>P<font color="#000080">).</font>Segment<font color="#000080">) + </font><font color="#800000">':' </font><font color="#000080">+
                  </font>Hex<font color="#000080">(</font>PtrType<font color="#000080">(</font>P<font color="#000080">).</font>Offset<font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{*********** Print the EMM Status to the screen ****************}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>EmmPrintStatus<font color="#000080">(</font>Status<font color="#000080">: </font>Byte<font color="#000080">);

</font><font color="#FF0000"><b>CONST
  </b></font>EmmStatus <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">$80</font><font color="#000080">..</font><font color="#800000">$8F</font><font color="#000080">] </font><font color="#FF0000"><b>OF String </b></font><font color="#000080">=
    (</font><font color="#800000">'Driver malfunction'</font><font color="#000080">,
     </font><font color="#800000">'Hardware malfunction'</font><font color="#000080">,
     </font><font color="#800000">''</font><font color="#000080">,
     </font><font color="#800000">'Bad Handle'</font><font color="#000080">,
     </font><font color="#800000">'Undefined FUNCTION'</font><font color="#000080">,
     </font><font color="#800000">'No free handles'</font><font color="#000080">,
     </font><font color="#800000">'Page map context Error'</font><font color="#000080">,
     </font><font color="#800000">'Insufficient memory pages'</font><font color="#000080">,
     </font><font color="#800000">'Not enough free pages'</font><font color="#000080">,
     </font><font color="#800000">'Can''t allocate zero (0) pages'</font><font color="#000080">,
     </font><font color="#800000">'Logical page out of range'</font><font color="#000080">,
     </font><font color="#800000">'Physical page out of range'</font><font color="#000080">,
     </font><font color="#800000">'Page map hardware RAM full'</font><font color="#000080">,
     </font><font color="#800000">'Page map already has a Handle'</font><font color="#000080">,
     </font><font color="#800000">'Page map not mapped to Handle'</font><font color="#000080">,
     </font><font color="#800000">'Undefined subfunction number'</font><font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
  CASE </b></font>Status <font color="#FF0000"><b>OF
    </b></font><font color="#800000">0        </font><font color="#000080">: </font>WriteLn<font color="#000080">(</font><font color="#800000">'Ok'</font><font color="#000080">);
    </font><font color="#800000">$80</font><font color="#000080">..</font><font color="#800000">$8F </font><font color="#000080">: </font>WriteLn<font color="#000080">(</font><font color="#800000">'EMM: '</font><font color="#000080">,</font>EmmStatus<font color="#000080">[</font>Status<font color="#000080">])
    </font><font color="#FF0000"><b>ELSE </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'EMM: Unknown status = $'</font><font color="#000080">,</font>Hex<font color="#000080">(</font>Status<font color="#000080">))
    </font><font color="#FF0000"><b>END
END</b></font><font color="#000080">;



</font><font color="#008000"><i>{******** Generic procedure to call the EMM interrupt **********}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>CallEmm<font color="#000080">(</font>EmmFunction <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>R <font color="#000080">: </font>Registers<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
  </b></font>R<font color="#000080">.</font>AH <font color="#000080">:= </font>EmmFunction<font color="#000080">;
  </font>Intr<font color="#000080">(</font>EmsInt<font color="#000080">,</font>R<font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>R<font color="#000080">.</font>AH <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>EmmPrintStatus<font color="#000080">(</font>EmmRegs<font color="#000080">.</font>AH<font color="#000080">);
    </font>Halt<font color="#000080">(</font>EmmRegs<font color="#000080">.</font>AH<font color="#000080">)
    </font><font color="#FF0000"><b>END
  END</b></font><font color="#000080">;

</font><font color="#008000"><i>{******************  Main Program  *****************************}


</i></font><font color="#FF0000"><b>BEGIN

  </b></font>ClrScr<font color="#000080">;

</font><font color="#008000"><i>{$DEFINE CheckFile}              {Undefine to test second method}

{$IFDEF CheckFile}                  {Check EMM driver - Method 1}

  </i></font>GetIntVec<font color="#000080">(</font>EmsInt<font color="#000080">,</font>EmsVector<font color="#000080">);
  </font>PtrType<font color="#000080">(</font>EmsVector<font color="#000080">).</font>Offset <font color="#000080">:= </font><font color="#800000">10</font><font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>DeviceName<font color="#000080">(</font>EmsVector<font color="#000080">^) &lt;&gt; </font><font color="#800000">'EMMXXXX0'</font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'No EMM driver present'</font><font color="#000080">);
    </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{$ELSE}                             {Check EMM driver - Method 2}

  {***** Determine if EMM is installed by opening EMMXXXX0 *****}

  {$I-}
  </i></font>Assign<font color="#000080">(</font>Tmp<font color="#000080">,</font><font color="#800000">'EMMXXXX0'</font><font color="#000080">);
  </font>Reset<font color="#000080">(</font>Tmp<font color="#000080">);
  </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN      </b></font><font color="#008000"><i>{Opened file without error?}
    </i></font>WriteLn<font color="#000080">(</font><font color="#800000">'No EMM driver present'</font><font color="#000080">);
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'IO error #'</font><font color="#000080">,</font>IOResult<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">);
    </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font>EmmRegs<font color="#000080">.</font>AH <font color="#000080">:= </font>IOCtlFun              <font color="#008000"><i>{Call IOCtl function to   }
  </i></font>EmmRegs<font color="#000080">.</font>AL <font color="#000080">:= </font><font color="#800000">$00</font><font color="#000080">;                  </font><font color="#008000"><i>{ test whether EMMXXXX0 is}
  </i></font>EmmRegs<font color="#000080">.</font>BX <font color="#000080">:= </font>FileRec<font color="#000080">(</font>Tmp<font color="#000080">).</font>Handle<font color="#000080">;  </font><font color="#008000"><i>{ a file or a device      }

  </i></font>MsDos<font color="#000080">(</font>EmmRegs<font color="#000080">);
  </font>Close<font color="#000080">(</font>Tmp<font color="#000080">);

  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>EmmRegs<font color="#000080">.</font>Flags <font color="#FF0000"><b>AND </b></font><font color="#800000">1</font><font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN            </b></font><font color="#008000"><i>{Call successfull}
    </i></font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>EmmRegs<font color="#000080">.</font>DX <font color="#FF0000"><b>AND </b></font><font color="#800000">$80</font><font color="#000080">) = </font><font color="#800000">$80 </font><font color="#FF0000"><b>THEN   </b></font><font color="#008000"><i>{Handle is for a device}
      </i></font>WriteLn<font color="#000080">(</font><font color="#800000">'Handle refers to a device'</font><font color="#000080">)
    </font><font color="#FF0000"><b>ELSE BEGIN
      </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Handle refers to a FILE'</font><font color="#000080">);
      </font>WriteLn<font color="#000080">(</font><font color="#800000">'Unable to contact EMM driver if present'</font><font color="#000080">);
      </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
      </font><font color="#FF0000"><b>END
  ELSE BEGIN                                 </b></font><font color="#008000"><i>{Call unsuccessfull}
    </i></font><font color="#FF0000"><b>CASE </b></font>EmmRegs<font color="#000080">.</font>AX <font color="#FF0000"><b>OF
      </b></font><font color="#800000">1 </font><font color="#000080">: </font>WriteLn<font color="#000080">(</font><font color="#800000">'Invalid IOCTL subfunction'</font><font color="#000080">);
      </font><font color="#800000">5 </font><font color="#000080">: </font>WriteLn<font color="#000080">(</font><font color="#800000">'Access to IOCTL denied'</font><font color="#000080">);
      </font><font color="#800000">6 </font><font color="#000080">: </font>WriteLn<font color="#000080">(</font><font color="#800000">'Invalid Handle'</font><font color="#000080">)
      </font><font color="#FF0000"><b>ELSE </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Unknown error # '</font><font color="#000080">,</font>Hex<font color="#000080">(</font>EmmRegs<font color="#000080">.</font>AX<font color="#000080">))
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'Unable to contact EMM driver'</font><font color="#000080">);
    </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#008000"><i>{$ENDIF}

  </i></font>WriteLn<font color="#000080">(</font><font color="#800000">'EMM driver present'</font><font color="#000080">);

  </font><font color="#008000"><i>{********  Print the current status of the EMM driver ********}

  </i></font>CallEmm<font color="#000080">(</font>GetStatus<font color="#000080">,</font>EmmRegs<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'EMM Status Ok'</font><font color="#000080">);

  </font><font color="#008000"><i>{******** Print the version number of EMM driver *************}

  </i></font>CallEmm<font color="#000080">(</font>GetEmmVersion<font color="#000080">,</font>EmmRegs<font color="#000080">);

  </font>WriteLn<font color="#000080">(</font><font color="#800000">'EMS driver version = '</font><font color="#000080">,
           (</font>EmmRegs<font color="#000080">.</font>AL <font color="#FF0000"><b>SHR </b></font><font color="#800000">4</font><font color="#000080">):</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">'.'</font><font color="#000080">,
           (</font>EmmRegs<font color="#000080">.</font>AL <font color="#FF0000"><b>AND </b></font><font color="#800000">$0F</font><font color="#000080">):</font><font color="#800000">1</font><font color="#000080">);

  </font><font color="#FF0000"><b>IF </b></font>EmmRegs<font color="#000080">.</font>AL <font color="#000080">&lt; </font><font color="#800000">$32 </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Error - EMM is version is earlier than 3.2'</font><font color="#000080">);
    </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#008000"><i>{***** Print the page frame &amp; physical window addresses ******}

  </i></font>CallEmm<font color="#000080">(</font>GetPageFrameAddr<font color="#000080">,</font>EmmRegs<font color="#000080">);

  </font>PtrType<font color="#000080">(</font>P0<font color="#000080">).</font>Segment <font color="#000080">:= </font>EmmRegs<font color="#000080">.</font>BX<font color="#000080">; </font><font color="#008000"><i>{ Window 0 -&gt; P0 = BX:0000 }
  </i></font>PtrType<font color="#000080">(</font>P0<font color="#000080">).</font>Offset <font color="#000080">:= </font><font color="#800000">$0</font><font color="#000080">;
  </font>PtrType<font color="#000080">(</font>P1<font color="#000080">).</font>Segment <font color="#000080">:= </font>EmmRegs<font color="#000080">.</font>BX<font color="#000080">; </font><font color="#008000"><i>{ Window 1 -&gt; P1 = BX:4000 }
  </i></font>PtrType<font color="#000080">(</font>P1<font color="#000080">).</font>Offset <font color="#000080">:= </font><font color="#800000">$4000</font><font color="#000080">;
  </font>PtrType<font color="#000080">(</font>P2<font color="#000080">).</font>Segment <font color="#000080">:= </font>EmmRegs<font color="#000080">.</font>BX<font color="#000080">; </font><font color="#008000"><i>{ Window 2 -&gt; P2 = BX:8000 }
  </i></font>PtrType<font color="#000080">(</font>P2<font color="#000080">).</font>Offset <font color="#000080">:= </font><font color="#800000">$8000</font><font color="#000080">;
  </font>PtrType<font color="#000080">(</font>P3<font color="#000080">).</font>Segment <font color="#000080">:= </font>EmmRegs<font color="#000080">.</font>BX<font color="#000080">; </font><font color="#008000"><i>{ Window 3 -&gt; P3 = BX:C000 }
  </i></font>PtrType<font color="#000080">(</font>P3<font color="#000080">).</font>Offset <font color="#000080">:= </font><font color="#800000">$C000</font><font color="#000080">;

  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Page frame segment address = '</font><font color="#000080">,</font>Hex<font color="#000080">(</font>EmmRegs<font color="#000080">.</font>BX<font color="#000080">));
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Physical page 0 address = '</font><font color="#000080">,</font>PrintPointer<font color="#000080">(</font>P0<font color="#000080">));
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Physical page 1 address = '</font><font color="#000080">,</font>PrintPointer<font color="#000080">(</font>P1<font color="#000080">));
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Physical page 2 address = '</font><font color="#000080">,</font>PrintPointer<font color="#000080">(</font>P2<font color="#000080">));
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Physical page 3 address = '</font><font color="#000080">,</font>PrintPointer<font color="#000080">(</font>P3<font color="#000080">));

  </font><font color="#008000"><i>{***** Print # of unallocated pages and total # of pages *****}

  </i></font>CallEmm<font color="#000080">(</font>GetUnallocPages<font color="#000080">,</font>EmmRegs<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Total EMS pages = '</font><font color="#000080">,</font>EmmRegs<font color="#000080">.</font>DX<font color="#000080">:</font><font color="#800000">4</font><font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Unused EMS pages = '</font><font color="#000080">,</font>EmmRegs<font color="#000080">.</font>BX<font color="#000080">:</font><font color="#800000">4</font><font color="#000080">);

  </font><font color="#008000"><i>{***** Allocate some pages of expanded memory *****}

  </i></font>EmmRegs<font color="#000080">.</font>BX <font color="#000080">:= (</font>NumMsgs <font color="#000080">+ </font>MsgsPerPage<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font>MsgsPerPage<font color="#000080">;
  </font>CallEmm<font color="#000080">(</font>AllocatePages<font color="#000080">,</font>EmmRegs<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Allocated '</font><font color="#000080">,</font>EmmRegs<font color="#000080">.</font>BX<font color="#000080">,
          </font><font color="#800000">' pages to handle # '</font><font color="#000080">,</font>EmmRegs<font color="#000080">.</font>DX<font color="#000080">);
  </font>EmmHandle <font color="#000080">:= </font>EmmRegs<font color="#000080">.</font>DX<font color="#000080">;

  </font><font color="#008000"><i>{***** Load EMS RAM with data *****}

  </i></font>MsgBuf <font color="#000080">:= </font>P0<font color="#000080">;               </font><font color="#008000"><i>{* Set Message pointer to Page 0 *}

  </i></font><font color="#FF0000"><b>FOR </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font>NumMsgs<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>DO BEGIN
    </b></font>Str<font color="#000080">(</font>I<font color="#000080">:</font><font color="#800000">4</font><font color="#000080">,</font>StrNum<font color="#000080">);                       </font><font color="#008000"><i>{Create msg string   }
    </i></font>Buff <font color="#000080">:= </font><font color="#800000">' EMS msg # ' </font><font color="#000080">+ </font>StrNum<font color="#000080">;
    </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>I <font color="#FF0000"><b>MOD </b></font><font color="#800000">100</font><font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN </b></font>Write<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">);    </font><font color="#008000"><i>{Dsp status on screen}
    </i></font>Page <font color="#000080">:= </font>I <font color="#FF0000"><b>DIV </b></font>MsgsPerPage<font color="#000080">;
    </font>Index <font color="#000080">:= </font>I <font color="#FF0000"><b>MOD </b></font>MsgsPerPage<font color="#000080">;
    </font>PtrType<font color="#000080">(</font>MsgBuf<font color="#000080">).</font>Offset <font color="#000080">:= </font>Index <font color="#000080">* </font>SizeOf<font color="#000080">(</font>Buff<font color="#000080">);

     </font><font color="#008000"><i>{**** Map indicated logical page into physical page 0 ****}

    </i></font>EmmRegs<font color="#000080">.</font>AH <font color="#000080">:= </font>MapHandlePage<font color="#000080">;           </font><font color="#008000"><i>{Map EMS page cmd    }
    </i></font>EmmRegs<font color="#000080">.</font>BX <font color="#000080">:= </font>Page<font color="#000080">;                    </font><font color="#008000"><i>{Logical page number }
    </i></font>EmmRegs<font color="#000080">.</font>AL <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                       </font><font color="#008000"><i>{Physical page 0     }
    </i></font>EmmRegs<font color="#000080">.</font>DX <font color="#000080">:= </font>EmmHandle<font color="#000080">;               </font><font color="#008000"><i>{EMM RAM handle      }

    </i></font>Intr<font color="#000080">(</font>EmsInt<font color="#000080">,</font>EmmRegs<font color="#000080">);

    </font><font color="#FF0000"><b>IF </b></font>EmmRegs<font color="#000080">.</font>AH <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
      </b></font>Move<font color="#000080">(</font>Buff<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">],</font>MsgBuf<font color="#000080">^,</font>SizeOf<font color="#000080">(</font>Buff<font color="#000080">))   </font><font color="#008000"><i>{Set message into mem}
    </i></font><font color="#FF0000"><b>ELSE BEGIN
      </b></font>EmmPrintStatus<font color="#000080">(</font>EmmRegs<font color="#000080">.</font>AH<font color="#000080">);
      </font>I <font color="#000080">:= </font>NumMsgs
      <font color="#FF0000"><b>END
    END</b></font><font color="#000080">;

    </font>WriteLn<font color="#000080">;

  </font><font color="#008000"><i>{******  Allow user to access any message in the buffer ******}

  </i></font>I <font color="#000080">:= </font><font color="#800000">$FF</font><font color="#000080">;
  </font><font color="#FF0000"><b>WHILE </b></font>I <font color="#000080">&lt;&gt; -</font><font color="#800000">1 </font><font color="#FF0000"><b>DO BEGIN
    </b></font>MsgBuf <font color="#000080">:= </font>P3<font color="#000080">;                 </font><font color="#008000"><i>{Set MsgBuf to physical page 3}
    </i></font>Write<font color="#000080">(</font><font color="#800000">'Enter message # to retrieve, or -1 to quit: '</font><font color="#000080">);
    </font>ReadLn<font color="#000080">(</font>I<font color="#000080">);
    </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>I <font color="#000080">&gt;= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>I <font color="#000080">&lt; </font>NumMsgs<font color="#000080">) </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Page <font color="#000080">:= </font>I <font color="#FF0000"><b>DIV </b></font>MsgsPerPage<font color="#000080">;
      </font>Index <font color="#000080">:= </font>I <font color="#FF0000"><b>MOD </b></font>MsgsPerPage<font color="#000080">;

        </font><font color="#008000"><i>{**** Map indicated page into physical page 3 ****}

      </i></font>EmmRegs<font color="#000080">.</font>AH <font color="#000080">:= </font>MapHandlePage<font color="#000080">;         </font><font color="#008000"><i>{Map EMM page command}
      </i></font>EmmRegs<font color="#000080">.</font>BX <font color="#000080">:= </font>Page<font color="#000080">;                  </font><font color="#008000"><i>{Logical page number }
      </i></font>EmmRegs<font color="#000080">.</font>AL <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;                     </font><font color="#008000"><i>{Physical page 3     }
      </i></font>EmmRegs<font color="#000080">.</font>DX <font color="#000080">:= </font>EmmHandle<font color="#000080">;             </font><font color="#008000"><i>{EMM RAM handle      }

      </i></font>Intr<font color="#000080">(</font>EmsInt<font color="#000080">,</font>EmmRegs<font color="#000080">);

      </font><font color="#FF0000"><b>IF </b></font>EmmRegs<font color="#000080">.</font>AH <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>THEN BEGIN
        </b></font>Inc<font color="#000080">(</font>PtrType<font color="#000080">(</font>MsgBuf<font color="#000080">).</font>Offset<font color="#000080">,</font>Index <font color="#000080">* </font>SizeOf<font color="#000080">(</font>Buff<font color="#000080">));
        </font>Move<font color="#000080">(</font>MsgBuf<font color="#000080">^,</font>Buff<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">],</font>SizeOf<font color="#000080">(</font>Buff<font color="#000080">));
        </font>Write<font color="#000080">(</font><font color="#800000">'Retrieved message -&gt; '</font><font color="#000080">,</font>Buff<font color="#000080">);
        </font>WriteLn<font color="#000080">(</font><font color="#800000">' from page #'</font><font color="#000080">,</font>Page<font color="#000080">:</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">' Index'</font><font color="#000080">,</font>Index<font color="#000080">:</font><font color="#800000">5</font><font color="#000080">);
        </font><font color="#FF0000"><b>END
      ELSE BEGIN
        </b></font>EmmPrintStatus<font color="#000080">(</font>EmmRegs<font color="#000080">.</font>AH<font color="#000080">);
        </font>I <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
        </font><font color="#FF0000"><b>END
      END
    END</b></font><font color="#000080">;

     </font><font color="#008000"><i>{***** Free the EMS RAM back to the EMM driver ****}

  </i></font>EmmRegs<font color="#000080">.</font>DX <font color="#000080">:= </font>EmmHandle<font color="#000080">;
  </font>CallEmm<font color="#000080">(</font>DeallocatePages<font color="#000080">,</font>EmmRegs<font color="#000080">);
  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Released all memory for handle '</font><font color="#000080">,</font>EmmRegs<font color="#000080">.</font>DX<font color="#000080">:</font><font color="#800000">2</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p></body>
</html>
