<html>
<head><title> "DPMI Memory in WinAPI" by DJ MURDOCH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Protected mode has the WinAPI unit that lets you deal with
&gt; huge memory blocks and other stuff. That is what is needed.

&gt; In real mode all you can do is:

Here's some stuff from a huge memory block unit I'm working on.  It isn't fully
debugged yet, but I think these parts work.  However, use at your own risk.
There are a few routines called which I don't include; you should be able to
figure those ones out, or pull them out of a standard library.  &quot;LH&quot; is a
record with fields L and H for pulling the low and high words out of a pointer
or longint.

 { This part works in both real and protected mode. }

 </i></font><font color="#FF0000"><b>procedure </b></font>IncPtr<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>pointer<font color="#000080">;</font>count<font color="#000080">:</font>word<font color="#000080">);
 </font><font color="#008000"><i>{ Increments pointer }
 </i></font><font color="#FF0000"><b>begin
   </b></font>inc<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L<font color="#000080">,</font>count<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L <font color="#000080">&lt; </font>count <font color="#FF0000"><b>then
     </b></font>inc<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>H<font color="#000080">,</font>SelectorInc<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>DecPtr<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>pointer<font color="#000080">;</font>count<font color="#000080">:</font>word<font color="#000080">);
 </font><font color="#008000"><i>{ decrements pointer }
 </i></font><font color="#FF0000"><b>begin
   if </b></font>count <font color="#000080">&gt; </font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L <font color="#FF0000"><b>then
     </b></font>dec<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>H<font color="#000080">,</font>SelectorInc<font color="#000080">);
   </font>dec<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L<font color="#000080">,</font>Count<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>IncPtrLong<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>pointer<font color="#000080">;</font>count<font color="#000080">:</font>longint<font color="#000080">);
 </font><font color="#008000"><i>{ Increments pointer; assumes count &gt; 0 }
 </i></font><font color="#FF0000"><b>begin
   </b></font>inc<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>H<font color="#000080">,</font>SelectorInc<font color="#000080">*</font>LH<font color="#000080">(</font>count<font color="#000080">).</font>H<font color="#000080">);
   </font>inc<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L<font color="#000080">,</font>LH<font color="#000080">(</font>Count<font color="#000080">).</font>L<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L <font color="#000080">&lt; </font>LH<font color="#000080">(</font>count<font color="#000080">).</font>L <font color="#FF0000"><b>then
     </b></font>inc<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>H<font color="#000080">,</font>SelectorInc<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>DecPtrLong<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>pointer<font color="#000080">;</font>count<font color="#000080">:</font>longint<font color="#000080">);
 </font><font color="#008000"><i>{ Decrements pointer; assumes count &gt; 0 }
 </i></font><font color="#FF0000"><b>begin
   if </b></font>LH<font color="#000080">(</font>count<font color="#000080">).</font>L <font color="#000080">&gt; </font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L <font color="#FF0000"><b>then
     </b></font>dec<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>H<font color="#000080">,</font>SelectorInc<font color="#000080">);
   </font>dec<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>L<font color="#000080">,</font>LH<font color="#000080">(</font>Count<font color="#000080">).</font>L<font color="#000080">);
   </font>dec<font color="#000080">(</font>LH<font color="#000080">(</font>p<font color="#000080">).</font>H<font color="#000080">,</font>SelectorInc<font color="#000080">*</font>LH<font color="#000080">(</font>Count<font color="#000080">).</font>H<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#008000"><i>{ The next section is for real mode only }

{$ifndef dpmi}

 </i></font><font color="#FF0000"><b>type
   </b></font>PFreeRec <font color="#000080">= ^</font>TFreeRec<font color="#000080">;
   </font>TFreeRec <font color="#000080">= </font><font color="#FF0000"><b>record
     </b></font>next<font color="#000080">: </font>PFreeRec<font color="#000080">;
     </font>size<font color="#000080">: </font>Pointer<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>GetMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>HugePtr<font color="#000080">;</font>size<font color="#000080">:</font>Longint<font color="#000080">);
 </font><font color="#FF0000"><b>const
   </b></font>blocksize <font color="#000080">= </font><font color="#800000">$FFF0</font><font color="#000080">;
 </font><font color="#FF0000"><b>var
   </b></font>prev<font color="#000080">,</font>free <font color="#000080">: </font>PFreeRec<font color="#000080">;
   </font>save<font color="#000080">,</font>temp <font color="#000080">: </font>pointer<font color="#000080">;
   </font>block <font color="#000080">: </font>word<font color="#000080">;
 </font><font color="#FF0000"><b>begin
   </b></font><font color="#008000"><i>{ Handle the easy cases first }
   </i></font><font color="#FF0000"><b>if </b></font>size <font color="#000080">&gt; </font>maxavail <font color="#FF0000"><b>then
     </b></font>p <font color="#000080">:= </font><font color="#FF0000"><b>nil
   else if </b></font>size <font color="#000080">&lt; </font><font color="#800000">65521 </font><font color="#FF0000"><b>then
     </b></font>getmem<font color="#000080">(</font>p<font color="#000080">,</font>size<font color="#000080">)
   </font><font color="#FF0000"><b>else
   begin
 </b></font><font color="#008000"><i>{$ifndef ver60}
    {$ifndef ver70}
     </i></font>The code below <font color="#FF0000"><b>is </b></font>extremely version specific <font color="#FF0000"><b>to </b></font>the TP <font color="#800000">6</font><font color="#000080">/</font><font color="#800000">7 </font>heap manager<font color="#000080">!!
    </font><font color="#008000"><i>{$endif}
 {$endif}
     { Find the block that has enough space }
     </i></font>prev <font color="#000080">:= </font>PFreeRec<font color="#000080">(@</font>freeList<font color="#000080">);
     </font>free <font color="#000080">:= </font>prev<font color="#000080">^.</font>next<font color="#000080">;
     </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>free <font color="#000080">&lt;&gt; </font>heapptr<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PtrToLong<font color="#000080">(</font>free<font color="#000080">^.</font>size<font color="#000080">) &lt; </font>size<font color="#000080">) </font><font color="#FF0000"><b>do
     begin
       </b></font>prev <font color="#000080">:= </font>free<font color="#000080">;
       </font>free <font color="#000080">:= </font>prev<font color="#000080">^.</font>next<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#008000"><i>{ Now free points to a region with enough space; make it the first one and
       multiple allocations will be contiguous. }

     </i></font>save <font color="#000080">:= </font>freelist<font color="#000080">;
     </font>freelist <font color="#000080">:= </font>free<font color="#000080">;
     </font><font color="#008000"><i>{ In TP 6, this works; check against other heap managers }
     </i></font><font color="#FF0000"><b>while </b></font>size <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
     begin
       </b></font>block <font color="#000080">:= </font>minlong<font color="#000080">(</font>blocksize<font color="#000080">,</font>size<font color="#000080">);
       </font>dec<font color="#000080">(</font>size<font color="#000080">,</font>block<font color="#000080">);
       </font>getmem<font color="#000080">(</font>temp<font color="#000080">,</font>block<font color="#000080">);
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#008000"><i>{ We've got what we want now; just sort things out and restore the
       free list to normal }

     </i></font>p <font color="#000080">:= </font>free<font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>prev<font color="#000080">^.</font>next <font color="#000080">&lt;&gt; </font>freelist <font color="#FF0000"><b>then
     begin
       </b></font>prev<font color="#000080">^.</font>next <font color="#000080">:= </font>freelist<font color="#000080">;
       </font>freelist <font color="#000080">:= </font>save<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>FreeMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>HugePtr<font color="#000080">;</font>size <font color="#000080">: </font>longint<font color="#000080">);
 </font><font color="#FF0000"><b>const
   </b></font>blocksize <font color="#000080">= </font><font color="#800000">$FFF0</font><font color="#000080">;
 </font><font color="#FF0000"><b>var
   </b></font>block <font color="#000080">: </font>word<font color="#000080">;
 </font><font color="#FF0000"><b>begin
   while </b></font>size <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
   begin
     </b></font>block <font color="#000080">:= </font>minlong<font color="#000080">(</font>blocksize<font color="#000080">,</font>size<font color="#000080">);
     </font>dec<font color="#000080">(</font>size<font color="#000080">,</font>block<font color="#000080">);
     </font>freemem<font color="#000080">(</font>p<font color="#000080">,</font>block<font color="#000080">);
     </font>IncPtr<font color="#000080">(</font>p<font color="#000080">,</font>block<font color="#000080">);
     </font>p <font color="#000080">:= </font>Normalized<font color="#000080">(</font>p<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ The next section is the protected mode part }

 {$else}

 </i></font><font color="#FF0000"><b>Procedure </b></font>GetMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p <font color="#000080">: </font>HugePtr<font color="#000080">; </font>Size<font color="#000080">: </font>LongInt<font color="#000080">);
 </font><font color="#FF0000"><b>begin
   if </b></font>Size <font color="#000080">&lt; </font><font color="#800000">65521 </font><font color="#FF0000"><b>then
     </b></font>GetMem<font color="#000080">(</font>p<font color="#000080">,</font>size<font color="#000080">)
   </font><font color="#FF0000"><b>else
     </b></font>p <font color="#000080">:= </font>GlobalAllocPtr<font color="#000080">(</font>gmem_moveable<font color="#000080">,</font>Size<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>Procedure </b></font>FreeMemHuge<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p <font color="#000080">: </font>HugePtr<font color="#000080">; </font>Size<font color="#000080">: </font>Longint<font color="#000080">);
 </font><font color="#FF0000"><b>var
   </b></font>h <font color="#000080">: </font>THandle<font color="#000080">;
 </font><font color="#FF0000"><b>begin
   if </b></font>Size <font color="#000080">&lt; </font><font color="#800000">65521 </font><font color="#FF0000"><b>then
     </b></font>Freemem<font color="#000080">(</font>p<font color="#000080">,</font>size<font color="#000080">)
   </font><font color="#FF0000"><b>else
     </b></font>h <font color="#000080">:= </font>GlobalFreePtr<font color="#000080">(</font>p<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p></body>
</html>
