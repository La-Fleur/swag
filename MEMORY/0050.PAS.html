<html>
<head><title> "TStream for XMS" by HELGE HELGESEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{$A+,B-,D+,E-,F-,G+,I+,L+,N-,O+,P+,Q+,R+,S+,T-,V-,X+,Y+}
{.$DEFINE OPRO}
{
  This unit adds an XMS-memory stream to TStream or IdStream
  depending on the define above.
  (c) 1994 Helge Olav Helgesen
  If you have any comments, please leave them in the Pascal
  conference on Rime or U'NI, or on InterNet to me at
  helge.helgesen@midnight.powertech.no
}
{$IFNDEF MSDOS}
  </i></font><font color="#000080">!! </font>This <font color="#FF0000"><b>unit </b></font>must be compiled under real mode <font color="#000080">!!
</font><font color="#008000"><i>{$ENDIF}
</i></font><font color="#FF0000"><b>Unit </b></font>Xms<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
</b></font><font color="#008000"><i>{$IFDEF OPRO}
  </i></font>OpRoot<font color="#000080">,
</font><font color="#008000"><i>{$ELSE}
  </i></font>Objects<font color="#000080">,
</font><font color="#008000"><i>{$ENDIF}
  </i></font>OpDos<font color="#000080">, </font>OpXms<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>PXmsStream <font color="#000080">= ^</font>TXmsStream<font color="#000080">; </font><font color="#008000"><i>{ pointer to TXmsStream }
  </i></font>TXmsStream <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font><font color="#008000"><i>{$IFDEF OPRO}</i></font>IdStream<font color="#008000"><i>{$ELSE}</i></font>TStream<font color="#008000"><i>{$ENDIF}</i></font><font color="#000080">)
    </font>XmsSizeInK<font color="#000080">, </font><font color="#008000"><i>{ allocated size in kilobytes }
    </i></font>XmsHandle<font color="#000080">: </font>word<font color="#000080">; </font><font color="#008000"><i>{ XMS Handle }
    </i></font>TotalSize<font color="#000080">, </font><font color="#008000"><i>{ total size in bytes }
    </i></font>CurOfs<font color="#000080">, </font><font color="#008000"><i>{ current offset into the stream }
    </i></font>UsedSize<font color="#000080">: </font>longint<font color="#000080">; </font><font color="#008000"><i>{ size of used stream }

    </i></font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>MemNeeded<font color="#000080">: </font>word<font color="#000080">); </font><font color="#008000"><i>{ allocate ext. memory and init vars }
    </i></font><font color="#FF0000"><b>destructor  </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ deallocate ext. memory }

    </i></font><font color="#FF0000"><b>procedure   </b></font>Seek<font color="#000080">(</font>WhereTo<font color="#000080">: </font>longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ seek within stream }
    </i></font><font color="#FF0000"><b>function    </b></font>GetPos<font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ get curret offset }
    </i></font><font color="#FF0000"><b>function    </b></font>GetSize<font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ get used size of stream }
    </i></font><font color="#FF0000"><b>procedure   </b></font>SetPos<font color="#000080">(</font>Ofs<font color="#000080">: </font>longint<font color="#000080">; </font>Mode<font color="#000080">: </font>byte<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ seek using POS mode
 }

    </i></font><font color="#FF0000"><b>procedure   </b></font>Truncate<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ truncate stream to current size }

    </i></font><font color="#FF0000"><b>procedure   </b></font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ writes Buf to the stream
 }
    </i></font><font color="#FF0000"><b>procedure   </b></font>Read<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; </font><font color="#008000"><i>{ reads Buf from the stream
 }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream }

{$IFNDEF OPRO}
</i></font><font color="#FF0000"><b>var
  </b></font>InitStatus<font color="#000080">: </font>byte<font color="#000080">; </font><font color="#008000"><i>{ detailed error code from last Init or Done }
{$ENDIF}

</i></font><font color="#FF0000"><b>const
  </b></font>RealMemHandle <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">; </font><font color="#008000"><i>{ handle for Real Memory }
{$IFNDEF OPRO}
  </i></font>PosAbs     <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;               </font><font color="#008000"><i>{Relative to beginning}
  </i></font>PosCur     <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;               </font><font color="#008000"><i>{Relative to current position}
  </i></font>PosEnd     <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;               </font><font color="#008000"><i>{Relative to end}
{$ENDIF}

{$IFDEF OPRO}
</i></font><font color="#FF0000"><b>procedure </b></font>SaveStream<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>IdStream<font color="#000080">);
  </font><font color="#008000"><i>{ Saves a stream to disk, old file is erased! }
</i></font><font color="#FF0000"><b>procedure </b></font>LoadStream<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>IdStream<font color="#000080">);
  </font><font color="#008000"><i>{ Loads a stream from disk }
{$ELSE}
</i></font><font color="#FF0000"><b>procedure </b></font>SaveStream<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">);
  </font><font color="#008000"><i>{ Saves a stream to disk, old file is erased! }
</i></font><font color="#FF0000"><b>procedure </b></font>LoadStream<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>S<font color="#000080">: </font>TStream<font color="#000080">);
  </font><font color="#008000"><i>{ Loads a stream from disk }
{$ENDIF}

</i></font><font color="#FF0000"><b>implementation

constructor </b></font>TXmsStream<font color="#000080">.</font>Init<font color="#000080">;
  </font><font color="#008000"><i>{ You should already have tested if XMS is installed! }
</i></font><font color="#FF0000"><b>begin
  if not inherited </b></font>Init <font color="#FF0000"><b>then </b></font>Fail<font color="#000080">;
  </font>InitStatus<font color="#000080">:=</font>AllocateExtMem<font color="#000080">(</font>MemNeeded<font color="#000080">, </font>XmsHandle<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>InitStatus<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Fail<font color="#000080">;
  </font>XmsSizeInK<font color="#000080">:=</font>MemNeeded<font color="#000080">;
  </font>TotalSize<font color="#000080">:=</font>LongInt<font color="#000080">(</font>MemNeeded<font color="#000080">)*</font>LongInt<font color="#000080">(</font><font color="#800000">1024</font><font color="#000080">);
  </font>UsedSize<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>CurOfs<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream }

</i></font><font color="#FF0000"><b>destructor </b></font>TXmsStream<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FreeExtMem<font color="#000080">(</font>XmsHandle<font color="#000080">);
  </font><font color="#FF0000"><b>inherited </b></font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream.Done }

</i></font><font color="#FF0000"><b>procedure </b></font>TXmsStream<font color="#000080">.</font>Seek<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
  </i></font><font color="#FF0000"><b>if </b></font>idStatus<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF0000"><b>if </b></font>Status<font color="#000080">=</font>stOk <font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
  </i></font>CurOfs<font color="#000080">:=</font>WhereTo<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream }

</i></font><font color="#FF0000"><b>function </b></font>TXmsStream<font color="#000080">.</font>GetPos<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
  </i></font><font color="#FF0000"><b>if </b></font>idStatus<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF0000"><b>if </b></font>Status<font color="#000080">=</font>stOk <font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
  </i></font>GetPos<font color="#000080">:=</font>CurOfs <font color="#FF0000"><b>else </b></font>GetPos<font color="#000080">:=-</font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream.GetPos }

</i></font><font color="#FF0000"><b>function </b></font>TXmsStream<font color="#000080">.</font>GetSize<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
  </i></font><font color="#FF0000"><b>if </b></font>idStatus<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF0000"><b>if </b></font>Status<font color="#000080">=</font>stOk <font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
  </i></font>GetSize<font color="#000080">:=</font>UsedSize <font color="#FF0000"><b>else </b></font>GetSize<font color="#000080">:=-</font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream.GetSize }

</i></font><font color="#FF0000"><b>procedure </b></font>TXmsStream<font color="#000080">.</font>Truncate<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
  </i></font><font color="#FF0000"><b>if </b></font>idStatus<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF0000"><b>if </b></font>Status<font color="#000080">=</font>stOk <font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
  </i></font>UsedSize<font color="#000080">:=</font>CurOfs<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream.Truncate }

</i></font><font color="#FF0000"><b>procedure </b></font>TXmsStream<font color="#000080">.</font>Write<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>NumberisOdd<font color="#000080">: </font>boolean<font color="#000080">;
  </font>x<font color="#000080">: </font>word<font color="#000080">;
  </font>Source<font color="#000080">, </font>Dest<font color="#000080">: </font>ExtMemPtr<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
  </i></font><font color="#FF0000"><b>if </b></font>idStatus<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF0000"><b>if </b></font>Status<font color="#000080">&lt;&gt;</font>stOk <font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
  </i></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>LongInt<font color="#000080">(</font>Count<font color="#000080">)+</font>LongInt<font color="#000080">(</font>CurOfs<font color="#000080">)&gt;</font>LongInt<font color="#000080">(</font>TotalSize<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
    </i></font>Error<font color="#000080">(</font><font color="#800000">101</font><font color="#000080">); </font><font color="#008000"><i>{ disk write error }
{$ELSE}
    </i></font>Error<font color="#000080">(</font>stWriteError<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
    </i></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
  </i></font>NumberIsOdd<font color="#000080">:=</font>Odd<font color="#000080">(</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>NumberIsOdd <font color="#FF0000"><b>then </b></font>Dec<font color="#000080">(</font>Count<font color="#000080">);
  </font>Source<font color="#000080">.</font>RealPtr<font color="#000080">:=@</font>Buf<font color="#000080">;
  </font>Dest<font color="#000080">.</font>ProtectedPtr<font color="#000080">:=</font>CurOfs<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Count<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  </b></font>x<font color="#000080">:=</font>MoveExtMemBlock<font color="#000080">(</font>Count<font color="#000080">, </font>RealMemHandle<font color="#000080">, </font>Source<font color="#000080">, </font><font color="#008000"><i>{ source data }
                     </i></font>XmsHandle<font color="#000080">, </font>Dest<font color="#000080">) </font><font color="#008000"><i>{ dest data }
  </i></font><font color="#FF0000"><b>else </b></font>x<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>x<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ new error }
  </i></font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
    </i></font>Error<font color="#000080">(</font><font color="#800000">101</font><font color="#000080">); </font><font color="#008000"><i>{ disk write error }
{$ELSE}
    </i></font>Error<font color="#000080">(</font>stWriteError<font color="#000080">, </font>x<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
    </i></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
  </i></font>Inc<font color="#000080">(</font>CurOfs<font color="#000080">, </font>Count<font color="#000080">); </font><font color="#008000"><i>{ adjust current offset }
  </i></font><font color="#FF0000"><b>if </b></font>CurOfs<font color="#000080">&gt;</font>UsedSize <font color="#FF0000"><b>then </b></font>UsedSize<font color="#000080">:=</font>CurOfs<font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>NumberisOdd <font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#008000"><i>{ get last byte to transfer }
    </i></font><font color="#FF00FF">les  di, Buf
    mov  bx, Count
    mov  ax, es:[di+bx]
    inc  Count
    mov  x, ax
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ asm }
  </i></font>Source<font color="#000080">.</font>RealPtr<font color="#000080">:=@</font>x<font color="#000080">;
  </font>Inc<font color="#000080">(</font>Dest<font color="#000080">.</font>ProtectedPtr<font color="#000080">, </font>Count<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">);
  </font>Count<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">;
  </font>x<font color="#000080">:=</font>MoveExtMemBlock<font color="#000080">(</font>Count<font color="#000080">, </font>RealMemHandle<font color="#000080">, </font>Source<font color="#000080">, </font><font color="#008000"><i>{ source data }
                     </i></font>XmsHandle<font color="#000080">, </font>Dest<font color="#000080">); </font><font color="#008000"><i>{ dest data }
  </i></font><font color="#FF0000"><b>if </b></font>x<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ new error }
  </i></font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
    </i></font>Error<font color="#000080">(</font><font color="#800000">101</font><font color="#000080">); </font><font color="#008000"><i>{ disk write error }
{$ELSE}
    </i></font>Error<font color="#000080">(</font>stWriteError<font color="#000080">, </font>x<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
    </i></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
  </i></font>Inc<font color="#000080">(</font>CurOfs<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>CurOfs<font color="#000080">&gt;</font>UsedSize <font color="#FF0000"><b>then </b></font>UsedSize<font color="#000080">:=</font>CurOfs<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream.Write }

</i></font><font color="#FF0000"><b>procedure </b></font>TXmsStream<font color="#000080">.</font>Read<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>NumberisOdd<font color="#000080">: </font>boolean<font color="#000080">;
  </font>x<font color="#000080">: </font>word<font color="#000080">;
  </font>Source<font color="#000080">, </font>Dest<font color="#000080">: </font>ExtMemPtr<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
  </i></font><font color="#FF0000"><b>if </b></font>idStatus<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF0000"><b>if </b></font>Status<font color="#000080">&lt;&gt;</font>stOk <font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
  </i></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>LongInt<font color="#000080">(</font>CurOfs<font color="#000080">)+</font>LongInt<font color="#000080">(</font>Count<font color="#000080">)&gt;</font>LongInt<font color="#000080">(</font>UsedSize<font color="#000080">) </font><font color="#FF0000"><b>then
  begin </b></font><font color="#008000"><i>{ read error }
{$IFDEF OPRO}
    </i></font>Error<font color="#000080">(</font><font color="#800000">100</font><font color="#000080">); </font><font color="#008000"><i>{ read error }
{$ELSE}
    </i></font>Error<font color="#000080">(</font>stReadError<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
    </i></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
  </i></font>NumberisOdd<font color="#000080">:=</font>Odd<font color="#000080">(</font>Count<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>NumberisOdd <font color="#FF0000"><b>then </b></font>Inc<font color="#000080">(</font>Count<font color="#000080">);
  </font>Source<font color="#000080">.</font>ProtectedPtr<font color="#000080">:=</font>CurOfs<font color="#000080">;
  </font>Dest<font color="#000080">.</font>RealPtr<font color="#000080">:=@</font>Buf<font color="#000080">;
  </font>x<font color="#000080">:=</font>MoveExtMemBlock<font color="#000080">(</font>Count<font color="#000080">, </font>XmsHandle<font color="#000080">, </font>Source<font color="#000080">, </font><font color="#008000"><i>{ source data }
                     </i></font>RealMemHandle<font color="#000080">, </font>Dest<font color="#000080">); </font><font color="#008000"><i>{ dest data }
  </i></font><font color="#FF0000"><b>if </b></font>x<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
</b></font><font color="#008000"><i>{$IFDEF OPRO}
    </i></font>Error<font color="#000080">(</font><font color="#800000">100</font><font color="#000080">); </font><font color="#008000"><i>{ read error }
{$ELSE}
    </i></font>Error<font color="#000080">(</font>stReadError<font color="#000080">, </font>x<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
    </i></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
  </i></font><font color="#FF0000"><b>if </b></font>NumberisOdd <font color="#FF0000"><b>then </b></font>Dec<font color="#000080">(</font>Count<font color="#000080">);
  </font>Inc<font color="#000080">(</font>CurOfs<font color="#000080">, </font>Count<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream.Read }

</i></font><font color="#FF0000"><b>procedure </b></font>TXmsStream<font color="#000080">.</font>SetPos<font color="#000080">;
</font><font color="#FF0000"><b>begin
  case </b></font>Mode <font color="#FF0000"><b>of
    </b></font>PosAbs<font color="#000080">: </font>Seek<font color="#000080">(</font>Ofs<font color="#000080">);
    </font>PosCur<font color="#000080">: </font>Seek<font color="#000080">(</font>LongInt<font color="#000080">(</font>Ofs<font color="#000080">)+</font>LongInt<font color="#000080">(</font>CurOfs<font color="#000080">));
    </font>PosEnd<font color="#000080">: </font>Seek<font color="#000080">(</font>LongInt<font color="#000080">(</font>UsedSize<font color="#000080">)-</font>LongInt<font color="#000080">(</font>Ofs<font color="#000080">));
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ case }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ TXmsStream.SetPos }

</i></font><font color="#FF0000"><b>procedure </b></font>SaveStream<font color="#000080">;
</font><font color="#008000"><i>{
  Saves the stream to disk. No errorchecking is done
}
</i></font><font color="#FF0000"><b>var
  </b></font>Buf<font color="#000080">: </font>pointer<font color="#000080">;
  </font>x<font color="#000080">, </font>BufSize<font color="#000080">: </font>word<font color="#000080">;
  </font>f<font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>OldPos<font color="#000080">, </font>l<font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>f<font color="#000080">, </font>FileName<font color="#000080">);
  </font>Rewrite<font color="#000080">(</font>f<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>S<font color="#000080">.</font>GetSize<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>Close<font color="#000080">(</font>f<font color="#000080">);
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
  </i></font><font color="#FF0000"><b>if </b></font>MaxAvail<font color="#000080">&gt;</font><font color="#800000">65520 </font><font color="#FF0000"><b>then </b></font>BufSize<font color="#000080">:=</font><font color="#800000">65520 </font><font color="#FF0000"><b>else </b></font>BufSize<font color="#000080">:=</font>MaxAvail<font color="#000080">;
  </font>GetMem<font color="#000080">(</font>Buf<font color="#000080">, </font>BufSize<font color="#000080">);
  </font>OldPos<font color="#000080">:=</font>S<font color="#000080">.</font>GetPos<font color="#000080">;
  </font>l<font color="#000080">:=</font>S<font color="#000080">.</font>GetSize<font color="#000080">;
  </font>S<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>while </b></font>l<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    if </b></font>l<font color="#000080">&gt;</font>BufSize <font color="#FF0000"><b>then </b></font>x<font color="#000080">:=</font>BufSize <font color="#FF0000"><b>else </b></font>x<font color="#000080">:=</font>l<font color="#000080">;
    </font>S<font color="#000080">.</font>Read<font color="#000080">(</font>Buf<font color="#000080">^, </font>x<font color="#000080">);
</font><font color="#008000"><i>{$IFDEF OPRO}
    </i></font><font color="#FF0000"><b>if </b></font>S<font color="#000080">.</font>PeekStatus<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
    </i></font><font color="#FF0000"><b>if </b></font>S<font color="#000080">.</font>Status<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
    </i></font><font color="#FF0000"><b>begin
      </b></font>Close<font color="#000080">(</font>f<font color="#000080">);
      </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
    </i></font>BlockWrite<font color="#000080">(</font>f<font color="#000080">, </font>Buf<font color="#000080">^, </font>x<font color="#000080">);
    </font>Dec<font color="#000080">(</font>l<font color="#000080">, </font>x<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ while }
  </i></font>Close<font color="#000080">(</font>f<font color="#000080">);
  </font>FreeMem<font color="#000080">(</font>Buf<font color="#000080">, </font>BufSize<font color="#000080">);
  </font>S<font color="#000080">.</font>Seek<font color="#000080">(</font>OldPos<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ SaveStream }

</i></font><font color="#FF0000"><b>procedure </b></font>LoadStream<font color="#000080">;
</font><font color="#008000"><i>{
  Loads the stream from disk. No errorchecking is done, you must allocate
  enough memory yourself! Any old contents of the stream is erased.
}
</i></font><font color="#FF0000"><b>var
  </b></font>f<font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
  </font>BufSize<font color="#000080">, </font>x<font color="#000080">: </font>word<font color="#000080">;
  </font>l<font color="#000080">: </font>longint<font color="#000080">;
  </font>Buf<font color="#000080">: </font>pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not </b></font>ExistFile<font color="#000080">(</font>FileName<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font>Assign<font color="#000080">(</font>f<font color="#000080">, </font>FileName<font color="#000080">);
  </font>Reset<font color="#000080">(</font>f<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>S<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font>S<font color="#000080">.</font>Truncate<font color="#000080">;
  </font>l<font color="#000080">:=</font>FileSize<font color="#000080">(</font>f<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>l<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    if </b></font>MaxAvail<font color="#000080">&gt;</font><font color="#800000">65520 </font><font color="#FF0000"><b>then </b></font>BufSize<font color="#000080">:=</font><font color="#800000">65520 </font><font color="#FF0000"><b>else </b></font>BufSize<font color="#000080">:=</font>MaxAvail<font color="#000080">;
    </font>GetMem<font color="#000080">(</font>Buf<font color="#000080">, </font>BufSize<font color="#000080">);
    </font><font color="#FF0000"><b>while </b></font>l<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>do
    begin
      </b></font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>Buf<font color="#000080">^, </font>BufSize<font color="#000080">, </font>x<font color="#000080">);
      </font>S<font color="#000080">.</font>Write<font color="#000080">(</font>Buf<font color="#000080">^, </font>x<font color="#000080">);
</font><font color="#008000"><i>{$IFDEF OPRO}
      </i></font><font color="#FF0000"><b>if </b></font>S<font color="#000080">.</font>PeekStatus<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ELSE}
      </i></font><font color="#FF0000"><b>if </b></font>S<font color="#000080">.</font>Status<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font><font color="#008000"><i>{$ENDIF}
      </i></font><font color="#FF0000"><b>begin
        </b></font>Close<font color="#000080">(</font>f<font color="#000080">);
        </font>Exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
      </i></font>Dec<font color="#000080">(</font>l<font color="#000080">, </font>x<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ while }
    </i></font>FreeMem<font color="#000080">(</font>Buf<font color="#000080">, </font>BufSize<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if }
  </i></font>Close<font color="#000080">(</font>f<font color="#000080">);
  </font>S<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ LoadStream }

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p></body>
</html>
