<html>
<head><title> "Stack Swapping" by BOB SWART</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0045.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Also, can you tell me what the opro procedure SwapStackAndCallNear()
&gt; does?  Does it save registers, swap SP and do a near call, or what?

From the description DJ gave, I reconstructed it for you:
}

</i></font><font color="#FF0000"><b>procedure </b></font>SwapStackAndCallNear<font color="#000080">(</font>Routine<font color="#000080">: </font>Word<font color="#000080">;
                               </font>SP<font color="#000080">: </font>Pointer<font color="#000080">;
                               </font><font color="#FF0000"><b>var </b></font>Regs<font color="#000080">);
</font><font color="#008000"><i>{
  Flags are saved (unchanged during routine),
  Stack is restored after completion,
  Registers AX,BX,CX,DX,SI,DI and ES destroyed.
}
</i></font><font color="#FF0000"><b>InLine</b></font><font color="#000080">(
  </font><font color="#800000">$9C</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSHF                              }
  </i></font><font color="#800000">$07</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   ES    ; ES := flags          }
  </i></font><font color="#800000">$58</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   AX    ; AX := Regs ofs       }
  </i></font><font color="#800000">$5B</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   BX    ; BX := Regs seg       }
  </i></font><font color="#800000">$59</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   CX    ; CX := SP ofs         }
  </i></font><font color="#800000">$5A</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   DX    ; DX := SP seg         }
  </i></font><font color="#800000">$5F</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   DI    ; DI := near routine   }
           { @SwapStack                              }
  </i></font><font color="#800000">$8C</font><font color="#000080">/</font><font color="#800000">$D6</font><font color="#000080">/ </font><font color="#008000"><i>{      mov   SI,SS ; SI := SS = stack seg }
  </i></font><font color="#800000">$FA</font><font color="#000080">/     </font><font color="#008000"><i>{      cli         ; disable interrupts   }
  </i></font><font color="#800000">$8E</font><font color="#000080">/</font><font color="#800000">$D2</font><font color="#000080">/ </font><font color="#008000"><i>{      mov   SS,DX ; SS := DX = SP seg    }
  </i></font><font color="#800000">$87</font><font color="#000080">/</font><font color="#800000">$CC</font><font color="#000080">/ </font><font color="#008000"><i>{      xchg  SP,CX ; CX := SP = stack ofs }
           {                  ; SP := SP = SP ofs    }
  </i></font><font color="#800000">$06</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSH  ES    ; push ES (= flags)    }
  </i></font><font color="#800000">$9D</font><font color="#000080">/     </font><font color="#008000"><i>{      POPF        ; set flags again      }
  </i></font><font color="#800000">$9C</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSHF       ; push flags           }
  </i></font><font color="#800000">$56</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSH  SI    ; SI = old stackseg SS }
  </i></font><font color="#800000">$51</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSH  CX    ; CX = old stackofs SP }
           { @CallNear:                              }
  </i></font><font color="#800000">$53</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSH  BX    ; BX = ofs Regs var    }
  </i></font><font color="#800000">$50</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSH  AX    ; AX = seg Regs var    }
  </i></font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$15</font><font color="#000080">/ </font><font color="#008000"><i>{      CALL  WORD PTR [DI]  ; near call   }
           { @SwapBackStack:                         }
  </i></font><font color="#800000">$FA</font><font color="#000080">/     </font><font color="#008000"><i>{      CLI         ; disable interrupts   }
  </i></font><font color="#800000">$59</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   CX    ; CX := old stackofs SP}
  </i></font><font color="#800000">$5E</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   SI    ; SI := old stackseg SS}
  </i></font><font color="#800000">$07</font><font color="#000080">/     </font><font color="#008000"><i>{      pop   ES    ; pop flags in ES      }
  </i></font><font color="#800000">$8E</font><font color="#000080">/</font><font color="#800000">$D6</font><font color="#000080">/ </font><font color="#008000"><i>{      mov   SS,SI ; stack seg back in SS }
  </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$CC</font><font color="#000080">/ </font><font color="#008000"><i>{      mov   SP,CX ; stack ofs back in SP }
           { @Exit:                                  }
  </i></font><font color="#800000">$06</font><font color="#000080">/     </font><font color="#008000"><i>{      PUSH  ES    ; push values of flags }
  </i></font><font color="#800000">$9D</font><font color="#000080">);    </font><font color="#008000"><i>{      POPF        ; pop unchanged flags  }

{
&gt; I would like to write my own code to do this because I don't have
&gt; opro, and I'm not going to buy it for one procedure... :)
Please test my InLine macro, and tell me if this works. Sometime soon I'll
try to experiment with PAUSEDEV myself (if I can find it again, that is ;-)
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0045.PAS">Original</a><b>]</b></p></body>
</html>
