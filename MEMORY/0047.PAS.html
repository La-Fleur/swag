<html>
<head><title> "XMS Memory routines" by GREG ESTABROOKS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>UNIT </b></font>XMS<font color="#000080">;               </font><font color="#008000"><i>{  XMS Routines, Last Updated Dec 11/93        }
                        {  Copyright (C) 1993, Greg Estabrooks         }
                        {  NOTE: Requires TP 6.0+ To compile.          }
</i></font><font color="#FF0000"><b>INTERFACE
</b></font><font color="#008000"><i>{**********************************************************************}
</i></font><font color="#FF0000"><b>TYPE
    </b></font>_32Bit <font color="#000080">= </font>LONGINT<font color="#000080">;
    </font>XMSMovStruct <font color="#000080">= </font><font color="#FF0000"><b>RECORD
                    </b></font>Amount      <font color="#000080">:</font>_32Bit<font color="#000080">;  </font><font color="#008000"><i>{ 32 bit number of bytes to move}
                    </i></font>SourceHandle<font color="#000080">:</font>WORD<font color="#000080">;    </font><font color="#008000"><i>{ Handle of Source Block.     }
                    </i></font>SourceOffset<font color="#000080">:</font>_32Bit<font color="#000080">;  </font><font color="#008000"><i>{ 32 bit offset to source.    }
                    </i></font>DestHandle  <font color="#000080">:</font>WORD<font color="#000080">;    </font><font color="#008000"><i>{ Handle of destination.      }
                    </i></font>DestOffset  <font color="#000080">:</font>_32Bit<font color="#000080">;  </font><font color="#008000"><i>{ 32 bit offset to destination}
                   </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
                                </font><font color="#008000"><i>{ If SourceHandle is 0 then SourceOffset}
                                { Is Interpereted as a SEGMENT:OFFSET   }
                                { into conventional memory.             }
                                { The Same applies to DestHandle.       }
{ Potential XMS Error Codes:                                            }
{   BL=80h if the function is not implemented                           }
{      81h if a VDISK device is detected                                }
{      82h if an A20 error occurs                                       }
{      8Eh if a general driver error occurs                             }
{      8Fh if an unrecoverable driver error occurs                      }
{      90h if the HMA does not exist                                    }
{      91h if the HMA is already in use                                 }
{      92h if DX is less than the /HMAMIN= parameter                    }
{      93h if the HMA is not allocated                                  }
{      94h if the A20 line is still enabled                             }
{      A0h if all extended memory is allocated                          }
{      A1h if all available extended memory handles are in use          }
{      A2h if the handle is invalid                                     }
{      A3h if the SourceHandle is invalid                               }
{      A4h if the SourceOffset is invalid                               }
{      A5h if the DestHandle is invalid                                 }
{      A6h if the DestOffset is invalid                                 }
{      A7h if the Length is invalid                                     }
{      A8h if the move has an invalid overlap                           }
{      A9h if a parity error occurs                                     }
{      AAh if the block is not locked                                   }
{      ABh if the block is locked                                       }
{      ACh if the block's lock count overflows                          }
{      ADh if the lock fails                                            }
{      B0h if a smaller UMB is available                                }
{      B1h if no UMBs are available                                     }
{      B2h if the UMB segment number is invalid                         }

</i></font><font color="#FF0000"><b>VAR
        </b></font>XMSControl <font color="#000080">:</font>POINTER<font color="#000080">;    </font><font color="#008000"><i>{ Holds the address of the XMS API.     }
        </i></font>XMSError   <font color="#000080">:</font>BYTE<font color="#000080">;       </font><font color="#008000"><i>{ Holds any XMS error codes.            }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSDriver <font color="#000080">:</font>BOOLEAN<font color="#000080">;
                </font><font color="#008000"><i>{  Routine to determine if an XMS driver is installed.  }
                {  If it is installed it loads XMSControl with the      }
                {  location of the XMS API for the other routines.      }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSControlAdr <font color="#000080">:</font>POINTER<font color="#000080">;
                </font><font color="#008000"><i>{  This Routine returns a pointer to the XMS Controller.}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSVer <font color="#000080">:</font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{  This routine returns the version of the XMS driver   }
                {  that is currently installed.                         }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSRev <font color="#000080">:</font>WORD<font color="#000080">;
                </font><font color="#008000"><i>{ Returns XMS Revision Number. Usually used with XMSVer.}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSGetFreeMem <font color="#000080">:</font>WORD<font color="#000080">;
                   </font><font color="#008000"><i>{  Routine to Determine how much total XMS memory is }
                   {  free.                                             }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSGetLargeBlock <font color="#000080">:</font>WORD<font color="#000080">;
                   </font><font color="#008000"><i>{  Routine to Determine the size of the largest free }
                   {  XMS is block.                                     }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSGetMem<font color="#000080">( </font>Blocks<font color="#000080">:</font>WORD <font color="#000080">) :</font>WORD<font color="#000080">;
                    </font><font color="#008000"><i>{  Routine to allocate XMS for program use.         }
                    {  Blocks = k's being requested, XMSErr = ErrorCode.}
                    {  Returns 16 bit handle to mem allocated.          }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSFreeMem<font color="#000080">( </font>Handle<font color="#000080">:</font>WORD <font color="#000080">);
                    </font><font color="#008000"><i>{  Routine to free previously allocated XMS Memory. }
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSMoveblock<font color="#000080">( </font><font color="#FF0000"><b>VAR </b></font>Movstruct <font color="#000080">:</font>XMSMovStruct <font color="#000080">);
                    </font><font color="#008000"><i>{  Routine to move memory blocks around in XMS memory.}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSLockBlock<font color="#000080">( </font>Handle <font color="#000080">:</font>WORD <font color="#000080">);
                        </font><font color="#008000"><i>{ Routine to lock and XMS block. Locked blocks  }
                        { are guarnteed not to move.                    }
                        { Locked Blocks should be unlocked as soon as   }
                        { possible.                                     }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSUnLockBlock<font color="#000080">( </font>Handle <font color="#000080">:</font>WORD <font color="#000080">);
                        </font><font color="#008000"><i>{ Routine to unlock a previously lock XMS block.}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSReallocate<font color="#000080">( </font>Handle <font color="#000080">,</font>NewSize <font color="#000080">:</font>WORD <font color="#000080">);
                        </font><font color="#008000"><i>{ Routine to reallocate and XMS Block so that it}
                        { becomes equal to NewSize.                     }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>HMAExists <font color="#000080">:</font>BOOLEAN<font color="#000080">;
                </font><font color="#008000"><i>{  This routine returns Whether or not HMA Exists.      }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>HMARequest<font color="#000080">( </font>RequestType <font color="#000080">:</font>WORD <font color="#000080">);
                   </font><font color="#008000"><i>{ Attempt to reserve the 64k HMA area for the caller.}
                   { NOTE: RequestType must be either FFFF = Application}
                   { OR If caller is a TSR the RequestType = Amount of  }
                   { Space wanted.                                      }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>HMARelease<font color="#000080">;
                      </font><font color="#008000"><i>{ Routine to release previously allocated HMA.    }
                      { NOTE: Any Code/Data store in that HMA Memory    }
                      { Will become invalid and inaccessible.           }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>GlobaleEnableA20<font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to Enable the A20 Line. Should only be   }
                     { used by programs that have control of the HMA.   }
                     { NOTE: Remeber to disable the Line before         }
                     {       releaseing control of the system.          }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>GlobaleDisableA20<font color="#000080">;
                      </font><font color="#008000"><i>{ Routine to Disable the A20 Line. On some systems}
                      { the Toggling of the A20 Line can take a long    }
                      { time.                                           }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>LocalEnableA20<font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to Enable the A20 Line for current Program}
                     { NOTE: Rember to so a LocalDisableA20 before      }
                     {       releasing system control.                  }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>LocalDisableA20<font color="#000080">;
                      </font><font color="#008000"><i>{ Routine to Locally Disable the A20 Line.        }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>QueryA20 <font color="#000080">:</font>BOOLEAN<font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to test whether the A20 is Physically    }
                     { enabled or not.                                  }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>PtrToLong<font color="#000080">( </font>P<font color="#000080">:</font>POINTER <font color="#000080">) :</font>LONGINT<font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to convert a pointer to a 32 bit number. }

</i></font><font color="#FF0000"><b>IMPLEMENTATION
</b></font><font color="#008000"><i>{**********************************************************************}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSDriver <font color="#000080">:</font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                </font><font color="#008000"><i>{  Routine to determine if an XMS driver is installed.  }
                {  If it is installed it loads XMSControl with the      }
                {  location of the XMS API for the other routines.      }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Mov AX,$4300                  </font><font color="#008000"><i>{  Function to check for Driver.        }
  </i></font><font color="#FF00FF">Int $2F                       </font><font color="#008000"><i>{  Call Dos Int 2Fh.                    }
  </i></font><font color="#FF00FF">Cmp AL,$80                    </font><font color="#008000"><i>{  Check Result, if its 80h driver.     }
  </i></font><font color="#FF00FF">Je @Installed                 </font><font color="#008000"><i>{  If It is return TRUE.                }
  </i></font><font color="#FF00FF">Mov AL,0                      </font><font color="#008000"><i>{  Else Return FALSE.                   }
  </i></font><font color="#FF00FF">Jmp @Exit
@Installed:
  Mov AX,$4310                  </font><font color="#008000"><i>{  Function to return pointer to Driver.}
  </i></font><font color="#FF00FF">Int $2F                       </font><font color="#008000"><i>{  Call Interrupt.                      }
  </i></font><font color="#FF00FF">Mov XMSControl.WORD,BX        </font><font color="#008000"><i>{  Pointer info returned in ES:BX.      }
  </i></font><font color="#FF00FF">Mov XMSControl+2.WORD,ES
  Mov AL,1                      </font><font color="#008000"><i>{  Set True Flag.                       }
</i></font><font color="#FF00FF">@Exit:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSDriver}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSControlAdr <font color="#000080">:</font>POINTER<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                </font><font color="#008000"><i>{  This Routine returns a pointer to the XMS Controller.}
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push ES                       </font><font color="#008000"><i>{  Push ES onto the stack.              }
  </i></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{  Push BX onto the stack.              }
  </i></font><font color="#FF00FF">Mov AX,$4310                  </font><font color="#008000"><i>{  Function to return pointer to Driver.}
  </i></font><font color="#FF00FF">Int $2F                       </font><font color="#008000"><i>{  Call Interrupt.                      }
  </i></font><font color="#FF00FF">Mov DX,ES                     </font><font color="#008000"><i>{  Pointer info returned in ES:BX so    }
  </i></font><font color="#FF00FF">Mov AX,BX                     </font><font color="#008000"><i>{  move it into DX:AX.                  }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Pop BX Off the Stack.                }
  </i></font><font color="#FF00FF">Pop ES                        </font><font color="#008000"><i>{  Pop ES Off the Stack.                }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSControlAdr}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSVer <font color="#000080">:</font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                </font><font color="#008000"><i>{  This routine returns the version of the xms driver   }
                {  that is currently installed.Version is returned as a }
                {  16 bit BCD number.                                   }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Mov AH,0                      </font><font color="#008000"><i>{  Function to return XMS version.      }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api.                        }
                   {  Possible returns are :                            }
                   {  AX = XMS version , BX = driver revision number    }
                   {  DX = 1 if HMA exists, 0 if not.                   }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSVer}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSRev <font color="#000080">:</font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                </font><font color="#008000"><i>{ Returns XMS Revision Number. Usually used with XMSVer.}
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{  Save BX.                             }
  </i></font><font color="#FF00FF">Mov AH,0                      </font><font color="#008000"><i>{  Function to return XMS revision.     }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api.                        }
  </i></font><font color="#FF00FF">Mov AX,BX                     </font><font color="#008000"><i>{  Move result into proper register.    }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX.                          }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSRev}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSGetFreeMem <font color="#000080">:</font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                   </font><font color="#008000"><i>{  Routine to Determine how much total XMS memory is }
                   {  free.                                             }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX and BX.                      }
  </i></font><font color="#FF00FF">Push BX
  Mov XMSError,0                </font><font color="#008000"><i>{  Clear error flag.                    }
  </i></font><font color="#FF00FF">Mov AH,$08                    </font><font color="#008000"><i>{  Function to get free XMS mem         }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Return any error code to user.       }
  </i></font><font color="#FF00FF">Mov AX,DX                     </font><font color="#008000"><i>{  Load AX with Total Free k'S          }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX and DX.                   }
  </i></font><font color="#FF00FF">Pop DX
                   </font><font color="#008000"><i>{  DX = Total Free in k's                            }
                   {  AX = Largest free block in k's                    }
                   {  BL = Err Code.                                    }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSGetFreeMem}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSGetLargeBlock <font color="#000080">:</font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                   </font><font color="#008000"><i>{  Routine to Determine the size of the largest free }
                   {  XMS is block.                                     }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{  Save BX.                             }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{  Clear error flag.                    }
  </i></font><font color="#FF00FF">Mov AH,$08                    </font><font color="#008000"><i>{  Function to get free XMS mem         }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Return any error code to user.       }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX.                          }
                   {  DX = Total Free in k's                            }
                   {  AX = Largest free block in k's                    }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSGetLargeBlock}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>XMSGetMem<font color="#000080">( </font>Blocks<font color="#000080">:</font>WORD <font color="#000080">) :</font>WORD<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                    </font><font color="#008000"><i>{  Routine to allocate XMS for programs use         }
                    {  Blocks = k's being requested, XMSErr = ErrorCode }
                    {  Returns 16 bit handle to mem allocated           }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX and BX.                      }
  </i></font><font color="#FF00FF">Push BX
  Mov XMSError,0                </font><font color="#008000"><i>{  Clear error flag.                    }
  </i></font><font color="#FF00FF">Mov AH,9                      </font><font color="#008000"><i>{  Function Allocate Extended Memory    }
  </i></font><font color="#FF00FF">Mov DX,Blocks                 </font><font color="#008000"><i>{  Load k Blocks to be allocated        }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS API                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Return any error code to user.       }
  </i></font><font color="#FF00FF">Mov AX,DX                     </font><font color="#008000"><i>{  Load 16 Bit Handle to allocated Mem  }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX and DX.                   }
  </i></font><font color="#FF00FF">Pop DX
         </font><font color="#008000"><i>{NOTE: If there was an Error then the handle is invalid. }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSGetMem}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSFreeMem<font color="#000080">( </font>Handle<font color="#000080">:</font>WORD <font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                    </font><font color="#008000"><i>{  Routine to free previously allocated XMS Memory  }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX and BX.                      }
  </i></font><font color="#FF00FF">Push BX
  Mov XMSError,0                </font><font color="#008000"><i>{  Clear error flag.                    }
  </i></font><font color="#FF00FF">Mov AH,$0A                    </font><font color="#008000"><i>{  Function Free Allocated Memory       }
  </i></font><font color="#FF00FF">Mov DX,Handle                 </font><font color="#008000"><i>{  Load Handle of Memory to free        }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call API                             }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Return any error code to user.       }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX and DX.                   }
  </i></font><font color="#FF00FF">Pop DX
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSFreeMem}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSMoveblock<font color="#000080">( </font><font color="#FF0000"><b>VAR </b></font>Movstruct <font color="#000080">:</font>XMSMovStruct <font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
         </font><font color="#008000"><i>{  Routine to move memory blocks around in XMS memory.         }
         {  Length must be even.                                        }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DS                       </font><font color="#008000"><i>{  Save DS and SI                       }
  </i></font><font color="#FF00FF">Push SI
  Push BX
  Mov XMSError,0                </font><font color="#008000"><i>{  Clear error flag.                    }
  </i></font><font color="#FF00FF">LDS SI,MovStruct              </font><font color="#008000"><i>{  Point DS:SI to move Structure        }
  </i></font><font color="#FF00FF">Mov AH,$0B                    </font><font color="#008000"><i>{  Function to Move Extended memory block}
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS API                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Save any error code for user.        }
  </i></font><font color="#FF00FF">Pop BX
  Pop SI                        </font><font color="#008000"><i>{  Restore DS and SI                    }
  </i></font><font color="#FF00FF">Pop DS
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSMoveBlock}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSLockBlock<font color="#000080">( </font>Handle <font color="#000080">:</font>WORD <font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                        </font><font color="#008000"><i>{ Routine to lock and XMS block. Locked blocks  }
                        { are guarnteed not to move.                    }
                        { Locked Blocks should be unlocked as soon as   }
                        { possible.                                     }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX and BX.                      }
  </i></font><font color="#FF00FF">Push BX
  Mov XMSError,0                </font><font color="#008000"><i>{  Clear Error Flag.                    }
  </i></font><font color="#FF00FF">Mov AH,$0C                    </font><font color="#008000"><i>{  Function to lock XMS Block.          }
  </i></font><font color="#FF00FF">Mov DX,Handle                 </font><font color="#008000"><i>{  Handle of block to lock.             }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api.                        }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Save any error codes.                }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX and DX.                   }
  </i></font><font color="#FF00FF">Pop DX
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSLockBlock}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSUnLockBlock<font color="#000080">( </font>Handle <font color="#000080">:</font>WORD <font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                        </font><font color="#008000"><i>{ Routine to unlock a previously lock XMS block.}
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX and BX.                      }
  </i></font><font color="#FF00FF">Push BX
  Mov XMSError,0                </font><font color="#008000"><i>{  Clear Error Flag.                    }
  </i></font><font color="#FF00FF">Mov AH,$0D                    </font><font color="#008000"><i>{  Function to unlock XMS Block.        }
  </i></font><font color="#FF00FF">Mov DX,Handle                 </font><font color="#008000"><i>{  Handle of block to unlock.           }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api.                        }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Save any error codes.                }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX and DX.                   }
  </i></font><font color="#FF00FF">Pop DX
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSUnLockBlock}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>XMSReallocate<font color="#000080">( </font>Handle <font color="#000080">,</font>NewSize <font color="#000080">:</font>WORD <font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                        </font><font color="#008000"><i>{ Routine to reallocate and XMS Block so that it}
                        { becomes equal to NewSize.                     }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX and BX.                      }
  </i></font><font color="#FF00FF">Push BX
  Mov XMSError,0                </font><font color="#008000"><i>{  Clear Error Flag.                    }
  </i></font><font color="#FF00FF">Mov BX,NewSize                </font><font color="#008000"><i>{  Load New size of XMS Block.          }
  </i></font><font color="#FF00FF">Mov DX,Handle                 </font><font color="#008000"><i>{  Handle of an unlocked XMS Block.     }
  </i></font><font color="#FF00FF">Mov AH,$0F                    </font><font color="#008000"><i>{  Function to Reallocate XMS Block.    }
  </i></font><font color="#FF00FF">Mov DX,Handle                 </font><font color="#008000"><i>{  Handle of block to lock.             }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api.                        }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Save any error codes.                }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{  Restore BX and DX.                   }
  </i></font><font color="#FF00FF">Pop DX
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{XMSReallocate}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>HMAExists <font color="#000080">:</font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                </font><font color="#008000"><i>{  This routine returns Whether or not HMA Exists       }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX.                             }
  </i></font><font color="#FF00FF">Mov AH,0                      </font><font color="#008000"><i>{  Function to return HMA Status        }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS Api                         }
  </i></font><font color="#FF00FF">Mov AL,DL                     </font><font color="#008000"><i>{  Mov Status into proper register      }
  </i></font><font color="#FF00FF">Pop DX                        </font><font color="#008000"><i>{  Restore DX.                          }
                   {  Possible returns are :                            }
                   {  AX = XMS version , BX = driver revision number    }
                   {  DX = 1 if HMA exists, 0 if not                    }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{HMAExists}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>HMARequest<font color="#000080">( </font>RequestType <font color="#000080">:</font>WORD <font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                   </font><font color="#008000"><i>{ Attempt to reserve the 64k HMA area for the caller.}
                   { NOTE: RequestType must be either FFFF = Application}
                   { OR If caller is a TSR the RequestType = Amount of  }
                   { Space wanted.                                      }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX.                             }
  </i></font><font color="#FF00FF">Push BX
  Mov AH,1                      </font><font color="#008000"><i>{  Function to request HMA.             }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{  Clear error flag.                    }
  </i></font><font color="#FF00FF">Mov DX,RequestType            </font><font color="#008000"><i>{  Load whether area is for an App or TSR.}
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS API                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Return any error code to user.       }
  </i></font><font color="#FF00FF">Pop Bx
  Pop DX                        </font><font color="#008000"><i>{  Restore DX.                          }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{HMARequest}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>HMARelease<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                      </font><font color="#008000"><i>{ Routine to release previously allocated HMA.    }
                      { NOTE: Any Code/Data store in that HMA Memory    }
                      { Will become invalid and inaccessible.           }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push DX                       </font><font color="#008000"><i>{  Save DX.                             }
  </i></font><font color="#FF00FF">Mov AH,2                      </font><font color="#008000"><i>{  Function to release HMA.             }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{  Clear error flag.                    }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{  Call XMS API                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{  Return any error code to user.       }
  </i></font><font color="#FF00FF">Pop DX                        </font><font color="#008000"><i>{  Restore DX.                          }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{HMARelease}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>GlobaleEnableA20<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to Enable the A20 Line. Should only be   }
                     { used by programs that have control of the HMA.   }
                     { NOTE: Remeber to disable the Line before         }
                     {       releaseing control of the system.          }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{ Push BX onto the Stack.               }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{ Clear Error flag.                     }
  </i></font><font color="#FF00FF">Mov AH,3                      </font><font color="#008000"><i>{ Function to Enable A20 line.          }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{ Call XMS Api.                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{ Save any errors.                      }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{ Pop BX Off the Stack.                 }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{GlobalEnableA20}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>GlobaleDisableA20<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                      </font><font color="#008000"><i>{ Routine to Disable the A20 Line. On some systems}
                      { the Toggling of the A20 Line can take a long    }
                      { time.                                           }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{ Push BX onto the Stack.               }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{ Clear Error flag.                     }
  </i></font><font color="#FF00FF">Mov AH,4                      </font><font color="#008000"><i>{ Function to Disable A20 line.         }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{ Call XMS Api.                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{ Save any errors.                      }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{ Pop BX Off the Stack.                 }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{GlobalDisableA20}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>LocalEnableA20<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to Enable the A20 Line for current Program}
                     { NOTE: Rember to so a LocalDisableA20 before      }
                     {       releasing system control.                  }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{ Push BX onto the Stack.               }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{ Clear Error flag.                     }
  </i></font><font color="#FF00FF">Mov AH,5                      </font><font color="#008000"><i>{ Function to Enable A20 line.          }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{ Call XMS Api.                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{ Save any errors.                      }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{ Pop BX Off the Stack.                 }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{LocalEnableA20}

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>LocalDisableA20<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                      </font><font color="#008000"><i>{ Routine to Locally Disable the A20 Line.        }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{ Push BX onto the Stack.               }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{ Clear Error flag.                     }
  </i></font><font color="#FF00FF">Mov AH,6                      </font><font color="#008000"><i>{ Function to Disable A20 line.         }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{ Call XMS Api.                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{ Save any errors.                      }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{ Pop BX Off the Stack.                 }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{LocalDisableA20}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>QueryA20 <font color="#000080">:</font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to test whether the A20 is Physically    }
                     { enabled or not.                                  }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Push BX                       </font><font color="#008000"><i>{ Push BX onto the Stack.               }
  </i></font><font color="#FF00FF">Mov XMSError,0                </font><font color="#008000"><i>{ Clear Error flag.                     }
  </i></font><font color="#FF00FF">Mov AH,7                      </font><font color="#008000"><i>{ Function to test the A20 line.        }
  </i></font><font color="#FF00FF">Call [XMSControl]             </font><font color="#008000"><i>{ Call XMS Api.                         }
  </i></font><font color="#FF00FF">Mov XMSError,BL               </font><font color="#008000"><i>{ Save any errors.                      }
  </i></font><font color="#FF00FF">Pop BX                        </font><font color="#008000"><i>{ Pop BX Off the Stack.                 }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{QueryA20}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>PtrToLong<font color="#000080">( </font>P<font color="#000080">:</font>POINTER <font color="#000080">) :</font>LONGINT<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
                     </font><font color="#008000"><i>{ Routine to convert a pointer to a 32 bit number. }
</i></font><font color="#FF0000"><b>ASM
  </b></font><font color="#FF00FF">Mov AX,P.WORD[0]                 </font><font color="#008000"><i>{ Load low WORD into AX.             }
  </i></font><font color="#FF00FF">Mov DX,P.WORD[2]                 </font><font color="#008000"><i>{ Load high WORD into DX.            }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{PtrToLong}

</i></font><font color="#FF0000"><b>BEGIN
END</b></font><font color="#000080">.

</font><font color="#008000"><i>{---------------------------- CUT HERE FOR DEMO -------------------}
{***********************************************************************}
</i></font><font color="#FF0000"><b>PROGRAM </b></font>XMSDemo1<font color="#000080">;            </font><font color="#008000"><i>{ Demonstration of the XMS Unit.           }
                             { Last Updated Dec 10/93, Greg Estabrooks. }
</i></font><font color="#FF0000"><b>USES </b></font>CRT<font color="#000080">,                    </font><font color="#008000"><i>{ IMPORT Clrscr,Writeln.                   }
     </i></font>XMS<font color="#000080">;                    </font><font color="#008000"><i>{ IMPORT XMSDriver,XMSVer,XMSGetFreeMem,   }
                             { XMSGetLargeBlock,XMSGetMem,XMSMove,      }
                             { XMSError,XMSMovStruct,XMSFreeMem.        }
</i></font><font color="#FF0000"><b>VAR
   </b></font>XMSHandle  <font color="#000080">:</font>WORD<font color="#000080">;            </font><font color="#008000"><i>{ Holds the handle of our XMS Area.     }
   </i></font>MovInf     <font color="#000080">:</font>XMSMovStruct<font color="#000080">;    </font><font color="#008000"><i>{ Move Structure for Moving XMS Blocks. }
</i></font><font color="#FF0000"><b>BEGIN
  </b></font>Clrscr<font color="#000080">;                       </font><font color="#008000"><i>{ Clear away any screen clutter.        }
  </i></font><font color="#FF0000"><b>IF </b></font>XMSDriver <font color="#FF0000"><b>THEN             </b></font><font color="#008000"><i>{ If XMS Driver installed do demo.      }
  </i></font><font color="#FF0000"><b>BEGIN
    </b></font>Write<font color="#000080">(</font><font color="#800000">'XMS Driver Version '</font><font color="#000080">);   </font><font color="#008000"><i>{ Show Version Installed.           }
    </i></font>Writeln<font color="#000080">(</font>HI<font color="#000080">(</font>XMSVer<font color="#000080">),</font><font color="#800000">'.'</font><font color="#000080">,</font>LO<font color="#000080">(</font>XMSVer<font color="#000080">),</font><font color="#800000">'.'</font><font color="#000080">,</font>XMSRev<font color="#000080">,</font><font color="#800000">' Installed'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Total Free XMS Memory : '</font><font color="#000080">,</font>XMSGetFreeMem<font color="#000080">,</font><font color="#800000">'k'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Largest Free XMS Block: '</font><font color="#000080">,</font>XMSGetLargeBlock<font color="#000080">,</font><font color="#800000">'k'</font><font color="#000080">);
    </font>Writeln<font color="#000080">;

    </font>Writeln<font color="#000080">(</font><font color="#800000">'Attempting to Allocate 16k of XMS'</font><font color="#000080">);
    </font>XMSHandle <font color="#000080">:= </font>XMSGetMem<font color="#000080">(</font><font color="#800000">16</font><font color="#000080">); </font><font color="#008000"><i>{ Attempt to allocate 16k of XMS.       }
    </i></font>Writeln<font color="#000080">(</font><font color="#800000">'ErrorCode Returned : '</font><font color="#000080">,</font>XMSError<font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Current free XMS Memory : '</font><font color="#000080">,</font>XMSGetFreeMem<font color="#000080">);
    </font>Writeln<font color="#000080">;

    </font>Writeln<font color="#000080">(</font><font color="#800000">'Saving Screen to XMS.'</font><font color="#000080">);
    </font><font color="#FF0000"><b>WITH </b></font>MovInf <font color="#FF0000"><b>DO
      BEGIN
        </b></font>Amount <font color="#000080">:= </font><font color="#800000">4000</font><font color="#000080">;         </font><font color="#008000"><i>{ Length of the Video Screen.           }
        </i></font>SourceHandle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;      </font><font color="#008000"><i>{ If SourceHandle is 0 then SourceOffset}
                                { Is Interpereted as a SEGMENT:OFFSET   }
                                { into conventional memory.             }
        </i></font>SourceOffset <font color="#000080">:= </font>PtrToLong<font color="#000080">(</font>Ptr<font color="#000080">(</font><font color="#800000">$B800</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">));
        </font>DestHandle <font color="#000080">:= </font>XMSHandle<font color="#000080">;</font><font color="#008000"><i>{ Destination is our XMS block.         }
        </i></font>DestOffset <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>XMSMoveBlock<font color="#000080">(</font>MovInf<font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Press &lt;ENTER&gt; to continue.'</font><font color="#000080">);
    </font>Readln<font color="#000080">;

    </font>Clrscr<font color="#000080">;
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Press &lt;ENTER&gt; to Restore Screen.'</font><font color="#000080">);
    </font>Readln<font color="#000080">;

    </font><font color="#FF0000"><b>WITH </b></font>MovInf <font color="#FF0000"><b>DO
      BEGIN
        </b></font>Amount <font color="#000080">:= </font><font color="#800000">4000</font><font color="#000080">;         </font><font color="#008000"><i>{ Length of the Video Screen.           }
        </i></font>SourceHandle <font color="#000080">:= </font>XMSHandle<font color="#000080">;
        </font>SourceOffset <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
        </font>DestHandle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
        </font>DestOffset <font color="#000080">:= </font>PtrToLong<font color="#000080">(</font>Ptr<font color="#000080">(</font><font color="#800000">$B800</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">));;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font>XMSMoveBlock<font color="#000080">(</font>MovInf<font color="#000080">);
    </font>GotoXY<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">11</font><font color="#000080">);
    </font>XMSFreeMem<font color="#000080">(</font>XMSHandle<font color="#000080">);      </font><font color="#008000"><i>{ Free allocate XMS.                    }
    </i></font>Writeln<font color="#000080">(</font><font color="#800000">'Ending Free XMS Memory : '</font><font color="#000080">,</font>XMSGetFreeMem<font color="#000080">,</font><font color="#800000">'k'</font><font color="#000080">);
  </font><font color="#FF0000"><b>END
  ELSE
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'XMS Driver not Installed!'</font><font color="#000080">,^</font>G<font color="#000080">);
  </font>Readln<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.</font><font color="#008000"><i>{XMSDemo1}
{***********************************************************************}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MEMORY SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p></body>
</html>
