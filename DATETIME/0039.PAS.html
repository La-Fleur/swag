<html>
<head><title> "Get Native DOS Date/Time" by WILBERT VAN LEIJEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DATETIME SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ COUNTRY.PAS -- Going native with Dos.  Do not use under DOS 2.xx.
  Written by Wilbert van Leijen and released into the Public Domain }

</i></font><font color="#FF0000"><b>Unit </b></font>Country<font color="#000080">;

</font><font color="#FF0000"><b>Interface
uses </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>DelimType    <font color="#000080">= </font><font color="#FF0000"><b>Record
                   </b></font>thousands<font color="#000080">,
                   </font>decimal<font color="#000080">,
                   </font>date<font color="#000080">,
                   </font>time        <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>CurrType     <font color="#000080">= (</font>leads<font color="#000080">,               </font><font color="#008000"><i>{ symbol precedes value }
                  </i></font>trails<font color="#000080">,              </font><font color="#008000"><i>{ value precedes symbol }
                  </i></font>leads_<font color="#000080">,              </font><font color="#008000"><i>{ symbol, space, value }
                  </i></font>_trails<font color="#000080">,             </font><font color="#008000"><i>{ value, space, symbol }
                  </i></font>replace<font color="#000080">);            </font><font color="#008000"><i>{ replaced }
  </i></font>CountryType  <font color="#000080">= </font><font color="#FF0000"><b>Record
                   </b></font>DateFormat  <font color="#000080">: </font>Word<font color="#000080">;       </font><font color="#008000"><i>{ 0: USA, 1: Europe, 2: Japan }
                   </i></font>CurrSymbol  <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
                   </font>Delimiter   <font color="#000080">: </font>DelimType<font color="#000080">;  </font><font color="#008000"><i>{ Separators }
                   </i></font>CurrFormat  <font color="#000080">: </font>CurrType<font color="#000080">;   </font><font color="#008000"><i>{ Way currency is formatted }
                   </i></font>CurrDigits  <font color="#000080">: </font>Byte<font color="#000080">;       </font><font color="#008000"><i>{ Digits in currency }
                   </i></font>Clock24hrs  <font color="#000080">: </font>Boolean<font color="#000080">;    </font><font color="#008000"><i>{ True if 24-hour clock }
                   </i></font>CaseMapCall <font color="#000080">: </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Lookup table for ASCII &ograve; $80 }
                   </i></font>DataListSep <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
                   </font>CountryCode <font color="#000080">: </font>Word<font color="#000080">;
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>UpCaseType   <font color="#000080">= </font><font color="#FF0000"><b>Function</b></font><font color="#000080">(</font>c <font color="#000080">: </font>Char<font color="#000080">) : </font>Char<font color="#000080">;
  </font>UpCaseStrType <font color="#000080">= </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>UpCase       <font color="#000080">: </font>UpCaseType<font color="#000080">;       </font><font color="#008000"><i>{ To be determined at runtime }
  </i></font>UpCaseStr    <font color="#000080">: </font>UpCaseStrType<font color="#000080">;
  </font>CountryOk    <font color="#000080">: </font>Boolean<font color="#000080">;          </font><font color="#008000"><i>{ Could determine country code flag }
  </i></font>CountryRec   <font color="#000080">: </font>CountryType<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>GetSysTime<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Today <font color="#000080">: </font>DateTime<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>SetSysTime<font color="#000080">(</font>Today <font color="#000080">: </font>DateTime<font color="#000080">);

</font><font color="#FF0000"><b>Function </b></font>DateString<font color="#000080">(</font>FileStamp <font color="#000080">: </font>DateTime<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>TimeString<font color="#000080">(</font>FileStamp <font color="#000080">: </font>DateTime<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Implementation

</b></font><font color="#008000"><i>{$R-,S-,V- }

{ Country dependent character capitalisation for DOS 3 }

</i></font><font color="#FF0000"><b>Function </b></font>UpCase3<font color="#000080">(</font>c <font color="#000080">: </font>Char<font color="#000080">) : </font>Char<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">MOV    AL, c
        CMP    AL, 'a'
        JB     @2
        CMP    AL, 'z'
        JA     @1
        AND    AL, 11011111b
        JMP    @2
@1:     CMP    AL, 80h
        JB     @2
        CALL   [CountryRec.CaseMapCall]
@2:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ UpCase3 }

{ Country dependent string capitalisation for DOS 3 }

</i></font><font color="#FF0000"><b>Procedure </b></font>UpCaseStr3<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">CLD
        LES    DI, s
        XOR    AX, AX
        MOV    AL, ES:[DI]
        STOSB
        XCHG   AX, CX
        JCXZ   @4

@1:     MOV    AL, ES:[DI]
        CMP    AL, 'a'
        JB     @3
        CMP    AL, 'z'
        JA     @2
        AND    AL, 11011111b
        JMP    @3
@2:     CMP    AL, 80h
        JB     @3
        CALL   [CountryRec.CaseMapCall]
@3:     STOSB
        LOOP   @1
@4:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ UpCaseStr3 }

{ Country dependent character capitalisation for DOS 4+ }

</i></font><font color="#FF0000"><b>Function </b></font>UpCase4<font color="#000080">(</font>c <font color="#000080">: </font>Char<font color="#000080">) : </font>Char<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">MOV    DL, c
        MOV    AX, 6520h
        INT    21h
        MOV    AL, DL
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ UpCase4 }

{ Country dependent string capitalisation for DOS 4+ }

</i></font><font color="#FF0000"><b>Procedure </b></font>UpCaseStr4<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">PUSH   DS
        CLD
        XOR    AX, AX
        LDS    SI, s
        LODSB
        XCHG   AX, CX
        JCXZ   @1

        MOV    DX, SI
        MOV    AX, 6521h
        INT    21h
@1:     POP    DS
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ UpCaseStr4 }

{ Return system time in Today }

</i></font><font color="#FF0000"><b>Procedure </b></font>GetSysTime<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Today <font color="#000080">: </font>DateTime<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">LES    DI, Today
        CLD

        MOV    AH, 2Ah
        INT    21h
        XCHG   AX, CX          </font><font color="#008000"><i>{ year }
        </i></font><font color="#FF00FF">STOSW
        XOR    AH, AH
        MOV    AL, DH          </font><font color="#008000"><i>{ month }
        </i></font><font color="#FF00FF">STOSW
        MOV    AL, DL          </font><font color="#008000"><i>{ day }
        </i></font><font color="#FF00FF">STOSW

        MOV    AH, 2Ch
        INT    21h
        XOR    AH, AH
        MOV    AL, CH          </font><font color="#008000"><i>{ hours }
        </i></font><font color="#FF00FF">STOSW
        MOV    AL, CL          </font><font color="#008000"><i>{ min }
        </i></font><font color="#FF00FF">STOSW
        MOV    AL, DH          </font><font color="#008000"><i>{ seconds }
        </i></font><font color="#FF00FF">STOSW
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ GetSysTime }

{ Set system time }

</i></font><font color="#FF0000"><b>Procedure </b></font>SetSysTime<font color="#000080">(</font>Today <font color="#000080">: </font>DateTime<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">PUSH   DS
        CLD
        LDS    SI, Today
        LODSW
        MOV    CX, AX          </font><font color="#008000"><i>{ year }
        </i></font><font color="#FF00FF">LODSW
        MOV    DH, AL          </font><font color="#008000"><i>{ month }
        </i></font><font color="#FF00FF">LODSW
        MOV    DL, AL          </font><font color="#008000"><i>{ day }
        </i></font><font color="#FF00FF">MOV    AH, 2Bh
        INT    21h

        LODSW                  
        MOV    CH, AL          </font><font color="#008000"><i>{ hour }
        </i></font><font color="#FF00FF">LODSW
        MOV    CL, AL          </font><font color="#008000"><i>{ minutes }
        </i></font><font color="#FF00FF">LODSW
        MOV    DH, AL          </font><font color="#008000"><i>{ seconds }
        </i></font><font color="#FF00FF">XOR    DL, DL
        MOV    AH, 2Dh
        INT    21h
        POP    DS
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ SetSysTime }

{ Convert a binary number to an unpacked decimal
  On entry:  AL &lt;-- number &oacute; 99
  On exit:   AX --&gt; ASCII representation }

</i></font><font color="#FF0000"><b>Procedure </b></font>UnpackNumber<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">AAM
        XCHG    AH, AL
        ADD     AX, '00'
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ UnpackNumber }

</i></font><font color="#FF0000"><b>Function </b></font>DateString<font color="#000080">(</font>FileStamp <font color="#000080">: </font>DateTime<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">PUSH   DS
        CLD

  </font><font color="#008000"><i>{ Set string length }

        </i></font><font color="#FF00FF">LES    DI, @Result
        MOV    AL, 8
        STOSB

  </font><font color="#008000"><i>{ Store year, month and day in registers }

        </i></font><font color="#FF00FF">LDS    SI, FileStamp
        LODSW
        SUB    AX, 1900
        CALL   UnpackNumber
        XCHG   AX, BX              </font><font color="#008000"><i>{ yy -&gt; BX }
        </i></font><font color="#FF00FF">LODSW
        CALL   UnpackNumber
        XCHG   AX, CX              </font><font color="#008000"><i>{ mm -&gt; CX }
        </i></font><font color="#FF00FF">LODSW
        CALL   UnpackNumber
        XCHG   AX, DX              </font><font color="#008000"><i>{ dd -&gt; DX }

  {  Case date format of
       0 : USA standard       mm:dd:yy
       1 : Europe standard    dd:mm:yy
       2 : Japan standard     yy:mm:dd }

        </i></font><font color="#FF00FF">POP    DS
        MOV    AL, Byte Ptr [CountryRec.DateFormat]
        OR     AL, AL
        JZ     @1
        DEC    AL
        JZ     @2

  </font><font color="#008000"><i>{ Japan }

        </i></font><font color="#FF00FF">PUSH   DX
        PUSH   CX
        PUSH   BX
        JMP    @3

  </font><font color="#008000"><i>{ USA }

</i></font><font color="#FF00FF">@1:     PUSH   BX
        PUSH   DX
        PUSH   CX
        JMP    @3

  </font><font color="#008000"><i>{ Europe }

</i></font><font color="#FF00FF">@2:     PUSH   BX
        PUSH   CX
        PUSH   DX

  </font><font color="#008000"><i>{ Remove leading zero }

</i></font><font color="#FF00FF">@3:     POP    AX
        CMP    AL, '0'
        JNE    @4
        MOV    AL, ' '

@4:     MOV    CL, Byte Ptr [CountryRec.Delimiter.date]
        STOSW
        MOV    AL, CL
        STOSB
        POP    AX
        STOSW
        MOV    AL, CL
        STOSB
        POP    AX
        STOSW
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ DateString }

</i></font><font color="#FF0000"><b>Function </b></font>TimeString<font color="#000080">(</font>FileStamp <font color="#000080">: </font>DateTime<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">PUSH   DS
        CLD

        MOV    BL, [CountryRec.Clock24Hrs]
        MOV    DX, [CountryRec.Delimiter.time]
        LDS    SI, FileStamp
        LES    DI, @Result

  </font><font color="#008000"><i>{ Set string length }

        </i></font><font color="#FF00FF">MOV    AL, 5
        STOSB

  </font><font color="#008000"><i>{ Advance string index of FileStamp to hour field }

        </i></font><font color="#FF00FF">ADD    SI, 6
        LODSW

  </font><font color="#008000"><i>{ Query time format }

        </i></font><font color="#FF00FF">OR     BL, BL
        JNZ    @2

  </font><font color="#008000"><i>{ a.m. / p.m. clock format, set string length to 6 }

        </i></font><font color="#FF00FF">INC    Byte Ptr ES:[DI-1]
        MOV    BL, 'a'
        CMP    AL, 12
        JBE    @1
        SUB    AL, 12
        MOV    BL, 'p'
@1:     MOV    Byte Ptr ES:[DI+5], BL

  </font><font color="#008000"><i>{ Convert to ASCII and remove leading zero }

</i></font><font color="#FF00FF">@2:     CALL   UnpackNumber
        CMP    AL, '0'
        JNE    @3
        MOV    AL, ' '
@3:     STOSW

  </font><font color="#008000"><i>{ Write time separator }

        </i></font><font color="#FF00FF">XCHG   AX, DX
        STOSB

  </font><font color="#008000"><i>{ Store minutes in string }

        </i></font><font color="#FF00FF">LODSW
        CALL   UnpackNumber
        STOSW

        POP    DS
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TimeString }

</i></font><font color="#FF0000"><b>Begin  </b></font><font color="#008000"><i>{ Country }
</i></font><font color="#FF0000"><b>ASM

   </b></font><font color="#008000"><i>{ Exit if Dos version &lt; 3.0 }

        </i></font><font color="#FF00FF">MOV    AH, 30h
        INT    21h
        CMP    AL, 3
        JB     @3
        JA     @1

   </font><font color="#008000"><i>{ Initialise pointers to DOS 3 capitalisation routines }

        </i></font><font color="#FF00FF">MOV    Word Ptr [UpCase], Offset UpCase3
        MOV    Word Ptr [UpCaseStr], Offset UpCaseStr3
        JMP    @2

   </font><font color="#008000"><i>{ Initialise pointers to DOS 4 (or later) capitalisation routines }

</i></font><font color="#FF00FF">@1:     MOV    Word Ptr [UpCase], Offset UpCase4
        MOV    Word Ptr [UpCaseStr], Offset UpCaseStr4

@2:     MOV    Word Ptr [UpCase+2], CS
        MOV    Word Ptr [UpCaseStr+2], CS

   </font><font color="#008000"><i>{ Call Dos 'Get country dependent information' function }

        </i></font><font color="#FF00FF">MOV    AX, 3800h
        MOV    DX, Offset [CountryRec]
        INT    21h
        JC     @3

   </font><font color="#008000"><i>{ Add country code to the structure }

        </i></font><font color="#FF00FF">MOV    [CountryRec.CountryCode], BX
        MOV    [CountryOk], True
        JMP    @4
@3:     MOV    [CountryOk], False
@4:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.  </font><font color="#008000"><i>{ Country }</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DATETIME SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p></body>
</html>
