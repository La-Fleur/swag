<html>
<head><title> "Interrupt driven external events" by UDO JUERSS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to INTERRUP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ This little program shows how to count or act on external events. It works
  since 3 years in a industial application without any problems.
  It's interrupt driven to make sure, that no event is missed.

  You need a male DB25 connector (the counterpart of the PC's printer
  connector), and at least 2 wires. A switch is recommend.
  What you have to do is to connect 2 wires to the male DB25 connector.
  One wire to pin 10 and the other to pin 25.

              IRQ-inputline
            +----------------+
            |                |
            -         13     |10               1
          switch       - - - - - - - - - - - - -
            -           - - - - - - - - - - - -   backview of connector
            |         25|                     14
            +-----------+
               ground

  Pin 10 is the acknowledge line (input) witch normaly is connected to a
  printer output signal. A internal resistor with 4,7k_ pulls this pin up to
  5V TTL level. So the normal level is 5V TTL. With some software setup
  this input line can perform interrupts when the signal is forced from high
  to low level. This can be done with a simple switch that connects pin10 to
  ground. The little &quot;framework&quot; above shows it.

  In the program below events up to 35kHz can be sensed.

  Try ($define IRQ7) first. If this doesn't work then use ($define IRQ5).
  If you do your own interrupt service, consider that it must be a far proc.

  There's a lot of what you can do with this - go external...

  Dec. 12, 1995, Udo Juerss, 57078 Siegen, Germany, CompuServe [101364,526]}

{$define IRQ7}
</i></font><font color="#FF0000"><b>uses
  </b></font>Dos<font color="#000080">,
  </font>Crt<font color="#000080">;
</font><font color="#008000"><i>{---------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>var
  </b></font>Lpt            <font color="#000080">: </font>Word<font color="#000080">;
  </font>InterruptCount <font color="#000080">: </font>Word<font color="#000080">;
  </font>LptOrgVec      <font color="#000080">: </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>procedure </b></font>SetPortBit<font color="#000080">(</font>PortAdr<font color="#000080">:</font>Word<font color="#000080">; </font>Bit<font color="#000080">:</font>Byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
           </b></font><font color="#FF00FF">mov   dx,PortAdr
           in    al,dx
           mov   cl,Bit
           and   cl,7
           mov   ah,1
           shl   ah,cl
           or    al,ah
           out   dx,al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>procedure </b></font>ClearPortBit<font color="#000080">(</font>PortAdr<font color="#000080">:</font>Word<font color="#000080">; </font>Bit<font color="#000080">:</font>Byte<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
           </b></font><font color="#FF00FF">mov   dx,PortAdr
           in    al,dx
           mov   cl,Bit
           and   cl,7
           mov   ah,1
           shl   ah,cl
           not   ah
           and   al,ah
           out   dx,al
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>function </b></font>GetLptPort<font color="#000080">(</font>LptNr<font color="#000080">:</font>Byte<font color="#000080">):</font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetLptPort<font color="#000080">:=</font>MemW<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">8 </font><font color="#000080">+ (</font>LptNr <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">) * </font><font color="#800000">2</font><font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{---------------------------------------------------------------------------}

{$F+}
</i></font><font color="#FF0000"><b>procedure </b></font>NewLptInt<font color="#000080">; </font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Sound<font color="#000080">(</font><font color="#800000">880</font><font color="#000080">);                                      </font><font color="#008000"><i>{Quittungssignal ausgeben}
  </i></font>Delay<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
  </font>NoSound<font color="#000080">;

  </font>Inc<font color="#000080">(</font>InterruptCount<font color="#000080">);                              </font><font color="#008000"><i>{Interruptzdhler erhvhen}

  </i></font>SetPortBit<font color="#000080">(</font>Lpt <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">);                 </font><font color="#008000"><i>{Bit 6 im Interrupt Register setzen}

  </i></font><font color="#FF0000"><b>asm                                         </b></font><font color="#008000"><i>{Interrupt Anforderung lvschen}
    </i></font><font color="#FF00FF">mov  al,20h
    out  20h,al
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}
{---------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>begin
  </b></font>ClrScr<font color="#000080">;

  </font>Lpt<font color="#000080">:=</font>GetLptPort<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);                     </font><font color="#008000"><i>{Port Adresse der 1. Schnittstelle}
  </i></font>SetPortBit<font color="#000080">(</font>Lpt <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">);                 </font><font color="#008000"><i>{Bit 6 im Interrupt Register setzen}
  </i></font>SetPortBit<font color="#000080">(</font>Lpt <font color="#000080">+ </font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);                  </font><font color="#008000"><i>{Bit 4 im Kontroll Register setzen}

{$ifdef IRQ7}
  </i></font>ClearPortBit<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">,</font><font color="#800000">7</font><font color="#000080">);                </font><font color="#008000"><i>{IRQ7 im Intrrupt-Controller freigeben}
  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$0F</font><font color="#000080">,@</font>LptOrgVec<font color="#000080">);              </font><font color="#008000"><i>{Bisherigen Interrupt Vektor holen}
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$0F</font><font color="#000080">,@</font>NewLptInt<font color="#000080">);              </font><font color="#008000"><i>{Vektor f|r neuen Interrupt setzen}
{$else}
  </i></font>ClearPortBit<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">,</font><font color="#800000">5</font><font color="#000080">);                </font><font color="#008000"><i>{IRQ5 im Intrrupt-Controller freigeben}
  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$0D</font><font color="#000080">,@</font>LptOrgVec<font color="#000080">);              </font><font color="#008000"><i>{Bisherigen Interrupt Vektor holen}
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$0D</font><font color="#000080">,@</font>NewLptInt<font color="#000080">);              </font><font color="#008000"><i>{Vektor f|r neuen Interrupt setzen}
{$endif}

  </i></font>Writeln<font color="#000080">(</font><font color="#800000">'Press the interrupt-switch to test response, or any key to quit...'</font><font color="#000080">);
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Interrupts occurrences : '</font><font color="#000080">);
  </font>InterruptCount<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>GotoXY<font color="#000080">(</font><font color="#800000">25</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
    </font>Write<font color="#000080">(</font>InterruptCount<font color="#000080">:</font><font color="#800000">5</font><font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>KeyPressed<font color="#000080">;
  </font>ReadKey<font color="#000080">;

</font><font color="#008000"><i>{$ifdef IRQ7}
  </i></font>SetPortBit<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">,</font><font color="#800000">7</font><font color="#000080">);                    </font><font color="#008000"><i>{IRQ7 im Intrrupt-Controller sperren}
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$0F</font><font color="#000080">,@</font>LptOrgVec<font color="#000080">);     </font><font color="#008000"><i>{Vektor von urspr|nglichem Interrupt setzen}
{$else}
  </i></font>SetPortBit<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">,</font><font color="#800000">5</font><font color="#000080">);                    </font><font color="#008000"><i>{IRQ5 im Intrrupt-Controller sperren}
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$0D</font><font color="#000080">,@</font>LptOrgVec<font color="#000080">);     </font><font color="#008000"><i>{Vektor von urspr|nglichem Interrupt setzen}
{$endif}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to INTERRUP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p></body>
</html>
