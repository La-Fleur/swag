<html>
<head><title> "Protected Mode Interrupts" by RAPHAEL VANNEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to INTERRUP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; One part of the program I am writing must call an interrupt (6A I believe
&gt; - it is a networking interrupt).  The interrupt expects ds:dx to point to a
&gt; structure I have to create.  I know my procedures work because I have
&gt; tested them in real mode.  The problem comes when Is witch into protected
&gt; mode.  The interrupt can no longer find the record that I create. How can I
&gt; do this without too much trouble?  I was thinking of using a known segment,
&gt; such as SegB000 (which I am not using right now), and using memcpy to
&gt; copy the record I create to that segment.  Then I could just point ds:
&gt; SegB000 and dx: 0 and do my interrupt.

Here's the unit I use to solve such problems. What you need to do :
- allocate memory in the first megabyte, using AllocateLowMem,
- properly set-up your structure in this memory area, using ProtectedPtr,
- set-up a TRealModeRegs, DS being initialized with the RealSegment of
  the previously allocated memory block,
- call your interrupt with RealModeInt.

From: zlika@chaos2.frmug.fr.net (Raphael Vanney)
}

{ Outils DPMI }
{$x+,g+}

{$IfNDef DPMI}
     </i></font>You don<font color="#800000">'t need that unit.
</font><font color="#008000"><i>{$EndIf}

</i></font><font color="#FF0000"><b>Unit </b></font>MinDPMI <font color="#000080">;

</font><font color="#FF0000"><b>Interface

Type </b></font>TRealModeRegs <font color="#000080">=
     </font><font color="#FF0000"><b>Record
          Case </b></font>Integer <font color="#FF0000"><b>Of
          </b></font><font color="#800000">0</font><font color="#000080">: ( </font>EDI<font color="#000080">, </font>ESI<font color="#000080">, </font>EBP<font color="#000080">, </font>EXX<font color="#000080">, </font>EBX<font color="#000080">, </font>EDX<font color="#000080">, </font>ECX<font color="#000080">, </font>EAX<font color="#000080">: </font>Longint<font color="#000080">;
               </font>Flags<font color="#000080">, </font>ES<font color="#000080">, </font>DS<font color="#000080">, </font>FS<font color="#000080">, </font>GS<font color="#000080">, </font>IP<font color="#000080">, </font>CS<font color="#000080">, </font>SP<font color="#000080">, </font>SS<font color="#000080">: </font>Word<font color="#000080">) ;
          </font><font color="#800000">1</font><font color="#000080">: ( </font>DI<font color="#000080">,</font>DIH<font color="#000080">, </font>SI<font color="#000080">, </font>SIH<font color="#000080">, </font>BP<font color="#000080">, </font>BPH<font color="#000080">, </font>XX<font color="#000080">, </font>XXH<font color="#000080">: </font>Word<font color="#000080">;
               </font><font color="#FF0000"><b>Case </b></font>Integer <font color="#FF0000"><b>of
                 </b></font><font color="#800000">0</font><font color="#000080">: (</font>BX<font color="#000080">, </font>BXH<font color="#000080">, </font>DX<font color="#000080">, </font>DXH<font color="#000080">, </font>CX<font color="#000080">, </font>CXH<font color="#000080">, </font>AX<font color="#000080">, </font>AXH<font color="#000080">: </font>Word<font color="#000080">);
                 </font><font color="#800000">1</font><font color="#000080">: (</font>BL<font color="#000080">, </font>BH<font color="#000080">, </font>BLH<font color="#000080">, </font>BHH<font color="#000080">, </font>DL<font color="#000080">, </font>DH<font color="#000080">, </font>DLH<font color="#000080">, </font>DHH<font color="#000080">,
                     </font>CL<font color="#000080">, </font>CH<font color="#000080">, </font>CLH<font color="#000080">, </font>CHH<font color="#000080">, </font>AL<font color="#000080">, </font>AH<font color="#000080">, </font>ALH<font color="#000080">, </font>AHH<font color="#000080">: </font>Byte<font color="#000080">));
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;

     </font>TLowMemoryBlock     <font color="#000080">=
     </font><font color="#008000"><i>{ TLowMemoryBlock is used to point to a memory area within the
       first megabyte, which can thus be accessed both in protected
       and real mode. }
     </i></font><font color="#FF0000"><b>Record
          </b></font>ProtectedPtr   <font color="#000080">: </font>Pointer <font color="#000080">;    </font><font color="#008000"><i>{ pointer valid in protected mode }
          </i></font>RealSegment    <font color="#000080">: </font>Word <font color="#000080">;       </font><font color="#008000"><i>{ segment valid in real mode (ofs=0) }
          </i></font>Size           <font color="#000080">: </font>Word <font color="#000080">;       </font><font color="#008000"><i>{ size of allocated memory area }
     </i></font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ClearRegs<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>RealRegs <font color="#000080">: </font>TRealModeRegs<font color="#000080">) ;

</font><font color="#FF0000"><b>Function </b></font>RealModeInt<font color="#000080">(    </font>IntNo          <font color="#000080">: </font>Byte <font color="#000080">;
                         </font><font color="#FF0000"><b>Var </b></font>RealRegs   <font color="#000080">: </font>TRealModeRegs<font color="#000080">) : </font>Boolean <font color="#000080">;
</font><font color="#008000"><i>{ Important notes :
  . If SS and SP are set to 0, the DPMI server will provide a 30 bytes stack.
  . Calling ClearRegs before initializing registers used for a RealModeInt
    sets SS ans SP to 0.
  }

</i></font><font color="#FF0000"><b>Procedure </b></font>AllocateLowMem<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Pt <font color="#000080">: </font>TLowMemoryBlock <font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">) ;
</font><font color="#FF0000"><b>Procedure </b></font>FreeLowMem<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Pt <font color="#000080">: </font>TLowMemoryBlock<font color="#000080">) ;

</font><font color="#FF0000"><b>Procedure </b></font>SetProtectedIntVec<font color="#000080">(</font>No <font color="#000080">: </font>Byte <font color="#000080">; </font>p <font color="#000080">: </font>Pointer<font color="#000080">) ;
</font><font color="#FF0000"><b>Procedure </b></font>GetProtectedIntVec<font color="#000080">(</font>No <font color="#000080">: </font>Byte <font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>p <font color="#000080">: </font>Pointer<font color="#000080">) ;

</font><font color="#FF0000"><b>Implementation

Uses </b></font>WinAPI <font color="#000080">;

</font><font color="#FF0000"><b>Type </b></font>TDouble   <font color="#000080">=
     </font><font color="#FF0000"><b>Record
          </b></font>Lo<font color="#000080">, </font>Hi    <font color="#000080">: </font>Word <font color="#000080">;
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ClearRegs <font color="#000080">;
</font><font color="#FF0000"><b>Begin
     </b></font>FillChar<font color="#000080">(</font>RealRegs<font color="#000080">, </font>SizeOf<font color="#000080">(</font>RealRegs<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">) ;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>RealModeInt<font color="#000080">(    </font>IntNo          <font color="#000080">: </font>Byte <font color="#000080">;
                         </font><font color="#FF0000"><b>Var </b></font>RealRegs   <font color="#000080">: </font>TRealModeRegs<font color="#000080">) : </font>Boolean <font color="#000080">;
</font><font color="#FF0000"><b>Assembler </b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
     </b></font><font color="#FF00FF">Mov  AX, $0300
     Mov  BL, IntNo
     XOr  BH, BH
     XOr  CX, CX
     LES  DI, RealRegs
     Int  $31
     Mov  AX, 0               </font><font color="#008000"><i>{ don't use XOr }
     </i></font><font color="#FF00FF">JNC  @Ok
     Inc  AX
@Ok:
     Or   AX, AX
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AllocateLowMem <font color="#000080">;
</font><font color="#FF0000"><b>Var  </b></font>Adr  <font color="#000080">: </font>LongInt <font color="#000080">;
</font><font color="#FF0000"><b>Begin
     </b></font>Adr<font color="#000080">:=</font>GlobalDOSAlloc<font color="#000080">(</font>Size<font color="#000080">) ;
     </font><font color="#FF0000"><b>If </b></font>Adr<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>Size<font color="#000080">:=</font><font color="#800000">0 </font><font color="#000080">;
     </font>Pt<font color="#000080">.</font>ProtectedPtr<font color="#000080">:=</font>Ptr<font color="#000080">(</font>TDouble<font color="#000080">(</font>Adr<font color="#000080">).</font>Lo<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">) ;
     </font>Pt<font color="#000080">.</font>RealSegment<font color="#000080">:=</font>TDouble<font color="#000080">(</font>Adr<font color="#000080">).</font>Hi <font color="#000080">;
     </font>Pt<font color="#000080">.</font>Size<font color="#000080">:=</font>Size <font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FreeLowMem <font color="#000080">;
</font><font color="#FF0000"><b>Begin
     </b></font>GlobalDOSFree<font color="#000080">(</font>Seg<font color="#000080">(</font>Pt<font color="#000080">.</font>ProtectedPtr<font color="#000080">^)) ;
     </font>FillChar<font color="#000080">(</font>Pt<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Pt<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">) ;           </font><font color="#008000"><i>{ Fills with NIL }
</i></font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetProtectedIntVec<font color="#000080">(</font>No <font color="#000080">: </font>Byte <font color="#000080">; </font>p <font color="#000080">: </font>Pointer<font color="#000080">) ; </font><font color="#FF0000"><b>Assembler </b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
     </b></font><font color="#FF00FF">Mov  AX, $0205
     Mov  BL, No
     Mov  CX, TDouble[p].Hi        </font><font color="#008000"><i>{ Selector }
     </i></font><font color="#FF00FF">Mov  DX, TDouble[p].Lo        </font><font color="#008000"><i>{ Offset }
     </i></font><font color="#FF00FF">Int  $31
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>GetProtectedIntVec<font color="#000080">(</font>No <font color="#000080">: </font>Byte <font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>p <font color="#000080">: </font>Pointer<font color="#000080">) ; </font><font color="#FF0000"><b>Assembler </b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
     </b></font><font color="#FF00FF">Mov  AX, $0204
     Mov  BL, No
     Int  $31
     LES  DI, p
     </font><font color="#008000"><i>{ Mov  ES:[DI], DX }
     { Mov  ES:[DI+2], CX }
     </i></font><font color="#FF00FF">Mov  TDouble[ES:DI].Lo, DX
     Mov  TDouble[ES:DI].Hi, CX
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>HugeAdr<font color="#000080">(</font>Slct <font color="#000080">: </font>Word <font color="#000080">; </font>Ofst <font color="#000080">: </font>LongInt<font color="#000080">) : </font>Pointer <font color="#000080">;
</font><font color="#FF0000"><b>Assembler </b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
     </b></font><font color="#FF00FF">Mov  AX, SelectorInc
     Mul  TDouble[Ofst].Hi
     Add  AX, Slct                 </font><font color="#008000"><i>{ First selector of bloc }
     </i></font><font color="#FF00FF">Mov  DX, AX                   </font><font color="#008000"><i>{ New selector }
     </i></font><font color="#FF00FF">Mov  AX, TDouble[Ofst].Lo     </font><font color="#008000"><i>{ Low word of offset is the same }
</i></font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to INTERRUP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p></body>
</html>
