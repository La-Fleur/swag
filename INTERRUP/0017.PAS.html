<html>
<head><title> "Disabling The Ctrl-Alt-D" by TIM MCKAY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to INTERRUP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0017.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>unit </b></font>NonStop<font color="#000080">;                         </font><font color="#008000"><i>{Makes your program UNSTOPPABLE!}

</i></font><font color="#FF0000"><b>interface

 var
   </b></font>Intr09 <font color="#000080">: </font>pointer <font color="#FF0000"><b>absolute </b></font><font color="#800000">$0000</font><font color="#000080">:</font><font color="#800000">$0024</font><font color="#000080">; </font><font color="#008000"><i>{Interrupt $09, keyboard ISR}
   </i></font>OldIntr09 <font color="#000080">: </font>pointer<font color="#000080">;                   </font><font color="#008000"><i>{Original Interrupt $09     }

</i></font><font color="#FF0000"><b>const
   </b></font>NoBoot  <font color="#000080">: </font>boolean <font color="#000080">= </font>true<font color="#000080">;              </font><font color="#008000"><i>{flag to disable soft boot  }
   </i></font>NoBreak <font color="#000080">: </font>boolean <font color="#000080">= </font>true<font color="#000080">;              </font><font color="#008000"><i>{flag to disable Ctrl-Break }
   </i></font>NoCtrlC <font color="#000080">: </font>boolean <font color="#000080">= </font>true<font color="#000080">;              </font><font color="#008000"><i>{flag to disable Ctrl-C     }

 </i></font><font color="#FF0000"><b>procedure </b></font>InstallNonStopISR<font color="#000080">;
 </font><font color="#FF0000"><b>procedure </b></font>NonStopExitProc<font color="#000080">;

</font><font color="#FF0000"><b>implementation

 var
   </b></font>PreNonStopExitProc <font color="#000080">: </font>pointer<font color="#000080">;

 </font><font color="#FF0000"><b>const
   </b></font>Installed <font color="#000080">: </font>boolean <font color="#000080">= </font>false<font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>NonStopISR<font color="#000080">; </font><font color="#FF0000"><b>External</b></font><font color="#000080">; </font><font color="#008000"><i>{$L NonStop}

 </i></font><font color="#FF0000"><b>procedure </b></font>InstallNonStopISR<font color="#000080">;

 </font><font color="#FF0000"><b>begin
  if not </b></font>Installed <font color="#FF0000"><b>then
  begin
   </b></font>OldIntr09 <font color="#000080">:= </font>Intr09<font color="#000080">;
   </font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$fa</font><font color="#000080">);                       </font><font color="#008000"><i>{CLI - disable interrupts         }
   </i></font>Intr09 <font color="#000080">:= @</font>NonStopISR<font color="#000080">;              </font><font color="#008000"><i>{Link NonStop into interrupt chain}
   </i></font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$fb</font><font color="#000080">);                       </font><font color="#008000"><i>{STI - enable interrupts          }
   </i></font>PreNonStopExitProc <font color="#000080">:= </font>ExitProc<font color="#000080">;    </font><font color="#008000"><i>{Save old ExitProc                }
   </i></font>ExitProc <font color="#000080">:= @</font>NonStopExitProc<font color="#000080">;      </font><font color="#008000"><i>{Link in NonStopExitProc          }
   </i></font>Installed <font color="#000080">:= </font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>NonStopExitProc<font color="#000080">;

 </font><font color="#FF0000"><b>begin
  </b></font>ExitProc <font color="#000080">:= </font>PreNonStopExitProc<font color="#000080">;      </font><font color="#008000"><i>{Point ExitProc to next  }
  </i></font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$fa</font><font color="#000080">);                         </font><font color="#008000"><i>{CLI - disable interrupts}
  </i></font>Intr09 <font color="#000080">:= </font>OldIntr09<font color="#000080">;                 </font><font color="#008000"><i>{Restore Original Vector }
  </i></font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$fb</font><font color="#000080">);                         </font><font color="#008000"><i>{STI - enable interrupts }
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

*</font>XX3402<font color="#000080">-</font><font color="#800000">000419</font><font color="#000080">-</font><font color="#800000">090294</font><font color="#000080">--</font><font color="#800000">72</font><font color="#000080">--</font><font color="#800000">85</font><font color="#000080">-</font><font color="#800000">43138</font><font color="#000080">-----</font>NONSTOP<font color="#000080">.</font>OBJ<font color="#000080">--</font><font color="#800000">1</font><font color="#000080">-</font><font color="#FF0000"><b>OF</b></font><font color="#000080">--</font><font color="#800000">1
</font>U<font color="#000080">+</font>o<font color="#000080">+</font><font color="#800000">0</font>qtjPbBoPr<font color="#000080">+</font>iEJBBG6UU<font color="#000080">++++</font><font color="#800000">53</font>FpQa7j623nQqJhMalZQW<font color="#000080">+</font>UJaJmQqZjPW<font color="#000080">+</font>n9X8NW<font color="#000080">-</font>A<font color="#000080">+
</font>ECblGoYQ0qtjPbBoPr<font color="#000080">+</font>iEJBBQ6U1<font color="#000080">+</font><font color="#800000">21</font>dH7M0<font color="#000080">++-</font>cW<font color="#000080">+</font>A<font color="#000080">+</font>E84IZUM<font color="#000080">+-</font><font color="#800000">2</font>F<font color="#000080">-</font>J234a<font color="#000080">+</font>Q<font color="#000080">+</font>G<font color="#000080">++++</font>U2<font color="#000080">-
</font><font color="#800000">3</font>NM4<font color="#000080">++</font>F1HoF3FNU5<font color="#000080">+</font><font color="#800000">0</font>WW<font color="#000080">++</font>A<font color="#000080">-+</font>N8A7U<font color="#000080">+</font><font color="#800000">4</font>HYx0HoxI<font color="#000080">++</font>RCHo7GFI39<font color="#000080">++</font>RCHoBIIYl1<font color="#000080">++</font>ZDH2F7
HZFGA1Y<font color="#000080">+</font>l7<font color="#000080">+</font>F<font color="#000080">+++</font><font color="#800000">00</font>YtDHZBIHp<font color="#000080">-</font><font color="#800000">7</font>Ip6<font color="#000080">++++</font>oW<font color="#000080">+</font>E<font color="#000080">+</font>E86<font color="#000080">-</font>YO0V<font color="#000080">++</font><font color="#800000">6</font><font color="#000080">++-</font>tEi<font color="#000080">+++</font>XhUilUOR<font color="#000080">+</font>CeE
znM0<font color="#000080">+</font>Dwq<font color="#000080">+++</font>iXkOS<font color="#000080">+</font><font color="#800000">0</font>uD<font color="#000080">-</font>e<font color="#000080">++</font>Aw0CqDwq7<font color="#000080">+-</font>M<font color="#000080">-</font>HA<font color="#000080">+</font>I6w47<font color="#000080">+-</font>M5ls4I9V<font color="#000080">++</font><font color="#800000">6</font>v<font color="#000080">+</font>i<font color="#000080">+++</font>XhUaWWML
<font color="#000080">+</font><font color="#800000">61</font>Y<font color="#000080">-</font><font color="#800000">61</font>A<font color="#000080">+</font><font color="#800000">5</font>FAt4<font color="#000080">+</font>mt<font color="#000080">+</font>ca<font color="#000080">++-</font>o2mO87VQ<font color="#000080">+</font>UCE6UAk<font color="#000080">+</font>R<font color="#000080">+</font>MwIrI0ulcmt<font color="#000080">+</font>ca<font color="#000080">++-</font>o<font color="#000080">-</font>XnURE9f119Y
<font color="#800000">0</font>WM<font color="#000080">++</font><font color="#800000">5E</font>ND0tp3SFVWi<font color="#000080">+</font>AUCNVVi1aDTek6CMUK<font color="#000080">+</font>QTnzhM<font color="#000080">-</font>lw6b0s<font color="#000080">+</font>l<font color="#000080">+</font>dI<font color="#000080">+</font>gENJ<font color="#000080">+</font><font color="#800000">925</font>ZE0m<font color="#000080">+</font>BI
<font color="#000080">+</font>QEE<font color="#000080">-</font>U22l<font color="#000080">-</font>E4<font color="#000080">+</font>EH6D3E<font color="#000080">-</font>l3A4<font color="#000080">+</font>E52PUM<font color="#000080">-+</font>gFw<font color="#000080">-</font>U21m6c5<font color="#000080">+</font>A2<font color="#000080">++</font>U6<font color="#000080">++</font><font color="#800000">8</font>c<font color="#000080">+
***** </font><font color="#FF0000"><b>END OF </b></font>BLOCK <font color="#800000">1 </font><font color="#000080">*****


</font><font color="#008000"><i>{ ------------------------   ASSEMBLER MODULE  --------------------- }
</i></font><font color="#000080">;</font><font color="#FF0000"><b>ASM </b></font><font color="#FF00FF">NONSTOP.PAS

DATA    SEGMENT WORD PUBLIC
        ASSUME DS:DATA
EXTRN   NoBoot    : BYTE
EXTRN   NoBreak   : BYTE
EXTRN   NoCtrlC   : BYTE
EXTRN   OldIntr09 : DWORD
DATA    ENDS

CODE    SEGMENT BYTE PUBLIC
        ASSUME CS:CODE

NonStopISR PROC FAR
           PUBLIC NonStopISR

        push    ds                     ;This is the initialization code
        push    ax                     ;It will be used only once
        mov     ax, seg DATA           ;To fix up the far jump
        mov     ds, ax                 ;put Global Data Segment in DS
        mov     cs:[JmpCode], 0eah     ;install far jump op code
        push    [OldIntr09]            ;put pointer to old interrupt 09
        pop     cs:Offs                ;in far jump offset
        pop     cs:Segm                ;in far jump segment
        xor     ax,ax                  ;point DS to interrupt vector table
        mov     ds,ax                  ;ie, ds=0
        push    ds:[24h]               ;Put offset of Int 09
        pop     ax                     ;in ax
        add     ax, Entry - NonStopISR ;Adjust past init code
        push    ax
        pop     ds:[24h]               ;revector to regular entry point
        pop     ax
        pop     ds
Entry:
        push    ds
        push    es
        push    ax
        mov     ax, 40h                ;point es
        mov     es, ax                 ;to BIOS data area
        mov     ax, seg DATA           ;point ds
        mov     ds, ax                 ;to data segment
        mov     ah, es:[17h]           ;put keyboard shift flags in ax
        and     ah, 00000100b          ;mask out everything but ctrl flag
        or      ah, 00000000b          ;see if zero
        jz      NormalKey              ;chain on if ctrl not pressed
        in      al, 60h                ;get make/break code
        xor     ah, ah                 ;zero ah
        or      ah, NoBoot             ;Is flag set to disable soft boot?
        jz      CheckBreak             ;No? Go check for break
        mov     ah, es:[17h]           ;get keyboard shift flags
        and     ah, 00001000b          ;mask out all but alt flag
        or      ah, 00000000b          ;is result zero?
        jz      CheckBreak             ;go on to check for break
        cmp     al, 53h                ;is it del make?
        jnz     CheckBreak             ;no, chain on to old int 09
        jmp short TossIt               ;Soft boot attempted - no dice!
CheckBreak:
        xor     ah, ah                 ;zero ah
        or      ah, NoBreak            ;Flag set to disable ctrl-break?
        jz      CheckCtrlC             ;No? Go check for Ctrl-C
        cmp     al, 0E0h               ;is it Break make?
        jnz     CheckCtrlC             ;No? Go check for Ctrl-C
        jmp short TossIt               ;Ctrl-Break attempted - toss it!
CheckCtrlC:
        xor     ah, ah                 ;zero ah
        or      ah, NoCtrlC            ;flag set to disabe ctrl-c?
        jz      NormalKey              ;No? Chain on to old ISR
        cmp     al, 2Eh                ;C pressed?
        jnz     NormalKey              ;No? Chain on to old ISR
TossIt:
        in      al, 61h                ;read keyboard control port
        mov     ah, al
        or      al, 10000000b          ;set the &quot;reset&quot; bit
        out     61h, al                ;send it back to control
        xchg    ah, al                 ;get back control value
        out     61, al                 ;send it out also
        cli
        mov     al, 20h                ;send EOI to the
        out     20h, al                ;interrupt controller
        pop     ax;
        pop     es;
        pop     ds;
        iret                           ;LATER, DUDE!
NormalKey:
        sti                            ;allow interrupts
        pop     ax                     ;cleanup and
        pop     es
        pop     ds
JmpCode db      ?                      ;Far jump to old Int 09
Offs    dw      ?
Segm    dw      ?

NonStopISR  ENDP
CODE    ENDS
        </font><font color="#FF0000"><b>END     </b></font>NonStopISR


</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to INTERRUP SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0017.PAS">Original</a><b>]</b></p></body>
</html>
