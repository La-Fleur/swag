<html>
<head><title> "Programming the Keyboard" by MARK OUELLET</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0098.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
&gt;&gt;&gt; procedure newkbdint; interrupt;   { new keyboard handler }
&gt;&gt;&gt; begin
&gt;&gt;&gt; keydown[port[$60] and $7f] := (port[$60] and $80) = $00;
&gt;&gt;&gt; port[$20] := $20;
&gt;&gt;&gt; end;
&gt;&gt;
&gt;&gt;&gt; On the XT I tested that code on, it accepted the first keystroke but
&gt;&gt;&gt; then acted like I never released the key or pressed another.
&gt;&gt;
&gt;&gt; I believe sending the EOI is insuficient. You also need to signify
&gt;&gt; the keyboard through port 61... But then again I might be wrong.

&gt; What do you mean by &quot;signify the keyboard through port 61h&quot;?  Also, would
&gt; that be specific to XTs?  I don't have problems with my 386, or my
&gt; sister's, or a friend's, or another friend's 286 ...

Well I was hoping you might know what I was talking about ;-)

    It's just that I noticed you weren't calling the old interrupt routine and
I noticed most keyboard routines, including TP/BP's keyboard routine, seem to
interract with port $61. It might be some kind of handshaking between the
keyboard controller and the PC. Maybe it is specific to models prior to the AT
and that could be why you have problems with the XT only.

Here is what I found in HelpPc:

Ports 60-67 are linked to the 8255 (PPI) on PCs, XTs and Jr's
Ports 60-6F are linked to the 8042 on ATs and PS/2s

    Port 61 is Port B Status on 8255
            And System Control port on the 8042 (For compatibility with 8255)

So port 61 manipulation would be for XT compatibility reasons.

And here is more help from Tech Help


Port  Description
&szlig;&szlig;&szlig;&szlig;  &szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;&szlig;
060H  &thorn;PC/XT&thorn;  PPI port A.  Read keyboard scan code:
      IN   al,60H  ;fetches most recent scan code.

061H  &thorn;PC/XT&thorn; PPI (Programmable Peripheral Interface) port B.
      &Ouml;7&Acirc;6&Acirc;5&Acirc;4&Acirc;3&Acirc;2&Acirc;1&Acirc;0&middot;
      &ordm; &sup3; &sup3; &sup3; &sup3; &sup3;0&sup3; &sup3; &ordm;
      &Oacute;&Ograve;&Aacute;&Ograve;&Aacute;&Ograve;&Aacute;&Ograve;&Aacute;&Ograve;&Aacute;&Auml;&Aacute;&Ograve;&Aacute;&Ograve;&frac12; bit
       &ordm; &ordm; &ordm; &ordm; &ordm;   &ordm; &Egrave;&Iacute; 0: Timer 2 gate (speaker)  &Iacute;&Euml;&Iacute; OR 03H=speaker ON
       &ordm; &ordm; &ordm; &ordm; &ordm;   &Egrave;&Iacute;&Iacute;&Iacute; 1: Timer 2 data  &Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&frac14;  AND 0fcH=speaker OFF
       &ordm; &ordm; &ordm; &ordm; &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 3: 1=read high switches; 0=read low switches(see 62H)
       &ordm; &ordm; &ordm; &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 4: 0=enable RAM parity checking; 1=disable
       &ordm; &ordm; &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 5: 0=enable I/O channel check
       &ordm; &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 6: 0=hold keyboard clock low
       &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 7: 0=enable keyboard; 1=disable keyboard

062H  &thorn;PC/XT&thorn; PPI port C.
      &Ouml;7&Acirc;6&Acirc;5&Acirc;4&Acirc;3&Acirc;2&Acirc;1&Acirc;0&middot;
      &ordm; &sup3; &sup3; &sup3;0&sup3;equip't&ordm;
      &Oacute;&Ograve;&Aacute;&Ograve;&Aacute;&Ograve;&Aacute;&Auml;&Aacute;&Auml;&Aacute;&Auml;&Aacute;&Auml;&Aacute;&Auml;&frac12; bit
       &ordm; &ordm; &ordm;   &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Ecirc;&Iacute; 0-3: values of DIP switches.  See Equipment List
       &ordm; &ordm; &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 5: 1=Timer 2 channel out
       &ordm; &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 6: 1=I/O channel check
       &Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute; 7: 1=RAM parity check error occurred.

063H  &thorn;PC/XT&thorn; PPI Command/Mode Register.  Selects which PPI ports are input
      or output.  BIOS sets to 99H (Ports A and C are input, B is output).

With this and a look at BP 7's RTL source for the keyboard routines you should
be able to determine what's the problem.
*)</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0098.PAS">Original</a><b>]</b></p></body>
</html>
