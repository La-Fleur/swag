<html>
<head><title> "Even More Keyboard Stuff!" by LOU DUCHEZ</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0100.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Well, I got it figured out now!  Kudos go to you, to Ralf Brown and his
list of ports, the great state of Ohio, the Church of the SubGenius, and
most of all, Bill Seiler.

Who is Bill Seiler?  Well, did any of you ever play that old (1985-1986)
game called &quot;Space War&quot;?  I did, and still do; and in fact, I registered
the game (it IS shareware, after all), and got the source code.  It's all
in ASM, and a lot of it still mystifies me; but I was able to figure out
how he does his keyboard interrupt.  Yet another advantage of registering
this shareware product, five years ago!

Here's my Pascal version, with significant line numbers:

    var port60h, port61h: byte;
        keydown: array[0 .. 127] of boolean;

    procedure newkbdint; interrupt;
    begin
1     port60h := port[$60];
2     keydown[port60h and $7f] := (port60h &lt;= $7f);
3     port61h := port[$61];
4     port[$61] := port61h or $80;
5     port[$61] := port61h;
6     port[$20] := $20;
      end;

1 - Read the port.
2 - Store the new key status for whatever key: either up or down.
3 - Read in port 61h, the system control port.
4 - Send the value back to 61h with the high bit set to &quot;1&quot; to reset
    the keyboard.
5 - Send the original, unadulterated value back to 61h.
6 - The boring old End of Interrupt instruction.  This line might not
    even be necessary!  It was only after testing that procedure out
    and pasting it into this message, that I noticed that I had left
    the EOI off the procedure.  But it seemed to work all right without
    it.  It seems to work just fine *with* it too, so it's probably
    best to keep it.

And, for the pure of heart: the same routine in BASM, which does not
need &quot;port60h&quot; and &quot;port61h&quot; for intermediate storage:
}

</i></font><font color="#FF0000"><b>procedure </b></font>newkbdint<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;       </font><font color="#008000"><i>{ new keyboard handler }
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push ax                           </font><font color="#008000"><i>{ push registers }
    </i></font><font color="#FF00FF">push bx
    push ds
    mov ax, SEG @Data
    mov ds, ax
    in  al, 60h
    mov bx, ax
    and bx, 007fh                     </font><font color="#008000"><i>{ switch high bit of BX to zero }
    </i></font><font color="#FF00FF">and al, 80h                       </font><font color="#008000"><i>{ check high bit of port value }
    </i></font><font color="#FF00FF">jz @press
    @release:                         </font><font color="#008000"><i>{ high bit = 1: &quot;release&quot; code }
    </i></font><font color="#FF00FF">mov byte ptr keydown[bx], 00h     </font><font color="#008000"><i>{ write 00 to &quot;down&quot; array element }
    </i></font><font color="#FF00FF">jmp @done
    @press:                           </font><font color="#008000"><i>{ high bit = 0: &quot;press&quot; code }
    </i></font><font color="#FF00FF">mov byte ptr keydown[bx], 01h     </font><font color="#008000"><i>{ write 01 to &quot;down&quot; array element }
    </i></font><font color="#FF00FF">@done:
    in al, 61h                        </font><font color="#008000"><i>{ read port 61h, system ctrl port }
    </i></font><font color="#FF00FF">mov ah, al                        </font><font color="#008000"><i>{ save value to AH }
    </i></font><font color="#FF00FF">or al, 80h                        </font><font color="#008000"><i>{ set top bit to &quot;1&quot; - reset kbd }
    </i></font><font color="#FF00FF">out 61h, al                       </font><font color="#008000"><i>{ write out value to port }
    </i></font><font color="#FF00FF">xchg ah, al                       </font><font color="#008000"><i>{ put original value back into AL }
    </i></font><font color="#FF00FF">out 61h, al                       </font><font color="#008000"><i>{ rewrite original value in AL }
    </i></font><font color="#FF00FF">mov al, 20h                       </font><font color="#008000"><i>{ generate End of Interrupt }
    </i></font><font color="#FF00FF">out 20h, al
    pop ds                            </font><font color="#008000"><i>{ pop registers }
    </i></font><font color="#FF00FF">pop bx
    pop ax
    iret                              </font><font color="#008000"><i>{ return }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0100.PAS">Original</a><b>]</b></p></body>
</html>
