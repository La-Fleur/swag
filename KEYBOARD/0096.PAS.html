<html>
<head><title> "Increasing the Keyboard buffer to 127 Ch" by FRANS POSTMA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: Frans@frp.idn.nl (Frans Postma)

&gt; Does anyone know of some Pascal source code to increase the
&gt; size of the  keyboard buffer?

Following unit enlarges keyboard buffer to hold 127 characters (max) and
you can stuff a string in it (max. length 127 chars) and that string will
be executed after your program has ended.
}
</i></font><font color="#FF0000"><b>Unit </b></font>frp_key<font color="#000080">;
</font><font color="#008000"><i>{keyboard unit}
{$V-,R-,S-}

{ Written by Frans Postma
             Fido: 2:282/500.17
             Internet: frans@frp.idn.nl (preferred)
                    OR frp@fahp425y.med.rug.nl

 I don't promise this unit will work, only that it will consume some
 diskspace. If you happen to find some bugs, feel free to mail me..

 You use this unit at your own risc.
 This unit is hereby placed in the Public Domain.

 ...and that's enough legal bla-bla :-) Enjoy.
}

{$IFDEF DPMI}
  </i></font>Yell<font color="#000080">! </font><font color="#FF0000"><b>Do Not </b></font>compile <font color="#FF0000"><b>With </b></font>DPMI<font color="#000080">!! </font><font color="#FF0000"><b>Not </b></font>tested yet<font color="#000080">!!!
  (</font>It should work <font color="#FF0000"><b>with </b></font>DPMI though<font color="#000080">, </font>just didn<font color="#800000">'t test/need it)
</font><font color="#008000"><i>{$ENDIF}

{ How to stuff 127 characters into the keyboardbuffer.
    Since the normal keyboardbuffer only stores 15 characters, we need to
    get ourselves a new (larger) buffer. Therefore we relocate the current
    buffer to adress $0134 (max. size then becomes 127 since every
    character needs two bytes). We do that by changing the pointers to the
    keyboardbuffer. Those pointers are at $0080 and $0082 resp. , change
    those and all should work...}

</i></font><font color="#FF0000"><b>Interface

Type </b></font>BufSize <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">127</font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>PutBuffer <font color="#000080">(</font>stx<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>Function  </b></font>GetBufSize<font color="#000080">: </font>BufSize<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>SetBufSize <font color="#000080">(</font>Size<font color="#000080">: </font>BufSize<font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>ClearBuffer<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Const </b></font>Segm    <font color="#000080">= </font><font color="#800000">$0040</font><font color="#000080">; </font><font color="#008000"><i>{ segment adress of HeadPtn etc. }
      </i></font>OldAdr  <font color="#000080">= </font><font color="#800000">$001E</font><font color="#000080">;
      </font>HeadPtn <font color="#000080">= </font><font color="#800000">$001A</font><font color="#000080">;
      </font>TailPtn <font color="#000080">= </font><font color="#800000">$001C</font><font color="#000080">;
      </font>NewAdr  <font color="#000080">= </font><font color="#800000">$0134</font><font color="#000080">; </font><font color="#008000"><i>{adress of the new extended keyboardbuffer}
      </i></font>BegBuf  <font color="#000080">= </font><font color="#800000">$0080</font><font color="#000080">; </font><font color="#008000"><i>{these two ptr point to the start/end of the}
      </i></font>EndBuf  <font color="#000080">= </font><font color="#800000">$0082</font><font color="#000080">; </font><font color="#008000"><i>{keyboardbuffer}

</i></font><font color="#FF0000"><b>Var </b></font>Buffer<font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ClearBuffer<font color="#000080">;
</font><font color="#008000"><i>{Make start/end equal, dirty trick to clear the buffer}

</i></font><font color="#FF0000"><b>Begin
  </b></font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>TailPtn<font color="#000080">] := </font>Buffer<font color="#000080">;
  </font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>HeadPtn<font color="#000080">] := </font>Buffer
<font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetBufSize <font color="#000080">(</font>Size<font color="#000080">: </font>BufSize<font color="#000080">);
</font><font color="#008000"><i>{ This procedure sets the size of the keyboard-buffer, max. = 127 }
{ If you manage to set it bigger then 127, you'll overwrite God knows what}
{   so that's NOT recommended :-) }

</i></font><font color="#FF0000"><b>Begin
  Case </b></font>Size <font color="#FF0000"><b>Of
    </b></font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">: </font>Buffer <font color="#000080">:= </font>OldAdr<font color="#000080">; </font><font color="#008000"><i>{no need to change here}
    </i></font><font color="#800000">16</font><font color="#000080">..</font><font color="#800000">127</font><font color="#000080">: </font>Buffer <font color="#000080">:= </font>NewAdr<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>BegBuf<font color="#000080">] := </font>Buffer<font color="#000080">;
  </font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>EndBuf<font color="#000080">] := </font>Buffer <font color="#000080">+ (</font><font color="#800000">2 </font><font color="#000080">* </font>Size<font color="#000080">) + </font><font color="#800000">2</font><font color="#000080">;
  </font>ClearBuffer<font color="#000080">; </font><font color="#008000"><i>{since we changed it, we must clean it up}
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetBufSize<font color="#000080">: </font>BufSize<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>GetBufSize <font color="#000080">:= ( (</font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>EndBuf<font color="#000080">] - </font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>BegBuf<font color="#000080">] ) </font><font color="#FF0000"><b>Div </b></font><font color="#800000">2</font><font color="#000080">) - </font><font color="#800000">1 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>PutBuffer <font color="#000080">(</font>stx<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#008000"><i>{ This procedure puts the given string into the keyboard-buffer. If there's
  no room in the buffer for the entire string, only part of string is copied
  (no overflow will occur, it'll simple stop copying)
}

</i></font><font color="#FF0000"><b>Var </b></font>i<font color="#000080">, </font>j<font color="#000080">, </font>avail<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#008000"><i>{avail is 0..127, so byte is enough}

</i></font><font color="#FF0000"><b>Begin
  </b></font>i <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">; </font>j <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>avail <font color="#000080">:= </font>GetBufSize<font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>i <font color="#000080">&lt;= </font>Length <font color="#000080">(</font>stx<font color="#000080">) ) </font><font color="#FF0000"><b>And </b></font><font color="#000080">(</font>i <font color="#000080">&lt; </font>Avail<font color="#000080">) </font><font color="#FF0000"><b>Do
  Begin
    </b></font>Mem <font color="#000080">[</font>Segm<font color="#000080">: </font>Buffer <font color="#000080">+ </font>j<font color="#000080">] := </font>Ord <font color="#000080">(</font>stx <font color="#000080">[</font>i<font color="#000080">] ); </font><font color="#008000"><i>{put keycode}
    </i></font>Mem <font color="#000080">[</font>Segm<font color="#000080">: </font>Buffer <font color="#000080">+ </font>j <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;          </font><font color="#008000"><i>{ignore scancode}
    </i></font>Inc <font color="#000080">(</font>i<font color="#000080">);
    </font>j <font color="#000080">:= </font>j <font color="#000080">+ </font><font color="#800000">2</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>Dec <font color="#000080">(</font>i<font color="#000080">); </font><font color="#008000"><i>{we entered i-1 keys into the stack}
  </i></font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>TailPtn<font color="#000080">] := </font>Buffer <font color="#000080">+ (</font>i <font color="#000080">* </font><font color="#800000">2</font><font color="#000080">); </font><font color="#008000"><i>{update pointer stuff}
  </i></font>MemW <font color="#000080">[</font>Segm<font color="#000080">: </font>HeadPtn<font color="#000080">] := </font>Buffer
<font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin </b></font><font color="#008000"><i>{unit}
{ since this part is auto-executed when you run your program you might wish
  to leave it out }
  </i></font>SetBufSize <font color="#000080">(</font><font color="#800000">127</font><font color="#000080">); </font><font color="#008000"><i>{set buffer to max}
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">.


</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p></body>
</html>
