<html>
<head><title> "Another Ctrl-Break Trap" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>UNIT </b></font>Break<font color="#000080">;
</font><font color="#008000"><i>{This unit traps the Ctrl-Break sequence}

</i></font><font color="#FF0000"><b>INTERFACE
USES
  </b></font>DOS<font color="#000080">;
</font><font color="#FF0000"><b>CONST
  </b></font>BrkTrapped <font color="#000080">: </font>Boolean <font color="#000080">= </font>FALSE<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>TrapCtrlBrkOn<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>TrapCtrlBrkOff<font color="#000080">;

</font><font color="#FF0000"><b>IMPLEMENTATION
CONST
  </b></font>CtrlBrkInterrupt     <font color="#000080">= </font><font color="#800000">$1B</font><font color="#000080">;
  </font>BrkTrapSet <font color="#000080">: </font>Boolean <font color="#000080">= </font>FALSE<font color="#000080">;
</font><font color="#FF0000"><b>VAR
  </b></font>OldBrkVector <font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#008000"><i>{ The following procedure is the new Ctrl-Break
  Interrupt handler. It traps the Ctrl-Break key
  sequence and setsa flag for the currently
  running program to check.  You should do any
  special processing based on this flag's value}
{$F+}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>NewCtrlBrkVector<font color="#000080">; </font>INTERRUPT<font color="#000080">;
</font><font color="#008000"><i>{$F-}
</i></font><font color="#FF0000"><b>BEGIN
  INLINE</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">); </font><font color="#008000"><i>{Clear interrupts instruction -CLI}
  {Reset bit 7 low}
  </i></font>Mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$0071</font><font color="#000080">] := </font>Mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$0071</font><font color="#000080">] </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$E</font><font color="#000080">;
  </font>BrkTrapped <font color="#000080">:= </font>TRUE<font color="#000080">;
  </font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">) </font><font color="#008000"><i>{Set interrupts instruction - STI}
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>TrapCtrlBrkOn<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font><font color="#008000"><i>{Make sure no stacked calls are possible}
  </i></font><font color="#FF0000"><b>IF NOT </b></font>BrkTrapSet <font color="#FF0000"><b>THEN
   BEGIN
    </b></font>BrkTrapSet <font color="#000080">:= </font>TRUE<font color="#000080">;
    </font>GetIntVec<font color="#000080">(</font>CtrlBrkInterrupt<font color="#000080">, </font>OldBrkVector<font color="#000080">);
    </font>SetIntVec<font color="#000080">(</font>CtrlBrkInterrupt<font color="#000080">, @</font>NewCtrlBrkVector<font color="#000080">)
   </font><font color="#FF0000"><b>END
END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>TrapCtrlBrkOff<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN </b></font><font color="#008000"><i>{Check if there is an old vector to restore}
  </i></font><font color="#FF0000"><b>IF </b></font>BrkTrapSet <font color="#FF0000"><b>THEN
    BEGIN
      </b></font>BrkTrapSet <font color="#000080">:= </font>FALSE<font color="#000080">;
      </font>SetIntVec<font color="#000080">(</font>CtrlBrkInterrupt<font color="#000080">, </font>OldBrkVector<font color="#000080">)
    </font><font color="#FF0000"><b>END
END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p></body>
</html>
