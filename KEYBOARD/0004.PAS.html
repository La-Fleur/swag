<html>
<head><title> "INT09 Keyboard handler #2" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0004.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here is my source For the keyboard handler.
}

{$X+}

</i></font><font color="#FF0000"><b>Unit </b></font>KbIO<font color="#000080">;

</font><font color="#008000"><i>(*---------------------------*) </i></font><font color="#FF0000"><b>Interface </b></font><font color="#008000"><i>(*----------------------------*)

</i></font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Var
   </b></font>KbScancode  <font color="#000080">: </font>Byte<font color="#000080">;  </font><font color="#008000"><i>{ internal Variable, can be used by host Program }
   </i></font>OldInt9Vect <font color="#000080">: </font>Pointer<font color="#000080">;  </font><font color="#008000"><i>{ For storing the old interrupt vector }

</i></font><font color="#FF0000"><b>Procedure </b></font>RestoreOldInt9<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>NewInt9<font color="#000080">; </font>Interrupt<font color="#000080">;

</font><font color="#008000"><i>(*------------------------*) </i></font><font color="#FF0000"><b>Implementation </b></font><font color="#008000"><i>(*--------------------------*)

</i></font><font color="#FF0000"><b>Procedure </b></font>RestoreOldInt9<font color="#000080">;  </font><font color="#008000"><i>{ Restores control to the old interrupt handler }
</i></font><font color="#FF0000"><b>begin
  </b></font>SetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, </font>OldInt9Vect<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$F+}
</i></font><font color="#FF0000"><b>Procedure </b></font>NewInt9<font color="#000080">; </font><font color="#008000"><i>(* Interrupt; *)
</i></font><font color="#FF0000"><b>Var
  </b></font>scancode <font color="#000080">: </font>Byte<font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>ResetKBD<font color="#000080">;
  </font><font color="#FF0000"><b>Var
    </b></font>b <font color="#000080">: </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
       </b></font>b <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">];
       </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] := </font>b <font color="#FF0000"><b>or </b></font><font color="#800000">$80</font><font color="#000080">;
       </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] := </font>b<font color="#000080">;
       </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>scancode   <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">];
  </font>KbScancode <font color="#000080">:= </font>scancode<font color="#000080">;
  </font><font color="#008000"><i>(* at this point, you could add Up, Down, Left &amp; Right Vars
     eg. if (KbScancode = 72) then Up := True;
         if (KbScancode = 72 + 128) then Up := False;
         .
         .
         .
         Don't Forget to initialize Up, Down, etc. if you use them! *)
  </i></font>ResetKBD<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}

</i></font><font color="#FF0000"><b>begin
  </b></font>GetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, </font>OldInt9Vect<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, @</font>NewInt9<font color="#000080">);
  </font>KbScancode <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#008000"><i>(*
    At this point, the Unit could install a custom Exit Procedure
    that automatically restores the old keyboard handler when the
    host Program finishes.
  *)
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
Just include this Unit in your Uses clause, and, at any time during your
Program, you can check 'KbScancode' to see which key was currently pressed or
released.  Pressed keys have values between 0..127, and released keys have a
value between 128..255.  ESC = scancode #1, so here's a sample.
}
</i></font><font color="#FF0000"><b>Function </b></font>Check4Quit <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>kbcode  <font color="#000080">: </font>Byte<font color="#000080">;
  </font>tmpBool <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>tmpBool <font color="#000080">:= </font>False<font color="#000080">;
  </font>kbcode <font color="#000080">:= </font>KbScancode<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>kbcode <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin

     Repeat
       </b></font>kbcode <font color="#000080">:= </font>KbScancode
     <font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>kbcode <font color="#000080">&lt;&gt; </font><font color="#800000">1</font><font color="#000080">);
     </font><font color="#008000"><i>(* the above line Repeats Until a different key is pressed
        or released *)

     </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>kbcode <font color="#000080">= </font><font color="#800000">129</font><font color="#000080">) </font><font color="#FF0000"><b>then
       </b></font>tmpBool <font color="#000080">:= </font>True<font color="#000080">;
     </font><font color="#008000"><i>(* if they released ESC directly after pressing it, without
        pressing or releasing any other keys, return a True value *)

  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Check4Quit <font color="#000080">:= </font>tmpBool<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{
So, basically, it's a good idea to save KbScancode in a temporary Variable
beFore doing any checks on it, as it may change if you do this:

if (KbScancode = 1) then begin
   Delay(1);
   WriteLn('You pressed key #', KbScancode);
end;

In that short Delay, they may have released the key or pressed a new one,so the
value would have changed, and the Program might screw up.

Something to add:  Boolean Variables For Up, Down, Left, and Right, For use in
games and such.  See the section in Procedure NewInt9.


Hey, Drew.  I Forgot one thing in my message about the custom KB handler.
You'll probably receive this message at the same time as the Unit I sent.
Here is the important message:

When using the KbIO Unit, at the very end of your Program, include the line
that restores the old int9 vector.  It is a Procedure called 'RestoreOldInt9'.
It may not be Absolutely essential to include this line, but if you don't
restore the old keyboard handler, you might not be able to Type anything when
the Program Exits!  (not so good, huh?)  What to do: you can install a custom
exit Procedure that restores the old int9 vector.  if you don't know how to do
this, quote these lines, or Write to me about &quot;custom Exit Procedures to
restore the old int9 vector,&quot; or something like that.  Bye For now.
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0004.PAS">Original</a><b>]</b></p></body>
</html>
