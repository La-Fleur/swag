<html>
<head><title> "Increasing Keyboard Buffer" by HORST KRAEMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0087.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 &gt; Does anyone know how to increase the size of the keyboard buffer? I need
 &gt; to be able to pump out more than 16 bytes to the buffer.

This is a resident utility I wrote myself for this purpose.

It has to be loaded in conventional memory (NOT LoadHigh) at an address lower
than $10400, preferrably immediately after Keyb.com.

One warning: there may be programs around (very old XT-programs, or bad
programs), which will try to access the keyboard buffer at it's standard
address $40:$1E. If you use one of these programs, the machine will crash.
}

{*********************************************
 * Installs keyboard buffer of any size      *
 * Usage: bigkey [bufparas]                  *
 * Bufparas: desired size of keyboard buffer *
 *           in paragraphs (16 bytes)        *
 *           default : 10 &lt;-&gt; 79 chars       *
 *                                           *
 * The size of the resident program will be  *
 * 96 bytes + buffer size.                   *
 *                                           *
 * Horst Kraemer  2:2410/121.16@fidonet.org  *
 * 30.06.92                                  *
 *********************************************}

</i></font><font color="#FF0000"><b>program </b></font>bigkey<font color="#000080">;

</font><font color="#FF0000"><b>uses
  </b></font>dos<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>PSPOffset<font color="#000080">=</font><font color="#800000">6</font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>KeyBufTail  <font color="#000080">: </font>word <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$1A</font><font color="#000080">;
  </font>KeyBufHead  <font color="#000080">: </font>word <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$1C</font><font color="#000080">;
  </font>KeyBufStart <font color="#000080">: </font>word <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$80</font><font color="#000080">;
  </font>KeyBufEnd   <font color="#000080">: </font>word <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$82</font><font color="#000080">;
  </font>EnvSeg<font color="#000080">,</font>Dist<font color="#000080">,</font>BufParas<font color="#000080">,</font>Code<font color="#000080">:</font>word<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>usage<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>writeln<font color="#000080">(</font><font color="#800000">'Usage: bigkey [bufparas]'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'bufparas: size of buffer in paragraphs (&gt;2)'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'          default : 10 &lt;-&gt; 79 chars'</font><font color="#000080">);
  </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  if </b></font>paramcount<font color="#000080">&gt;</font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font>Usage<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>paramcount<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>BufParas<font color="#000080">:=</font><font color="#800000">10
  </font><font color="#FF0000"><b>else begin
    </b></font>val<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">),</font>BufParas<font color="#000080">,</font>Code<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Code<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>BufParas<font color="#000080">&lt;=</font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Usage
  <font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>Dist<font color="#000080">:=</font>prefixseg<font color="#000080">+</font>PSPOffset<font color="#000080">-</font><font color="#800000">$40</font><font color="#000080">; </font><font color="#008000"><i>{Distance BIOS segment &lt;-&gt; start of buffer}

  </i></font><font color="#FF0000"><b>if </b></font>Dist<font color="#000080">+</font>BufParas <font color="#000080">&gt;= </font><font color="#800000">$1000 </font><font color="#FF0000"><b>then begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'End of buffer not in BIOS segment'</font><font color="#000080">);
    </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
  </font><font color="#FF0000"><b>end
  else
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Buffer for '</font><font color="#000080">,</font>BufParas<font color="#000080">*</font><font color="#800000">8</font><font color="#000080">-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">' characters installed'</font><font color="#000080">);

  </font>Dist<font color="#000080">:=</font>Dist <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">; </font><font color="#008000"><i>{Offset of buffer relative to BIOS segment}

  </i></font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">cli </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>KeyBufTail  <font color="#000080">:= </font>Dist<font color="#000080">;
  </font>KeyBufHead  <font color="#000080">:= </font>Dist<font color="#000080">;
  </font>KeyBufStart <font color="#000080">:= </font>Dist<font color="#000080">;
  </font>KeyBufEnd   <font color="#000080">:= </font>Dist <font color="#000080">+ </font>BufParas <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">sti </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Free environment and leave only
    keyboard buffer in memory
  }
  </i></font>swapvectors<font color="#000080">;
  </font>envseg<font color="#000080">:=</font>memw<font color="#000080">[</font>prefixseg<font color="#000080">:</font><font color="#800000">$2c</font><font color="#000080">];
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov es,envseg
    mov ah,49h
    int 21h
    mov dx,PSPOffset
    add dx,BufParas
    mov ax,3100h
    int 21h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0087.PAS">Original</a><b>]</b></p></body>
</html>
