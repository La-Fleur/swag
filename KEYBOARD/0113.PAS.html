<html>
<head><title> "Read Multiple Keys" by SCOTT TUNSTALL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0113.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Unit for reading multiple keys... works brilliantly, 
although I (Scott Tunstall) didn't write it, I think it was
Lou Duchez. Thanks Lou!
}

</i></font><font color="#FF0000"><b>Unit </b></font>NWKBDINT <font color="#000080">;         

</font><font color="#FF0000"><b>Interface
Procedure </b></font>HookKeyBoardInt<font color="#000080">;              </font><font color="#008000"><i>{ Take over Keyboard handler }
</i></font><font color="#FF0000"><b>Procedure </b></font>UnHookKeyBoardInt<font color="#000080">;            </font><font color="#008000"><i>{ Return control back to system }


</i></font><font color="#FF0000"><b>Var
   </b></font>KeyDown <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">127 </font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Boolean <font color="#000080">;

</font><font color="#FF0000"><b>Implementation
Uses </b></font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>Var
   </b></font>OldInt09 <font color="#000080">: </font>Pointer <font color="#000080">;
   </font>ExitSave <font color="#000080">: </font>Pointer <font color="#000080">;




</font><font color="#008000"><i>{$F+}


</i></font><font color="#FF0000"><b>procedure </b></font>Newint09<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;       </font><font color="#008000"><i>{ new keyboard handler }
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">push ax                           </font><font color="#008000"><i>{ push registers }
    </i></font><font color="#FF00FF">push bx
    push ds
    mov ax, SEG @Data
    mov ds, ax
    in  al, 60h
    mov bx, ax
    and bx, 007fh                     </font><font color="#008000"><i>{ switch high bit of BX to zero }
    </i></font><font color="#FF00FF">and al, 80h                       </font><font color="#008000"><i>{ check high bit of port value }
    </i></font><font color="#FF00FF">jz @press
    @release:                         </font><font color="#008000"><i>{ high bit = 1: &quot;release&quot; code }
    </i></font><font color="#FF00FF">mov byte ptr keydown[bx], 00h     </font><font color="#008000"><i>{ write 00 to &quot;down&quot; array element }
    </i></font><font color="#FF00FF">jmp @done
    @press:                           </font><font color="#008000"><i>{ high bit = 0: &quot;press&quot; code }
    </i></font><font color="#FF00FF">mov byte ptr keydown[bx], 01h     </font><font color="#008000"><i>{ write 01 to &quot;down&quot; array element }
    </i></font><font color="#FF00FF">@done:
    in al, 61h                        </font><font color="#008000"><i>{ read port 61h, system ctrl port }
    </i></font><font color="#FF00FF">mov ah, al                        </font><font color="#008000"><i>{ save value to AH }
    </i></font><font color="#FF00FF">or al, 80h                        </font><font color="#008000"><i>{ set top bit to &quot;1&quot; - reset kbd }
    </i></font><font color="#FF00FF">out 61h, al                       </font><font color="#008000"><i>{ write out value to port }
    </i></font><font color="#FF00FF">xchg ah, al                       </font><font color="#008000"><i>{ put original value back into AL }
    </i></font><font color="#FF00FF">out 61h, al                       </font><font color="#008000"><i>{ rewrite original value in AL }
    </i></font><font color="#FF00FF">mov al, 20h                       </font><font color="#008000"><i>{ generate End of Interrupt }
    </i></font><font color="#FF00FF">out 20h, al
    pop ds                            </font><font color="#008000"><i>{ pop registers }
    </i></font><font color="#FF00FF">pop bx
    pop ax
    iret                              </font><font color="#008000"><i>{ return }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>Procedure </b></font>HookKeyBoardInt<font color="#000080">;            </font><font color="#008000"><i>{ Take over keyboard }
</i></font><font color="#FF0000"><b>Var </b></font>KeyCount<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
     For </b></font>KeyCount<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">127 </font><font color="#FF0000"><b>do
         </b></font>KeyDown<font color="#000080">[</font>KeyCount<font color="#000080">]:=</font>False<font color="#000080">;
     </font>GetIntVec<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">,</font>OldInt09<font color="#000080">);
     </font>SetIntVec<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">,@</font>NewInt09<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;






</font><font color="#FF0000"><b>Procedure </b></font>UnHookKeyBoardInt<font color="#000080">;          </font><font color="#008000"><i>{ Let system do hard work now }
</i></font><font color="#FF0000"><b>Begin
     </b></font>SetIntVec<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">,</font>OldInt09<font color="#000080">);
     </font>Mem<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$1c</font><font color="#000080">]:=</font>Mem<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$1a</font><font color="#000080">];      </font><font color="#008000"><i>{ Flush key buffer so
                                        there's no phantom keys }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;




</font><font color="#FF0000"><b>Begin
     </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Installing NEWKBDINT multiple key handler..'</font><font color="#000080">);

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0113.PAS">Original</a><b>]</b></p></body>
</html>
