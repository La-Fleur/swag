<html>
<head><title> "Stuffing Keyboard Buffer" by GABRIEL LAGOS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0076.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
   I found the following code in my Utils unit and repackaged into a new
   unit. It compiles and works on my PC, but as Im sure everyone will
   agree, this programming style is rather dirty! It assumes the keyboard
   buffer is in the same location in memory on every pc. I really should
   be using an interrupt but never got around to it.
   Remember that you have a limit of only 16 characters in the buffer.

   Anywayz hope it helps...

   {-----------------------------------CUT HERE------------------------}

</i></font><font color="#FF0000"><b>UNIT </b></font>KeyStuff<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Var
  </b></font>keyrec <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">16</font><font color="#000080">] </font><font color="#FF0000"><b>of
             record
               </b></font>ch <font color="#000080">,
               </font>scan <font color="#000080">: </font>char<font color="#000080">;
             </font><font color="#FF0000"><b>end absolute </b></font><font color="#800000">$0000</font><font color="#000080">:</font><font color="#800000">1054</font><font color="#000080">;
  </font>KeyPtr1<font color="#000080">: </font>byte <font color="#FF0000"><b>absolute </b></font><font color="#800000">0000</font><font color="#000080">:</font><font color="#800000">1050</font><font color="#000080">;
  </font>KeyPtr2<font color="#000080">: </font>byte <font color="#FF0000"><b>absolute </b></font><font color="#800000">0000</font><font color="#000080">:</font><font color="#800000">1052</font><font color="#000080">;

  </font><font color="#FF0000"><b>Procedure </b></font>AdvanceKeyTail<font color="#000080">;
  </font><font color="#FF0000"><b>Procedure </b></font>AdvanceKeyHead<font color="#000080">;
  </font><font color="#FF0000"><b>procedure </b></font>FlushBuffer<font color="#000080">;
  </font><font color="#FF0000"><b>procedure </b></font>StuffBufferKey<font color="#000080">(</font>ch<font color="#000080">,</font>Scan <font color="#000080">: </font>char<font color="#000080">);
  </font><font color="#FF0000"><b>procedure </b></font>StuffBuffer<font color="#000080">(</font>W<font color="#000080">:</font>word<font color="#000080">);
  </font><font color="#FF0000"><b>procedure </b></font>StuffBufferStr<font color="#000080">(</font>Str<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">);
  </font><font color="#FF0000"><b>function  </b></font>tail<font color="#000080">:</font>byte<font color="#000080">;
  </font><font color="#FF0000"><b>Function  </b></font>head<font color="#000080">:</font>byte<font color="#000080">;

</font><font color="#FF0000"><b>Implementation
uses </b></font>dos<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AdvanceKeyTail<font color="#000080">;
</font><font color="#008000"><i>{Moves the keyboard tail ptr forward}
</i></font><font color="#FF0000"><b>begin
  </b></font>inc<font color="#000080">(</font>KeyPtr1<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>keyptr1 <font color="#000080">&gt; </font><font color="#800000">60 </font><font color="#FF0000"><b>then </b></font>keyptr1 <font color="#000080">:= </font><font color="#800000">30</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AdvanceKeyHead<font color="#000080">;
</font><font color="#008000"><i>{Moves the keyboard Head ptr forward.
Turbo's KeyPressed function will now return True}
</i></font><font color="#FF0000"><b>begin
  </b></font>inc<font color="#000080">(</font>KeyPtr2<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>keyptr2 <font color="#000080">&gt; </font><font color="#800000">60 </font><font color="#FF0000"><b>then </b></font>keyptr2 <font color="#000080">:= </font><font color="#800000">30</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>FlushBuffer<font color="#000080">;
</font><font color="#008000"><i>{Clear Keyboard Buffer}
</i></font><font color="#FF0000"><b>var </b></font>Regs<font color="#000080">: </font>registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
   with </b></font>Regs <font color="#FF0000"><b>do
   begin
      </b></font>Ax <font color="#000080">:= (</font><font color="#800000">$0c </font><font color="#FF0000"><b>shl </b></font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#800000">6</font><font color="#000080">;
      </font>Dx <font color="#000080">:= </font><font color="#800000">$00ff</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Intr<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">,</font>Regs<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>StuffBufferKey<font color="#000080">(</font>ch<font color="#000080">,</font>Scan <font color="#000080">: </font>char<font color="#000080">);
</font><font color="#008000"><i>{Puts keyboard scan code directly into the buffer
Examples. #65,#0 = Simulate an 'A' being pressed
          #0,#59 = Simulate the F1 key being pressed
}
</i></font><font color="#FF0000"><b>begin
   </b></font>keyrec<font color="#000080">[</font>head<font color="#000080">].</font>ch <font color="#000080">:= </font>ch<font color="#000080">;
   </font>keyrec<font color="#000080">[</font>head<font color="#000080">].</font>scan <font color="#000080">:= </font>scan<font color="#000080">;
   </font>AdvanceKeyhead<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>StuffBuffer<font color="#000080">(</font>W<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#008000"><i>{Put Word directly into the buffer}
</i></font><font color="#FF0000"><b>begin
   </b></font>keyrec<font color="#000080">[</font>head<font color="#000080">].</font>ch <font color="#000080">:= </font>chr<font color="#000080">(</font>lo<font color="#000080">(</font>w<font color="#000080">));
   </font>keyrec<font color="#000080">[</font>head<font color="#000080">].</font>scan <font color="#000080">:= </font>chr<font color="#000080">(</font>hi<font color="#000080">(</font>w<font color="#000080">));
   </font>AdvanceKeyhead<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>StuffBufferStr<font color="#000080">(</font>Str<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#008000"><i>{Stuffs a string into the buffer. Remember the max of 16 chars.}
</i></font><font color="#FF0000"><b>var </b></font>I<font color="#000080">,</font>L <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   if </b></font>Str <font color="#000080">&lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>then
   begin
      </b></font>I <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font>L <font color="#000080">:= </font>length<font color="#000080">(</font>Str<font color="#000080">);
      </font><font color="#FF0000"><b>while </b></font>I <font color="#000080">&lt;= </font>L <font color="#FF0000"><b>do
      begin
         </b></font>StuffBuffer<font color="#000080">(</font>ord<font color="#000080">(</font>Str<font color="#000080">[</font>I<font color="#000080">]));
         </font>inc<font color="#000080">(</font>I<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Tail<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#008000"><i>{Returns number between 1 and 16 showing where tail is}
</i></font><font color="#FF0000"><b>begin
  </b></font>tail <font color="#000080">:= </font>KeyPtr1 <font color="#FF0000"><b>div </b></font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">14</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Head<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#008000"><i>{Returns number between 1 and 16 showing where head is}
</i></font><font color="#FF0000"><b>begin
  </b></font>head <font color="#000080">:= </font>KeyPtr2 <font color="#FF0000"><b>div </b></font><font color="#800000">2 </font><font color="#000080">- </font><font color="#800000">14</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

   </font><font color="#008000"><i>{-----------------------------------CUT HERE------------------------}

</i></font><font color="#000080">*********************
</font>Example <font color="#FF0000"><b>of </b></font>use<font color="#000080">...
*********************

</font><font color="#FF0000"><b>Uses </b></font>Keystuff<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>StuffBufferStr<font color="#000080">(</font><font color="#800000">'Hello There!'#13</font><font color="#000080">);
  </font>Write<font color="#000080">(</font><font color="#800000">'&gt;'</font><font color="#000080">);
  </font>Readln<font color="#000080">;
  </font>halt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0076.PAS">Original</a><b>]</b></p></body>
</html>
