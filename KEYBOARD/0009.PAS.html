<html>
<head><title> "Int 09 Support" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>UNIT </b></font>KeyIntr <font color="#000080">;  </font><font color="#008000"><i>{ support for INT 09 16 routines } { Turbo Pascal 5.5+ }

</i></font><font color="#FF0000"><b>INTERFACE

Type
   </b></font>InterruptProcedure <font color="#000080">= </font><font color="#FF0000"><b>Procedure </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Const
   </b></font>BiosDataSegment <font color="#000080">= </font><font color="#800000">$40 </font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DisableInterrupts <font color="#000080">; </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">( </font><font color="#800000">$FA </font><font color="#000080">) ;   </font><font color="#008000"><i>{ CLI }
</i></font><font color="#FF0000"><b>Procedure </b></font>EnableInterrupts <font color="#000080">;  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">( </font><font color="#800000">$FB </font><font color="#000080">) ;   </font><font color="#008000"><i>{ STI }
</i></font><font color="#FF0000"><b>Procedure </b></font>CallInterrupt<font color="#000080">( </font>P <font color="#000080">: </font>Pointer <font color="#000080">) ;

</font><font color="#FF0000"><b>Function </b></font>AltPressed <font color="#000080">: </font>Boolean <font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>ControlPressed <font color="#000080">: </font>Boolean <font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>ShiftPressed <font color="#000080">: </font>Boolean <font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EOI <font color="#000080">;                      </font><font color="#008000"><i>{ end of interrupt to 8259 }
</i></font><font color="#FF0000"><b>Function </b></font>ReadScanCode <font color="#000080">: </font>Byte <font color="#000080">;       </font><font color="#008000"><i>{ read keyboard }
</i></font><font color="#FF0000"><b>Procedure </b></font>ResetKeyboard <font color="#000080">;            </font><font color="#008000"><i>{ prepare for next key }
                                     { put key in buffer for INT 16 }
</i></font><font color="#FF0000"><b>Function </b></font>StoreKey<font color="#000080">( </font>Scan<font color="#000080">, </font>Key <font color="#000080">: </font>Byte <font color="#000080">) : </font>Boolean <font color="#000080">;

</font><font color="#FF0000"><b>IMPLEMENTATION

Type
   </b></font>TwoBytesPtr <font color="#000080">= ^</font>TwoBytes <font color="#000080">;
   </font>TwoBytes <font color="#000080">=               </font><font color="#008000"><i>{ one key in the keyboard buffer }
   </i></font><font color="#FF0000"><b>Record
      </b></font>KeyCode<font color="#000080">,
      </font>ScanCode <font color="#000080">: </font>Byte <font color="#000080">;
   </font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
   </b></font>KeyState       <font color="#000080">: </font>Word <font color="#FF0000"><b>Absolute </b></font>BiosDataSegment<font color="#000080">:</font><font color="#800000">$17 </font><font color="#000080">;
   </font>KeyBufferHead  <font color="#000080">: </font>Word <font color="#FF0000"><b>Absolute </b></font>BiosDataSegment<font color="#000080">:</font><font color="#800000">$1A </font><font color="#000080">;
   </font>KeyBufferTail  <font color="#000080">: </font>Word <font color="#FF0000"><b>Absolute </b></font>BiosDataSegment<font color="#000080">:</font><font color="#800000">$1C </font><font color="#000080">;
   </font>KeyBufferStart <font color="#000080">: </font>Word <font color="#FF0000"><b>Absolute </b></font>BiosDataSegment<font color="#000080">:</font><font color="#800000">$80 </font><font color="#000080">;
   </font>KeyBufferEnd   <font color="#000080">: </font>Word <font color="#FF0000"><b>Absolute </b></font>BiosDataSegment<font color="#000080">:</font><font color="#800000">$82 </font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>CallInterrupt<font color="#000080">( </font>P <font color="#000080">: </font>Pointer <font color="#000080">) ;
</font><font color="#FF0000"><b>Begin
   Inline</b></font><font color="#000080">( </font><font color="#800000">$9C </font><font color="#000080">) ;           </font><font color="#008000"><i>{ PUSHF }
   </i></font>InterruptProcedure<font color="#000080">(</font>P<font color="#000080">) ;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>AltPressed <font color="#000080">: </font>Boolean <font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>AltPressed <font color="#000080">:= (</font>KeyState <font color="#FF0000"><b>and </b></font><font color="#800000">8</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>ControlPressed <font color="#000080">: </font>Boolean <font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>ControlPressed <font color="#000080">:= (</font>KeyState <font color="#FF0000"><b>and </b></font><font color="#800000">4</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>ShiftPressed <font color="#000080">: </font>Boolean <font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>ShiftPressed <font color="#000080">:= (</font>KeyState <font color="#FF0000"><b>and </b></font><font color="#800000">3</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EOI <font color="#000080">;  </font><font color="#008000"><i>{ end of interrupt to 8259 interrupt controller }
</i></font><font color="#FF0000"><b>Begin
   </b></font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20 </font><font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>ReadScanCode <font color="#000080">: </font>Byte <font color="#000080">;
</font><font color="#FF0000"><b>Var
   </b></font>N <font color="#000080">: </font>Byte <font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>N <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">] ;     </font><font color="#008000"><i>{ $FF means keyboard overrun }
   </i></font>ReadScanCode <font color="#000080">:= </font>N <font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ResetKeyboard <font color="#000080">;      </font><font color="#008000"><i>{ prepare for next key }
</i></font><font color="#FF0000"><b>Var
   </b></font>N <font color="#000080">: </font>Byte <font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>N <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] ;
   </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] := (</font>N <font color="#FF0000"><b>or </b></font><font color="#800000">$80</font><font color="#000080">) ;
   </font>Port<font color="#000080">[</font><font color="#800000">$61</font><font color="#000080">] := </font>N <font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>StoreKey<font color="#000080">( </font>Scan<font color="#000080">, </font>Key <font color="#000080">: </font>Byte <font color="#000080">) : </font>Boolean <font color="#000080">;
</font><font color="#FF0000"><b>Var                </b></font><font color="#008000"><i>{ put key in buffer that INT 16 reads }
   </i></font>P <font color="#000080">: </font>TwoBytesPtr <font color="#000080">;
   </font>N <font color="#000080">: </font>Word <font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>DisableInterrupts <font color="#000080">;

   </font>N <font color="#000080">:= </font>KeyBufferTail <font color="#000080">;
   </font>P <font color="#000080">:= </font>Ptr<font color="#000080">( </font>BiosDataSegment<font color="#000080">, </font>N <font color="#000080">) ;

   </font>Inc<font color="#000080">( </font>N<font color="#000080">, </font><font color="#800000">2 </font><font color="#000080">) ;
   </font><font color="#FF0000"><b>If</b></font><font color="#000080">( </font>N <font color="#000080">= </font>KeyBufferEnd <font color="#000080">) </font><font color="#FF0000"><b>then        </b></font><font color="#008000"><i>{ end of the circular buffer }
      </i></font>N <font color="#000080">:= </font>KeyBufferStart <font color="#000080">;
   </font><font color="#FF0000"><b>If</b></font><font color="#000080">( </font>N <font color="#000080">= </font>KeyBufferHead <font color="#000080">) </font><font color="#FF0000"><b>then       </b></font><font color="#008000"><i>{ buffer full }
   </i></font><font color="#FF0000"><b>Begin
      </b></font>EnableInterrupts <font color="#000080">;
      </font>StoreKey <font color="#000080">:= </font>False <font color="#000080">;
   </font><font color="#FF0000"><b>End
   Else
   Begin
      </b></font>P<font color="#000080">^.</font>KeyCode <font color="#000080">:= </font>Key <font color="#000080">;
      </font>P<font color="#000080">^.</font>ScanCode <font color="#000080">:= </font>Scan <font color="#000080">;             </font><font color="#008000"><i>{ store key in circular buffer }
      </i></font>KeyBufferTail <font color="#000080">:= </font>N <font color="#000080">;              </font><font color="#008000"><i>{ advance tail pointer }
      </i></font>EnableInterrupts <font color="#000080">;
      </font>StoreKey <font color="#000080">:= </font>True <font color="#000080">;
   </font><font color="#FF0000"><b>End </b></font><font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;


</font><font color="#FF0000"><b>END</b></font><font color="#000080">.



</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to KEYBOARD SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p></body>
</html>
