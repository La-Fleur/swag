<html>
<head><title> "Printer Control" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to PRINTING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{      This Unit is a replacement for the Printer unit that   }
{ came with Turbo Pascal Version 4.0 and 5.0.  Its purpose is }
{ fourfold.                                                   }
{                                                             }
{ First: It will allow a user to change the printer port that }
{ the LST file is writing to on the fly.  This takes the      }
{ place of LstOutPtr and the routine on page 369 of the Turbo }
{ Pascal Version 3.0 manual.                                  }
{                                                             }
{ Second: This unit will free the programmer from the need to }
{ check to see if the printer is ready to accept characters.  }
{ If the printer is not ready, the unit will place a line on  }
{ the screen prompting the user to fix the printer and press  }
{ a key.  This process will continue until the printer is     }
{ made ready or the user Aborts or Ignores the printing       }
{ operation.  NOTE: BIOS does not return correct error codes  }
{ for Non-Existent printers or printer ports because the      }
{ printer is not there to return any error codes at all.      }
{                                                             }
{ Third: This unit will also circumvent DOS's stripping of a  }
{ Ctrl-Z ($1A, the End Of File character) when writing to the }
{ printer as an ASCII device. Ctrl-Z was usually sent as part }
{ of a graphics string to a printer.  In version 3.0 of Turbo }
{ Pascal, an ASCII device was opened in binary mode.  In      }
{ version 4.0, an ASCII device is opened in ASCII mode and    }
{ DOS thus strips a Ctrl-Z.                                   }
{                                                             }
{ Fourth: This also provides a good example of a Text file    }
{ device driver.                                              }
{ Warning: This Driver has not been tested on a non-buffered  }
{ printer, as the smallest buffer I could find was 80 chars.  }

{      Type this to a file called PRINTERR.PAS                }

{$R-}
</i></font><font color="#FF0000"><b>Unit </b></font>PrintErr<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Uses </b></font>DOS<font color="#000080">,</font>CRT<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>LST <font color="#000080">: </font>Text<font color="#000080">;                      </font><font color="#008000"><i>{ Public LST file variable }

</i></font><font color="#FF0000"><b>Procedure </b></font>SetPrinter<font color="#000080">( </font>Port<font color="#000080">:</font>Byte <font color="#000080">);
</font><font color="#008000"><i>{      SetPrinter sets the printer number to Port where Port  }
{ is 'n' in 'LPTn'.  ie.  To write to LPT1: SetPrinter(1),    }
{ for LPT2: SetPrinter(2).  SetPrinter changes the Port that  }
{ subsequent Write operations will write to.  This lets you   }
{ change the printer that you are printing to on the fly.     }

</i></font><font color="#FF0000"><b>Implementation

Function </b></font>PrinterCheck<font color="#000080">( </font>PortNum<font color="#000080">, </font>Error<font color="#000080">:</font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Pos<font color="#000080">:</font>Word<font color="#000080">):</font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Response <font color="#000080">: </font>Char<font color="#000080">;
  </font>Regs     <font color="#000080">: </font>Registers<font color="#000080">;
  </font>OldTextAttr <font color="#000080">: </font>Byte<font color="#000080">;
  </font>NewPos <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>Response <font color="#000080">:= </font><font color="#800000">'R'</font><font color="#000080">;                </font><font color="#008000"><i>{ Assume Retry              }
  </i></font>NewPos <font color="#000080">:= </font>Pos<font color="#000080">;                  </font><font color="#008000"><i>{ Assume no Error           }
  </i></font><font color="#FF0000"><b>While </b></font><font color="#000080">((</font>Error <font color="#FF0000"><b>and </b></font><font color="#800000">$29</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Response <font color="#000080">= </font><font color="#800000">'R'</font><font color="#000080">) </font><font color="#FF0000"><b>do
  Begin
    </b></font>NewPos <font color="#000080">:= </font>Pos <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;            </font><font color="#008000"><i>{ Decrement to reprint char }
    </i></font>OldTextAttr <font color="#000080">:= </font>TextAttr<font color="#000080">;      </font><font color="#008000"><i>{ Save Old Attribute        }
    </i></font>TextAttr <font color="#000080">:= </font>TextAttr <font color="#FF0000"><b>or </b></font><font color="#800000">$80</font><font color="#000080">;  </font><font color="#008000"><i>{ Turn on Blink Bit         }
    </i></font>Write<font color="#000080">( </font><font color="#800000">#13'Printer Not Ready!   ' </font><font color="#000080">);     </font><font color="#008000"><i>{ Write the user }
    </i></font>Write<font color="#000080">( </font><font color="#800000">'A) Abort, R) Retry, I) Ignore '#13 </font><font color="#000080">); </font><font color="#008000"><i>{ a message }
    </i></font>TextAttr <font color="#000080">:= </font>OldTextAttr<font color="#000080">;      </font><font color="#008000"><i>{ Restore Old Attribute     }
    </i></font>Response <font color="#000080">:= </font>Upcase<font color="#000080">( </font>Readkey <font color="#000080">);</font><font color="#008000"><i>{ Read Char and upcase it   }
    </i></font>ClrEol<font color="#000080">;                       </font><font color="#008000"><i>{ Clear Line                }
    </i></font><font color="#FF0000"><b>If </b></font>Response <font color="#000080">= </font><font color="#800000">'A' </font><font color="#FF0000"><b>then        </b></font><font color="#008000"><i>{ If Abort then exit        }
      </i></font>halt<font color="#000080">( </font><font color="#800000">160 </font><font color="#000080">);                </font><font color="#008000"><i>{ Note: Uses Exit Proc.     }
    </i></font><font color="#FF0000"><b>If </b></font>Response <font color="#000080">= </font><font color="#800000">'R' </font><font color="#FF0000"><b>then
    Begin
      </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;                 </font><font color="#008000"><i>{ Code for Check Status   }
      </i></font>Regs<font color="#000080">.</font>DX <font color="#000080">:= </font>PortNum<font color="#000080">;           </font><font color="#008000"><i>{ Printer port number -1  }
      </i></font>Intr<font color="#000080">(</font><font color="#800000">$17</font><font color="#000080">,</font>Regs<font color="#000080">);               </font><font color="#008000"><i>{ Call printer service    }
      </i></font>Error <font color="#000080">:= </font>Regs<font color="#000080">.</font>AH<font color="#000080">;             </font><font color="#008000"><i>{ save Printer Error Code }
                                    { 00000001 = Time Out     }
                                    { 00000010 = Unused       }
                                    { 00000100 = Unused       }
                                    { 00001000 = I/O Error    }
                                    { 00010000 = Selected     }
                                    { 00100000 = Out of Paper }
                                    { 01000000 = Acknowledge  }
                                    { 10000000 = Not busy     }
    </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>PrinterCheck <font color="#000080">:= </font>Response <font color="#000080">= </font><font color="#800000">'R'</font><font color="#000080">;
  </font>Pos <font color="#000080">:= </font>NewPos<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>PrinterReady<font color="#000080">(</font>PortNum<font color="#000080">:</font>Byte<font color="#000080">):</font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Ready    <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>Dummy    <font color="#000080">: </font>word<font color="#000080">;
  </font>Regs     <font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>Begin
    </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;                   </font><font color="#008000"><i>{ Code for Check Status   }
    </i></font>Regs<font color="#000080">.</font>DX <font color="#000080">:= </font>PortNum<font color="#000080">;             </font><font color="#008000"><i>{ Printer port number -1  }
    </i></font>Intr<font color="#000080">(</font><font color="#800000">$17</font><font color="#000080">,</font>Regs<font color="#000080">);                 </font><font color="#008000"><i>{ Call printer service    }
    </i></font>PrinterReady <font color="#000080">:= </font>PrinterCheck<font color="#000080">( </font>PortNum<font color="#000080">, </font>Regs<font color="#000080">.</font>AH<font color="#000080">, </font>Dummy <font color="#000080">)
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{      The following routines MUST be FAR calls because they  }
{ are called by the Read and Write routines.  (They are not   }
{ Public (in the implementation section) because they should  }
{ only be accessed by the Read and Write routines.)           }

{$F+}

{      LSTNoFunction performs a NUL operation for a Reset or  }
{ Rewrite on LST (just in case).                              }

</i></font><font color="#FF0000"><b>Function </b></font>LSTNoFunction<font color="#000080">( </font><font color="#FF0000"><b>Var </b></font>F<font color="#000080">: </font>TextRec <font color="#000080">): </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>LSTNoFunction <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                    </font><font color="#008000"><i>{ No error           }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{      LSTOutputToPrinter sends the output to the Printer     }
{ port number stored in the first byte or the UserData area   }
{ of the Text Record.                                         }

</i></font><font color="#FF0000"><b>Function </b></font>LSTOutputToPrinter<font color="#000080">( </font><font color="#FF0000"><b>Var </b></font>F<font color="#000080">: </font>TextRec <font color="#000080">): </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Regs<font color="#000080">: </font>Registers<font color="#000080">;
  </font>P <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>F <font color="#FF0000"><b>do
  Begin
    </b></font>P <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>PrinterReady<font color="#000080">( </font>F<font color="#000080">.</font>UserData<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] ) </font><font color="#FF0000"><b>Then
    While </b></font><font color="#000080">(</font>P <font color="#000080">&lt; </font>BufPos<font color="#000080">) </font><font color="#FF0000"><b>do
    Begin
      </b></font>Regs<font color="#000080">.</font>AL <font color="#000080">:= </font>Ord<font color="#000080">(</font>BufPtr<font color="#000080">^[</font>P<font color="#000080">]);
      </font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>Regs<font color="#000080">.</font>DX <font color="#000080">:= </font>UserData<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">];
      </font>Intr<font color="#000080">(</font><font color="#800000">$17</font><font color="#000080">,</font>Regs<font color="#000080">);
      </font>Inc<font color="#000080">(</font>P<font color="#000080">);
      </font><font color="#FF0000"><b>If Not </b></font>PrinterCheck<font color="#000080">( </font>F<font color="#000080">.</font>UserData<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>Regs<font color="#000080">.</font>AH<font color="#000080">, </font>P <font color="#000080">) </font><font color="#FF0000"><b>then
        </b></font>P <font color="#000080">:= </font>BufPos<font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font>BufPos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>LSTOutputToPrinter <font color="#000080">:= </font><font color="#800000">0              </font><font color="#008000"><i>{ No error           }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{$F-}

{      AssignLST both sets up the LST text file record as     }
{ would ASSIGN, and initializes it as would a RESET.  It also }
{ stores the Port number in the first Byte of the UserData    }
{ area.                                                       }

</i></font><font color="#FF0000"><b>Procedure </b></font>AssignLST<font color="#000080">( </font>Port<font color="#000080">:</font>Byte <font color="#000080">);
</font><font color="#FF0000"><b>Begin
  With </b></font>TextRec<font color="#000080">(</font>LST<font color="#000080">) </font><font color="#FF0000"><b>do
    begin
      </b></font>Handle      <font color="#000080">:= </font><font color="#800000">$FFF0</font><font color="#000080">;
      </font>Mode        <font color="#000080">:= </font>fmOutput<font color="#000080">;
      </font>BufSize     <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>Buffer<font color="#000080">);
      </font>BufPtr      <font color="#000080">:= @</font>Buffer<font color="#000080">;
      </font>BufPos      <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>OpenFunc    <font color="#000080">:= @</font>LSTNoFunction<font color="#000080">;
      </font>InOutFunc   <font color="#000080">:= @</font>LSTOutputToPrinter<font color="#000080">;
      </font>FlushFunc   <font color="#000080">:= @</font>LSTOutputToPrinter<font color="#000080">;
      </font>CloseFunc   <font color="#000080">:= @</font>LSTOutputToPrinter<font color="#000080">;
      </font>UserData<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>Port <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;  </font><font color="#008000"><i>{ We subtract one because }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                          </font><font color="#008000"><i>{ DOS Counts from zero.   }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>SetPrinter<font color="#000080">( </font>Port<font color="#000080">:</font>Byte <font color="#000080">); </font><font color="#008000"><i>{ Documented above     }
</i></font><font color="#FF0000"><b>Begin
  With </b></font>TextRec<font color="#000080">(</font>LST<font color="#000080">) </font><font color="#FF0000"><b>do
    </b></font>UserData<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>Port <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;</font><font color="#008000"><i>{ We subtract one because DOS }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;                        </font><font color="#008000"><i>{ Counts from zero.           }

</i></font><font color="#FF0000"><b>Begin  </b></font><font color="#008000"><i>{ Initialization }
  </i></font>AssignLST<font color="#000080">( </font><font color="#800000">1 </font><font color="#000080">);           </font><font color="#008000"><i>{ Call assignLST so it works  }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.                        </font><font color="#008000"><i>{ like Turbo's Printer unit   }


</i></font><font color="#000080">---------------------------------------------------------------

************ </font><font color="#FF0000"><b>Type </b></font>this <font color="#FF0000"><b>to </b></font>a Second <font color="#FF0000"><b>file </b></font><font color="#000080">************

</font><font color="#FF0000"><b>Program </b></font>Test_PrintErr_Unit<font color="#000080">;

</font><font color="#FF0000"><b>Uses </b></font>PrintErr<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Writeln<font color="#000080">(     </font><font color="#800000">'Testing...Printer #1'</font><font color="#000080">);
  </font>Writeln<font color="#000080">( </font>LST<font color="#000080">,</font><font color="#800000">'Testing...Printer #1'</font><font color="#000080">);
  </font>SetPrinter<font color="#000080">( </font><font color="#800000">1 </font><font color="#000080">);
  </font>Writeln<font color="#000080">(     </font><font color="#800000">'Testing...Same Printer'</font><font color="#000080">);
  </font>Writeln<font color="#000080">( </font>LST<font color="#000080">,</font><font color="#800000">'Testing...Same Printer'</font><font color="#000080">);
  </font>SetPrinter<font color="#000080">( </font><font color="#800000">2 </font><font color="#000080">);
  </font>Writeln<font color="#000080">(     </font><font color="#800000">'Testing...Printer #2'</font><font color="#000080">);
  </font>Writeln<font color="#000080">( </font>LST<font color="#000080">,</font><font color="#800000">'Testing...Printer #2'</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to PRINTING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p></body>
</html>
