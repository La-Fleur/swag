<html>
<head><title> "Printing from CmdLine" by GREG VIGNEAULT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to PRINTING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0005.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ The following Program, LPRINT, illustrates how to do control a    }
{ Printer directly without using the BIOS (Printers connected to    }
{ the parallel port, not serial Printers connected to an RS-232     }
{ port).                                                            }
{ LPRINT checks to see if you want to print a line from the command }
{ prompt, as in:                                                    }
{        LPRINT Hello, World!                                       }
{ If there's no command input, LPRINT checks For Characters at the  }
{ &quot;standard input,&quot; so you can print Files or directories using     }
{ redirection or piping:    LPRINT &lt; myFile.pas                     }
{                           DIR | LPRINT                            }
{ LPT1 is used. You can modify LPRINT to use another, or be able to }
{ specify which Printer via the command line (eg. /2 For LPT2,etc.) }
{ This source code is a bit cramped, to fit into one message.       }
{                                                                   }

</i></font><font color="#FF0000"><b>Program </b></font>LPRINT<font color="#000080">;
</font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">;
</font><font color="#FF0000"><b>Const
  </b></font>BusyB   <font color="#000080">=</font><font color="#800000">$80</font><font color="#000080">;                   </font><font color="#008000"><i>{ status port 'busy' bit    }
  </i></font>AckB    <font color="#000080">=</font><font color="#800000">$40</font><font color="#000080">;                   </font><font color="#008000"><i>{ status port 'ack' bit     }
</i></font><font color="#FF0000"><b>Var
  </b></font>DataP<font color="#000080">,
  </font>Strobe<font color="#000080">,
  </font>Status<font color="#000080">,                         </font><font color="#008000"><i>{ assigned lpt i/o ports    }
  </i></font>MaxWait <font color="#000080">: </font>Word<font color="#000080">;                 </font><font color="#008000"><i>{ seconds before timing out }
  </i></font>Done    <font color="#000080">: </font>Boolean<font color="#000080">;              </font><font color="#008000"><i>{ sanity clause             }
  </i></font>Reg     <font color="#000080">: </font>Registers<font color="#000080">;            </font><font color="#008000"><i>{ For Dos i/o               }
  </i></font>txtptr  <font color="#000080">: </font>Byte<font color="#000080">;                 </font><font color="#008000"><i>{ counter Byte              }

</i></font><font color="#FF0000"><b>Procedure </b></font>VerifyPrinter<font color="#000080">( </font><font color="#FF0000"><b>Var </b></font>Printer<font color="#000080">, </font>Status<font color="#000080">, </font>Strobe <font color="#000080">: </font>Word <font color="#000080">);
</font><font color="#008000"><i>{ check For presence of specified Printer - returning ports         }
</i></font><font color="#FF0000"><b>begin
  if </b></font>Printer <font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>then         </b></font><font color="#008000"><i>{ must be known     }
  </i></font><font color="#FF0000"><b>begin
    </b></font>DEC<font color="#000080">( </font>Printer <font color="#000080">);                 </font><font color="#008000"><i>{ For 0..2          }
    </i></font>Printer <font color="#000080">:= </font>MemW<font color="#000080">[</font><font color="#800000">$40 </font><font color="#000080">: (</font>Printer <font color="#000080">+ </font><font color="#800000">8 </font><font color="#000080">+ </font>Printer <font color="#000080">* </font><font color="#800000">2</font><font color="#000080">)];
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">((</font>Port<font color="#000080">[</font>Printer <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font>AckB<font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Printer <font color="#000080">:= </font><font color="#800000">0           </font><font color="#008000"><i>{ to say it's not there }
    </i></font><font color="#FF0000"><b>else
    begin
      </b></font>Status <font color="#000080">:= </font>Printer <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
      </font>Strobe <font color="#000080">:= </font>Printer <font color="#000080">+ </font><font color="#800000">2</font><font color="#000080">;
    </font><font color="#FF0000"><b>end
  end
end</b></font><font color="#000080">; </font><font color="#008000"><i>{VerifyPrinter}

</i></font><font color="#FF0000"><b>Procedure </b></font>Print<font color="#000080">( </font>DataP <font color="#000080">: </font>Word<font color="#000080">; </font>chout <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Done <font color="#000080">: </font>Boolean<font color="#000080">);
</font><font color="#008000"><i>{ send Character to Printer port, With busy timeout and feedback    }
</i></font><font color="#FF0000"><b>Var
  </b></font>WaitTime <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>Timer    <font color="#000080">: </font>LongInt <font color="#FF0000"><b>Absolute </b></font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">$046c</font><font color="#000080">;
  </font>BusyWait <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>BusyWait <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>WaitTime <font color="#000080">:= </font>Timer<font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">((</font>Port<font color="#000080">[</font>Status<font color="#000080">] </font><font color="#FF0000"><b>and </b></font>BusyB<font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>BusyWait <font color="#000080">&lt; </font>MaxWait <font color="#000080">* </font><font color="#800000">19</font><font color="#000080">) </font><font color="#FF0000"><b>do
  </b></font><font color="#008000"><i>{ wait up to MaxWait seconds For non-busy state             }
    </i></font>BusyWait <font color="#000080">:= </font>Word<font color="#000080">( </font>Timer <font color="#000080">- </font>WaitTime <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>BusyWait <font color="#000080">&gt;= (</font>MaxWait <font color="#000080">* </font><font color="#800000">19</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ Printer &quot;busy&quot; For too long? }
    </i></font>Done <font color="#000080">:= </font>False              <font color="#008000"><i>{ failed            }
  </i></font><font color="#FF0000"><b>else
  begin
    </b></font>Port<font color="#000080">[</font>DataP<font color="#000080">]  := </font>chout<font color="#000080">;     </font><font color="#008000"><i>{ send the Char data}
    </i></font>Port<font color="#000080">[</font>Strobe<font color="#000080">] := </font><font color="#800000">$0c</font><font color="#000080">;       </font><font color="#008000"><i>{ strobe it in      }
    </i></font>Port<font color="#000080">[</font>Strobe<font color="#000080">] := </font><font color="#800000">$0d</font><font color="#000080">;       </font><font color="#008000"><i>{ reset strobe      }
    </i></font>Done <font color="#000080">:= </font>True<font color="#000080">;              </font><font color="#008000"><i>{ success           }
  </i></font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{else}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Print}

</i></font><font color="#FF0000"><b>begin   </b></font><font color="#008000"><i>{LPRINT}
  </i></font>WriteLn<font color="#000080">(</font><font color="#800000">#10</font><font color="#000080">, </font><font color="#800000">'LPRINT v1.0 G.S.Vigneault'</font><font color="#000080">, </font><font color="#800000">#10</font><font color="#000080">);
  </font>DataP <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;     </font><font color="#008000"><i>{ LPT1 }
  </i></font>VerifyPrinter<font color="#000080">( </font>DataP<font color="#000080">, </font>Status<font color="#000080">, </font>Strobe <font color="#000080">);
  </font><font color="#008000"><i>{ DataP will be 0 now if requested Printer didn't respond   }
  </i></font><font color="#FF0000"><b>if </b></font>DataP <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Printer not detected!'</font><font color="#000080">,</font><font color="#800000">#10</font><font color="#000080">,</font><font color="#800000">#7</font><font color="#000080">);
    </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>MaxWait <font color="#000080">:= </font><font color="#800000">10</font><font color="#000080">;  </font><font color="#008000"><i>{ max wait 10sec before timing out lpt      }
  </i></font><font color="#FF0000"><b>if </b></font>ParamCount <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then  </b></font><font color="#008000"><i>{ no command-line input?            }
  { handle redirected and piped }
  </i></font><font color="#FF0000"><b>Repeat
    </b></font>Reg<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$b</font><font color="#000080">;   </font><font color="#008000"><i>{ to see if a Char is available     }
    </i></font>MsDos<font color="#000080">( </font>Reg <font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Reg<font color="#000080">.</font>AL <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>Reg<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;            </font><font color="#008000"><i>{ get the Char      }
      </i></font>MsDos<font color="#000080">( </font>Reg <font color="#000080">);           </font><font color="#008000"><i>{ via Dos           }
      </i></font>Print<font color="#000080">( </font>DataP<font color="#000080">, </font>Reg<font color="#000080">.</font>AL<font color="#000080">, </font>Done <font color="#000080">);</font><font color="#008000"><i>{ lprint it    }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{if}
  </i></font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Reg<font color="#000080">.</font>AL <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or not </b></font>Done
  <font color="#FF0000"><b>else    </b></font><font color="#008000"><i>{ print the command line Text }
  </i></font><font color="#FF0000"><b>begin
    </b></font>txtptr <font color="#000080">:= </font><font color="#800000">$82</font><font color="#000080">;
    </font><font color="#FF0000"><b>Repeat
      </b></font>Print<font color="#000080">( </font>DataP<font color="#000080">, </font>Mem<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font>txtptr<font color="#000080">], </font>Done <font color="#000080">);
      </font>INC<font color="#000080">( </font>txtptr <font color="#000080">);
    </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Mem<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font>txtptr<font color="#000080">] = </font><font color="#800000">13</font><font color="#000080">) </font><font color="#FF0000"><b>or not </b></font>Done<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Done <font color="#FF0000"><b>then
    </b></font>Print<font color="#000080">( </font>DataP<font color="#000080">, </font><font color="#800000">10</font><font color="#000080">, </font>Done<font color="#000080">);       </font><font color="#008000"><i>{ lf    }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{LPRINT}</i></font><font color="#000080">.
</font><font color="#008000"><i>(********************************************************************)
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to PRINTING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0005.PAS">Original</a><b>]</b></p></body>
</html>
