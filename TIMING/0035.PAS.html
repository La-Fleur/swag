<html>
<head><title> "Timer unit" by CHRIS AUSTIN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0035.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>Unit </b></font>Timer<font color="#000080">;
 </font><font color="#FF0000"><b>Interface
  Var </b></font>Int1CSave <font color="#000080">: </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;        </font><font color="#008000"><i>{Pointer to the old 1C.                  }
      </i></font>TimerCnt  <font color="#000080">: </font>Word<font color="#000080">;             </font><font color="#008000"><i>{The timer counter.                      }

</i></font><font color="#FF0000"><b>Procedure </b></font>InstallInt1C<font color="#000080">;            </font><font color="#008000"><i>{Install the interrupt routine for $1C.   }
</i></font><font color="#FF0000"><b>Procedure </b></font>RestoreInt1C<font color="#000080">;            </font><font color="#008000"><i>{Restore the original interrupt for $1C.  }
</i></font><font color="#FF0000"><b>Procedure </b></font>SetTimer<font color="#000080">(</font>SetVar <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#008000"><i>{Sets the timer to a number of ticks.     }
</i></font><font color="#FF0000"><b>Procedure </b></font>WaitTimer<font color="#000080">;               </font><font color="#008000"><i>{Waits until the timer is 0.              }
</i></font><font color="#FF0000"><b>Procedure </b></font>DLay<font color="#000080">(</font>Ticks <font color="#000080">: </font>Word<font color="#000080">);      </font><font color="#008000"><i>{Delays a number of ticks (18.2 per sec.) }
</i></font><font color="#FF0000"><b>Procedure </b></font>DLaySec<font color="#000080">(</font>Ticks <font color="#000080">: </font>Word<font color="#000080">);   </font><font color="#008000"><i>{Delays a certain # of seconds.           }
</i></font><font color="#FF0000"><b>Function </b></font>TimerDone <font color="#000080">: </font>Boolean<font color="#000080">;      </font><font color="#008000"><i>{Checks if the timer has counted down.    }
</i></font><font color="#FF0000"><b>Implementation
 Uses </b></font>CRT<font color="#000080">,
      </font>DOS<font color="#000080">;

</font><font color="#008000"><i>{$F+,S-}
</i></font><font color="#FF0000"><b>Procedure </b></font>TimerHandler<font color="#000080">;
 </font>Interrupt<font color="#000080">;
  </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Cmp   TimerCnt,0
    Jle   @Done
    Dec   TimerCnt
   @Done:
    PushF
    Call  Int1CSave
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-,S-}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetTimer<font color="#000080">(</font>SetVar <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>Begin </b></font>TimerCnt<font color="#000080">:=</font>SetVar <font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>TimerDone <font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Begin </b></font>TimerDone<font color="#000080">:=</font>TimerCnt<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">; </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>WaitTimer<font color="#000080">;
 </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">@RepLoop:
   Cmp TimerCnt,0
   Jge @RepLoop
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DLay<font color="#000080">(</font>Ticks <font color="#000080">: </font>Word<font color="#000080">);
 </font><font color="#FF0000"><b>Begin
  </b></font>TimerCnt<font color="#000080">:=</font>Ticks<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">@RepLoop:
   Cmp TimerCnt,0
   Jg @RepLoop
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DLaySec<font color="#000080">(</font>Ticks <font color="#000080">: </font>Word<font color="#000080">);
 </font><font color="#FF0000"><b>Begin
  </b></font>TimerCnt<font color="#000080">:=</font>Round<font color="#000080">(</font>Ticks<font color="#000080">*</font><font color="#800000">18.2</font><font color="#000080">);
  </font><font color="#FF0000"><b>Asm
   </b></font><font color="#FF00FF">@RepLoop:
   Cmp TimerCnt,0
   Jg @RepLoop
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>InstallInt1C<font color="#000080">;
 </font><font color="#FF0000"><b>Begin
  </b></font>GetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">,@</font>Int1CSave<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">,</font>Addr<font color="#000080">(</font>TimerHandler<font color="#000080">));
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>RestoreInt1C<font color="#000080">;
 </font><font color="#FF0000"><b>Begin
  </b></font>SetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">,@</font>Int1CSave<font color="#000080">);
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">. </font><font color="#008000"><i>{You need to call InstallInt1C; to start it and make SURE you call
RestoreInt1C; before you exit your program.}

</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0035.PAS">Original</a><b>]</b></p></body>
</html>
