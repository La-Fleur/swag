<html>
<head><title> "Super Precise Timing" by LOU DUCHEZ</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0023.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
MA&gt;generate an interrupt (int $70?) 1000 times a second.

To speed up the system timer by a factor of 2, call &quot;goosetimer(2)&quot;:
}
</i></font><font color="#FF0000"><b>procedure </b></font>goosetimer<font color="#000080">(</font>goose<font color="#000080">: </font>byte<font color="#000080">);    </font><font color="#008000"><i>{ Speed up system timer }
</i></font><font color="#FF0000"><b>var </b></font>gooseword<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>gooseword <font color="#000080">:= </font><font color="#800000">$ffff </font><font color="#FF0000"><b>div </b></font>goose<font color="#000080">;       </font><font color="#008000"><i>{ Number of oscillations between ticks }
  </i></font>port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$36</font><font color="#000080">;                   </font><font color="#008000"><i>{ Set timer at new speed }
  </i></font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>lo<font color="#000080">(</font>gooseword<font color="#000080">);
  </font>port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>hi<font color="#000080">(</font>gooseword<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{
In that procedure, you are telling the timer chip how many chip oscillations
to wait before generating a &quot;tick&quot;.  The default is to generate a &quot;tick&quot;
every 65536 cycles, or 18.2 times per second (which also works out to 65536
&quot;ticks&quot; per hour).  The drawback here is that the system clock will speed up
accordingly, as will all functions dependent on the reception of &quot;ticks&quot;.
So a useful approach is to reprogram Int $08 such that additional &quot;ticks&quot;
are not passed along to the standard system functions.  The way to
accomplish that is to generate an &quot;End of Interrupt&quot; command on all the
additional &quot;ticks&quot; instead of invoking the &quot;original&quot; Int 08h ISR.  The
&quot;End of Interrupt&quot; command is a command that, much like the STI instruction,
enables subsequent hardware interrupts to be processed.  Code is in order:
}
</i></font><font color="#FF0000"><b>var </b></font>goosefactor<font color="#000080">, </font>ticklooper<font color="#000080">, </font>cloktick<font color="#000080">: </font>byte<font color="#000080">;
    </font>oldtimint<font color="#000080">: </font><font color="#FF0000"><b>procedure</b></font><font color="#000080">;

</font><font color="#008000"><i>{ GOOSEFACTOR: the multiplication factor for the system speed
  TICKLOOPER:  loops from 0 to GOOSEFACTOR - 1, resetting itself to 0
               when it gets to GOOSEFACTOR -- used internally to determine
               which &quot;ticks&quot; get passed along
  CLOKTICK:    counts &quot;ticks&quot;; used in standardizing program timing
  OLDTIMINT:   points to &quot;original&quot; Int 08h ISR }
{--------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>tickwait<font color="#000080">(</font>time2wait<font color="#000080">: </font>byte<font color="#000080">);    </font><font color="#008000"><i>{ delay until counter reaches }
</i></font><font color="#FF0000"><b>begin                                   </b></font><font color="#008000"><i>{ certain value }
  </i></font><font color="#FF0000"><b>repeat until </b></font>cloktick <font color="#000080">&gt;= </font>time2wait<font color="#000080">;
  </font>cloktick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                        </font><font color="#008000"><i>{ reset counter }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{--------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>newtimint<font color="#000080">; </font>interrupt<font color="#000080">;   </font><font color="#008000"><i>{ new timer interrupt }
</i></font><font color="#FF0000"><b>begin
  if </b></font>ticklooper <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then          </b></font><font color="#008000"><i>{ &quot;suppress&quot; this &quot;tick&quot; }
    </i></font>port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20              </font><font color="#008000"><i>{ &quot;End-of-Interrupt&quot; command }
   </i></font><font color="#FF0000"><b>else begin
    asm </b></font><font color="#FF00FF">pushf; </font><font color="#FF0000"><b>end</b></font><font color="#000080">;               </font><font color="#008000"><i>{ call old timer interrupt }
    </i></font>oldtimint<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>inc<font color="#000080">(</font>cloktick<font color="#000080">);                  </font><font color="#008000"><i>{ update &quot;tick&quot; counter }
  </i></font>inc<font color="#000080">(</font>ticklooper<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ticklooper <font color="#000080">= </font>goosefactor <font color="#FF0000"><b>then </b></font>ticklooper <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{--------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>initnewtimint<font color="#000080">(</font>goose<font color="#000080">: </font>byte<font color="#000080">); </font><font color="#008000"><i>{ set up new timer interrupt }
</i></font><font color="#FF0000"><b>var </b></font>gooseword<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>goosetimer<font color="#000080">(</font>goose<font color="#000080">);                  </font><font color="#008000"><i>{ speed up timer }
  </i></font>goosefactor <font color="#000080">:= </font>goose<font color="#000080">;               </font><font color="#008000"><i>{ record speed increase }
  </i></font>getintvec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">, @</font>oldtimint<font color="#000080">);         </font><font color="#008000"><i>{ record location of old interrupt }
  </i></font>setintvec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">, @</font>newtimint<font color="#000080">);         </font><font color="#008000"><i>{ install new interrupt procedure }
  </i></font>cloktick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                      </font><font color="#008000"><i>{ set counter to 0 }
  </i></font>ticklooper <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                    </font><font color="#008000"><i>{ set &quot;extra tick&quot; determiner to 0 }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{--------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>setoldtimint<font color="#000080">;               </font><font color="#008000"><i>{ reset old timer }
</i></font><font color="#FF0000"><b>begin
  </b></font>setintvec<font color="#000080">(</font><font color="#800000">$08</font><font color="#000080">, @</font>oldtimint<font color="#000080">);         </font><font color="#008000"><i>{ original interrupt }
  </i></font>goosetimer<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);                      </font><font color="#008000"><i>{ original system speed }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{--------------------------------------------------------------------------}
{
To start new system timing, it's &quot;initnewtimint&quot;; to turn it off, it's
&quot;setoldtimint&quot;.  Most of the rest of that code is &quot;internal&quot;: you don't need
to worry about it.  The one procedure I haven't explained is &quot;tickwait&quot;: it
is used to standardize timing in programs from machine to machine by waiting
for a given number of &quot;ticks&quot; to have gone by before continuing.  (Unlike
&quot;Delay&quot;, &quot;tickwait&quot; monitors an interrupt-driven counter, meaning the number
of &quot;ticks&quot; is advanced even while other routines are executing.)  For
example, this loop will print a new line every 18 &quot;ticks&quot;, which are coming
at twice the normal speed:
}
</i></font>initnewtimint<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
</font>cloktick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>while not </b></font>keypressed <font color="#FF0000"><b>do begin
  </b></font>writeln<font color="#000080">(</font><font color="#800000">'18 more ticks have gone by'</font><font color="#000080">);
  </font>tickwait<font color="#000080">(</font><font color="#800000">18</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>setoldtimint<font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0023.PAS">Original</a><b>]</b></p></body>
</html>
