<html>
<head><title> "Time Code Segments" by D.J. MURDOCH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000000"> <font color="#008000"><i>{$G+,S-,R-,Q-}
 </i></font><font color="#FF0000"><b>program </b></font>timer<font color="#000080">;

 </font><font color="#008000"><i>{ Program to time short segments of code; inspired by Michael Abrash's
   Zen timer.  Donated to the public domain by D.J. Murdoch }

 </i></font><font color="#FF0000"><b>uses
   </b></font>opdos<font color="#000080">; </font><font color="#008000"><i>{ Object Professional unit, needed only for TimeMS,
            a millisecond timer. }

 </i></font><font color="#FF0000"><b>const
   </b></font>onetick <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">/</font><font color="#800000">33E6</font><font color="#000080">;  </font><font color="#008000"><i>{ This is the time in seconds for one cpu cycle.
                        I've got it set for a 33 Mhz machine. }

 { Instructions:  put your code fragment into a short routine called Segment.
   It should leave the stack unchanged, or it'll blow up when we clone it.
   It *must* have a far return at the end.  Play around with declaring it
   as an assembler procedure or not to see the cost of the TP entry and
   exit code. }

 { This example is Sean Palmer's &quot;var2 := var1 div 2&quot; replacement fragment. }

 </i></font><font color="#FF0000"><b>var
   </b></font>var1<font color="#000080">,</font>var2 <font color="#000080">: </font>integer<font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>Segment<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax,var1
    sar ax,1
    jns @S
    adc ax,0
  @S:
    mov var2,ax
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#008000"><i>{ This is the comparison TP code.  Note that it includes entry/exit code;
   play around with variations on the assembler version to make it a fair
   comparison }
 (*
 procedure Segment; far;
 begin
   var2 := var1 div 2;
 end;
 *)

 { This procedure is essential!!! Do not move it. It must follow
   Segment directly. }
 </i></font><font color="#FF0000"><b>procedure </b></font>Stop<font color="#000080">;
 </font><font color="#FF0000"><b>begin
 end</b></font><font color="#000080">;

 </font><font color="#008000"><i>{ This routine will only be called once at the beginning of the program;
   set up any variables that Segment needs }

 </i></font><font color="#FF0000"><b>procedure </b></font>Setup<font color="#000080">;
 </font><font color="#FF0000"><b>begin
   </b></font>var1 <font color="#000080">:= </font><font color="#800000">5</font><font color="#000080">;
   </font>writeln<font color="#000080">(</font><font color="#800000">'This run, var1='</font><font color="#000080">,</font>var1<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>const
   </b></font>maxsize<font color="#000080">=</font><font color="#800000">65520</font><font color="#000080">;
   </font>RETF   <font color="#000080">= </font><font color="#800000">$CB</font><font color="#000080">;
 </font><font color="#FF0000"><b>var
   </b></font>p <font color="#000080">: </font>pointer<font color="#000080">;
   </font>src<font color="#000080">,</font>dest <font color="#000080">: ^</font>byte<font color="#000080">;
   </font>size <font color="#000080">: </font>word<font color="#000080">;
   </font>repeats <font color="#000080">: </font>word<font color="#000080">;
   </font>i <font color="#000080">: </font>word<font color="#000080">;
   </font>start<font color="#000080">,</font>finish <font color="#000080">: </font>longint<font color="#000080">;
   </font>count <font color="#000080">: </font>longint<font color="#000080">;
   </font>main<font color="#000080">,</font>overhead<font color="#000080">,</font>millisecs <font color="#000080">: </font>real<font color="#000080">;
 </font><font color="#FF0000"><b>begin

   </b></font>setup<font color="#000080">;

   </font><font color="#008000"><i>{ Get a segment of memory, and fill it up with as many copies
     of the segment as possible }

   </i></font>size <font color="#000080">:= </font>ofs<font color="#000080">(</font>stop<font color="#000080">) - </font>ofs<font color="#000080">(</font>Segment<font color="#000080">) -</font><font color="#800000">1</font><font color="#000080">;
   </font>repeats <font color="#000080">:= </font>maxsize <font color="#FF0000"><b>div </b></font>size<font color="#000080">;
   </font>getmem<font color="#000080">(</font>p<font color="#000080">, </font>size<font color="#000080">*</font>repeats <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
   </font>src <font color="#000080">:= @</font>Segment<font color="#000080">;
   </font>dest <font color="#000080">:= </font>p<font color="#000080">;
   </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>repeats <font color="#FF0000"><b>do
   begin
     </b></font>move<font color="#000080">(</font>src<font color="#000080">^,</font>dest<font color="#000080">^,</font>size<font color="#000080">);
     </font>inc<font color="#000080">(</font>dest<font color="#000080">,</font>size<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#008000"><i>{ Add a final RETF at the end. }
   </i></font>dest<font color="#000080">^ := </font>RETF<font color="#000080">;

   </font><font color="#008000"><i>{ Now do the timing.  Keep repeating one second loops indefinitely. }

   </i></font>writeln<font color="#000080">(</font><font color="#800000">' Bytes     Clocks       ns       MIPS'</font><font color="#000080">);
   </font><font color="#FF0000"><b>repeat
     </b></font><font color="#008000"><i>{ First loop:  one second worth of calls to the segment }
     </i></font>start <font color="#000080">:= </font>timems<font color="#000080">;
     </font>count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
     </font><font color="#FF0000"><b>repeat
       asm
         </b></font><font color="#FF00FF">call dword ptr p
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
       </font>finish <font color="#000080">:= </font>timems<font color="#000080">;
       </font>inc<font color="#000080">(</font>count<font color="#000080">);
     </font><font color="#FF0000"><b>until </b></font>finish <font color="#000080">&gt; </font><font color="#800000">1000</font><font color="#000080">+</font>start<font color="#000080">;
     </font>main <font color="#000080">:= (</font>finish <font color="#000080">- </font>start<font color="#000080">)/</font>repeats<font color="#000080">/</font>count<font color="#000080">;

     </font><font color="#008000"><i>{ Second loop:  1/2 second worth of calls to the RETF }
     </i></font>start <font color="#000080">:= </font>timems<font color="#000080">;
     </font>count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
     </font><font color="#FF0000"><b>repeat
       asm
         </b></font><font color="#FF00FF">call dword ptr dest
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
       </font>finish <font color="#000080">:= </font>timems<font color="#000080">;
       </font>inc<font color="#000080">(</font>count<font color="#000080">);
     </font><font color="#FF0000"><b>until </b></font>finish <font color="#000080">&gt; </font><font color="#800000">500</font><font color="#000080">+</font>start<font color="#000080">;
     </font>overhead <font color="#000080">:= (</font>finish<font color="#000080">-</font>start<font color="#000080">)/</font>count<font color="#000080">;
     </font>millisecs <font color="#000080">:= (</font>main<font color="#000080">-</font>overhead<font color="#000080">/</font>repeats<font color="#000080">);
     </font>writeln<font color="#000080">(</font>size<font color="#000080">:</font><font color="#800000">6</font><font color="#000080">,</font>millisecs<font color="#000080">/</font><font color="#800000">1000</font><font color="#000080">/</font>onetick<font color="#000080">:</font><font color="#800000">11</font><font color="#000080">:</font><font color="#800000">1</font><font color="#000080">,
                    </font><font color="#800000">1.e6</font><font color="#000080">*</font>millisecs<font color="#000080">:</font><font color="#800000">11</font><font color="#000080">:</font><font color="#800000">0</font><font color="#000080">,
                    </font><font color="#800000">1</font><font color="#000080">/</font>millisecs<font color="#000080">/</font><font color="#800000">1000</font><font color="#000080">:</font><font color="#800000">11</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">);
   </font><font color="#FF0000"><b>until </b></font>false<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">.


--- </font>Msg V3<font color="#000080">.</font><font color="#800000">2
 </font><font color="#000080">* </font>Origin<font color="#000080">: </font>Murdoch<font color="#800000">'s Point, Kingston, Ont, Canada  - -   (1:249/99.5)
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p></body>
</html>
