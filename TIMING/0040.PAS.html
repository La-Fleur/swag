<html>
<head><title> "Re: Hardware delays on all Platforms" by CIPHER@IAP.NET.AU</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0040.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;The hardware requires several types of simple 'wait' delay from about
&gt;100us through to 100's of ms. Currently this is done using a
&gt;software-calibrated technique and count loops, but a (say) 10ms delay is
&gt;only about 5% accurate. To improve this operation, I propose to change to
&gt;the following:
&gt;
&gt;If my app is running in DOS only (real or DPMI).
&gt;------------------------------------------------
&gt;To use a standard 'timer'-based unit which is known to be solid with the
&gt;PC timer to generate delays. (Eg Turbopowers sample file).
&gt;
&gt;If my app is running as a DOS app under Windows.
&gt;------------------------------------------------
&gt;The standard 'timer'-based unit above does NOT work now - presumably
&gt;because Windows virtualises the timer. In this mode I would like my
&gt;(DOS!) app to be able to access MMSYSTEM to get at its timer services.
&gt;
&gt;
&gt;So to the questions.
&gt;1. How can a DPMI program running under windows get at (say) MMSYSTEM?
&gt;2. Is it possible for a real-mode DOS program running under windows to
&gt;get at any of these services?
&gt;

Don't know about any of that but there is a way to get at the microtimer
port on any computer above an &quot;AT&quot; here is the code }

{
In &lt;Ds2woK.CCA@cix.compulink.co.uk&gt;, bfrost@cix.compulink.co.uk (&quot;Brian Frost&quot;) writes:
&gt;Well, I've tried ReadMicroTimer and it looked promising at first. If you 
&gt;call it (in BP7 but under W95) in a simple routine to loop reading it 
&gt;until an elapsed duration is complete, it works for durations &gt; 100,000 
&gt;counts (each count is actually 0.8us I think) but if you then try 10,000 
&gt;counts it appears that the routine actually hangs around looping on 
&gt;something and times go out by a factor of 5 or so.

The code was for micro timing not for long delays you've got the interrupts
held up while it does the reads thus when the interrupt routines come 
through between calls they upset the timing! For OS2 native mode you can use the following code on a compiler such as speed or Virtual Pascal

{$IFNDEF OS2}                                         { Non OS2 version }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ReadMicroTimer<font color="#000080">: </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM  </b></font><font color="#008000"><i>{ Read the system timer With 1 microsecond resolution }
   </i></font><font color="#FF00FF">CLI;                                               </font><font color="#008000"><i>{ Disable interrupts }
   </i></font><font color="#FF00FF">MOV AL, 0AH;                                       </font><font color="#008000"><i>{ Set irr address }
   </i></font><font color="#FF00FF">OUT 20H, AL;                                       </font><font color="#008000"><i>{ Ask to read irr }
   </i></font><font color="#FF00FF">MOV AL, 00H;                                       </font><font color="#008000"><i>{ Value to set timer }
   </i></font><font color="#FF00FF">OUT 43H, AL;                                       </font><font color="#008000"><i>{ Set timer 0 latch }
   </i></font><font color="#FF00FF">IN AL, DX;                                         </font><font color="#008000"><i>{ Read irr value }
   </i></font><font color="#FF00FF">MOV DI, AX;                                        </font><font color="#008000"><i>{ Save value in DI }
   </i></font><font color="#FF00FF">IN AL, 40H;                                        </font><font color="#008000"><i>{ Read counter value }
   </i></font><font color="#FF00FF">MOV BL, AL;                                        </font><font color="#008000"><i>{ LSB in BL }
   </i></font><font color="#FF00FF">IN AL, 40H;                                        </font><font color="#008000"><i>{ Read counter value }
   </i></font><font color="#FF00FF">MOV BH, AL;                                        </font><font color="#008000"><i>{ MSB in BH }
   </i></font><font color="#FF00FF">NOT BX;                                            </font><font color="#008000"><i>{ Asscending count }
   </i></font><font color="#FF00FF">IN AL, 21H;                                        </font><font color="#008000"><i>{ Read PIC imr }
   </i></font><font color="#FF00FF">MOV SI, AX;                                        </font><font color="#008000"><i>{ Save value in SI }
   </i></font><font color="#FF00FF">MOV AL, 0FFH;                                      </font><font color="#008000"><i>{ Mask all interrupts }
   </i></font><font color="#FF00FF">OUT 21H, AL;                                       </font><font color="#008000"><i>{ Stop all interrupts }
   </i></font><font color="#FF00FF">MOV AX, [Seg0040];                                 </font><font color="#008000"><i>{ Dos data segment }
   </i></font><font color="#FF00FF">MOV ES, AX;                                        </font><font color="#008000"><i>{ Set register }
   </i></font><font color="#FF00FF">MOV DX, ES:[006CH];                                </font><font color="#008000"><i>{ Read time clock }
   </i></font><font color="#FF00FF">MOV AX, SI;                                        </font><font color="#008000"><i>{ Reload PIC imr }
   </i></font><font color="#FF00FF">OUT 21H, AL;                                       </font><font color="#008000"><i>{ Restore interrupts }
   </i></font><font color="#FF00FF">STI;                                               </font><font color="#008000"><i>{ Enable interrupts }
   </i></font><font color="#FF00FF">MOV AX, DI;                                        </font><font color="#008000"><i>{ Retreive old irr }
   </i></font><font color="#FF00FF">TEST AL, 01H;                                      </font><font color="#008000"><i>{ Counter hit 0 }
   </i></font><font color="#FF00FF">JZ @@Done;                                         </font><font color="#008000"><i>{ Count complete }
   </i></font><font color="#FF00FF">CMP BX, 0FF00H;                                    </font><font color="#008000"><i>{ Counter &gt; $FFxx }
   </i></font><font color="#FF00FF">JA @@Done;                                         </font><font color="#008000"><i>{ Counter complete }
   </i></font><font color="#FF00FF">INC DX;                                            </font><font color="#008000"><i>{ Count irq request }
</i></font><font color="#FF00FF">@@Done:
   MOV AX, BX;                                        </font><font color="#008000"><i>{ Return time pulses }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}                                               { OS2 version }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>ReadMicroTimer<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>VAR </b></font>Value<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>DosQuerySysInfo<font color="#000080">(</font>qsv_Ms_Count<font color="#000080">, </font>qsv_Ms_Count<font color="#000080">,
       </font>Value<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Value<font color="#000080">));                         </font><font color="#008000"><i>{ Issue query }
   </i></font>ReadMicroTimer <font color="#000080">:= </font>Value<font color="#000080">;                           </font><font color="#008000"><i>{ Return timer }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

</i></font>Longer delays can be done <font color="#FF0000"><b>with </b></font>code like

<font color="#FF0000"><b>CONST
   </b></font>DelayCount <font color="#000080">: </font>LongInt <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;                          </font><font color="#008000"><i>{ Delay cycle counts }
   </i></font>HrtimerRate<font color="#000080">: </font>Longint <font color="#000080">= </font><font color="#800000">1193182</font><font color="#000080">;                    </font><font color="#008000"><i>{ RTC Timer rate }

{$IFNDEF OS2}                                         { Non OS2 version }
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>Delay <font color="#000080">(</font>MilliSecs<font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
   </b></font><font color="#FF00FF">CMP WORD PTR [DelayCount], 0;
   JNZ @@AlreadyInstalled;                            </font><font color="#008000"><i>{ Delay installed }
   </i></font><font color="#FF00FF">MOV AX, [Seg0040];
   MOV ES, AX;                                        </font><font color="#008000"><i>{ DOS Data segment }
   </i></font><font color="#FF00FF">MOV SI, 006CH;
   MOV AX, ES:[SI];                                   </font><font color="#008000"><i>{ Read DOS clock }
</i></font><font color="#FF00FF">@@DifferWait:
   CMP AX, ES:[SI];
   JZ @@DifferWait;                                   </font><font color="#008000"><i>{ Wait for change }
   </i></font><font color="#FF00FF">MOV AX, ES:[SI];
   MOV CX, 0FFFFH;                                    </font><font color="#008000"><i>{ Preset count }
</i></font><font color="#FF00FF">@@DifferWait1:
   CMP AX, ES:[SI];
   JNZ @@Differs;                                     </font><font color="#008000"><i>{ Wait for tick }
   </i></font><font color="#FF00FF">LOOP @@DifferWait1;
@@Differs:
   MOV AX, 0037H;
   XCHG CX, AX;                                       </font><font color="#008000"><i>{ Calculate delay }
   </i></font><font color="#FF00FF">NOT AX;
   XOR DX, DX;
   DIV CX;
   MOV WORD PTR [DelayCount], AX;                     </font><font color="#008000"><i>{ Hold delay count }
</i></font><font color="#FF00FF">@@AlreadyInstalled:
   MOV DX, [MilliSecs];                               </font><font color="#008000"><i>{ Retreive delay }
</i></font><font color="#FF00FF">@@CountLoop:
   OR DX, DX;
   JZ @@Exit;                                         </font><font color="#008000"><i>{ Zero delay exit }
   </i></font><font color="#FF00FF">XOR SI, SI;
   MOV AX, [Seg0040];                                 </font><font color="#008000"><i>{ Load address }
   </i></font><font color="#FF00FF">MOV ES, AX;
   MOV AX, ES:[SI];
   MOV CX, WORD PTR [DelayCount];                     </font><font color="#008000"><i>{ Load delay count }
</i></font><font color="#FF00FF">@@Wait2:
   CMP AX, ES:[SI];
   JNZ @@Over;
   LOOP @@Wait2;                                      </font><font color="#008000"><i>{ Wait 1ms }
</i></font><font color="#FF00FF">@@Over:
   DEC DX;
   JNZ @@CountLoop;                                   </font><font color="#008000"><i>{ Repeat 1ms delay }
</i></font><font color="#FF00FF">@@Exit:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}                                               { OS2 version }

{ Waits for next timer tick or delays 1ms }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>DelayLoop <font color="#000080">(</font>Count<font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>StartValue<font color="#000080">: </font>LongInt<font color="#000080">): </font>Longint<font color="#000080">;
</font><font color="#FF0000"><b>VAR </b></font>Value<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   Repeat
     </b></font>DosQuerySysInfo<font color="#000080">(</font>qsv_Ms_Count<font color="#000080">, </font>qsv_Ms_Count<font color="#000080">,
       </font>Value<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Value<font color="#000080">));                         </font><font color="#008000"><i>{ Get timer count }
     </i></font>Dec<font color="#000080">(</font>Count<font color="#000080">);                                      </font><font color="#008000"><i>{ Count down }
   </i></font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Value <font color="#000080">&lt;&gt; </font>StartValue<font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>Count <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">);
   </font>StartValue <font color="#000080">:= </font>Value<font color="#000080">;                               </font><font color="#008000"><i>{ Update start }
   </i></font>DelayLoop <font color="#000080">:= </font>Count<font color="#000080">;                                </font><font color="#008000"><i>{ Return result }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Calculates 1ms delay count for DelayLoop routine. }
{ CalcDelayCount is called once at startup.         }

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>CalcDelayCount<font color="#000080">;
</font><font color="#FF0000"><b>VAR </b></font>Interval<font color="#000080">, </font>StartValue<font color="#000080">, </font>Value<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>DosQuerySysInfo<font color="#000080">(</font>qsv_Timer_Interval<font color="#000080">, </font>qsv_Timer_Interval<font color="#000080">,
    </font>Interval<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Interval<font color="#000080">));                      </font><font color="#008000"><i>{  Get timer interval }
   </i></font>DosQuerySysInfo<font color="#000080">(</font>qsv_Ms_Count<font color="#000080">, </font>qsv_Ms_Count<font color="#000080">,
    </font>StartValue<font color="#000080">, </font>SizeOf<font color="#000080">(</font>StartValue<font color="#000080">));                  </font><font color="#008000"><i>{ Get timer count }
   </i></font><font color="#FF0000"><b>Repeat
     </b></font>DosQuerySysInfo<font color="#000080">(</font>qsv_Ms_Count<font color="#000080">, </font>qsv_Ms_Count<font color="#000080">,
       </font>Value<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Value<font color="#000080">));                         </font><font color="#008000"><i>{ Get timer timer }
   </i></font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Value <font color="#000080">&lt;&gt; </font>StartValue<font color="#000080">);
   </font>TenthsCount <font color="#000080">:= -</font>DelayLoop<font color="#000080">(-</font><font color="#800000">1</font><font color="#000080">, </font>Value<font color="#000080">) </font><font color="#FF0000"><b>DIV </b></font>Interval<font color="#000080">; </font><font color="#008000"><i>{ Tenths count}
   </i></font>DelayCount <font color="#000080">:= </font>TenthsCount <font color="#000080">* </font><font color="#800000">10</font><font color="#000080">;                    </font><font color="#008000"><i>{ Delay count }
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Delay <font color="#000080">(</font>MilliSecs<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>VAR </b></font>StartValue<font color="#000080">, </font>Value<font color="#000080">: </font>LongInt<font color="#000080">; </font>Count<font color="#000080">: </font>Longint<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   If </b></font><font color="#000080">(</font>DelayCount<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Then </b></font>CalcDelayCount<font color="#000080">;             </font><font color="#008000"><i>{ Calc delay count }
   </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>MilliSecs <font color="#000080">&gt;= (</font><font color="#800000">5</font><font color="#000080">*</font><font color="#800000">31</font><font color="#000080">)) </font><font color="#FF0000"><b>Then </b></font>DosSleep<font color="#000080">(</font>MilliSecs<font color="#000080">)  </font><font color="#008000"><i>{ Long delay sleep }
   </i></font><font color="#FF0000"><b>Else Begin
     </b></font>DosQuerySysInfo<font color="#000080">(</font>qsv_Ms_Count<font color="#000080">, </font>qsv_Ms_Count<font color="#000080">,
     </font>StartValue<font color="#000080">, </font>SizeOf<font color="#000080">(</font>StartValue<font color="#000080">));                 </font><font color="#008000"><i>{ Issue query }
     </i></font>Value <font color="#000080">:= </font>StartValue<font color="#000080">;                             </font><font color="#008000"><i>{ Hold start value }
     </i></font>Count <font color="#000080">:= </font>MilliSecs<font color="#000080">;                              </font><font color="#008000"><i>{ Load count }
     </i></font><font color="#FF0000"><b>Repeat
       </b></font>DelayLoop<font color="#000080">(</font>DelayCount<font color="#000080">, </font>Value<font color="#000080">);                  </font><font color="#008000"><i>{ Call delay loop }
       </i></font>Dec<font color="#000080">(</font>Count<font color="#000080">);                                    </font><font color="#008000"><i>{ 1 millisec down }
     </i></font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>Value<font color="#000080">-</font>StartValue <font color="#000080">&gt;= </font>MilliSecs<font color="#000080">) </font><font color="#FF0000"><b>OR
     </b></font><font color="#000080">(</font>Count <font color="#000080">&lt;= </font><font color="#800000">0</font><font color="#000080">);                                    </font><font color="#008000"><i>{ Delay complete }
   </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0040.PAS">Original</a><b>]</b></p></body>
</html>
