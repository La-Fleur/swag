<html>
<head><title> "New Timer Unit" by THOMAS HONORE NIELSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0030.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt;Hi, I'm looking for a timer program that will be able to calculate
&gt;consistently and accurately the processing time of a certain procedure.
&gt;The one program I've seen simply takes the times reported by Dos at the
&gt;beginning and end, and subtracts them. This program seems to report
&gt;different processing times each time I run it. Sometimes the program changes
&gt;by up to 7/10th of a second (even after the procedure being timed is run
&gt;several times and loaded into the buffer). Strangly enough, if my clock is
&gt;set to 5:00:00 before the timer prog is run, the time reported is less than
&gt;when the clock is set to 6:00:00; this happens consistently!
&gt;
&gt;Is there some other more accurate way to time my procedure?

This ought to work.
From: thn.cls@login.dknet.dk (Thomas Honore Nielsen)
}

</i></font><font color="#FF0000"><b>UNIT </b></font>Profiler<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

PROCEDURE </b></font>Start<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>Stop<font color="#000080">: </font>Real<font color="#000080">;

</font><font color="#FF0000"><b>IMPLEMENTATION

VAR
   </b></font>StartW <font color="#000080">: </font>Word<font color="#000080">;
   </font>StartM <font color="#000080">: </font>LongInt<font color="#000080">;
   </font>StopW  <font color="#000080">: </font>Word<font color="#000080">;
   </font>StopM  <font color="#000080">: </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Start<font color="#000080">;

</font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
   </b></font><font color="#FF00FF">IN     AL, 40h
   MOV    AH, AL
   IN     AL, 40h
   XCHG   AH, AL
   MOV    Word PTR StartW , AX
   MOV    BX, 40h
   MOV    ES, BX
   MOV    BX, 6Ch
   MOV    AX, ES:[BX]
   MOV    Word PTR StartM, AX
   MOV    AX, ES:[BX+2]
   MOV    Word PTR StartM+2, AX
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>Stop<font color="#000080">: </font>Real<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
     ASM
        </b></font><font color="#FF00FF">IN      AL, 40h
        MOV     AH, AL
        IN      AL, 40h
        XCHG    AH, AL
        MOV     Word PTR StopW, AX
        MOV     BX, 40h
        MOV     ES, BX
        MOV     BX, 6Ch
        MOV     AX, ES:[BX]
        MOV     Word PTR StopM, AX
        MOV     AX, ES:[BX+2]
        MOV     Word PTR StopM+2, AX
     </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>IF </b></font>StartM <font color="#000080">&lt;= </font>StopM <font color="#FF0000"><b>THEN
       </b></font>StopM<font color="#000080">:=</font>StopM<font color="#000080">-</font>StartM
     <font color="#FF0000"><b>ELSE
       </b></font>StopM<font color="#000080">:=</font><font color="#800000">1572480</font><font color="#000080">-</font>StartM<font color="#000080">+</font>StopM<font color="#000080">;
     </font><font color="#FF0000"><b>IF </b></font>StartW <font color="#000080">&lt;= </font>StopW <font color="#FF0000"><b>THEN
       </b></font>StopW<font color="#000080">:=</font>StopW<font color="#000080">-</font>StartW
     <font color="#FF0000"><b>ELSE
       </b></font>StopW<font color="#000080">:=</font><font color="#800000">65535</font><font color="#000080">-</font>StartW<font color="#000080">+</font>StopW<font color="#000080">;
     </font>Stop<font color="#000080">:=(</font>Stopm<font color="#000080">*</font><font color="#800000">65535</font><font color="#000080">+</font>StopW<font color="#000080">)/</font><font color="#800000">1193181.667</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0030.PAS">Original</a><b>]</b></p></body>
</html>
