<html>
<head><title> "Timing Functions" by TONI PERRETTA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0016.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
   &Yacute;Is there an easy way to time functions and/or procedures??  I'm trying
   &Yacute;to compare a couple functions that do the samething and I would like to
   &Yacute;time them.  I've tried using the GetTime procedure but the hundredths of
   &Yacute;seconds isn't fast enough.  Can any one help?

   I think this unit may help you:

***************************************************************************
}
</i></font><font color="#FF0000"><b>unit </b></font>tptimer<font color="#000080">;

</font><font color="#FF0000"><b>interface

procedure </b></font>cardinal<font color="#000080">(</font>l<font color="#000080">:</font>longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>result<font color="#000080">:</font>double<font color="#000080">);

</font><font color="#FF0000"><b>procedure </b></font>elapsedtime<font color="#000080">(</font>start<font color="#000080">:</font>longint<font color="#000080">; </font>stop<font color="#000080">:</font>longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>result<font color="#000080">:</font>double<font color="#000080">);
</font><font color="#008000"><i>(*Calculate time elapsed (in milliseconds) between Start and Stop*)

</i></font><font color="#FF0000"><b>procedure </b></font>initializetimer<font color="#000080">;
</font><font color="#008000"><i>(*Reprogram the timer chip to allow 1 microsecond resolution*)

</i></font><font color="#FF0000"><b>procedure </b></font>restoretimer<font color="#000080">;
</font><font color="#008000"><i>(*Restore the timer chip to its normal state*)

</i></font><font color="#FF0000"><b>function </b></font>readtimer<font color="#000080">:</font>longint<font color="#000080">;
</font><font color="#008000"><i>(*Read the timer with 1 microsecond resolution*)

</i></font><font color="#FF0000"><b>implementation
uses </b></font>dos<font color="#000080">;

</font><font color="#FF0000"><b>const
</b></font>TimerResolution<font color="#000080">=</font><font color="#800000">1193181.667</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>cardinal<font color="#000080">(</font>l<font color="#000080">:</font>longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>result<font color="#000080">:</font>double<font color="#000080">);
 </font><font color="#FF0000"><b>Begin
  if </b></font>l <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>result<font color="#000080">:= </font>l <font color="#000080">+ </font><font color="#800000">4294967296.0
    </font><font color="#FF0000"><b>else
  </b></font>result <font color="#000080">:= </font>l<font color="#000080">;
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>elapsedtime<font color="#000080">(</font>start<font color="#000080">, </font>stop<font color="#000080">:</font>longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>result<font color="#000080">:</font>double<font color="#000080">);
  </font><font color="#FF0000"><b>var </b></font>r<font color="#000080">:</font>double<font color="#000080">;
 </font><font color="#FF0000"><b>Begin
  </b></font>cardinal<font color="#000080">(</font>stop <font color="#000080">- </font>start<font color="#000080">, </font>r<font color="#000080">);
  </font>result <font color="#000080">:= (</font><font color="#800000">1000 </font><font color="#000080">* </font>r<font color="#000080">) / </font>TimerResolution<font color="#000080">;
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>initializetimer<font color="#000080">;
</font><font color="#FF0000"><b>label </b></font>NullJump1<font color="#000080">,</font>NullJump2<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>port<font color="#000080">[</font><font color="#800000">$043</font><font color="#000080">]:=</font><font color="#800000">$034</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">jmp NullJump1;
  NullJump1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>port<font color="#000080">[</font><font color="#800000">$040</font><font color="#000080">]:=</font><font color="#800000">$000</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">jmp NullJump2
  NullJump2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>port<font color="#000080">[</font><font color="#800000">$040</font><font color="#000080">]:=</font><font color="#800000">$000</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>restoretimer<font color="#000080">;
</font><font color="#FF0000"><b>label </b></font>NullJump1<font color="#000080">,</font>NullJump2<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>port<font color="#000080">[</font><font color="#800000">$043</font><font color="#000080">]:=</font><font color="#800000">$036</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">jmp NullJump1;
  NullJump1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>port<font color="#000080">[</font><font color="#800000">$040</font><font color="#000080">]:=</font><font color="#800000">$000</font><font color="#000080">;
  </font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">jmp NullJump2
  NullJump2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>port<font color="#000080">[</font><font color="#800000">$040</font><font color="#000080">]:=</font><font color="#800000">$000</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>readtimer<font color="#000080">:</font>longint<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>label </b></font>done<font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">cli             </font><font color="#008000"><i>(* Disable interrupts *)
  </i></font><font color="#FF00FF">mov  dx,020h     </font><font color="#008000"><i>(* Address PIC ocw3   *)
  </i></font><font color="#FF00FF">mov  al,00Ah     </font><font color="#008000"><i>(* Ask to read irr    *)
  </i></font><font color="#FF00FF">out  dx,al
  mov  al,00h     </font><font color="#008000"><i>(* Latch timer 0 *)
  </i></font><font color="#FF00FF">out  043h,al
  in   al,dx      </font><font color="#008000"><i>(* Read irr      *)
  </i></font><font color="#FF00FF">mov  di,ax      </font><font color="#008000"><i>(* Save it in DI *)
  </i></font><font color="#FF00FF">in   al,040h     </font><font color="#008000"><i>(* Counter --&gt; bx*)
  </i></font><font color="#FF00FF">mov  bl,al      </font><font color="#008000"><i>(* LSB in BL     *)
  </i></font><font color="#FF00FF">in   al,040h
  mov  bh,al      </font><font color="#008000"><i>(* MSB in BH     *)
  </i></font><font color="#FF00FF">not  bx         </font><font color="#008000"><i>(* Need ascending counter *)
  </i></font><font color="#FF00FF">in   al,021h     </font><font color="#008000"><i>(* Read PIC imr  *)
  </i></font><font color="#FF00FF">mov  si,ax      </font><font color="#008000"><i>(* Save it in SI *)
  </i></font><font color="#FF00FF">mov  al,00FFh    </font><font color="#008000"><i>(* Mask all interrupts *)
  </i></font><font color="#FF00FF">out  021h,al
  mov  ax,040h     </font><font color="#008000"><i>(* read low word of time *)
  </i></font><font color="#FF00FF">mov  es,ax      </font><font color="#008000"><i>(* from BIOS data area   *)
  </i></font><font color="#FF00FF">mov  dx,es:[06Ch]
  mov  ax,si      </font><font color="#008000"><i>(* Restore imr from SI   *)
  </i></font><font color="#FF00FF">out  021h,al
  sti             </font><font color="#008000"><i>(* Enable interrupts *)
  </i></font><font color="#FF00FF">mov  ax,di      </font><font color="#008000"><i>(* Retrieve old irr  *)
  </i></font><font color="#FF00FF">test al,001h     </font><font color="#008000"><i>(* Counter hit 0?    *)
  </i></font><font color="#FF00FF">jz   done       </font><font color="#008000"><i>(* Jump if not       *)
  </i></font><font color="#FF00FF">cmp  bx,0FFh     </font><font color="#008000"><i>(* Counter &gt; 0x0FF?    *)
  </i></font><font color="#FF00FF">ja   done       </font><font color="#008000"><i>(* Done if so        *)
  </i></font><font color="#FF00FF">inc  dx         </font><font color="#008000"><i>(* Else count int req. *)
</i></font><font color="#FF00FF">done:
  mov ax,bx   </font><font color="#008000"><i>(* set function result *)
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

***********************************************************************

</font><font color="#FF0000"><b>and </b></font>here <font color="#FF0000"><b>is </b></font>a <font color="#FF0000"><b>program to </b></font>test the <font color="#FF0000"><b>unit</b></font><font color="#000080">:

</font><font color="#FF0000"><b>Program </b></font>TestTime<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>crt<font color="#000080">, </font>dos<font color="#000080">, </font>tptimer<font color="#000080">;
 </font><font color="#FF0000"><b>var </b></font>start_time<font color="#000080">, </font>stop_time<font color="#000080">: </font>longint<font color="#000080">;
     </font>time<font color="#000080">:</font>double<font color="#000080">;
</font><font color="#FF0000"><b>Begin
 </b></font>Clrscr<font color="#000080">;
 </font>initializetimer<font color="#000080">;
 </font>delay<font color="#000080">(</font><font color="#800000">100</font><font color="#000080">);
 </font>start_time<font color="#000080">:=</font>readtimer<font color="#000080">;
 </font>delay<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">);
 </font>stop_time<font color="#000080">:=</font>readtimer<font color="#000080">;
 </font>elapsedtime<font color="#000080">(</font>start_time<font color="#000080">, </font>stop_time<font color="#000080">, </font>time<font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'elapsed time = '</font><font color="#000080">, </font>time<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">10</font><font color="#000080">);
 </font>readln<font color="#000080">;
 </font>restoretimer<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0016.PAS">Original</a><b>]</b></p></body>
</html>
