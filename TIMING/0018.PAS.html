<html>
<head><title> "Wait Correction" by SOUTHERN SOFTWARE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0018.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{$A+,B-,E-,F-,I-,N-,O-,R-,S-,V-}

(*
FastWait               Copyright (c) 1991  Southern Software

Version 1.00 - 4/8/91

Allows PC's faster than 20 mhz (386/486) to properly use a delay
function based upon a null looping procedure such as is used in the
Turbo Pascal &quot;Delay&quot; procedure.  Wait is accurate for PC's as fast as
1,100 mhz equivalent!

USAGE: Simply place &quot;FastWait&quot; in the Uses section of your program
       and replace each occurrence of &quot;delay&quot; in your program with
       &quot;wait&quot;.

Example-
=======

     Existing program:
     ----------------
     Uses CRT;

     begin
     writeln('This program delays for 5 seconds.);
     delay(5000);
     end.

     New program:
     -----------
     Uses FastWait, CRT;                {Now also uses &quot;FastWait&quot;}

     begin
     writeln('This program delays for 5 seconds.);
     wait(5000);                        {changed &quot;delay&quot; to &quot;wait&quot;}
     end.
*)

</i></font><font color="#FF0000"><b>unit </b></font>FastWait<font color="#000080">;

  </font><font color="#008000"><i>(*   Version 1.00 - 4/8/91  *)

  {$ifdef DEBUG}
    {$D+,L+}
  {$else}
    {$D-,L-}
  {$endif}

(****************************************************************************)
 </i></font><font color="#FF0000"><b>interface
</b></font><font color="#008000"><i>(****************************************************************************)

</i></font><font color="#FF0000"><b>var
                   </b></font><font color="#008000"><i>(* Number of loops to do for 1 ms wait.                  *)
  </i></font>WaitOneMS <font color="#000080">: </font>word<font color="#000080">;

                   </font><font color="#008000"><i>(* Number of loops per timer tick.                       *)
  </i></font>LoopsPerTick <font color="#000080">: </font>longint<font color="#000080">;

                   </font><font color="#008000"><i>(* System timer, 18.2/second.                            *)
  </i></font>BIOSTick <font color="#000080">: </font>longint <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$6C</font><font color="#000080">;

                   </font><font color="#008000"><i>(* Pauses execution for &quot;ms&quot; milliseconds. *)
</i></font><font color="#FF0000"><b>procedure </b></font>Wait<font color="#000080">(</font>ms <font color="#000080">: </font>word<font color="#000080">);

</font><font color="#008000"><i>{$ifdef VER60}

                 (* This procedure is for very short timing loops ( &lt; 1ms)
                    that cannot be handled by the delay routine.

                    The variable &quot;LoopsPerTick&quot; has the number of loops
                    to do for one BIOS tick (18.2 of these/sec). If you
                    want to delay for &quot;X&quot; &aelig;s, the number of loops required
                    would be  &quot;(LoopsPerTick * X) div 54945&quot;. This will not
                    compile if you are using TP 4.0, 5.0 or 5.5 due to the
                    conditional defines. This is because it makes use of
                    the &quot;asm&quot; statement which is not available in TP
                    versions prior to 6.0. *)

 </i></font><font color="#FF0000"><b>procedure </b></font>ShortDelay<font color="#000080">(</font>NumLoops <font color="#000080">: </font>word<font color="#000080">);
  
</font><font color="#008000"><i>{$endif}


(****************************************************************************)
 </i></font><font color="#FF0000"><b>implementation
</b></font><font color="#008000"><i>(****************************************************************************)

  {$L WAIT.OBJ}

  </i></font><font color="#FF0000"><b>procedure </b></font>Wait<font color="#000080">(</font>ms <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>external</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>WaitInit<font color="#000080">; </font><font color="#FF0000"><b>external</b></font><font color="#000080">;

</font><font color="#008000"><i>{$ifdef VER60}

  </i></font><font color="#FF0000"><b>procedure </b></font>ShortDelay<font color="#000080">(</font>NumLoops <font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov  cx,NumLoops
    jcxz @@2
    xor  di,di         </font><font color="#008000"><i>(* ES:DI points to dummy address *)
    </i></font><font color="#FF00FF">mov  es,di         </font><font color="#008000"><i>(* which won't change *)
    </i></font><font color="#FF00FF">mov  al,es:[di]    </font><font color="#008000"><i>(* AL has the value there *)
   </i></font><font color="#FF00FF">@@1:
    cmp  al,es:[di]
    jne  @@2
    loop @@1
   @@2:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$endif}

</i></font><font color="#FF0000"><b>BEGIN              </b></font><font color="#008000"><i>(* Code to execute at start-up to calibrate the loop     *)
                   (* delay.                                                *)
  </i></font>WaitInit
<font color="#FF0000"><b>END</b></font><font color="#000080">.

</font><font color="#008000"><i>{ XX3402 Code to WAIT.OBJ
{ Cut and save as WAIT.XX.  Execute : XX3402 D WAIT.XX to create WAIT.OBJ }
{ ------------------   CUT HERE -------------------------- }


</i></font><font color="#000080">*</font>XX3402<font color="#000080">-</font><font color="#800000">000319</font><font color="#000080">-</font><font color="#800000">080491</font><font color="#000080">--</font><font color="#800000">72</font><font color="#000080">--</font><font color="#800000">85</font><font color="#000080">-</font><font color="#800000">45848</font><font color="#000080">--------</font>WAIT<font color="#000080">.</font>OBJ<font color="#000080">--</font><font color="#800000">1</font><font color="#000080">-</font><font color="#FF0000"><b>OF</b></font><font color="#000080">--</font><font color="#800000">1
</font>U<font color="#000080">+</font>c<font color="#000080">+</font><font color="#800000">03</font>R<font color="#000080">-</font>GJEiEJBB8cUU<font color="#000080">++++</font>J5JmMawUELBnNKpWP4Jm60<font color="#000080">-</font>KNL7nOKxi616iA145W<font color="#000080">-++</font>ECbg
gsUK03R<font color="#000080">-</font>GJEiEJBBhcU1<font color="#000080">+</font><font color="#800000">21</font>dH7M0<font color="#000080">++-</font>cW<font color="#000080">+</font>A<font color="#000080">+</font>E84IZUM<font color="#000080">+-</font><font color="#800000">2</font>F<font color="#000080">-</font>J234a<font color="#000080">+</font>Q<font color="#000080">+</font><font color="#800000">8</font><font color="#000080">++++</font>U2<font color="#000080">-</font>BNM4<font color="#000080">++</font>F1
HoF3FNU5<font color="#000080">+</font><font color="#800000">0</font>VR<font color="#000080">++</font>A<font color="#000080">-+</font>RSA4U<font color="#000080">+</font><font color="#800000">7</font>Jo37J2xCFIpH<font color="#000080">++</font>lAHoxEIp<font color="#000080">-</font><font color="#800000">3</font>IZF7Eog<font color="#000080">+</font>vt<font color="#000080">+</font>D<font color="#000080">+++</font><font color="#800000">003</font>R<font color="#000080">-</font>GJF7
HYZI8<font color="#000080">+++</font>ld<font color="#000080">+</font><font color="#800000">9</font><font color="#000080">+++</font><font color="#800000">0</font><font color="#000080">-</font><font color="#800000">3</font>R<font color="#000080">-</font>GJE6<font color="#000080">+++</font>WW<font color="#000080">+</font>E<font color="#000080">+</font>E86<font color="#000080">-</font>YO<font color="#000080">-</font>V<font color="#000080">++</font><font color="#800000">6</font><font color="#000080">++</font><font color="#800000">0</font>Mu<font color="#000080">-</font>LI0sjb1WxkqWpQ20x7o2nDz
XgQaWUK95U<font color="#000080">++</font>Wwjcrjx8RTX8<font color="#000080">+</font>U0sE<font color="#000080">+</font><font color="#800000">0</font>Ck9xg<font color="#000080">+</font><font color="#800000">9</font>bzznDG7cc37Xc3RDgaWUIaCUJp<font color="#000080">-</font>S9tEijq
i1Q<font color="#000080">+</font>YTTEck<font color="#000080">++</font>WFM0<font color="#000080">+</font>DTlck<font color="#000080">++</font>kzWQ3E124kM<font color="#000080">-+</font>QFF<font color="#000080">-</font>U20l3I4<font color="#000080">+</font>E92KUM<font color="#000080">-+</font>E88<font color="#000080">+</font>U<font color="#000080">++</font>R<font color="#000080">+++
***** </font><font color="#FF0000"><b>END OF </b></font>BLOCK <font color="#800000">1 </font><font color="#000080">*****

</font><font color="#008000"><i>{ --------------------------   CUT HERE ------------------------   }
{ TEST PROGRAM }

</i></font><font color="#FF0000"><b>program </b></font>TestWait<font color="#000080">;
</font><font color="#FF0000"><b>uses
  </b></font>crt<font color="#000080">,
  </font>FastWait<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Counter <font color="#000080">: </font>word<font color="#000080">;
  </font>jj <font color="#000080">: </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>clrscr<font color="#000080">;
  </font>HighVideo<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'           Southern Software  (c) 1991'#10</font><font color="#000080">);
  </font>LowVideo<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'This test compares the standard &quot;delay&quot; routine with our new &quot;Wait&quot;'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'procedure.  Below is the calculated number of small loops the PC goes'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'through for one millisecond delay.  If this number is above 1,191 then'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'the &quot;delay&quot; routine in the Turbo CRT unit as well as those in the'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'TurboPower Software Object Professional and Turbo Professional series'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'will yield delays that are too short.  Our &quot;wait&quot; procedure is the same'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'as the &quot;delay&quot; procedure except that it will adjust for faster machines.'</font><font color="#000080">);
  </font>writeln<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'The looping below is for 10 seconds in each case.  The seconds are shown'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'and at the end, the number of BIOS ticks is shown.  A properly calibrated'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'delay routine should be almost exactly 10 seconds long, which is 182 ticks.'</font><font color="#000080">);
  </font>writeln<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'To abort at any time, press any key.'</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">#10</font><font color="#000080">);
  </font>write<font color="#000080">(</font><font color="#800000">'The delay factor for this machine is actually '</font><font color="#000080">);
  </font>HighVideo<font color="#000080">;
  </font>writeln<font color="#000080">(</font>WaitOneMS<font color="#000080">);
  </font>LowVideo<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">#10</font><font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'10 second delays using'</font><font color="#000080">);
  </font>write<font color="#000080">(</font><font color="#800000">'    CRT unit &quot;delay&quot; : '</font><font color="#000080">);
  </font>HighVideo<font color="#000080">;
                   </font><font color="#008000"><i>(* Delay 10 seconds using the CRT unit &quot;delay&quot; routine.  *)
  </i></font>jj <font color="#000080">:= </font>BIOSTick<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
  until </b></font><font color="#000080">(</font>jj <font color="#000080">&lt;&gt; </font>BIOSTick<font color="#000080">);
  </font>jj <font color="#000080">:= </font>BIOSTick<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>Counter <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">10 </font><font color="#FF0000"><b>do 
    begin
      </b></font>delay<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">);
      </font>write<font color="#000080">(</font>Counter<font color="#000080">)
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>jj <font color="#000080">:= (</font>BIOSTick <font color="#000080">- </font>jj<font color="#000080">);
  </font>LowVideo<font color="#000080">;
  </font>write<font color="#000080">(</font><font color="#800000">'         BIOS Ticks : '</font><font color="#000080">);
  </font>HighVideo<font color="#000080">;
  </font>writeln<font color="#000080">(</font>jj<font color="#000080">);
  </font>LowVideo<font color="#000080">;
  </font>write<font color="#000080">(</font><font color="#800000">'FastWait unit &quot;wait&quot; : '</font><font color="#000080">);
  </font>HighVideo<font color="#000080">;
                   </font><font color="#008000"><i>(* Delay 10 seconds using FastWait unit &quot;wait&quot; routine.  *)
  </i></font>jj <font color="#000080">:= </font>BIOSTick<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
  until </b></font><font color="#000080">(</font>jj <font color="#000080">&lt;&gt; </font>BIOSTick<font color="#000080">);
  </font>jj <font color="#000080">:= </font>BIOSTick<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>Counter <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">10 </font><font color="#FF0000"><b>do 
    begin
      </b></font>wait<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">);
      </font>write<font color="#000080">(</font>Counter<font color="#000080">)
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>jj <font color="#000080">:= (</font>BIOSTick <font color="#000080">- </font>jj<font color="#000080">);
  </font>LowVideo<font color="#000080">;
  </font>write<font color="#000080">(</font><font color="#800000">'         BIOS Ticks : '</font><font color="#000080">);
  </font>HighVideo<font color="#000080">;
  </font>writeln<font color="#000080">(</font>jj<font color="#000080">, </font><font color="#800000">#10</font><font color="#000080">);
  </font>LowVideo<font color="#000080">;
  </font>write<font color="#000080">(</font><font color="#800000">'Press any key to end '</font><font color="#000080">);
  </font><font color="#FF0000"><b>repeat
  until </b></font>keypressed<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>keypressed <font color="#FF0000"><b>do
    </b></font>Counter <font color="#000080">:= </font>ord<font color="#000080">(</font>ReadKey<font color="#000080">);
  </font>clrscr
<font color="#FF0000"><b>END</b></font><font color="#000080">.


</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0018.PAS">Original</a><b>]</b></p></body>
</html>
