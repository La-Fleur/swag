<html>
<head><title> "Millisecond Timers" by BART BROERSMA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0033.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{

The two Units below give you a millisecond timer. Use the global variable
TimerTick for the timing e.g.
}

</i></font><font color="#FF0000"><b>program </b></font>Test<font color="#000080">;

</font><font color="#FF0000"><b>uses </b></font>timer<font color="#000080">;  </font><font color="#008000"><i>{or timer2}

</i></font><font color="#FF0000"><b>procedure </b></font>TestIt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#000080">...
  </font><font color="#008000"><i>{put code here}
  </i></font><font color="#000080">...
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>Time<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TimerTick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>TestIt<font color="#000080">;
  </font>Time <font color="#000080">:= </font>TimerTick<font color="#000080">;    :</font>Te amount <font color="#FF0000"><b>of </b></font>ms<font color="#000080">. </font>used by the <font color="#FF0000"><b>procedure </b></font>TestIt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font>Use Timer <font color="#FF0000"><b>if </b></font>your max<font color="#000080">. </font>time <font color="#000080">&lt; </font><font color="#800000">$FFFF </font><font color="#000080">(</font><font color="#800000">65535</font><font color="#000080">) </font>Ms<font color="#000080">, </font><font color="#FF0000"><b>else </b></font>use Timer2<font color="#000080">.



======================================================================

</font><font color="#008000"><i>{CUT HERE}

</i></font><font color="#FF0000"><b>Unit </b></font>Timer<font color="#000080">;

</font><font color="#008000"><i>{ 1 Ms timer Unit }

</i></font><font color="#FF0000"><b>InterFace

var </b></font>TimerTick<font color="#000080">: </font>Word<font color="#000080">;               </font><font color="#008000"><i>{ Global Ms counter }


</i></font><font color="#FF0000"><b>procedure </b></font>TDelay<font color="#000080">(</font>Ms<font color="#000080">: </font>Integer<font color="#000080">);     </font><font color="#008000"><i>{ Ms dealy procedure }
                                   { Resets the global TimerTick variable 
!! }


</i></font><font color="#FF0000"><b>Implementation


const </b></font>SaveInt <font color="#000080">= </font><font color="#800000">$67</font><font color="#000080">;               </font><font color="#008000"><i>{ Private constants and variables }
      </i></font>Base <font color="#000080">= </font><font color="#800000">55</font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>OldExitProc<font color="#000080">: </font>Pointer<font color="#000080">;
    </font>Counter<font color="#000080">: </font>Word<font color="#000080">;



</font><font color="#FF0000"><b>procedure </b></font>TDelay<font color="#000080">(</font>Ms<font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Ms <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font>TimerTick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat until </b></font>TimerTick <font color="#000080">&gt;= </font>Ms<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>procedure </b></font>NewTimer<font color="#000080">; </font>INTERRUPT<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm                                 
  </b></font><font color="#FF00FF">Dec Counter                      </font><font color="#008000"><i>{ Decrement counter }
  </i></font><font color="#FF00FF">CMP Counter, $00                 </font><font color="#008000"><i>{ Call old INT ? }
  </i></font><font color="#FF00FF">JNZ @@2                          
  Int SaveInt                      </font><font color="#008000"><i>{ Yes } 
  </i></font><font color="#FF00FF">MOV Counter, Base;               </font><font color="#008000"><i>{ Restore counter }
  </i></font><font color="#FF00FF">JMP @@3
@@2:
  MOV AL, $20                      
  OUT $20, AL
@@3:
  Inc TimerTick                    </font><font color="#008000"><i>{ Increment Ticker }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>InitTimer<font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>Freq <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>InitialCount<font color="#000080">: </font>Word<font color="#000080">;
    </font>OldVector<font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TimerTick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);                             </font><font color="#008000"><i>{ Disable Interrrupts }
  </i></font>InitialCount <font color="#000080">:= </font><font color="#800000">1193180 </font><font color="#FF0000"><b>div </b></font>Freq<font color="#000080">;        </font><font color="#008000"><i>{ Calculate base for counter }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$36</font><font color="#000080">;                        </font><font color="#008000"><i>{ Setl mode for timerchip }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>InitialCount<font color="#000080">);           </font><font color="#008000"><i>{ Write LSB }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>InitialCount<font color="#000080">);           </font><font color="#008000"><i>{ Write MSB }
  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">, </font>OldVector<font color="#000080">);                 </font><font color="#008000"><i>{ Get Old IntVec }
  </i></font>SetIntVec<font color="#000080">(</font>SaveInt<font color="#000080">,</font>OldVector<font color="#000080">);            </font><font color="#008000"><i>{ Int 8 now saved in OldVector }
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">, @</font>NewTimer<font color="#000080">);                 </font><font color="#008000"><i>{ New Int Handler }
  </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);                             </font><font color="#008000"><i>{ Enable Interrupts }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;




</font><font color="#FF0000"><b>procedure </b></font>SaveExitProc<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>OldVector<font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);                             
  </font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$36</font><font color="#000080">;                        </font><font color="#008000"><i>{ Restore old interrupts and }
  </i></font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$FF</font><font color="#000080">;
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$FF</font><font color="#000080">;
  </font>GetIntVec<font color="#000080">(</font>SaveInt<font color="#000080">, </font>OldVector<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">, </font>OldVector<font color="#000080">);
  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);
  </font>ExitProc <font color="#000080">:= </font>OldExitProc<font color="#000080">;                 </font><font color="#008000"><i>{ Restore old ExitProc }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin
  </b></font>OldExitProc <font color="#000080">:=</font>ExitProc<font color="#000080">;                  </font><font color="#008000"><i>{ Save ExitProcedure }
  </i></font>ExitProc <font color="#000080">:= @</font>SaveExitProc<font color="#000080">;               </font><font color="#008000"><i>{ Install our ExitProcedure }
  </i></font>InitTimer<font color="#000080">;                               </font><font color="#008000"><i>{ Install new Int Handler }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.



======================================================================

</font><font color="#FF0000"><b>Unit </b></font>Timer2<font color="#000080">;

</font><font color="#008000"><i>{ 1 Ms timer Unit }

</i></font><font color="#FF0000"><b>InterFace

var </b></font>TimerTick<font color="#000080">: </font>LongInt<font color="#000080">;    


</font><font color="#FF0000"><b>procedure </b></font>TDelay<font color="#000080">(</font>Ms<font color="#000080">: </font>LongInt<font color="#000080">); 


</font><font color="#FF0000"><b>Implementation

Uses </b></font>Dos<font color="#000080">;                 </font><font color="#008000"><i>{ For the Registers type used in NewTimer }

</i></font><font color="#FF0000"><b>const </b></font>SaveInt <font color="#000080">= </font><font color="#800000">$67</font><font color="#000080">;     
      </font>Base <font color="#000080">= </font><font color="#800000">55</font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>OldExitProc<font color="#000080">: </font>Pointer<font color="#000080">;
    </font>Counter<font color="#000080">: </font>Word<font color="#000080">;
    </font>DTick<font color="#000080">: </font>LongInt<font color="#000080">;     


</font><font color="#FF0000"><b>procedure </b></font>TDelay<font color="#000080">(</font>Ms<font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>Ms <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font>DTick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat until </b></font>DTick <font color="#000080">&gt;= </font>Ms<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>procedure </b></font>NewTimer<font color="#000080">; </font>INTERRUPT<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>R<font color="#000080">: </font>Registers<font color="#000080">;                    
</font><font color="#FF0000"><b>begin
  </b></font>Dec<font color="#000080">(</font>Counter<font color="#000080">);                  
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Counter <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin                
    </b></font>Intr<font color="#000080">(</font>SaveInt<font color="#000080">,</font>R<font color="#000080">);   
    </font>Counter <font color="#000080">:= </font>Base<font color="#000080">;
  </font><font color="#FF0000"><b>end
  Else </b></font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">] := </font><font color="#800000">$20</font><font color="#000080">;
  </font>Inc<font color="#000080">(</font>TimerTick<font color="#000080">);       
  </font>Inc<font color="#000080">(</font>DTick<font color="#000080">);           
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>InitTimer<font color="#000080">;
</font><font color="#FF0000"><b>const </b></font>Freq <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>InitialCount<font color="#000080">: </font>Word<font color="#000080">;
    </font>OldVector<font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TimerTick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>DTick <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);
  </font>InitialCount <font color="#000080">:= </font><font color="#800000">1193180 </font><font color="#FF0000"><b>div </b></font>Freq<font color="#000080">;     
  </font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$36</font><font color="#000080">;                     
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>Lo<font color="#000080">(</font>InitialCount<font color="#000080">);        
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font>Hi<font color="#000080">(</font>InitialCount<font color="#000080">);        
  </font>GetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">, </font>OldVector<font color="#000080">);              
  </font>SetIntVec<font color="#000080">(</font>SaveInt<font color="#000080">,</font>OldVector<font color="#000080">);         
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">, @</font>NewTimer<font color="#000080">);              
  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);                          
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;




</font><font color="#FF0000"><b>procedure </b></font>SaveExitProc<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>OldVector<font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);                        
  </font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$36</font><font color="#000080">;                   
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$FF</font><font color="#000080">;                   
  </font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$FF</font><font color="#000080">;                   
  </font>GetIntVec<font color="#000080">(</font>SaveInt<font color="#000080">, </font>OldVector<font color="#000080">);      
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">, </font>OldVector<font color="#000080">);            
  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);                        
  </font>ExitProc <font color="#000080">:= </font>OldExitProc<font color="#000080">;            
</font>ExitProc <font color="#000080">}
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>begin
  </b></font>OldExitProc <font color="#000080">:=</font>ExitProc<font color="#000080">;
  </font>ExitProc <font color="#000080">:= @</font>SaveExitProc<font color="#000080">;
  </font>InitTimer<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0033.PAS">Original</a><b>]</b></p></body>
</html>
