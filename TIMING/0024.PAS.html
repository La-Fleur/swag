<html>
<head><title> "ASM High Resolution Timer" by JOHN O'HARROW</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Does anybody knows if there's a timer function in turbo pascal (version 5) or
&gt; turbo pascal for windows in which the user could start and stop a timer using
&gt; this function.

Here is the unit I wrote for high precision timing.  Is can be used for
timing events of up to 54 milliseconds duration accurate to a few microseconds.
Hope it helps.

From: JOHARROW@homeloan.demon.co.uk (John O'Harrow)
}
</i></font><font color="#FF0000"><b>UNIT </b></font>Timer<font color="#000080">;

</font><font color="#008000"><i>(*High Precision Timer Library for Borland Pascal, for timing operations 
  of less than 54 milliseconds duration, accurate to a few microseconds.
  Based on code originally written by Michael Abrash for his book &quot;Zen of
  Assembly language&quot;, and on Kendall Bennett's subsequent enhancements.*)

</i></font><font color="#FF0000"><b>INTERFACE

  PROCEDURE </b></font>StartTimer<font color="#000080">;          </font><font color="#008000"><i>{Start the High-Precision Timer   }
  </i></font><font color="#FF0000"><b>PROCEDURE </b></font>StopTimer <font color="#000080">;          </font><font color="#008000"><i>{Stop the High-Precision Timer    }

  </i></font><font color="#FF0000"><b>FUNCTION  </b></font>TimeTaken <font color="#000080">: </font>LongInt<font color="#000080">; </font><font color="#008000"><i>{Return Time Taken in Microseconds}
                                 {Returns -1 if Time Taken &gt; 54 mS }
</i></font><font color="#FF0000"><b>IMPLEMENTATION

VAR
  </b></font>Flags    <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Overflow <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Counter  <font color="#000080">: </font>Word<font color="#000080">;
  </font>RefCount <font color="#000080">: </font>Word<font color="#000080">;

  </font><font color="#FF0000"><b>PROCEDURE </b></font>RefOn<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">mov  al,00110100b
    out  43h,al
    db   $EB,0,$EB,0,$EB,0
    sub  al,al
    out  40h,al
    db   $EB,0,$EB,0,$EB,0
    out  40h,al
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>PROCEDURE </b></font>RefOff<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">mov  al,0
    out  43h,al
    db   $EB,0,$EB,0,$EB,0
    in   al,40h
    db   $EB,0,$EB,0,$EB,0
    mov  ah,al
    in   al,40h
    xchg ah,al
    neg  ax
    add  [RefCount],ax
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>PROCEDURE </b></font>StartTimer<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">pushf
    pop  ax
    mov  [Flags],ah
    and  ah,0fdh
    push ax
    sti
    mov  al,00110100b
    out  43h,al
    db   $EB,0,$EB,0,$EB,0
    sub  al,al
    out  40h,al
    db   $EB,0,$EB,0,$EB,0
    out  40h,al
    mov  cx,10
  @@Delay:
    Loop @@Delay
    cli
    mov  al,00110100b
    out  43h,al
    db   $EB,0,$EB,0,$EB,0
    sub  al,al
    out  40h,al
    db   $EB,0,$EB,0,$EB,0
    out  40h,al
    popf
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>PROCEDURE </b></font>StopTimer<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">pushf
    mov  al,0
    out  43h,al
    mov  al,00001010b
    out  20h,al
    db   $EB,0,$EB,0,$EB,0
    in   al,20h
    and  al,1
    mov  [Overflow],al
    sti
    in   al,40h
    db   $EB,0,$EB,0,$EB,0
    mov  ah,al
    in   al,40h
    xchg ah,al
    neg  ax
    mov  [Counter ],ax
    mov  [RefCount],0
    mov  cx,16
    cli
  @@Loop:
    call RefOn
    call RefOff
    loop @@Loop
    sti
    add  [RefCount],8
    mov  cl,4
    shr  [RefCount],cl
    pop  ax
    mov  ch,[Flags]
    and  ch,2
    and  ah,0fdh
    or   ah,ch
    push ax
    popf
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>FUNCTION </b></font>TimeTaken <font color="#000080">: </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">cmp  [Overflow],0
    jz   @@Good
    mov  ax,0FFFFh
    mov  dx,0FFFFh
    jmp  @@Done
  @@Good:
    mov  ax,[Counter ]
    sub  ax,[RefCount]
    mov  dx,8381
    mul  dx
    mov  bx,10000
    div  bx
    xor  dx,dx
  @@Done:
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0024.PAS">Original</a><b>]</b></p></body>
</html>
