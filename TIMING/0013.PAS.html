<html>
<head><title> "Setting Timing at 21Khz" by CEES BINKHORST</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
CEES BINKHORST

&gt;  Has anyone ever succeeded in setting the timer rate at a higher frequency
&gt; than 21KHz in protected mode? I've tried every possible thing, and it
Could you give details on that 21KHz? Sounds rather a high rate.

&gt; don't know whether I have enough IOPL as to make CLI and STI to work, but
Try the following:
}

{dr. dobb's 80286/386 #185}
</i></font><font color="#FF0000"><b>Function </b></font>SensitiveOK <font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">; </font><font color="#008000"><i>{sensitive instructions are: }
                                    {IN    read a port           }
                                    {OUT   Write to a port       }
                                    {INS   read a String from a port}
                                    {OUTS  Write a String to a port}
                                    {CLI   disable interrupts    }
                                    {STI   enable interrupts     }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">push  ax
  push  bx
  pushf                             </font><font color="#008000"><i>{put flags 'I/O privilege level' (IOPL)}
  </i></font><font color="#FF00FF">pop   ax                          </font><font color="#008000"><i>{ into ax }
  </i></font><font color="#FF00FF">and   ax, 3000h                   </font><font color="#008000"><i>{00110000 00000000 - mask all but iopl}
                                    {ax = 00??0000 00000000 now}
  </i></font><font color="#FF00FF">shr   ax, 12                      </font><font color="#008000"><i>{ax -&gt; 00000000 000000??}
                                    {compile With 286 instructions enabled!!}
  </i></font><font color="#FF00FF">mov   iopl, al
  mov   bx, cs                      </font><font color="#008000"><i>{current privilege level (cpl) is in cs}
  </i></font><font color="#FF00FF">and   bx, 3                       </font><font color="#008000"><i>{00000000 00000011 - mask all but cpl}
  </i></font><font color="#FF00FF">mov   cpl, bl
  cmp   bx, ax                      </font><font color="#008000"><i>{compare cpl and iopl}
  </i></font><font color="#FF00FF">ja    @not_sensitive              </font><font color="#008000"><i>{jump  if cpl &gt; iopl}
  </i></font><font color="#FF00FF">clc
  mov   @result, True               </font><font color="#008000"><i>{sensitive instructions ok}
  </i></font><font color="#FF00FF">jmp   @exit
 @not_sensitive:
  stc
  mov   @result, False              </font><font color="#008000"><i>{sensitive instructions not ok}
 </i></font><font color="#FF00FF">@exit:
  pop   bx
  pop   ax
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>PrivilegeOK<font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">; </font><font color="#008000"><i>{privileged instructions are:}
                                    {HLT   halt the processor    }
                                    {LGDT  load the GDT register }
                                    {LIDT  load the interrupt-descriptor-}
                                    {      table register        }
                                    {LLDT  load the LDT register  }
                                    {CLTS  clear the task-switched flag}
                                    {LMSW  load the MSW          }
                                    {LTR   load the task register}
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">push  ax
  mov   ax, cs                    </font><font color="#008000"><i>{cpl resides in cs}
  </i></font><font color="#FF00FF">and   ax, 3                     </font><font color="#008000"><i>{00000000 00000011 - mask all but cpl}
                                  {ax = 00000000 000000?? now}
  </i></font><font color="#FF00FF">jnz   @lbl1
  mov   @result, True             </font><font color="#008000"><i>{privileged}
  </i></font><font color="#FF00FF">jmp   @exit
 @lbl1:
  mov   @result, False            </font><font color="#008000"><i>{not privileged}
 </i></font><font color="#FF00FF">@exit:
  pop   ax
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p></body>
</html>
