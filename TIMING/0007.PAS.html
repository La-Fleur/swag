<html>
<head><title> "High Resolution Timer" by TURBOPOWER SOFTWARE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$S-,R-,I-,V-,B-}

{*********************************************************}
{*                   TPTIMER.PAS 2.00                    *}
{*                by TurboPower Software                 *}
{*********************************************************}

</i></font><font color="#FF0000"><b>Unit </b></font>TpTimer<font color="#000080">;
  </font><font color="#008000"><i>{-Allows events to be timed With 1 microsecond resolution}



</i></font><font color="#FF0000"><b>Interface
Const
  </b></font>TimerResolution <font color="#000080">= </font><font color="#800000">1193181.667</font><font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>InitializeTimer<font color="#000080">;
  </font><font color="#008000"><i>{-ReProgram the timer chip to allow 1 microsecond resolution}

</i></font><font color="#FF0000"><b>Procedure </b></font>RestoreTimer<font color="#000080">;
  </font><font color="#008000"><i>{-Restore the timer chip to its normal state}

</i></font><font color="#FF0000"><b>Function </b></font>ReadTimer <font color="#000080">: </font>LongInt<font color="#000080">;
  </font><font color="#008000"><i>{-Read the timer With 1 microsecond resolution}

</i></font><font color="#FF0000"><b>Function </b></font>ElapsedTime<font color="#000080">(</font>Start<font color="#000080">, </font>Stop <font color="#000080">: </font>LongInt<font color="#000080">) : </font>Real<font color="#000080">;
  </font><font color="#008000"><i>{-Calculate time elapsed (in milliseconds) between Start and Stop}

</i></font><font color="#FF0000"><b>Function </b></font>ElapsedTimeString<font color="#000080">(</font>Start<font color="#000080">, </font>Stop <font color="#000080">: </font>LongInt<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{-Return time elapsed (in milliseconds) between Start and Stop as a String}

  {==========================================================================}

</i></font><font color="#FF0000"><b>Implementation

Var
  </b></font>SaveExitProc <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>Delta <font color="#000080">: </font>LongInt<font color="#000080">;

  </font><font color="#FF0000"><b>Function </b></font>Cardinal<font color="#000080">(</font>L <font color="#000080">: </font>LongInt<font color="#000080">) : </font>Real<font color="#000080">;
    </font><font color="#008000"><i>{-Return the unsigned equivalent of L as a Real}
  </i></font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{Cardinal}
    </i></font><font color="#FF0000"><b>if </b></font>L <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Cardinal <font color="#000080">:= </font><font color="#800000">4294967296.0</font><font color="#000080">+</font>L
    <font color="#FF0000"><b>else
      </b></font>Cardinal <font color="#000080">:= </font>L<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{Cardinal}

  </i></font><font color="#FF0000"><b>Function </b></font>ElapsedTime<font color="#000080">(</font>Start<font color="#000080">, </font>Stop <font color="#000080">: </font>LongInt<font color="#000080">) : </font>Real<font color="#000080">;
    </font><font color="#008000"><i>{-Calculate time elapsed (in milliseconds) between Start and Stop}
  </i></font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{ElapsedTime}
    </i></font>ElapsedTime <font color="#000080">:= </font><font color="#800000">1000.0</font><font color="#000080">*</font>Cardinal<font color="#000080">(</font>Stop<font color="#000080">-(</font>Start<font color="#000080">+</font>Delta<font color="#000080">))/</font>TimerResolution<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{ElapsedTime}

  </i></font><font color="#FF0000"><b>Function </b></font>ElapsedTimeString<font color="#000080">(</font>Start<font color="#000080">, </font>Stop <font color="#000080">: </font>LongInt<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font><font color="#008000"><i>{-Return time elapsed (in milliseconds) between Start and Stop as a String}
  </i></font><font color="#FF0000"><b>Var
    </b></font>R <font color="#000080">: </font>Real<font color="#000080">;
    </font>S <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{ElapsedTimeString}
    </i></font>R <font color="#000080">:= </font>ElapsedTime<font color="#000080">(</font>Start<font color="#000080">, </font>Stop<font color="#000080">);
    </font>Str<font color="#000080">(</font>R<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>S<font color="#000080">);
    </font>ElapsedTimeString <font color="#000080">:= </font>S<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{ElapsedTimeString}

  </i></font><font color="#FF0000"><b>Procedure </b></font>InitializeTimer<font color="#000080">;
    </font><font color="#008000"><i>{-ReProgram the timer chip to allow 1 microsecond resolution}
  </i></font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{InitializeTimer}
    {select timer mode 2, read/Write channel 0}
    </i></font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$34</font><font color="#000080">;        </font><font color="#008000"><i>{00110100b}
    </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$EB</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">);         </font><font color="#008000"><i>{jmp short $+2 ;Delay}
    </i></font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">;        </font><font color="#008000"><i>{LSB = 0}
    </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$EB</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">);         </font><font color="#008000"><i>{jmp short $+2 ;Delay}
    </i></font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">;        </font><font color="#008000"><i>{MSB = 0}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{InitializeTimer}

  </i></font><font color="#FF0000"><b>Procedure </b></font>RestoreTimer<font color="#000080">;
    </font><font color="#008000"><i>{-Restore the timer chip to its normal state}
  </i></font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{RestoreTimer}
    {select timer mode 3, read/Write channel 0}
    </i></font>Port<font color="#000080">[</font><font color="#800000">$43</font><font color="#000080">] := </font><font color="#800000">$36</font><font color="#000080">;        </font><font color="#008000"><i>{00110110b}
    </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$EB</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">);         </font><font color="#008000"><i>{jmp short $+2 ;Delay}
    </i></font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">;        </font><font color="#008000"><i>{LSB = 0}
    </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$EB</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">);         </font><font color="#008000"><i>{jmp short $+2 ;Delay}
    </i></font>Port<font color="#000080">[</font><font color="#800000">$40</font><font color="#000080">] := </font><font color="#800000">$00</font><font color="#000080">;        </font><font color="#008000"><i>{MSB = 0}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{RestoreTimer}

  </i></font><font color="#FF0000"><b>Function </b></font>ReadTimer <font color="#000080">: </font>LongInt<font color="#000080">;
    </font><font color="#008000"><i>{-Read the timer With 1 microsecond resolution}
  </i></font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{ReadTimer}
    </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(
      </font><font color="#800000">$FA</font><font color="#000080">/                   </font><font color="#008000"><i>{cli             ;Disable interrupts}
      </i></font><font color="#800000">$BA</font><font color="#000080">/</font><font color="#800000">$20</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/           </font><font color="#008000"><i>{mov  dx,$20     ;Address PIC ocw3}
      </i></font><font color="#800000">$B0</font><font color="#000080">/</font><font color="#800000">$0A</font><font color="#000080">/               </font><font color="#008000"><i>{mov  al,$0A     ;Ask to read irr}
      </i></font><font color="#800000">$EE</font><font color="#000080">/                   </font><font color="#008000"><i>{out  dx,al}
      </i></font><font color="#800000">$B0</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/               </font><font color="#008000"><i>{mov  al,$00     ;Latch timer 0}
      </i></font><font color="#800000">$E6</font><font color="#000080">/</font><font color="#800000">$43</font><font color="#000080">/               </font><font color="#008000"><i>{out  $43,al}
      </i></font><font color="#800000">$EC</font><font color="#000080">/                   </font><font color="#008000"><i>{in   al,dx      ;Read irr}
      </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$C7</font><font color="#000080">/               </font><font color="#008000"><i>{mov  di,ax      ;Save it in DI}
      </i></font><font color="#800000">$E4</font><font color="#000080">/</font><font color="#800000">$40</font><font color="#000080">/               </font><font color="#008000"><i>{in   al,$40     ;Counter --&gt; bx}
      </i></font><font color="#800000">$88</font><font color="#000080">/</font><font color="#800000">$C3</font><font color="#000080">/               </font><font color="#008000"><i>{mov  bl,al      ;LSB in BL}
      </i></font><font color="#800000">$E4</font><font color="#000080">/</font><font color="#800000">$40</font><font color="#000080">/               </font><font color="#008000"><i>{in   al,$40}
      </i></font><font color="#800000">$88</font><font color="#000080">/</font><font color="#800000">$C7</font><font color="#000080">/               </font><font color="#008000"><i>{mov  bh,al      ;MSB in BH}
      </i></font><font color="#800000">$F7</font><font color="#000080">/</font><font color="#800000">$D3</font><font color="#000080">/               </font><font color="#008000"><i>{not  bx         ;Need ascending counter}
      </i></font><font color="#800000">$E4</font><font color="#000080">/</font><font color="#800000">$21</font><font color="#000080">/               </font><font color="#008000"><i>{in   al,$21     ;Read PIC imr}
      </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$C6</font><font color="#000080">/               </font><font color="#008000"><i>{mov  si,ax      ;Save it in SI}
      </i></font><font color="#800000">$B0</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/               </font><font color="#008000"><i>{mov  al,$0FF    ;Mask all interrupts}
      </i></font><font color="#800000">$E6</font><font color="#000080">/</font><font color="#800000">$21</font><font color="#000080">/               </font><font color="#008000"><i>{out  $21,al}
      </i></font><font color="#800000">$B8</font><font color="#000080">/</font><font color="#800000">$40</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/           </font><font color="#008000"><i>{mov  ax,$40     ;read low Word of time}
      </i></font><font color="#800000">$8E</font><font color="#000080">/</font><font color="#800000">$C0</font><font color="#000080">/               </font><font color="#008000"><i>{mov  es,ax      ;from BIOS data area}
      </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$16</font><font color="#000080">/</font><font color="#800000">$6C</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/   </font><font color="#008000"><i>{mov  dx,es:[$6C]}
      </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$F0</font><font color="#000080">/               </font><font color="#008000"><i>{mov  ax,si      ;Restore imr from SI}
      </i></font><font color="#800000">$E6</font><font color="#000080">/</font><font color="#800000">$21</font><font color="#000080">/               </font><font color="#008000"><i>{out  $21,al}
      </i></font><font color="#800000">$FB</font><font color="#000080">/                   </font><font color="#008000"><i>{sti             ;Enable interrupts}
      </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$F8</font><font color="#000080">/               </font><font color="#008000"><i>{mov  ax,di      ;Retrieve old irr}
      </i></font><font color="#800000">$A8</font><font color="#000080">/</font><font color="#800000">$01</font><font color="#000080">/               </font><font color="#008000"><i>{test al,$01     ;Counter hit 0?}
      </i></font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$07</font><font color="#000080">/               </font><font color="#008000"><i>{jz   done       ;Jump if not}
      </i></font><font color="#800000">$81</font><font color="#000080">/</font><font color="#800000">$FB</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/       </font><font color="#008000"><i>{cmp  bx,$FF     ;Counter &gt; $FF?}
      </i></font><font color="#800000">$77</font><font color="#000080">/</font><font color="#800000">$01</font><font color="#000080">/               </font><font color="#008000"><i>{ja   done       ;Done if so}
      </i></font><font color="#800000">$42</font><font color="#000080">/                   </font><font color="#008000"><i>{inc  dx         ;else count int req.}
      {done:}
      </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$5E</font><font color="#000080">/</font><font color="#800000">$FC</font><font color="#000080">/           </font><font color="#008000"><i>{mov [bp-4],bx   ;set Function result}
      </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$56</font><font color="#000080">/</font><font color="#800000">$FE</font><font color="#000080">);          </font><font color="#008000"><i>{mov [bp-2],dx}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{ReadTimer}

  </i></font><font color="#FF0000"><b>Procedure </b></font>Calibrate<font color="#000080">;
    </font><font color="#008000"><i>{-Calibrate the timer}
  </i></font><font color="#FF0000"><b>Const
    </b></font>Reps <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">;
  </font><font color="#FF0000"><b>Var
    </b></font>I <font color="#000080">: </font>Word<font color="#000080">;
    </font>L1<font color="#000080">, </font>L2<font color="#000080">, </font>Diff <font color="#000080">: </font>LongInt<font color="#000080">;
  </font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{Calibrate}
    </i></font>Delta <font color="#000080">:= </font>MaxInt<font color="#000080">;
    </font><font color="#FF0000"><b>For </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Reps <font color="#FF0000"><b>do begin
      </b></font>L1 <font color="#000080">:= </font>ReadTimer<font color="#000080">;
      </font>L2 <font color="#000080">:= </font>ReadTimer<font color="#000080">;
      </font><font color="#008000"><i>{use the minimum difference}
      </i></font>Diff <font color="#000080">:= </font>L2<font color="#000080">-</font>L1<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>Diff <font color="#000080">&lt; </font>Delta <font color="#FF0000"><b>then
        </b></font>Delta <font color="#000080">:= </font>Diff<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{Calibrate}

  {$F+}
  </i></font><font color="#FF0000"><b>Procedure </b></font>OurExitProc<font color="#000080">;
    </font><font color="#008000"><i>{-Restore timer chip to its original state}
  </i></font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>{OurExitProc}
    </i></font>ExitProc <font color="#000080">:= </font>SaveExitProc<font color="#000080">;
    </font>RestoreTimer<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;                       </font><font color="#008000"><i>{OurExitProc}
  {$F-}

</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{set up our Exit handler}
  </i></font>SaveExitProc <font color="#000080">:= </font>ExitProc<font color="#000080">;
  </font>ExitProc <font color="#000080">:= @</font>OurExitProc<font color="#000080">;

  </font><font color="#008000"><i>{reProgram the timer chip}
  </i></font>InitializeTimer<font color="#000080">;

  </font><font color="#008000"><i>{adjust For speed of machine}
  </i></font>Calibrate<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TIMING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0007.PAS">Original</a><b>]</b></p></body>
</html>
