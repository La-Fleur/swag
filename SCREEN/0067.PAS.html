<html>
<head><title> "Direct VIDEO write (BASM)" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SCREEN SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0067.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>procedure </b></font>qwrite<font color="#000080">(</font>x<font color="#000080">, </font>y<font color="#000080">: </font>byte<font color="#000080">; </font>s<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>f<font color="#000080">, </font>b<font color="#000080">: </font>byte<font color="#000080">);

</font><font color="#008000"><i>{ Does a direct video write -- extremely fast. }

</i></font><font color="#FF0000"><b>begin
  asm
    </b></font><font color="#FF00FF">mov dh, y         </font><font color="#008000"><i>{ move X and Y into DL and DH }
    </i></font><font color="#FF00FF">mov dl, x
    xor al, al
    mov ah, b         </font><font color="#008000"><i>{ load background into AH }
    </i></font><font color="#FF00FF">mov cl, 4         </font><font color="#008000"><i>{ shift background over to next nibble }
    </i></font><font color="#FF00FF">shl ax, cl
    add ah, f         </font><font color="#008000"><i>{ add foreground }
    </i></font><font color="#FF00FF">push ax           </font><font color="#008000"><i>{ PUSH color combo onto the stack }
    </i></font><font color="#FF00FF">mov bx, 0040h     </font><font color="#008000"><i>{ look at 0040h:0049h to get video mode }
    </i></font><font color="#FF00FF">mov es, bx
    mov bx, 0049h
    mov al, es:[bx]
    cmp al, 7         </font><font color="#008000"><i>{ see if mode = 7 (i.e., monochrome) }
    </i></font><font color="#FF00FF">je @mono_segment
    mov ax, 0b800h    </font><font color="#008000"><i>{ it's color: use segment B800h }
    </i></font><font color="#FF00FF">jmp @got_segment
    @mono_segment:
    mov ax, 0b000h    </font><font color="#008000"><i>{ it's mono: use segment B000h }
    </i></font><font color="#FF00FF">@got_segment:
    push ax           </font><font color="#008000"><i>{ PUSH video segment onto stack }
    </i></font><font color="#FF00FF">mov bx, 004ah     </font><font color="#008000"><i>{ check 0040h:0049h to get number of screen columns }
    </i></font><font color="#FF00FF">xor ch, ch
    mov cl, es:[bx]
    xor ah, ah        </font><font color="#008000"><i>{ move Y into AL; decrement to convert Pascal coords }
    </i></font><font color="#FF00FF">mov al, dh
    dec al
    xor bh, bh        </font><font color="#008000"><i>{ shift X over into BL; decrement again }
    </i></font><font color="#FF00FF">mov bl, dl
    dec bl
    cmp cl, $50       </font><font color="#008000"><i>{ see if we're in 80-column mode }
    </i></font><font color="#FF00FF">je @eighty_column
    mul cx            </font><font color="#008000"><i>{ multiply Y by the number of columns }
    </i></font><font color="#FF00FF">jmp @multiplied
    @eighty_column:   </font><font color="#008000"><i>{ 80-column mode: it may be faster to perform the }
    </i></font><font color="#FF00FF">mov cl, 4         </font><font color="#008000"><i>{   multiplication via shifts and adds: remember  }
    </i></font><font color="#FF00FF">shl ax, cl        </font><font color="#008000"><i>{   that 80d = 1010000b , so one can SHL 4, copy  }
    </i></font><font color="#FF00FF">mov dx, ax        </font><font color="#008000"><i>{   the result to DX, SHL 2, and add DX in.       }
    </i></font><font color="#FF00FF">mov cl, 2
    shl ax, cl
    add ax, dx
    @multiplied:
    add ax, bx        </font><font color="#008000"><i>{ add X in }
    </i></font><font color="#FF00FF">shl ax, 1         </font><font color="#008000"><i>{ multiply by 2 to get offset into video segment }
    </i></font><font color="#FF00FF">mov di, ax        </font><font color="#008000"><i>{ video pointer is in DI }
    </i></font><font color="#FF00FF">lea si, s         </font><font color="#008000"><i>{ string pointer is in SI }
    </i></font><font color="#FF00FF">SEGSS lodsb
    cmp al, 00h       </font><font color="#008000"><i>{ if zero-length string, jump to end }
    </i></font><font color="#FF00FF">je @done
    mov cl, al
    xor ch, ch        </font><font color="#008000"><i>{ string length is in CX }
    </i></font><font color="#FF00FF">pop es            </font><font color="#008000"><i>{ get video segment back from stack; put in ES }
    </i></font><font color="#FF00FF">pop ax            </font><font color="#008000"><i>{ get color back from stack; put in AX (AH = color) }
    </i></font><font color="#FF00FF">@write_loop:
    SEGSS lodsb       </font><font color="#008000"><i>{ get character to write }
    </i></font><font color="#FF00FF">mov es:[di], ax   </font><font color="#008000"><i>{ write AX to video memory }
    </i></font><font color="#FF00FF">inc di            </font><font color="#008000"><i>{ increment video pointer }
    </i></font><font color="#FF00FF">inc di
    loop @write_loop  </font><font color="#008000"><i>{ if CX &gt; 0, go back to top of loop }
    </i></font><font color="#FF00FF">@done:            </font><font color="#008000"><i>{ end }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SCREEN SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0067.PAS">Original</a><b>]</b></p></body>
</html>
