<html>
<head><title> "Universal Fastwrite" by JOHN O'HARROW</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SCREEN SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0074.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
Re:	Copy of: Submission for SWAG

Here is a unit I have developed for very fast direct screen writes.  
This unit is, unless you know better, the fastest direct direct write 
procedure available.  This is because it is optimised to use word 
size moves on word boundaries where possible. 

It also works in both real and protected modes. 
*)

{$S-}

</i></font><font color="#FF0000"><b>UNIT </b></font>FWrite<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

  PROCEDURE </b></font>FastWrite<font color="#000080">(</font>Col<font color="#000080">, </font>Row<font color="#000080">, </font>Attr <font color="#000080">: </font>Byte<font color="#000080">; </font>Str <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
  </font><font color="#008000"><i>{Fast Direct Screen Writes for Real/Protected Mode Programs.    }
  {Note: 'Col' and 'Row' are zero relative, ie:- 0,0 for Top-Left.}

</i></font><font color="#FF0000"><b>IMPLEMENTATION

USES
  </b></font>Crt<font color="#000080">;

  </font><font color="#FF0000"><b>PROCEDURE </b></font>FastWrite<font color="#000080">(</font>Col<font color="#000080">, </font>Row<font color="#000080">, </font>Attr <font color="#000080">: </font>Byte<font color="#000080">; </font>Str <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">PUSH   DS           </font><font color="#008000"><i>{Save DS}
    </i></font><font color="#FF00FF">MOV    DL,CheckSnow </font><font color="#008000"><i>{Save CheckSnow Setting}
    </i></font><font color="#FF00FF">MOV    ES,SegB800   </font><font color="#008000"><i>{ES = Colour Screen Segment}
    </i></font><font color="#FF00FF">MOV    SI,SegB000   </font><font color="#008000"><i>{SI = Mono Screen Segment}
    </i></font><font color="#FF00FF">MOV    DS,Seg0040   </font><font color="#008000"><i>{DS = ROM Bios Segment}
    </i></font><font color="#FF00FF">MOV    BX,[49h]     </font><font color="#008000"><i>{BL = CRT Mode, BH = ScreenWidth}
    </i></font><font color="#FF00FF">MOV    AL,Row       </font><font color="#008000"><i>{AL = Row No}
    </i></font><font color="#FF00FF">MUL    BH           </font><font color="#008000"><i>{AX = Row * ScreenWidth}
    </i></font><font color="#FF00FF">XOR    CH,CH        </font><font color="#008000"><i>{CH = 0}
    </i></font><font color="#FF00FF">MOV    CL,Col       </font><font color="#008000"><i>{CX = Column No}
    </i></font><font color="#FF00FF">ADD    AX,CX        </font><font color="#008000"><i>{(Row*ScreenWidth)+Column}
    </i></font><font color="#FF00FF">ADD    AX,AX        </font><font color="#008000"><i>{Multiply by 2 (2 Byte per Position)}
    </i></font><font color="#FF00FF">MOV    DI,AX        </font><font color="#008000"><i>{DI = Screen Offset}
    </i></font><font color="#FF00FF">CMP    BL,7         </font><font color="#008000"><i>{CRT Mode = Mono?}
    </i></font><font color="#FF00FF">JNE    @@DestSet    </font><font color="#008000"><i>{No  - Use Colour Screen Segment}
    </i></font><font color="#FF00FF">MOV    ES,SI        </font><font color="#008000"><i>{Yes - ES = Mono Screen Segment}
    </i></font><font color="#FF00FF">XOR    DX,DX        </font><font color="#008000"><i>{Force jump to FWrite}
  </i></font><font color="#FF00FF">@@DestSet:            </font><font color="#008000"><i>{ES:DI = Screen Destination Address}
    </i></font><font color="#FF00FF">LDS    SI,Str       </font><font color="#008000"><i>{DS:SI = Source String}
    </i></font><font color="#FF00FF">CLD                 </font><font color="#008000"><i>{Move Forward through String}
    </i></font><font color="#FF00FF">LODSB               </font><font color="#008000"><i>{Get Length Byte of String}
    </i></font><font color="#FF00FF">MOV    CL,AL        </font><font color="#008000"><i>{CX = Input String Length}
    </i></font><font color="#FF00FF">JCXZ   @@Done       </font><font color="#008000"><i>{Exit if Null String}
    </i></font><font color="#FF00FF">MOV    AH,Attr      </font><font color="#008000"><i>{AH = Attribute}
    </i></font><font color="#FF00FF">OR     DL,DL        </font><font color="#008000"><i>{Test Mono/CheckSnow Flag}
    </i></font><font color="#FF00FF">JZ     @@FWrite     </font><font color="#008000"><i>{Snow Checking Disabled or Mono - Use FWrite}
{Output during Screen Retrace's}
    </i></font><font color="#FF00FF">MOV    DX,003DAh    </font><font color="#008000"><i>{6845 Status Port}
  </i></font><font color="#FF00FF">@@WaitLoop:           </font><font color="#008000"><i>{Output during Retrace's}
    </i></font><font color="#FF00FF">MOV    BL,[SI]      </font><font color="#008000"><i>{Load Next Character into BL}
    </i></font><font color="#FF00FF">INC    SI           </font><font color="#008000"><i>{Update Source Pointer}
    </i></font><font color="#FF00FF">CLI                 </font><font color="#008000"><i>{Interrupts off}
  </i></font><font color="#FF00FF">@@Wait1:              </font><font color="#008000"><i>{Wait for End of Retrace}
    </i></font><font color="#FF00FF">IN      AL,DX       </font><font color="#008000"><i>{Get 6845 status}
    </i></font><font color="#FF00FF">TEST    AL,8        </font><font color="#008000"><i>{Vertical Retrace in Progress?}
    </i></font><font color="#FF00FF">JNZ     @@Write     </font><font color="#008000"><i>{Yes - Output Next Char}
    </i></font><font color="#FF00FF">SHR     AL,1        </font><font color="#008000"><i>{Horizontal Retrace in Progress?}
    </i></font><font color="#FF00FF">JC      @@Wait1     </font><font color="#008000"><i>{Yes - Wait until End of Retrace}
  </i></font><font color="#FF00FF">@@Wait2:              </font><font color="#008000"><i>{Wait for Start of Next Retrace}
    </i></font><font color="#FF00FF">IN      AL,DX       </font><font color="#008000"><i>{Get 6845 status}
    </i></font><font color="#FF00FF">SHR     AL,1        </font><font color="#008000"><i>{Horizontal Retrace in Progress?}
    </i></font><font color="#FF00FF">JNC     @@Wait2     </font><font color="#008000"><i>{No - Wait until Retrace Starts}
  </i></font><font color="#FF00FF">@@Write:              </font><font color="#008000"><i>{Output Char and Attribute}
    </i></font><font color="#FF00FF">MOV     AL,BL       </font><font color="#008000"><i>{Put Char to Write into AL}
    </i></font><font color="#FF00FF">STOSW               </font><font color="#008000"><i>{Store Character and Attribute}
    </i></font><font color="#FF00FF">STI                 </font><font color="#008000"><i>{Interrupts On}
    </i></font><font color="#FF00FF">LOOP   @@WaitLoop   </font><font color="#008000"><i>{Repeat for Each Character}
    </i></font><font color="#FF00FF">JMP    @@Done       </font><font color="#008000"><i>{Exit}
{Ignore Screen Retrace's}
  </i></font><font color="#FF00FF">@@FWrite:             </font><font color="#008000"><i>{Output Ignoring Retrace's}
    </i></font><font color="#FF00FF">TEST   SI,1         </font><font color="#008000"><i>{DS:SI an Even Offset?}
    </i></font><font color="#FF00FF">JZ     @@Words      </font><font color="#008000"><i>{Yes - Skip (On Even Boundary)}
    </i></font><font color="#FF00FF">LODSB               </font><font color="#008000"><i>{Get 1st Char}
    </i></font><font color="#FF00FF">STOSW               </font><font color="#008000"><i>{Write 1st Char and Attrib}
    </i></font><font color="#FF00FF">DEC    CX           </font><font color="#008000"><i>{Decrement Count}
    </i></font><font color="#FF00FF">JCXZ   @@Done       </font><font color="#008000"><i>{Finished if only 1 Char in Str}
  </i></font><font color="#FF00FF">@@Words:              </font><font color="#008000"><i>{DS:SI Now on Word Boundary}
    </i></font><font color="#FF00FF">SHR    CX,1         </font><font color="#008000"><i>{CX = Char Pairs, Set CF if Odd Byte Left}
    </i></font><font color="#FF00FF">JZ     @@ChkOdd     </font><font color="#008000"><i>{Skip if No Pairs to Store}
  </i></font><font color="#FF00FF">@@Loop:               </font><font color="#008000"><i>{Loop Outputing 2 Chars per Loop}
    </i></font><font color="#FF00FF">MOV    BH,AH        </font><font color="#008000"><i>{BH = Attrib}
    </i></font><font color="#FF00FF">LODSW               </font><font color="#008000"><i>{Load 2 Chars}
    </i></font><font color="#FF00FF">XCHG   AH,BH        </font><font color="#008000"><i>{AL = 1st Char, AH = Attrib, BH = 2nd Char}
    </i></font><font color="#FF00FF">STOSW               </font><font color="#008000"><i>{Store 1st Char and Attrib}
    </i></font><font color="#FF00FF">MOV    AL,BH        </font><font color="#008000"><i>{AL = 2nd Char}
    </i></font><font color="#FF00FF">STOSW               </font><font color="#008000"><i>{Store 2nd Char and Attrib}
    </i></font><font color="#FF00FF">LOOP   @@Loop       </font><font color="#008000"><i>{Repeat for Each Pair of Chars}
  </i></font><font color="#FF00FF">@@ChkOdd:             </font><font color="#008000"><i>{Check for Final Char}
    </i></font><font color="#FF00FF">JNC    @@Done       </font><font color="#008000"><i>{Skip if No Odd Char to Display}
    </i></font><font color="#FF00FF">LODSB               </font><font color="#008000"><i>{Get Last Char}
    </i></font><font color="#FF00FF">STOSW               </font><font color="#008000"><i>{Store Last Char and Attribute}
  </i></font><font color="#FF00FF">@@Done:               </font><font color="#008000"><i>{Finished}
    </i></font><font color="#FF00FF">POP    DS           </font><font color="#008000"><i>{Restore DS}
  </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{FastWrite}

</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SCREEN SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0074.PAS">Original</a><b>]</b></p></body>
</html>
