<html>
<head><title> "Fast Direct Screen Writes" by SEAN PALMER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SCREEN SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
===========================================================================
 BBS: Canada Remote Systems
Date: 06-22-93 (23:10)             Number: 27381
From: SEAN PALMER                  Refer#: NONE
  To: LOU DUCHEZ                    Recvd: NO
Subj: FAST DIRECT WRITES             Conf: (1221) F-PASCAL
---------------------------------------------------------------------------
LD&gt;SP&gt;I've optimized it a little, if you're interested... 8)

LD&gt;SP&gt;procedure qwrite(x, y: byte; s: string; f, b: byte);

LD&gt;Interesting optimizations -- do I assume that Inc, Dec, Pred, and Succ
LD&gt;are faster than I had ever imagined?  (Shoot, I always figured they'd be
LD&gt;a lot slower than normal arithmetic!)  Thanks!

Succ and Pred are faster for byte-sized ordinals (at least in TP 6.0)
than +1 and -1. The same for word-size. See, with +1 and -1, the byte
gets converted into a word first, but with Succ() and Pred() it
stays a byte... Inc(I) is faster than I:=I+1 or I:=Succ(I) stuff in 6.0
but I think 7.0+ optimize them all to the same code...not sure, I don't
have 7.0...8(

Actually the fastest part of what I did is to pre-calculate the
attribute as the hi byte of a word, and use word stores instead of byte
stores. Could be done alot faster in assembly (don't access any
memory-based variables that way, it's all in registers..8)

Here is a direct screen write unit I wrote in BASM. VERY fast...
*)

{$A-,B-,S-,V-X+}
</i></font><font color="#FF0000"><b>unit </b></font>Direct<font color="#000080">;
</font><font color="#FF0000"><b>interface

CONST
 </b></font>vSeg<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">$B800</font><font color="#000080">;  </font><font color="#008000"><i>{change for mono}

</i></font><font color="#FF0000"><b>VAR
  </b></font>VMode   <font color="#000080">: </font>BYTE <font color="#FF0000"><b>ABSOLUTE </b></font><font color="#800000">$0040 </font><font color="#000080">: </font><font color="#800000">$0049</font><font color="#000080">; </font><font color="#008000"><i>{ Video mode: Mono=7, Color=0-3 }
  </i></font>ScrCols <font color="#000080">: </font>WORD <font color="#FF0000"><b>ABSOLUTE </b></font><font color="#800000">$0040 </font><font color="#000080">: </font><font color="#800000">$004A</font><font color="#000080">; </font><font color="#008000"><i>{ Number of CRT columns (1-based) }

{in following parms, s=source,d=destination,n=count, words are offsets
 into video memory (you calculate them with ((y*80+x)*2)}
{I did this mainly so less parms would have to be sent, as TP does a
 good job of the arithmetic for that expression...Oh well if you really
 don't like it I could make these use x and y coords, but this was
 basically chopped from another project of mine..}

</i></font><font color="#FF0000"><b>procedure </b></font>moveScr<font color="#000080">(</font>s<font color="#000080">,</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">);    </font><font color="#008000"><i>{one part of screen to another}
</i></font><font color="#FF0000"><b>procedure </b></font>toScr<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s<font color="#000080">;</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">);  </font><font color="#008000"><i>{from string to video ram}
</i></font><font color="#FF0000"><b>procedure </b></font>toScrA<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s<font color="#000080">;</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">;</font>a<font color="#000080">:</font>byte<font color="#000080">); </font><font color="#008000"><i>{ditto with attribute also}
</i></font><font color="#FF0000"><b>procedure </b></font>fillScr<font color="#000080">(</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">;</font>c<font color="#000080">:</font>char<font color="#000080">);      </font><font color="#008000"><i>{mainly useful for rows}
</i></font><font color="#FF0000"><b>procedure </b></font>fillAttr<font color="#000080">(</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">;</font>a<font color="#000080">:</font>byte<font color="#000080">);     </font><font color="#008000"><i>{ditto}

{ I added the following to make this GREAT code more useful for us hackers !!}
{ Gayle Davis 06/26/93 }

</i></font><font color="#FF0000"><b>function  </b></font>ScreenAdr <font color="#000080">(</font>Row<font color="#000080">,</font>Col <font color="#000080">: </font>Byte<font color="#000080">) : </font>WORD<font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>Qwrite<font color="#000080">(</font>Row<font color="#000080">, </font>Col<font color="#000080">, </font>Attr<font color="#000080">: </font>byte<font color="#000080">; </font>S<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);

</font><font color="#FF0000"><b>implementation


procedure </b></font>moveScr<font color="#000080">(</font>s<font color="#000080">,</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov cx,n; jcxz @X;
 push ds; mov ax,vSeg; mov es,ax; mov ds,ax;
 mov si,s; shl si,1;
 mov di,d; shl di,1;
 cmp si,di; jb @REV;  </font><font color="#008000"><i>{move in reverse to prevent overwrite}
 </i></font><font color="#FF00FF">cld; jmp @GO;
@REV: std; shl cx,1; add si,cx; add di,cx; shr cx,1; </font><font color="#008000"><i>{start at end}
</i></font><font color="#FF00FF">@GO: repz movsw; </font><font color="#008000"><i>{move attr too!}
 </i></font><font color="#FF00FF">pop ds;
@X:
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>toScr<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s<font color="#000080">;</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov cx,n; jcxz @X;
 push ds; mov es,vSeg;
 mov di,d; shl di,1;
 lds si,s; cld;
@L: movsb; inc di; loop @L;
 pop ds;
@X:
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>toScrA<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>s<font color="#000080">;</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">;</font>a<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov cx,n; jcxz @X;
 push ds; mov es,vSeg;
 mov di,d; shl di,1;
 lds si,s; cld;
 mov al,a;  </font><font color="#008000"><i>{attribute}
</i></font><font color="#FF00FF">@L: movsb; </font><font color="#008000"><i>{doesn't affect al reg}
 </i></font><font color="#FF00FF">stosb; loop @L;
 pop ds;
@X:
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>fillScr<font color="#000080">(</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">;</font>c<font color="#000080">:</font>char<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov cx,n; jcxz @X;
 mov es,vSeg;
 mov di,d; shl di,1;
 mov al,c; cld;
@L: stosb; inc di; loop @L;
@X:
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>fillAttr<font color="#000080">(</font>d<font color="#000080">,</font>n<font color="#000080">:</font>word<font color="#000080">;</font>a<font color="#000080">:</font>byte<font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">mov cx,n; jcxz @X;
 mov es,vSeg;
 mov di,d; shl di,1;
 mov al,a; cld;
@L: inc di; stosb; loop @L;
@X:
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ScreenAdr <font color="#000080">(</font>Row<font color="#000080">,</font>Col <font color="#000080">: </font>Byte<font color="#000080">) : </font>WORD<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
   </b></font>ScreenAdr <font color="#000080">:= </font>PRED <font color="#000080">(</font>Row<font color="#000080">) * </font>ScrCols <font color="#000080">+ </font>PRED <font color="#000080">(</font>Col<font color="#000080">) * </font><font color="#800000">2</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>qwrite<font color="#000080">(</font>Row<font color="#000080">, </font>Col<font color="#000080">, </font>Attr<font color="#000080">: </font>byte<font color="#000080">; </font>S<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
</b></font>toScrA<font color="#000080">(</font>MemW<font color="#000080">[</font>Seg<font color="#000080">(</font>S<font color="#000080">):</font>SUCC<font color="#000080">(</font>Ofs<font color="#000080">(</font>S<font color="#000080">))], </font>ScreenAdr<font color="#000080">(</font>Row<font color="#000080">,</font>Col<font color="#000080">), </font>Length<font color="#000080">(</font>S<font color="#000080">), </font>Attr<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
IF </b></font>VMode <font color="#000080">= </font><font color="#800000">7 </font><font color="#FF0000"><b>Then </b></font>VSeg <font color="#000080">:= </font><font color="#800000">$B000</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.



</font>Keep <font color="#FF0000"><b>in </b></font>mind these are VERY low<font color="#000080">-</font>level <font color="#FF0000"><b>and </b></font>aren<font color="#800000">'t necessarily gonna be
</font>easy <font color="#FF0000"><b>to </b></font>work <font color="#FF0000"><b>with </b></font>but they are<font color="#000080">, </font>by god<font color="#000080">, </font>FAST<font color="#000080">.

</font>LD<font color="#000080">&gt;</font><font color="#FF0000"><b>As to </b></font>why I pass attributes <font color="#FF0000"><b>and </b></font>don<font color="#800000">'t use WhereX() and WhereY(), I wrote
</font>LD<font color="#000080">&gt;</font>QWRITE mostly <font color="#FF0000"><b>for </b></font>screen drawing <font color="#000080">-- </font><font color="#FF0000"><b>in </b></font>fact<font color="#000080">, </font>QWRITE doesn<font color="#800000">'t even move the
</font>LD<font color="#000080">&gt;</font>cursor<font color="#000080">.  </font>It<font color="#800000">'s no good for &quot;scrolling&quot; text, but goldang, when you want
</font>LD<font color="#000080">&gt;</font><font color="#FF0000"><b>to </b></font>draw a box <font color="#FF0000"><b>on </b></font>the screen <font color="#FF0000"><b>or </b></font>fill a region <font color="#FF0000"><b>with </b></font>a given character <font color="#000080">...

</font>These don<font color="#800000">'t either (cursor? who needs it!)

</font>QWrite<font color="#800000">'ll work a little faster now, anyway...

 </font><font color="#000080">* </font>OLX <font color="#800000">2.2 </font><font color="#000080">* </font>Cana<font color="#000080">-</font>DOS<font color="#000080">: &quot;</font>Yer sure<font color="#000080">, </font>eh<font color="#000080">?&quot; [</font>O<font color="#000080">]</font>k<font color="#000080">, </font>eh<font color="#000080">! [</font>N<font color="#000080">]</font>o way<font color="#000080">! [</font>B<font color="#000080">]</font>eauty<font color="#000080">! ?

--- </font>Maximus <font color="#800000">2.01</font>wb
 <font color="#000080">* </font>Origin<font color="#000080">: &gt;&gt;&gt; </font>Sun Mountain BBS <font color="#000080">&lt;&lt;&lt; (</font><font color="#800000">303</font><font color="#000080">)-</font><font color="#800000">665</font><font color="#000080">-</font><font color="#800000">6922 </font><font color="#000080">(</font><font color="#800000">1</font><font color="#000080">:</font><font color="#800000">104</font><font color="#000080">/</font><font color="#800000">123</font><font color="#000080">)
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SCREEN SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0021.PAS">Original</a><b>]</b></p></body>
</html>
