<html>
<head><title> "WATCHDOG.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ISR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000000"> BC<font color="#000080">&gt; </font>I have the desire <font color="#FF0000"><b>to </b></font>create a <font color="#FF0000"><b>Type of </b></font><font color="#000080">&quot;</font>watch dog<font color="#000080">&quot; </font><font color="#FF0000"><b>Procedure For </b></font>a <font color="#FF0000"><b>Program
 </b></font>BC<font color="#000080">&gt; </font>I am writing<font color="#000080">. </font>It has become increasingly attractive <font color="#FF0000"><b>For </b></font>me <font color="#FF0000"><b>to </b></font>create this
 BC<font color="#000080">&gt; </font><font color="#FF0000"><b>Procedure to </b></font>activate at certain times every hour <font color="#000080">- </font>i<font color="#000080">.</font>e<font color="#000080">. </font>at <font color="#800000">15 </font>past <font color="#FF0000"><b>and </b></font><font color="#800000">45
 </font>BC<font color="#000080">&gt; </font>past the hour<font color="#000080">.

</font>Perhaps <font color="#FF0000"><b>if </b></font>you insert this code into your <font color="#FF0000"><b>Program</b></font><font color="#000080">. </font>It works <font color="#FF0000"><b>With </b></font>the ISR <font color="#800000">1</font>C
called by the timerinterrupt <font color="#800000">8 </font>periodically<font color="#000080">. </font><font color="#FF0000"><b>For </b></font>testing reasons it calls the
batchFile at <font color="#800000">15 </font><font color="#FF0000"><b>and </b></font><font color="#800000">45 </font>seconds<font color="#000080">. </font>Change <font color="#FF0000"><b>finally </b></font>the line <font color="#000080">&quot;</font><font color="#FF0000"><b>if</b></font><font color="#000080">(</font>s<font color="#000080">=</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>s<font color="#000080">=</font><font color="#800000">45</font><font color="#000080">)&quot; </font><font color="#FF0000"><b>to
</b></font><font color="#000080">&quot;</font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>m<font color="#000080">=</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>m<font color="#000080">=</font><font color="#800000">45</font><font color="#000080">)&quot; </font><font color="#FF0000"><b>to </b></font>test the minutes<font color="#000080">.

</font>Code written <font color="#FF0000"><b>in </b></font>TP6<font color="#000080">.</font><font color="#800000">0 </font><font color="#000080">:

</font><font color="#008000"><i>{$M 16384,0,16384} (*Adjust to your requirements*)
</i></font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">,</font>Crt<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>WDTryTime <font color="#000080">= </font><font color="#800000">18</font><font color="#000080">; </font><font color="#008000"><i>(*18 ticks = about every second*)
  </i></font>BatchFileName <font color="#000080">= </font><font color="#800000">'woufwouf.bat'</font><font color="#000080">; </font><font color="#008000"><i>(*BatchFile to start*) </i></font><font color="#000080">&lt;&lt;&lt;</font>your BatchFilename
<font color="#FF0000"><b>Var
  </b></font>WDCount <font color="#000080">: </font>Integer<font color="#000080">;
  </font>WDBusy<font color="#000080">,</font>WdEvent <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>WDSave1c<font color="#000080">,</font>WDSaveExit<font color="#000080">: </font>Pointer<font color="#000080">;
  </font>DosReentrant <font color="#000080">: ^</font>Byte<font color="#000080">;
  </font>IntVec <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Pointer <font color="#FF0000"><b>Absolute </b></font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">0</font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>STI<font color="#000080">;
</font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FB</font><font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>CLI<font color="#000080">;
</font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">);

</font><font color="#008000"><i>(*Do not use Turbo-Pascal I/O Routines in here.*)
(*Be also sure not to use GetTime/Date at the same time as this routine*)

</i></font><font color="#FF0000"><b>Procedure </b></font>WatchDog<font color="#000080">;</font>interrupt<font color="#000080">;
</font><font color="#FF0000"><b>Var </b></font>h<font color="#000080">,</font>m<font color="#000080">,</font>s<font color="#000080">,</font>c <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not </b></font>WDBusy <font color="#FF0000"><b>then
  begin
    </b></font>WDBusy<font color="#000080">:=</font>True<font color="#000080">;
    </font>inc<font color="#000080">(</font>WDCount<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>DosReentrant<font color="#000080">^=</font><font color="#800000">0 </font><font color="#FF0000"><b>then      </b></font><font color="#008000"><i>(*No Dos op's in work ?*)
      </i></font><font color="#FF0000"><b>if </b></font>WDCount<font color="#000080">&gt;=</font>WdTryTime <font color="#FF0000"><b>then </b></font><font color="#008000"><i>(*Test only every second to prevent*)
      </i></font><font color="#FF0000"><b>begin                      </b></font><font color="#008000"><i>(*big loss in perFormance.        *)
        </i></font>WDCount<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
        </font>GetTime<font color="#000080">(</font>h<font color="#000080">,</font>m<font color="#000080">,</font>s<font color="#000080">,</font>c<font color="#000080">);              </font><font color="#008000"><i>(*Get Time*)

</i></font>here<font color="#000080">&gt;&gt;&gt; </font><font color="#FF0000"><b>if</b></font><font color="#000080">(</font>s<font color="#000080">=</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>s<font color="#000080">=</font><font color="#800000">45</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>(*Call on 15 minutes and 45 minutes*)

        </i></font><font color="#FF0000"><b>begin
          </b></font>Cli<font color="#000080">;</font>IntVec<font color="#000080">[</font><font color="#800000">$1c</font><font color="#000080">]:=</font>WDSave1C<font color="#000080">;</font>Sti<font color="#000080">;
          </font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$a0</font><font color="#000080">;</font><font color="#008000"><i>(*Report TimerInt finished to Interrupt-contr.*)
          </i></font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;
          </font>SwapVectors<font color="#000080">;      </font><font color="#008000"><i>(*Execute COMMand.COM + batchFile*)
          </i></font>Exec<font color="#000080">(</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font><font color="#800000">'/C '</font><font color="#000080">+</font>batchFilename<font color="#000080">);
          </font>SwapVectors<font color="#000080">;
          </font>Cli<font color="#000080">;</font>IntVec<font color="#000080">[</font><font color="#800000">$1c</font><font color="#000080">]:=@</font>Watchdog<font color="#000080">;</font>Sti<font color="#000080">;
          </font>WDEvent<font color="#000080">:=</font>True<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>WDBusy<font color="#000080">:=</font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>WDRemove<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>SetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">,</font>WDSave1c<font color="#000080">); </font><font color="#008000"><i>(*Restore old 1c routine*)
  </i></font>ExitProc<font color="#000080">:=</font>WDSaveExit<font color="#000080">;
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Exiting Watchdog'</font><font color="#000080">);
  </font>Halt<font color="#000080">(</font>Exitcode<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>WDInstall<font color="#000080">;
</font><font color="#FF0000"><b>Var </b></font>Regs<font color="#000080">:</font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>Regs <font color="#FF0000"><b>do
  begin
    </b></font>ah<font color="#000080">:=</font><font color="#800000">$34</font><font color="#000080">;
    </font>MsDos<font color="#000080">(</font>regs<font color="#000080">);
    </font>DosReentrant<font color="#000080">:=</font>ptr<font color="#000080">(</font>es<font color="#000080">,</font>bx<font color="#000080">); </font><font color="#008000"><i>(*Get Reentrant Pointer*)</i></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>WdCount<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>WDBusy<font color="#000080">:=</font>False<font color="#000080">;
  </font>WDEvent<font color="#000080">:=</font>False<font color="#000080">;
  </font>GetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">,</font>WDSave1C<font color="#000080">); </font><font color="#008000"><i>(*Save old 1c routine*)
  </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">,@</font>Watchdog<font color="#000080">); </font><font color="#008000"><i>(*Assign Watchdog to int 1c*)
  </i></font>WDSaveExit<font color="#000080">:=</font>ExitProc<font color="#000080">;
  </font>ExitProc<font color="#000080">:=@</font>WDRemove<font color="#000080">;
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Watchdog installed'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var </b></font>c<font color="#000080">:</font>Char<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>WDInstall<font color="#000080">;
  </font><font color="#FF0000"><b>Repeat </b></font><font color="#008000"><i>(*Example Main Loop*)
    </i></font>Write<font color="#000080">(</font><font color="#800000">'Hello'</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>WDEvent <font color="#FF0000"><b>then  </b></font><font color="#008000"><i>(*Watch sign of Watchdog*)
    </i></font><font color="#FF0000"><b>begin
      </b></font>Writeln<font color="#000080">;</font>Writeln<font color="#000080">(</font><font color="#800000">'Event occured'</font><font color="#000080">);
      </font>WDEvent<font color="#000080">:=</font>False<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>Delay<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font>KeyPressed<font color="#000080">;
  </font>c<font color="#000080">:=</font>ReadKey<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ISR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p></body>
</html>
