<html>
<head><title> "Zip Header" by EDWIN GROOTHUIS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0025.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Does anyone know where I can obtain source for reading a ZIP
&gt; file.  I know I could just shell and execute PKUNZIP, but the
&gt; looks horrible. 8-) I would like to do it as transparently as
&gt; possible (and without shelling :)  TIA!
}
</i></font><font color="#FF0000"><b>Type      </b></font>ZFHeader<font color="#000080">=</font><font color="#FF0000"><b>Record
                     </b></font>Signature                         <font color="#000080">:</font>longint<font color="#000080">;
                     </font>Version<font color="#000080">,</font>GPBFlag<font color="#000080">,</font>Compress<font color="#000080">,</font>Date<font color="#000080">,</font>Time<font color="#000080">:</font>word<font color="#000080">;
                     </font>CRC32<font color="#000080">,</font>CSize<font color="#000080">,</font>USize                 <font color="#000080">:</font>longint<font color="#000080">;
                     </font>FNameLen<font color="#000080">,</font>ExtraField               <font color="#000080">:</font>word<font color="#000080">;
                   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>type      </b></font>PZipArchive<font color="#000080">=^</font>TZipArchive<font color="#000080">;
          </font>TZipArchive<font color="#000080">=</font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TGeneralArchive<font color="#000080">)
                        </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">;
                        </font><font color="#FF0000"><b>procedure </b></font>FindFirst<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>sr<font color="#000080">:</font>SearchRec<font color="#000080">);</font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>procedure </b></font>FindNext<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>sr<font color="#000080">:</font>SearchRec<font color="#000080">);</font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                      </font><font color="#FF0000"><b>private
                        </b></font>Hdr<font color="#000080">:</font>ZFHeader<font color="#000080">;
                        </font><font color="#FF0000"><b>function  </b></font>GetHeader<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>sr<font color="#000080">:</font>SearchRec<font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
                      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

uses      </b></font>Objects<font color="#000080">,</font>OOAVUtil<font color="#000080">;

</font><font color="#FF0000"><b>Const     </b></font>SIG <font color="#000080">= </font><font color="#800000">$04034B50</font><font color="#000080">;                  </font><font color="#008000"><i>{ Signature }


</i></font><font color="#FF0000"><b>constructor </b></font>TZipArchive<font color="#000080">.</font>Init<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FillChar<font color="#000080">(</font>Hdr<font color="#000080">,</font>sizeof<font color="#000080">(</font>Hdr<font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>function  </b></font>TZipArchive<font color="#000080">.</font>GetHeader<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>sr<font color="#000080">:</font>SearchRec<font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var       </b></font>b<font color="#000080">:</font>byte<font color="#000080">;
          </font>FName<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>fillchar<font color="#000080">(</font>sr<font color="#000080">,</font>sizeof<font color="#000080">(</font>sr<font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>_FArchive<font color="#000080">^.</font>GetPos<font color="#000080">=</font>_FArchive<font color="#000080">^.</font>GetSize <font color="#FF0000"><b>then
    </b></font>exit<font color="#000080">;
  </font>_Farchive<font color="#000080">^.</font>Read<font color="#000080">(</font>Hdr<font color="#000080">,</font>SizeOf<font color="#000080">(</font>Hdr<font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font>_FArchive<font color="#000080">^.</font>Status<font color="#000080">&lt;&gt;</font>stOk <font color="#FF0000"><b>then
    </b></font>exit<font color="#000080">;
</font><font color="#008000"><i>{ Why checking for Hdr.FNamelen=0?
  Because the comments inserted in a ZIP-file are at the last field }
  </i></font><font color="#FF0000"><b>if </b></font>Hdr<font color="#000080">.</font>FNameLen<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>exit<font color="#000080">;
  </font>FName<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>Repeat
    </b></font>_FArchive<font color="#000080">^.</font>Read<font color="#000080">(</font>b<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>b<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Then
      </b></font>FName<font color="#000080">:=</font>FName<font color="#000080">+</font>Chr<font color="#000080">(</font>b<font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>length<font color="#000080">(</font>FName<font color="#000080">)=</font>Hdr<font color="#000080">.</font>FNameLen<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>b<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>b<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>GetHeader<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
    </font>exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>_FArchive<font color="#000080">^.</font>Seek<font color="#000080">(</font>_FArchive<font color="#000080">^.</font>GetPos<font color="#000080">+</font>Hdr<font color="#000080">.</font>CSize<font color="#000080">+</font>Hdr<font color="#000080">.</font>ExtraField<font color="#000080">);
  </font>sr<font color="#000080">.</font>Size<font color="#000080">:=</font>Hdr<font color="#000080">.</font>USize<font color="#000080">;
  </font>sr<font color="#000080">.</font>Time<font color="#000080">:=</font>Hdr<font color="#000080">.</font>Date<font color="#000080">+</font>Hdr<font color="#000080">.</font>Time<font color="#000080">*</font>longint<font color="#000080">(</font><font color="#800000">256</font><font color="#000080">*</font><font color="#800000">256</font><font color="#000080">);
  </font>GetHeader<font color="#000080">:=</font>FName<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>TZipArchive<font color="#000080">.</font>FindFirst<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>sr<font color="#000080">:</font>SearchRec<font color="#000080">);
</font><font color="#FF0000"><b>var       </b></font>FName<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
          </font>found<font color="#000080">:</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>found<font color="#000080">:=</font>false<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>FName<font color="#000080">:=</font>GetHeader<font color="#000080">(</font>sr<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>FName<font color="#000080">=</font><font color="#800000">'' </font><font color="#FF0000"><b>then
    begin
      </b></font>found<font color="#000080">:=</font>true<font color="#000080">;
      </font>sr<font color="#000080">.</font>Name<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font>pos<font color="#000080">(</font><font color="#800000">'/'</font><font color="#000080">,</font>FName<font color="#000080">)&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>do
      </b></font>FName<font color="#000080">[</font>pos<font color="#000080">(</font><font color="#800000">'/'</font><font color="#000080">,</font>FName<font color="#000080">)]:=</font><font color="#800000">'\'</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Fits<font color="#000080">(</font>FName<font color="#000080">,</font>_SearchDir<font color="#000080">+</font>_SearchFile<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>sr<font color="#000080">.</font>Name<font color="#000080">:=</font>copy<font color="#000080">(</font>FName<font color="#000080">,</font>length<font color="#000080">(</font>_SearchDir<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">12</font><font color="#000080">);
      </font>found<font color="#000080">:=</font>true<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>until </b></font>found<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>TZipArchive<font color="#000080">.</font>FindNext<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>sr<font color="#000080">:</font>SearchRec<font color="#000080">);
</font><font color="#FF0000"><b>var       </b></font>FName<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
          </font>found<font color="#000080">:</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>found<font color="#000080">:=</font>false<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>FName<font color="#000080">:=</font>GetHeader<font color="#000080">(</font>sr<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>FName<font color="#000080">=</font><font color="#800000">'' </font><font color="#FF0000"><b>then
    begin
      </b></font>found<font color="#000080">:=</font>true<font color="#000080">;
      </font>sr<font color="#000080">.</font>Name<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font>pos<font color="#000080">(</font><font color="#800000">'/'</font><font color="#000080">,</font>FName<font color="#000080">)&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>do
      </b></font>FName<font color="#000080">[</font>pos<font color="#000080">(</font><font color="#800000">'/'</font><font color="#000080">,</font>FName<font color="#000080">)]:=</font><font color="#800000">'\'</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Fits<font color="#000080">(</font>FName<font color="#000080">,</font>_SearchDir<font color="#000080">+</font>_SearchFile<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>sr<font color="#000080">.</font>Name<font color="#000080">:=</font>copy<font color="#000080">(</font>FName<font color="#000080">,</font>length<font color="#000080">(</font>_SearchDir<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">12</font><font color="#000080">);
      </font>found<font color="#000080">:=</font>true<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>until </b></font>found<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0025.PAS">Original</a><b>]</b></p></body>
</html>
