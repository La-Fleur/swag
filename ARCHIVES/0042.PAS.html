<html>
<head><title> "ZIP Text Viewer" by SAMUEL H. SMITH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0042.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>(*
 * Copyright 1987, 1990 Samuel H. Smith;  All rights reserved
 *
 * This is a component of the ProDoor System.
 * Do not distribute modified versions without my permission.
 * Do not remove or alter this notice or any other copyright notice.
 * If you use this in your own program you must distribute source code.
 * Do not use any of this in a commercial product.
 *
 *)

(*
 * ZipTV - zipfile text view utility/door
 *
 *)

{$I prodef.inc}

{$M 5000,0,0} {minstack,minheap,maxheap}

{$D+}    {Global debug information}
{$L+}    {Local debug information}

{ $r+,s+}

</i></font><font color="#FF0000"><b>program </b></font>ZipTV<font color="#000080">;

</font><font color="#FF0000"><b>Uses
   </b></font>Dos<font color="#000080">, </font>DosMem<font color="#000080">, </font>MiniCrt<font color="#000080">, </font>Mdosio<font color="#000080">, </font>Tools<font color="#000080">, </font>CInput<font color="#000080">;

</font><font color="#FF0000"><b>const
   </b></font>version <font color="#000080">= </font><font color="#800000">'ZipTV:  ZIP Text Viewer v2.1 of 04-22-90;  (C) 1990 S.H.Smith'</font><font color="#000080">;


</font><font color="#008000"><i>(* ----------------------------------------------------------- *)
(*
 * ZIPfile layout declarations
 *
 *)

</i></font><font color="#FF0000"><b>type
   </b></font>signature_type <font color="#000080">= </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>const
   </b></font>local_file_header_signature <font color="#000080">= </font><font color="#800000">$04034b50</font><font color="#000080">;

</font><font color="#FF0000"><b>type
   </b></font>local_file_header <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>version_needed_to_extract<font color="#000080">:    </font>word<font color="#000080">;
      </font>general_purpose_bit_flag<font color="#000080">:     </font>word<font color="#000080">;
      </font>compression_method<font color="#000080">:           </font>word<font color="#000080">;
      </font>last_mod_file_time<font color="#000080">:           </font>word<font color="#000080">;
      </font>last_mod_file_date<font color="#000080">:           </font>word<font color="#000080">;
      </font>crc32<font color="#000080">:                        </font>longint<font color="#000080">;
      </font>compressed_size<font color="#000080">:              </font>longint<font color="#000080">;
      </font>uncompressed_size<font color="#000080">:            </font>longint<font color="#000080">;
      </font>filename_length<font color="#000080">:              </font>word<font color="#000080">;
      </font>extra_field_length<font color="#000080">:           </font>word<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
   </b></font><font color="#008000"><i>{general_purpose_bit_flag bit values}
   </i></font>GP_encrypted   <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;     </font><font color="#008000"><i>{file is encrypted}
   </i></font>GP_8K_dict     <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;     </font><font color="#008000"><i>{8k implode dictionary}
   </i></font>GP_lit_tree    <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;     </font><font color="#008000"><i>{literal implode tree is present}


</i></font><font color="#FF0000"><b>const
   </b></font>central_file_header_signature <font color="#000080">= </font><font color="#800000">$02014b50</font><font color="#000080">;

</font><font color="#FF0000"><b>type
   </b></font>central_directory_file_header <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>version_made_by<font color="#000080">:                 </font>word<font color="#000080">;
      </font>version_needed_to_extract<font color="#000080">:       </font>word<font color="#000080">;
      </font>general_purpose_bit_flag<font color="#000080">:        </font>word<font color="#000080">;
      </font>compression_method<font color="#000080">:              </font>word<font color="#000080">;
      </font>last_mod_file_time<font color="#000080">:              </font>word<font color="#000080">;
      </font>last_mod_file_date<font color="#000080">:              </font>word<font color="#000080">;
      </font>crc32<font color="#000080">:                           </font>longint<font color="#000080">;
      </font>compressed_size<font color="#000080">:                 </font>longint<font color="#000080">;
      </font>uncompressed_size<font color="#000080">:               </font>longint<font color="#000080">;
      </font>filename_length<font color="#000080">:                 </font>word<font color="#000080">;
      </font>extra_field_length<font color="#000080">:              </font>word<font color="#000080">;
      </font>file_comment_length<font color="#000080">:             </font>word<font color="#000080">;
      </font>disk_number_start<font color="#000080">:               </font>word<font color="#000080">;
      </font>internal_file_attributes<font color="#000080">:        </font>word<font color="#000080">;
      </font>external_file_attributes<font color="#000080">:        </font>longint<font color="#000080">;
      </font>relative_offset_local_header<font color="#000080">:    </font>longint<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
   </b></font>end_central_dir_signature <font color="#000080">= </font><font color="#800000">$06054b50</font><font color="#000080">;

</font><font color="#FF0000"><b>type
   </b></font>end_central_dir_record <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>number_this_disk<font color="#000080">:                         </font>word<font color="#000080">;
      </font>number_disk_with_start_central_directory<font color="#000080">: </font>word<font color="#000080">;
      </font>total_entries_central_dir_on_this_disk<font color="#000080">:   </font>word<font color="#000080">;
      </font>total_entries_central_dir<font color="#000080">:                </font>word<font color="#000080">;
      </font>size_central_directory<font color="#000080">:                   </font>longint<font color="#000080">;
      </font>offset_start_central_directory<font color="#000080">:           </font>longint<font color="#000080">;
      </font>zipfile_comment_length<font color="#000080">:                   </font>word<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
   </b></font>compression_methods<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>of string</b></font><font color="#000080">[</font><font color="#800000">8</font><font color="#000080">] =
      (</font><font color="#800000">' Stored '</font><font color="#000080">,
       </font><font color="#800000">' Shrunk '</font><font color="#000080">,
       </font><font color="#800000">'Reduce-1'</font><font color="#000080">, </font><font color="#800000">'Reduce-2'</font><font color="#000080">, </font><font color="#800000">'Reduce-3'</font><font color="#000080">, </font><font color="#800000">'Reduce-4'</font><font color="#000080">,
       </font><font color="#800000">'Imploded'</font><font color="#000080">,
       </font><font color="#800000">'    ?   '</font><font color="#000080">);


</font><font color="#008000"><i>(* ----------------------------------------------------------- *)
(*
 * input file variables
 *
 *)

</i></font><font color="#FF0000"><b>const
   </b></font>uinbufsize <font color="#000080">= </font><font color="#800000">512</font><font color="#000080">;    </font><font color="#008000"><i>{input buffer size}

</i></font><font color="#FF0000"><b>var
   </b></font>zipeof<font color="#000080">:     </font>boolean<font color="#000080">;

   </font>csize<font color="#000080">:      </font>longint<font color="#000080">;
   </font>cusize<font color="#000080">:     </font>longint<font color="#000080">;
   </font>cmethod<font color="#000080">:    </font>integer<font color="#000080">;
   </font>cflags<font color="#000080">:     </font>word<font color="#000080">;

   </font>inbuf<font color="#000080">:      </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>uinbufsize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
   </font>inpos<font color="#000080">:      </font>integer<font color="#000080">;
   </font>incnt<font color="#000080">:      </font>integer<font color="#000080">;
   </font>pc<font color="#000080">:         </font>byte<font color="#000080">;
   </font>pcbits<font color="#000080">:     </font>byte<font color="#000080">;
   </font>pcbitv<font color="#000080">:     </font>byte<font color="#000080">;
   </font>zipfd<font color="#000080">:      </font>dos_handle<font color="#000080">;
   </font>zipfn<font color="#000080">:      </font>dos_filename<font color="#000080">;



</font><font color="#008000"><i>(* ----------------------------------------------------------- *)
(*
 * output stream variables
 *
 *)

</i></font><font color="#FF0000"><b>const
   </b></font>hsize <font color="#000080">=     </font><font color="#800000">8192</font><font color="#000080">;    </font><font color="#008000"><i>{must be 8192 for 13 bit shrinking}

   </i></font>max_binary <font color="#000080">= </font><font color="#800000">50</font><font color="#000080">;     </font><font color="#008000"><i>{non-printing count before binary file trigger}
   </i></font>max_linelen <font color="#000080">= </font><font color="#800000">200</font><font color="#000080">;   </font><font color="#008000"><i>{line length before binary file triggered}

   </i></font>maxlines<font color="#000080">: </font>integer <font color="#000080">= </font><font color="#800000">500</font><font color="#000080">;
                        </font><font color="#008000"><i>{maximum lines per session}

</i></font><font color="#FF0000"><b>var
   </b></font>uoutbuf<font color="#000080">:             </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font>max_linelen<font color="#000080">];    </font><font color="#008000"><i>{disp line buffer}
   </i></font>binary_count<font color="#000080">:        </font>integer<font color="#000080">;                </font><font color="#008000"><i>{non-text chars so far}

   </i></font>outbuf<font color="#000080">:              </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>hsize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">; </font><font color="#008000"><i>{must be &gt;= 8192 for look-back}
   </i></font>outpos<font color="#000080">:              </font>longint<font color="#000080">;                 </font><font color="#008000"><i>{absolute position in outfile}


(* ----------------------------------------------------------- *)
(*
 * other working storage
 *
 *)

</i></font><font color="#FF0000"><b>var
   </b></font>expand_files<font color="#000080">:        </font>boolean<font color="#000080">;
   </font>header_present<font color="#000080">:      </font>boolean<font color="#000080">;
   </font>default_pattern<font color="#000080">:     </font>string20<font color="#000080">;
   </font>pattern<font color="#000080">:             </font>string20<font color="#000080">;
   </font>action<font color="#000080">:              </font>string20<font color="#000080">;



</font><font color="#008000"><i>(* ----------------------------------------------------
 *
 *  Zipfile input/output handlers
 *
 *)

</i></font><font color="#FF0000"><b>procedure </b></font>skip_rest<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>dos_lseek<font color="#000080">(</font>zipfd<font color="#000080">,</font>csize<font color="#000080">-</font>incnt<font color="#000080">,</font>seek_cur<font color="#000080">);
   </font>zipeof <font color="#000080">:= </font>true<font color="#000080">;
   </font>csize <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>incnt <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>skip_csize<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>incnt <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>skip_rest<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ------------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>ReadByte<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>x<font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
   if </b></font>incnt <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
   begin
      if </b></font>csize <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
         </b></font>zipeof <font color="#000080">:= </font>true<font color="#000080">;
         </font>exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>inpos <font color="#000080">:= </font>sizeof<font color="#000080">(</font>inbuf<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>inpos <font color="#000080">&gt; </font>csize <font color="#FF0000"><b>then
         </b></font>inpos <font color="#000080">:= </font>csize<font color="#000080">;
      </font>incnt <font color="#000080">:= </font>dos_read<font color="#000080">(</font>zipfd<font color="#000080">,</font>inbuf<font color="#000080">,</font>inpos<font color="#000080">);

      </font>inpos <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font>dec<font color="#000080">(</font>csize<font color="#000080">,</font>incnt<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>x <font color="#000080">:= </font>inbuf<font color="#000080">[</font>inpos<font color="#000080">];
   </font>inc<font color="#000080">(</font>inpos<font color="#000080">);
   </font>dec<font color="#000080">(</font>incnt<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ------------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>ReadBits<font color="#000080">(</font>bits<font color="#000080">: </font>integer<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>x<font color="#000080">: </font>integer<font color="#000080">);
   </font><font color="#008000"><i>{read the specified number of bits}
</i></font><font color="#FF0000"><b>var
   </b></font>bit<font color="#000080">:     </font>integer<font color="#000080">;
   </font>bitv<font color="#000080">:    </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin

</b></font><font color="#008000"><i>(****
write('readbits n=',bits,' b=');
****)

   </i></font>x <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>bitv <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;

   </font><font color="#FF0000"><b>for </b></font>bit <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>bits<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
   begin

      if </b></font>pcbits <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
         </b></font>dec<font color="#000080">(</font>pcbits<font color="#000080">);
         </font>pcbitv <font color="#000080">:= </font>pcbitv <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>end
      else

      begin
         </b></font>ReadByte<font color="#000080">(</font>pc<font color="#000080">);
         </font>pcbits <font color="#000080">:= </font><font color="#800000">7</font><font color="#000080">;
         </font>pcbitv <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>pc <font color="#FF0000"><b>and </b></font>pcbitv<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
         </b></font>x <font color="#000080">:= </font>x <font color="#FF0000"><b>or </b></font>bitv<font color="#000080">;

      </font>bitv <font color="#000080">:= </font>bitv <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>(****
writeln(' -&gt; ',x,' = ',binary(x));
*****)

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>get_string<font color="#000080">(</font>len<font color="#000080">: </font>integer<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>s<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>n<font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
   if </b></font>len <font color="#000080">&lt;= </font><font color="#800000">255 </font><font color="#FF0000"><b>then
      </b></font>n <font color="#000080">:= </font>dos_read<font color="#000080">(</font>zipfd<font color="#000080">,</font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>len<font color="#000080">)
   </font><font color="#FF0000"><b>else
   begin
      </b></font>n <font color="#000080">:= </font>dos_read<font color="#000080">(</font>zipfd<font color="#000080">,</font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font><font color="#800000">255</font><font color="#000080">);
      </font>dos_lseek<font color="#000080">(</font>zipfd<font color="#000080">,</font>len<font color="#000080">-</font><font color="#800000">255</font><font color="#000080">,</font>seek_cur<font color="#000080">);
      </font>len <font color="#000080">:= </font><font color="#800000">255</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>chr<font color="#000080">(</font>len<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ------------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>OutByte <font color="#000080">(</font>c<font color="#000080">: </font>integer<font color="#000080">);
   </font><font color="#008000"><i>(* output each character from archive to screen *)

   </i></font><font color="#FF0000"><b>procedure </b></font>flushbuf<font color="#000080">;
   </font><font color="#FF0000"><b>begin
      </b></font>disp<font color="#000080">(</font>uoutbuf<font color="#000080">);
      </font>uoutbuf <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>procedure </b></font>addchar<font color="#000080">;
   </font><font color="#FF0000"><b>begin
      </b></font>inc<font color="#000080">(</font>uoutbuf<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
      </font>uoutbuf<font color="#000080">[</font>length<font color="#000080">(</font>uoutbuf<font color="#000080">)] := </font>chr<font color="#000080">(</font>c<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>procedure </b></font>not_text<font color="#000080">;
   </font><font color="#FF0000"><b>begin
      </b></font>newline<font color="#000080">;
      </font>displn<font color="#000080">(</font><font color="#800000">'This is not a text file!'</font><font color="#000080">);
      </font>linenum <font color="#000080">:= </font><font color="#800000">1000</font><font color="#000080">;
      </font>skip_rest<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   
</font><font color="#FF0000"><b>begin
   </b></font>outbuf<font color="#000080">[</font>outpos <font color="#FF0000"><b>mod </b></font>sizeof<font color="#000080">(</font>outbuf<font color="#000080">)] := </font>c<font color="#000080">;
   </font>inc<font color="#000080">(</font>outpos<font color="#000080">);

</font><font color="#008000"><i>(********
if debug then begin
if c = 13 then else
if c = 10 then begin
   if nomore then
      skip_rest
   else
      newline;
end else write(chr(c));
writeln(' [outbyte c=',c:3,' outpos=',outpos-1:5,']');
if keypressed and (readkey=#27) then halt;
exit; end;
********)

   </i></font><font color="#FF0000"><b>case </b></font>c <font color="#FF0000"><b>of
   </b></font><font color="#800000">10</font><font color="#000080">:  </font><font color="#FF0000"><b>begin
           if </b></font>linenum <font color="#000080">&lt; </font><font color="#800000">1000 </font><font color="#FF0000"><b>then
           begin
              </b></font>flushbuf<font color="#000080">;
              </font>newline<font color="#000080">;

              </font>dec<font color="#000080">(</font>maxlines<font color="#000080">);
              </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>maxlines <font color="#000080">&lt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>dump_user<font color="#000080">) </font><font color="#FF0000"><b>then
              begin
                  </b></font>newline<font color="#000080">;
                  </font>displn<font color="#000080">(</font><font color="#800000">'You''ve seen enough.  Please download this file if you want to see more.'</font><font color="#000080">);
                  </font>dump_user <font color="#000080">:= </font>true<font color="#000080">;
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
           </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

           </font><font color="#FF0000"><b>if </b></font>nomore <font color="#FF0000"><b>or </b></font>dump_user <font color="#FF0000"><b>then
              </b></font>skip_rest<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#800000">13</font><font color="#000080">:   ;

   </font><font color="#800000">26</font><font color="#000080">: </font><font color="#FF0000"><b>begin
          </b></font>flushbuf<font color="#000080">;
          </font>skip_rest<font color="#000080">;         </font><font color="#008000"><i>{jump to nomore mode on ^z}
       </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">9</font><font color="#000080">,</font><font color="#800000">32</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">:
       </font><font color="#FF0000"><b>begin
          if </b></font>length<font color="#000080">(</font>uoutbuf<font color="#000080">) &gt;= </font>max_linelen <font color="#FF0000"><b>then
          begin
             </b></font>flushbuf<font color="#000080">;
             </font><font color="#FF0000"><b>if </b></font>csize <font color="#000080">&gt; </font><font color="#800000">10 </font><font color="#FF0000"><b>then
                </b></font>not_text<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

          </font><font color="#FF0000"><b>if </b></font>linenum <font color="#000080">&lt; </font><font color="#800000">1000 </font><font color="#FF0000"><b>then   </b></font><font color="#008000"><i>{stop display on nomore}
             </i></font>addchar<font color="#000080">;
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>else
      begin
         if </b></font>binary_count <font color="#000080">&lt; </font>max_binary <font color="#FF0000"><b>then
            </b></font>inc<font color="#000080">(</font>binary_count<font color="#000080">)
         </font><font color="#FF0000"><b>else
         if </b></font>csize <font color="#000080">&gt; </font><font color="#800000">10 </font><font color="#FF0000"><b>then
            </b></font>not_text<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ------------------------------------------------------------- *)
(*
 * The Reducing algorithm is actually a combination of two
 * distinct algorithms.  The first algorithm compresses repeated
 * byte sequences, and the second algorithm takes the compressed
 * stream from the first algorithm and applies a probabilistic
 * compression method.
 *
 *)

</i></font><font color="#FF0000"><b>procedure </b></font>unReduce<font color="#000080">;
   </font><font color="#008000"><i>{expand probablisticly reduced data}

   </i></font><font color="#FF0000"><b>type
      </b></font>Sarray <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of string</b></font><font color="#000080">[</font><font color="#800000">64</font><font color="#000080">];

   </font><font color="#FF0000"><b>var
      </b></font>factor<font color="#000080">:     </font>integer<font color="#000080">;
      </font>followers<font color="#000080">:  ^</font>Sarray<font color="#000080">;
      </font>ExState<font color="#000080">:    </font>integer<font color="#000080">;
      </font>C<font color="#000080">:          </font>integer<font color="#000080">;
      </font>V<font color="#000080">:          </font>integer<font color="#000080">;
      </font>Len<font color="#000080">:        </font>integer<font color="#000080">;

   </font><font color="#FF0000"><b>const
      </b></font>Lmask<font color="#000080">:   </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer <font color="#000080">= (</font><font color="#800000">$7f</font><font color="#000080">,</font><font color="#800000">$3f</font><font color="#000080">,</font><font color="#800000">$1f</font><font color="#000080">,</font><font color="#800000">$0f</font><font color="#000080">);
      </font>Fcase<font color="#000080">:   </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer <font color="#000080">= (</font><font color="#800000">127</font><font color="#000080">, </font><font color="#800000">63</font><font color="#000080">, </font><font color="#800000">31</font><font color="#000080">, </font><font color="#800000">15</font><font color="#000080">);
      </font>Dshift<font color="#000080">:  </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer <font color="#000080">= (</font><font color="#800000">7</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">5</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">);
      </font>Dand<font color="#000080">:    </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer <font color="#000080">= (</font><font color="#800000">$01</font><font color="#000080">,</font><font color="#800000">$03</font><font color="#000080">,</font><font color="#800000">$07</font><font color="#000080">,</font><font color="#800000">$0f</font><font color="#000080">);


   </font><font color="#FF0000"><b>procedure </b></font>Expand<font color="#000080">(</font>c<font color="#000080">: </font>byte<font color="#000080">);
   </font><font color="#FF0000"><b>const
      </b></font>DLE <font color="#000080">= </font><font color="#800000">144</font><font color="#000080">;
   </font><font color="#FF0000"><b>var
      </b></font>op<font color="#000080">:   </font>longint<font color="#000080">;
      </font>i<font color="#000080">:    </font>integer<font color="#000080">;

   </font><font color="#FF0000"><b>begin

      case </b></font>ExState <font color="#FF0000"><b>of
           </b></font><font color="#800000">0</font><font color="#000080">:  </font><font color="#FF0000"><b>if </b></font>C <font color="#000080">&lt;&gt; </font>DLE <font color="#FF0000"><b>then
                   </b></font>OutByte<font color="#000080">(</font>C<font color="#000080">)
               </font><font color="#FF0000"><b>else
                   </b></font>ExState <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;

           </font><font color="#800000">1</font><font color="#000080">:  </font><font color="#FF0000"><b>if </b></font>C <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
               begin
                   </b></font>V <font color="#000080">:= </font>C<font color="#000080">;
                   </font>Len <font color="#000080">:= </font>V <font color="#FF0000"><b>and </b></font>Lmask<font color="#000080">[</font>factor<font color="#000080">];
                   </font><font color="#FF0000"><b>if </b></font>Len <font color="#000080">= </font>Fcase<font color="#000080">[</font>factor<font color="#000080">] </font><font color="#FF0000"><b>then
                     </b></font>ExState <font color="#000080">:= </font><font color="#800000">2
                   </font><font color="#FF0000"><b>else
                     </b></font>ExState <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;
               </font><font color="#FF0000"><b>end
               else
               begin
                   </b></font>OutByte<font color="#000080">(</font>DLE<font color="#000080">);
                   </font>ExState <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

           </font><font color="#800000">2</font><font color="#000080">:  </font><font color="#FF0000"><b>begin
                  </b></font>inc<font color="#000080">(</font>Len<font color="#000080">,</font>C<font color="#000080">);
                  </font>ExState <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

           </font><font color="#800000">3</font><font color="#000080">:  </font><font color="#FF0000"><b>begin
                  </b></font>op <font color="#000080">:= </font>outpos <font color="#000080">- </font>C <font color="#000080">- </font><font color="#800000">1 </font><font color="#000080">- ((</font>V <font color="#FF0000"><b>shr </b></font>Dshift<font color="#000080">[</font>factor<font color="#000080">]) </font><font color="#FF0000"><b>and
                                          </b></font>Dand<font color="#000080">[</font>factor<font color="#000080">]) * </font><font color="#800000">256</font><font color="#000080">;

                  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Len<font color="#000080">+</font><font color="#800000">2 </font><font color="#FF0000"><b>do
                  begin
                     if </b></font>op <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
                        </b></font>OutByte<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)
                     </font><font color="#FF0000"><b>else
                        </b></font>OutByte<font color="#000080">(</font>outbuf<font color="#000080">[</font>op <font color="#FF0000"><b>mod </b></font>sizeof<font color="#000080">(</font>outbuf<font color="#000080">)]);
                     </font>inc<font color="#000080">(</font>op<font color="#000080">);
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

                  </font>ExState <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#FF0000"><b>procedure </b></font>LoadFollowers<font color="#000080">;
   </font><font color="#FF0000"><b>var
      </b></font>x<font color="#000080">: </font>integer<font color="#000080">;
      </font>i<font color="#000080">: </font>integer<font color="#000080">;
      </font>b<font color="#000080">: </font>integer<font color="#000080">;
   </font><font color="#FF0000"><b>begin
      for </b></font>x <font color="#000080">:= </font><font color="#800000">255 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
      begin
         </b></font>ReadBits<font color="#000080">(</font><font color="#800000">6</font><font color="#000080">,</font>b<font color="#000080">);
         </font>followers<font color="#000080">^[</font>x<font color="#000080">][</font><font color="#800000">0</font><font color="#000080">] := </font>chr<font color="#000080">(</font>b<font color="#000080">);

         </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>followers<font color="#000080">^[</font>x<font color="#000080">]) </font><font color="#FF0000"><b>do
         begin
            </b></font>ReadBits<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,</font>b<font color="#000080">);
            </font>followers<font color="#000080">^[</font>x<font color="#000080">][</font>i<font color="#000080">] := </font>chr<font color="#000080">(</font>b<font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#FF0000"><b>function </b></font>B<font color="#000080">(</font>x<font color="#000080">: </font>byte<font color="#000080">): </font>word<font color="#000080">;
      </font><font color="#008000"><i>{number of bits needed to encode the specified number}
   </i></font><font color="#FF0000"><b>begin
      case </b></font>x<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>of
         </b></font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">:    </font>B <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
         </font><font color="#800000">2</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">:    </font>B <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
         </font><font color="#800000">4</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">:    </font>B <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;
         </font><font color="#800000">8</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">:   </font>B <font color="#000080">:= </font><font color="#800000">4</font><font color="#000080">;
        </font><font color="#800000">16</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">:   </font>B <font color="#000080">:= </font><font color="#800000">5</font><font color="#000080">;
        </font><font color="#800000">32</font><font color="#000080">..</font><font color="#800000">63</font><font color="#000080">:   </font>B <font color="#000080">:= </font><font color="#800000">6</font><font color="#000080">;
        </font><font color="#800000">64</font><font color="#000080">..</font><font color="#800000">127</font><font color="#000080">:  </font>B <font color="#000080">:= </font><font color="#800000">7</font><font color="#000080">;
      </font><font color="#FF0000"><b>else        </b></font>B <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ----------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>var
   </b></font>lchar<font color="#000080">:   </font>integer<font color="#000080">;
   </font>lout<font color="#000080">:    </font>integer<font color="#000080">;
   </font>I<font color="#000080">:       </font>integer<font color="#000080">;
   </font>mem<font color="#000080">:     </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>mem <font color="#000080">:= (</font>sizeof<font color="#000080">(</font>followers<font color="#000080">^)+</font><font color="#800000">100</font><font color="#000080">) - </font>dos_maxavail<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>mem <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
   begin
      </b></font>displn<font color="#000080">(</font>ltoa<font color="#000080">(</font>mem<font color="#000080">)+</font><font color="#800000">' more bytes of RAM needed to UnReduce!'</font><font color="#000080">);
      </font>skip_csize<font color="#000080">;
      </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>factor <font color="#000080">:= </font>cmethod <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>factor <font color="#000080">&lt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>factor <font color="#000080">&gt; </font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>then
   begin
      </b></font>skip_csize<font color="#000080">;
      </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>dos_getmem<font color="#000080">(</font>followers<font color="#000080">,</font>sizeof<font color="#000080">(</font>followers<font color="#000080">^));
   </font>ExState <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>LoadFollowers<font color="#000080">;
   </font>lchar <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>zipeof<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>outpos <font color="#000080">&lt; </font>cusize<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>dump_user<font color="#000080">) </font><font color="#FF0000"><b>do
   begin

      if </b></font>followers<font color="#000080">^[</font>lchar<font color="#000080">] = </font><font color="#800000">'' </font><font color="#FF0000"><b>then
         </b></font>ReadBits<font color="#000080">( </font><font color="#800000">8</font><font color="#000080">,</font>lout <font color="#000080">)
      </font><font color="#FF0000"><b>else

      begin
         </b></font>ReadBits<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>lout<font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>lout <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
            </b></font>ReadBits<font color="#000080">( </font><font color="#800000">8</font><font color="#000080">,</font>lout <font color="#000080">)
         </font><font color="#FF0000"><b>else
         begin
            </b></font>ReadBits<font color="#000080">( </font>B<font color="#000080">(</font>length<font color="#000080">(</font>followers<font color="#000080">^[</font>lchar<font color="#000080">])), </font>I <font color="#000080">);
            </font>lout <font color="#000080">:= </font>ord<font color="#000080">( </font>followers<font color="#000080">^[</font>lchar<font color="#000080">][</font>I<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">] );
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>Expand<font color="#000080">( </font>lout <font color="#000080">);
      </font>lchar <font color="#000080">:= </font>lout<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>dos_freemem<font color="#000080">(</font>followers<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#008000"><i>(* ------------------------------------------------------------- *)
(*
 * UnShrinking
 * -----------
 *
 * Shrinking is a Dynamic Ziv-Lempel-Welch compression algorithm
 * with partial clearing.  The initial code size is 9 bits, and
 * the maximum code size is 13 bits.  Shrinking differs from
 * conventional Dynamic Ziv-lempel-Welch implementations in several
 * respects:
 *
 * 1)  The code size is controlled by the compressor, and is not
 *     automatically increased when codes larger than the current
 *     code size are created (but not necessarily used).  When
 *     the decompressor encounters the code sequence 256
 *     (decimal) followed by 1, it should increase the code size
 *     read from the input stream to the next bit size.  No
 *     blocking of the codes is performed, so the next code at
 *     the increased size should be read from the input stream
 *     immediately after where the previous code at the smaller
 *     bit size was read.  Again, the decompressor should not
 *     increase the code size used until the sequence 256,1 is
 *     encountered.
 *
 * 2)  When the table becomes full, total clearing is not
 *     performed.  Rather, when the compresser emits the code
 *     sequence 256,2 (decimal), the decompressor should clear
 *     all leaf nodes from the Ziv-Lempel tree, and continue to
 *     use the current code size.  The nodes that are cleared
 *     from the Ziv-Lempel tree are then re-used, with the lowest
 *     code value re-used first, and the highest code value
 *     re-used last.  The compressor can emit the sequence 256,2
 *     at any time.
 *
 *)

</i></font><font color="#FF0000"><b>procedure </b></font>unShrink<font color="#000080">;

</font><font color="#FF0000"><b>const
   </b></font>max_bits <font color="#000080">=  </font><font color="#800000">13</font><font color="#000080">;
   </font>init_bits <font color="#000080">= </font><font color="#800000">9</font><font color="#000080">;
   </font>first_ent <font color="#000080">= </font><font color="#800000">257</font><font color="#000080">;
   </font>clear <font color="#000080">=     </font><font color="#800000">256</font><font color="#000080">;
   
</font><font color="#FF0000"><b>type
   </b></font>hsize_array_integer <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>hsize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>integer<font color="#000080">;
   </font>hsize_array_byte    <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>hsize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;

</font><font color="#FF0000"><b>var
   </b></font>cbits<font color="#000080">:      </font>integer<font color="#000080">;
   </font>maxcode<font color="#000080">:    </font>integer<font color="#000080">;
   </font>free_ent<font color="#000080">:   </font>integer<font color="#000080">;
   </font>maxcodemax<font color="#000080">: </font>integer<font color="#000080">;
   </font>offset<font color="#000080">:     </font>integer<font color="#000080">;
   </font>sizex<font color="#000080">:      </font>integer<font color="#000080">;
   </font>prefix_of<font color="#000080">:  ^</font>hsize_array_integer<font color="#000080">;
   </font>suffix_of<font color="#000080">:  ^</font>hsize_array_byte<font color="#000080">;
   </font>stack<font color="#000080">:      </font>hsize_array_byte <font color="#FF0000"><b>absolute </b></font>outbuf<font color="#000080">;
   </font>stackp<font color="#000080">:     </font>integer<font color="#000080">;
   </font>finchar<font color="#000080">:    </font>integer<font color="#000080">;
   </font>code<font color="#000080">:       </font>integer<font color="#000080">;
   </font>oldcode<font color="#000080">:    </font>integer<font color="#000080">;
   </font>incode<font color="#000080">:     </font>integer<font color="#000080">;


   </font><font color="#008000"><i>(* ------------------------------------------------------------- *)
   </i></font><font color="#FF0000"><b>procedure </b></font>partial_clear<font color="#000080">;
   </font><font color="#FF0000"><b>var
      </b></font>pr<font color="#000080">:   </font>integer<font color="#000080">;
      </font>cd<font color="#000080">:   </font>integer<font color="#000080">;

   </font><font color="#FF0000"><b>begin
      </b></font><font color="#008000"><i>{mark all nodes as potentially unused}
      </i></font><font color="#FF0000"><b>for </b></font>cd <font color="#000080">:= </font>first_ent <font color="#FF0000"><b>to </b></font>free_ent<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
         </b></font>word<font color="#000080">(</font>prefix_of<font color="#000080">^[</font>cd<font color="#000080">]) := </font>prefix_of<font color="#000080">^[</font>cd<font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$8000</font><font color="#000080">;


      </font><font color="#008000"><i>{unmark those that are used by other nodes}
      </i></font><font color="#FF0000"><b>for </b></font>cd <font color="#000080">:= </font>first_ent <font color="#FF0000"><b>to </b></font>free_ent<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
      begin
         </b></font>pr <font color="#000080">:= </font>prefix_of<font color="#000080">^[</font>cd<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$7fff</font><font color="#000080">;    </font><font color="#008000"><i>{reference to another node?}
         </i></font><font color="#FF0000"><b>if </b></font>pr <font color="#000080">&gt;= </font>first_ent <font color="#FF0000"><b>then            </b></font><font color="#008000"><i>{flag node as referenced}
            </i></font>prefix_of<font color="#000080">^[</font>pr<font color="#000080">] := </font>prefix_of<font color="#000080">^[</font>pr<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$7fff</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#008000"><i>{clear the ones that are still marked}
      </i></font><font color="#FF0000"><b>for </b></font>cd <font color="#000080">:= </font>first_ent <font color="#FF0000"><b>to </b></font>free_ent<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
         if </b></font><font color="#000080">(</font>prefix_of<font color="#000080">^[</font>cd<font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$8000</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
            </b></font>prefix_of<font color="#000080">^[</font>cd<font color="#000080">] := -</font><font color="#800000">1</font><font color="#000080">;


      </font><font color="#008000"><i>{find first cleared node as next free_ent}
      </i></font>free_ent <font color="#000080">:= </font>first_ent<font color="#000080">;
      </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>free_ent <font color="#000080">&lt; </font>maxcodemax<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>prefix_of<font color="#000080">^[</font>free_ent<font color="#000080">] &lt;&gt; -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>do
         </b></font>inc<font color="#000080">(</font>free_ent<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#008000"><i>(* ------------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>var
   </b></font>mem<font color="#000080">:  </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>mem <font color="#000080">:= (</font>sizeof<font color="#000080">(</font>prefix_of<font color="#000080">^)+</font>sizeof<font color="#000080">(</font>suffix_of<font color="#000080">^)+ </font><font color="#800000">100</font><font color="#000080">) - </font>dos_maxavail<font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font>mem <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
   begin
      </b></font>displn<font color="#000080">(</font>ltoa<font color="#000080">(</font>mem<font color="#000080">)+</font><font color="#800000">' more bytes of RAM needed to UnShrink!'</font><font color="#000080">);
      </font>skip_csize<font color="#000080">;
      </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#008000"><i>{allocate heap storage}
   </i></font>dos_getmem<font color="#000080">(</font>prefix_of<font color="#000080">,</font>sizeof<font color="#000080">(</font>prefix_of<font color="#000080">^));
   </font>dos_getmem<font color="#000080">(</font>suffix_of<font color="#000080">,</font>sizeof<font color="#000080">(</font>suffix_of<font color="#000080">^));


   </font><font color="#008000"><i>{decompress the file}
   </i></font>maxcodemax <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>max_bits<font color="#000080">;
   </font>cbits <font color="#000080">:= </font>init_bits<font color="#000080">;
   </font>maxcode <font color="#000080">:= (</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>cbits<font color="#000080">)- </font><font color="#800000">1</font><font color="#000080">;
   </font>free_ent <font color="#000080">:= </font>first_ent<font color="#000080">;
   </font>offset <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>sizex <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

   </font>fillchar<font color="#000080">(</font>prefix_of<font color="#000080">^,</font>sizeof<font color="#000080">(</font>prefix_of<font color="#000080">^),</font><font color="#800000">$FF</font><font color="#000080">);
   </font><font color="#FF0000"><b>for </b></font>code <font color="#000080">:= </font><font color="#800000">255 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
   begin
      </b></font>prefix_of<font color="#000080">^[</font>code<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
      </font>suffix_of<font color="#000080">^[</font>code<font color="#000080">] := </font>code<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>ReadBits<font color="#000080">(</font>cbits<font color="#000080">,</font>oldcode<font color="#000080">);
   </font>finchar <font color="#000080">:= </font>oldcode<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>zipeof <font color="#FF0000"><b>then
      </b></font>exit<font color="#000080">;

   </font>OutByte<font color="#000080">(</font>finchar<font color="#000080">);

   </font>stackp <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>zipeof<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>dump_user<font color="#000080">) </font><font color="#FF0000"><b>do
   begin
      </b></font>ReadBits<font color="#000080">(</font>cbits<font color="#000080">,</font>code<font color="#000080">);

      </font><font color="#FF0000"><b>while </b></font>code <font color="#000080">= </font>clear <font color="#FF0000"><b>do
      begin
         </b></font>ReadBits<font color="#000080">(</font>cbits<font color="#000080">,</font>code<font color="#000080">);

         </font><font color="#FF0000"><b>case </b></font>code <font color="#FF0000"><b>of
            </b></font><font color="#800000">1</font><font color="#000080">: </font><font color="#FF0000"><b>begin
                  </b></font>inc<font color="#000080">(</font>cbits<font color="#000080">);
                  </font><font color="#FF0000"><b>if </b></font>cbits <font color="#000080">= </font>max_bits <font color="#FF0000"><b>then
                     </b></font>maxcode <font color="#000080">:= </font>maxcodemax
                  <font color="#FF0000"><b>else
                     </b></font>maxcode <font color="#000080">:= (</font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>cbits<font color="#000080">) - </font><font color="#800000">1</font><font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

            </font><font color="#800000">2</font><font color="#000080">: </font>partial_clear<font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

         </font>ReadBits<font color="#000080">(</font>cbits<font color="#000080">,</font>code<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#008000"><i>{special case for KwKwK string}
      </i></font>incode <font color="#000080">:= </font>code<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>prefix_of<font color="#000080">^[</font>code<font color="#000080">] = -</font><font color="#800000">1 </font><font color="#FF0000"><b>then
      begin
         </b></font>stack<font color="#000080">[</font>stackp<font color="#000080">] := </font>finchar<font color="#000080">;
         </font>inc<font color="#000080">(</font>stackp<font color="#000080">);
         </font>code <font color="#000080">:= </font>oldcode<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#008000"><i>{generate output characters in reverse order}
      </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>code <font color="#000080">&gt;= </font>first_ent<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>stackp <font color="#000080">&lt; </font>sizeof<font color="#000080">(</font>stack<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>do
      begin
         </b></font>stack<font color="#000080">[</font>stackp<font color="#000080">] := </font>suffix_of<font color="#000080">^[</font>code<font color="#000080">];
         </font>inc<font color="#000080">(</font>stackp<font color="#000080">);
         </font>code <font color="#000080">:= </font>prefix_of<font color="#000080">^[</font>code<font color="#000080">];
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>finchar <font color="#000080">:= </font>suffix_of<font color="#000080">^[</font>code<font color="#000080">];
      </font>stack<font color="#000080">[</font>stackp<font color="#000080">] := </font>finchar<font color="#000080">;
      </font>inc<font color="#000080">(</font>stackp<font color="#000080">);


      </font><font color="#008000"><i>{and put them out in forward order}
      </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>stackp <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do
      begin
         </b></font>outpos <font color="#000080">:= </font>stackp<font color="#000080">; </font><font color="#008000"><i>{required to preserve shared buffer/stack}
         </i></font>dec<font color="#000080">(</font>stackp<font color="#000080">);
         </font>OutByte<font color="#000080">(</font>stack<font color="#000080">[</font>stackp<font color="#000080">]);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#008000"><i>{generate new entry}
      </i></font>code <font color="#000080">:= </font>free_ent<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>code <font color="#000080">&lt; </font>maxcodemax <font color="#FF0000"><b>then
      begin
         </b></font>prefix_of<font color="#000080">^[</font>code<font color="#000080">] := </font>oldcode<font color="#000080">;  </font><font color="#008000"><i>{previous code}
         </i></font>suffix_of<font color="#000080">^[</font>code<font color="#000080">] := </font>finchar<font color="#000080">;  </font><font color="#008000"><i>{final character from this code}
         </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>free_ent <font color="#000080">&lt; </font>maxcodemax<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>prefix_of<font color="#000080">^[</font>free_ent<font color="#000080">] &lt;&gt; -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>do
            </b></font>inc<font color="#000080">(</font>free_ent<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#008000"><i>{remember previous code}
      </i></font>oldcode <font color="#000080">:= </font>incode<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#008000"><i>{release heap storage}
   </i></font>dos_freemem<font color="#000080">(</font>suffix_of<font color="#000080">);
   </font>dos_freemem<font color="#000080">(</font>prefix_of<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ------------------------------------------------------------- *)
(*
 * Imploding
 * ---------
 *
 * The Imploding algorithm is actually a combination of two distinct
 * algorithms.  The first algorithm compresses repeated byte sequences
 * using a sliding dictionary.  The second algorithm is used to compress
 * the encoding of the sliding dictionary ouput, using multiple
 * Shannon-Fano trees.
 *
 *)

</i></font><font color="#FF0000"><b>procedure </b></font>unImplode<font color="#000080">;
   </font><font color="#008000"><i>{expand imploded data}

   </i></font><font color="#FF0000"><b>const
      </b></font>maxSF <font color="#000080">= </font><font color="#800000">256</font><font color="#000080">;

   </font><font color="#FF0000"><b>type
      </b></font>sf_entry <font color="#000080">= </font><font color="#FF0000"><b>record
                    </b></font>Code<font color="#000080">:       </font>word<font color="#000080">;
                    </font>Value<font color="#000080">:      </font>byte<font color="#000080">;
                    </font>BitLength<font color="#000080">:  </font>byte<font color="#000080">;
                 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>sf_tree <font color="#000080">= </font><font color="#FF0000"><b>record  </b></font><font color="#008000"><i>{a shannon-fano tree}
         </i></font>entry<font color="#000080">:         </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>maxSF<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>sf_entry<font color="#000080">;
         </font>entries<font color="#000080">:       </font>integer<font color="#000080">;
         </font>MaxLength<font color="#000080">:     </font>integer<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>sf_treep <font color="#000080">= ^</font>sf_tree<font color="#000080">;

   </font><font color="#FF0000"><b>var
      </b></font>lit_tree<font color="#000080">:               </font>sf_treep<font color="#000080">;
      </font>length_tree<font color="#000080">:            </font>sf_treep<font color="#000080">;
      </font>distance_tree<font color="#000080">:          </font>sf_treep<font color="#000080">;
      </font>lit_tree_present<font color="#000080">:       </font>boolean<font color="#000080">;
      </font>eightK_dictionary<font color="#000080">:      </font>boolean<font color="#000080">;
      </font>minimum_match_length<font color="#000080">:   </font>integer<font color="#000080">;
      </font>dict_bits<font color="#000080">:              </font>integer<font color="#000080">;


   </font><font color="#008000"><i>(* ----------------------------------------------------------- *)
   </i></font><font color="#FF0000"><b>procedure </b></font>LoadTree<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>tree<font color="#000080">: </font>sf_treep<font color="#000080">;
                      </font>treesize<font color="#000080">: </font>integer<font color="#000080">);
      </font><font color="#008000"><i>{allocate and load a shannon-fano tree from the compressed file}

      </i></font><font color="#FF0000"><b>procedure </b></font>SortLengths<font color="#000080">;
         </font><font color="#008000"><i>{Sort the Bit Lengths in ascending order, while retaining the order
          of the original lengths stored in the file}
      </i></font><font color="#FF0000"><b>var
         </b></font>x<font color="#000080">:       </font>integer<font color="#000080">;
         </font>gap<font color="#000080">:     </font>integer<font color="#000080">;
         </font>t<font color="#000080">:       </font>sf_entry<font color="#000080">;
         </font>noswaps<font color="#000080">: </font>boolean<font color="#000080">;
         </font>a<font color="#000080">,</font>b<font color="#000080">:     </font>word<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         </b></font>gap <font color="#000080">:= </font>treesize <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;

         </font><font color="#FF0000"><b>with </b></font>tree<font color="#000080">^ </font><font color="#FF0000"><b>do
         repeat
            repeat
               </b></font>noswaps <font color="#000080">:= </font>true<font color="#000080">;
               </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#000080">(</font>treesize<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)-</font>gap <font color="#FF0000"><b>do
               begin
                  </b></font>a <font color="#000080">:= </font>entry<font color="#000080">[</font>x<font color="#000080">].</font>BitLength<font color="#000080">;
                  </font>b <font color="#000080">:= </font>entry<font color="#000080">[</font>x<font color="#000080">+</font>gap<font color="#000080">].</font>BitLength<font color="#000080">;
                  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>a <font color="#000080">&gt; </font>b<font color="#000080">) </font><font color="#FF0000"><b>or
                     </b></font><font color="#000080">((</font>a <font color="#000080">= </font>b<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>entry<font color="#000080">[</font>x<font color="#000080">].</font>Value <font color="#000080">&gt; </font>entry<font color="#000080">[</font>x<font color="#000080">+</font>gap<font color="#000080">].</font>Value<font color="#000080">)) </font><font color="#FF0000"><b>then
                  begin
                     </b></font>t <font color="#000080">:= </font>entry<font color="#000080">[</font>x<font color="#000080">];
                     </font>entry<font color="#000080">[</font>x<font color="#000080">] := </font>entry<font color="#000080">[</font>x<font color="#000080">+</font>gap<font color="#000080">];
                     </font>entry<font color="#000080">[</font>x<font color="#000080">+</font>gap<font color="#000080">] := </font>t<font color="#000080">;
                     </font>noswaps <font color="#000080">:= </font>false<font color="#000080">;
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>until </b></font>noswaps<font color="#000080">;

            </font>gap <font color="#000080">:= </font>gap <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
         </font><font color="#FF0000"><b>until </b></font>gap <font color="#000080">&lt; </font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#FF0000"><b>procedure </b></font>ReadLengths<font color="#000080">;
      </font><font color="#FF0000"><b>var
         </b></font>treeBytes<font color="#000080">:  </font>integer<font color="#000080">;
         </font>i<font color="#000080">:          </font>integer<font color="#000080">;
         </font>num<font color="#000080">,</font>len<font color="#000080">:    </font>integer<font color="#000080">;
      </font><font color="#FF0000"><b>begin
         </b></font><font color="#008000"><i>{get number of bytes in compressed tree}
         </i></font>ReadBits<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,</font>treeBytes<font color="#000080">);
         </font>inc<font color="#000080">(</font>treeBytes<font color="#000080">);
         </font>i <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
         </font><font color="#FF0000"><b>with </b></font>tree<font color="#000080">^ </font><font color="#FF0000"><b>do
         begin
            </b></font>MaxLength <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

            </font><font color="#008000"><i>{High 4 bits: Number of values at this bit length + 1. (1 - 16)
             Low  4 bits: Bit Length needed to represent value + 1. (1 - 16)}
            </i></font><font color="#FF0000"><b>while </b></font>treeBytes <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
            begin
               </b></font>ReadBits<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">,</font>len<font color="#000080">);  </font>inc<font color="#000080">(</font>len<font color="#000080">);
               </font>ReadBits<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">,</font>num<font color="#000080">);  </font>inc<font color="#000080">(</font>num<font color="#000080">);

               </font><font color="#FF0000"><b>while </b></font>num <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
               with </b></font>entry<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>do
               begin
                  if </b></font>len <font color="#000080">&gt; </font>MaxLength <font color="#FF0000"><b>then
                     </b></font>MaxLength <font color="#000080">:= </font>len<font color="#000080">;
                  </font>BitLength <font color="#000080">:= </font>len<font color="#000080">;
                  </font>Value <font color="#000080">:= </font>i<font color="#000080">;
                  </font>inc<font color="#000080">(</font>i<font color="#000080">);
                  </font>dec<font color="#000080">(</font>num<font color="#000080">);
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

               </font>dec<font color="#000080">(</font>treeBytes<font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>procedure </b></font>GenerateTrees<font color="#000080">;
         </font><font color="#008000"><i>{Generate the Shannon-Fano trees}
      </i></font><font color="#FF0000"><b>var
         </b></font>Code<font color="#000080">:          </font>word<font color="#000080">;
         </font>CodeIncrement<font color="#000080">: </font>integer<font color="#000080">;
         </font>LastBitLength<font color="#000080">: </font>integer<font color="#000080">;
         </font>i<font color="#000080">:             </font>integer<font color="#000080">;
      </font><font color="#FF0000"><b>begin
         </b></font>Code <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
         </font>CodeIncrement <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
         </font>LastBitLength <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

         </font>i <font color="#000080">:= </font>treesize <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;   </font><font color="#008000"><i>{either 255 or 63}
         </i></font><font color="#FF0000"><b>with </b></font>tree<font color="#000080">^ </font><font color="#FF0000"><b>do
         while </b></font>i <font color="#000080">&gt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>do
         begin
            </b></font>inc<font color="#000080">(</font>Code<font color="#000080">,</font>CodeIncrement<font color="#000080">);
            </font><font color="#FF0000"><b>if </b></font>entry<font color="#000080">[</font>i<font color="#000080">].</font>BitLength <font color="#000080">&lt;&gt; </font>LastBitLength <font color="#FF0000"><b>then
            begin
               </b></font>LastBitLength <font color="#000080">:= </font>entry<font color="#000080">[</font>i<font color="#000080">].</font>BitLength<font color="#000080">;
               </font>CodeIncrement <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font><font color="#000080">(</font><font color="#800000">16 </font><font color="#000080">- </font>LastBitLength<font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

            </font>entry<font color="#000080">[</font>i<font color="#000080">].</font>Code <font color="#000080">:= </font>Code<font color="#000080">;
            </font>dec<font color="#000080">(</font>i<font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>procedure </b></font>ReverseBits<font color="#000080">;
         </font><font color="#008000"><i>{Reverse the order of all the bits in the above ShannonCode[]
          vector, so that the most significant bit becomes the least
          significant bit. For example, the value 0x1234 (hex) would become
          0x2C48 (hex).}
      </i></font><font color="#FF0000"><b>var
         </b></font>i<font color="#000080">:    </font>integer<font color="#000080">;
         </font>mask<font color="#000080">: </font>word<font color="#000080">;
         </font>revb<font color="#000080">: </font>word<font color="#000080">;
         </font>v<font color="#000080">:    </font>word<font color="#000080">;
         </font>o<font color="#000080">:    </font>word<font color="#000080">;
         </font>b<font color="#000080">:    </font>integer<font color="#000080">;

      </font><font color="#FF0000"><b>begin
         for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>treesize<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
         begin
            </b></font><font color="#008000"><i>{get original code}
            </i></font>o <font color="#000080">:= </font>tree<font color="#000080">^.</font>entry<font color="#000080">[</font>i<font color="#000080">].</font>Code<font color="#000080">;

            </font><font color="#008000"><i>{reverse each bit}
            </i></font>mask <font color="#000080">:= </font><font color="#800000">$0001</font><font color="#000080">;
            </font>revb <font color="#000080">:= </font><font color="#800000">$8000</font><font color="#000080">;
            </font>v <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
            </font><font color="#FF0000"><b>for </b></font>b <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">15 </font><font color="#FF0000"><b>do
            begin
               </b></font><font color="#008000"><i>{if bit set in mask, then substitute reversed bit}
               </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>o <font color="#FF0000"><b>and </b></font>mask<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
                  </b></font>v <font color="#000080">:= </font>v <font color="#FF0000"><b>or </b></font>revb<font color="#000080">;

               </font><font color="#008000"><i>{advance to next bit}
               </i></font>revb <font color="#000080">:= </font>revb <font color="#FF0000"><b>shr </b></font><font color="#800000">1</font><font color="#000080">;
               </font>mask <font color="#000080">:= </font>mask <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

            </font><font color="#008000"><i>{store reversed bits}
            </i></font>tree<font color="#000080">^.</font>entry<font color="#000080">[</font>i<font color="#000080">].</font>Code <font color="#000080">:= </font>v<font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>begin
      </b></font>dos_getmem<font color="#000080">(</font>tree<font color="#000080">,</font>sizeof<font color="#000080">(</font>tree<font color="#000080">^));
      </font>tree<font color="#000080">^.</font>entries <font color="#000080">:= </font>treesize<font color="#000080">;
      </font>ReadLengths<font color="#000080">;
      </font>SortLengths<font color="#000080">;
      </font>GenerateTrees<font color="#000080">;
      </font>ReverseBits<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#008000"><i>(* ----------------------------------------------------------- *)
   </i></font><font color="#FF0000"><b>procedure </b></font>LoadTrees<font color="#000080">;
   </font><font color="#FF0000"><b>begin
      </b></font>eightK_dictionary <font color="#000080">:= (</font>cflags <font color="#FF0000"><b>and </b></font>GP_8k_dict<font color="#000080">)  &lt;&gt; </font><font color="#800000">0</font><font color="#000080">;
      </font>lit_tree_present  <font color="#000080">:= (</font>cflags <font color="#FF0000"><b>and </b></font>GP_lit_tree<font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font>eightK_dictionary <font color="#FF0000"><b>then
         </b></font>dict_bits <font color="#000080">:= </font><font color="#800000">7
      </font><font color="#FF0000"><b>else
         </b></font>dict_bits <font color="#000080">:= </font><font color="#800000">6</font><font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font>lit_tree_present <font color="#FF0000"><b>then
      begin
         </b></font>minimum_match_length <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;
         </font>LoadTree<font color="#000080">(</font>lit_tree<font color="#000080">,</font><font color="#800000">256</font><font color="#000080">);
      </font><font color="#FF0000"><b>end
      else
         </b></font>minimum_match_length <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;

      </font>LoadTree<font color="#000080">(</font>length_tree<font color="#000080">,</font><font color="#800000">64</font><font color="#000080">);
      </font>LoadTree<font color="#000080">(</font>distance_tree<font color="#000080">,</font><font color="#800000">64</font><font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#008000"><i>(* ----------------------------------------------------------- *)
   </i></font><font color="#FF0000"><b>procedure </b></font>ReadTree<font color="#000080">(</font>tree<font color="#000080">: </font>sf_treep<font color="#000080">;
                      </font><font color="#FF0000"><b>var </b></font>dest<font color="#000080">: </font>integer<font color="#000080">);
      </font><font color="#008000"><i>{read next byte using a shannon-fano tree}
   </i></font><font color="#FF0000"><b>var
      </b></font>bits<font color="#000080">: </font>integer<font color="#000080">;
      </font>cv<font color="#000080">:   </font>word<font color="#000080">;
      </font>b<font color="#000080">:    </font>integer<font color="#000080">;
      </font>cur<font color="#000080">:  </font>integer<font color="#000080">;

   </font><font color="#FF0000"><b>begin
      </b></font>bits <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>cv <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>cur <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>dest <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">; </font><font color="#008000"><i>{in case of error}

      </i></font><font color="#FF0000"><b>with </b></font>tree<font color="#000080">^ </font><font color="#FF0000"><b>do
      while </b></font>true <font color="#FF0000"><b>do
      begin
         </b></font>ReadBits<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>b<font color="#000080">);
         </font>cv <font color="#000080">:= </font>cv <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>b <font color="#FF0000"><b>shl </b></font>bits<font color="#000080">);
         </font>inc<font color="#000080">(</font>bits<font color="#000080">);

         </font><font color="#FF0000"><b>while </b></font>entry<font color="#000080">[</font>cur<font color="#000080">].</font>BitLength <font color="#000080">&lt; </font>bits <font color="#FF0000"><b>do
         begin
            </b></font>inc<font color="#000080">(</font>cur<font color="#000080">);
            </font><font color="#FF0000"><b>if </b></font>cur <font color="#000080">&gt;= </font>entries <font color="#FF0000"><b>then
               </b></font>exit<font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>while </b></font>entry<font color="#000080">[</font>cur<font color="#000080">].</font>BitLength <font color="#000080">= </font>bits <font color="#FF0000"><b>do
         begin
            if </b></font>entry<font color="#000080">[</font>cur<font color="#000080">].</font>Code <font color="#000080">= </font>cv <font color="#FF0000"><b>then
            begin
               </b></font>dest <font color="#000080">:= </font>entry<font color="#000080">[</font>cur<font color="#000080">].</font>Value<font color="#000080">;
               </font>exit<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

            </font>inc<font color="#000080">(</font>cur<font color="#000080">);
            </font><font color="#FF0000"><b>if </b></font>cur <font color="#000080">&gt;= </font>entries <font color="#FF0000"><b>then
               </b></font>exit<font color="#000080">;
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ----------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>var
   </b></font>lout<font color="#000080">:       </font>integer<font color="#000080">;
   </font>mem<font color="#000080">:        </font>longint<font color="#000080">;
   </font>op<font color="#000080">:         </font>longint<font color="#000080">;
   </font>Length<font color="#000080">:     </font>integer<font color="#000080">;
   </font>Distance<font color="#000080">:   </font>integer<font color="#000080">;
   </font>i<font color="#000080">:          </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>mem <font color="#000080">:= (</font>sizeof<font color="#000080">(</font>sf_tree<font color="#000080">)*</font><font color="#800000">3</font><font color="#000080">+</font><font color="#800000">100</font><font color="#000080">) - </font>dos_maxavail<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>mem <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
   begin
      </b></font>displn<font color="#000080">(</font>ltoa<font color="#000080">(</font>mem<font color="#000080">)+</font><font color="#800000">' more bytes of RAM needed to UnImplode!'</font><font color="#000080">);
      </font>skip_csize<font color="#000080">;
      </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>LoadTrees<font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>zipeof<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>outpos <font color="#000080">&lt; </font>cusize<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>dump_user<font color="#000080">) </font><font color="#FF0000"><b>do
   begin
      </b></font>ReadBits<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>lout<font color="#000080">);

      </font><font color="#FF0000"><b>if </b></font>lout <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then    </b></font><font color="#008000"><i>{encoded data is literal data}
      </i></font><font color="#FF0000"><b>begin
         if </b></font>lit_tree_present <font color="#FF0000"><b>then
            </b></font>ReadTree<font color="#000080">(</font>lit_tree<font color="#000080">,</font>lout<font color="#000080">)   </font><font color="#008000"><i>{use Literal Shannon-Fano tree}
         </i></font><font color="#FF0000"><b>else
            </b></font>ReadBits<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,</font>lout<font color="#000080">);

         </font>OutByte<font color="#000080">(</font>lout<font color="#000080">);
      </font><font color="#FF0000"><b>end
      else

      begin          </b></font><font color="#008000"><i>{encoded data is sliding dictionary match}
         </i></font>readBits<font color="#000080">(</font>dict_bits<font color="#000080">,</font>lout<font color="#000080">);
         </font>Distance <font color="#000080">:= </font>lout<font color="#000080">;

         </font>ReadTree<font color="#000080">(</font>distance_tree<font color="#000080">,</font>lout<font color="#000080">);
         </font>Distance <font color="#000080">:= </font>Distance <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>lout <font color="#FF0000"><b>shl </b></font>dict_bits<font color="#000080">);
         </font><font color="#008000"><i>{using the Distance Shannon-Fano tree, read and decode the
            upper 6 bits of the Distance value}

         </i></font>ReadTree<font color="#000080">(</font>length_tree<font color="#000080">,</font>Length<font color="#000080">);
         </font><font color="#008000"><i>{using the Length Shannon-Fano tree, read and decode the Length value}

         </i></font>inc<font color="#000080">(</font>Length<font color="#000080">,</font>Minimum_Match_Length<font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>Length <font color="#000080">= (</font><font color="#800000">63 </font><font color="#000080">+ </font>Minimum_Match_Length<font color="#000080">) </font><font color="#FF0000"><b>then
         begin
            </b></font>ReadBits<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,</font>lout<font color="#000080">);
            </font>inc<font color="#000080">(</font>Length<font color="#000080">,</font>lout<font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

         </font><font color="#008000"><i>{move backwards Distance+1 bytes in the output stream, and copy
          Length characters from this position to the output stream.
          (if this position is before the start of the output stream,
          then assume that all the data before the start of the output
          stream is filled with zeros)}

         </i></font>op <font color="#000080">:= </font>outpos <font color="#000080">- </font>Distance <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
         </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Length <font color="#FF0000"><b>do
         begin
            if </b></font>op <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
               </b></font>OutByte<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)
            </font><font color="#FF0000"><b>else
               </b></font>OutByte<font color="#000080">(</font>outbuf<font color="#000080">[</font>op <font color="#FF0000"><b>mod </b></font>sizeof<font color="#000080">(</font>outbuf<font color="#000080">)]);
            </font>inc<font color="#000080">(</font>op<font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font>lit_tree_present <font color="#FF0000"><b>then
      </b></font>dos_freemem<font color="#000080">(</font>lit_tree<font color="#000080">);
   </font>dos_freemem<font color="#000080">(</font>distance_tree<font color="#000080">);
   </font>dos_freemem<font color="#000080">(</font>length_tree<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
(*
 * This procedure displays the text contents of a specified archive
 * file.  The filename must be fully specified and verified.
 *
 *)
</i></font><font color="#FF0000"><b>procedure </b></font>viewfile<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>b<font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>newline<font color="#000080">;
   </font><font color="#008000"><i>{default_color;}
   </i></font>binary_count <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>pcbits <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>incnt <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>outpos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>uoutbuf <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
   </font>zipeof <font color="#000080">:= </font>false<font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>cflags <font color="#FF0000"><b>and </b></font>GP_encrypted<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
   begin
      </b></font>displn<font color="#000080">(</font><font color="#800000">'File is encrypted.'</font><font color="#000080">);
      </font>skip_csize<font color="#000080">;
      </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>case </b></font>cmethod <font color="#FF0000"><b>of
      </b></font><font color="#800000">0</font><font color="#000080">:    </font><font color="#008000"><i>{stored}
            </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>zipeof<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>dump_user<font color="#000080">) </font><font color="#FF0000"><b>do
            begin
               </b></font>ReadByte<font color="#000080">(</font>b<font color="#000080">);
               </font>OutByte<font color="#000080">(</font>b<font color="#000080">);
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#800000">1</font><font color="#000080">:    </font>UnShrink<font color="#000080">;

      </font><font color="#800000">2</font><font color="#000080">..</font><font color="#800000">5</font><font color="#000080">: </font>UnReduce<font color="#000080">;

      </font><font color="#800000">6</font><font color="#000080">:    </font>UnImplode<font color="#000080">;

      </font><font color="#FF0000"><b>else  begin
               </b></font>displn<font color="#000080">(</font><font color="#800000">'Unknown compression method.'</font><font color="#000080">);
               </font>skip_csize<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font>nomore<font color="#000080">=</font>false <font color="#FF0000"><b>then
      </b></font>newline<font color="#000080">;

   </font>linenum <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>_itoa<font color="#000080">(</font>i<font color="#000080">: </font>integer<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>sp<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>s<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#FF0000"><b>absolute </b></font>sp<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>chr<font color="#000080">( (</font>i <font color="#FF0000"><b>div </b></font><font color="#800000">10</font><font color="#000080">) + </font>ord<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">));
   </font>s<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>chr<font color="#000080">( (</font>i <font color="#FF0000"><b>mod </b></font><font color="#800000">10</font><font color="#000080">) + </font>ord<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>format_date<font color="#000080">(</font>date<font color="#000080">: </font>word<font color="#000080">): </font>string8<font color="#000080">;
</font><font color="#FF0000"><b>const
   </b></font>s<font color="#000080">:       </font>string8 <font color="#000080">= </font><font color="#800000">'mm-dd-yy'</font><font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>_itoa<font color="#000080">(((</font>date <font color="#FF0000"><b>shr </b></font><font color="#800000">9</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">127</font><font color="#000080">)+</font><font color="#800000">80</font><font color="#000080">, </font>s<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">]);
   </font>_itoa<font color="#000080">( (</font>date <font color="#FF0000"><b>shr </b></font><font color="#800000">5</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">15</font><font color="#000080">,  </font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
   </font>_itoa<font color="#000080">( (</font>date      <font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">31</font><font color="#000080">,  </font>s<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">]);
   </font>format_date <font color="#000080">:= </font>s<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>format_time<font color="#000080">(</font>time<font color="#000080">: </font>word<font color="#000080">): </font>string8<font color="#000080">;
</font><font color="#FF0000"><b>const
   </b></font>s<font color="#000080">:       </font>string8 <font color="#000080">= </font><font color="#800000">'hh:mm:ss'</font><font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>_itoa<font color="#000080">( (</font>time <font color="#FF0000"><b>shr </b></font><font color="#800000">11</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">31</font><font color="#000080">, </font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
   </font>_itoa<font color="#000080">( (</font>time <font color="#FF0000"><b>shr  </b></font><font color="#800000">5</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">63</font><font color="#000080">, </font>s<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">]);
   </font>_itoa<font color="#000080">( (</font>time <font color="#FF0000"><b>shl  </b></font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">63</font><font color="#000080">, </font>s<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">]);
   </font>format_time <font color="#000080">:= </font>s<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>process_local_file_header<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>n<font color="#000080">:             </font>word<font color="#000080">;
   </font>rec<font color="#000080">:           </font>local_file_header<font color="#000080">;
   </font>filename<font color="#000080">:      </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
   </font>extra<font color="#000080">:         </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
   </font>fpos<font color="#000080">:          </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>dos_lseek<font color="#000080">(</font>zipfd<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>seek_cur<font color="#000080">);
   </font>fpos <font color="#000080">:= </font>dos_tell<font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>dump_user <font color="#000080">= </font>false<font color="#000080">) </font><font color="#FF0000"><b>do
   begin
      </b></font>set_function<font color="#000080">(</font>fun_arcview<font color="#000080">);

      </font>dos_lseek<font color="#000080">(</font>zipfd<font color="#000080">,</font>fpos<font color="#000080">,</font>seek_start<font color="#000080">);
      </font>n <font color="#000080">:= </font>dos_read<font color="#000080">(</font>zipfd<font color="#000080">,</font>rec<font color="#000080">,</font>sizeof<font color="#000080">(</font>rec<font color="#000080">));
      </font>get_string<font color="#000080">(</font>rec<font color="#000080">.</font>filename_length<font color="#000080">,</font>filename<font color="#000080">);
      </font>filename <font color="#000080">:= </font>remove_path<font color="#000080">(</font>filename<font color="#000080">);
      </font>stoupper<font color="#000080">(</font>filename<font color="#000080">);
      </font>get_string<font color="#000080">(</font>rec<font color="#000080">.</font>extra_field_length<font color="#000080">,</font>extra<font color="#000080">);
      </font>csize <font color="#000080">:= </font>rec<font color="#000080">.</font>compressed_size<font color="#000080">;
      </font>cusize <font color="#000080">:= </font>rec<font color="#000080">.</font>uncompressed_size<font color="#000080">;
      </font>cmethod <font color="#000080">:= </font>rec<font color="#000080">.</font>compression_method<font color="#000080">;
      </font>cflags <font color="#000080">:= </font>rec<font color="#000080">.</font>general_purpose_bit_flag<font color="#000080">;


      </font><font color="#008000"><i>(* exclude the file if outside current pattern *)
      </i></font><font color="#FF0000"><b>if </b></font>nomore <font color="#FF0000"><b>or </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>wildcard_match<font color="#000080">(</font>pattern<font color="#000080">,</font>filename<font color="#000080">)) </font><font color="#FF0000"><b>then
      begin
         </b></font>skip_csize<font color="#000080">;
         </font>exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#008000"><i>(* display file information headers if needed *)
      </i></font><font color="#FF0000"><b>if not </b></font>header_present <font color="#FF0000"><b>then
      begin
         </b></font>header_present <font color="#000080">:= </font>true<font color="#000080">;

         </font>newline<font color="#000080">;
         </font>disp<font color="#000080">(</font><font color="#800000">' File Name    Length   Method     Date      Time'</font><font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>expand_files <font color="#FF0000"><b>then </b></font>disp<font color="#000080">(</font><font color="#800000">'    (Enter) or (S)kip, (V)iew'</font><font color="#000080">);
         </font>newline<font color="#000080">;

         </font>disp<font color="#000080">(</font><font color="#800000">'------------  ------  --------  --------  --------'</font><font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>expand_files <font color="#FF0000"><b>then </b></font>disp<font color="#000080">(</font><font color="#800000">'  -------------------------'</font><font color="#000080">);
         </font>newline<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#008000"><i>(* display file information *)
      </i></font>disp<font color="#000080">(</font>ljust<font color="#000080">(</font>filename<font color="#000080">,</font><font color="#800000">12</font><font color="#000080">)+</font><font color="#800000">' '</font><font color="#000080">+
           </font>rjust<font color="#000080">(</font>ltoa<font color="#000080">(</font>rec<font color="#000080">.</font>uncompressed_size<font color="#000080">),</font><font color="#800000">7</font><font color="#000080">)+</font><font color="#800000">'  '</font><font color="#000080">+
           </font>compression_methods<font color="#000080">[</font>rec<font color="#000080">.</font>compression_method<font color="#000080">]+</font><font color="#800000">'  '</font><font color="#000080">+
           </font>format_date<font color="#000080">(</font>rec<font color="#000080">.</font>last_mod_file_date<font color="#000080">)+</font><font color="#800000">'  '</font><font color="#000080">+
           </font>format_time<font color="#000080">(</font>rec<font color="#000080">.</font>last_mod_file_time<font color="#000080">));

      </font><font color="#FF0000"><b>if not </b></font>expand_files <font color="#FF0000"><b>then
      begin
         </b></font>skip_csize<font color="#000080">;
         </font>newline<font color="#000080">;
         </font>exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


      </font><font color="#008000"><i>(* determine action to perform on this member file *)
      </i></font>action <font color="#000080">:= </font><font color="#800000">'S'</font><font color="#000080">;
      </font>disp<font color="#000080">(</font><font color="#800000">'  Action? '</font><font color="#000080">);
      </font>input<font color="#000080">(</font>action<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>stoupper<font color="#000080">(</font>action<font color="#000080">);

      </font><font color="#FF0000"><b>case </b></font>action<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of
         </b></font><font color="#800000">'S'</font><font color="#000080">:
            </font><font color="#FF0000"><b>begin
               </b></font>displn<font color="#000080">(</font><font color="#800000">' [Skip]'</font><font color="#000080">);
               </font>skip_csize<font color="#000080">;
               </font>exit<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

         </font><font color="#800000">'V'</font><font color="#000080">,</font><font color="#800000">'R'</font><font color="#000080">:
            </font><font color="#FF0000"><b>begin
               </b></font>displn<font color="#000080">(</font><font color="#800000">' [View]'</font><font color="#000080">);
               </font>viewfile<font color="#000080">;

               </font>header_present <font color="#000080">:= </font>false<font color="#000080">;

            </font><font color="#008000"><i>{  make_log_entry('View archive member ('+extname
                                        +') from ('+remove_path(arcname)
                                        +')',true); }
            </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

         </font><font color="#800000">'Q'</font><font color="#000080">:
            </font><font color="#FF0000"><b>begin
               </b></font>displn<font color="#000080">(</font><font color="#800000">' [Quit]'</font><font color="#000080">);
               </font>dos_lseek<font color="#000080">(</font>zipfd<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>seek_end<font color="#000080">);
               </font>exit<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

         </font><font color="#FF0000"><b>else
            </b></font>displn<font color="#000080">(</font><font color="#800000">' [Type S, V or Q!]'</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>process_central_file_header<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>n<font color="#000080">:             </font>word<font color="#000080">;
   </font>rec<font color="#000080">:           </font>central_directory_file_header<font color="#000080">;
   </font>filename<font color="#000080">:      </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
   </font>extra<font color="#000080">:         </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
   </font>comment<font color="#000080">:       </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>n <font color="#000080">:= </font>dos_read<font color="#000080">(</font>zipfd<font color="#000080">,</font>rec<font color="#000080">,</font>sizeof<font color="#000080">(</font>rec<font color="#000080">));
   </font>get_string<font color="#000080">(</font>rec<font color="#000080">.</font>filename_length<font color="#000080">,</font>filename<font color="#000080">);
   </font>get_string<font color="#000080">(</font>rec<font color="#000080">.</font>extra_field_length<font color="#000080">,</font>extra<font color="#000080">);
   </font>get_string<font color="#000080">(</font>rec<font color="#000080">.</font>file_comment_length<font color="#000080">,</font>comment<font color="#000080">);
  </font><font color="#008000"><i>{dos_lseek(zipfd,rec.compressed_size,seek_cur);}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>process_end_central_dir<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>n<font color="#000080">:             </font>word<font color="#000080">;
   </font>rec<font color="#000080">:           </font>end_central_dir_record<font color="#000080">;
   </font>comment<font color="#000080">:       </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>n <font color="#000080">:= </font>dos_read<font color="#000080">(</font>zipfd<font color="#000080">,</font>rec<font color="#000080">,</font>sizeof<font color="#000080">(</font>rec<font color="#000080">));
   </font>get_string<font color="#000080">(</font>rec<font color="#000080">.</font>zipfile_comment_length<font color="#000080">,</font>comment<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>process_headers<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>sig<font color="#000080">:  </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>dos_lseek<font color="#000080">(</font>zipfd<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>seek_start<font color="#000080">);
   </font>header_present <font color="#000080">:= </font>false<font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>dump_user<font color="#000080">) </font><font color="#FF0000"><b>do
   begin
      if </b></font>nomore <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>dos_read<font color="#000080">(</font>zipfd<font color="#000080">,</font>sig<font color="#000080">,</font>sizeof<font color="#000080">(</font>sig<font color="#000080">)) &lt;&gt; </font>sizeof<font color="#000080">(</font>sig<font color="#000080">)) </font><font color="#FF0000"><b>then
         </b></font>exit
      <font color="#FF0000"><b>else

      if </b></font>sig <font color="#000080">= </font>local_file_header_signature <font color="#FF0000"><b>then
         </b></font>process_local_file_header
      <font color="#FF0000"><b>else

      if </b></font>sig <font color="#000080">= </font>central_file_header_signature <font color="#FF0000"><b>then
         </b></font>process_central_file_header
      <font color="#FF0000"><b>else

      if </b></font>sig <font color="#000080">= </font>end_central_dir_signature <font color="#FF0000"><b>then
      begin
         </b></font>process_end_central_dir<font color="#000080">;
         </font>exit<font color="#000080">;
      </font><font color="#FF0000"><b>end

      else
      begin
         </b></font>displn<font color="#000080">(</font><font color="#800000">'Invalid Zipfile Header'</font><font color="#000080">);
         </font>exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>select_pattern<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>default_pattern <font color="#000080">:= </font><font color="#800000">'*.*'</font><font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font>true <font color="#FF0000"><b>do
   begin
      </b></font>newline<font color="#000080">;
      </font>disp<font color="#000080">(</font>remove_path<font color="#000080">(</font>zipfn<font color="#000080">));
      </font>get_def<font color="#000080">(</font><font color="#800000">': View member filespec:'</font><font color="#000080">, </font>enter_eq<font color="#000080">+</font>default_pattern<font color="#000080">+</font><font color="#800000">'? '</font><font color="#000080">);
      
      </font>get_nextpar<font color="#000080">;
      </font>pattern <font color="#000080">:= </font>par<font color="#000080">;
      </font>stoupper<font color="#000080">(</font>pattern<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>length<font color="#000080">(</font>pattern<font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>then
         </b></font>pattern <font color="#000080">:= </font>default_pattern<font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>pattern <font color="#000080">= </font><font color="#800000">'none'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>pattern <font color="#000080">= </font><font color="#800000">'Q'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>dump_user <font color="#FF0000"><b>then
         </b></font>exit<font color="#000080">;
   
      </font>process_headers<font color="#000080">;
   
      </font>default_pattern <font color="#000080">:= </font><font color="#800000">'none'</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>view_zipfile<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>zipfd <font color="#000080">:= </font>dos_open<font color="#000080">(</font>zipfn<font color="#000080">,</font>open_read<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>zipfd <font color="#000080">= </font>dos_error <font color="#FF0000"><b>then
      </b></font>exit<font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font>expand_files <font color="#FF0000"><b>then
      </b></font>select_pattern
   <font color="#FF0000"><b>else
   begin
      </b></font>pattern <font color="#000080">:= </font><font color="#800000">'*.*'</font><font color="#000080">;
      </font>process_headers<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>dos_close<font color="#000080">(</font>zipfd<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#008000"><i>(* ---------------------------------------------------------- *)
</i></font><font color="#FF0000"><b>procedure </b></font>process_zipfile<font color="#000080">(</font>name<font color="#000080">: </font>filenames<font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>mem<font color="#000080">:    </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>linenum <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font>cmdline <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
   </font>expand_files <font color="#000080">:= </font>false<font color="#000080">;
   </font>zipfn <font color="#000080">:= </font>name<font color="#000080">;
   </font>view_zipfile<font color="#000080">;

   </font>newline<font color="#000080">;
   </font>get_def<font color="#000080">(</font><font color="#800000">'View text files in this zipfile:'</font><font color="#000080">,</font><font color="#800000">'(Enter)=yes? '</font><font color="#000080">);

   </font><font color="#008000"><i>(* process text viewing if desired *)
   </i></font>get_nextpar<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>par<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font><font color="#800000">'N' </font><font color="#FF0000"><b>then
   begin
      </b></font>expand_files <font color="#000080">:= </font>true<font color="#000080">;
      </font>view_zipfile<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>(*
 * main program
 *
 *)

</i></font><font color="#FF0000"><b>var
   </b></font>i<font color="#000080">:    </font>integer<font color="#000080">;
   </font>n<font color="#000080">:    </font>integer<font color="#000080">;
   </font>par<font color="#000080">:  </font>anystring<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>gotoxy<font color="#000080">(</font><font color="#800000">60</font><font color="#000080">,</font>scroll_line<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
   </font>reverseVideo<font color="#000080">;
   </font>disp<font color="#000080">(</font><font color="#800000">' ZipTV '</font><font color="#000080">);

   </font>SetScrollPoint<font color="#000080">(</font>scroll_line<font color="#000080">);
   </font>gotoxy<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">23</font><font color="#000080">);  </font>lowVideo<font color="#000080">;
   </font>linenum <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font>paramcount <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
   begin
      </b></font>displn<font color="#000080">(</font>version<font color="#000080">);
</font><font color="#008000"><i>{     newline;
      displn('Courtesy of:  S.H.Smith  and  The Tool Shop BBS,  (602) 279-2673.');
      newline;  }

      </i></font>displn<font color="#000080">(</font><font color="#800000">'Usage:  ziptv [-Pport] [-Tminutes] [-Llines] [-Mlines] FILE[.zip]'</font><font color="#000080">);

</font><font color="#008000"><i>{     newline;
      displn('-Pn   enables com port COMn and monitors carrier');
      displn('-Tn   allows user to stay in program for n minutes');
      displn('-Ln   sets lines per screen');
      displn('-Mn   sets maximum lines per session');
}
      </i></font>halt<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>paramcount <font color="#FF0000"><b>do
   begin
      </b></font>par <font color="#000080">:= </font>paramstr<font color="#000080">(</font>i<font color="#000080">);
      </font>n <font color="#000080">:= </font>atoi<font color="#000080">(</font>copy<font color="#000080">(</font>par<font color="#000080">,</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">5</font><font color="#000080">));

      </font><font color="#FF0000"><b>if </b></font>par<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">'-' </font><font color="#FF0000"><b>then
         case </b></font>upcase<font color="#000080">(</font>par<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]) </font><font color="#FF0000"><b>of
            </b></font><font color="#800000">'P'</font><font color="#000080">:  </font>opencom<font color="#000080">(</font>n<font color="#000080">);
            </font><font color="#800000">'T'</font><font color="#000080">:  </font>tlimit <font color="#000080">:= </font>n<font color="#000080">;      </font><font color="#008000"><i>{time limit}
            </i></font><font color="#800000">'L'</font><font color="#000080">:  </font>user<font color="#000080">.</font>pagelen <font color="#000080">:= </font>n<font color="#000080">;
            </font><font color="#800000">'M'</font><font color="#000080">:  </font>maxlines <font color="#000080">:= </font>n<font color="#000080">;
         </font><font color="#FF0000"><b>end
      else

      begin
        if </b></font>pos<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">,</font>par<font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>then
            </b></font>par <font color="#000080">:= </font>par <font color="#000080">+ </font><font color="#800000">'.ZIP'</font><font color="#000080">;

        </font><font color="#FF0000"><b>if </b></font>dos_exists<font color="#000080">(</font>par<font color="#000080">) </font><font color="#FF0000"><b>then
            </b></font>process_zipfile<font color="#000080">(</font>par<font color="#000080">)
        </font><font color="#FF0000"><b>else
            </b></font>displn<font color="#000080">(</font><font color="#800000">'File not found: '</font><font color="#000080">+</font>par<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>newline<font color="#000080">;
   </font>displn<font color="#000080">(</font>version<font color="#000080">);
   </font>closecom<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0042.PAS">Original</a><b>]</b></p></body>
</html>
