<html>
<head><title> "Is file is packed with WWPACK" by THOMAS MOENKEMEIER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0033.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
  Copyright (c) 1994-95 by Piotr Warezak and Rafal Wierzbicki, Lodz, Poland

  function check_if_packed(var f:file);
       function checks if the assigned and opened file is compressed
       with WWPACK.

       Function returns byte:

            WWPACK version (when packed) and compression command:
                       3.00     3.01    3.02    3.03    3.04
                PR        9        9      14      17      21
                P        10       12      15      18      22
                PU       11       13      16      19      23
                PP      n/a      n/a     n/a      20      24

            or:
                0  -  not packed with WWPACK
                1  -  not an EXE file
                2  -  unrecognized WWPACK version
                3  -  error while reading the file
}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>check_if_packed<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>f<font color="#000080">:</font><font color="#FF0000"><b>FILE</b></font><font color="#000080">):</font>BYTE<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>start<font color="#000080">,</font>size<font color="#000080">,</font>old_position<font color="#000080">:</font>LONGINT<font color="#000080">;
    </font>header<font color="#000080">:</font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">16</font><font color="#000080">]</font><font color="#FF0000"><b>OF </b></font>word<font color="#000080">;
    </font>buf<font color="#000080">:</font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">75</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>BYTE<font color="#000080">;
    </font>ver<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font><font color="#008000"><i>{$I-}
  </i></font>ver<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#008000"><i>{***  store old FilePosition  ***}
  </i></font>old_position<font color="#000080">:=</font>FilePos<font color="#000080">(</font>f<font color="#000080">);
  </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">); </font>size<font color="#000080">:=</font>FileSize<font color="#000080">(</font>f<font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
    BEGIN
      </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">); </font>ver<font color="#000080">:=</font>IOResult<font color="#000080">; </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#008000"><i>{***  check if EXE file ***}
  </i></font><font color="#FF0000"><b>IF </b></font>size<font color="#000080">&lt;</font><font color="#800000">32 </font><font color="#FF0000"><b>THEN
    BEGIN
      </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">); </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>BlockRead<font color="#000080">(</font>f<font color="#000080">,</font>header<font color="#000080">,</font><font color="#800000">32</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>header<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]&lt;&gt;</font>Ord<font color="#000080">(</font><font color="#800000">'M'</font><font color="#000080">)+</font><font color="#800000">256</font><font color="#000080">*</font>Ord<font color="#000080">(</font><font color="#800000">'Z'</font><font color="#000080">)) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>header<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]&lt;&gt;</font>Ord<font color="#000080">(</font><font color="#800000">'Z'</font><font color="#000080">)+</font><font color="#800000">256</font><font color="#000080">*</font>Ord<font color="#000080">(</font><font color="#800000">'M'</font><font color="#000080">))
</font><font color="#FF0000"><b>THEN    BEGIN
      </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">); </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
    BEGIN
      </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">); </font>ver<font color="#000080">:=</font>IOResult<font color="#000080">; </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#008000"><i>{***  jump to the begin of the code (jump to CS:IP address)  ***}
  </i></font>start<font color="#000080">:=</font>LONGINT<font color="#000080">(</font>header<font color="#000080">[</font><font color="#800000">12</font><font color="#000080">])*</font><font color="#800000">16</font><font color="#000080">+</font>header<font color="#000080">[</font><font color="#800000">11</font><font color="#000080">]+</font>header<font color="#000080">[</font><font color="#800000">5</font><font color="#000080">]*</font><font color="#800000">16</font><font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>start<font color="#000080">&gt;=</font><font color="#800000">65536</font><font color="#000080">*</font><font color="#800000">16 </font><font color="#FF0000"><b>THEN </b></font>dec<font color="#000080">(</font>start<font color="#000080">,</font><font color="#800000">65536</font><font color="#000080">*</font><font color="#800000">16</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font>start<font color="#000080">+</font><font color="#800000">74</font><font color="#000080">&lt;</font>size <font color="#FF0000"><b>THEN
    BEGIN

      </b></font><font color="#008000"><i>{***  read first 75 bytes of the code  ***}
      </i></font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>start<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">); </font>BlockRead<font color="#000080">(</font>f<font color="#000080">,</font>buf<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font><font color="#800000">75</font><font color="#000080">);
      </font><font color="#FF0000"><b>IF </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>THEN
        BEGIN
          </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">); </font>ver<font color="#000080">:=</font>IOResult<font color="#000080">; </font>Exit<font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

      </font><font color="#008000"><i>{***  check if WWPACK 3.00/3.01 PR code  ***}
      </i></font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">]=</font><font color="#800000">$be</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">]=</font><font color="#800000">$ba</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">9</font><font color="#000080">]=</font><font color="#800000">$bf</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">12</font><font color="#000080">]=</font><font color="#800000">$b9</font><font color="#000080">) </font><font color="#FF0000"><b>THEN
        BEGIN
          IF </b></font>buf<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]=</font><font color="#800000">9 </font><font color="#FF0000"><b>THEN </b></font>ver<font color="#000080">:=</font><font color="#800000">9
          </font><font color="#FF0000"><b>ELSE
            BEGIN
              </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">;
              </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">);
              </font>Exit<font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

      </font><font color="#008000"><i>{***  check if WWPACK 3.02/3.03/3.04 PR code  ***}
      </i></font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">]=</font><font color="#800000">$be</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">]=</font><font color="#800000">$bf</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">9</font><font color="#000080">]=</font><font color="#800000">$b9</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">12</font><font color="#000080">]=</font><font color="#800000">$8c</font><font color="#000080">) </font><font color="#FF0000"><b>AND
         </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">13</font><font color="#000080">]=</font><font color="#800000">$cd</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">14</font><font color="#000080">]=</font><font color="#800000">$81</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">15</font><font color="#000080">]=</font><font color="#800000">$ed</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">18</font><font color="#000080">]=</font><font color="#800000">$8b</font><font color="#000080">)
</font><font color="#FF0000"><b>AND         </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">19</font><font color="#000080">]=</font><font color="#800000">$dd</font><font color="#000080">)
      </font><font color="#FF0000"><b>THEN
        BEGIN
          </b></font>buf<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]:=</font>buf<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]+</font><font color="#800000">14</font><font color="#000080">; </font>ver<font color="#000080">:=</font>buf<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
          </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>ver<font color="#000080">&lt;&gt;</font><font color="#800000">14</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>ver<font color="#000080">&lt;&gt;</font><font color="#800000">17</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>ver<font color="#000080">&lt;&gt;</font><font color="#800000">21</font><font color="#000080">) </font><font color="#FF0000"><b>THEN
            BEGIN
              </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">); </font>Exit<font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

      </font><font color="#008000"><i>{***  check if WWPACK 3.0x P/PU/PP code  ***}
      </i></font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">]=</font><font color="#800000">$b8</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">]=</font><font color="#800000">$8c</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">]=</font><font color="#800000">$ca</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">]=</font><font color="#800000">$03</font><font color="#000080">) </font><font color="#FF0000"><b>AND
         </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">9</font><font color="#000080">]=</font><font color="#800000">$d0</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">10</font><font color="#000080">]=</font><font color="#800000">$8c</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">11</font><font color="#000080">]=</font><font color="#800000">$c9</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">12</font><font color="#000080">]=</font><font color="#800000">$81</font><font color="#000080">)
</font><font color="#FF0000"><b>AND         </b></font><font color="#000080">(</font>buf<font color="#000080">[</font><font color="#800000">16</font><font color="#000080">]=</font><font color="#800000">$51</font><font color="#000080">)
      </font><font color="#FF0000"><b>THEN
        BEGIN
          </b></font>ver<font color="#000080">:=</font>buf<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
          </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>ver<font color="#000080">&lt;</font><font color="#800000">10</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>ver<font color="#000080">&gt;</font><font color="#800000">24</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>ver<font color="#000080">=</font><font color="#800000">14</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>ver<font color="#000080">=</font><font color="#800000">17</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>ver<font color="#000080">=</font><font color="#800000">21</font><font color="#000080">) </font><font color="#FF0000"><b>THEN
            BEGIN
              </b></font>check_if_packed<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">); </font>Exit<font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#008000"><i>{***  restore old FilePosition and return WWPACK's version  ***}
  </i></font>check_if_packed<font color="#000080">:=</font>ver<font color="#000080">; </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>old_position<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0033.PAS">Original</a><b>]</b></p></body>
</html>
