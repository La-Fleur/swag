<html>
<head><title> "Self Modify PKLITE files" by ANTHONY GELAT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0014.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
ANTHONY GELAT

&gt;&gt;Is it the size of the EXE File?  You can compress it With PKLite or
&gt;&gt;LZEXE - it'll load into memory With full size, though.  This just

&gt;Nope, it has self modifying data.  PKLiting it wouldn't work.

 I have code For a self modifying EXE that claims to be PKLITEable,
 so i believe it can be done...here it is
}

</i></font><font color="#FF0000"><b>Unit </b></font>PCkSelfM<font color="#000080">;
</font><font color="#008000"><i>{ Programmer: Jim Nicholson

Purpose: Implement a method For creating &quot;self-modifying&quot; .EXE Files from
TP which will survive the encoding techniques used by LZEXE and PKLite(tm).
For discussion and examples, see SelfMod.Pas
This Unit contains code placed into the public domain, With the following
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
provision:
Please do not distribute modified versions of this code Without indicating
such modification by commenting the File.
if you have questions, comments, modifications, or suggestions, please
feel free to contact us:

             PCkS Associates
             138 Frances Place
             Hillside, NJ 07205

             On CompuServe, EasyPlex to    70152,332
             On Delphi                     CHICKENJN
             On GENie                      J.NICHOLSON1

}

</i></font><font color="#FF0000"><b>Interface

Var
  </b></font>ExeFileName <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">128</font><font color="#000080">];

</font><font color="#FF0000"><b>Function  </b></font>ConfigBlockPresent<font color="#000080">(</font>Size <font color="#000080">: </font>Integer<font color="#000080">)          : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>NewConfigBlock<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>C_B<font color="#000080">; </font>Size <font color="#000080">: </font>Integer<font color="#000080">)     : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>ReadConfigBlock<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>C_B<font color="#000080">; </font>Size <font color="#000080">: </font>Integer<font color="#000080">)    : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Function  </b></font>ConfigBlockReWrite<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>C_B<font color="#000080">; </font>Size <font color="#000080">: </font>Integer<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>SelfModHeader <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">10</font><font color="#000080">] = </font><font color="#800000">'PCkS SMODF'</font><font color="#000080">;
  </font>CtrlZ         <font color="#000080">: </font>Char <font color="#000080">= ^</font>Z<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>ExeFile <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>Buffer  <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">10</font><font color="#000080">];

</font><font color="#FF0000"><b>Function </b></font>ConfigBlockPresent<font color="#000080">(</font>Size <font color="#000080">: </font>Integer<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>assign<font color="#000080">(</font>ExeFile<font color="#000080">, </font>ExeFileName<font color="#000080">);
  </font>reset<font color="#000080">(</font>ExeFile<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>seek<font color="#000080">(</font>ExeFile<font color="#000080">, </font>FileSize<font color="#000080">(</font>ExeFile<font color="#000080">) - (</font>SizeOf<font color="#000080">(</font>SelfModHeader<font color="#000080">) + </font>Size <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">));
  </font>BlockRead<font color="#000080">(</font>ExeFile<font color="#000080">, </font>Buffer<font color="#000080">, </font>SizeOf<font color="#000080">(</font>SelfModHeader<font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font>Buffer <font color="#000080">= </font>SelfModHeader <font color="#FF0000"><b>then
    </b></font>ConfigBlockPresent <font color="#000080">:= </font>True
  <font color="#FF0000"><b>else
    </b></font>ConfigBlockPresent <font color="#000080">:= </font>False<font color="#000080">;
  </font>close<font color="#000080">(</font>ExeFile<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>NewConfigBlock<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>C_B<font color="#000080">; </font>Size <font color="#000080">: </font>Integer<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>NewConfigBlock <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>ConfigBlockPresent<font color="#000080">(</font>Size<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>assign<font color="#000080">(</font>ExeFile<font color="#000080">, </font>ExeFileName<font color="#000080">);
    </font>reset<font color="#000080">(</font>ExeFile<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>Seek<font color="#000080">(</font>ExeFile<font color="#000080">, </font>FileSize<font color="#000080">(</font>ExeFile<font color="#000080">));
    </font>BlockWrite<font color="#000080">(</font>ExeFile<font color="#000080">, </font>SelfModHeader<font color="#000080">, </font>SizeOf<font color="#000080">(</font>SelfModHeader<font color="#000080">));
    </font>BlockWrite<font color="#000080">(</font>ExeFile<font color="#000080">, </font>C_B<font color="#000080">, </font>Size<font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>ExeFile<font color="#000080">, </font>CtrlZ<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>close<font color="#000080">(</font>ExeFile<font color="#000080">);
    </font>NewConfigBlock <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>ReadConfigBlock<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>C_B<font color="#000080">; </font>Size <font color="#000080">: </font>Integer<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ReadConfigBlock <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>ConfigBlockPresent<font color="#000080">(</font>Size<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>assign<font color="#000080">(</font>ExeFile<font color="#000080">, </font>ExeFileName<font color="#000080">);
    </font>reset<font color="#000080">(</font>ExeFile<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>seek<font color="#000080">(</font>ExeFile<font color="#000080">, </font>FileSize<font color="#000080">(</font>ExeFile<font color="#000080">) - (</font>Size <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">));
    </font>BlockRead<font color="#000080">(</font>ExeFile<font color="#000080">, </font>C_B<font color="#000080">, </font>Size<font color="#000080">);
    </font>close<font color="#000080">(</font>ExeFile<font color="#000080">);
    </font>ReadConfigBlock <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>ConfigBlockReWrite<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>C_B<font color="#000080">; </font>Size <font color="#000080">: </font>Integer<font color="#000080">) : </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ConfigBlockReWrite <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>ConfigBlockPresent<font color="#000080">(</font>Size<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>assign<font color="#000080">(</font>ExeFile<font color="#000080">, </font>ExeFileName<font color="#000080">);
    </font>reset<font color="#000080">(</font>ExeFile<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>seek<font color="#000080">(</font>ExeFile<font color="#000080">, </font>FileSize<font color="#000080">(</font>ExeFile<font color="#000080">) - (</font>SizeOf<font color="#000080">(</font>SelfModHeader<font color="#000080">) + </font>Size <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">));
    </font>BlockWrite<font color="#000080">(</font>ExeFile<font color="#000080">, </font>SelfModHeader<font color="#000080">, </font>SizeOf<font color="#000080">(</font>SelfModHeader<font color="#000080">));
    </font>BlockWrite<font color="#000080">(</font>ExeFile<font color="#000080">, </font>C_B<font color="#000080">, </font>Size<font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>ExeFile<font color="#000080">, </font>CtrlZ<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>close<font color="#000080">(</font>ExeFile<font color="#000080">);
    </font>ConfigBlockReWrite <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>ExeFileName <font color="#000080">:= </font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font><font color="#008000"><i>{--------------------------And SELFMOD.PAS, referenced above: }
</i></font><font color="#FF0000"><b>Program </b></font>SelfMod<font color="#000080">;

</font><font color="#008000"><i>{
   This demonstrates a technique For creating self-modifying .EXE Files. It
   has an advantage over techniques which use Typed Constants, in that it will
   survive LZEXEC and PkLite(tm).

   Note that if the Program is run before LZEXEC is used to compress it, the
   compressed Program will not have been initialized. This is because LZEXEC
   strips off the config block (and everything else) at the end of the .EXE
   File. This problem does not occur With PKLite(tm).

   To run the demo, compile the Program and execute it twice. Whatever
   String you enter is written to the end of the .EXE File.

   To further demonstrate it's ablities, compress the File With PKLite(tm) or
   LZEXEC after compiling.

   Address all questions and comments to:

              PCkS Associates
              138 Frances Place
              Hillside, NJ 07205

              On CompuServe, EasyPlex to    70152,332
              On Delphi                     CHICKENJN
              On GENie                      J.NICHOLSON1


}



</i></font><font color="#FF0000"><b>Uses
  </b></font>PCkSelfM<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>ConfigBlock <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">40</font><font color="#000080">];

</font><font color="#FF0000"><b>Var
  </b></font>MyConfig <font color="#000080">: </font>ConfigBlock<font color="#000080">;

</font><font color="#FF0000"><b>begin
  if </b></font>ConfigBlockPresent<font color="#000080">(</font>SizeOf<font color="#000080">(</font>ConfigBlock<font color="#000080">)) </font><font color="#FF0000"><b>then
    if </b></font>ReadConfigBlock<font color="#000080">(</font>MyConfig<font color="#000080">, </font>SizeOf<font color="#000080">(</font>ConfigBlock<font color="#000080">)) </font><font color="#FF0000"><b>then
    begin
      </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Old value of MyConfig: '</font><font color="#000080">,</font>MyConfig<font color="#000080">);
      </font>Write<font color="#000080">(</font><font color="#800000">'Enter new value: '</font><font color="#000080">);
      </font>readln<font color="#000080">(</font>MyConfig<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>ConfigBlockReWrite<font color="#000080">(</font>MyConfig<font color="#000080">,</font>SizeOf<font color="#000080">(</font>ConfigBlock<font color="#000080">)) </font><font color="#FF0000"><b>then
        </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Rewrote the block.'</font><font color="#000080">)
      </font><font color="#FF0000"><b>else
        </b></font>Writeln<font color="#000080">(</font><font color="#800000">'ConfigBlockReWrite failed.'</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
    else
      </b></font>Writeln<font color="#000080">(</font><font color="#800000">'ReadConfigBlock failed'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else
  begin
    </b></font>Write<font color="#000080">(</font><font color="#800000">'Enter inital value For MyConfig: '</font><font color="#000080">);
    </font>readln<font color="#000080">(</font>MyConfig<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>NewConfigBlock<font color="#000080">(</font>MyConfig<font color="#000080">, </font>SizeOf<font color="#000080">(</font>ConfigBlock<font color="#000080">)) </font><font color="#FF0000"><b>then
      </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Created new config block'</font><font color="#000080">)
    </font><font color="#FF0000"><b>else
      </b></font>Writeln<font color="#000080">(</font><font color="#800000">'NewConfigBlock failed.'</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0014.PAS">Original</a><b>]</b></p></body>
</html>
