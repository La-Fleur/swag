<html>
<head><title> "Checking for SFX headers" by GAYLE DAVIS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0015.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{ Detection of ZIP and ARJ SFX files }

{$S-,V-,D+,I-}
</i></font><font color="#FF0000"><b>USES </b></font>DOS<font color="#000080">;


</font><font color="#FF0000"><b>TYPE
  </b></font>ArchiveTypes <font color="#000080">= (</font>NONE<font color="#000080">,</font>ARJ<font color="#000080">,</font>PKZIP<font color="#000080">);
  </font>Header <font color="#000080">= </font><font color="#FF0000"><b>RECORD
           </b></font>HeadId  <font color="#000080">: </font>WORD<font color="#000080">;                                      </font><font color="#008000"><i>{ 60000 }
           </i></font>SIG1    <font color="#000080">: </font>WORD<font color="#000080">;                          </font><font color="#008000"><i>{ Basic Header Size }
  </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR

   </b></font>ArchiveName   <font color="#000080">: </font>PathStr<font color="#000080">;
   </font>ArchiveSize   <font color="#000080">: </font>LongInt<font color="#000080">;  </font><font color="#008000"><i>{ actual size of archive }
   </i></font>ArchiveOffset <font color="#000080">: </font>LongInt<font color="#000080">;  </font><font color="#008000"><i>{ bytes to skip in header if SFX }
   </i></font>ArchiveKind   <font color="#000080">: </font>ArchiveTypes<font color="#000080">;

  </font><font color="#FF0000"><b>FUNCTION </b></font>CheckSfx<font color="#000080">(</font>SfxName <font color="#000080">: </font>PathStr<font color="#000080">) : </font>BOOLEAN<font color="#000080">;

  </font><font color="#008000"><i>{-check for self-extracting archive}
  {-if Sfx Exe: set ArchiveName and ArchiveOffset}
  </i></font><font color="#FF0000"><b>Var </b></font>ImageInfo <font color="#000080">: </font><font color="#FF0000"><b>Record
                    </b></font>ExeId <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Char<font color="#000080">;
                    </font>Remainder<font color="#000080">,
                    </font>size <font color="#000080">: </font>Word
                  <font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font>SfxExe <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
    </font>H  <font color="#000080">: </font>Header<font color="#000080">;
    </font>rd <font color="#000080">: </font>Word<font color="#000080">;
    </font>Err <font color="#000080">: </font>Boolean<font color="#000080">;
    </font>AOffset <font color="#000080">: </font>LongInt<font color="#000080">;
    </font>ExeId <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Char<font color="#000080">;

  </font><font color="#FF0000"><b>Begin

    </b></font>CheckSFX <font color="#000080">:= </font>FALSE<font color="#000080">;
    </font>Assign<font color="#000080">(</font>SfxExe<font color="#000080">, </font>SfxName<font color="#000080">); </font>Reset<font color="#000080">(</font>SfxExe<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>IoResult <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;

    </font>ArchiveName   <font color="#000080">:= </font>SfxName<font color="#000080">;
    </font>ArchiveOffset <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>ArchiveSize   <font color="#000080">:= </font>Filesize<font color="#000080">(</font>SfxExe<font color="#000080">);
    </font>BlockRead<font color="#000080">(</font>SfxExe<font color="#000080">, </font>ImageInfo<font color="#000080">, </font>SizeOf<font color="#000080">(</font>ImageInfo<font color="#000080">));
    </font><font color="#FF0000"><b>If </b></font>ImageInfo<font color="#000080">.</font>ExeId <font color="#000080">&lt;&gt; </font><font color="#800000">'MZ' </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
    </font>AOffset <font color="#000080">:= </font>LongInt<font color="#000080">(</font>ImageInfo<font color="#000080">.</font>size<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)*</font><font color="#800000">512</font><font color="#000080">+</font>ImageInfo<font color="#000080">.</font>Remainder<font color="#000080">;
    </font>Seek<font color="#000080">(</font>SfxExe<font color="#000080">, </font>AOffset<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>IoResult <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
    </font>BlockRead<font color="#000080">(</font>SfxExe<font color="#000080">, </font>H<font color="#000080">, </font>SizeOf<font color="#000080">(</font>H<font color="#000080">), </font>rd<font color="#000080">);
    </font>Err <font color="#000080">:= (</font>IoResult <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Or </b></font><font color="#000080">(</font>rd <font color="#000080">&lt; </font>SizeOf<font color="#000080">(</font>Header<font color="#000080">));
    </font>Close<font color="#000080">(</font>SfxExe<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>Err <font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
    </font>ArchiveName   <font color="#000080">:= </font>SfxName<font color="#000080">;
    </font>ArchiveOffset <font color="#000080">:= </font>AOffset <font color="#000080">+ (</font>ORD<font color="#000080">(</font>BOOLEAN<font color="#000080">(</font>H<font color="#000080">.</font>Sig1 <font color="#000080">= </font><font color="#800000">$EA60</font><font color="#000080">)) * </font><font color="#800000">2</font><font color="#000080">); </font><font color="#008000"><i>{ add 2 bytes for ARJ241}
    </i></font>ArchiveKind   <font color="#000080">:= </font>ArchiveTypes<font color="#000080">(</font>ORD<font color="#000080">(</font>ArchiveOffset <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) + </font>ORD<font color="#000080">(</font>BOOLEAN<font color="#000080">(</font>H<font color="#000080">.</font>Sig1 <font color="#000080">&lt;&gt; </font><font color="#800000">$EA60</font><font color="#000080">)));
    </font>CheckSfx      <font color="#000080">:= (</font>ArchiveOffset <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

                                              
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to ARCHIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0015.PAS">Original</a><b>]</b></p></body>
</html>
