<html>
<head><title> "BmpToGif" by JOHN THE GREAT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0340.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ Caveats:
  1. This ONLY converts 256 color bitmaps!
  2. The only format supported is GIF87a.
}

</i></font><font color="#FF0000"><b>unit </b></font>Bmp2Gif<font color="#000080">;

</font><font color="#FF0000"><b>interface

  uses
    </b></font>SysUtils<font color="#000080">,
  </font>Classes<font color="#000080">,
  </font>Windows<font color="#000080">,
  </font>Graphics<font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>SaveAsGif<font color="#000080">(</font>InputBM <font color="#000080">: </font>TBitmap<font color="#000080">; </font>FName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>implementation

const
  </b></font>BlockTerminator<font color="#000080">:</font>byte <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>FileTrailer<font color="#000080">:</font>byte <font color="#000080">= </font><font color="#800000">$3B</font><font color="#000080">;
  </font>gifBGColor<font color="#000080">:</font>byte <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>gifPixAsp<font color="#000080">:</font>byte <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>gifcolordepth<font color="#000080">:</font>byte <font color="#000080">= </font><font color="#800000">8</font><font color="#000080">;  </font><font color="#008000"><i>// 8 bit = 256 colors
  </i></font>gifncolors<font color="#000080">:</font>integer <font color="#000080">= </font><font color="#800000">256</font><font color="#000080">;
  </font>gifLIDid<font color="#000080">:</font>byte <font color="#000080">= </font><font color="#800000">$2C</font><font color="#000080">;
  </font>HASHSIZE<font color="#000080">:</font>integer <font color="#000080">= </font><font color="#800000">5101</font><font color="#000080">;
  </font>HASHBITS<font color="#000080">:</font>integer <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;
  </font>TABLSIZE<font color="#000080">:</font>integer <font color="#000080">= </font><font color="#800000">4096</font><font color="#000080">;
  </font>EMPTY<font color="#000080">:</font>integer <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">;

</font><font color="#FF0000"><b>var
 </b></font>F <font color="#000080">: </font>integer<font color="#000080">;
 </font>Dbg <font color="#000080">: </font>TextFile<font color="#000080">;
 </font>MapBM <font color="#000080">: </font>TBitmap<font color="#000080">;
 </font>ImageWidth<font color="#000080">,</font>ImageHeight<font color="#000080">:</font>Integer<font color="#000080">;
 </font>buffer <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
 </font>codes <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">5101</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Integer<font color="#000080">;
 </font>prefix<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">5101</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Integer<font color="#000080">;
 </font>suffix<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">5101</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Integer<font color="#000080">;
 </font>nBytes<font color="#000080">,</font>nbits<font color="#000080">, </font>size<font color="#000080">,</font>cursize<font color="#000080">, </font>curcode<font color="#000080">, </font>maxcode <font color="#000080">: </font>Integer<font color="#000080">;
 </font>BitmapSizeImage <font color="#000080">: </font>Integer<font color="#000080">;
 </font>Started <font color="#000080">: </font>Boolean<font color="#000080">;
 </font>minsize<font color="#000080">,</font>maxsize<font color="#000080">,</font>nroots<font color="#000080">,</font>Capacity <font color="#000080">: </font>Integer<font color="#000080">;
 </font>endc<font color="#000080">, </font>clrc <font color="#000080">: </font>Integer<font color="#000080">;
 </font>MinLZWCodeSize <font color="#000080">: </font>Byte<font color="#000080">;
 </font>bytecode<font color="#000080">,</font>bytemask <font color="#000080">:</font>Integer<font color="#000080">;
 </font>counter <font color="#000080">: </font>Integer<font color="#000080">;
 </font>strc<font color="#000080">,</font>chrc <font color="#000080">:</font>Integer<font color="#000080">;
 </font>ErrorMsg <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Putbyte<font color="#000080">(</font>B<font color="#000080">,</font>fh<font color="#000080">:</font>Integer<font color="#000080">):</font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Counter <font color="#000080">:= </font>counter <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>buffer<font color="#000080">[</font>nbytes<font color="#000080">] := </font>B<font color="#000080">;
  </font>Inc<font color="#000080">(</font>nbytes<font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>nbytes <font color="#000080">= </font><font color="#800000">255 </font><font color="#FF0000"><b>then
  begin
    </b></font><font color="#008000"><i>//ShowMessage('255');
    </i></font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>nbytes<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>buffer<font color="#000080">,</font>nbytes<font color="#000080">);
    </font>nbytes <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>result <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>PutCode<font color="#000080">(</font>code<font color="#000080">, </font>fh <font color="#000080">:</font>Integer<font color="#000080">) : </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>temp<font color="#000080">,</font>n<font color="#000080">,</font>mask <font color="#000080">:</font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>mask <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>n <font color="#000080">:= </font>nbits<font color="#000080">;
  </font><font color="#008000"><i>//If nbits &gt; 11 then ShowMessage('nbits = 12');
  </i></font><font color="#FF0000"><b>while </b></font>n <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    </b></font>dec<font color="#000080">(</font>n<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">((</font>code <font color="#FF0000"><b>and </b></font>mask<font color="#000080">)&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>bytecode <font color="#000080">:= (</font>bytecode <font color="#FF0000"><b>or </b></font>bytemask<font color="#000080">);
    </font>bytemask <font color="#000080">:= </font>bytemask <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>bytemask <font color="#000080">&gt; </font><font color="#800000">$80</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      If </b></font>PutByte<font color="#000080">(</font>bytecode<font color="#000080">,</font>fh<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>bytecode <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
        </font>bytemask <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>mask <font color="#000080">:= </font>mask <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>result <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Flush<font color="#000080">(</font>fh<font color="#000080">:</font>Integer<font color="#000080">);

</font><font color="#FF0000"><b>begin
  if </b></font>bytemask <font color="#000080">&lt;&gt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then
  begin
    </b></font>PutByte<font color="#000080">(</font>byteCode<font color="#000080">,</font>fh<font color="#000080">);
    </font>bytecode <font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    </font>bytemask <font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>nbytes <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>nbytes<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>buffer<font color="#000080">,</font>nbytes<font color="#000080">);
    </font>nbytes <font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>ClearX<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>J <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>cursize <font color="#000080">:= </font>minsize<font color="#000080">;
  </font>nbits <font color="#000080">:= </font>cursize<font color="#000080">;
  </font>curcode <font color="#000080">:= </font>endc <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>maxcode <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>cursize<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>J <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>HASHSIZE <font color="#FF0000"><b>do </b></font>codes<font color="#000080">[</font>J<font color="#000080">] := </font>EMPTY<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>findstr<font color="#000080">(</font>pfx<font color="#000080">,</font>sfx <font color="#000080">:</font>Integer<font color="#000080">):</font>integer<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">,</font>di <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>i <font color="#000080">:= (</font>sfx <font color="#FF0000"><b>shl </b></font>HASHBITS<font color="#000080">) </font><font color="#FF0000"><b>xor </b></font>pfx<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>i <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>di <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>else </b></font>di <font color="#000080">:= </font>Capacity <font color="#000080">-</font>i<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>True <font color="#FF0000"><b>do
  begin
    if </b></font>codes<font color="#000080">[</font>i<font color="#000080">] = </font>EMPTY <font color="#FF0000"><b>then </b></font>break<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">((</font>prefix<font color="#000080">[</font>i<font color="#000080">] = </font>pfx<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>suffix<font color="#000080">[</font>i<font color="#000080">] = </font>sfx<font color="#000080">)) </font><font color="#FF0000"><b>then </b></font>break<font color="#000080">;
    </font>i <font color="#000080">:= </font>i <font color="#000080">- </font>di<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>i <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>i <font color="#000080">:= </font>i <font color="#000080">+ </font>Capacity<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Result <font color="#000080">:= </font>i<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>EncodeScanLine<font color="#000080">(</font>fh <font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>buf <font color="#000080">: </font>Pbyte<font color="#000080">; </font>npxls <font color="#000080">: </font>Integer<font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>np<font color="#000080">,</font>I <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>np <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>Started <font color="#FF0000"><b>then
  begin
    </b></font>strc <font color="#000080">:= </font>buf<font color="#000080">^;
    </font>Inc<font color="#000080">(</font>np<font color="#000080">); </font>Inc<font color="#000080">(</font>buf<font color="#000080">);
    </font>Started <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>np <font color="#000080">&lt; </font>npxls <font color="#FF0000"><b>do
  begin
    </b></font><font color="#008000"><i>// If np = 3 then break;
    </i></font>chrc <font color="#000080">:= </font>buf<font color="#000080">^;
    </font>Inc<font color="#000080">(</font>np<font color="#000080">); </font>Inc<font color="#000080">(</font>buf<font color="#000080">);
    </font>I <font color="#000080">:= </font>findstr<font color="#000080">(</font>strc<font color="#000080">,</font>chrc<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>codes<font color="#000080">[</font>I<font color="#000080">] &lt;&gt; </font>EMPTY <font color="#FF0000"><b>then
      </b></font>strc <font color="#000080">:= </font>codes<font color="#000080">[</font>I<font color="#000080">]
    </font><font color="#FF0000"><b>else
    begin
      </b></font>codes<font color="#000080">[</font>I<font color="#000080">] := </font>curcode<font color="#000080">;
      </font>prefix<font color="#000080">[</font>I<font color="#000080">] := </font>strc<font color="#000080">;
      </font>suffix<font color="#000080">[</font>I<font color="#000080">] := </font>chrc<font color="#000080">;
      </font>putcode<font color="#000080">(</font>strc<font color="#000080">,</font>fh<font color="#000080">);
      </font>strc <font color="#000080">:= </font>chrc<font color="#000080">;
      </font>Inc<font color="#000080">(</font>curcode<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>curcode <font color="#000080">&gt; </font>maxcode <font color="#FF0000"><b>then
      begin
        </b></font>Inc<font color="#000080">(</font>cursize<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>cursize <font color="#000080">&gt; </font>maxsize <font color="#FF0000"><b>then
        begin
          </b></font>putcode<font color="#000080">(</font>clrc<font color="#000080">,</font>fh<font color="#000080">);
          </font>ClearX<font color="#000080">;
        </font><font color="#FF0000"><b>end
        else
        begin
          </b></font>nbits <font color="#000080">:= </font>cursize<font color="#000080">;
          </font>maxcode <font color="#000080">:= </font>maxcode <font color="#FF0000"><b>shl </b></font><font color="#800000">1</font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>cursize <font color="#000080">= </font>maxsize  <font color="#FF0000"><b>then </b></font>dec<font color="#000080">(</font>maxcode<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Initialize<font color="#000080">(</font>fh<font color="#000080">:</font>integer<font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>flags <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>counter <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Started <font color="#000080">:= </font>False<font color="#000080">;
  </font>size <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
  </font>nbytes <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>nbits <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
  </font>bytecode <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>bytemask <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>Capacity <font color="#000080">:= </font>HASHSIZE<font color="#000080">;
  </font>minsize <font color="#000080">:= </font><font color="#800000">9</font><font color="#000080">;
  </font>maxsize <font color="#000080">:= </font><font color="#800000">12</font><font color="#000080">;
  </font>nroots <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font><font color="#800000">8</font><font color="#000080">;
  </font>clrc <font color="#000080">:= </font>nroots<font color="#000080">;
  </font>endc <font color="#000080">:= </font>clrc <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>MinLZWCodeSize <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
  </font>ClearX<font color="#000080">;
  </font><font color="#008000"><i>// Write the type
  </i></font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font><font color="#800000">'GIF87a'</font><font color="#000080">,</font><font color="#800000">6</font><font color="#000080">);
  </font><font color="#008000"><i>// Write the GIF screen descriptor
  // Note: width &gt; 255 is a two byte word!!
  </i></font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>ImageWidth<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>ImageHeight<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
  </font>flags <font color="#000080">:= </font><font color="#800000">$80 </font><font color="#FF0000"><b>or </b></font><font color="#000080">((</font>gifcolordepth<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)</font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>gifcolordepth<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">);
  </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>flags<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>gifBGColor<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>gifPixAsp<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>procedure </b></font>WriteGif<font color="#000080">(</font>fh <font color="#000080">: </font>integer<font color="#000080">);

</font><font color="#FF0000"><b>var
  </b></font>F<font color="#000080">:</font>TextFile<font color="#000080">;
  </font>gifxLeft<font color="#000080">,</font>gifyTop <font color="#000080">: </font>word<font color="#000080">; </font><font color="#008000"><i>//Must be 16 bit!!
  </i></font>flags <font color="#000080">:</font>Byte<font color="#000080">;
  </font>K <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>Test<font color="#000080">,</font>J<font color="#000080">,</font>M <font color="#000080">: </font>Integer<font color="#000080">;
  </font>scanLine<font color="#000080">, </font>TempscanLine<font color="#000080">, </font>Bits<font color="#000080">, </font>PBits <font color="#000080">: </font>PByte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>//Get the info from the Bitmap
  </i></font>GetMem<font color="#000080">(</font>K<font color="#000080">,(</font>sizeof<font color="#000080">(</font>TBitMapInfoHeader<font color="#000080">) + </font><font color="#800000">4 </font><font color="#000080">* </font>gifncolors<font color="#000080">));
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biSize <font color="#000080">:= </font>sizeof<font color="#000080">(</font>TBitMapInfoHeader<font color="#000080">);
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biWidth <font color="#000080">:= </font>ImageWidth<font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biHeight <font color="#000080">:= </font>ImageHeight<font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biPlanes <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biBitCount <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biCompression <font color="#000080">:= </font>BI_RGB<font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biSizeImage <font color="#000080">:=
  ((((</font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biWidth <font color="#000080">* </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biBitCount<font color="#000080">)+</font><font color="#800000">31</font><font color="#000080">)
      </font><font color="#FF0000"><b>and Not</b></font><font color="#000080">(</font><font color="#800000">31</font><font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">3</font><font color="#000080">)*</font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biHeight<font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biXPelsPerMeter <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biYPelsPerMeter <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biClrUsed <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biClrImportant <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>try
    </b></font>GetMem<font color="#000080">(</font>Bits<font color="#000080">,</font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biSizeImage<font color="#000080">);
    </font>Test <font color="#000080">:= </font>GetDIBits<font color="#000080">(</font>MapBM<font color="#000080">.</font>Canvas<font color="#000080">.</font>Handle<font color="#000080">,</font>MapBM<font color="#000080">.</font>Handle<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>ImageHeight<font color="#000080">,</font>Bits<font color="#000080">,</font>TBitmapInfo<font color="#000080">(</font>K<font color="#000080">^),</font>DIB_RGB_COLORS<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>Test <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      for </b></font>J <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
      begin
        </b></font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>TBitMapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiColors<font color="#000080">[</font>J<font color="#000080">].</font>rgbRed<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
        </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>TBitMapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiColors<font color="#000080">[</font>J<font color="#000080">].</font>rgbGreen<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
        </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>TBitMapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiColors<font color="#000080">[</font>J<font color="#000080">].</font>rgbBlue<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#008000"><i>//Write the Logical Image Descriptor
      </i></font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>gifLIDid<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>gifxLeft <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;  </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>gifxLeft<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">); </font><font color="#008000"><i>// Write X position of image
      </i></font>gifyTop  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;  </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>gifyTop<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);  </font><font color="#008000"><i>// Write Y position of image
      </i></font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>ImageWidth<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
      </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>ImageHeight<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
      </font>flags <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>flags<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>//Write Local flags 0=None
      //Write Min LZW code size = 8 (for 8 bit)
      </i></font>MinLZWCodeSize <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
      </font>FileWrite<font color="#000080">(</font>fh<font color="#000080">,</font>MinLZWCodesize<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>PutCode<font color="#000080">(</font>clrc<font color="#000080">,</font>fh<font color="#000080">);
      </font>PBits <font color="#000080">:= </font>Bits<font color="#000080">;
      </font>Inc<font color="#000080">(</font>Pbits<font color="#000080">,(</font>ImageWidth <font color="#000080">*(</font>ImageHeight <font color="#000080">-</font><font color="#800000">1</font><font color="#000080">)));
      </font>GetMem<font color="#000080">(</font>scanLine<font color="#000080">,</font>ImageWidth<font color="#000080">);
      </font>TempscanLine <font color="#000080">:= </font>scanLine<font color="#000080">;
      </font><font color="#FF0000"><b>For </b></font>M <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>ImageHeight<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
      begin
        </b></font>FillChar<font color="#000080">(</font>scanLine<font color="#000080">^,</font>ImageWidth<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
        </font>move<font color="#000080">(</font>PBits<font color="#000080">^,</font>scanLine<font color="#000080">^,</font>ImageWidth<font color="#000080">);
        </font>EncodeScanLine<font color="#000080">(</font>fh<font color="#000080">,</font>scanLine<font color="#000080">,</font>ImageWidth<font color="#000080">);
        </font>dec<font color="#000080">(</font>scanLine<font color="#000080">,</font>ImageWidth<font color="#000080">);
        </font>Dec<font color="#000080">(</font>PBits<font color="#000080">,</font>ImageWidth<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>finally
    </b></font>scanLine <font color="#000080">:= </font>TempscanLine<font color="#000080">;
    </font>FreeMem<font color="#000080">(</font>scanLine<font color="#000080">,</font>ImageWidth<font color="#000080">);
    </font>FreeMem<font color="#000080">(</font>Bits<font color="#000080">,</font>TBitMapInfo<font color="#000080">(</font>K<font color="#000080">^).</font>bmiHeader<font color="#000080">.</font>biSizeImage<font color="#000080">);
    </font>FreeMem<font color="#000080">(</font>K<font color="#000080">,(</font>sizeof<font color="#000080">(</font>TBitMapInfoHeader<font color="#000080">) + </font><font color="#800000">4 </font><font color="#000080">* </font>gifncolors<font color="#000080">));
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>function </b></font>SaveAsGif<font color="#000080">(</font>InputBM <font color="#000080">: </font>TBitmap<font color="#000080">; </font>FName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>ErrorMsg <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font>Result <font color="#000080">:= </font>FALSE<font color="#000080">;
  </font>MapBM <font color="#000080">:= </font>InputBM<font color="#000080">;
  </font>ImageWidth <font color="#000080">:= </font>MapBM<font color="#000080">.</font>Width<font color="#000080">;
  </font>ImageHeight <font color="#000080">:= </font>MapBM<font color="#000080">.</font>Height<font color="#000080">;
  </font>F <font color="#000080">:= </font>FileCreate<font color="#000080">(</font>FName<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>F <font color="#000080">&gt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>Initialize<font color="#000080">(</font>F<font color="#000080">);
    </font>WriteGif<font color="#000080">(</font>F<font color="#000080">);
    </font>PutCode<font color="#000080">(</font>strc<font color="#000080">,</font>F<font color="#000080">);
    </font>PutCode<font color="#000080">(</font>endc<font color="#000080">,</font>F<font color="#000080">);
    </font>Flush<font color="#000080">(</font>F<font color="#000080">);
    </font>FileWrite<font color="#000080">(</font>F<font color="#000080">,</font>BlockTerminator<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>FileWrite<font color="#000080">(</font>F<font color="#000080">,</font>FileTrailer<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font>FileClose<font color="#000080">(</font>F<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>length<font color="#000080">(</font>ErrorMsg<font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Result <font color="#000080">:= </font>TRUE<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0340.PAS">Original</a><b>]</b></p></body>
</html>
