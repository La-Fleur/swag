<html>
<head><title> "FLI ScreenSave for Delphi 1.0" by TOMMY ANDERSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0236.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Hi, This is an easy made screensaver, viewing FLI files from
Autodesk animator, it's not optimized for reading FLC files, since
that would be a larger project, which i dont have enough spare-time
for now!

The &quot;Treatframe&quot; and &quot;Getclock&quot; routine was taken from Eirik Pedersens
fli player, found in snipet: &quot;misc&quot;. I had to change Treatframe a litle
just to handle the palette. Use at your own risk.

There's not much documentation, but if there's so much you don't understand,
send me a mail, and i'll try to answer it as soon as possible!



Tommy Andersen
email: tommy.andersen@dialogue.telemax.no
snail: Tommy Andersen
       Andebuveien 11
       3170  SEM
       Norway
}


</i></font><font color="#FF0000"><b>Program </b></font>Fliplay<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Forms<font color="#000080">,
  </font>Unit1 <font color="#FF0000"><b>in </b></font><font color="#800000">'UNIT1.PAS' </font><font color="#008000"><i>{Form1}</i></font><font color="#000080">;

</font><font color="#008000"><i>{$R *.RES}

</i></font><font color="#FF0000"><b>Begin
   </b></font><font color="#008000"><i>{ Prevent multiple instances }
   </i></font><font color="#FF0000"><b>IF </b></font>HPrevinst <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;

   </font>Application<font color="#000080">.</font>CreateForm<font color="#000080">(</font>TForm1<font color="#000080">, </font>Form1<font color="#000080">);
   </font>Application<font color="#000080">.</font>Run<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font><font color="#008000"><i>{ -------------  Cut out and save as UNIT1.PAS ----------------- }

</i></font><font color="#FF0000"><b>Unit </b></font>Unit1<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Uses
  </b></font>SysUtils<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Messages<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">, </font>Controls<font color="#000080">,
  </font>Forms<font color="#000080">, </font>Dialogs<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>CLOCK_HZ              <font color="#000080">= </font><font color="#800000">4608</font><font color="#000080">;                   </font><font color="#008000"><i>{ Frequency of clock }
  </i></font>MONItoR_HZ            <font color="#000080">= </font><font color="#800000">70</font><font color="#000080">;                     </font><font color="#008000"><i>{ Frequency of monitor }
  </i></font>CLOCK_SCALE           <font color="#000080">= </font>CLOCK_HZ <font color="#FF0000"><b>div </b></font>MONItoR_HZ<font color="#000080">;
  </font>CDATA                 <font color="#000080">= </font><font color="#800000">$040</font><font color="#000080">;                   </font><font color="#008000"><i>{ Port number of timer 0 }
  </i></font>CMODE                 <font color="#000080">= </font><font color="#800000">$043</font><font color="#000080">;                   </font><font color="#008000"><i>{ Port number of timers control Word }
  </i></font>Scale_FLI             <font color="#000080">= </font>False<font color="#000080">;                  </font><font color="#008000"><i>{ Set this to true if saver shall use whole screen }

</i></font><font color="#FF0000"><b>Type
  </b></font>Big_Buffer_Type <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">65534</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>FliHeaderType <font color="#000080">= </font><font color="#FF0000"><b>Record
                     </b></font>Size          <font color="#000080">: </font>Longint<font color="#000080">;
                     </font>Magic         <font color="#000080">: </font>Word<font color="#000080">;
                     </font>Frames        <font color="#000080">: </font>Word<font color="#000080">;
                     </font>Width         <font color="#000080">: </font>Word<font color="#000080">;
                     </font>Height        <font color="#000080">: </font>Word<font color="#000080">;
                     </font>Bitsperpixel  <font color="#000080">: </font>Word<font color="#000080">;
                     </font>Flags         <font color="#000080">: </font>Integer<font color="#000080">;
                     </font>Speed         <font color="#000080">: </font>Integer<font color="#000080">;
                     </font>Nexthead      <font color="#000080">: </font>Longint<font color="#000080">;
                     </font>Framesintable <font color="#000080">: </font>Longint<font color="#000080">;
                     </font>hfile         <font color="#000080">: </font>Integer<font color="#000080">;
                     </font>hframe1offset <font color="#000080">: </font>Longint<font color="#000080">;
                     </font>Strokes       <font color="#000080">: </font>Longint<font color="#000080">;
                     </font>Session       <font color="#000080">: </font>Longint<font color="#000080">;
                     </font>Reserved      <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">88</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
                  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>FrameHeaderType <font color="#000080">= </font><font color="#FF0000"><b>Record
                       </b></font>Size   <font color="#000080">: </font>LongInt<font color="#000080">;
                       </font>Magic  <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ $F1FA }
                       </i></font>Chunks <font color="#000080">: </font>Word<font color="#000080">;
                       </font>Expand <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
                    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;


  </font>TForm1 <font color="#000080">= </font><font color="#FF0000"><b>Class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
    </font>OpenDialog1<font color="#000080">: </font>TOpenDialog<font color="#000080">;
    </font><font color="#FF0000"><b>Procedure </b></font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>FormPaint<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>FormMouseMove<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font>Shift<font color="#000080">: </font>TShiftState<font color="#000080">; </font>X<font color="#000080">,
      </font>Y<font color="#000080">: </font>Integer<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>FormKeyDown<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Key<font color="#000080">: </font>Word<font color="#000080">;
      </font>Shift<font color="#000080">: </font>TShiftState<font color="#000080">);
  </font><font color="#FF0000"><b>Private
    </b></font><font color="#008000"><i>{ Private declarations }
  </i></font><font color="#FF0000"><b>Public
    </b></font><font color="#008000"><i>{ Public declarations }
    </i></font>Start_Screensaver        <font color="#000080">: </font>Boolean<font color="#000080">;
    </font>MouseMovement            <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Fli_Filename             <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font>Screensaver_Ini_filename <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font>ScreenBitmap             <font color="#000080">: </font>TBitmap<font color="#000080">;


    </font>Flifilestream            <font color="#000080">: </font>TMemoryStream<font color="#000080">;
    </font>FliScreenstream          <font color="#000080">: </font>TMemoryStream<font color="#000080">;
    </font>Screen_Buffer            <font color="#000080">: ^</font>Big_Buffer_Type<font color="#000080">;
    </font>File_Buffer              <font color="#000080">: ^</font>Big_Buffer_Type<font color="#000080">;
    </font>FLI_Header               <font color="#000080">: </font>FLIHeaderType<font color="#000080">;
    </font>FLI_FrameHeader          <font color="#000080">: </font>FrameHeaderType<font color="#000080">;
    </font>FLI_Speed                <font color="#000080">: </font>Longint<font color="#000080">;
    </font>FLI_Nexttime             <font color="#000080">: </font>Longint<font color="#000080">;
    </font>Fli_FrameNr              <font color="#000080">: </font>Word<font color="#000080">;
    </font>FLI_SecondPosition       <font color="#000080">: </font>Longint<font color="#000080">;


    </font><font color="#FF0000"><b>Procedure </b></font>Get_INI_Filename<font color="#000080">;
    </font><font color="#FF0000"><b>Procedure </b></font>Read_INI_Settings<font color="#000080">;
    </font><font color="#FF0000"><b>Procedure </b></font>Write_INI_Settings<font color="#000080">;

    </font><font color="#FF0000"><b>Procedure </b></font>Create_Bitmap<font color="#000080">;
    </font><font color="#FF0000"><b>Procedure </b></font>Show_Next_Frame<font color="#000080">;
    </font><font color="#FF0000"><b>Procedure </b></font>Load_FLI_File<font color="#000080">;
    </font><font color="#FF0000"><b>Procedure </b></font>Kill_FLI_Screensaver<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Form1<font color="#000080">: </font>TForm1<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

</b></font><font color="#008000"><i>{$R *.DFM}

</i></font><font color="#FF0000"><b>Uses </b></font>Inifiles<font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>GetClock<font color="#000080">:</font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">; </font><font color="#008000"><i>{Taken from the FLILIB source}
{ this routine returns a clock With occassional spikes where time
  will look like its running backwards 1/18th of a second.  The resolution
  of the clock is 1/(18*256) = 1/4608 second.  66 ticks of this clock
  are supposed to be equal to a monitor 1/70 second tick.}
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">mov  ah,0                                         </font><font color="#008000"><i>{ get tick count from Dos and use For hi 3 Bytes }
  </i></font><font color="#FF00FF">int  01ah                                         </font><font color="#008000"><i>{ lo order count in DX, hi order in CX }
  </i></font><font color="#FF00FF">mov  ah,dl
  mov  dl,dh
  mov  dh,cl

  mov  al,0                                         </font><font color="#008000"><i>{ read lo Byte straight from timer chip }
  </i></font><font color="#FF00FF">out  CMODE,al                                         </font><font color="#008000"><i>{ latch count }
  </i></font><font color="#FF00FF">mov  al,1
  out  CMODE,al                                         </font><font color="#008000"><i>{ set up to read count }
  </i></font><font color="#FF00FF">in   al,CDATA                                         </font><font color="#008000"><i>{ read in lo Byte (and discard) }
  </i></font><font color="#FF00FF">in   al,CDATA                                         </font><font color="#008000"><i>{ hi Byte into al }
  </i></font><font color="#FF00FF">neg  al                                         </font><font color="#008000"><i>{ make it so counting up instead of down }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>Get_INI_Filename<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Buffer <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>Size   <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>Size <font color="#000080">:= </font>GetSystemDirectory<font color="#000080">(</font>Buffer<font color="#000080">, </font><font color="#800000">256</font><font color="#000080">);
   </font><font color="#FF0000"><b>IF </b></font>Size <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>Then
   Begin
      </b></font>Screensaver_Ini_filename <font color="#000080">:= </font>StrPas<font color="#000080">(</font>Buffer<font color="#000080">);
      </font>Screensaver_Ini_filename<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>Chr<font color="#000080">(</font>Size<font color="#000080">);
   </font><font color="#FF0000"><b>End
    Else </b></font>Screensaver_Ini_filename <font color="#000080">:= </font><font color="#800000">'C:\'</font><font color="#000080">;



   </font><font color="#008000"><i>{ Make sure filename got the last expected slash }
   </i></font><font color="#FF0000"><b>IF </b></font>Screensaver_Ini_filename<font color="#000080">[</font>Length<font color="#000080">(</font>Screensaver_Ini_filename<font color="#000080">)] &lt;&gt; </font><font color="#800000">'\' </font><font color="#FF0000"><b>Then
      </b></font>Screensaver_Ini_filename <font color="#000080">:= </font>Screensaver_Ini_filename <font color="#000080">+ </font><font color="#800000">'\'</font><font color="#000080">;


   </font>Screensaver_Ini_filename <font color="#000080">:= </font>Screensaver_Ini_filename <font color="#000080">+ </font><font color="#800000">'FLIPLAY.INI'</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>Write_INI_Settings<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Inifile <font color="#000080">: </font>TInifile<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>Inifile <font color="#000080">:= </font>TInifile<font color="#000080">.</font>Create<font color="#000080">(</font>Screensaver_Ini_filename<font color="#000080">);
   </font>Inifile<font color="#000080">.</font>WriteString<font color="#000080">(</font><font color="#800000">'FLI-Screensaver'</font><font color="#000080">, </font><font color="#800000">'Filename'</font><font color="#000080">, </font>Fli_Filename<font color="#000080">);
   </font>Inifile<font color="#000080">.</font>Free<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>Read_INI_Settings<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Inifile <font color="#000080">: </font>TInifile<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>Inifile <font color="#000080">:= </font>TInifile<font color="#000080">.</font>Create<font color="#000080">(</font>Screensaver_Ini_filename<font color="#000080">);
   </font>Fli_Filename <font color="#000080">:= </font>Inifile<font color="#000080">.</font>ReadString<font color="#000080">(</font><font color="#800000">'FLI-Screensaver'</font><font color="#000080">, </font><font color="#800000">'Filename'</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">);
   </font>Inifile<font color="#000080">.</font>Free<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>Load_FLI_File<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Temp <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>Fli_FrameNr <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>FliFileStream<font color="#000080">.</font>Clear<font color="#000080">;

   </font><font color="#FF0000"><b>IF </b></font>FileExists<font color="#000080">(</font>Fli_Filename<font color="#000080">) </font><font color="#FF0000"><b>Then
   Begin
      Try
        </b></font>FliFileStream<font color="#000080">.</font>LoadFromFile<font color="#000080">(</font>Fli_Filename<font color="#000080">);
      </font><font color="#FF0000"><b>Except
        </b></font>FliFileStream<font color="#000080">.</font>Clear<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>FliFileStream<font color="#000080">.</font>Size <font color="#000080">&gt; </font><font color="#800000">128</font><font color="#000080">) </font><font color="#FF0000"><b>Then
      Begin
         </b></font>FliFileStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
         </font>Temp <font color="#000080">:= </font>FliFileStream<font color="#000080">.</font>Read<font color="#000080">(</font>Fli_Header<font color="#000080">, </font><font color="#800000">128</font><font color="#000080">);

         </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>Temp <font color="#000080">= </font><font color="#800000">128</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Fli_Header<font color="#000080">.</font>Magic <font color="#000080">= </font><font color="#800000">$AF11</font><font color="#000080">) </font><font color="#FF0000"><b>Then
         Begin
            </b></font><font color="#008000"><i>{ Ok }
            </i></font>FLI_Speed <font color="#000080">:= </font>Fli_Header<font color="#000080">.</font>Speed<font color="#000080">;
            </font>FLI_Speed <font color="#000080">:= </font>FLI_Speed<font color="#000080">*</font>CLOCK_SCALE<font color="#000080">;
            </font>FLI_NextTime <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
         </font><font color="#FF0000"><b>End
          Else </b></font>FliFileStream<font color="#000080">.</font>Clear<font color="#000080">;

      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>Create_Bitmap<font color="#000080">;
</font><font color="#FF0000"><b>Type
  </b></font>BitmapHeader <font color="#000080">= </font><font color="#FF0000"><b>Record
                    </b></font>ID    <font color="#000080">: </font>Word<font color="#000080">;
                    </font>FSize <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>Ver   <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>Image <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>Misc  <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>Width <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>Height<font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>Num   <font color="#000080">: </font>Word<font color="#000080">;
                    </font>Bits  <font color="#000080">: </font>Word<font color="#000080">;
                    </font>Comp  <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>ISize <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>XRes  <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>YRes  <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>PSize <font color="#000080">: </font>LongInt<font color="#000080">;
                    </font>Res   <font color="#000080">: </font>LongInt<font color="#000080">;
                 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>BmpHeader <font color="#000080">: </font>BitmapHeader<font color="#000080">;
  </font>T<font color="#000080">, </font>myByte <font color="#000080">: </font>Byte<font color="#000080">;
  </font>MSize     <font color="#000080">: </font>LongInt<font color="#000080">;


</font><font color="#FF0000"><b>Begin
   </b></font>FLIScreenStream<font color="#000080">.</font>Clear<font color="#000080">;


   </font>MSize <font color="#000080">:= </font><font color="#800000">64000</font><font color="#000080">;
   </font>MSize <font color="#000080">:= </font>MSize <font color="#000080">+ </font><font color="#800000">1024</font><font color="#000080">;
   </font>MSize <font color="#000080">:= </font>MSize <font color="#000080">+ </font><font color="#800000">54</font><font color="#000080">;

   </font>BmpHeader<font color="#000080">.</font>ID          <font color="#000080">:= </font><font color="#800000">19778</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>FSize       <font color="#000080">:= </font>MSize<font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Ver         <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Image       <font color="#000080">:= </font><font color="#800000">54 </font><font color="#000080">+ (</font><font color="#800000">256</font><font color="#000080">*</font><font color="#800000">4</font><font color="#000080">);
   </font>BmpHeader<font color="#000080">.</font>Misc        <font color="#000080">:= </font><font color="#800000">40</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Width       <font color="#000080">:= </font><font color="#800000">320</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Height      <font color="#000080">:= </font><font color="#800000">200</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Num         <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Bits        <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Comp        <font color="#000080">:= </font>bi_RGB<font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>ISize       <font color="#000080">:= </font>BmpHeader<font color="#000080">.</font>FSize <font color="#000080">- </font>BmpHeader<font color="#000080">.</font>Image<font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>XRes        <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>YRes        <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>BmpHeader<font color="#000080">.</font>Res         <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>ID<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>FSize<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Ver<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Image<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Misc<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Width<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Height<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Num<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Bits<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Comp<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>ISize<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>XRes<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>YRes<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>BmpHeader<font color="#000080">.</font>Res<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);


   </font>FLIScreenStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">54</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
   </font><font color="#008000"><i>{ Create palette }
   </i></font><font color="#FF0000"><b>For </b></font>T <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>To </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
   Begin
      </b></font><font color="#008000"><i>{ Blue }
      </i></font>myByte <font color="#000080">:= </font>T<font color="#000080">;
      </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>myByte<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);

      </font><font color="#008000"><i>{ Green }
      </i></font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>myByte<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);

      </font><font color="#008000"><i>{ Red }
      </i></font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>myByte<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);

      </font>myByte <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>myByte<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;


   </font>FillChar<font color="#000080">(</font>Screen_Buffer<font color="#000080">^, </font><font color="#800000">64000</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
   </font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>Screen_Buffer<font color="#000080">^, </font><font color="#800000">64000</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>Kill_FLI_Screensaver<font color="#000080">;
</font><font color="#FF0000"><b>Begin
   </b></font>Freemem<font color="#000080">(</font>Screen_Buffer<font color="#000080">, </font><font color="#800000">64000</font><font color="#000080">);
   </font>Freemem<font color="#000080">(</font>File_Buffer<font color="#000080">, </font><font color="#800000">65535</font><font color="#000080">);
   </font>Flifilestream<font color="#000080">.</font>Free<font color="#000080">;
   </font>FliScreenstream<font color="#000080">.</font>Free<font color="#000080">;
   </font>ScreenBitmap<font color="#000080">.</font>Free<font color="#000080">;
   </font>Halt<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>Param <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>S     <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>Flifilestream    <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
   </font>FliScreenstream  <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
   </font>ScreenBitmap     <font color="#000080">:= </font>TBitmap<font color="#000080">.</font>Create<font color="#000080">;


   </font>Param <font color="#000080">:= </font>Uppercase<font color="#000080">( </font>Paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) );
   </font>Caption <font color="#000080">:= </font><font color="#800000">'FLI screensaver, made by Tommy Andersen!'</font><font color="#000080">;
   </font>Application<font color="#000080">.</font>Title <font color="#000080">:= </font>Caption<font color="#000080">;


   </font>Getmem<font color="#000080">(</font>Screen_Buffer<font color="#000080">, </font><font color="#800000">64000</font><font color="#000080">);
   </font>Getmem<font color="#000080">(</font>File_Buffer<font color="#000080">, </font><font color="#800000">65535</font><font color="#000080">);


   </font>Get_INI_Filename<font color="#000080">;
   </font>Read_INI_Settings<font color="#000080">;


   </font><font color="#008000"><i>{ Config screensaver? }
   </i></font><font color="#FF0000"><b>IF </b></font>Param <font color="#000080">= </font><font color="#800000">'/C' </font><font color="#FF0000"><b>Then
   Begin
      </b></font><font color="#008000"><i>{ Yes }
      </i></font>Start_Screensaver <font color="#000080">:= </font>False<font color="#000080">;
      </font>Windowstate <font color="#000080">:= </font>wsMinimized<font color="#000080">;


      </font>S     <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font>Param <font color="#000080">:= </font>FLI_Filename<font color="#000080">;
      </font><font color="#FF0000"><b>While </b></font>Pos<font color="#000080">(</font><font color="#800000">'\'</font><font color="#000080">, </font>Param<font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
      Begin
         </b></font>S <font color="#000080">:= </font>S <font color="#000080">+ </font>Copy<font color="#000080">(</font>Param<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>Pos<font color="#000080">(</font><font color="#800000">'\'</font><font color="#000080">, </font>Param<font color="#000080">));
         </font>Delete<font color="#000080">(</font>Param<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>Pos<font color="#000080">(</font><font color="#800000">'\'</font><font color="#000080">, </font>Param<font color="#000080">));
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font>Opendialog1<font color="#000080">.</font>Initialdir <font color="#000080">:= </font>S<font color="#000080">;
      </font>Opendialog1<font color="#000080">.</font>Filename <font color="#000080">:= </font>Param<font color="#000080">;


      </font>Opendialog1<font color="#000080">.</font>Filter <font color="#000080">:= </font><font color="#800000">'FLI files|*.FLI|All files|*.*'</font><font color="#000080">;
      </font><font color="#FF0000"><b>IF </b></font>Opendialog1<font color="#000080">.</font>Execute <font color="#FF0000"><b>Then
      Begin
         </b></font>FLI_Filename <font color="#000080">:= </font>Opendialog1<font color="#000080">.</font>Filename<font color="#000080">;
         </font>Write_INI_Settings<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;


      </font>Kill_FLI_Screensaver<font color="#000080">;
   </font><font color="#FF0000"><b>End
    Else
     Begin
        </b></font><font color="#008000"><i>{ No! Start screensaver! }
        </i></font>Create_Bitmap<font color="#000080">;
        </font>Load_FLI_File<font color="#000080">;


        </font>Start_Screensaver <font color="#000080">:= </font>True<font color="#000080">;
        </font>Windowstate       <font color="#000080">:= </font>wsMaximized<font color="#000080">;
</font><font color="#008000"><i>{
        Formstyle         := fsStayOnTop;
}
        </i></font>Borderstyle       <font color="#000080">:= </font>bsNone<font color="#000080">;
        </font>Color             <font color="#000080">:= </font>clBlack<font color="#000080">;
        </font>MouseMovement     <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>FormMouseMove<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font>Shift<font color="#000080">: </font>TShiftState<font color="#000080">; </font>X<font color="#000080">, </font>Y <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Begin
   IF </b></font>MouseMovement <font color="#000080">&gt; </font><font color="#800000">2 </font><font color="#FF0000"><b>Then </b></font>Kill_FLI_Screensaver<font color="#000080">;
   </font>Inc<font color="#000080">(</font>MouseMovement<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>FormKeyDown<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Key<font color="#000080">: </font>Word<font color="#000080">; </font>Shift<font color="#000080">: </font>TShiftState<font color="#000080">);
</font><font color="#FF0000"><b>Begin
   </b></font>Kill_FLI_Screensaver<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>Show_Next_Frame<font color="#000080">;
</font><font color="#FF0000"><b>Type
  </b></font>Paltype <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Temp    <font color="#000080">: </font>Word<font color="#000080">;
  </font>Nextpos <font color="#000080">: </font>Longint<font color="#000080">;
  </font>Palette <font color="#000080">: ^</font>Paltype<font color="#000080">;
  </font>Paladdr <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TreatFrame<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Buffer<font color="#000080">, </font>ScreenBuffer<font color="#000080">, </font>Palette<font color="#000080">; </font>Chunks<font color="#000080">:</font>Word<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ this is the 'workhorse' routine that takes a frame and put it on the screen }
{ chunk by chunk }
</i></font><font color="#FF0000"><b>Label
  </b></font>Color_Loop<font color="#000080">, </font>Copy_Bytes<font color="#000080">, </font>Copy_Bytes2<font color="#000080">, </font>Exit<font color="#000080">, </font>Fli_Black<font color="#000080">, </font>Fli_Brun<font color="#000080">, </font>Fli_Color<font color="#000080">,
  </font>Fli_Copy<font color="#000080">, </font>Fli_Lc<font color="#000080">, </font>Fli_Loop<font color="#000080">, </font>Jump_Over<font color="#000080">, </font>Line_Loop<font color="#000080">, </font>Line_Loop2<font color="#000080">, </font>Next_Line<font color="#000080">,
  </font>Next_Line2<font color="#000080">, </font>Pack_Loop<font color="#000080">, </font>Pack_Loop2<font color="#000080">, </font>C_Loop<font color="#000080">;

</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">Cli

  push ds
  lds  si,Buffer                                 </font><font color="#008000"><i>{ let DS:SI point at the frame to be drawn }

</i></font><font color="#FF00FF">Fli_Loop:                                        </font><font color="#008000"><i>{ main loop that goes through all the chunks in a frame }
  </i></font><font color="#FF00FF">cmp  Chunks,0                                  </font><font color="#008000"><i>{ are there any more chunks to draw? }
  </i></font><font color="#FF00FF">je   Exit
  dec  Chunks                                    </font><font color="#008000"><i>{ decrement Chunks For the chunk to process now }

  </i></font><font color="#FF00FF">mov  ax,[Word ptr ds:si+4]                     </font><font color="#008000"><i>{ let AX have the ChunkType }
  </i></font><font color="#FF00FF">add  si,6                                      </font><font color="#008000"><i>{ skip the ChunkHeader }

  </i></font><font color="#FF00FF">cmp  ax,0Bh                                    </font><font color="#008000"><i>{ is it a FLI_COLor chunk? }
  </i></font><font color="#FF00FF">je   Fli_Color
  cmp  ax,0Ch                                    </font><font color="#008000"><i>{ is it a FLI_LC chunk? }
  </i></font><font color="#FF00FF">je   Fli_Lc
  cmp  ax,0Dh                                    </font><font color="#008000"><i>{ is it a FLI_BLACK chunk? }
  </i></font><font color="#FF00FF">je   Fli_Black
  cmp  ax,0Fh                                    </font><font color="#008000"><i>{ is it a FLI_BRUN chunk? }
  </i></font><font color="#FF00FF">je   Fli_Brun
  cmp  ax,10h                                    </font><font color="#008000"><i>{ is it a FLI_COPY chunk? }
  </i></font><font color="#FF00FF">je   Fli_Copy
  jmp  Fli_Loop                                  </font><font color="#008000"><i>{ This command should not be necessary since the Program should make one - }
                                                 { - of the other jumps }

</i></font><font color="#FF00FF">Fli_Color:
  mov  bx,[Word ptr ds:si]                       </font><font color="#008000"><i>{ number of packets in this chunk (allways 1?) }
  </i></font><font color="#FF00FF">add  si,2                                      </font><font color="#008000"><i>{ skip the NumberofPackets }
  </i></font><font color="#FF00FF">mov  al,0                                      </font><font color="#008000"><i>{ start at color 0 }
  </i></font><font color="#FF00FF">xor  cx,cx                                     </font><font color="#008000"><i>{ reset CX }

</i></font><font color="#FF00FF">Color_Loop:
  or   bx,bx                                     </font><font color="#008000"><i>{ set flags }
  </i></font><font color="#FF00FF">jz   Fli_Loop                                  </font><font color="#008000"><i>{ Exit if no more packages }
  </i></font><font color="#FF00FF">dec  bx                                        </font><font color="#008000"><i>{ decrement NumberofPackages For the package to process now }

  </i></font><font color="#FF00FF">mov  cl,[Byte ptr ds:si+0]                     </font><font color="#008000"><i>{ first Byte in packet tells how many colors to skip }
  </i></font><font color="#FF00FF">add  al,cl                                     </font><font color="#008000"><i>{ add the skiped colors to the start to get the new start }

  </i></font><font color="#FF00FF">mov  cl,[Byte ptr ds:si+1]                     </font><font color="#008000"><i>{ next Byte in packet tells how many colors to change }
  </i></font><font color="#FF00FF">or   cl,cl                                     </font><font color="#008000"><i>{ set the flags }
  </i></font><font color="#FF00FF">jnz  Jump_Over                                 </font><font color="#008000"><i>{ if NumberstoChange=0 then NumberstoChange=256 }
  </i></font><font color="#FF00FF">inc  ch                                        </font><font color="#008000"><i>{ CH=1 and CL=0 =&gt; CX=256 }
</i></font><font color="#FF00FF">Jump_Over:
  add  al,cl                                     </font><font color="#008000"><i>{ update the color to start at }
  </i></font><font color="#FF00FF">mov  di,cx                                     </font><font color="#008000"><i>{ since each color is made of 3 Bytes (Red, Green &amp; Blue) we have to - }
  </i></font><font color="#FF00FF">shl  cx,1                                      </font><font color="#008000"><i>{ - multiply CX (the data counter) With 3 }
  </i></font><font color="#FF00FF">add  cx,di                                     </font><font color="#008000"><i>{ - CX = old_CX shl 1 + old_CX   (the fastest way to multiply With 3) }
  </i></font><font color="#FF00FF">add  si,2                                      </font><font color="#008000"><i>{ skip the NumberstoSkip and NumberstoChange Bytes }


  { Find start position }
  </i></font><font color="#FF00FF">Les  di, Palette
  Mov  CL, AL
@LLL:
  Cmp  CL, 0
  Je   C_Loop
  Dec  CL
  Add  di, 3
  Jmp  @LLL

C_Loop:
  Cmp  CX, 0
  Je   Color_Loop
  Dec  CX
  Mov  AL, [Byte ptr DS:SI]
  Add  AL, AL
  Add  AL, AL
  Mov  [Byte ptr ES:DI], AL
  Inc  SI
  Inc  DI
  Jmp  C_Loop


Fli_Lc:
  Les  di, ScreenBuffer

  mov  di,[Word ptr ds:si+0]                     </font><font color="#008000"><i>{ put LinestoSkip into DI - }
  </i></font><font color="#FF00FF">mov  ax,di                                     </font><font color="#008000"><i>{ - to get the offset address to this line we have to multiply With 320 - }
  </i></font><font color="#FF00FF">shl  ax,8                                      </font><font color="#008000"><i>{ - DI = old_DI shl 8 + old_DI shl 6 - }
  </i></font><font color="#FF00FF">shl  di,6                                      </font><font color="#008000"><i>{ - it is the same as DI = old_DI*256 + old_DI*64 = old_DI*320 - }
  </i></font><font color="#FF00FF">add  di,ax                                     </font><font color="#008000"><i>{ - but this way is faster than a plain mul }
  </i></font><font color="#FF00FF">mov  bx,[Word ptr ds:si+2]                     </font><font color="#008000"><i>{ put LinestoChange into BX }
  </i></font><font color="#FF00FF">add  si,4                                      </font><font color="#008000"><i>{ skip the LinestoSkip and LinestoChange Words }
  </i></font><font color="#FF00FF">xor  cx,cx                                     </font><font color="#008000"><i>{ reset cx }

</i></font><font color="#FF00FF">Line_Loop:
  or   bx,bx                                     </font><font color="#008000"><i>{ set flags }
  </i></font><font color="#FF00FF">jz  Fli_Loop                                   </font><font color="#008000"><i>{ Exit if no more lines to change }
  </i></font><font color="#FF00FF">dec  bx

  mov  dl,[Byte ptr ds:si]                       </font><font color="#008000"><i>{ put PacketsInLine into DL }
  </i></font><font color="#FF00FF">inc  si                                        </font><font color="#008000"><i>{ skip the PacketsInLine Byte }
  </i></font><font color="#FF00FF">push di                                        </font><font color="#008000"><i>{ save the offset address of this line }

</i></font><font color="#FF00FF">Pack_Loop:
  or   dl,dl                                     </font><font color="#008000"><i>{ set flags }
  </i></font><font color="#FF00FF">jz   Next_Line                                 </font><font color="#008000"><i>{ Exit if no more packets in this line }
  </i></font><font color="#FF00FF">dec  dl
  mov  cl,[Byte ptr ds:si+0]                     </font><font color="#008000"><i>{ put BytestoSkip into CL }
  </i></font><font color="#FF00FF">add  di,cx                                     </font><font color="#008000"><i>{ update the offset address }
  </i></font><font color="#FF00FF">mov  cl,[Byte ptr ds:si+1]                     </font><font color="#008000"><i>{ put BytesofDatatoCome into CL }
  </i></font><font color="#FF00FF">or   cl,cl                                     </font><font color="#008000"><i>{ set flags }
  </i></font><font color="#FF00FF">jns  Copy_Bytes                                </font><font color="#008000"><i>{ no SIGN means that CL number of data is to come - }
                                                 { - else the next data should be put -CL number of times }
  </i></font><font color="#FF00FF">mov  al,[Byte ptr ds:si+2]                     </font><font color="#008000"><i>{ put the Byte to be Repeated into AL }
  </i></font><font color="#FF00FF">add  si,3                                      </font><font color="#008000"><i>{ skip the packet }
  </i></font><font color="#FF00FF">neg  cl                                        </font><font color="#008000"><i>{ Repeat -CL times }
  </i></font><font color="#FF00FF">rep  stosb
  jmp  Pack_Loop                                 </font><font color="#008000"><i>{ finish With this packet }

</i></font><font color="#FF00FF">Copy_Bytes:
  add  si,2                                      </font><font color="#008000"><i>{ skip the two count Bytes at the start of the packet }
  </i></font><font color="#FF00FF">rep  movsb
  jmp  Pack_Loop                                 </font><font color="#008000"><i>{ finish With this packet }

</i></font><font color="#FF00FF">Next_Line:
  pop  di                                        </font><font color="#008000"><i>{ restore the old offset address of the current line }
  </i></font><font color="#FF00FF">add  di,320                                    </font><font color="#008000"><i>{ offset address to the next line }
  </i></font><font color="#FF00FF">jmp  Line_Loop


Fli_Black:
  Les  di, ScreenBuffer

  xor  di,di
  mov  cx,32000                                  </font><font color="#008000"><i>{ number of Words in a screen }
  </i></font><font color="#FF00FF">xor  ax,ax                                     </font><font color="#008000"><i>{ color 0 is to be put on the screen }
  </i></font><font color="#FF00FF">rep  stosw
  jmp  Fli_Loop                                  </font><font color="#008000"><i>{ jump back to main loop }


</i></font><font color="#FF00FF">Fli_Brun:
  Les  di, ScreenBuffer

  xor  di,di
  mov  bx,200                                    </font><font color="#008000"><i>{ numbers of lines in a screen }
  </i></font><font color="#FF00FF">xor  cx,cx

Line_Loop2:
  mov  dl,[Byte ptr ds:si]                       </font><font color="#008000"><i>{ put PacketsInLine into DL }
  </i></font><font color="#FF00FF">inc  si                                        </font><font color="#008000"><i>{ skip the PacketsInLine Byte }
  </i></font><font color="#FF00FF">push di                                        </font><font color="#008000"><i>{ save the offset address of this line }

</i></font><font color="#FF00FF">Pack_Loop2:
  or   dl,dl                                     </font><font color="#008000"><i>{ set flags }
  </i></font><font color="#FF00FF">jz   Next_Line2                                </font><font color="#008000"><i>{ Exit if no more packets in this line }
  </i></font><font color="#FF00FF">dec  dl
  mov  cl,[Byte ptr ds:si]                       </font><font color="#008000"><i>{ put BytesofDatatoCome into CL }
  </i></font><font color="#FF00FF">or   cl,cl                                     </font><font color="#008000"><i>{ set flags }
  </i></font><font color="#FF00FF">js   Copy_Bytes2                               </font><font color="#008000"><i>{ SIGN meens that CL number of data is to come - }
                                                 { - else the next data should be put -CL number of times }
  </i></font><font color="#FF00FF">mov  al,[Byte ptr ds:si+1]                     </font><font color="#008000"><i>{ put the Byte to be Repeated into AL }
  </i></font><font color="#FF00FF">add  si,2                                      </font><font color="#008000"><i>{ skip the packet }
  </i></font><font color="#FF00FF">rep  stosb
  jmp  Pack_Loop2                                </font><font color="#008000"><i>{ finish With this packet }

</i></font><font color="#FF00FF">Copy_Bytes2:
  inc  si                                        </font><font color="#008000"><i>{ skip the count Byte at the start of the packet }
  </i></font><font color="#FF00FF">neg  cl                                        </font><font color="#008000"><i>{ Repeat -CL times }
  </i></font><font color="#FF00FF">rep  movsb
  jmp  Pack_Loop2                                </font><font color="#008000"><i>{ finish With this packet }

</i></font><font color="#FF00FF">Next_Line2:
  pop  di                                        </font><font color="#008000"><i>{ restore the old offset address of the current line }
  </i></font><font color="#FF00FF">add  di,320                                    </font><font color="#008000"><i>{ offset address to the next line }
  </i></font><font color="#FF00FF">dec  bx                                        </font><font color="#008000"><i>{ any more lines to draw? }
  </i></font><font color="#FF00FF">jnz  Line_Loop2
  jmp  Fli_Loop                                  </font><font color="#008000"><i>{ jump back to main loop }


</i></font><font color="#FF00FF">Fli_Copy:
  Les  di, ScreenBuffer

  xor  di,di
  mov  cx,32000                                  </font><font color="#008000"><i>{ number of Words in a screen }
  </i></font><font color="#FF00FF">rep  movsw
  jmp  Fli_Loop                                  </font><font color="#008000"><i>{ jump back to main loop }


</i></font><font color="#FF00FF">Exit:
  mov  ax, 0
  mov  es, ax
  pop  ds

  Sti
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ReadPalette<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>T<font color="#000080">, </font>Zero <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>FLIScreenstream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">54</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
   </font><font color="#FF0000"><b>For </b></font>T <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
   Begin
      </b></font>FLIScreenStream<font color="#000080">.</font>Read<font color="#000080">(</font>Palette<font color="#000080">^[</font>T<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{ Blue }
      </i></font>FLIScreenStream<font color="#000080">.</font>Read<font color="#000080">(</font>Palette<font color="#000080">^[</font>T<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">], </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{ Green }
      </i></font>FLIScreenStream<font color="#000080">.</font>Read<font color="#000080">(</font>Palette<font color="#000080">^[</font>T<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">], </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{ Red }
      </i></font>FLIScreenStream<font color="#000080">.</font>Read<font color="#000080">(</font>Zero<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);         </font><font color="#008000"><i>{ Zero }
   </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>WritePalette<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>T<font color="#000080">, </font>Zero <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>Zero <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

   </font>FLIScreenStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">54</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
   </font><font color="#FF0000"><b>For </b></font>T <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">255 </font><font color="#FF0000"><b>do
   Begin
      </b></font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>Palette<font color="#000080">^[</font>T<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{ Blue }
      </i></font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>Palette<font color="#000080">^[</font>T<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">], </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{ Green }
      </i></font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>Palette<font color="#000080">^[</font>T<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">], </font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{ Red }
      </i></font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>Zero<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);         </font><font color="#008000"><i>{ Zero }
   </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Write_To_Screen<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Y <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin
   </b></font>FLIScreenStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">1078</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

   </font><font color="#FF0000"><b>For </b></font>Y <font color="#000080">:= </font><font color="#800000">199 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
   Begin
      </b></font>FLIScreenStream<font color="#000080">.</font>Write<font color="#000080">(</font>Screen_Buffer<font color="#000080">^[</font>Y<font color="#000080">*</font><font color="#800000">320</font><font color="#000080">], </font><font color="#800000">320</font><font color="#000080">);
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Begin
   IF </b></font>GetClock <font color="#000080">&lt; </font>FLI_Nexttime <font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;


   </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>FliFileStream<font color="#000080">.</font>Size <font color="#000080">&gt; </font><font color="#800000">128</font><font color="#000080">) </font><font color="#FF0000"><b>Then
   Begin
      </b></font>FillChar<font color="#000080">(</font>FLI_FrameHeader<font color="#000080">, </font><font color="#800000">16</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
      </font>FliFileStream<font color="#000080">.</font>Read<font color="#000080">(</font>FLI_FrameHeader<font color="#000080">.</font>Size<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
      </font>FliFileStream<font color="#000080">.</font>Read<font color="#000080">(</font>FLI_FrameHeader<font color="#000080">.</font>Magic<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
      </font>FliFileStream<font color="#000080">.</font>Read<font color="#000080">(</font>FLI_FrameHeader<font color="#000080">.</font>Chunks<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
      </font>FliFileStream<font color="#000080">.</font>Read<font color="#000080">(</font>FLI_FrameHeader<font color="#000080">.</font>Expand<font color="#000080">, </font><font color="#800000">8</font><font color="#000080">);

      </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>FLI_FrameHeader<font color="#000080">.</font>Magic <font color="#000080">= </font><font color="#800000">$F1FA</font><font color="#000080">) </font><font color="#FF0000"><b>Then
      Begin
         </b></font>FLI_FrameHeader<font color="#000080">.</font>Size <font color="#000080">:= </font>FLI_FrameHeader<font color="#000080">.</font>Size <font color="#000080">- </font><font color="#800000">16</font><font color="#000080">;
         </font>FliFileStream<font color="#000080">.</font>Read<font color="#000080">(</font>File_Buffer<font color="#000080">^, </font>FLI_FrameHeader<font color="#000080">.</font>Size<font color="#000080">);

         </font>Getmem<font color="#000080">(</font>Palette<font color="#000080">, </font><font color="#800000">768</font><font color="#000080">);
         </font>Paladdr <font color="#000080">:= </font>Seg<font color="#000080">(</font>Palette<font color="#000080">^);
         </font>ReadPalette<font color="#000080">;
         </font>TreatFrame<font color="#000080">(</font>File_Buffer<font color="#000080">^, </font>Screen_Buffer<font color="#000080">^, </font>Palette<font color="#000080">^, </font>FLI_FrameHeader<font color="#000080">.</font>Chunks<font color="#000080">);
         </font>WritePalette<font color="#000080">;
         </font>Freemem<font color="#000080">(</font>Palette<font color="#000080">, </font><font color="#800000">768</font><font color="#000080">);

         </font>Write_To_Screen<font color="#000080">;


         </font><font color="#FF0000"><b>IF </b></font>FLI_FrameNr <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>Then
         Begin
            </b></font>FLI_SecondPosition <font color="#000080">:= </font>FliFileStream<font color="#000080">.</font>Position<font color="#000080">;
         </font><font color="#FF0000"><b>End</b></font><font color="#000080">;


         </font>Inc<font color="#000080">(</font>Fli_FrameNr<font color="#000080">);
         </font><font color="#FF0000"><b>IF </b></font>Fli_FrameNr <font color="#000080">&gt; </font>FLI_Header<font color="#000080">.</font>Frames <font color="#FF0000"><b>Then
         Begin
            </b></font>FliFileStream<font color="#000080">.</font>Seek<font color="#000080">(</font>FLI_SecondPosition<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
            </font>Fli_FrameNr <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
         </font><font color="#FF0000"><b>End</b></font><font color="#000080">;


         </font>FLI_NextTime <font color="#000080">:= </font>GetClock <font color="#000080">+ </font>FLI_Speed<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>TForm1<font color="#000080">.</font>FormPaint<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>Begin
   IF not </b></font>Start_Screensaver <font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
   </font>Start_Screensaver <font color="#000080">:= </font>False<font color="#000080">;

   </font><font color="#FF0000"><b>While </b></font>True <font color="#FF0000"><b>do
   Begin
      </b></font>Show_Next_Frame<font color="#000080">;


      </font>FLIScreenStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>Try
        </b></font>ScreenBitmap<font color="#000080">.</font>LoadFromStream<font color="#000080">(</font>FLIScreenStream<font color="#000080">);
      </font><font color="#FF0000"><b>Except
      End</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>IF not </b></font>Scale_FLI <font color="#FF0000"><b>Then </b></font>Canvas<font color="#000080">.</font>Draw<font color="#000080">((</font>Screen<font color="#000080">.</font>Width <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">) - </font><font color="#800000">160</font><font color="#000080">, (</font>Screen<font color="#000080">.</font>Height <font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">) - </font><font color="#800000">100</font><font color="#000080">, </font>ScreenBitmap<font color="#000080">)
         </font><font color="#FF0000"><b>Else </b></font>Canvas<font color="#000080">.</font>StretchDraw<font color="#000080">(</font>ClientRect<font color="#000080">, </font>ScreenBitmap<font color="#000080">);

      </font>Application<font color="#000080">.</font>ProcessMessages<font color="#000080">;
   </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font><font color="#008000"><i>{ -------------  Cut out and save as UNIT1.DFM ----------------- }

</i></font><font color="#FF0000"><b>object </b></font>Form1<font color="#000080">: </font>TForm1
  Left <font color="#000080">= </font><font color="#800000">216
  </font>Top <font color="#000080">= </font><font color="#800000">168
  </font>Width <font color="#000080">= </font><font color="#800000">435
  </font>Height <font color="#000080">= </font><font color="#800000">300
  </font>Caption <font color="#000080">= </font><font color="#800000">'Form1'
  </font>Font<font color="#000080">.</font>Color <font color="#000080">= </font>clWindowText
  Font<font color="#000080">.</font>Height <font color="#000080">= -</font><font color="#800000">13
  </font>Font<font color="#000080">.</font>Name <font color="#000080">= </font><font color="#800000">'System'
  </font>Font<font color="#000080">.</font>Style <font color="#000080">= []
  </font>PixelsPerInch <font color="#000080">= </font><font color="#800000">96
  </font>OnCreate <font color="#000080">= </font>FormCreate
  OnKeyDown <font color="#000080">= </font>FormKeyDown
  OnMouseMove <font color="#000080">= </font>FormMouseMove
  OnPaint <font color="#000080">= </font>FormPaint
  TextHeight <font color="#000080">= </font><font color="#800000">16
  </font><font color="#FF0000"><b>object </b></font>OpenDialog1<font color="#000080">: </font>TOpenDialog
    Left <font color="#000080">= </font><font color="#800000">4
    </font>Top <font color="#000080">= </font><font color="#800000">4
  </font><font color="#FF0000"><b>end
end
</b></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0236.PAS">Original</a><b>]</b></p></body>
</html>
