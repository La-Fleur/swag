<html>
<head><title> "Byte Swapping" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0310.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">Some time ago I had <font color="#FF0000"><b>to </b></font>write some data marshalling tools<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>I had <font color="#FF0000"><b>to
</b></font>perform byte swapping <font color="#FF0000"><b>in </b></font>both Delphi <font color="#FF0000"><b>and </b></font>C<font color="#000080">++  (</font>we had <font color="#FF0000"><b>to </b></font>talk <font color="#FF0000"><b>to </b></font>a Sun
box<font color="#000080">). </font>Here <font color="#FF0000"><b>is </b></font>the code that will perform byte swapping <font color="#FF0000"><b>on </b></font>any <font color="#FF0000"><b>type </b></font><font color="#000080">(</font>single<font color="#000080">,
</font>double<font color="#000080">, </font>extended<font color="#000080">, </font>etc<font color="#000080">)

</font><font color="#FF0000"><b>procedure </b></font>PerformByteSwapping<font color="#000080">(</font>DataPtr <font color="#000080">: </font>Pointer<font color="#000080">;</font>NoBytes <font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>integer<font color="#000080">;
  </font>dp <font color="#000080">: </font>PChar<font color="#000080">;
  </font>tmp <font color="#000080">: </font>char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>// Perform a sanity check to make sure that the function was called
</i></font>properly
  <font color="#FF0000"><b>if </b></font><font color="#000080">(</font>NoBytes <font color="#000080">&gt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>Dec<font color="#000080">(</font>NoBytes<font color="#000080">);
    </font>dp <font color="#000080">:= </font>PChar<font color="#000080">(</font>DataPtr<font color="#000080">);
    </font><font color="#008000"><i>// we are now safe to perform the byte swapping
    </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font>NoBytes <font color="#FF0000"><b>downto </b></font><font color="#000080">(</font>NoBytes <font color="#FF0000"><b>div </b></font><font color="#800000">2 </font><font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>do
    begin
      </b></font>tmp <font color="#000080">:= </font>Pchar<font color="#000080">(</font>Integer<font color="#000080">(</font>dp<font color="#000080">)+</font>i<font color="#000080">)^;
      </font>Pchar<font color="#000080">(</font>Integer<font color="#000080">(</font>dp<font color="#000080">)+</font>i<font color="#000080">)^ := </font>Pchar<font color="#000080">(</font>Integer<font color="#000080">(</font>dp<font color="#000080">)+</font>NoBytes<font color="#000080">-</font>i<font color="#000080">)^;
      </font>Pchar<font color="#000080">(</font>Integer<font color="#000080">(</font>dp<font color="#000080">)+</font>NoBytes<font color="#000080">-</font>i<font color="#000080">)^ := </font>tmp<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>The way <font color="#FF0000"><b>to </b></font>use this <font color="#FF0000"><b>function is as </b></font>follows<font color="#000080">::
</font>j <font color="#000080">: </font>integer<font color="#000080">;
</font>x <font color="#000080">: </font>double<font color="#000080">;
</font>y <font color="#000080">: </font>extended<font color="#000080">;

</font>PerformByteSwapping<font color="#000080">(@</font>i<font color="#000080">,</font>SizeOf<font color="#000080">(</font>i<font color="#000080">)); </font><font color="#008000"><i>//to swap an integer
</i></font>PerformByteSwapping<font color="#000080">(@</font>x<font color="#000080">,</font>SizeOf<font color="#000080">(</font>x<font color="#000080">)); </font><font color="#008000"><i>//to swap a double
</i></font>PerformByteSwapping<font color="#000080">(@</font>y<font color="#000080">,</font>SizeOf<font color="#000080">(</font>y<font color="#000080">)); </font><font color="#008000"><i>//to swap an extended.
</i></font>The <font color="#FF0000"><b>function </b></font>works very well<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>has been tested thoroughly<font color="#000080">.

</font><font color="#FF0000"><b>On </b></font>the C side I could follow a more elegant approach <font color="#000080">- </font>such <font color="#FF0000"><b>as </b></font>this<font color="#000080">::
</font><font color="#008000"><i>//first define a macro that will enable easy usage ::
</i></font><font color="#800000">#</font>define SwapBytes<font color="#000080">(</font>x<font color="#000080">) </font>PerformByteSwapping<font color="#000080">((</font>char <font color="#000080">*)&amp;(</font>x<font color="#000080">),</font>sizeof<font color="#000080">((</font>x<font color="#000080">)))

</font>int PerformByteSwapping<font color="#000080">(</font>char <font color="#000080">*</font>DataPtr<font color="#000080">, </font>int NumBytes<font color="#000080">)
</font><font color="#008000"><i>{
  char tmp;
  char *OtherEnd;

  /* Perform a sanity check to make sure that the function was called
properly*/
  if ((NumBytes &lt;= 1) || !DataPtr)
        return(0);
        OtherEnd = &amp;DataPtr[NumBytes-1];
  do
  {
    tmp = *DataPtr;
    *DataPtr++ = *OtherEnd;
    *OtherEnd-- = tmp;
  } </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>DataPtr <font color="#000080">&lt; </font>OtherEnd<font color="#000080">);
  </font>return<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
}

</font><font color="#008000"><i>//the macro makes things easier ... eg
</i></font>int i<font color="#000080">;
</font>double x<font color="#000080">;
</font>SwapBytes<font color="#000080">(</font>i<font color="#000080">); </font><font color="#008000"><i>//with macro substitution things are easier to code and
</i></font>become more readable
SwapBytes<font color="#000080">(</font>x<font color="#000080">);

</font>P<font color="#000080">.</font>S<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>anyone  gets this <font color="#FF0000"><b>message </b></font>please acknowledge<font color="#000080">, </font><font color="#FF0000"><b>as </b></font>my messages did
<font color="#FF0000"><b>not </b></font>make it <font color="#FF0000"><b>to </b></font>the list lately<font color="#000080">.
</font>I hope this helps<font color="#000080">. </font>Cheers<font color="#000080">.

</font>teo<font color="#000080">@</font>partnership<font color="#000080">-</font>group<font color="#000080">.</font>com<font color="#000080">.</font>au

</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0310.PAS">Original</a><b>]</b></p></body>
</html>
