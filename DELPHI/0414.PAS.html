<html>
<head><title> "Shutting down a Delphi app" by WES JONES</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0414.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">Performing an action when Windows shuts down a Delphi app
From<font color="#000080">: </font>wesjones<font color="#000080">@</font>hooked<font color="#000080">.</font>net <font color="#000080">(</font>Wes Jones<font color="#000080">)

</font>I did a little investigation<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>here <font color="#FF0000"><b>is </b></font>what seems <font color="#FF0000"><b>to </b></font>be happening<font color="#000080">:

</font>Normally<font color="#000080">, </font>when you exit a Delphi application by using the system menu <font color="#FF0000"><b>or </b></font>by calling the Form<font color="#800000">'s Close method, the following event handlers are called:

</font>FormCloseQuery <font color="#000080">- </font>the <font color="#FF0000"><b>default </b></font>action sets the variable CanClose<font color="#000080">=</font>TRUE so form close will continue<font color="#000080">. 
</font>FormClose 
FormDestroy 
<font color="#FF0000"><b>If </b></font>the application <font color="#FF0000"><b>is </b></font>active <font color="#FF0000"><b>and </b></font>you attempt <font color="#FF0000"><b>to </b></font>exit Windows<font color="#000080">, </font>the event handlers are called <font color="#FF0000"><b>in </b></font>the following sequence<font color="#000080">:

</font>FormCloseQuery 
FormDestroy 
The FormClose method never seems <font color="#FF0000"><b>to </b></font>be called<font color="#000080">.

</font>Here <font color="#FF0000"><b>is </b></font>the flow <font color="#FF0000"><b>of </b></font>events when the user chooses <font color="#FF0000"><b>to end </b></font>the Windows session<font color="#000080">:

</font>Windows sends <font color="#FF0000"><b>out </b></font>a WM_QUERYENDSESSION <font color="#FF0000"><b>message to </b></font>all application windows one by one <font color="#FF0000"><b>and </b></font>awaits a response 
Each application window receives the <font color="#FF0000"><b>message and </b></font>returns a non<font color="#000080">-</font>zero value <font color="#FF0000"><b>if </b></font>it <font color="#FF0000"><b>is </b></font>OK <font color="#FF0000"><b>to </b></font>terminate<font color="#000080">, </font><font color="#FF0000"><b>or </b></font><font color="#800000">0 </font><font color="#FF0000"><b>if </b></font>it <font color="#FF0000"><b>is not </b></font>OK <font color="#FF0000"><b>to </b></font>terminate<font color="#000080">. 
</font><font color="#FF0000"><b>If </b></font>any application returns <font color="#800000">0</font><font color="#000080">, </font>the Windows session <font color="#FF0000"><b>is not </b></font>ended<font color="#000080">, </font>otherwise<font color="#000080">, </font>Windows sends a WM_ENDSESSION <font color="#FF0000"><b>message to </b></font>all application windows 
Each Application Window responds <font color="#FF0000"><b>with </b></font>a TRUE value indicating that Windows can terminate any time after all applications have returned from processing this <font color="#FF0000"><b>message</b></font><font color="#000080">. </font>This appears <font color="#FF0000"><b>to </b></font>be the location <font color="#FF0000"><b>of </b></font>the Delphi problem<font color="#000080">: </font>Delphi applications seem <font color="#FF0000"><b>to </b></font>return TRUE <font color="#FF0000"><b>and </b></font>the FormDestroy method <font color="#FF0000"><b>is </b></font>called immediately<font color="#000080">, </font>bypassing the FormClose method<font color="#000080">. 
</font>Windows exits 
One solution <font color="#FF0000"><b>is to </b></font>respond <font color="#FF0000"><b>to </b></font>the WM_QUERYENDSESSION <font color="#FF0000"><b>message in </b></font>the Delphi application <font color="#FF0000"><b>and </b></font>prevent Windows from exiting by returning a <font color="#800000">0 </font>result<font color="#000080">. </font>This can<font color="#800000">'t be done in the FormCloseQuery method because there is no way to determine the source of the request (it can either be the result of the WM_QUERYENDSESSION message or the user just simply closing the application). 

</font>Another solution <font color="#FF0000"><b>is to </b></font>respond <font color="#FF0000"><b>to </b></font>the WM_QUERYENDSESSION <font color="#FF0000"><b>message </b></font>by calling the same cleanup <font color="#FF0000"><b>procedure </b></font>you call <font color="#FF0000"><b>in </b></font>the FormClose method<font color="#000080">.

</font>Example<font color="#000080">:


--------------------------------------------------------------------------------

</font><font color="#FF0000"><b>unit </b></font>Unit1<font color="#000080">;
</font><font color="#FF0000"><b>interface
uses
  </b></font>SysUtils<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Messages<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">, </font>Controls<font color="#000080">, </font>Forms<font color="#000080">,
</font>Dialogs<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>TForm1 <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
    </font><font color="#FF0000"><b>procedure </b></font>FormClose<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Action<font color="#000080">: </font>TCloseAction<font color="#000080">);
  </font><font color="#FF0000"><b>private
  </b></font><font color="#008000"><i>{---------------------------------------------------------------}
  { Custom procedure to respond to the WM_QUERYENDSESSION message }
  {---------------------------------------------------------------}
  </i></font><font color="#FF0000"><b>procedure </b></font>WMQueryEndSession<font color="#000080">(
             </font><font color="#FF0000"><b>var Message</b></font><font color="#000080">: </font>TWMQueryEndSession<font color="#000080">); </font><font color="#FF0000"><b>message </b></font>WM_QUERYENDSESSION<font color="#000080">;
  </font><font color="#FF0000"><b>public
    </b></font><font color="#008000"><i>{ Public declarations }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Form1    <font color="#000080">: </font>TForm1<font color="#000080">;

</font><font color="#FF0000"><b>implementation
</b></font><font color="#008000"><i>{$R *.DFM}

{---------------------------------------------------------------}
{ Custom procedure to respond to the WM_QUERYENDSESSION message }
{ The application will only receive this message in the event   }
{ that Windows is requesing to exit.                            }
{---------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>WMQueryEndSession<font color="#000080">(</font><font color="#FF0000"><b>var Message</b></font><font color="#000080">: </font>TWMQueryEndSession<font color="#000080">);
</font><font color="#FF0000"><b>begin
  inherited</b></font><font color="#000080">;         </font><font color="#008000"><i>{ let the inherited message handler respond first }
  {--------------------------------------------------------------------}
  { at this point, you can either prevent windows from closing...      }
  { Message.Result:=0;                                                 }
  {---------------------------or---------------------------------------}
  { just call the same cleanup procedure that you call in FormClose... }
  { MyCleanUpProcedure;                                                }
  {--------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>FormClose<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Action<font color="#000080">: </font>TCloseAction<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>MyCleanUpProcedure<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0414.PAS">Original</a><b>]</b></p></body>
</html>
