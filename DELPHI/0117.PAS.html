<html>
<head><title> "Dynamically Allocating Arrays" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0117.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
Dynamic Arrays

Is it possible to create a dynamically-sized array in Delphi?

Yes.  First, you need to create an array type using the largest
size you might possibly need.  When creating a type, no memory
is actually allocated.  If you created a variable of that type,
then the compiler will attempt to allocate the necessary memory
for you.  Instead, create a variable which is a pointer to that
type.  This causes the compiler to only allocate the four bytes
needed for the pointer.

Before you can use the array, you need to allocate memory for
it.  By using AllocMem, you will be able to control exactly how
many bytes are allocated.  To determine the number of bytes
you'll need to allocate, simply multiply the array size you
want by the size of the individual array element.  Keep in mind
that the largest block that can be allocated at one time in a
16-bit environment is 64KB.  The largest block that can be
allocated at one time in a 32-bit environment is 4GB.  To
determine the maximum number of elements you can have in your
particular array (in a 16-bit environment), divide 65,520 by
the size of the individual element.
Example:  65520 div SizeOf(LongInt)

Example of declaring an array type and pointer:
}
</i></font><font color="#FF0000"><b>type
  </b></font>ElementType <font color="#000080">= </font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>MaxArraySize <font color="#000080">= (</font><font color="#800000">65520 </font><font color="#FF0000"><b>div </b></font>SizeOf<font color="#000080">(</font>ElementType<font color="#000080">));
    </font><font color="#008000"><i>(* under a 16-bit environment *)

</i></font><font color="#FF0000"><b>type
  </b></font>MyArrayType <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>MaxArraySize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>ElementType<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>P<font color="#000080">: ^</font>MyArrayType<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>ArraySizeIWant<font color="#000080">: </font>Integer <font color="#000080">= </font><font color="#800000">1500</font><font color="#000080">;

</font><font color="#FF0000"><b>Then </b></font>when you wish <font color="#FF0000"><b>to </b></font>allocate memory <font color="#FF0000"><b>for </b></font>the <font color="#FF0000"><b>array</b></font><font color="#000080">, </font>you could
use the following <font color="#FF0000"><b>procedure</b></font><font color="#000080">:

</font><font color="#FF0000"><b>procedure </b></font>AllocateArray<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>ArraySizeIWant <font color="#000080">&lt;= </font>MaxArraySize <font color="#FF0000"><b>then
    </b></font>P <font color="#000080">:= </font>AllocMem<font color="#000080">(</font>ArraySizeIWant <font color="#000080">* </font>SizeOf<font color="#000080">(</font>LongInt<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>Remember <font color="#FF0000"><b>to </b></font>make sure that the value <font color="#FF0000"><b>of </b></font>ArraySizeIWant <font color="#FF0000"><b>is </b></font>less
than <font color="#FF0000"><b>or </b></font>equal <font color="#FF0000"><b>to </b></font>MaxArraySize<font color="#000080">.

</font>Here <font color="#FF0000"><b>is </b></font>a <font color="#FF0000"><b>procedure </b></font>that will loop through the <font color="#FF0000"><b>array and set </b></font>a
value <font color="#FF0000"><b>for </b></font>each member<font color="#000080">:

</font><font color="#FF0000"><b>procedure </b></font>AssignValues<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>ArraySizeIWant <font color="#FF0000"><b>do
    </b></font>P<font color="#000080">^[</font>I<font color="#000080">] := </font>I<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>Keep <font color="#FF0000"><b>in </b></font>mind that you must <font color="#FF0000"><b>do </b></font>your own range checking<font color="#000080">.  </font><font color="#FF0000"><b>If </b></font>you
have allocated an <font color="#FF0000"><b>array with </b></font>five members <font color="#FF0000"><b>and </b></font>you <font color="#FF0000"><b>try to </b></font>assign
a value <font color="#FF0000"><b>to </b></font>the sixth member <font color="#FF0000"><b>of </b></font>the <font color="#FF0000"><b>array</b></font><font color="#000080">, </font>you will <font color="#FF0000"><b>not </b></font>receive
an error <font color="#FF0000"><b>message</b></font><font color="#000080">.  </font>However<font color="#000080">, </font>you will get memory corruption<font color="#000080">.

</font>Remember that you must always free up any memory that you
allocate<font color="#000080">.  </font>Here <font color="#FF0000"><b>is </b></font>an example <font color="#FF0000"><b>of </b></font>how <font color="#FF0000"><b>to </b></font>dispose <font color="#FF0000"><b>of </b></font>this <font color="#FF0000"><b>array</b></font><font color="#000080">:

</font><font color="#FF0000"><b>procedure </b></font>DeallocateArray<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>P <font color="#000080">:= </font>AllocMem<font color="#000080">(</font>ArraySizeIWant <font color="#000080">* </font>SizeOf<font color="#000080">(</font>LongInt<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>Below <font color="#FF0000"><b>is </b></font>an example <font color="#FF0000"><b>of </b></font>a <font color="#FF0000"><b>dynamic array</b></font><font color="#000080">:

}

</font><font color="#FF0000"><b>unit </b></font>Unit1<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
  </b></font>SysUtils<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Messages<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">,
  </font>Controls<font color="#000080">, </font>Forms<font color="#000080">, </font>Dialogs<font color="#000080">, </font>StdCtrls<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>ElementType <font color="#000080">= </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>MaxArraySize <font color="#000080">= (</font><font color="#800000">65520 </font><font color="#FF0000"><b>div </b></font>SizeOf<font color="#000080">(</font>ElementType<font color="#000080">));
    </font><font color="#008000"><i>{ in a 16-bit environment }

</i></font><font color="#FF0000"><b>type
  </b></font><font color="#008000"><i>{ Create the array type.  Make sure that you set the range to
    be the largest number you would possibly need. }
  </i></font>TDynamicArray <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>MaxArraySize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>ElementType<font color="#000080">;
  </font>TForm1 <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
    </font>Button1<font color="#000080">: </font>TButton<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Button1Click<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>FormDestroy<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
  </font><font color="#FF0000"><b>private
    </b></font><font color="#008000"><i>{ Private declarations }
  </i></font><font color="#FF0000"><b>public
    </b></font><font color="#008000"><i>{ Public declarations }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Form1<font color="#000080">: </font>TForm1<font color="#000080">;
  </font><font color="#008000"><i>{ Create a variable of type pointer to your array type. }
  </i></font>P<font color="#000080">: ^</font>TDynamicArray<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font><font color="#008000"><i>{ This is a typed constant.  They are actually static
    variables hat are initialized at runtime to the value taken
    from the source code.  This means that you can use a typed
    constant just like you would use any other variable.  Plus
    you get the added bonus of being able to automatically
    initialize it's value. }
  </i></font>DynamicArraySizeNeeded<font color="#000080">: </font>Integer <font color="#000080">= </font><font color="#800000">10</font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

</b></font><font color="#008000"><i>{$R *.DFM}

</i></font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Allocate memory for your array.  Be very careful that you
    allocate the amount that you need.  If you try to write
    beyond the amount that you've allocated, the compiler will
    let you do it.  You'll just get data corruption. }
  </i></font>DynamicArraySizeNeeded <font color="#000080">:= </font><font color="#800000">500</font><font color="#000080">;
  </font>P <font color="#000080">:= </font>AllocMem<font color="#000080">(</font>DynamicArraySizeNeeded <font color="#000080">* </font>SizeOf<font color="#000080">(</font>Integer<font color="#000080">));
  </font><font color="#008000"><i>{ How to assign a value to the fifth member of the array. }
  </i></font>P<font color="#000080">^[</font><font color="#800000">5</font><font color="#000080">] := </font><font color="#800000">68</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>Button1Click<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Displaying the data. }
  </i></font>Button1<font color="#000080">.</font>Caption <font color="#000080">:= </font>IntToStr<font color="#000080">(</font>P<font color="#000080">^[</font><font color="#800000">5</font><font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>FormDestroy<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Free the memory you allocated for the array. }
  </i></font>FreeMem<font color="#000080">(</font>P<font color="#000080">, </font>DynamicArraySizeNeeded <font color="#000080">* </font>SizeOf<font color="#000080">(</font>Integer<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0117.PAS">Original</a><b>]</b></p></body>
</html>
