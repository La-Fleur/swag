<html>
<head><title> "Canvas from THandle (for metafiles)" by RENE POST</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0037.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000080">&gt;</font>I need <font color="#FF0000"><b>to </b></font>draw <font color="#FF0000"><b>to </b></font>a Windows metafile<font color="#000080">. </font>Delphi does <font color="#FF0000"><b>not </b></font>directly support this<font color="#000080">,
&gt;</font>so I plan <font color="#FF0000"><b>to </b></font>use API calls <font color="#FF0000"><b>to </b></font>create the metafile<font color="#000080">. </font>Creating a Metafile returns
<font color="#000080">&gt;</font>a THandle which can be cast <font color="#FF0000"><b>to </b></font>a DC<font color="#000080">.
&gt;
&gt;</font><font color="#FF0000"><b>In </b></font>delphi<font color="#000080">, </font>how can I use the THandle <font color="#FF0000"><b>to </b></font>get<font color="#000080">/</font>create a Canvas <font color="#FF0000"><b>for </b></font>drawing<font color="#000080">?

</font>I<font color="#800000">'ve asked a similar question a few days ago but got no response, so
</font>I figured it <font color="#FF0000"><b>out </b></font>myself<font color="#000080">. </font>Here<font color="#800000">'s the code. (hope it'</font>s what you need<font color="#000080">).

</font><font color="#FF0000"><b>unit </b></font>Metaform<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
  </b></font>SysUtils<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Messages<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">, </font>Controls<font color="#000080">,
  </font>Forms<font color="#000080">, </font>Dialogs<font color="#000080">, </font>StdCtrls<font color="#000080">, </font>Buttons<font color="#000080">, </font>ExtCtrls<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TForm1 <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
    </font>Panel1<font color="#000080">: </font>TPanel<font color="#000080">;
    </font>BitBtn1<font color="#000080">: </font>TBitBtn<font color="#000080">;
    </font>Image1<font color="#000080">: </font>TImage<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>BitBtn1Click<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
  </font><font color="#FF0000"><b>private
    </b></font><font color="#008000"><i>{ Private declarations }
  </i></font><font color="#FF0000"><b>public
    </b></font><font color="#008000"><i>{ Public declarations }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Form1<font color="#000080">: </font>TForm1<font color="#000080">;

</font><font color="#FF0000"><b>implementation

</b></font><font color="#008000"><i>{$R *.DFM}

</i></font><font color="#FF0000"><b>type
  </b></font>TMetafileCanvas <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TCanvas<font color="#000080">)
  </font><font color="#FF0000"><b>private
    </b></font>FClipboardHandle<font color="#000080">: </font>THandle<font color="#000080">;
    </font>FMetafileHandle<font color="#000080">: </font>HMetafile<font color="#000080">;
    </font>FRect<font color="#000080">: </font>TRect<font color="#000080">;
  </font><font color="#FF0000"><b>protected
    procedure </b></font>CreateHandle<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetMetafileHandle<font color="#000080">: </font>HMetafile<font color="#000080">;
  </font><font color="#FF0000"><b>public
    constructor </b></font>Create<font color="#000080">;
    </font><font color="#FF0000"><b>destructor </b></font>Destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Rect<font color="#000080">: </font>TRect <font color="#FF0000"><b>read </b></font>FRect <font color="#FF0000"><b>write </b></font>FRect<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>MetafileHandle<font color="#000080">: </font>HMetafile <font color="#FF0000"><b>read </b></font>GetMetafileHandle<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>constructor </b></font>TMetafileCanvas<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>begin
  inherited </b></font>Create<font color="#000080">;
  </font>FClipboardHandle <font color="#000080">:= </font>GlobalAlloc<font color="#000080">(
    </font>GMEM_SHARE <font color="#FF0000"><b>or </b></font>GMEM_ZEROINIT<font color="#000080">, </font>SizeOf<font color="#000080">(</font>TMetafilePict<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>TMetafileCanvas<font color="#000080">.</font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DeleteMetafile<font color="#000080">(</font>CloseMetafile<font color="#000080">(</font>Handle<font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font>Bool<font color="#000080">(</font>FClipboardHandle<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>GlobalFree<font color="#000080">(</font>FClipboardHandle<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Bool<font color="#000080">(</font>FMetafileHandle<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>DeleteMetafile<font color="#000080">(</font>FMetafileHandle<font color="#000080">);
  </font><font color="#FF0000"><b>inherited </b></font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TMetafileCanvas<font color="#000080">.</font>CreateHandle<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>MetafileDC<font color="#000080">: </font>HDC<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Create a metafile DC in memory }
  </i></font>MetafileDC <font color="#000080">:= </font>CreateMetaFile<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Bool<font color="#000080">(</font>MetafileDC<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font><font color="#008000"><i>{ Map the top,left corner of the displayed rectangle to the
top,left of the
      device context. Leave a border of 10 logical units around the
picture. }
    </i></font><font color="#FF0000"><b>with </b></font>FRect <font color="#FF0000"><b>do </b></font>SetWindowOrg<font color="#000080">(</font>MetafileDC<font color="#000080">, </font>Left <font color="#000080">- </font><font color="#800000">10</font><font color="#000080">, </font>Top <font color="#000080">- </font><font color="#800000">10</font><font color="#000080">);
    </font><font color="#008000"><i>{ Set the extent of the picture with a border of 10 logical units.
}
    </i></font><font color="#FF0000"><b>with </b></font>FRect <font color="#FF0000"><b>do </b></font>SetWindowExt<font color="#000080">(</font>MetafileDC<font color="#000080">, </font>Right <font color="#000080">- </font>Left <font color="#000080">+ </font><font color="#800000">20</font><font color="#000080">, </font>Bottom <font color="#000080">-
</font>Top <font color="#000080">+ </font><font color="#800000">20</font><font color="#000080">);
    </font><font color="#008000"><i>{ Play any valid metafile contents to it. }
    </i></font><font color="#FF0000"><b>if </b></font>Bool<font color="#000080">(</font>FMetafileHandle<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>PlayMetafile<font color="#000080">(</font>MetafileDC<font color="#000080">, </font>FMetafileHandle<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Handle <font color="#000080">:= </font>MetafileDC<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TMetafileCanvas<font color="#000080">.</font>GetMetafileHandle<font color="#000080">: </font>HMetafile<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>MetafilePict<font color="#000080">: </font>PMetafilePict<font color="#000080">;
  </font>IC<font color="#000080">: </font>HDC<font color="#000080">;
  </font>ExtRect<font color="#000080">: </font>TRect<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Bool<font color="#000080">(</font>FMetafileHandle<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>DeleteMetafile<font color="#000080">(</font>FMetafileHandle<font color="#000080">);
  </font>FMetafileHandle <font color="#000080">:= </font>CloseMetafile<font color="#000080">(</font>Handle<font color="#000080">);
  </font>Handle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#008000"><i>{ Prepair metafile for clipboard display. }
  </i></font>MetafilePict <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>FClipboardHandle<font color="#000080">);
  </font>MetafilePict<font color="#000080">^.</font>mm <font color="#000080">:= </font>mm_AnIsoTropic<font color="#000080">;
  </font>IC <font color="#000080">:= </font>CreateIC<font color="#000080">(</font><font color="#800000">'DISPLAY'</font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">);
  </font>SetMapMode<font color="#000080">(</font>IC<font color="#000080">, </font>mm_HiMetric<font color="#000080">);
  </font>ExtRect <font color="#000080">:= </font>FRect<font color="#000080">;
  </font>DPtoLP<font color="#000080">(</font>IC<font color="#000080">, </font>ExtRect<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
  </font>DeleteDC<font color="#000080">(</font>IC<font color="#000080">);
  </font>MetafilePict<font color="#000080">^.</font>xExt <font color="#000080">:= </font>ExtRect<font color="#000080">.</font>Right <font color="#000080">- </font>ExtRect<font color="#000080">.</font>Left<font color="#000080">;
  </font>MetafilePict<font color="#000080">^.</font>yExt <font color="#000080">:= </font>ExtRect<font color="#000080">.</font>Top <font color="#000080">- </font>ExtRect<font color="#000080">.</font>Bottom<font color="#000080">;
  </font>MetafilePict<font color="#000080">^.</font>HMF <font color="#000080">:=  </font>FMetafileHandle<font color="#000080">;
  </font>GlobalUnlock<font color="#000080">(</font>FClipboardHandle<font color="#000080">);
  </font><font color="#008000"><i>{ I'm giving you this handle, but please do NOT eat it. }
  </i></font>Result <font color="#000080">:= </font>FClipboardHandle<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>BitBtn1Click<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>MetafileCanvas <font color="#000080">: </font>TMetafileCanvas<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>MetafileCanvas <font color="#000080">:= </font>TMetafileCanvas<font color="#000080">.</font>Create<font color="#000080">;
  </font>MetafileCanvas<font color="#000080">.</font>Rect <font color="#000080">:= </font>Rect<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">500</font><font color="#000080">,</font><font color="#800000">500</font><font color="#000080">);
  </font>MetafileCanvas<font color="#000080">.</font>Ellipse<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">10</font><font color="#000080">,</font><font color="#800000">400</font><font color="#000080">,</font><font color="#800000">400</font><font color="#000080">);
  </font>Image1<font color="#000080">.</font>Picture<font color="#000080">.</font>Metafile<font color="#000080">.</font>LoadFromClipboardFormat<font color="#000080">(
    </font>cf_MetafilePict<font color="#000080">, </font>MetafileCanvas<font color="#000080">.</font>MetafileHandle<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>MetafileCanvas<font color="#000080">.</font>Free<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0037.PAS">Original</a><b>]</b></p></body>
</html>
