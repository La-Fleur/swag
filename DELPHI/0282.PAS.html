<html>
<head><title> "Extended compressed Bitmap object" by HERBERT BEEMSTER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0282.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>UBitmap<font color="#000080">;
</font><font color="#008000"><i>{
Extented TBitmap object for Delphi 1.0
Added methods to load and save a compressed bitmap.
Copyright &copy; 1997 by Herbert J.Beemster.

Questions, positive remarks, improvements etc. : herbertjb@compuserve.com

Credits goes to:
- Kurt Haenen for the LZRW1KH unit.
- Dan English for the trick with the streams.
- Danny Heijl for sample of using LZRW1KH.


This piece of source is hereby donated to the public domain. Enjoy!
}

</i></font><font color="#FF0000"><b>interface

uses </b></font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>SysUtils<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">;

</font><font color="#FF0000"><b>type
 </b></font>TLZRBitmap <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TBitmap<font color="#000080">)
 </font><font color="#FF0000"><b>public
   procedure </b></font>LZRLoadFromFile<font color="#000080">(
     </font><font color="#FF0000"><b>const </b></font>Filename <font color="#000080">: </font><font color="#FF0000"><b>string
   </b></font><font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>procedure </b></font>LZRSaveToFile<font color="#000080">(
     </font><font color="#FF0000"><b>const </b></font>Filename <font color="#000080">: </font><font color="#FF0000"><b>string
   </b></font><font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{TLZRBitmap}


</i></font><font color="#FF0000"><b>implementation

uses
  </b></font>LZRW1KH<font color="#000080">; </font><font color="#008000"><i>{Credits : Kurt Haenen}  { unit can be in ARCHIVES.SWG !! }

</i></font><font color="#FF0000"><b>const
  </b></font>ChunkSize <font color="#000080">= </font><font color="#800000">32768</font><font color="#000080">;
  </font>IOBufSize <font color="#000080">= (</font>ChunkSize <font color="#000080">+ </font><font color="#800000">16</font><font color="#000080">);
  </font>LZRWIdentifier <font color="#000080">: </font>LONGINT <font color="#000080">=
  ((((((</font>ORD<font color="#000080">(</font><font color="#800000">'L'</font><font color="#000080">) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">8</font><font color="#000080">)+</font>ORD<font color="#000080">(</font><font color="#800000">'Z'</font><font color="#000080">)) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">8</font><font color="#000080">)+</font>ORD<font color="#000080">(</font><font color="#800000">'R'</font><font color="#000080">)) </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">8</font><font color="#000080">)+</font>ORD<font color="#000080">(</font><font color="#800000">'W'</font><font color="#000080">));

</font><font color="#FF0000"><b>var
  </b></font>InStream   <font color="#000080">: </font>TMemoryStream<font color="#000080">;
  </font>OutStream  <font color="#000080">: </font>TMemoryStream<font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>TLZRBitmap<font color="#000080">.</font>LZRLoadFromFile<font color="#000080">(
  </font><font color="#FF0000"><b>const </b></font>Filename <font color="#000080">: </font><font color="#FF0000"><b>string
</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Tmp<font color="#000080">,
  </font>Identifier<font color="#000080">,
  </font>OrigSize<font color="#000080">,
  </font>SrcSize<font color="#000080">,
  </font>DstSize    <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>SrcBuf<font color="#000080">,
  </font>DstBuf     <font color="#000080">: </font>BufferPtr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  try
  </b></font><font color="#008000"><i>{Create InStream &amp; OutStream}
    </i></font>InStream  <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
    </font>OutStream <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
  </font><font color="#008000"><i>{Create buffers for LZWR1KH}
    </i></font>Getmem<font color="#000080">(</font>SrcBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);
    </font>Getmem<font color="#000080">(</font>DstBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);

  </font><font color="#008000"><i>{Load the compressed bitmap}
    </i></font>InStream<font color="#000080">.</font>LoadFromFile<font color="#000080">( </font>Filename<font color="#000080">);
    </font>InStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);

  </font><font color="#008000"><i>{Decompress the lot...}
  {Read compression ID }
    </i></font>InStream<font color="#000080">.</font>Read<font color="#000080">( </font>Identifier<font color="#000080">, </font>SizeOf<font color="#000080">( </font>LongInt<font color="#000080">));

  </font><font color="#008000"><i>{Read in uncompressed filesize }
    </i></font>InStream<font color="#000080">.</font>Read<font color="#000080">( </font>OrigSize<font color="#000080">, </font>SizeOf<font color="#000080">( </font>LongInt<font color="#000080">));

    </font>DstSize <font color="#000080">:= </font>ChunkSize<font color="#000080">;
    </font>SrcSize <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>DstSize <font color="#000080">= </font>ChunkSize<font color="#000080">)
    </font><font color="#FF0000"><b>do
    begin
    </b></font><font color="#008000"><i>{Read size of compressed block }
      </i></font>Tmp <font color="#000080">:= </font>InStream<font color="#000080">.</font>Read<font color="#000080">( </font>SrcSize<font color="#000080">, </font>SizeOf<font color="#000080">( </font>Word<font color="#000080">));
    </font><font color="#008000"><i>{Read compressed block }
      </i></font>InStream<font color="#000080">.</font>Read<font color="#000080">( </font>SrcBuf<font color="#000080">^, </font>SrcSize<font color="#000080">);
    </font><font color="#008000"><i>{Decompress block }
      </i></font>DstSize <font color="#000080">:= </font>Decompression<font color="#000080">( </font>SrcBuf<font color="#000080">, </font>DstBuf<font color="#000080">, </font>SrcSize<font color="#000080">);
    </font><font color="#008000"><i>{Write decompressed block out to OutStream }
      </i></font>OutStream<font color="#000080">.</font>Write<font color="#000080">( </font>DstBuf<font color="#000080">^, </font>DstSize<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{TBitmap thinks its loading from a file!}
    </i></font>OutStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
    </font>LoadfromStream<font color="#000080">( </font>OutStream<font color="#000080">);

  </font><font color="#FF0000"><b>finally
  </b></font><font color="#008000"><i>{Clean Up Memory}
    </i></font>InStream<font color="#000080">.</font>Free<font color="#000080">;
    </font>OutStream<font color="#000080">.</font>Free<font color="#000080">;
    </font>Freemem<font color="#000080">( </font>SrcBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);
    </font>Freemem<font color="#000080">( </font>DstBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);

  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{try}

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{LZRLoadFromFile}


</i></font><font color="#FF0000"><b>procedure </b></font>TLZRBitmap<font color="#000080">.</font>LZRSaveToFile<font color="#000080">(
  </font><font color="#FF0000"><b>const </b></font>Filename <font color="#000080">: </font><font color="#FF0000"><b>string
</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Size<font color="#000080">,
  </font>CompIdentifier<font color="#000080">,
  </font>SrcSize<font color="#000080">,
  </font>DstSize    <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>SrcBuf<font color="#000080">,
  </font>DstBuf     <font color="#000080">: </font>BufferPtr<font color="#000080">;

</font><font color="#FF0000"><b>begin
  try
  </b></font><font color="#008000"><i>{Create InStream &amp; OutStream}
    </i></font>InStream  <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
    </font>OutStream <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
  </font><font color="#008000"><i>{Create buffers for LZWR1KH}
    </i></font>Getmem<font color="#000080">(</font>SrcBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);
    </font>Getmem<font color="#000080">(</font>DstBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);

  </font><font color="#008000"><i>{Save the bitmap to InStream}
    </i></font>SaveToStream<font color="#000080">( </font>InStream<font color="#000080">);
    </font>InStream<font color="#000080">.</font>Seek<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);

  </font><font color="#008000"><i>{Compress the lot...}
  {Write out compression ID }
    </i></font>CompIdentifier <font color="#000080">:= </font>LZRWIdentifier<font color="#000080">;
    </font>OutStream<font color="#000080">.</font>Write<font color="#000080">( </font>CompIdentifier<font color="#000080">, </font>SizeOf<font color="#000080">( </font>LongInt<font color="#000080">));

  </font><font color="#008000"><i>{Write out uncompressed filesize }
    </i></font>Size <font color="#000080">:= </font>InStream<font color="#000080">.</font>Size<font color="#000080">;
    </font>OutStream<font color="#000080">.</font>Write<font color="#000080">( </font>Size<font color="#000080">, </font>SizeOf<font color="#000080">( </font>LongInt<font color="#000080">));


    </font>SrcSize <font color="#000080">:= </font>ChunkSize<font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>SRCSize <font color="#000080">= </font>ChunkSize<font color="#000080">)
    </font><font color="#FF0000"><b>do
    begin
    </b></font><font color="#008000"><i>{Read a block of data }
      </i></font>SrcSize <font color="#000080">:= </font>InStream<font color="#000080">.</font>Read<font color="#000080">( </font>SrcBuf<font color="#000080">^, </font>ChunkSize<font color="#000080">);
    </font><font color="#008000"><i>{Compress it }
      </i></font>DstSize <font color="#000080">:= </font>Compression<font color="#000080">( </font>SrcBuf<font color="#000080">, </font>DstBuf<font color="#000080">, </font>SrcSize<font color="#000080">);
    </font><font color="#008000"><i>{Write out compressed size }
      </i></font>OutStream<font color="#000080">.</font>Write<font color="#000080">( </font>DstSize<font color="#000080">, </font>SizeOf<font color="#000080">( </font>Word<font color="#000080">));
    </font><font color="#008000"><i>{Write out compressed data }
      </i></font>OutStream<font color="#000080">.</font>Write<font color="#000080">( </font>DstBuf<font color="#000080">^, </font>DstSize<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{while}

  {Save compressed OutStream to file}
    </i></font>OutStream<font color="#000080">.</font>SaveToFile<font color="#000080">( </font>Filename<font color="#000080">);

  </font><font color="#FF0000"><b>finally
  </b></font><font color="#008000"><i>{Clean Up Memory}
    </i></font>InStream<font color="#000080">.</font>Free<font color="#000080">;
    </font>OutStream<font color="#000080">.</font>Free<font color="#000080">;
    </font>Freemem<font color="#000080">( </font>SrcBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);
    </font>Freemem<font color="#000080">( </font>DstBuf<font color="#000080">, </font>IOBufSize<font color="#000080">);

  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{try}

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{LZRSaveToFile}

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0282.PAS">Original</a><b>]</b></p></body>
</html>
