<html>
<head><title> "Drag'n'Drop from Delphi to Win Explorer" by KANCA <KANCA@IBM.NET></title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0213.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Hi Vit,

: Anybody tied d'n'd any object from Delphi App (for example TListView) to
: win Explorer, DeskTop?
: How my App can catch the path?

Here is a piece of code I had in my arhcives &lt;g&gt;
It shold work on D2 too --I havent checked.

HTH

Basri,
kanca@ibm.net

-------BEGIN CUT AND PASTE-------------------
{
This small app should answer some questions for you.  If has quite a
few nifty things it does too, such as shows you how to drag and drop
from the file manager, owner drawn list boxes, etc.  Run it and tell
me what you think.  Make sure you adjust your file manager when it
comes up so that it doesn't cover up this program.  When saving as a
bitmap, remember to enter in an extension.  I havn't figured out how
to find the value of the SAVE FILE AS TYPE combo box...&lt;g&gt;

This work was originally created by Freddy Enok Hansson (100572,2032)
to help me with some of my questions. I have modified and added to it
to suit my needs.  If you like what you see, drop him a note and tell
him thanks.

-Pat Buchanan   73072,2743-
}


</i></font><font color="#FF0000"><b>unit </b></font>Pat<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
  </b></font>SysUtils<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Messages<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">, </font>Controls<font color="#000080">,
  </font>Forms<font color="#000080">, </font>Dialogs<font color="#000080">, </font>ExtCtrls<font color="#000080">, </font>StdCtrls<font color="#000080">, </font>Buttons<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TForm1 <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
    </font>BitBtn1<font color="#000080">: </font>TBitBtn<font color="#000080">;
    </font>ListBox1<font color="#000080">: </font>TListBox<font color="#000080">;
    </font>NumIcons<font color="#000080">: </font>TLabel<font color="#000080">;
    </font>Label1<font color="#000080">: </font>TLabel<font color="#000080">;
    </font>Label2<font color="#000080">: </font>TLabel<font color="#000080">;
    </font>SaveDialog1<font color="#000080">: </font>TSaveDialog<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>FormClose<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Action<font color="#000080">: </font>TCloseAction<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>ListBox1DrawItem<font color="#000080">(</font>Control<font color="#000080">: </font>TWinControl<font color="#000080">; </font>Index<font color="#000080">: </font>Integer<font color="#000080">;
      </font>Rect<font color="#000080">: </font>TRect<font color="#000080">; </font>State<font color="#000080">: </font>TOwnerDrawState<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>ListBox1DblClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
  </font><font color="#FF0000"><b>private
    </b></font><font color="#008000"><i>{ Private declarations }
  </i></font><font color="#FF0000"><b>procedure </b></font>WMDropFiles <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Msg<font color="#000080">: </font>TMessage<font color="#000080">); </font><font color="#FF0000"><b>message </b></font>wm_DropFiles<font color="#000080">;
  </font><font color="#FF0000"><b>public
    </b></font><font color="#008000"><i>{ Public declarations }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Form1<font color="#000080">: </font>TForm1<font color="#000080">;

</font><font color="#FF0000"><b>implementation

uses </b></font>ShellAPI<font color="#000080">;

</font><font color="#008000"><i>{$R *.DFM}

</i></font><font color="#FF0000"><b>var
  </b></font>Pic<font color="#000080">: </font>TPicture<font color="#000080">;
  </font>Fname <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>TempFile<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>Icon <font color="#000080">: </font>TIcon<font color="#000080">;
  </font>Drop <font color="#000080">: </font>THandle<font color="#000080">; </font><font color="#008000"><i>{Handle for Msg.wParam}




 </i></font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>WMDropFiles<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Msg<font color="#000080">: </font>TMessage<font color="#000080">);
 </font><font color="#FF0000"><b>var
   </b></font>i<font color="#000080">,</font>K<font color="#000080">,
   </font>NumFiles<font color="#000080">, </font>NameLength <font color="#000080">: </font>integer<font color="#000080">;
   </font>nIconsInFile <font color="#000080">: </font>word<font color="#000080">;
   </font>nTotal <font color="#000080">: </font>word<font color="#000080">;

 </font><font color="#FF0000"><b>begin

  try
   </b></font>screen<font color="#000080">.</font>cursor <font color="#000080">:= </font>crHourglass<font color="#000080">;

   </font>ListBox1<font color="#000080">.</font>clear<font color="#000080">;
   </font>Drop <font color="#000080">:= </font>Msg<font color="#000080">.</font>wParam<font color="#000080">;
   </font>nTotal <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

   </font><font color="#008000"><i>{Query how many files were dropped on the app}
   </i></font>NumFiles <font color="#000080">:= </font>DragQueryFile<font color="#000080">(</font>Msg<font color="#000080">.</font>wParam<font color="#000080">, </font><font color="#800000">$FFFF</font><font color="#000080">, </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

   </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#000080">(</font>NumFiles<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
     </b></font>NameLength <font color="#000080">:= </font>DragQueryFile<font color="#000080">(</font>Msg<font color="#000080">.</font>wParam<font color="#000080">, </font>i<font color="#000080">, </font><font color="#FF0000"><b>Nil </b></font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
     </font>DragQueryFile<font color="#000080">(</font>Msg<font color="#000080">.</font>wParam<font color="#000080">, </font>i<font color="#000080">, </font>TempFile<font color="#000080">, </font>NameLength<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
     </font>FName <font color="#000080">:= </font>StrPas<font color="#000080">(</font>TempFile<font color="#000080">);

     </font><font color="#008000"><i>{Query how many icons existin the file (-1)}
     </i></font>nIconsInFile <font color="#000080">:= </font>ExtractIcon<font color="#000080">(</font>HInstance<font color="#000080">, </font>TempFile<font color="#000080">, </font><font color="#800000">$FFFF</font><font color="#000080">);
     </font>nTotal <font color="#000080">:= </font>nTotal <font color="#000080">+ </font>nIconsInFile<font color="#000080">;

       </font><font color="#FF0000"><b>for </b></font>K <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>nIconsInFile<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
         </b></font><font color="#008000"><i>{Extract the icon}
         </i></font>Icon<font color="#000080">.</font>Handle <font color="#000080">:= </font>ExtractIcon<font color="#000080">(</font>HInstance<font color="#000080">, </font>TempFile<font color="#000080">, </font>K<font color="#000080">);

         </font><font color="#008000"><i>{Create a TPicture instance}
         </i></font>Pic <font color="#000080">:= </font>TPicture<font color="#000080">.</font>Create<font color="#000080">;
         </font><font color="#008000"><i>{Assign the icon.handle to the Pic.icon property}
         </i></font>Pic<font color="#000080">.</font>Icon <font color="#000080">:= </font>Icon<font color="#000080">;

         </font><font color="#008000"><i>{Add the Filename and icon to the ListBox}
         </i></font>ListBox1<font color="#000080">.</font>Items<font color="#000080">.</font>AddObject<font color="#000080">(</font>ExtractFileName<font color="#000080">(</font>FName<font color="#000080">), </font>Pic<font color="#000080">);
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{For K}

   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{For I}

       </i></font><font color="#FF0000"><b>IF </b></font>nTotal <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
           </b></font>NumIcons<font color="#000080">.</font>Caption <font color="#000080">:= </font><font color="#800000">'None'
       </font><font color="#FF0000"><b>ELSE
           </b></font>NumIcons<font color="#000080">.</font>Caption <font color="#000080">:= </font>IntToStr<font color="#000080">(</font>nTotal<font color="#000080">);


   </font><font color="#FF0000"><b>finally
     </b></font>screen<font color="#000080">.</font>cursor <font color="#000080">:= </font>crDefault<font color="#000080">;

   </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{main begin}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{WMDropFiles}



</i></font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>DragAcceptFiles<font color="#000080">(</font>Handle<font color="#000080">, </font>True<font color="#000080">);
  </font>Icon <font color="#000080">:= </font>TIcon<font color="#000080">.</font>Create<font color="#000080">;
  </font>WinExec<font color="#000080">(</font><font color="#800000">'winfile.exe'</font><font color="#000080">, </font>SW_RESTORE<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>FormClose<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Action<font color="#000080">: </font>TCloseAction<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DragFinish<font color="#000080">(</font>Drop<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>ListBox1<font color="#000080">.</font>Items<font color="#000080">.</font>Count <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do
    </b></font>TPicture<font color="#000080">(</font>ListBox1<font color="#000080">.</font>Items<font color="#000080">.</font>Objects<font color="#000080">[</font>I<font color="#000080">]).</font>Free<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>ListBox1DrawItem<font color="#000080">(</font>Control<font color="#000080">: </font>TWinControl<font color="#000080">; </font>Index<font color="#000080">: </font>Integer<font color="#000080">;
  </font>Rect<font color="#000080">: </font>TRect<font color="#000080">; </font>State<font color="#000080">: </font>TOwnerDrawState<font color="#000080">);
</font><font color="#FF0000"><b>begin
  with </b></font>ListBox1<font color="#000080">.</font>Canvas <font color="#FF0000"><b>do
  begin
    </b></font>FillRect<font color="#000080">(</font>Rect<font color="#000080">);
    </font>Pic <font color="#000080">:= </font>TPicture<font color="#000080">(</font>ListBox1<font color="#000080">.</font>Items<font color="#000080">.</font>Objects<font color="#000080">[</font>Index<font color="#000080">]);
    </font>Draw<font color="#000080">(</font>Rect<font color="#000080">.</font>Left<font color="#000080">, </font>Rect<font color="#000080">.</font>Top <font color="#000080">+ </font><font color="#800000">2</font><font color="#000080">, </font>Pic<font color="#000080">.</font>Graphic<font color="#000080">);
    </font>TextOut<font color="#000080">(</font>Rect<font color="#000080">.</font>Left <font color="#000080">+ </font><font color="#800000">34</font><font color="#000080">, </font>Rect<font color="#000080">.</font>Top <font color="#000080">+ </font><font color="#800000">5</font><font color="#000080">,
      </font>ListBox1<font color="#000080">.</font>Items<font color="#000080">[</font>Index<font color="#000080">]);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;




</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>ListBox1DblClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>oIcon <font color="#000080">: </font>TPicture<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>oBitmap <font color="#000080">: </font>TBitmap<font color="#000080">;

</font><font color="#FF0000"><b>begin

 </b></font>oIcon <font color="#000080">:= </font>TPicture<font color="#000080">.</font>create<font color="#000080">;
 </font>oBitmap <font color="#000080">:= </font>TBitMap<font color="#000080">.</font>create<font color="#000080">;


 </font><font color="#FF0000"><b>IF </b></font>SaveDialog1<font color="#000080">.</font>Execute <font color="#FF0000"><b>then

  WITH </b></font><font color="#000080">(</font>Sender <font color="#FF0000"><b>as </b></font>TListBox<font color="#000080">) </font><font color="#FF0000"><b>DO
     begin

      </b></font>oIcon<font color="#000080">.</font>Assign<font color="#000080">(</font>TPicture<font color="#000080">(</font>Items<font color="#000080">.</font>Objects<font color="#000080">[</font>ItemIndex<font color="#000080">]));

       </font><font color="#008000"><i>{---------Save as an icon---------}
       </i></font><font color="#FF0000"><b>IF </b></font>ExtractFileExt<font color="#000080">(</font>SaveDialog1<font color="#000080">.</font>FileName<font color="#000080">) = </font><font color="#800000">'.ICO' </font><font color="#FF0000"><b>then
         begin

           </b></font><font color="#008000"><i>{Save the icon to the specified file}
           </i></font>oIcon<font color="#000080">.</font>icon<font color="#000080">.</font>SaveToFile<font color="#000080">(</font>SaveDialog1<font color="#000080">.</font>Filename<font color="#000080">);

           </font>ShowMessage<font color="#000080">(</font>ExtractFileName<font color="#000080">(</font>SaveDialog1<font color="#000080">.</font>Filename<font color="#000080">) + </font><font color="#800000">' has been
</font>saved <font color="#FF0000"><b>as </b></font>an ICON<font color="#000080">.</font><font color="#800000">');

         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

       </font><font color="#008000"><i>{---------Save as a bitmap---------}
       </i></font><font color="#FF0000"><b>IF </b></font>ExtractFileExt<font color="#000080">(</font>SaveDialog1<font color="#000080">.</font>FileName<font color="#000080">) = </font><font color="#800000">'.BMP' </font><font color="#FF0000"><b>then
         begin

            </b></font><font color="#008000"><i>{Setup the bitmap size, so that it matches the icon}
            </i></font>oBitmap<font color="#000080">.</font>Width <font color="#000080">:= </font>Icon<font color="#000080">.</font>Width<font color="#000080">;
            </font>oBitmap<font color="#000080">.</font>Height <font color="#000080">:= </font>Icon<font color="#000080">.</font>Height<font color="#000080">;

            </font><font color="#008000"><i>{ Draw Icon on Bitmap }
            </i></font>oBitmap<font color="#000080">.</font>Canvas<font color="#000080">.</font>Draw<font color="#000080">( </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>oIcon<font color="#000080">.</font>Graphic <font color="#000080">);

            </font><font color="#008000"><i>{Save the bitmap to the specified file}
            </i></font>oBitmap<font color="#000080">.</font>SaveToFile<font color="#000080">(</font>SaveDialog1<font color="#000080">.</font>Filename<font color="#000080">);

            </font>ShowMessage<font color="#000080">(</font>ExtractFileName<font color="#000080">(</font>SaveDialog1<font color="#000080">.</font>Filename<font color="#000080">) + </font><font color="#800000">' has been
</font>saved <font color="#FF0000"><b>as </b></font>a BITMAP<font color="#000080">.</font><font color="#800000">');

         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#008000"><i>{Clean up after yourself}
     </i></font>oIcon<font color="#000080">.</font>free<font color="#000080">;
     </font>oBitmap<font color="#000080">.</font>free<font color="#000080">;
     </font>SaveDialog1<font color="#000080">.</font>FileName <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0213.PAS">Original</a><b>]</b></p></body>
</html>
