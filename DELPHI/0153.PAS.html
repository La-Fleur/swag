<html>
<head><title> "Re: How do I get the Disk Serials?" by H.B. LANIER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0153.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; &gt;I've got code to do this in Turbo Pascal, using the DOS Services interrupt
&gt; &gt;(21), function number 69H.  But this does not work in Delphi.  I'm sure this
&gt; &gt;can be done using the DOS3CALL function, but I've tried and tried, and I can't
&gt; &gt;seem to get it to work.  Any ideas?
&gt;
&gt; &gt;Mike
&gt; &gt;m.d.bews@swansea.ac.uk
&gt;
&gt; This will do it !
}
 </i></font><font color="#FF0000"><b>unit </b></font>Procs<font color="#000080">;

 </font><font color="#FF0000"><b>interface

 uses
   </b></font>Forms<font color="#000080">, </font>DB<font color="#000080">, </font>DBGrids<font color="#000080">, </font>DBTables<font color="#000080">, </font>Graphics<font color="#000080">, </font>Classes<font color="#000080">, </font>Dialogs<font color="#000080">;

 </font><font color="#FF0000"><b>Type
      </b></font>TRWBlock <font color="#000080">= </font><font color="#FF0000"><b>Record
         </b></font>rwSpecFunc<font color="#000080">: </font>Byte<font color="#000080">;
         </font>rwHead<font color="#000080">: </font>Word<font color="#000080">;
         </font>rwCylinder<font color="#000080">: </font>Word<font color="#000080">;
         </font>rwFirstSector<font color="#000080">: </font>Word<font color="#000080">;
         </font>rwSectors<font color="#000080">: </font>Word<font color="#000080">;
         </font>rwBufPtr<font color="#000080">: </font>Pointer<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

      </font>TBootSector <font color="#000080">= </font><font color="#FF0000"><b>Record
          </b></font>bsJump<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
          </font>bsOemName<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
          </font>bsBytesPerSec<font color="#000080">: </font>Word<font color="#000080">;
          </font>bsSecPerClust<font color="#000080">: </font>Byte<font color="#000080">;
          </font>bsResSectors<font color="#000080">: </font>Word<font color="#000080">;
          </font>bsFATs<font color="#000080">: </font>Byte<font color="#000080">;
          </font>bsRootDirEnts<font color="#000080">: </font>Word<font color="#000080">;
          </font>bsSectors<font color="#000080">: </font>Word<font color="#000080">;
          </font>bsMedia<font color="#000080">: </font>Byte<font color="#000080">;
          </font>bsFATSecs<font color="#000080">: </font>Word<font color="#000080">;
          </font>bsSecPerTrack<font color="#000080">: </font>Word<font color="#000080">;
          </font>bsHeads<font color="#000080">: </font>Word<font color="#000080">;
          </font>bsHiddensecs<font color="#000080">: </font>Longint<font color="#000080">;
          </font>bsHugeSectors<font color="#000080">: </font>LongInt<font color="#000080">;
          </font>bsDriveNumber<font color="#000080">: </font>Byte<font color="#000080">;
          </font>bsReserved<font color="#000080">: </font>Byte<font color="#000080">;
          </font>bsBootsignature<font color="#000080">: </font>Byte<font color="#000080">;
          </font>bsVolumeID<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
          </font>bsVolumeLabel<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">10</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
          </font>bsFileSysType<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>Const </b></font>RWBlock<font color="#000080">: </font>TRWBlock <font color="#000080">= (</font>rwSpecFunc<font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
                            </font>rwHead<font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
                            </font>rwCylinder<font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
                            </font>rwfirstSector<font color="#000080">: </font><font color="#800000">0</font><font color="#000080">;
                            </font>rwSectors<font color="#000080">: </font><font color="#800000">1</font><font color="#000080">;
                            </font>rwBufPtr<font color="#000080">: </font><font color="#FF0000"><b>nil</b></font><font color="#000080">);

 </font><font color="#FF0000"><b>Function </b></font>ReadBootSector<font color="#000080">(</font>Drive<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>BootSector<font color="#000080">: </font>TBootsector<font color="#000080">): </font>Boolean<font color="#000080">;

 </font><font color="#FF0000"><b>implementation

 Uses </b></font>MsgForm<font color="#000080">;

 </font><font color="#FF0000"><b>Function </b></font>ReadBootSector<font color="#000080">(</font>Drive<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>BootSector<font color="#000080">: </font>TBootsector<font color="#000080">): </font>Boolean<font color="#000080">;
 </font><font color="#FF0000"><b>Var </b></font>Buffer<font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1023</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">; </font>Status<font color="#000080">: </font>Word<font color="#000080">;
 </font><font color="#FF0000"><b>Begin
    </b></font>RWBlock<font color="#000080">.</font>rwBufPtr <font color="#000080">:= </font>addr<font color="#000080">(</font>Buffer<font color="#000080">);
    </font><font color="#FF0000"><b>asm
         </b></font><font color="#FF00FF">mov         bx, Drive
         mov         ch, 08h
         mov         cl, 61h
         mov         dx, seg RWBlock
         mov         ds, dx
         mov         dx, offset RWBlock
         mov         ax, 440dh
         int         21h
         jc          @Error_handler
         jmp         @ok
      @Error_handler:
         mov         Status, ax
         jmp         @exit
      @ok:
         mov         status, 0
      @exit:
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font>ReadBootSector <font color="#000080">:= </font>Status <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>Status <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>Move<font color="#000080">(</font>Buffer<font color="#000080">, </font>BootSector<font color="#000080">, </font>SizeOf<font color="#000080">(</font>TBootSector<font color="#000080">));
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ -------------  ANOTHER WAY TO DO IT -------------------- }

</i></font><font color="#FF0000"><b>Type
  </b></font>InfoBuffer <font color="#000080">= </font><font color="#FF0000"><b>RECORD
    </b></font>InfoLevel <font color="#000080">: </font>WORD<font color="#000080">;
    </font>Serial <font color="#000080">: </font>DWord<font color="#000080">;
    </font>VolLabel <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">10</font><font color="#000080">]</font><font color="#FF0000"><b>OF </b></font>CHAR<font color="#000080">;
    </font>FileSystem <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">]</font><font color="#FF0000"><b>OF </b></font>CHAR<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>TFMain<font color="#000080">.</font>GetDiskSerNo<font color="#000080">(</font>Drive <font color="#000080">: </font>Byte<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Const
  </b></font>HexDigits <font color="#000080">: </font><font color="#FF0000"><b>ARRAY </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">]</font><font color="#FF0000"><b>OF </b></font>CHAR <font color="#000080">= </font><font color="#800000">'0123456789ABCDEF'</font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>IB   <font color="#000080">: </font>InfoBuffer<font color="#000080">;
  </font>N    <font color="#000080">: </font>WORD<font color="#000080">;

  </font><font color="#FF0000"><b>Function </b></font>SerialStr <font color="#000080">(</font>L <font color="#000080">: </font>LONGINT<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Var
    </b></font>Temp <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    </b></font><font color="#008000"><i>{Temp [0] := #9; }
    </i></font>Temp <font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>HexDigits <font color="#000080">[</font>L <font color="#FF0000"><b>SHR </b></font><font color="#800000">28</font><font color="#000080">];
    </font>Temp <font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>HexDigits <font color="#000080">[ (</font>L <font color="#FF0000"><b>SHR </b></font><font color="#800000">24</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$F</font><font color="#000080">];
    </font>Temp <font color="#000080">[</font><font color="#800000">3</font><font color="#000080">] := </font>HexDigits <font color="#000080">[ (</font>L <font color="#FF0000"><b>SHR </b></font><font color="#800000">20</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$F</font><font color="#000080">];
    </font>Temp <font color="#000080">[</font><font color="#800000">4</font><font color="#000080">] := </font>HexDigits <font color="#000080">[ (</font>L <font color="#FF0000"><b>SHR </b></font><font color="#800000">16</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$F</font><font color="#000080">];
    </font>Temp <font color="#000080">[</font><font color="#800000">5</font><font color="#000080">] := </font><font color="#800000">'-'</font><font color="#000080">;
    </font>Temp <font color="#000080">[</font><font color="#800000">6</font><font color="#000080">] := </font>HexDigits <font color="#000080">[ (</font>L <font color="#FF0000"><b>SHR </b></font><font color="#800000">12</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$F</font><font color="#000080">];
    </font>Temp <font color="#000080">[</font><font color="#800000">7</font><font color="#000080">] := </font>HexDigits <font color="#000080">[ (</font>L <font color="#FF0000"><b>SHR </b></font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$F</font><font color="#000080">];
    </font>Temp <font color="#000080">[</font><font color="#800000">8</font><font color="#000080">] := </font>HexDigits <font color="#000080">[ (</font>L <font color="#FF0000"><b>SHR </b></font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>AND </b></font><font color="#800000">$F</font><font color="#000080">];
    </font>Temp <font color="#000080">[</font><font color="#800000">9</font><font color="#000080">] := </font>HexDigits <font color="#000080">[</font>L <font color="#FF0000"><b>AND </b></font><font color="#800000">$F</font><font color="#000080">];
    </font>SerialStr <font color="#000080">:= </font>Temp<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Function </b></font>GetSerial <font color="#000080">(</font>DiskNum <font color="#000080">: </font>BYTE<font color="#000080">; </font><font color="#FF0000"><b>VAR </b></font>I <font color="#000080">: </font>InfoBuffer<font color="#000080">) : </font>WORD<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">MOV AH, 69h
      MOV AL, 00h
      MOV BL, DiskNum
      PUSH DS
      LDS DX, I  </font><font color="#008000"><i>{error here &quot;Operand Size Mismatch I&quot;}
      </i></font><font color="#FF00FF">INT 21h
      POP DS
      JC @Bad
      XOR AX, AX
      @Bad :
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>N <font color="#000080">:= </font>GetSerial <font color="#000080">(</font>Drive<font color="#000080">, </font>IB<font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>N <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>Result <font color="#000080">:= </font>SerialStr <font color="#000080">(</font>IB<font color="#000080">.</font>Serial<font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>Result <font color="#000080">:= </font><font color="#800000">'Error Reading Disk'</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0153.PAS">Original</a><b>]</b></p></body>
</html>
