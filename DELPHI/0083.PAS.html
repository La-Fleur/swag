<html>
<head><title> "More on using TStream/TFileStream" by MARK JOHNSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0083.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">Take a look at TStream<font color="#000080">/</font>TFileStream<font color="#000080">.  </font>There <font color="#FF0000"><b>is </b></font>a specific pair <font color="#FF0000"><b>of </b></font>methods
called WriteComponent <font color="#FF0000"><b>and </b></font>ReadComponent that will <font color="#FF0000"><b>do </b></font>what you need<font color="#000080">.
</font>However<font color="#000080">, </font>it may <font color="#FF0000"><b>not </b></font>always work exactly <font color="#FF0000"><b>as </b></font>expected<font color="#000080">.

</font>WriteComponent will take a component <font color="#FF0000"><b>as </b></font>a parameter <font color="#FF0000"><b>and </b></font>will write
that component <font color="#FF0000"><b>and </b></font>all components that it owns <font color="#FF0000"><b>to </b></font>a stream<font color="#000080">, </font>according
<font color="#FF0000"><b>to </b></font>the documentation<font color="#000080">.  </font>However<font color="#000080">, </font>it will <font color="#FF0000"><b>not </b></font>actually write all <font color="#FF0000"><b>of
</b></font>its owned components unless it <font color="#FF0000"><b>is </b></font>a TWinControl descendant <font color="#000080">(</font><font color="#FF0000"><b>or </b></font>a
component <font color="#FF0000"><b>type </b></font>that overrides the WriteComponents method<font color="#000080">).

</font><font color="#FF0000"><b>To </b></font>store a form <font color="#FF0000"><b>and </b></font>all <font color="#FF0000"><b>of </b></font>the components <font color="#FF0000"><b>on </b></font>it<font color="#000080">, </font>you would <font color="#FF0000"><b>do </b></font>something
like<font color="#000080">:

</font><font color="#FF0000"><b>procedure </b></font>SaveForm<font color="#000080">(</font>form <font color="#000080">: </font>TForm<font color="#000080">; </font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>fstream <font color="#000080">: </font>TFileStream<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>form <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
    </b></font>fstream <font color="#000080">:= </font>TFileStream<font color="#000080">.</font>Create<font color="#000080">(</font>filename<font color="#000080">, </font>fmCreate<font color="#000080">);
    </font><font color="#FF0000"><b>try
      </b></font>fstream<font color="#000080">.</font>WriteComponent<font color="#000080">(</font>form<font color="#000080">);
    </font><font color="#FF0000"><b>finally
      </b></font>fstream<font color="#000080">.</font>Free<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>You could <font color="#FF0000"><b>then </b></font>read it back <font color="#FF0000"><b>in with </b></font>the following<font color="#000080">:

</font><font color="#FF0000"><b>function </b></font>LoadForm<font color="#000080">(</font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>TForm<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>fstream <font color="#000080">: </font>TFileStream<font color="#000080">;
  </font>cmpnt   <font color="#000080">: </font>TComponent<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Result  <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>fstream <font color="#000080">:= </font>TFileStream<font color="#000080">.</font>Create<font color="#000080">(</font>OpenDialog1<font color="#000080">.</font>FileName<font color="#000080">, </font>fmOpenRead<font color="#000080">);
  </font><font color="#FF0000"><b>try
    </b></font>cmpnt <font color="#000080">:= </font>fstream<font color="#000080">.</font>ReadComponent<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">);   </font><font color="#008000"><i>{read component from stream}
    </i></font><font color="#FF0000"><b>if </b></font>cmpnt <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin             </b></font><font color="#008000"><i>{if successfully read, ... }
      </i></font><font color="#FF0000"><b>if </b></font>cmpnt <font color="#FF0000"><b>is </b></font>TForm <font color="#FF0000"><b>then begin         </b></font><font color="#008000"><i>{check that it is a form   }
        </i></font>Result <font color="#000080">:= </font>cmpnt<font color="#000080">;                   </font><font color="#008000"><i>{if so, return it          }
        </i></font>Application<font color="#000080">.</font>InsertComponent<font color="#000080">(</font>Result<font color="#000080">); </font><font color="#008000"><i>{and make App owner of it}
      </i></font><font color="#FF0000"><b>end else                             </b></font><font color="#008000"><i>{if not what was expected  }
        </i></font>cmpnt<font color="#000080">.</font>Free<font color="#000080">;                        </font><font color="#008000"><i>{free it and return nil    }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>finally
    </b></font>fstream<font color="#000080">.</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>One thing you should watch <font color="#FF0000"><b>out for</b></font><font color="#000080">, </font>however<font color="#000080">, </font><font color="#FF0000"><b>is </b></font>that this method writes
<font color="#FF0000"><b>and </b></font>reads ALL <font color="#FF0000"><b>of </b></font>the components <font color="#FF0000"><b>on </b></font>the form<font color="#000080">, </font>even those that were added
during design time<font color="#000080">.  </font>This can be problematic when you <font color="#FF0000"><b>try to </b></font>read the
form back <font color="#FF0000"><b>in</b></font><font color="#000080">.  </font>The first item read <font color="#FF0000"><b>in </b></font>will be the form itself<font color="#000080">, </font>which
will be created according <font color="#FF0000"><b>to </b></font>its declaration<font color="#000080">, </font>which will include all
<font color="#FF0000"><b>of </b></font>the controls added at design time<font color="#000080">.  </font><font color="#FF0000"><b>Then</b></font><font color="#000080">, </font>when it begins loading
<font color="#FF0000"><b>in </b></font>the owned controls from the stream<font color="#000080">, </font>it will run into name conflicts
when it tries <font color="#FF0000"><b>to </b></font>create those controls that were design<font color="#000080">-</font>time additions
<font color="#FF0000"><b>to </b></font>the form since they already exist when the form <font color="#FF0000"><b>is </b></font>created<font color="#000080">.

</font>One possible way around this <font color="#FF0000"><b>is to </b></font>limit exactly which components
are saved <font color="#FF0000"><b>to </b></font>the stream<font color="#000080">.  </font><font color="#FF0000"><b>For </b></font>example<font color="#000080">, </font>something like this<font color="#000080">:

        </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>form<font color="#000080">.</font>ComponentCount <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do
          </b></font>fstream<font color="#000080">.</font>WriteComponent<font color="#000080">(</font>form<font color="#000080">.</font>Components<font color="#000080">[</font>i<font color="#000080">]);

</font>This will store one component after another <font color="#FF0000"><b>to </b></font>the stream<font color="#000080">.  </font>You could
<font color="#FF0000"><b>then </b></font>read it back <font color="#FF0000"><b>with </b></font>something like<font color="#000080">:

      </font><font color="#FF0000"><b>while not </b></font><font color="#000080">(</font>fstream<font color="#000080">.</font>Position <font color="#000080">= </font>fstream<font color="#000080">.</font>Size<font color="#000080">) </font><font color="#FF0000"><b>do begin
        </b></font>cmpnt <font color="#000080">:= </font>fstream<font color="#000080">.</font>ReadComponent<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>cmpnt <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
          </b></font>form<font color="#000080">.</font>InsertComponent<font color="#000080">(</font>cmpnt<font color="#000080">);
          </font><font color="#FF0000"><b>if </b></font>cmpnt <font color="#FF0000"><b>is </b></font>TControl <font color="#FF0000"><b>then
            </b></font>TControl<font color="#000080">(</font>cmpnt<font color="#000080">).</font>Parent <font color="#000080">:= </font>form<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>However<font color="#000080">, </font>watch <font color="#FF0000"><b>out </b></font>when you use this<font color="#000080">.  </font>It <font color="#FF0000"><b>is not </b></font>compatible <font color="#FF0000"><b>with </b></font>some
components<font color="#000080">.  </font><font color="#FF0000"><b>For </b></font>example<font color="#000080">, </font>when I tried <font color="#FF0000"><b>to </b></font>use this method <font color="#FF0000"><b>to </b></font>load <font color="#FF0000"><b>in
</b></font>a TMemo I had saved that contained some text<font color="#000080">, </font>I received a <font color="#800000">'Control
</font>has no parent<font color="#800000">' exception.  Apparently, attempting to add text to a
</font>TMemo that has no Parent will cause an exception<font color="#000080">, </font>interrupting the
ReadComponent process<font color="#000080">.

</font><font color="#FF0000"><b>With </b></font>a bit more work <font color="#FF0000"><b>and </b></font>code<font color="#000080">, </font>you may be able <font color="#FF0000"><b>to </b></font>come up <font color="#FF0000"><b>with </b></font>a
more flexible method <font color="#FF0000"><b>for </b></font>loading <font color="#FF0000"><b>and </b></font>saving components<font color="#000080">.  </font><font color="#FF0000"><b>To do </b></font>so<font color="#000080">,
</font>you will need <font color="#FF0000"><b>to </b></font>take a look at the TFiler components<font color="#000080">, </font>TReader <font color="#FF0000"><b>and
</b></font>TWriter<font color="#000080">.

</font>Oh<font color="#000080">!  </font>One other note <font color="#000080">-- </font>ReadComponent <font color="#FF0000"><b>and </b></font>WriteComponent will only
work <font color="#FF0000"><b>with </b></font>components that have been registered <font color="#FF0000"><b>with </b></font>a call <font color="#FF0000"><b>to
</b></font>RegisterClass <font color="#FF0000"><b>or </b></font>RegisterClasses<font color="#000080">.  </font>It <font color="#FF0000"><b>uses </b></font>the list <font color="#FF0000"><b>of </b></font>registered
classes <font color="#FF0000"><b>as </b></font>a look<font color="#000080">-</font>up table <font color="#FF0000"><b>to </b></font>determine how <font color="#FF0000"><b>to </b></font>recreate what <font color="#FF0000"><b>is
</b></font>stored <font color="#FF0000"><b>in </b></font>the stream<font color="#000080">.  </font>Unforutnately<font color="#000080">, </font>Delphi does <font color="#FF0000"><b>not </b></font>automatically
<font color="#FF0000"><b>register </b></font>classes<font color="#000080">.  </font>So<font color="#000080">, </font>you must already have some idea ahead <font color="#FF0000"><b>of
</b></font>time about what kinds <font color="#FF0000"><b>of </b></font>controls may be read <font color="#FF0000"><b>and </b></font>written<font color="#000080">.  </font>Make
a call <font color="#FF0000"><b>to </b></font>RegisterClasses once during application start<font color="#000080">-</font>up <font color="#000080">--
</font>something like<font color="#000080">:

  </font>RegisterClasses<font color="#000080">([</font>TButton<font color="#000080">, </font>TEdit<font color="#000080">, </font>TListBox<font color="#000080">, </font>TMemo<font color="#000080">, </font>TForm1<font color="#000080">]);

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0083.PAS">Original</a><b>]</b></p></body>
</html>
