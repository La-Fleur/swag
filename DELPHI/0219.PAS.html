<html>
<head><title> "Direct write to network printer" by PETER VAN LONKHUYZEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0219.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>unit </b></font>Rawprint<font color="#000080">;

</font><font color="#FF0000"><b>interface
uses </b></font>printers<font color="#000080">,</font>windows<font color="#000080">;

</font><font color="#FF0000"><b>type </b></font>TRawprinter <font color="#000080">=</font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TPrinter<font color="#000080">)
                  </font><font color="#FF0000"><b>public
                    </b></font>dc2 <font color="#000080">: </font>HDC<font color="#000080">;
                    </font>aborted <font color="#000080">: </font>boolean<font color="#000080">;
                    </font>printing <font color="#000080">: </font>boolean<font color="#000080">;
                    </font>lasttime <font color="#000080">: </font>integer<font color="#000080">;
                    </font><font color="#FF0000"><b>procedure </b></font>abort<font color="#000080">;
                    </font><font color="#FF0000"><b>function </b></font>startraw <font color="#000080">: </font>boolean<font color="#000080">;
                    </font><font color="#FF0000"><b>function </b></font>endraw<font color="#000080">: </font>boolean<font color="#000080">;
                    </font><font color="#FF0000"><b>function </b></font>write<font color="#000080">(</font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">): </font>boolean<font color="#000080">;
                    </font><font color="#FF0000"><b>function </b></font>writeln<font color="#000080">: </font>boolean<font color="#000080">;
                    </font><font color="#FF0000"><b>destructor </b></font>destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
                    </font><font color="#FF0000"><b>procedure </b></font>settimer<font color="#000080">;
                    </font><font color="#FF0000"><b>function </b></font>printerror <font color="#000080">: </font>boolean<font color="#000080">;
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>implementation
uses </b></font>sysutils<font color="#000080">,</font>forms<font color="#000080">,</font>dialogs<font color="#000080">,</font>controls<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRawPrinter<font color="#000080">.</font>settimer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>lasttime<font color="#000080">:=</font>gettickcount<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TRawPrinter<font color="#000080">.</font>printerror <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>r <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>result<font color="#000080">:=</font>false<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>gettickcount<font color="#000080">&gt;</font>lasttime<font color="#000080">+</font><font color="#800000">15000</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>gettickcount<font color="#000080">&lt;</font>lasttime<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>r<font color="#000080">:=</font>messagedlg<font color="#000080">(</font><font color="#800000">'Error '</font><font color="#000080">+</font>inttostr<font color="#000080">(</font>getlasterror<font color="#000080">)+</font><font color="#800000">' Printing on '</font><font color="#000080">+</font>printers<font color="#000080">[</font>printerindex<font color="#000080">],</font>mterror<font color="#000080">,[</font>mbretry<font color="#000080">,</font>mbabort<font color="#000080">,</font>mbignore<font color="#000080">],</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>r<font color="#000080">=</font>mrretry <font color="#FF0000"><b>then
      </b></font>result<font color="#000080">:=</font>false
    <font color="#FF0000"><b>else
    begin
      </b></font>result<font color="#000080">:=</font>true<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>r<font color="#000080">=</font>mrabort <font color="#FF0000"><b>then
        </b></font>abort<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>settimer<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TRawPrinter<font color="#000080">.</font>abort<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>abortdoc<font color="#000080">(</font>dc2<font color="#000080">);
  </font>endraw<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>AbortProc<font color="#000080">(</font>Prn<font color="#000080">: </font>HDC<font color="#000080">; </font>Error<font color="#000080">: </font>Integer<font color="#000080">): </font>Bool<font color="#000080">; </font><font color="#FF0000"><b>stdcall</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Application<font color="#000080">.</font>ProcessMessages<font color="#000080">;
  </font>Result <font color="#000080">:= </font><font color="#FF0000"><b>not </b></font>TRawprinter<font color="#000080">(</font>Printer<font color="#000080">).</font>Aborted<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TPrinterDevice <font color="#000080">= </font><font color="#FF0000"><b>class
    </b></font>Driver<font color="#000080">, </font>Device<font color="#000080">, </font>Port<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Create<font color="#000080">(</font>ADriver<font color="#000080">, </font>ADevice<font color="#000080">, </font>APort<font color="#000080">: </font>PChar<font color="#000080">);
    </font><font color="#FF0000"><b>function </b></font>IsEqual<font color="#000080">(</font>ADriver<font color="#000080">, </font>ADevice<font color="#000080">, </font>APort<font color="#000080">: </font>PChar<font color="#000080">): </font>Boolean<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>constructor </b></font>TPrinterDevice<font color="#000080">.</font>Create<font color="#000080">(</font>ADriver<font color="#000080">, </font>ADevice<font color="#000080">, </font>APort<font color="#000080">: </font>PChar<font color="#000080">);
</font><font color="#FF0000"><b>begin
  inherited </b></font>Create<font color="#000080">;
  </font>Driver <font color="#000080">:= </font>ADriver<font color="#000080">;
  </font>Device <font color="#000080">:= </font>ADevice<font color="#000080">;
  </font>Port <font color="#000080">:= </font>APort<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TPrinterDevice<font color="#000080">.</font>IsEqual<font color="#000080">(</font>ADriver<font color="#000080">, </font>ADevice<font color="#000080">, </font>APort<font color="#000080">: </font>PChar<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:= (</font>Device <font color="#000080">= </font>ADevice<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Port <font color="#000080">= </font>APort<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>destructor </b></font>TRawprinter<font color="#000080">.</font>destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>dc2<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>deletedc<font color="#000080">(</font>dc2<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TRawprinter<font color="#000080">.</font>startraw<font color="#000080">:</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>CTitle<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>CMode <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>DocInfo<font color="#000080">: </font>TDocInfo<font color="#000080">;
  </font>r <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>result<font color="#000080">:=</font>false<font color="#000080">;
  </font>StrPLCopy<font color="#000080">(</font>CTitle<font color="#000080">, </font>Title<font color="#000080">, </font>SizeOf<font color="#000080">(</font>CTitle<font color="#000080">) - </font><font color="#800000">1</font><font color="#000080">);
  </font>StrPCopy<font color="#000080">(</font>CMode<font color="#000080">, </font><font color="#800000">'RAW'</font><font color="#000080">);
  </font>FillChar<font color="#000080">(</font>DocInfo<font color="#000080">, </font>SizeOf<font color="#000080">(</font>DocInfo<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>with </b></font>DocInfo <font color="#FF0000"><b>do
  begin
    </b></font>cbSize <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>DocInfo<font color="#000080">);
    </font>lpszDocName <font color="#000080">:= </font>CTitle<font color="#000080">;
    </font>lpszOutput <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
    </font>lpszDatatype <font color="#000080">:=</font>CMode<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>with </b></font>TPrinterDevice<font color="#000080">(</font>Printers<font color="#000080">.</font>Objects<font color="#000080">[</font>PrinterIndex<font color="#000080">]) </font><font color="#FF0000"><b>do
  begin
    if </b></font>dc2<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>DC2 <font color="#000080">:= </font>CreateDC<font color="#000080">(</font>PChar<font color="#000080">(</font>Driver<font color="#000080">), </font>PChar<font color="#000080">(</font>Device<font color="#000080">), </font>PChar<font color="#000080">(</font>Port<font color="#000080">), </font><font color="#FF0000"><b>nil</b></font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>dc2<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        </b></font>result<font color="#000080">:=</font>false<font color="#000080">;
        </font>exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>SetAbortProc<font color="#000080">(</font>dc2<font color="#000080">, </font>AbortProc<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>settimer<font color="#000080">;
  </font>aborted<font color="#000080">:=</font>false<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>application<font color="#000080">.</font>processmessages<font color="#000080">;
  </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>StartDoc<font color="#000080">(</font>dc2<font color="#000080">, </font>DocInfo<font color="#000080">)&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>printerror<font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>aborted <font color="#FF0000"><b>then
    </b></font>printing<font color="#000080">:=</font>true<font color="#000080">;
  </font>result<font color="#000080">:=</font>printing<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TRawprinter<font color="#000080">.</font>endraw <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>settimer<font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>aborted <font color="#FF0000"><b>and </b></font>printing <font color="#FF0000"><b>then
  repeat
    </b></font>application<font color="#000080">.</font>processmessages<font color="#000080">;
  </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>windows<font color="#000080">.</font>enddoc<font color="#000080">(</font>dc2<font color="#000080">)&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>printerror<font color="#000080">;
  </font>printing<font color="#000080">:=</font>false<font color="#000080">;
  </font>result<font color="#000080">:=</font><font color="#FF0000"><b>not </b></font>aborted<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>type </b></font>passrec <font color="#000080">= </font><font color="#FF0000"><b>packed record
                 </b></font>l <font color="#000080">: </font>word<font color="#000080">;
                 </font>s <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>pass <font color="#000080">: </font>Passrec<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>TRawprinter<font color="#000080">.</font>write<font color="#000080">(</font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>tmp <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>result<font color="#000080">:=</font>false<font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>aborted <font color="#FF0000"><b>and </b></font>printing <font color="#FF0000"><b>then
  while </b></font>s<font color="#000080">&lt;&gt;</font><font color="#800000">'' </font><font color="#FF0000"><b>do
  begin
    </b></font>result<font color="#000080">:=</font>false<font color="#000080">;
    </font>tmp<font color="#000080">:=</font>copy<font color="#000080">(</font>s<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">);
    </font>delete<font color="#000080">(</font>s<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">255</font><font color="#000080">);
    </font>pass<font color="#000080">.</font>l<font color="#000080">:=</font>length<font color="#000080">(</font>tmp<font color="#000080">);
    </font>strpcopy<font color="#000080">(</font>pass<font color="#000080">.</font>s<font color="#000080">,</font>tmp<font color="#000080">);
    </font>settimer<font color="#000080">;
    </font><font color="#FF0000"><b>repeat
      </b></font>application<font color="#000080">.</font>processmessages
    <font color="#FF0000"><b>until </b></font><font color="#000080">(</font>escape<font color="#000080">(</font>dc2<font color="#000080">,</font>PASSTHROUGH<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,@</font>pass<font color="#000080">,</font><font color="#FF0000"><b>nil</b></font><font color="#000080">)&gt;=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>printerror<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>aborted <font color="#FF0000"><b>then
      </b></font>break<font color="#000080">;
    </font>result<font color="#000080">:=</font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TRawprinter<font color="#000080">.</font>writeln <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>pass<font color="#000080">.</font>l<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">;
  </font>strpcopy<font color="#000080">(</font>pass<font color="#000080">.</font>s<font color="#000080">,</font><font color="#800000">#13#10</font><font color="#000080">);
  </font>settimer<font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    </b></font>application<font color="#000080">.</font>processmessages
  <font color="#FF0000"><b>until </b></font><font color="#000080">(</font>escape<font color="#000080">(</font>dc2<font color="#000080">,</font>PASSTHROUGH<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,@</font>pass<font color="#000080">,</font><font color="#FF0000"><b>nil</b></font><font color="#000080">)&gt;=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>printerror<font color="#000080">;
  </font>result<font color="#000080">:=</font><font color="#FF0000"><b>not </b></font>aborted<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0219.PAS">Original</a><b>]</b></p></body>
</html>
