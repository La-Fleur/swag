<html>
<head><title> "ShellExecute in Delphi2/NT" by STEVE TEIXEIRA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0136.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
&gt; David Swaddle &lt;100657.155@CompuServe.COM&gt; wrote:
&gt;
&gt; &gt;Can anyone suggest a method of running an MS DOS applications
&gt; &gt;(yuck) from within Delphi 2 where the program can be forced to
&gt; &gt;wait for the DOS process to finish before resuming??
&gt;
&gt; &gt;I know that this sounds like an odd request, but I have a legacy
&gt; &gt;EXE file without the source and it runs a vital part of a system
&gt; &gt;that I'm writing.  Previously I used the TExecFile component, but
&gt; &gt;I don't have the source for this.  I have tried using the
&gt; &gt;ShellExecute API call and this works fine, except that I can't
&gt; &gt;find a way of waiting to see if the new process has terminated.
&gt;
&gt; &gt;I'm not very au fait with the Win32 API yet, so any help
&gt; &gt;appreciated.
&gt; This works in 1.0 and should work in 2.0


&gt; var
&gt;    AppHandle : THandle;
&gt; 
&gt; begin
&gt;    AppHandle := ShellExecute(Application.MainForm.Handlle, 'OPEN',
&gt; EXEName, Params, 'C:\PROGRAMS', SW_SHOWNORMAL);
&gt; 
&gt;    if AppHandle &lt;= 32 then { Error Running Program}
&gt;       raise Exception.Create('There was a problem Running the App');
&gt; 
&gt;    while (GetModuleUsage(AppHandle) = 0) do
&gt;       Application.ProcessMessages;
&gt; end;
&gt;
&gt; Brad Huggins

That code will not work in Delphi 2.0 because the GetModuleUsage function
doesn't exist under Win32.  You can get this behavior, however, using the
Win32 CreateProcess function.  Here is a function I use to wait for another
program to finish execution:
*)

</i></font><font color="#FF0000"><b>function </b></font>CreateProcessAndWait<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>AppPath<font color="#000080">, </font>AppParams<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                              </font>Visibility<font color="#000080">: </font>word<font color="#000080">): </font>DWord<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>SI<font color="#000080">: </font>TStartupInfo<font color="#000080">;
  </font>PI<font color="#000080">: </font>TProcessInformation<font color="#000080">;
  </font>Proc<font color="#000080">: </font>THandle<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FillChar<font color="#000080">(</font>SI<font color="#000080">, </font>SizeOf<font color="#000080">(</font>SI<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font>SI<font color="#000080">.</font>cb <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>SI<font color="#000080">);
  </font>SI<font color="#000080">.</font>wShowWindow <font color="#000080">:= </font>Visibility<font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>CreateProcess<font color="#000080">(</font>PChar<font color="#000080">(</font>AppPath<font color="#000080">), </font>PChar<font color="#000080">(</font>AppParams<font color="#000080">), </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">, </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">, </font>False<font color="#000080">,
                   </font>Normal_Priority_Class<font color="#000080">, </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">, </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">, </font>SI<font color="#000080">, </font>PI<font color="#000080">) </font><font color="#FF0000"><b>then
    raise </b></font>Exception<font color="#000080">.</font>CreateFmt<font color="#000080">(</font><font color="#800000">'Failed to execute program.  Error Code %d'</font><font color="#000080">,
                              [</font>GetLastError<font color="#000080">]);
  </font>Proc <font color="#000080">:= </font>PI<font color="#000080">.</font>hProcess<font color="#000080">;
  </font>CloseHandle<font color="#000080">(</font>PI<font color="#000080">.</font>hThread<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>WaitForSingleObject<font color="#000080">(</font>Proc<font color="#000080">, </font>Infinite<font color="#000080">) &lt;&gt; </font>Wait_Failed <font color="#FF0000"><b>then
    </b></font>GetExitCodeProcess<font color="#000080">(</font>Proc<font color="#000080">, </font>Result<font color="#000080">);
  </font>CloseHandle<font color="#000080">(</font>Proc<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0136.PAS">Original</a><b>]</b></p></body>
</html>
