<html>
<head><title> "Components in a DBGrid" by VARIOUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0422.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">Dropdownlist <font color="#FF0000"><b>in </b></font>a DBGrid<font color="#000080">, </font>HOW <font color="#000080">?
</font>From<font color="#000080">: </font>Susan <font color="#000080">&lt;</font>terminal<font color="#000080">@</font>meinc<font color="#000080">.</font>com<font color="#000080">&gt;

</font>Q<font color="#000080">: </font>How <font color="#FF0000"><b>do </b></font>I put components into a TDBGrid<font color="#000080">?

</font>A<font color="#000080">: </font>I saw this <font color="#FF0000"><b>on </b></font>compuserve <font color="#FF0000"><b>and </b></font>it <font color="#FF0000"><b>is </b></font>great<font color="#000080">!

</font>HOW <font color="#FF0000"><b>TO </b></font>PUT COMPONENTS INTO A GRID
This article <font color="#FF0000"><b>and </b></font>the accompanying code shows how <font color="#FF0000"><b>to </b></font>put just about any component into a cell <font color="#FF0000"><b>on </b></font>a grid<font color="#000080">. </font>By component I mean anything from a simple combobox <font color="#FF0000"><b>to </b></font>a more complicated dialog box<font color="#000080">. </font>The techniques described below <font color="#FF0000"><b>to </b></font>anything that <font color="#FF0000"><b>is </b></font>termed a visual component<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>you can put it into a form you can probably put it into a grid<font color="#000080">.

</font>There are no new ideas here<font color="#000080">, </font><font color="#FF0000"><b>in </b></font>fact<font color="#000080">, </font>the basic technique simply mimics what the DBGrid does internally<font color="#000080">. </font>The idea <font color="#FF0000"><b>is to </b></font>float a control over the grid<font color="#000080">. </font>Inside DBGrid <font color="#FF0000"><b>is </b></font>a TDBEdit that moves around the grid<font color="#000080">. </font>It<font color="#800000">'s that TDBEdit that you key you data into. The rest of the unfocused cells are really just pictures. What you will learn here, is how to float any type of visual control/component around the grid.

</font>COMPONENT <font color="#800000">#1 </font><font color="#000080">- </font>TDBLOOKUPCOMBO
You need a form <font color="#FF0000"><b>with </b></font>a DBGrid <font color="#FF0000"><b>in </b></font>it<font color="#000080">. </font>So start an new project <font color="#FF0000"><b>and </b></font>drop a DBGrid into the main form<font color="#000080">.

</font>Next drop <font color="#FF0000"><b>in </b></font>a TTable <font color="#FF0000"><b>and set </b></font>it<font color="#800000">'s Alias to DBDEMOS, TableName to GRIDDATA.DB and set the Active property to True. Drop in a DataSource and set it'</font>s DataSet <font color="#FF0000"><b>property to </b></font>point <font color="#FF0000"><b>to </b></font>Table1<font color="#000080">. </font>Go back <font color="#FF0000"><b>to </b></font>the grid <font color="#FF0000"><b>and </b></font>point it<font color="#800000">'s DataSource property to DataSource1. The data from GRIDDATA.DB should appear in your grid..

</font>The first control we are going <font color="#FF0000"><b>to </b></font>put into the grid <font color="#FF0000"><b>is </b></font>a TDBLookupCombo so we need a second table <font color="#FF0000"><b>for </b></font>the lookup<font color="#000080">. </font>Drop a second TTable into the form<font color="#000080">. </font><font color="#FF0000"><b>Set </b></font>it<font color="#800000">'s Alias also to DBDEMOS, TableName to CUSTOMER.DB and Active to True. Drop in a second data source and set its DataSet to Table2.

</font>Now go get a TDBLookupCombo from the Data Controls pallet <font color="#FF0000"><b>and </b></font>drop it any where <font color="#FF0000"><b>on </b></font>the form<font color="#000080">, </font>it doesn<font color="#800000">'t matter where since it will usually be invisible or floating over the grid. Set the LookuoCombo'</font>s properties <font color="#FF0000"><b>as </b></font>follows<font color="#000080">.



--------------------------------------------------------------------------------


        </font>DataSource      DataSource1
        DataField       CustNo
        LookupSource    DataSource2
        LookupField     CustNo
        LookupDisplay   CustNo  <font color="#008000"><i>{you can change it to Company later but keep it custno for now)


--------------------------------------------------------------------------------


So far it's been nothing but boring point and click. Now let's do some coding.

The first thing you need to do is make sure that DBLookupCombo you put into the form is invisible when you run the app. So select Form1 into Object Inspector goto the Events tab and double click on the onCreate event. You should now have the shell for the onCreate event displayed on your screen.



--------------------------------------------------------------------------------


procedure TForm1.FormCreate(Sender: TObject);
begin

end;


--------------------------------------------------------------------------------


Set the LookupCombo's visible property to False as follows.



--------------------------------------------------------------------------------


procedure TForm1.FormCreate(Sender: TObject);
begin
  DBLookupCombo1.Visible := False;
end;


--------------------------------------------------------------------------------


Those of you who are paying attention are probably asking why I didn't just set this in the Object Inspector for the component. Actually, you could have. Personally, I like to initialize properties that change at run time in the code. I set static properties that don't change as the program runs in the object inspector. I think it makes the code easier to read. 

Now we to be able to move this control around the grid. Specifically we want it to automatically appear as you either cursor or click into the column labeled DBLookupCombo. This involves defining two events for the grid, OnDrawDataCell and OnColExit. First lets do OnDrawDataCell. Double click on the grid's OnDrawDataCell event in the Object Inspector and fill in the code as follows. 



--------------------------------------------------------------------------------


procedure TForm1.DBGrid1DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
begin
  if (gdFocused in State) then
  begin
     if (Field.FieldName = DBLookupCombo1.DataField) then
     begin
       DBLookupCombo1.Left := Rect.Left + DBGrid1.Left;
       DBLookupCombo1.Top := Rect.Top + DBGrid1.top;
       DBLookupCombo1.Width := Rect.Right - Rect.Left;
      { DBLookupCombo1.Height := Rect.Bottom - Rect.Top; }
       </i></font>DBLookupCombo1<font color="#000080">.</font>Visible <font color="#000080">:= </font>True<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>The reasons <font color="#FF0000"><b>for </b></font>the excessive use <font color="#FF0000"><b>begin</b></font><font color="#000080">/</font><font color="#FF0000"><b>end </b></font>will become clear later <font color="#FF0000"><b>in </b></font>the demo<font color="#000080">. </font>The code <font color="#FF0000"><b>is </b></font>saying that <font color="#FF0000"><b>if </b></font>the State parameter <font color="#FF0000"><b>is </b></font>gdFocused <font color="#FF0000"><b>then </b></font>this particular cell <font color="#FF0000"><b>is </b></font>the one highlighted <font color="#FF0000"><b>in </b></font>the grid<font color="#000080">. </font>Further <font color="#FF0000"><b>if </b></font>it<font color="#800000">'s the highlighted cell and the cell has the same field name as the lookup combo'</font>s datafield <font color="#FF0000"><b>then </b></font>we need <font color="#FF0000"><b>to </b></font>move the LookupCombo over that cell <font color="#FF0000"><b>and </b></font>make it visible<font color="#000080">. </font>Notice that the position <font color="#FF0000"><b>is </b></font>determined relative <font color="#FF0000"><b>to </b></font>the form <font color="#FF0000"><b>not to </b></font>just the grid<font color="#000080">. </font>So<font color="#000080">, </font><font color="#FF0000"><b>for </b></font>example<font color="#000080">, </font>the left side <font color="#FF0000"><b>of </b></font>LookupCombo needs <font color="#FF0000"><b>to </b></font>be the offset <font color="#FF0000"><b>of </b></font>the grid <font color="#000080">( </font>DBGrid1<font color="#000080">.</font>Left<font color="#000080">) </font>into the form plus the offset <font color="#FF0000"><b>of </b></font>the cell into the grid <font color="#000080">(</font>Rect<font color="#000080">.</font>Left<font color="#000080">).

</font>Also notice that the Height <font color="#FF0000"><b>of </b></font>the LookupCombo has been commented <font color="#FF0000"><b>out </b></font>above<font color="#000080">. </font>The reason <font color="#FF0000"><b>is </b></font>that the LookupCombo has a minimum height<font color="#000080">. </font>You just can<font color="#800000">'t make it any smaller. That minimum height is larger than the height of the cell. If you un-commented the height line above. Your code would change it and then Delphi would immediately change it right back. It causes an annoying screen flash so don'</font>t fight it<font color="#000080">. </font>Let the LookupCombo be a little larger than the cell<font color="#000080">. </font>It looks a little funny but it works<font color="#000080">.

</font>Now just <font color="#FF0000"><b>for </b></font>fun run the <font color="#FF0000"><b>program</b></font><font color="#000080">. </font>Correct all you missing semi<font color="#000080">-</font>colons etc<font color="#000080">. </font>Once its running <font color="#FF0000"><b>try </b></font>moving the cursor around the grid<font color="#000080">. </font>Pretty cool<font color="#000080">, </font>hu<font color="#000080">? </font><font color="#FF0000"><b>Not</b></font><font color="#000080">! </font>We<font color="#800000">'re only part of the way there. We need to hide the LookupCombo when we leave the column. So define the grid'</font>s onColExit<font color="#000080">. </font>It should look like this<font color="#000080">;



--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1ColExit<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  If </b></font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField <font color="#FF0000"><b>then
    </b></font>DBLookupCombo1<font color="#000080">.</font>Visible <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>This <font color="#FF0000"><b>uses </b></font>the TDBGrids SelectedField <font color="#FF0000"><b>property to </b></font>match up the FieldName associated <font color="#FF0000"><b>with </b></font>the cell <font color="#FF0000"><b>with </b></font>that <font color="#FF0000"><b>of </b></font>the LookupCombo<font color="#000080">. </font>The code says<font color="#000080">, &quot;</font><font color="#FF0000"><b>If </b></font>the cell you are leaving was <font color="#FF0000"><b>in </b></font>the DBLookupCombo column <font color="#FF0000"><b>then </b></font>make it invisible<font color="#000080">&quot;.

</font>Now run it again<font color="#000080">. </font>Was that worth the effort <font color="#FF0000"><b>or </b></font>what<font color="#000080">?

</font>Now things look right but we<font color="#800000">'re still missing one thing. Try typing a new customer number into one of the LookupCombo. The problem is that the keystrokes are going to the grid, not to the LookupCombo. To fix this we need to define a onKeyPress event for the grid. It goes like this;



</font><font color="#000080">--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1KeyPress<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Key<font color="#000080">: </font>Char<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>key <font color="#000080">&lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">)) </font><font color="#FF0000"><b>then
  begin
    if </b></font><font color="#000080">(</font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
    begin

      </b></font>DBLookupCombo1<font color="#000080">.</font>SetFocus<font color="#000080">;
      </font>SendMessage<font color="#000080">(</font>DBLookupCombo1<font color="#000080">.</font>Handle<font color="#000080">, </font>WM_Char<font color="#000080">, </font>word<font color="#000080">(</font>Key<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>This code <font color="#FF0000"><b>is </b></font>saying that <font color="#FF0000"><b>if </b></font>the key pressed <font color="#FF0000"><b>is not </b></font>a tab key <font color="#000080">(</font>Chr<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font>the current field <font color="#FF0000"><b>in </b></font>the grid <font color="#FF0000"><b>is </b></font>the LookupCombo <font color="#FF0000"><b>then set </b></font>the focus <font color="#FF0000"><b>to </b></font>the LookupCombo <font color="#FF0000"><b>and then </b></font>pass the keystroke over <font color="#FF0000"><b>to </b></font>the LookupCombo<font color="#000080">. </font>OK so I had <font color="#FF0000"><b>to </b></font>use a WIN API <font color="#FF0000"><b>function</b></font><font color="#000080">. </font>You don<font color="#800000">'t really need to know how it works just that it works.

</font>But let me explain a bit anyway<font color="#000080">. </font><font color="#FF0000"><b>To </b></font>make Window<font color="#800000">'s SendMessage function work you must give it the handle of the component you want to send the message to. Use the component'</font>s Handle <font color="#FF0000"><b>property</b></font><font color="#000080">. </font>Next it wants <font color="#FF0000"><b>to </b></font>know what the <font color="#FF0000"><b>message is</b></font><font color="#000080">. </font><font color="#FF0000"><b>In </b></font>this <font color="#FF0000"><b>case </b></font>it<font color="#800000">'s Window'</font>s <font color="#FF0000"><b>message </b></font>WM_CHAR which says I<font color="#800000">'m sending the LookupCombo a character. Finally, you need to tell it which character, so word(Key). That'</font>s a typecast <font color="#FF0000"><b>to type </b></font>word <font color="#FF0000"><b>of </b></font>the events Key parameter<font color="#000080">. </font>Clear <font color="#FF0000"><b>as </b></font>mud<font color="#000080">, </font>right<font color="#000080">? </font>All you really need <font color="#FF0000"><b>to </b></font>know <font color="#FF0000"><b>is to </b></font>replace the DBLookupCombo1 <font color="#FF0000"><b>in </b></font>the call <font color="#FF0000"><b>to </b></font>the name <font color="#FF0000"><b>of </b></font>the component your putting into the grid<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>you want more info <font color="#FF0000"><b>on </b></font>SendMessage <font color="#FF0000"><b>do </b></font>a search <font color="#FF0000"><b>in </b></font>Delphi<font color="#800000">'s on-line help.

</font>Now run it again <font color="#FF0000"><b>and try </b></font>typing<font color="#000080">. </font>It works<font color="#000080">! </font>Play <font color="#FF0000"><b>with </b></font>it a bit <font color="#FF0000"><b>and </b></font>see how the tab key gets you <font color="#FF0000"><b>out of </b></font><font color="#000080">&quot;</font>edit mode<font color="#000080">&quot; </font>back into <font color="#000080">&quot;</font>move the cell cursor around mode<font color="#000080">&quot;.

</font>Now go back <font color="#FF0000"><b>to </b></font>the <font color="#FF0000"><b>Object </b></font>Inspector <font color="#FF0000"><b>for </b></font>the DBLookupCombo component <font color="#FF0000"><b>and </b></font>change the LookupDIsplay <font color="#FF0000"><b>property to </b></font>Company<font color="#000080">. </font>Run it<font color="#000080">. </font>Imagine the possibilities<font color="#000080">.

</font>COMPONENT <font color="#800000">#2 </font><font color="#000080">- </font>TDBCOMBO
I<font color="#800000">'m not going to discuss installing the second component, a DBCombo, because I don'</font>t really have anything new <font color="#FF0000"><b>to </b></font>say<font color="#000080">. </font>It<font color="#800000">'s really the same as #1. Here'</font>s the incrementally developed code <font color="#FF0000"><b>for </b></font>your review<font color="#000080">.



--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>DBLookupCombo1<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;
  </font>DBComboBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1DrawDataCell<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>const </b></font>Rect<font color="#000080">: </font>TRect<font color="#000080">;
  </font>Field<font color="#000080">: </font>TField<font color="#000080">; </font>State<font color="#000080">: </font>TGridDrawState<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>gdFocused <font color="#FF0000"><b>in </b></font>State<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
     if </b></font><font color="#000080">(</font>Field<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then

     begin
       </b></font>DBLookupCombo1<font color="#000080">.</font>Left <font color="#000080">:= </font>Rect<font color="#000080">.</font>Left <font color="#000080">+ </font>DBGrid1<font color="#000080">.</font>Left<font color="#000080">;
       </font>DBLookupCombo1<font color="#000080">.</font>Top <font color="#000080">:= </font>Rect<font color="#000080">.</font>Top <font color="#000080">+ </font>DBGrid1<font color="#000080">.</font>top<font color="#000080">;
       </font>DBLookupCombo1<font color="#000080">.</font>Width <font color="#000080">:= </font>Rect<font color="#000080">.</font>Right <font color="#000080">- </font>Rect<font color="#000080">.</font>Left<font color="#000080">;
       </font>DBLookupCombo1<font color="#000080">.</font>Visible <font color="#000080">:= </font>True<font color="#000080">;
     </font><font color="#FF0000"><b>end
     else if </b></font><font color="#000080">(</font>Field<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBComboBox1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
     begin
       </b></font>DBComboBox1<font color="#000080">.</font>Left <font color="#000080">:= </font>Rect<font color="#000080">.</font>Left <font color="#000080">+ </font>DBGrid1<font color="#000080">.</font>Left<font color="#000080">;
       </font>DBComboBox1<font color="#000080">.</font>Top <font color="#000080">:= </font>Rect<font color="#000080">.</font>Top <font color="#000080">+ </font>DBGrid1<font color="#000080">.</font>top<font color="#000080">;
       </font>DBComboBox1<font color="#000080">.</font>Width <font color="#000080">:= </font>Rect<font color="#000080">.</font>Right <font color="#000080">- </font>Rect<font color="#000080">.</font>Left<font color="#000080">;
       </font>DBComboBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>True<font color="#000080">;
     </font><font color="#FF0000"><b>end
  end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1ColExit<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  If </b></font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField <font color="#FF0000"><b>then
    </b></font>DBLookupCombo1<font color="#000080">.</font>Visible <font color="#000080">:= </font>false
  <font color="#FF0000"><b>else If </b></font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBComboBox1<font color="#000080">.</font>DataField <font color="#FF0000"><b>then
    </b></font>DBComboBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1KeyPress<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Key<font color="#000080">: </font>Char<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>key <font color="#000080">&lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">)) </font><font color="#FF0000"><b>then
  begin
    if </b></font><font color="#000080">(</font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
    begin

      </b></font>DBLookupCombo1<font color="#000080">.</font>SetFocus<font color="#000080">;
      </font>SendMessage<font color="#000080">(</font>DBLookupCombo1<font color="#000080">.</font>Handle<font color="#000080">, </font>WM_Char<font color="#000080">, </font>word<font color="#000080">(</font>Key<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
    else if </b></font><font color="#000080">(</font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBComboBox1<font color="#000080">.</font>DataField<font color="#000080">)
</font><font color="#FF0000"><b>then
    begin
      </b></font>DBComboBox1<font color="#000080">.</font>SetFocus<font color="#000080">;
      </font>SendMessage<font color="#000080">(</font>DBComboBox1<font color="#000080">.</font>Handle<font color="#000080">, </font>WM_Char<font color="#000080">, </font>word<font color="#000080">(</font>Key<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>COMPONENT <font color="#800000">#3 </font><font color="#000080">- </font>TDBCHECKBOX
The DBCheckBox gets even more interesting<font color="#000080">. </font><font color="#FF0000"><b>In </b></font>this <font color="#FF0000"><b>case </b></font>it seems appropriate <font color="#FF0000"><b>to </b></font>leave something <font color="#FF0000"><b>in </b></font>the non<font color="#000080">-</font>focused checkbox cells <font color="#FF0000"><b>to </b></font>indicate that there<font color="#800000">'s a check box there. You can either draw the &quot;stay behind&quot; image of the checkbox or you can blast in a picture of the checkbox. I chose to do the latter. I created two BMP files one that'</font>s a picture <font color="#FF0000"><b>of </b></font>the box checked <font color="#000080">(</font>TRUE<font color="#000080">.</font>BMP<font color="#000080">) </font><font color="#FF0000"><b>and </b></font>one that<font color="#800000">'s a picture of the box unchecked (FALSE.BMP). Put two TImage components on the form called ImageTrue and ImageFalse and attach the BMP files to there respective Picture properties. Oh yes you also need to put a DBCheckbox component on the form. Wire it to the CheckBox field in DataSource1 and set the Color property to clWindow. First edit the onCreate so it reads as follows;



</font><font color="#000080">--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>FormCreate<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>DBLookupCombo1<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;
  </font>DBCheckBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;
  </font>DBComboBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;
  </font>ImageTrue<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;
  </font>ImageFalse<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>Now we need <font color="#FF0000"><b>to </b></font>modify the onDrawDataCell <font color="#FF0000"><b>to do </b></font>something <font color="#FF0000"><b>with </b></font>cells that <font color="#FF0000"><b>do not </b></font>have the focus<font color="#000080">. </font>Here comes the code<font color="#000080">.



--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1DrawDataCell<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>const </b></font>Rect<font color="#000080">: </font>TRect<font color="#000080">;
  </font>Field<font color="#000080">: </font>TField<font color="#000080">; </font>State<font color="#000080">: </font>TGridDrawState<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>gdFocused <font color="#FF0000"><b>in </b></font>State<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
     if </b></font><font color="#000080">(</font>Field<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
     begin
        </b></font><font color="#000080">...</font>SEE ABOVE
     <font color="#FF0000"><b>end
     else if </b></font><font color="#000080">(</font>Field<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBCheckBox1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
     begin
       </b></font>DBCheckBox1<font color="#000080">.</font>Left <font color="#000080">:= </font>Rect<font color="#000080">.</font>Left <font color="#000080">+ </font>DBGrid1<font color="#000080">.</font>Left <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
       </font>DBCheckBox1<font color="#000080">.</font>Top <font color="#000080">:= </font>Rect<font color="#000080">.</font>Top <font color="#000080">+ </font>DBGrid1<font color="#000080">.</font>top <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
       </font>DBCheckBox1<font color="#000080">.</font>Width <font color="#000080">:= </font>Rect<font color="#000080">.</font>Right <font color="#000080">- </font>Rect<font color="#000080">.</font>Left<font color="#008000"><i>{ - 1}</i></font><font color="#000080">;
       </font>DBCheckBox1<font color="#000080">.</font>Height <font color="#000080">:= </font>Rect<font color="#000080">.</font>Bottom <font color="#000080">- </font>Rect<font color="#000080">.</font>Top<font color="#008000"><i>{ - 1}</i></font><font color="#000080">;

       </font>DBCheckBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>True<font color="#000080">;
     </font><font color="#FF0000"><b>end
     else if </b></font><font color="#000080">(</font>Field<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBComboBox1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
     begin
        </b></font><font color="#000080">...</font>SEE ABOVE
     <font color="#FF0000"><b>end
  end
  else </b></font><font color="#008000"><i>{in this else area draw any stay behind bit maps}
  </i></font><font color="#FF0000"><b>begin
    if </b></font><font color="#000080">(</font>Field<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBCheckBox1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
     if </b></font>TableGridDataCheckBox<font color="#000080">.</font>AsBoolean <font color="#FF0000"><b>then
       </b></font>DBGrid1<font color="#000080">.</font>Canvas<font color="#000080">.</font>Draw<font color="#000080">(</font>Rect<font color="#000080">.</font>Left<font color="#000080">,</font>Rect<font color="#000080">.</font>Top<font color="#000080">,</font>ImageTrue<font color="#000080">.</font>Picture<font color="#000080">.</font>Bitmap<font color="#000080">)
     </font><font color="#FF0000"><b>else
       </b></font>DBGrid1<font color="#000080">.</font>Canvas<font color="#000080">.</font>Draw<font color="#000080">(</font>Rect<font color="#000080">.</font>Left<font color="#000080">,</font>Rect<font color="#000080">.</font>Top<font color="#000080">,</font>ImageFalse<font color="#000080">.</font>Picture<font color="#000080">.</font>Bitmap<font color="#000080">)
    </font><font color="#FF0000"><b>end
  end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>It<font color="#800000">'s the very last part we'</font>re most interested <font color="#FF0000"><b>in</b></font><font color="#000080">. </font><font color="#FF0000"><b>If </b></font>the state <font color="#FF0000"><b>is not </b></font>gdFocused <font color="#FF0000"><b>and </b></font>the column <font color="#FF0000"><b>in </b></font>CheckBox <font color="#FF0000"><b>then </b></font>this last bit executes<font color="#000080">. </font>All it does <font color="#FF0000"><b>is </b></font>check the value <font color="#FF0000"><b>of </b></font>the data <font color="#FF0000"><b>in </b></font>the field <font color="#FF0000"><b>and if </b></font>it<font color="#800000">'s true it shows the TRUE.BMP otherwise it shows the FALSE.BMP. I created the bit maps so they are indented so you can tell the difference between a focused and unfocused cell. Make onColExit look like this;



</font><font color="#000080">--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1ColExit<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  If </b></font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField <font color="#FF0000"><b>then
    </b></font>DBLookupCombo1<font color="#000080">.</font>Visible <font color="#000080">:= </font>false
  <font color="#FF0000"><b>else If </b></font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBCheckBox1<font color="#000080">.</font>DataField <font color="#FF0000"><b>then
    </b></font>DBCheckBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>false
  <font color="#FF0000"><b>else If </b></font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBComboBox1<font color="#000080">.</font>DataField <font color="#FF0000"><b>then
    </b></font>DBComboBox1<font color="#000080">.</font>Visible <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>Edit onKeyPress <font color="#FF0000"><b>to</b></font><font color="#000080">;



--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1KeyPress<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Key<font color="#000080">: </font>Char<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>key <font color="#000080">&lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">)) </font><font color="#FF0000"><b>then
  begin
    if </b></font><font color="#000080">(</font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBLookupCombo1<font color="#000080">.</font>DataField<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>DBLookupCombo1<font color="#000080">.</font>SetFocus<font color="#000080">;
      </font>SendMessage<font color="#000080">(</font>DBLookupCombo1<font color="#000080">.</font>Handle<font color="#000080">, </font>WM_Char<font color="#000080">, </font>word<font color="#000080">(</font>Key<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
    else if </b></font><font color="#000080">(</font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBCheckBox1<font color="#000080">.</font>DataField<font color="#000080">)
</font><font color="#FF0000"><b>then
    begin
      </b></font>DBCheckBox1<font color="#000080">.</font>SetFocus<font color="#000080">;
      </font>SendMessage<font color="#000080">(</font>DBCheckBox1<font color="#000080">.</font>Handle<font color="#000080">, </font>WM_Char<font color="#000080">, </font>word<font color="#000080">(</font>Key<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
    else if </b></font><font color="#000080">(</font>DBGrid1<font color="#000080">.</font>SelectedField<font color="#000080">.</font>FieldName <font color="#000080">= </font>DBComboBox1<font color="#000080">.</font>DataField<font color="#000080">)
</font><font color="#FF0000"><b>then
    begin
      </b></font>DBComboBox1<font color="#000080">.</font>SetFocus<font color="#000080">;
      </font>SendMessage<font color="#000080">(</font>DBComboBox1<font color="#000080">.</font>Handle<font color="#000080">, </font>WM_Char<font color="#000080">, </font>word<font color="#000080">(</font>Key<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>Finally</b></font><font color="#000080">, </font>here<font color="#800000">'s the last trick. The caption of the checkbox needs to change as the user checks or unchecks the box. My first thought was to do this in the TDBCheckBox'</font>s onChange event<font color="#000080">, </font>the only problem <font color="#FF0000"><b>is </b></font>that it doesn<font color="#800000">'t have one. So I had to go back to the Windows API and send another message. &quot;SendMessage(DBCheckBox1.Handle, BM_GetCheck, 0, 0)&quot; which returns a 0 if the box is unchecked, otherwise it'</font>s checked<font color="#000080">.



--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBCheckBox1Click<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>SendMessage<font color="#000080">(</font>DBCheckBox1<font color="#000080">.</font>Handle<font color="#000080">, </font>BM_GetCheck<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>then
     </b></font>DBCheckBox1<font color="#000080">.</font>Caption <font color="#000080">:= </font><font color="#800000">'  ' </font><font color="#000080">+ </font><font color="#800000">'False'
  </font><font color="#FF0000"><b>else
     </b></font>DBCheckBox1<font color="#000080">.</font>Caption <font color="#000080">:= </font><font color="#800000">'  ' </font><font color="#000080">+ </font><font color="#800000">'True'
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>That<font color="#800000">'s it. Hopefully you learned something. I'</font>ve tried this technique <font color="#FF0000"><b>with </b></font>dialog boxes<font color="#000080">. </font>It works <font color="#FF0000"><b>and </b></font>it<font color="#800000">'s simple. Have fun with it. You don'</font>t really need <font color="#FF0000"><b>to </b></font>completely understand it <font color="#FF0000"><b>as </b></font>long <font color="#FF0000"><b>as </b></font>you know how <font color="#FF0000"><b>to </b></font>edit the code <font color="#FF0000"><b>and </b></font>replace the above component names <font color="#FF0000"><b>with with </b></font>the name <font color="#FF0000"><b>of </b></font>the component you want <font color="#FF0000"><b>to </b></font>drop into the grid<font color="#000080">.

</font>REVISED <font color="#000080">- </font><font color="#800000">7</font><font color="#000080">/</font><font color="#800000">11</font><font color="#000080">/</font><font color="#800000">95
</font>Fred Dalgleish was nice enough <font color="#FF0000"><b>to </b></font>point <font color="#FF0000"><b>out </b></font><font color="#800000">2 </font>stichy points about the Original grid demo<font color="#000080">. </font>First<font color="#000080">, </font>once a component <font color="#FF0000"><b>in </b></font>the grid has the focus it takes <font color="#800000">2 </font>Tab presses <font color="#FF0000"><b>to </b></font>move <font color="#FF0000"><b>to </b></font>the next grid cell<font color="#000080">. </font>The other has <font color="#FF0000"><b>to do with </b></font>adding new records<font color="#000080">.

</font>Problem <font color="#800000"># 1 </font><font color="#000080">- </font>Two Tab Presses Required<font color="#000080">.
</font>A component installed <font color="#FF0000"><b>in </b></font>the grid <font color="#FF0000"><b>is </b></font>actually floating over the top <font color="#FF0000"><b>of </b></font>the grid <font color="#FF0000"><b>and not </b></font>part <font color="#FF0000"><b>of </b></font>the grid it self<font color="#000080">. </font>So when that component has the focus it takes two tab presses <font color="#FF0000"><b>to </b></font>move <font color="#FF0000"><b>to </b></font>the next cell<font color="#000080">. </font>The first tab moves from the floating component <font color="#FF0000"><b>to </b></font>the Grid cell underneath <font color="#FF0000"><b>and </b></font>the second <font color="#FF0000"><b>to </b></font>move <font color="#FF0000"><b>to </b></font>the next grid cell<font color="#000080">. </font><font color="#FF0000"><b>If </b></font>this behavior bugs you heres how <font color="#FF0000"><b>to </b></font>fix it<font color="#000080">.

</font>First <font color="#FF0000"><b>in </b></font>the form that <font color="#FF0000"><b>contains </b></font>grid add <font color="#FF0000"><b>private </b></font>variable called WasInFloater <font color="#FF0000"><b>of type </b></font>boolean<font color="#000080">, </font>like so<font color="#000080">.



--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>type
  </b></font>TForm1 <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
   ...
   ...
  </font><font color="#FF0000"><b>private
    </b></font><font color="#008000"><i>{ Private declarations }
     </i></font>WasInFloater <font color="#000080">: </font>Boolean<font color="#000080">;
   ...
   ...
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>Next create an onEnter event <font color="#FF0000"><b>for </b></font>the LookupCombo where WasInFloater <font color="#FF0000"><b>is set to </b></font>true<font color="#000080">. </font><font color="#FF0000"><b>Then </b></font>point the onEnter event <font color="#FF0000"><b>for </b></font>each component that goes into the grid at this same single onEnter event<font color="#000080">.



--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBLookupCombo1Enter<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>WasInFloater <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>Finally</b></font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>here<font color="#800000">'s the tricky part, define the following onKeyUp event for the grid.



</font><font color="#000080">--------------------------------------------------------------------------------


</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>DBGrid1KeyUp<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Key<font color="#000080">: </font>Word<font color="#000080">;
  </font>Shift<font color="#000080">: </font>TShiftState<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>Key <font color="#FF0000"><b>in </b></font><font color="#000080">[</font>VK_TAB<font color="#000080">]) </font><font color="#FF0000"><b>and </b></font>WasInFloater <font color="#FF0000"><b>then
  begin
    </b></font>SendMessage<font color="#000080">(</font>DBGrid1<font color="#000080">.</font>Handle<font color="#000080">, </font>WM_KeyDown<font color="#000080">, </font>Key<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
    </font>WasInFloater <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


--------------------------------------------------------------------------------


</font>What<font color="#800000">'s happening here is that the grid'</font>s onKeyUp <font color="#FF0000"><b>is </b></font>sending it self a KeyDown when the focus just switched from one <font color="#FF0000"><b>of </b></font>the floating controls<font color="#000080">. </font>This solution handles both tab <font color="#FF0000"><b>and </b></font>shift<font color="#000080">-</font>tab<font color="#000080">.

</font>Problems <font color="#800000">#2 </font><font color="#000080">- </font>New <font color="#FF0000"><b>record </b></font>disappears when component gets focus
The second problem <font color="#FF0000"><b>is </b></font>that <font color="#FF0000"><b>if </b></font>you press add <font color="#FF0000"><b>record on </b></font>the navigator <font color="#FF0000"><b>in </b></font>the demo a new <font color="#FF0000"><b>record is </b></font>added but <font color="#FF0000"><b>then </b></font>when you click <font color="#FF0000"><b>on </b></font>one <font color="#FF0000"><b>of </b></font>the components installed <font color="#FF0000"><b>in </b></font>the grid the new <font color="#FF0000"><b>record </b></font>disappears<font color="#000080">. </font>The reason <font color="#FF0000"><b>for </b></font>this <font color="#FF0000"><b>is </b></font>that there <font color="#FF0000"><b>is </b></font>a strange grid option called dgCancelOnExit which <font color="#FF0000"><b>is </b></font>True by <font color="#FF0000"><b>default</b></font><font color="#000080">. </font><font color="#FF0000"><b>Set </b></font>it <font color="#FF0000"><b>to </b></font>False <font color="#FF0000"><b>and </b></font>the above problem goes away<font color="#000080">.

</font><font color="#FF0000"><b>In </b></font>my opinion Borland should have had this <font color="#FF0000"><b>default set to </b></font>False <font color="#FF0000"><b>to begin with </b></font><font color="#000080">. </font>I find it getting <font color="#FF0000"><b>in </b></font>the way all the time <font color="#FF0000"><b>and </b></font>based <font color="#FF0000"><b>on </b></font>forum messages I<font color="#800000">'m not alone. The option is basically saying that if the grid looses focus then cancel and current edit'</font>s<font color="#000080">! </font>Anyway I<font color="#800000">'ve got it turned off in just about every grid I'</font>ve ever installed<font color="#000080">.

</font>Note<font color="#000080">: </font>This was written by Alec Bergamini<font color="#000080">, </font>at <font color="#800000">75664</font><font color="#000080">,</font><font color="#800000">1224. </font>His companyis <font color="#FF0000"><b>Out </b></font><font color="#000080">&amp; </font>About Productions<font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0422.PAS">Original</a><b>]</b></p></body>
</html>
