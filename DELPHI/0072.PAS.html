<html>
<head><title> "Query By Form for DbGrid components in D" by RICK RUTT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0072.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here is a Delphi unit for a modal dialog to support Query By Form
(QBF) for DbGrid components which receive data from Table components
(not Query components).

The lack of this as a built-in feature makes it harder for Delphi to
compete with more resource-intensive tools like Oracle Forms.
This unit is not as powerful as the built-in QBF features of Oracle
Forms, but it does fill a significant gap in functionality.

Note that the unit is copyrighted, as required by Borland's license,
and as desired by me to retain credit for its development.
Note that the copyright terms allow free use for any purpose.

}

</i></font><font color="#FF0000"><b>unit </b></font>Db_QBF<font color="#000080">;  </font><font color="#008000"><i>{ Database Query By Form -- Version 19950731 }

{ Copyright 1995 by Rick Rutt.
  This work may be used, copied, or distributed by anyone for any purpose,
  provided all copies retain this copyright notice,
  and provided no fee is charged for the contents of this work.
  The author grants permission to anyone to create a derivative work,
  provided each derivative work contains a copyright notice and the notice
  &quot;Portions of this work are based on Db_QBF.PAS as written by Rick Rutt.&quot;
}

{ This unit provides a basic but effective Query By Form service
  for database access applications written using Borland Delphi.
  This unit also provides a similar Sort By Form service.

  The Query By Form service displays a modal dialog box with a StringGrid
  of searchable fields, taken from the calling DbGrid.  The user may
  enter an exact search value for any number of fields, and may use
  drag and drop to rearrange the sort order of the fields.
  (Only the fields that contain search values are relevant to the sort.)
  When the user clicks the dialog's OK button, this unit modifies the
  calling DbGrid's IndexFieldNames property, applies a search range
  (of exact values), and refreshes the data.
  If the user leaves all search values empty, this unit clears the
  calling DbGrid's IndexFieldNames property, clears the search range,
  and refreshes the data.

  The Sort By Form service works in a similar manner, except that it
  does not accept search values from the user.  The user drags and drops
  the field sort order, then clicks the OK button.  This unit modifies
  the calling DbGrid's IndexFieldNames property, clears the search range,
  and refreshes the data.
}

{ Create the corresponding dialog form using the New Form action,
  selecting a Standard Dialog Box.  Place a StringGrid on the form
  (as found in the Additional tab of the component toolbar.
  Set the StringGrid's Height to 161 and its Width to 305.
  Finally, replace the new form's .PAS source with this unit.
}

</i></font><font color="#FF0000"><b>interface

uses </b></font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">, </font>Forms<font color="#000080">, </font>Controls<font color="#000080">, </font>Buttons<font color="#000080">,
  </font>StdCtrls<font color="#000080">, </font>ExtCtrls<font color="#000080">, </font>Grids<font color="#000080">, </font>DBGrids<font color="#000080">;

</font><font color="#008000"><i>{ The following two procedures provide the mechanism for accessing
  the services of this unit.

  Have a button or menu item on the calling form call one of these
  procedures, passing the DbGrid as the argument.  (Remember to add
  &quot;uses Db_QBF;&quot; to the calling form's implementation section.)

  Restriction:  The DbGrid must reference a DataSource that, in turn,
  references a DataSet that is a Table.  This unit does not support
  a DataSet that is a Query, since it has no IndexFieldNames property.
}

</i></font><font color="#FF0000"><b>procedure </b></font>QueryByForm<font color="#000080">(</font>grid<font color="#000080">: </font>TDbGrid<font color="#000080">);

</font><font color="#FF0000"><b>procedure </b></font>SortByForm<font color="#000080">(</font>grid<font color="#000080">: </font>TDbGrid<font color="#000080">);

</font><font color="#008000"><i>{ The following section is managed by the Delphi environment. }

</i></font><font color="#FF0000"><b>type
  </b></font>TdlgQBF <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
    </font>OKBtn<font color="#000080">: </font>TBitBtn<font color="#000080">;
    </font>CancelBtn<font color="#000080">: </font>TBitBtn<font color="#000080">;
    </font>HelpBtn<font color="#000080">: </font>TBitBtn<font color="#000080">;
    </font>gridQBF<font color="#000080">: </font>TStringGrid<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>OKBtnClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>CancelBtnClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
  </font><font color="#FF0000"><b>private
    </b></font><font color="#008000"><i>{ Private declarations }
  </i></font><font color="#FF0000"><b>public
    </b></font><font color="#008000"><i>{ Public declarations }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>dlgQBF<font color="#000080">: </font>TdlgQBF<font color="#000080">;

</font><font color="#FF0000"><b>implementation

</b></font><font color="#008000"><i>{ The following section is managed by the programmer,
  with assistance from the Delphi environment. }

</i></font><font color="#FF0000"><b>uses </b></font>Dialogs<font color="#000080">, </font>Db<font color="#000080">, </font>DbTables<font color="#000080">;

</font><font color="#008000"><i>{$R *.DFM}

</i></font><font color="#FF0000"><b>const
  </b></font>qbfRowHeight <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">;
  </font>qbfColWidth  <font color="#000080">= </font><font color="#800000">150</font><font color="#000080">;

  </font>qbfFieldLabel <font color="#000080">= </font><font color="#800000">'&lt;&lt;Field&gt;&gt;'</font><font color="#000080">;
  </font>qbfValueLabel <font color="#000080">= </font><font color="#800000">'&lt;&lt;Value&gt;&gt;'</font><font color="#000080">;

  </font>qbfQueryCaption <font color="#000080">= </font><font color="#800000">'Query for Table '</font><font color="#000080">;
  </font>qbfSortCaption  <font color="#000080">= </font><font color="#800000">'Sort Order for Table '</font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font><font color="#008000"><i>{ Remember some things for use by the QBF dialog's OK button. }
  </i></font>CallingGrid<font color="#000080">: </font>TDbGrid<font color="#000080">;
  </font>CallingMode<font color="#000080">: (</font>modeQuery<font color="#000080">, </font>modeSort<font color="#000080">);

</font><font color="#FF0000"><b>procedure </b></font>SetupAndShowForm<font color="#000080">;  </font><font color="#008000"><i>{ Called by the two exported procedures }
</i></font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">, </font>j<font color="#000080">, </font>n<font color="#000080">: </font>integer<font color="#000080">;
  </font>tbl<font color="#000080">: </font>TTable<font color="#000080">;
  </font>f<font color="#000080">: </font>TField<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>n <font color="#000080">:= </font>CallingGrid<font color="#000080">.</font>FieldCount<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>n <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin </b></font><font color="#008000"><i>{ Exceptions may be raised instead of showing messages }
    </i></font>MessageDlg<font color="#000080">(
        </font><font color="#800000">'Db_QBF unit called for a DbGrid without any Fields'</font><font color="#000080">,
        </font>mtWarning<font color="#000080">, [</font>mbOK<font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end else if </b></font>CallingGrid<font color="#000080">.</font>DataSource <font color="#000080">= </font><font color="#FF0000"><b>NIL then begin
    </b></font>MessageDlg<font color="#000080">(
        </font><font color="#800000">'Db_QBF unit called for a DbGrid without a DataSource'</font><font color="#000080">,
        </font>mtWarning<font color="#000080">, [</font>mbOK<font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end else if </b></font>CallingGrid<font color="#000080">.</font>DataSource<font color="#000080">.</font>DataSet <font color="#000080">= </font><font color="#FF0000"><b>NIL then begin
    </b></font>MessageDlg<font color="#000080">(
        </font><font color="#800000">'Db_QBF unit called for a DbGrid with a DataSource without a DataSet'</font><font color="#000080">,
        </font>mtWarning<font color="#000080">, [</font>mbOK<font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end else if not </b></font><font color="#000080">(</font>CallingGrid<font color="#000080">.</font>DataSource<font color="#000080">.</font>DataSet <font color="#FF0000"><b>is </b></font>TTable<font color="#000080">) </font><font color="#FF0000"><b>then begin
    </b></font>MessageDlg<font color="#000080">(
        </font><font color="#800000">'Db_QBF unit called for a DbGrid with a DataSource that is not a Table'</font><font color="#000080">,
        </font>mtWarning<font color="#000080">, [</font>mbOK<font color="#000080">], </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end else with </b></font>dlgQBF<font color="#000080">.</font>gridQBF <font color="#FF0000"><b>do begin
    </b></font><font color="#008000"><i>{ These properties can also be set once at design time }
    </i></font>DefaultRowHeight <font color="#000080">:= </font>qbfRowHeight<font color="#000080">;
    </font>Scrollbars <font color="#000080">:= </font>ssVertical<font color="#000080">;
    </font>ColCount <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;  </font><font color="#008000"><i>{ Even the Sort service needs a dummy second column }

    { These properties must be set at run time }
    </i></font>RowCount <font color="#000080">:= </font>Succ<font color="#000080">(</font>n<font color="#000080">);
    </font>Cells<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">] := </font>qbfFieldLabel<font color="#000080">;
    </font>Options <font color="#000080">:= </font>Options <font color="#000080">+ [</font>goRowMoving<font color="#000080">];

    </font>tbl <font color="#000080">:= </font>TTable<font color="#000080">(</font>CallingGrid<font color="#000080">.</font>DataSource<font color="#000080">.</font>DataSet<font color="#000080">);

    </font><font color="#FF0000"><b>if </b></font>CallingMode <font color="#000080">= </font>modeQuery <font color="#FF0000"><b>then begin
      </b></font>dlgQBF<font color="#000080">.</font>Caption <font color="#000080">:= </font>qbfQueryCaption <font color="#000080">+ </font>tbl<font color="#000080">.</font>TableName<font color="#000080">;
      </font>Cells<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">] := </font>qbfValueLabel<font color="#000080">;
      </font>Options <font color="#000080">:= </font>Options <font color="#000080">+ [</font>goEditing<font color="#000080">];  </font><font color="#008000"><i>{ Allow user to enter values }
      </i></font>DefaultColWidth  <font color="#000080">:= </font>qbfColWidth<font color="#000080">;
    </font><font color="#FF0000"><b>end else begin
      </b></font>dlgQBF<font color="#000080">.</font>Caption <font color="#000080">:= </font>qbfSortCaption <font color="#000080">+ </font>tbl<font color="#000080">.</font>TableName<font color="#000080">;
      </font>Cells<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">] := </font><font color="#800000">''</font><font color="#000080">;  </font><font color="#008000"><i>{ Dummy &quot;value&quot; column to allow fixed &quot;field&quot; column }
      </i></font>Options <font color="#000080">:= </font>Options <font color="#000080">- [</font>goEditing<font color="#000080">];  </font><font color="#008000"><i>{ User just reorders the rows }
      </i></font>DefaultColWidth  <font color="#000080">:= (</font><font color="#800000">2 </font><font color="#000080">* </font>qbfColWidth<font color="#000080">);  </font><font color="#008000"><i>{ Shove aside dummy 2nd column }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>j <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;  </font><font color="#008000"><i>{ Actual number of fields shown to user }
    </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>n <font color="#FF0000"><b>do begin
      </b></font>f <font color="#000080">:= </font>CallingGrid<font color="#000080">.</font>Fields<font color="#000080">[</font>Pred<font color="#000080">(</font>i<font color="#000080">)];
      </font><font color="#FF0000"><b>if </b></font>f<font color="#000080">.</font>DataType <font color="#FF0000"><b>in </b></font><font color="#000080">[</font>ftBlob<font color="#000080">,</font>ftBytes<font color="#000080">,</font>ftGraphic<font color="#000080">,</font>ftMemo<font color="#000080">,</font>ftUnknown<font color="#000080">,</font>ftVarBytes<font color="#000080">]
          </font><font color="#FF0000"><b>then  </b></font>RowCount <font color="#000080">:= </font>Pred<font color="#000080">(</font>RowCount<font color="#000080">)  </font><font color="#008000"><i>{ Ignore unsearchable fields }
      </i></font><font color="#FF0000"><b>else begin
        </b></font>Inc<font color="#000080">(</font>j<font color="#000080">);
        </font>Cells<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">,</font>j<font color="#000080">] := </font>f<font color="#000080">.</font>FieldName<font color="#000080">;
        </font>Cells<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">,</font>j<font color="#000080">] := </font><font color="#800000">''</font><font color="#000080">;  </font><font color="#008000"><i>{ Empty search value }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>dlgQBF<font color="#000080">.</font>HelpBtn<font color="#000080">.</font>Visible <font color="#000080">:= </font>False<font color="#000080">;  </font><font color="#008000"><i>{ We haven't implemented Help }
    </i></font>dlgQBF<font color="#000080">.</font>ShowModal<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ with dlgQBF.gridQBF }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>QueryByForm<font color="#000080">(</font>Grid<font color="#000080">: </font>TDbGrid<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>CallingGrid <font color="#000080">:= </font>Grid<font color="#000080">;  </font><font color="#008000"><i>{ Save for use by OK button }
  </i></font>CallingMode <font color="#000080">:= </font>modeQuery<font color="#000080">;
  </font>SetupAndShowForm<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SortByForm<font color="#000080">(</font>Grid<font color="#000080">: </font>TDbGrid<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>CallingGrid <font color="#000080">:= </font>Grid<font color="#000080">;  </font><font color="#008000"><i>{ Save for use by OK button }
  </i></font>CallingMode <font color="#000080">:= </font>modeSort<font color="#000080">;
  </font>SetupAndShowForm<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TdlgQBF<font color="#000080">.</font>CancelBtnClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Just dismiss the dialog, without making changes to the calling grid. }
  </i></font>dlgQBF<font color="#000080">.</font>Hide<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TdlgQBF<font color="#000080">.</font>OKBtnClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>flds<font color="#000080">, </font>sep<font color="#000080">, </font>val<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>i<font color="#000080">, </font>n<font color="#000080">, </font>nfld<font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>flds <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;  </font><font color="#008000"><i>{ List of fields separated by ';'.}
  </i></font>sep  <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;  </font><font color="#008000"><i>{ Becomes ';' after the 1st field is appended. }
  </i></font>nfld <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;   </font><font color="#008000"><i>{ Number of fields in the list. }

  </i></font><font color="#FF0000"><b>with </b></font>dlgQBF<font color="#000080">.</font>gridQBF <font color="#FF0000"><b>do begin
    </b></font>n <font color="#000080">:= </font>Pred<font color="#000080">(</font>RowCount<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>n <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>n <font color="#FF0000"><b>do begin
      </b></font>val <font color="#000080">:= </font>Cells<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">,</font>i<font color="#000080">];  </font><font color="#008000"><i>{ The user-entered search value (if any) }
      </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>CallingMode <font color="#000080">= </font>modeSort<font color="#000080">)
      </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>val <font color="#000080">&lt;&gt; </font><font color="#800000">''</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font>flds <font color="#000080">:= </font>flds <font color="#000080">+ </font>sep <font color="#000080">+ </font>Cells<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">,</font>i<font color="#000080">];
        </font>sep  <font color="#000080">:= </font><font color="#800000">';'</font><font color="#000080">;
        </font>nfld <font color="#000080">:= </font>Succ<font color="#000080">(</font>nfld<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>with </b></font>CallingGrid<font color="#000080">.</font>DataSource<font color="#000080">.</font>DataSet <font color="#FF0000"><b>as </b></font>TTable <font color="#FF0000"><b>do begin
      </b></font>IndexFieldNames <font color="#000080">:= </font>flds<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>CallingMode <font color="#000080">= </font>modeSort<font color="#000080">)
      </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>flds <font color="#000080">= </font><font color="#800000">''</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font>CancelRange<font color="#000080">;
      </font><font color="#FF0000"><b>end else begin
        </b></font>SetRangeStart<font color="#000080">;
        </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>n <font color="#FF0000"><b>do begin
          </b></font>val <font color="#000080">:= </font>Cells<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">,</font>i<font color="#000080">];
          </font><font color="#FF0000"><b>if </b></font>val <font color="#000080">&lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>then begin
            </b></font>FieldByName<font color="#000080">(</font>Cells<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">,</font>i<font color="#000080">]).</font>AsString <font color="#000080">:= </font>val<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font>SetRangeEnd<font color="#000080">;  </font><font color="#008000"><i>{ Set range end to match range start }
        </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>n <font color="#FF0000"><b>do begin
          </b></font>val <font color="#000080">:= </font>Cells<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">,</font>i<font color="#000080">];
          </font><font color="#FF0000"><b>if </b></font>val <font color="#000080">&lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>then begin
            </b></font>FieldByName<font color="#000080">(</font>Cells<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">,</font>i<font color="#000080">]).</font>AsString <font color="#000080">:= </font>val<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font>ApplyRange<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>Refresh<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ with CallingGrid.DataSource.DataSet }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ with dlgQBF.gridQBF }

  </i></font>dlgQBF<font color="#000080">.</font>Hide<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0072.PAS">Original</a><b>]</b></p></body>
</html>
