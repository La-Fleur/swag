<html>
<head><title> "Re: Clipboard and Streams" by MARK JOHNSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>In </b></font>article <font color="#000080">&lt;</font><font color="#800000">684156579</font>wnr<font color="#000080">@</font>spudsoft<font color="#000080">.</font>demon<font color="#000080">.</font>co<font color="#000080">.</font>uk<font color="#000080">&gt;,
   &quot;</font>D<font color="#000080">:</font>DEMONSPOOLMAIL<font color="#000080">&quot; &lt;</font>jt<font color="#000080">@</font>spudsoft<font color="#000080">.</font>demon<font color="#000080">.</font>co<font color="#000080">.</font>uk<font color="#000080">&gt; </font>wrote<font color="#000080">:
&gt;</font>I want <font color="#FF0000"><b>to </b></font>use the clipboard <font color="#FF0000"><b>to </b></font>store data <font color="#FF0000"><b>in </b></font>a proprietry format but I 
<font color="#000080">&gt;</font>would like <font color="#FF0000"><b>to </b></font>just write a single <font color="#FF0000"><b>set of </b></font>routines <font color="#FF0000"><b>to </b></font>input <font color="#FF0000"><b>and </b></font>output 
<font color="#000080">&gt;</font>from streams<font color="#000080">.
&gt;
&gt;</font><font color="#FF0000"><b>Is </b></font>it possible <font color="#FF0000"><b>to set </b></font>up a TMemoryStream <font color="#FF0000"><b>object</b></font><font color="#000080">, </font>fill it <font color="#FF0000"><b>with </b></font>the data 
<font color="#000080">&gt;</font><font color="#FF0000"><b>and then </b></font>give it <font color="#FF0000"><b>to </b></font>the clipboard<font color="#000080">?
&gt;</font><font color="#FF0000"><b>If </b></font>so<font color="#000080">, </font>how<font color="#000080">?

</font><font color="#FF0000"><b>Not </b></font>only <font color="#FF0000"><b>is </b></font>it possible<font color="#000080">, </font>but this <font color="#FF0000"><b>is </b></font>exactly how Borland implemented
the Clipboard<font color="#000080">.</font>GetComponent <font color="#FF0000"><b>and </b></font>Clipboard<font color="#000080">.</font>SetComponent functions<font color="#000080">.
</font>Basically<font color="#000080">, </font>you would need <font color="#FF0000"><b>to register </b></font>your own clipboard format
<font color="#FF0000"><b>with </b></font>a call <font color="#FF0000"><b>to </b></font>RegisterClipboardFormat<font color="#000080">():

</font>CF_MYFORMAT <font color="#000080">:= </font>RegisterClipboardFormat<font color="#000080">(</font><font color="#800000">'My Format Description'</font><font color="#000080">);

</font>You would <font color="#FF0000"><b>then </b></font>follow these steps<font color="#000080">:
</font><font color="#800000">1. </font>Create a memory stream <font color="#000080">&amp; </font>write your data <font color="#FF0000"><b>to </b></font>it<font color="#000080">.
</font><font color="#800000">2. </font>Create a global memory buffer <font color="#FF0000"><b>and </b></font>copy the stream into it<font color="#000080">.
</font><font color="#800000">3. </font>Call Clipboard<font color="#000080">.</font>SetAsHandle<font color="#000080">() </font><font color="#FF0000"><b>to </b></font>place it <font color="#FF0000"><b>on </b></font>the clipboard<font color="#000080">.

</font>Example<font color="#000080">:

</font><font color="#FF0000"><b>var
  </b></font>hbuf    <font color="#000080">: </font>THandle<font color="#000080">;
  </font>bufptr  <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>mstream <font color="#000080">: </font>TMemoryStream<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>mstream <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
  </font><font color="#FF0000"><b>try
    </b></font><font color="#008000"><i>{-- Write your data to the stream. --}
    </i></font>hbuf <font color="#000080">:= </font>GlobalAlloc<font color="#000080">(</font>GMEM_MOVEABLE<font color="#000080">, </font>mstream<font color="#000080">.</font>size<font color="#000080">);
    </font><font color="#FF0000"><b>try
      </b></font>bufptr <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>hbuf<font color="#000080">);
      </font><font color="#FF0000"><b>try
        </b></font>Move<font color="#000080">(</font>mstream<font color="#000080">.</font>Memory<font color="#000080">^, </font>bufptr<font color="#000080">^, </font>mstream<font color="#000080">.</font>size<font color="#000080">);
        </font>Clipboard<font color="#000080">.</font>SetAsHandle<font color="#000080">(</font>CF_MYFORMAT<font color="#000080">, </font>hbuf<font color="#000080">);
      </font><font color="#FF0000"><b>finally
        </b></font>GlobalUnlock<font color="#000080">(</font>hbuf<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>except
      </b></font>GlobalFree<font color="#000080">(</font>hbuf<font color="#000080">);
      </font><font color="#FF0000"><b>raise</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>finally
    </b></font>mstream<font color="#000080">.</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>IMPORTANT<font color="#000080">: </font><font color="#FF0000"><b>Do not </b></font>delete the buffer you GlobalAlloc<font color="#000080">().  </font>Once you
put it <font color="#FF0000"><b>on </b></font>the clipboard<font color="#000080">, </font>it<font color="#800000">'s up to the clipboard to dispose of
</font>it<font color="#000080">.  </font>When retrieving it<font color="#000080">, </font>again<font color="#000080">, </font><font color="#FF0000"><b>do not </b></font>delete the buffer you
retrieve <font color="#000080">-- </font>just make a copy <font color="#FF0000"><b>of </b></font>the contents<font color="#000080">.

</font><font color="#FF0000"><b>To </b></font>retrieve the stream <font color="#FF0000"><b>and </b></font>its data<font color="#000080">, </font><font color="#FF0000"><b>do </b></font>something like this<font color="#000080">:

</font><font color="#FF0000"><b>var
  </b></font>hbuf    <font color="#000080">: </font>THandle<font color="#000080">;
  </font>bufptr  <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>mstream <font color="#000080">: </font>TMemoryStream<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>hbuf <font color="#000080">:= </font>Clipboard<font color="#000080">.</font>GetAsHandle<font color="#000080">(</font>CF_MYFORMAT<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>hbuf <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font>bufptr <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>hbuf<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>bufptr <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
      try
        </b></font>mstream <font color="#000080">:= </font>TMemoryStream<font color="#000080">.</font>Create<font color="#000080">;
        </font><font color="#FF0000"><b>try
          </b></font>mstream<font color="#000080">.</font>WriteBuffer<font color="#000080">(</font>bufptr<font color="#000080">^, </font>GlobalSize<font color="#000080">(</font>hbuf<font color="#000080">));
          </font>mstream<font color="#000080">.</font>Position <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#008000"><i>{-- Read your data from the stream. --}
        </i></font><font color="#FF0000"><b>finally
          </b></font>mstream<font color="#000080">.</font>Free<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>finally
        </b></font>GlobalUnlock<font color="#000080">(</font>hbuf<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p></body>
</html>
