<html>
<head><title> "Com ports in Delphi 2.0" by KEITH ANDERSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0185.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000080">&gt;</font>What I need <font color="#FF0000"><b>to do is </b></font>write an arbitrary number <font color="#FF0000"><b>of </b></font>bytes <font color="#FF0000"><b>to </b></font>a serial
<font color="#000080">&gt;</font>port<font color="#000080">.  </font>Period<font color="#000080">.  </font>No modem commands<font color="#000080">, </font>no acknowledgement from the
<font color="#000080">&gt;</font>distant <font color="#FF0000"><b>end of </b></font>the serial line<font color="#000080">, </font>no reading <font color="#FF0000"><b>of </b></font>the port <font color="#000080">(</font>at least<font color="#000080">, </font><font color="#FF0000"><b>not
</b></font><font color="#000080">&gt;</font>yet<font color="#000080">), </font>no nothing <font color="#FF0000"><b>except FOR </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>TO </b></font>X <font color="#FF0000"><b>DO </b></font>Send<font color="#000080">(</font>AByte<font color="#000080">);

</font>Well<font color="#000080">, </font>that<font color="#800000">'s an easy task in D2.  Here is how you open the port:

  </font><font color="#FF0000"><b>Var </b></font>Port<font color="#000080">:</font><font color="#FF0000"><b>STRING</b></font><font color="#000080">;  </font>Handle<font color="#000080">:</font>INTEGER<font color="#000080">;

  </font>Port<font color="#000080">:=</font><font color="#800000">'COM2'</font><font color="#000080">;  </font><font color="#008000"><i>// or whatever COM port
  </i></font>Handle<font color="#000080">:=</font>CreateFile<font color="#000080">(</font>PChar<font color="#000080">(</font>Port<font color="#000080">),</font>GENERIC_READ<font color="#000080">+</font>GENERIC_WRITE<font color="#000080">,
                               </font><font color="#800000">0</font><font color="#000080">,</font><font color="#FF0000"><b>nil</b></font><font color="#000080">,</font>OPEN_EXISTING<font color="#000080">,</font>FILE_ATTRIBUTE_NORMAL<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>Handle<font color="#000080">=</font>INVALID_HANDLE_VALUE <font color="#FF0000"><b>then </b></font>exit<font color="#000080">; </font><font color="#008000"><i>// handle the error if it didn't open

  </i></font>SetupComm<font color="#000080">(</font><font color="#800000">8192</font><font color="#000080">,</font><font color="#800000">8192</font><font color="#000080">);  </font><font color="#008000"><i>// works best if you set the buffer size high

</i></font>Now you write the characters <font color="#FF0000"><b>to </b></font>the port using one <font color="#FF0000"><b>of </b></font>two ways<font color="#000080">...

</font>Using WriteFile<font color="#000080">:

  </font><font color="#FF0000"><b>Var </b></font>DataToSend<font color="#000080">:</font><font color="#FF0000"><b>STRING</b></font><font color="#000080">;  </font>Written<font color="#000080">:</font>DWORD<font color="#000080">;

   </font>WriteFile<font color="#000080">(</font>Handle<font color="#000080">,</font>DataToSend<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>Length<font color="#000080">(</font><font color="#FF0000"><b>String</b></font><font color="#000080">),</font>Written<font color="#000080">,</font><font color="#FF0000"><b>Nil</b></font><font color="#000080">);

</font>The above will use the buffer <font color="#FF0000"><b>to </b></font>send the data<font color="#000080">, </font>so it will return before
the actual data has been sent <font color="#FF0000"><b>to </b></font>the port<font color="#000080">, </font>so be sure <font color="#FF0000"><b>to </b></font>delay a bit
before closing the port so you don<font color="#800000">'t truncate the outgoing data.  The
</font>parameters are Modem handle<font color="#000080">, </font>Where the data <font color="#FF0000"><b>is</b></font><font color="#000080">, </font>The number <font color="#FF0000"><b>of
</b></font>bytes <font color="#FF0000"><b>to </b></font>send<font color="#000080">, </font>Returns the number <font color="#FF0000"><b>of </b></font>bytes actually sent<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>the last
parameter <font color="#FF0000"><b>is if </b></font>you want <font color="#FF0000"><b>to do </b></font>overlapped writes <font color="#000080">(</font>sounds <font color="#FF0000"><b>to </b></font>me like
you don<font color="#800000">'t need to in your situation).

</font>The other way <font color="#FF0000"><b>to </b></font>send data <font color="#FF0000"><b>to </b></font>the port <font color="#FF0000"><b>is

  Var </b></font>K<font color="#000080">:</font>CHAR<font color="#000080">;
  </font><font color="#FF0000"><b>While not </b></font>TransmitCommChar<font color="#000080">(</font>Handle<font color="#000080">,</font>K<font color="#000080">) </font><font color="#FF0000"><b>do </b></font>Application<font color="#000080">.</font>ProcessMessages<font color="#000080">;

</font>This sends one character at a time<font color="#000080">.  </font>TransmitCommChar will return
FALSE <font color="#FF0000"><b>if </b></font>the last character sent hasn<font color="#800000">'t actually gone out the port yet,
</font>so you have <font color="#FF0000"><b>to </b></font>loop like above <font color="#FF0000"><b>to </b></font>send every character<font color="#000080">. </font>It also returns
FALSE <font color="#FF0000"><b>if </b></font>the port hasn<font color="#800000">'t been opened properly, so make sure it was
</font>opened before you get stuck <font color="#FF0000"><b>in </b></font>a loop somewhere<font color="#000080">./

</font>When you are done <font color="#FF0000"><b>with </b></font>the port<font color="#000080">, </font>use

   CloseHandle<font color="#000080">(</font>Handle<font color="#000080">);

</font><font color="#FF0000"><b>To </b></font>close the port <font color="#FF0000"><b>and </b></font>turn off the modem<font color="#000080">.   </font>Make sure you <font color="#FF0000"><b>do </b></font>this
<font color="#FF0000"><b>in </b></font>your error handlers because <font color="#FF0000"><b>if </b></font>the application terminates without
doing this you<font color="#800000">'ll have to reboot your system to get access to the
</font>COM port a second time<font color="#000080">.

</font>I hope this <font color="#FF0000"><b>is </b></font>what you were looking <font color="#FF0000"><b>for</b></font><font color="#000080">.

</font>Regards<font color="#000080">, </font>Keith


</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0185.PAS">Original</a><b>]</b></p></body>
</html>
