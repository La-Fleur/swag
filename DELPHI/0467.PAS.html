<html>
<head><title> "File I/O using Win32" by NEIL BUTTERWORTH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0467.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>//------------------------------------------------------------------------------
// ODFileUnit.Pas								Copyright (C) 1997 Object Dynamics Ltd.
//
// This unit implements classes supporting file I/O using Win32 I/O functions,
// and a &quot;C-like&quot; I/O style. It is intended to be somewhat easier to use than
// the built-in Pascal file I/O mechanisms.
//
//
// 								*** IMPORTANT ***
//
// By using this code, you accept the following conditions:
//
//  	You may use and adapt this code freely, but it remains the
// 	copyright of Object Dynamics Ltd. Any adaptations must retain the
// 	copyright message at the head of this file.
//
//		You use this code at your own risk. Object Dynamics is not responsible
//    for any loss or damage caused by programs using this code.
//
//
// History:
//
//		Version 1.0 Created by Neil Butterworth, September 1997
//    Fixed problems with file create modes, November 1997.
//
//------------------------------------------------------------------------------

</i></font><font color="#FF0000"><b>unit </b></font>ODFileUnit<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
</b></font>	Windows<font color="#000080">,
   </font>Messages<font color="#000080">,
   </font>SysUtils<font color="#000080">,
   </font>Classes<font color="#000080">;

</font><font color="#FF0000"><b>type

</b></font>	<font color="#008000"><i>// Windows file handle
</i></font>	FileHandle <font color="#000080">= </font>integer<font color="#000080">;

   </font><font color="#008000"><i>// All classes raise this exception
</i></font>	FileError <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">( </font>Exception <font color="#000080">);

   </font><font color="#008000"><i>// Raw file modes
   </i></font>FileOpenMode <font color="#000080">= (</font> 	foRead<font color="#000080">,</font>					<font color="#008000"><i>// open file read-only
</i></font>   						foWrite<font color="#000080">,</font>           	<font color="#008000"><i>// open file write-only
                     </i></font>foReadWrite        	<font color="#008000"><i>// open for both
</i></font>   					<font color="#000080">);

   </font>FileShareMode <font color="#000080">= ( </font>fsNoShare<font color="#000080">,           </font><font color="#008000"><i>// file cannot be shared
</i></font>   						fsShareRead<font color="#000080">,</font> 			<font color="#008000"><i>// file can be shared for reading
                     </i></font>fsShareWrite<font color="#000080">,</font> 			<font color="#008000"><i>// file can be shared for writing
                     </i></font>fsShared					<font color="#008000"><i>// file can be shared for any access
</i></font>   					<font color="#000080">);

   </font>FileCreateOption <font color="#000080">= ( </font>fcNew<font color="#000080">,</font> 				<font color="#008000"><i>// always creates a new file
</i></font>   							fcExisting<font color="#000080">,</font> 		<font color="#008000"><i>// file must already exist
                        </i></font>fcAlways          <font color="#008000"><i>// file will be created if it doesn't
</i></font>                        						<font color="#008000"><i>// exist, else it will be opened
                       </i></font><font color="#000080">);

   </font>FileSeekFrom <font color="#000080">= (</font> 	sfStart<font color="#000080">,</font> 				<font color="#008000"><i>// seek from start
</i></font>   						sfEnd<font color="#000080">,</font> 					<font color="#008000"><i>// seek from end
                     </i></font>sfHere 					<font color="#008000"><i>// seek from current position
                   </i></font><font color="#000080">);


</font>	<font color="#008000"><i>// RawFile implements simple binary file with seeking &amp; locking abilities. It
   // is used to implement the other file classes.

   </i></font>RawFile <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">( </font>TObject <font color="#000080">)
</font>		<font color="#FF0000"><b>private
</b></font>      	mFile <font color="#000080">: </font>FileHandle<font color="#000080">;              </font><font color="#008000"><i>// windows file handle
</i></font>			mFileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font>            	<font color="#008000"><i>// full name of file
         </i></font>mIsOpen <font color="#000080">: </font>boolean<font color="#000080">;               </font><font color="#008000"><i>// is it open?

         </i></font><font color="#FF0000"><b>procedure </b></font>Error<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>msg <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">);

</font>   	<font color="#FF0000"><b>public
</b></font>      	<font color="#FF0000"><b>constructor </b></font>Create<font color="#000080">;
</font>			<font color="#FF0000"><b>destructor </b></font>Destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;

         </font><font color="#008000"><i>// Open a file, possibly creating it. See above for the various modes.
         </i></font><font color="#FF0000"><b>procedure </b></font>Open<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>fname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font>         							omode <font color="#000080">: </font>FileOpenMode<font color="#000080">;
                              </font>smode <font color="#000080">: </font>FileShareMode<font color="#000080">;
                              </font>copts <font color="#000080">: </font>FileCreateOption <font color="#000080">);

         </font><font color="#008000"><i>// Read nbytes from file into buffer pointed to by buf. Returns actual
         // number of bytes read, which may be less than nbytes. If the number
         // of bytes read is zero, then the end of file has been reached.
</i></font>   		<font color="#FF0000"><b>function </b></font>Read<font color="#000080">( </font>buf <font color="#000080">: </font>pointer<font color="#000080">;
</font>         					  nbytes <font color="#000080">: </font>integer <font color="#000080">) : </font>integer<font color="#000080">;

         </font><font color="#008000"><i>// Write nbytes to file from buffer pointed to by buf.
         </i></font><font color="#FF0000"><b>procedure </b></font>Write<font color="#000080">( </font>buf <font color="#000080">: </font>pointer<font color="#000080">;
</font>         						nbytes <font color="#000080">: </font>integer <font color="#000080">);

         </font><font color="#008000"><i>// Seek in a file
</i></font>			<font color="#FF0000"><b>function </b></font>Seek<font color="#000080">( </font>moveby <font color="#000080">: </font>integer<font color="#000080">;  </font>from <font color="#000080">: </font>FileSeekFrom <font color="#000080">) : </font>integer<font color="#000080">;

</font>			<font color="#008000"><i>// Return current read/write position in file
         </i></font><font color="#FF0000"><b>function  </b></font>FilePosition <font color="#000080">: </font>integer<font color="#000080">;

         </font><font color="#008000"><i>// Perform region locking/unlocking
</i></font>			<font color="#FF0000"><b>function </b></font>Lock<font color="#000080">( </font>pos<font color="#000080">, </font>len <font color="#000080">: </font>integer <font color="#000080">) : </font>boolean<font color="#000080">;
         </font><font color="#FF0000"><b>procedure </b></font>Unlock<font color="#000080">( </font>pos<font color="#000080">, </font>len <font color="#000080">: </font>integer <font color="#000080">);

         </font><font color="#008000"><i>// Close the file.  It is always safe to call Close, even on an
         // already closed file.
         </i></font><font color="#FF0000"><b>procedure </b></font>Close<font color="#000080">;

         </font><font color="#008000"><i>// Accessors for file name and open state
</i></font>      	<font color="#FF0000"><b>property </b></font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string read </b></font>mFileName<font color="#000080">;
         </font><font color="#FF0000"><b>property </b></font>IsOpen <font color="#000080">: </font>boolean <font color="#FF0000"><b>read </b></font>mIsOpen<font color="#000080">;

</font>	<font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#008000"><i>// Text file buffer. This class is used solely to implement the TextFile class.

</i></font>	TFBuffer <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">( </font>TObject <font color="#000080">)

</font>   	<font color="#FF0000"><b>private
</b></font>      	mBuffer <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[ </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1023 </font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
         </font>mPtr<font color="#000080">, </font>mBytes <font color="#000080">: </font>integer<font color="#000080">;

      </font><font color="#FF0000"><b>public
</b></font>      	<font color="#FF0000"><b>constructor </b></font>Create<font color="#000080">;
         </font><font color="#FF0000"><b>function </b></font>Fill<font color="#000080">( </font>f <font color="#000080">: </font>RawFile <font color="#000080">) : </font>boolean<font color="#000080">;
         </font><font color="#FF0000"><b>function </b></font>GetLine<font color="#000080">( </font>f <font color="#000080">: </font>RawFile<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>line <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">) : </font>boolean<font color="#000080">;
         </font><font color="#FF0000"><b>procedure </b></font>Reset<font color="#000080">;
</font>			<font color="#FF0000"><b>function </b></font>GetChar<font color="#000080">( </font>f <font color="#000080">: </font>RawFile<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>c <font color="#000080">: </font>char <font color="#000080">) : </font>boolean<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


   </font><font color="#008000"><i>// Text file modes
   </i></font>TextFileOpenMode <font color="#000080">= ( </font>toRead<font color="#000080">,</font> 				<font color="#008000"><i>// open for reading
</i></font>   							toReWrite<font color="#000080">,</font> 			<font color="#008000"><i>// open for overwrite existing contents
                        </i></font>toAppend 			<font color="#008000"><i>// open for append to existing contents
                       </i></font><font color="#000080">);

   </font>TextFileShareMode <font color="#000080">= ( </font>smShare<font color="#000080">,         </font><font color="#008000"><i>// open shared (for read only)
                         </i></font>smNoShare        <font color="#008000"><i>// open single user
                        </i></font><font color="#000080">);

   </font><font color="#008000"><i>// The TextFile class implements access to files consisting of lines
   // of text. Text files do not support seeking, and have limited open and
   // sharing modes (see above).

   </i></font>TextFile <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">( </font>TObject <font color="#000080">)

</font>   	<font color="#FF0000"><b>private
</b></font>      	mFile <font color="#000080">: </font>RawFile<font color="#000080">;</font>						<font color="#008000"><i>// implemented via RawFile
         </i></font>mBuffer <font color="#000080">: </font>TFBuffer<font color="#000080">;</font>       			<font color="#008000"><i>// text file buffer

      </i></font><font color="#FF0000"><b>public
</b></font>      	<font color="#FF0000"><b>constructor </b></font>Create<font color="#000080">;
</font>			<font color="#FF0000"><b>destructor </b></font>Destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;

         </font><font color="#008000"><i>// Open a text file
         </i></font><font color="#FF0000"><b>procedure </b></font>Open<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>fname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font>                        	omode <font color="#000080">: </font>TextFileOpenMode<font color="#000080">;
                           </font>smode <font color="#000080">: </font>TextFileShareMode <font color="#000080">);

         </font><font color="#008000"><i>// Close file. Always safe to call, even on already closed files.
         </i></font><font color="#FF0000"><b>procedure </b></font>Close<font color="#000080">;

         </font><font color="#008000"><i>// accessors for RawFile properties
         </i></font><font color="#FF0000"><b>function </b></font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>function </b></font>IsOpen <font color="#000080">: </font>boolean<font color="#000080">;

         </font><font color="#008000"><i>// Write a line of text to file &amp; terminate with CR/LF pair
         </i></font><font color="#FF0000"><b>procedure </b></font>WriteLine<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>line <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">);

         </font><font color="#008000"><i>// Read a line from file, stripping CR/LF pair. Returns False if
         // at end of file.
         </i></font><font color="#FF0000"><b>function </b></font>ReadLine<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>line <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">) : </font>boolean<font color="#000080">;

   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font> 	<font color="#008000"><i>// This class supports random access to fixed-sized records.

   </i></font>RandomAccessFile <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">( </font>TObject <font color="#000080">)

</font>   	<font color="#FF0000"><b>private
</b></font>      	mFile <font color="#000080">: </font>RawFile<font color="#000080">;</font> 						<font color="#008000"><i>// RawFile implementation
</i></font>      	mRecSize <font color="#000080">: </font>integer<font color="#000080">;</font>             	<font color="#008000"><i>// record size

      </i></font><font color="#FF0000"><b>public
</b></font>      	<font color="#FF0000"><b>constructor </b></font>Create<font color="#000080">;
         </font><font color="#FF0000"><b>destructor </b></font>Destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;

         </font><font color="#008000"><i>// Open or create a RandomAccessFile. The RecSize parameter indicates
         // the size of the recoord in the file. This is not stored in the
         // file itself.
         </i></font><font color="#FF0000"><b>procedure </b></font>Open<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>fname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font>         							recsize <font color="#000080">: </font>integer<font color="#000080">;
</font>         							omode <font color="#000080">: </font>FileOpenMode<font color="#000080">;
                              </font>smode <font color="#000080">: </font>FileShareMode<font color="#000080">;
                              </font>copts <font color="#000080">: </font>FileCreateOption <font color="#000080">);

</font> 			<font color="#008000"><i>// Usual stuff
         </i></font><font color="#FF0000"><b>procedure </b></font>Close<font color="#000080">;
         </font><font color="#FF0000"><b>function </b></font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>function </b></font>IsOpen <font color="#000080">: </font>boolean<font color="#000080">;

         </font><font color="#008000"><i>// write a record at record number recno, which must be greater or
         // equal to zero. A record number greater than that of the last
         // record will extend the file.
         </i></font><font color="#FF0000"><b>procedure </b></font>WriteRecord<font color="#000080">( </font>rec <font color="#000080">: </font>pointer<font color="#000080">; </font>recno <font color="#000080">: </font>integer <font color="#000080">);

         </font><font color="#008000"><i>// Read a record. If the record does not exist, the function returns false.
         </i></font><font color="#FF0000"><b>function </b></font>ReadRecord<font color="#000080">( </font>rec <font color="#000080">: </font>pointer<font color="#000080">; </font>recno <font color="#000080">: </font>integer <font color="#000080">) : </font>boolean<font color="#000080">;

         </font><font color="#008000"><i>// read the next record sequentially. The first call to this method must
         // be preceded with a call to ReadRecord.
         </i></font><font color="#FF0000"><b>function </b></font>ReadNextRecord<font color="#000080">( </font>rec <font color="#000080">: </font>pointer <font color="#000080">) : </font>boolean<font color="#000080">;

         </font><font color="#008000"><i>// Record locking
         </i></font><font color="#FF0000"><b>function </b></font>LockRecord<font color="#000080">( </font>recno <font color="#000080">: </font>integer <font color="#000080">) : </font>boolean<font color="#000080">;
         </font><font color="#FF0000"><b>procedure </b></font>UnlockRecord<font color="#000080">( </font>recno <font color="#000080">: </font>integer <font color="#000080">);

         </font><font color="#008000"><i>// Extend the file by count records. The new records will contain garbage.
         </i></font><font color="#FF0000"><b>procedure </b></font>Extend<font color="#000080">( </font>count <font color="#000080">: </font>integer <font color="#000080">);

         </font><font color="#008000"><i>// Return the number of recordsin the file.
         </i></font><font color="#FF0000"><b>function </b></font>RecordCount <font color="#000080">: </font>integer<font color="#000080">;
</font>	<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>//------------------------------------------------------------------------------

</i></font><font color="#FF0000"><b>implementation

type

</b></font>	<font color="#008000"><i>// These declarations are necessary as there seems to be a problem with
   // the Borland-supplied declarations in Windows.Pas, at least in Delphi 2.

</i></font>	LPINTEGER <font color="#000080">= ^</font>integer<font color="#000080">;

</font>	<font color="#FF0000"><b>function </b></font>Win32WriteFile<font color="#000080">( </font>f <font color="#000080">: </font>integer<font color="#000080">; </font>p <font color="#000080">: </font>pointer<font color="#000080">;
</font>   									nb <font color="#000080">: </font>integer<font color="#000080">; </font>nbr <font color="#000080">: </font>LPINTEGER<font color="#000080">;
                              </font>junk <font color="#000080">: </font>pointer <font color="#000080">) : </font>BOOL<font color="#000080">; </font><font color="#FF0000"><b>stdcall</b></font><font color="#000080">;
                              </font><font color="#FF0000"><b>external </b></font>kernel32 name <font color="#800000">'WriteFile'</font><font color="#000080">;

</font>	<font color="#FF0000"><b>function </b></font>Win32ReadFile<font color="#000080">( </font>f <font color="#000080">: </font>integer<font color="#000080">; </font>p <font color="#000080">: </font>pointer<font color="#000080">;
</font>   									nb <font color="#000080">: </font>integer<font color="#000080">; </font>nbr <font color="#000080">: </font>LPINTEGER<font color="#000080">;
                              </font>junk <font color="#000080">: </font>pointer <font color="#000080">) : </font>BOOL<font color="#000080">; </font><font color="#FF0000"><b>stdcall</b></font><font color="#000080">;
                              </font><font color="#FF0000"><b>external </b></font>kernel32 name <font color="#800000">'ReadFile'</font><font color="#000080">;

</font><font color="#FF0000"><b>const

</b></font>	<font color="#008000"><i>// erroor messages
</i></font>	FILE_OPEN_EMSG <font color="#000080">=</font> 			<font color="#800000">'Could not open file'</font><font color="#000080">;
   </font>FILE_NOT_OPEN_EMSG <font color="#000080">=</font> 	<font color="#800000">'File is not open'</font><font color="#000080">;
</font>	BAD_BUFFER_SIZE_EMSG <font color="#000080">=</font> 	<font color="#800000">'Bad buffer size for Read/Write'</font><font color="#000080">;
   </font>READ_FAILED_EMSG <font color="#000080">=</font> 		<font color="#800000">'Read failed'</font><font color="#000080">;
   </font>WRITE_FAILED_EMSG <font color="#000080">=</font> 		<font color="#800000">'Write failed'</font><font color="#000080">;
</font>	SEEK_FAILED_EMSG <font color="#000080">=</font> 		<font color="#800000">'Seek failed'</font><font color="#000080">;
   </font>BAD_TFSHARE_EMSG <font color="#000080">=</font>		<font color="#800000">'Cannot open text file for write in shared mode'</font><font color="#000080">;
   </font>BAD_LOCK_VALUES_EMSG <font color="#000080">=</font>	<font color="#800000">'Bad range values for lock/unlock'</font><font color="#000080">;
</font>	UNLOCK_FAILED_EMSG <font color="#000080">=</font>		<font color="#800000">'Unlock failed!'</font><font color="#000080">;
   </font>BAD_REC_SIZE_EMSG <font color="#000080">=</font>		<font color="#800000">'Record size must be greater than zero'</font><font color="#000080">;
   </font>BAD_REC_NUMBER_EMSG <font color="#000080">=</font> 	<font color="#800000">'Bad record number'</font><font color="#000080">;
   </font>NIL_POINTER_EMSG	<font color="#000080">=</font>		<font color="#800000">'Nil pointer'</font><font color="#000080">;

</font><font color="#008000"><i>//------------------------------------------------------------------------------
// Utility stuff
//------------------------------------------------------------------------------

// replace with assert in Delphi3
</i></font><font color="#FF0000"><b>procedure </b></font>CheckPointer<font color="#000080">( </font>p <font color="#000080">: </font>pointer <font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>p <font color="#000080">= </font><font color="#FF0000"><b>nil </b></font><font color="#000080">) </font><font color="#FF0000"><b>then
      raise </b></font>FileError<font color="#000080">.</font>Create<font color="#000080">( </font>NIL_POINTER_EMSG <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>//------------------------------------------------------------------------------
// RawFile methods
//------------------------------------------------------------------------------

// Create new RawFile
</i></font><font color="#FF0000"><b>constructor </b></font>RawFile<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mFile <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>mIsOpen <font color="#000080">:= </font>false<font color="#000080">;
   </font>mFileName <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Destroy RawFile, closing disk image first.
</i></font><font color="#FF0000"><b>destructor </b></font>RawFile<font color="#000080">.</font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	Close<font color="#000080">;
   </font><font color="#FF0000"><b>inherited </b></font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// RawFile error messaging
</i></font><font color="#FF0000"><b>procedure </b></font>RawFile<font color="#000080">.</font>Error<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>msg <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>raise </b></font>Fileerror<font color="#000080">.</font>CreateFmt<font color="#000080">( </font><font color="#800000">'%s: %s'</font><font color="#000080">, [</font>mFileNAme<font color="#000080">, </font>msg <font color="#000080">] );
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Close RawFile
</i></font><font color="#FF0000"><b>procedure </b></font>RawFile<font color="#000080">.</font>Close<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>mIsOpen <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>		CloseHandle<font color="#000080">( </font>mFile <font color="#000080">);
   </font>mIsOpen <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>// Open RawFile. Most of this is mapping my modes onto Windows modes. Calling
// this on an already open file will Close &amp; then re-open it.
</i></font><font color="#FF0000"><b>procedure </b></font>RawFile<font color="#000080">.</font>Open<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>fname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font>         							omode <font color="#000080">: </font>FileOpenMode<font color="#000080">;
                              </font>smode <font color="#000080">: </font>FileShareMode<font color="#000080">;
                              </font>copts <font color="#000080">: </font>FileCreateOption <font color="#000080">);
</font><font color="#FF0000"><b>var
</b></font>	oflags<font color="#000080">, </font>sflags<font color="#000080">, </font>cflags <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	Close<font color="#000080">;
   </font>mFileName <font color="#000080">:= </font>fname<font color="#000080">;

   </font>oflags <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>sflags <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>cflags <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>omode <font color="#000080">= </font>foRead <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	oflags <font color="#000080">:= </font>GENERIC_READ
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>omode <font color="#000080">= </font>foWrite <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>		oflags <font color="#000080">:= </font>GENERIC_WRITE
   <font color="#FF0000"><b>else
</b></font>   	oflags <font color="#000080">:= </font>GENERIC_READ <font color="#000080">+ </font>GENERIC_WRITE<font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>smode <font color="#000080">= </font>fsShareRead <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	sflags <font color="#000080">:= </font>FILE_SHARE_READ
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>smode <font color="#000080">= </font>fsShareWrite <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	sflags <font color="#000080">:= </font>FILE_SHARE_WRITE
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>smode <font color="#000080">= </font>fsShared <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	sflags <font color="#000080">:= </font>FILE_SHARE_WRITE <font color="#000080">+ </font>FILE_SHARE_READ<font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>copts <font color="#000080">= </font>fcNew <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	cflags <font color="#000080">:= </font>CREATE_ALWAYS
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>copts <font color="#000080">= </font>fcExisting <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>    	cflags <font color="#000080">:= </font>OPEN_EXISTING
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>copts <font color="#000080">= </font>fcAlways <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>    	cflags <font color="#000080">:= </font>OPEN_ALWAYS<font color="#000080">;

      </font>mFile <font color="#000080">:= </font>Windows<font color="#000080">.</font>CreateFile<font color="#000080">( </font>PChar<font color="#000080">( </font>fname <font color="#000080">), </font>oflags<font color="#000080">, </font>sflags<font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>cflags<font color="#000080">,
                                 </font>FILE_ATTRIBUTE_NORMAL<font color="#000080">, </font><font color="#800000">0 </font><font color="#000080">);

</font> 	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>mFile <font color="#000080">= </font>INVALID_HANDLE_VALUE <font color="#000080">) </font><font color="#FF0000"><b>then begin
</b></font>   	mIsOpen <font color="#000080">:= </font>false<font color="#000080">;
      </font>Error<font color="#000080">( </font>FILE_OPEN_EMSG <font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>mIsOpen <font color="#000080">:= </font>true<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Read bytes from file
</i></font><font color="#FF0000"><b>function </b></font>RawFile<font color="#000080">.</font>Read<font color="#000080">( </font>buf <font color="#000080">: </font>pointer<font color="#000080">; </font>nbytes <font color="#000080">: </font>integer <font color="#000080">) : </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	bread <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin

</b></font>	CheckPointer<font color="#000080">( </font>buf <font color="#000080">);

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>IsOpen <font color="#000080">) </font><font color="#FF0000"><b>then</b></font>  					<font color="#008000"><i>// must be open
</i></font>   	Error<font color="#000080">( </font>FILE_NOT_OPEN_EMSG <font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>nbytes <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>then</b></font>             	<font color="#008000"><i>// byte number must be sensible
</i></font>   	Error<font color="#000080">( </font>BAD_BUFFER_SIZE_EMSG <font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font> 	Win32ReadFile<font color="#000080">( </font>mFile<font color="#000080">, </font>buf<font color="#000080">, </font>nbytes<font color="#000080">, @</font>bread<font color="#000080">, </font><font color="#FF0000"><b>nil </b></font><font color="#000080">) ) </font><font color="#FF0000"><b>then
</b></font>   	result <font color="#000080">:= </font>bread
   <font color="#FF0000"><b>else
</b></font>   	result <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Write bytes to file
</i></font><font color="#FF0000"><b>procedure </b></font>RawFile<font color="#000080">.</font>Write<font color="#000080">( </font>buf <font color="#000080">: </font>pointer<font color="#000080">;
</font>         						nbytes <font color="#000080">: </font>integer <font color="#000080">);
</font><font color="#FF0000"><b>var
</b></font>	bwrite <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin

</b></font>	CheckPointer<font color="#000080">( </font>buf <font color="#000080">);

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>IsOpen <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>FILE_NOT_OPEN_EMSG <font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>nbytes <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>BAD_BUFFER_SIZE_EMSG <font color="#000080">);

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>Win32WriteFile<font color="#000080">( </font>mFile<font color="#000080">, </font>buf<font color="#000080">, </font>nbytes<font color="#000080">, @</font>bwrite<font color="#000080">, </font><font color="#FF0000"><b>nil </b></font><font color="#000080">) ) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>WRITE_FAILED_EMSG <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Get current position. This involves seeking to end of file &amp; then back
// again and could therefore be slow.
</i></font><font color="#FF0000"><b>function  </b></font>RawFile<font color="#000080">.</font>FilePosition <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	pos <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>IsOpen <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>FILE_NOT_OPEN_EMSG <font color="#000080">);
   </font>pos <font color="#000080">:= </font>SetFilePointer<font color="#000080">( </font>mFile<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>FILE_CURRENT <font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>pos <font color="#000080">= -</font><font color="#800000">1 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>SEEK_FAILED_EMSG <font color="#000080">);
   </font>result <font color="#000080">:= </font>pos<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Seek in file, returning new position. Raises exception if seek fails.
</i></font><font color="#FF0000"><b>function </b></font>RawFile<font color="#000080">.</font>Seek<font color="#000080">( </font>moveby <font color="#000080">: </font>integer<font color="#000080">;  </font>from <font color="#000080">: </font>FileSeekFrom <font color="#000080">) : </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	mflags <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>IsOpen <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>FILE_NOT_OPEN_EMSG <font color="#000080">);

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>from <font color="#000080">= </font>sfStart <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	mflags <font color="#000080">:= </font>FILE_BEGIN
   <font color="#FF0000"><b>else</b></font> 	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>from <font color="#000080">= </font>sfEnd <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	mflags <font color="#000080">:= </font>FILE_END
	<font color="#FF0000"><b>else
</b></font>   	mflags <font color="#000080">:= </font>FILE_CURRENT<font color="#000080">;

   </font>result <font color="#000080">:= </font>SetFilePointer<font color="#000080">( </font>mFile<font color="#000080">, </font>moveby<font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>mflags <font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>result <font color="#000080">= -</font><font color="#800000">1 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>SEEK_FAILED_EMSG <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Lock a range of bytes
</i></font><font color="#FF0000"><b>function </b></font>RawFile<font color="#000080">.</font>Lock<font color="#000080">( </font>pos<font color="#000080">, </font>len <font color="#000080">: </font>integer <font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>IsOpen <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>FILE_NOT_OPEN_EMSG <font color="#000080">);

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( (</font>pos <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>len <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#000080">) ) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>BAD_LOCK_VALUES_EMSG <font color="#000080">);

   </font>result <font color="#000080">:= </font>LockFile<font color="#000080">( </font>mFile<font color="#000080">, </font>pos<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>len<font color="#000080">, </font><font color="#800000">0 </font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Unlock a range of bytesa
</i></font><font color="#FF0000"><b>procedure </b></font>RawFile<font color="#000080">.</font>UnLock<font color="#000080">( </font>pos<font color="#000080">, </font>len <font color="#000080">: </font>integer <font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>IsOpen <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>FILE_NOT_OPEN_EMSG <font color="#000080">);

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( (</font>pos <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>len <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#000080">) ) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>BAD_LOCK_VALUES_EMSG <font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font><font color="#FF0000"><b>not </b></font>UnLockFile<font color="#000080">( </font>mFile<font color="#000080">, </font>pos<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>len<font color="#000080">, </font><font color="#800000">0 </font><font color="#000080">) ) </font><font color="#FF0000"><b>then
</b></font>   	Error<font color="#000080">( </font>UNLOCK_FAILED_EMSG <font color="#000080">);

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>//------------------------------------------------------------------------------
// TFBuffer methods.
//------------------------------------------------------------------------------

</i></font><font color="#FF0000"><b>constructor </b></font>TFBuffer<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font> 	Reset<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Fill a buffer by reading raw bytes
</i></font><font color="#FF0000"><b>function </b></font>TFBuffer<font color="#000080">.</font>Fill<font color="#000080">( </font>f <font color="#000080">: </font>RawFile <font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font> 	mBytes <font color="#000080">:= </font>f<font color="#000080">.</font>Read<font color="#000080">( @</font>mBuffer<font color="#000080">, </font>sizeof<font color="#000080">( </font>mBuffer <font color="#000080">)) ;
   </font>mPtr <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>result <font color="#000080">:= </font>mBytes <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Get single character from the buffer, which will refill itself as
// necessary. Returns false on EOF.
</i></font><font color="#FF0000"><b>function </b></font>TFBuffer<font color="#000080">.</font>GetChar<font color="#000080">( </font>f <font color="#000080">: </font>RawFile<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>c <font color="#000080">: </font>char <font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	t <font color="#000080">: </font>char<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	result <font color="#000080">:= </font>false<font color="#000080">;

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( (</font>mPtr <font color="#000080">&gt;= </font>mBytes<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>Fill<font color="#000080">( </font>f <font color="#000080">) ) ) </font><font color="#FF0000"><b>then</b></font>  		<font color="#008000"><i>// eof
</i></font>		exit<font color="#000080">;

   </font>t <font color="#000080">:= </font>mBuffer<font color="#000080">[</font>mPtr<font color="#000080">];
   </font>inc<font color="#000080">( </font>mPtr <font color="#000080">);
   </font>result <font color="#000080">:= </font>true<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>t <font color="#000080">= </font><font color="#800000">#13 </font><font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font>GetChar<font color="#000080">( </font>f<font color="#000080">, </font>t <font color="#000080">);
      </font>c <font color="#000080">:= </font><font color="#800000">#0</font><font color="#000080">;
   </font><font color="#FF0000"><b>end
   else
</b></font>   	c <font color="#000080">:= </font>t<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Read line from buffer, stripping CR/LF. The buffer re-fills as necessary.
</i></font><font color="#FF0000"><b>function </b></font>TFBuffer<font color="#000080">.</font>GetLine<font color="#000080">( </font>f <font color="#000080">: </font>RawFile<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>line <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	c <font color="#000080">: </font>char<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	line <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
   </font><font color="#FF0000"><b>while</b></font><font color="#000080">( </font>GetChar<font color="#000080">( </font>f<font color="#000080">, </font>c <font color="#000080">) ) </font><font color="#FF0000"><b>do begin
</b></font>   	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>c <font color="#000080">= </font><font color="#800000">#0 </font><font color="#000080">) </font><font color="#FF0000"><b>then begin
</b></font>      	result <font color="#000080">:= </font>true<font color="#000080">;
</font>      	exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>line <font color="#000080">:= </font>line <font color="#000080">+ </font>c<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>result <font color="#000080">:= </font>Line <font color="#000080">&lt;&gt; </font><font color="#800000">''</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// empty the buffer
</i></font><font color="#FF0000"><b>procedure </b></font>TFBuffer<font color="#000080">.</font>Reset<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font> 	mPtr <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font>mBytes <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>//------------------------------------------------------------------------------
// TextFile methods. Most work is done by the RawFile and TFBuffer classes.
//------------------------------------------------------------------------------

// Constructor creates the rawfile &amp; buffer object
</i></font><font color="#FF0000"><b>constructor </b></font>TextFile<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mFile <font color="#000080">:= </font>RawFile<font color="#000080">.</font>Create<font color="#000080">;
   </font>mBuffer <font color="#000080">:= </font>TFBuffer<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>// destroy rawfile &amp; buffer
</i></font><font color="#FF0000"><b>destructor </b></font>TextFile<font color="#000080">.</font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mBuffer<font color="#000080">.</font>Free<font color="#000080">;
   </font>mFile<font color="#000080">.</font>Free<font color="#000080">;
   </font><font color="#FF0000"><b>inherited </b></font>destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>// Once again, open is mostly about mapping modes
</i></font><font color="#FF0000"><b>procedure </b></font>TextFile<font color="#000080">.</font>Open<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>fname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font>								omode <font color="#000080">: </font>TextFileOpenMode<font color="#000080">;
                        </font>smode <font color="#000080">: </font>TextFileShareMode <font color="#000080">);
</font><font color="#FF0000"><b>var
</b></font>	romode <font color="#000080">: </font>FileOpenMode<font color="#000080">;
   </font>rsmode <font color="#000080">: </font>FileShareMode<font color="#000080">;
   </font>rcmode <font color="#000080">: </font>FileCreateOption<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>omode <font color="#000080">= </font>toRead <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	romode <font color="#000080">:= </font>foRead
   <font color="#FF0000"><b>else
</b></font>   	romode <font color="#000080">:= </font>foWrite<font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>smode <font color="#000080">= </font>smNoShare <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	rsmode <font color="#000080">:= </font>fsNoShare
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>romode <font color="#000080">= </font>foRead <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	rsmode <font color="#000080">:= </font>fsShareRead
   <font color="#FF0000"><b>else
</b></font>   	<font color="#FF0000"><b>raise </b></font>FileError<font color="#000080">.</font>CreateFmt<font color="#000080">( </font><font color="#800000">'%s: %s'</font><font color="#000080">, [</font>fname<font color="#000080">, </font>BAD_TFSHARE_EMSG<font color="#000080">] );

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>omode <font color="#000080">= </font>toRead <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	rcmode <font color="#000080">:= </font>fcExisting
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>omode <font color="#000080">= </font>toReWrite <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	rcmode <font color="#000080">:= </font>fcNew
   <font color="#FF0000"><b>else if </b></font><font color="#000080">( </font>omode <font color="#000080">= </font>toAppend <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	rcmode <font color="#000080">:= </font>fcExisting<font color="#000080">;

   </font>mFile<font color="#000080">.</font>Open<font color="#000080">( </font>fname<font color="#000080">, </font>romode<font color="#000080">, </font>rsmode<font color="#000080">, </font>rcmode <font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>omode <font color="#000080">= </font>toAppend <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	mFile<font color="#000080">.</font>Seek<font color="#000080">( </font><font color="#800000">0</font><font color="#000080">, </font>sfEnd <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Close file
</i></font><font color="#FF0000"><b>procedure </b></font>TextFile<font color="#000080">.</font>Close<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mFile<font color="#000080">.</font>Close<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Get file name (may be empty)
</i></font><font color="#FF0000"><b>function </b></font>TextFile<font color="#000080">.</font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	result <font color="#000080">:= </font>mFile<font color="#000080">.</font>FileName<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Get open state
</i></font><font color="#FF0000"><b>function </b></font>TextFile<font color="#000080">.</font>IsOpen <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	result <font color="#000080">:= </font>mFile<font color="#000080">.</font>IsOpen<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// write line to text file, terminating with CR/LF pair
</i></font><font color="#FF0000"><b>procedure </b></font>TextFile<font color="#000080">.</font>WriteLine<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>line <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">);
</font><font color="#FF0000"><b>const
</b></font>	crlf <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#000080">= </font><font color="#800000">#13#10#0</font><font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	p <font color="#000080">: </font>pchar<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	p <font color="#000080">:= </font>pchar<font color="#000080">( </font>line <font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>length<font color="#000080">( </font>line <font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	mFile<font color="#000080">.</font>Write<font color="#000080">( </font>p<font color="#000080">, </font>length<font color="#000080">( </font>line <font color="#000080">) );
</font>	mFile<font color="#000080">.</font>Write<font color="#000080">( @</font>crlf<font color="#000080">, </font><font color="#800000">2 </font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Read line, trimming CR/LF.
</i></font><font color="#FF0000"><b>function </b></font>TextFile<font color="#000080">.</font>ReadLine<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>line <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	result <font color="#000080">:= </font>mBuffer<font color="#000080">.</font>GetLine<font color="#000080">( </font>mFile<font color="#000080">, </font>line <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>//------------------------------------------------------------------------------
// RandomAccessFile methods.  RawFile class does most of the work.
//------------------------------------------------------------------------------

// constructor creates rawfile
</i></font><font color="#FF0000"><b>constructor </b></font>RandomAccessFile<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mfile <font color="#000080">:= </font>RawFile<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>RandomAccessFile<font color="#000080">.</font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mFile<font color="#000080">.</font>Free<font color="#000080">;
   </font><font color="#FF0000"><b>inherited </b></font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Mode mapping not necessary, as we pass things thru to RawFile
</i></font><font color="#FF0000"><b>procedure </b></font>RandomAccessFile<font color="#000080">.</font>Open<font color="#000080">( </font><font color="#FF0000"><b>const </b></font>fname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font>         							recsize <font color="#000080">: </font>integer<font color="#000080">;
</font>         							omode <font color="#000080">: </font>FileOpenMode<font color="#000080">;
                              </font>smode <font color="#000080">: </font>FileShareMode<font color="#000080">;
                              </font>copts <font color="#000080">: </font>FileCreateOption <font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font>	mFile<font color="#000080">.</font>Open<font color="#000080">( </font>fname<font color="#000080">, </font>omode<font color="#000080">, </font>smode<font color="#000080">, </font>copts <font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>recsize <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>then begin
</b></font>   	mFile<font color="#000080">.</font>Close<font color="#000080">;
      </font>mFile<font color="#000080">.</font>Error<font color="#000080">( </font>BAD_REC_SIZE_EMSG <font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>mRecSize <font color="#000080">:= </font>recsize<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// usual stuff
</i></font><font color="#FF0000"><b>procedure </b></font>RandomAccessFile<font color="#000080">.</font>Close<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mFile<font color="#000080">.</font>close<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>RandomAccessFile<font color="#000080">.</font>FileName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	result <font color="#000080">:= </font>mFile<font color="#000080">.</font>FileName<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>RandomAccessFile<font color="#000080">.</font>IsOpen <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	result <font color="#000080">:= </font>mFile<font color="#000080">.</font>IsOpen<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// write record. If record number  higher than current highest, the call
// to Seek will extend the file
</i></font><font color="#FF0000"><b>procedure </b></font>RandomAccessFile<font color="#000080">.</font>WriteRecord<font color="#000080">( </font>rec <font color="#000080">: </font>pointer<font color="#000080">; </font>recno <font color="#000080">: </font>integer <font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>recno <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	mFile<font color="#000080">.</font>Error<font color="#000080">( </font>BAD_REC_NUMBER_EMSG <font color="#000080">);
</font>	mFile<font color="#000080">.</font>Seek<font color="#000080">( </font>recno <font color="#000080">* </font>mRecSize<font color="#000080">, </font>sfStart <font color="#000080">);
   </font>mFile<font color="#000080">.</font>Write<font color="#000080">( </font>rec<font color="#000080">, </font>mRecSize <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// read a record
</i></font><font color="#FF0000"><b>function </b></font>RandomAccessFile<font color="#000080">.</font>ReadRecord<font color="#000080">( </font>rec <font color="#000080">: </font>pointer<font color="#000080">; </font>recno <font color="#000080">: </font>integer <font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>recno <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	mFile<font color="#000080">.</font>Error<font color="#000080">( </font>BAD_REC_NUMBER_EMSG <font color="#000080">);
</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>RecordCount <font color="#000080">&lt;= </font>recno <font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>		result <font color="#000080">:= </font>false
   <font color="#FF0000"><b>else begin
</b></font>   	mFile<font color="#000080">.</font>Seek<font color="#000080">( </font>recno <font color="#000080">* </font>mRecSize<font color="#000080">, </font>sfStart <font color="#000080">);
</font>   	result <font color="#000080">:= </font>mFile<font color="#000080">.</font>Read<font color="#000080">( </font>rec<font color="#000080">, </font>mRecSize <font color="#000080">) = </font>mRecSize<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// read next record. Should have made som positioning call (like REadRecord)
// before calling this
</i></font><font color="#FF0000"><b>function </b></font>RandomAccessFile<font color="#000080">.</font>ReadNextRecord<font color="#000080">( </font>rec <font color="#000080">: </font>pointer <font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	mFile<font color="#000080">.</font>Seek<font color="#000080">( </font><font color="#800000">0</font><font color="#000080">, </font>sfHere <font color="#000080">);
   </font>result <font color="#000080">:= </font>mFile<font color="#000080">.</font>Read<font color="#000080">( </font>rec<font color="#000080">, </font>mRecSize <font color="#000080">) = </font>mRecSize<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Record locking
</i></font><font color="#FF0000"><b>function </b></font>RandomAccessFile<font color="#000080">.</font>LockRecord<font color="#000080">( </font>recno <font color="#000080">: </font>integer <font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	result <font color="#000080">:= </font>mFile<font color="#000080">.</font>Lock<font color="#000080">( </font>recno <font color="#000080">* </font>mRecSize<font color="#000080">, </font>mRecSize <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// and unlocking
</i></font><font color="#FF0000"><b>procedure </b></font>RandomAccessFile<font color="#000080">.</font>UnlockRecord<font color="#000080">( </font>recno <font color="#000080">: </font>integer <font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font>	mFile<font color="#000080">.</font>Unlock<font color="#000080">( </font>recno <font color="#000080">* </font>mRecSize<font color="#000080">, </font>mRecSize <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// extend file by count records
</i></font><font color="#FF0000"><b>procedure </b></font>RandomAccessFile<font color="#000080">.</font>Extend<font color="#000080">( </font>count <font color="#000080">: </font>integer <font color="#000080">);
</font><font color="#FF0000"><b>var
</b></font>	c <font color="#000080">: </font>char<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>count <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>		mFile<font color="#000080">.</font>Seek<font color="#000080">( (</font>count <font color="#000080">- </font><font color="#800000">1 </font><font color="#000080">) * </font>mRecSize<font color="#000080">, </font>sfEnd <font color="#000080">);

   </font><font color="#008000"><i>// for the last record we write a byte at its very end
   </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>mRecSize <font color="#000080">&gt; </font><font color="#800000">1 </font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>   	mFile<font color="#000080">.</font>Seek<font color="#000080">( </font>mRecSize <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">, </font>sfHere <font color="#000080">);
</font> 	mFile<font color="#000080">.</font>Write<font color="#000080">( @</font>c<font color="#000080">, </font><font color="#800000">1 </font><font color="#000080">);                </font><font color="#008000"><i>// must write in order to extend
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>// Return number of records. This causes several seeks, so may be slow
</i></font><font color="#FF0000"><b>function </b></font>RandomAccessFile<font color="#000080">.</font>RecordCount <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>var
</b></font>	now <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>	now <font color="#000080">:= </font>mFile<font color="#000080">.</font>FilePosition<font color="#000080">;
   </font>result <font color="#000080">:= </font>mFile<font color="#000080">.</font>Seek<font color="#000080">( </font><font color="#800000">0</font><font color="#000080">, </font>sfEnd <font color="#000080">) </font><font color="#FF0000"><b>div </b></font>mRecSize<font color="#000080">;
   </font>mFile<font color="#000080">.</font>Seek<font color="#000080">( </font>now<font color="#000080">, </font>sfStart <font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>//------------------------------------------------------------------------------

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0467.PAS">Original</a><b>]</b></p></body>
</html>
