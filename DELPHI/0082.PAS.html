<html>
<head><title> "Using TStream/TWrite" by MARK JOHNSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0082.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>For </b></font>those interested <font color="#FF0000"><b>in </b></font>storing components onto a stream<font color="#000080">, </font>take a look
at TWriter<font color="#000080">.</font>WriteRootComponent <font color="#FF0000"><b>and </b></font>TWriter<font color="#000080">.</font>WriteComponent<font color="#000080">.  </font><font color="#FF0000"><b>Then </b></font>check
<font color="#FF0000"><b>out </b></font>the TReader<font color="#000080">.</font>Read<font color="#000080">... </font>counterparts<font color="#000080">.  </font>Unfortunately<font color="#000080">, </font>there appears
<font color="#FF0000"><b>to </b></font>be no documentation showing HOW <font color="#FF0000"><b>to </b></font>use these methods properly<font color="#000080">.
</font>The docs keep mentioning the <font color="#000080">&quot;</font>root<font color="#000080">&quot; </font>component<font color="#000080">, </font>but never clearly
explain what it <font color="#FF0000"><b>is or </b></font>how you are suppose <font color="#FF0000"><b>to </b></font>use the root <font color="#FF0000"><b>property
to </b></font>store your components<font color="#000080">.

</font><font color="#FF0000"><b>If </b></font>you are interested <font color="#FF0000"><b>in </b></font>writing objects <font color="#FF0000"><b>to </b></font>the stream that are
<font color="#FF0000"><b>not </b></font>components<font color="#000080">, </font>I recommend doing something like the follow<font color="#000080">:

</font><font color="#FF0000"><b>type
  </b></font>TMyObject <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TObject<font color="#000080">)
    ...
  </font><font color="#FF0000"><b>protected
    procedure </b></font>SaveToStream<font color="#000080">(</font>writer <font color="#000080">: </font>TWriter<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">; 
    </font><font color="#FF0000"><b>procedure </b></font>LoadFromStream<font color="#000080">(</font>writer <font color="#000080">: </font>TWriter<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    ...
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TMyObject<font color="#000080">.</font>SaveToStream<font color="#000080">(</font>writer <font color="#000080">: </font>TWriter<font color="#000080">);
</font><font color="#FF0000"><b>begin
  with </b></font>writer <font color="#FF0000"><b>do begin
    </b></font>WriteListBegin<font color="#000080">;
    </font><font color="#008000"><i>{- write object state -}
    </i></font>WriteListEnd<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TMyObject<font color="#000080">.</font>LoadFromStream<font color="#000080">(</font>reader <font color="#000080">: </font>TReader<font color="#000080">);
</font><font color="#FF0000"><b>begin
  with </b></font>reader <font color="#FF0000"><b>do begin
    </b></font>ReadListBegin<font color="#000080">;
    </font><font color="#FF0000"><b>while not </b></font>EndOfList <font color="#FF0000"><b>do begin
      </b></font><font color="#008000"><i>{- read object state -}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>ReadListEnd<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>Somewhere <font color="#FF0000"><b>in </b></font>the <font color="#FF0000"><b>initialization </b></font>section <font color="#FF0000"><b>of </b></font>the <font color="#FF0000"><b>unit in </b></font>which this
<font color="#FF0000"><b>object is </b></font>declared<font color="#000080">, </font>call RegisterObject<font color="#000080">(</font><font color="#800000">'TMyObject'</font><font color="#000080">).  (</font>See
RegisterObject<font color="#000080">() </font>below<font color="#000080">.)

</font><font color="#FF0000"><b>In </b></font>the main <font color="#FF0000"><b>program</b></font><font color="#000080">, </font>where you specify the <font color="#FF0000"><b>file to </b></font>read<font color="#000080">/</font>write<font color="#000080">,
</font>you can <font color="#FF0000"><b>do </b></font>something like this<font color="#000080">:

</font><font color="#FF0000"><b>var
  </b></font>RegisteredObjects <font color="#000080">: </font>TStringList<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>RegisterObject<font color="#000080">(</font>cname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>ctype <font color="#000080">: </font>TClass<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>RegisteredObjects<font color="#000080">.</font>AddObject<font color="#000080">(</font>cname<font color="#000080">, </font>ctype<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetObject<font color="#000080">(</font>cname <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">) : </font>TClass<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>i <font color="#000080">:= </font>RegisteredObjects<font color="#000080">.</font>IndexOf<font color="#000080">(</font>cname<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>i <font color="#000080">&gt; -</font><font color="#800000">1 </font><font color="#FF0000"><b>then
    </b></font>Result <font color="#000080">:= </font>TClass<font color="#000080">(</font>RegisteredObjects<font color="#000080">.</font>Objects<font color="#000080">[</font>i<font color="#000080">])
  </font><font color="#FF0000"><b>else
    </b></font>Result <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SaveFile<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>objlist <font color="#000080">: </font>TList<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>stream <font color="#000080">: </font>TFileStream<font color="#000080">;
  </font>writer <font color="#000080">: </font>TWriter<font color="#000080">;
  </font>i      <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>stream <font color="#000080">:= </font>TFileStream<font color="#000080">.</font>Create<font color="#000080">(</font>filename<font color="#000080">, </font>fmCreate <font color="#FF0000"><b>or </b></font>fmOpenWrite<font color="#000080">);
  </font><font color="#FF0000"><b>try
    </b></font>writer <font color="#000080">:= </font>TWriter<font color="#000080">.</font>Create<font color="#000080">(</font>stream<font color="#000080">, </font><font color="#800000">$ff</font><font color="#000080">);
    </font><font color="#FF0000"><b>try
      with </b></font>writer <font color="#FF0000"><b>do begin
        </b></font>WriteSignature<font color="#000080">;     </font><font color="#008000"><i>{marker to indicate a Delphi filer object file.}
        </i></font>WriteListBegin<font color="#000080">;     </font><font color="#008000"><i>{outer list marker}
        </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>objlist<font color="#000080">.</font>Count <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
          </b></font>WriteListBegin<font color="#000080">;   </font><font color="#008000"><i>{object marker}
          </i></font>WriteString<font color="#000080">(</font>TMyObject<font color="#000080">(</font>objlist<font color="#000080">[</font>i<font color="#000080">]).</font>ClassName<font color="#000080">);
          </font>TMyObject<font color="#000080">(</font>objlist<font color="#000080">[</font>i<font color="#000080">]).</font>SaveToStream<font color="#000080">(</font>writer<font color="#000080">);
          </font>WriteListEnd<font color="#000080">;     </font><font color="#008000"><i>{object marker}
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>WriteListEnd<font color="#000080">;       </font><font color="#008000"><i>{outer list marker}
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>finally
      </b></font>writer<font color="#000080">.</font>Free<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>finally
    </b></font>stream<font color="#000080">.</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>OpenFile<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>objlist <font color="#000080">: </font>TList<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>stream <font color="#000080">: </font>TFileStream<font color="#000080">;
  </font>writer <font color="#000080">: </font>TWriter<font color="#000080">;
  </font>cname  <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;  </font><font color="#008000"><i>{class name}
  </i></font>ctype  <font color="#000080">: </font>TClass<font color="#000080">;  </font><font color="#008000"><i>{class type}
  </i></font>obj    <font color="#000080">: </font>TObject<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>stream <font color="#000080">:= </font>TFileStream<font color="#000080">.</font>Create<font color="#000080">(</font>filename<font color="#000080">, </font>fmOpenRead<font color="#000080">);
  </font><font color="#FF0000"><b>try
    </b></font>reader <font color="#000080">:= </font>TReader<font color="#000080">.</font>Create<font color="#000080">(</font>stream<font color="#000080">, </font><font color="#800000">$ff</font><font color="#000080">);
    </font><font color="#FF0000"><b>try
      with </b></font>reader <font color="#FF0000"><b>do begin
        </b></font>ReadSignature<font color="#000080">;     </font><font color="#008000"><i>{check Delphi filer object signature.}
        </i></font>ReadListBegin<font color="#000080">;     </font><font color="#008000"><i>{outer list marker}
        </i></font><font color="#FF0000"><b>while not </b></font>EndOfList <font color="#FF0000"><b>do begin
          </b></font>ReadListBegin<font color="#000080">;   </font><font color="#008000"><i>{object marker}
          </i></font><font color="#FF0000"><b>while not </b></font>EndOfList <font color="#FF0000"><b>do begin
            </b></font>cname <font color="#000080">:= </font>ReadString<font color="#000080">;
            </font>ctype <font color="#000080">:= </font>GetObjectClass<font color="#000080">(</font>cname<font color="#000080">);
            </font>obj <font color="#000080">:= </font>TObject<font color="#000080">(</font>TObjectClass<font color="#000080">(</font>ctype<font color="#000080">).</font>Create<font color="#000080">;
            </font><font color="#FF0000"><b>try
              </b></font>obj<font color="#000080">.</font>LoadFromStream<font color="#000080">(</font>reader<font color="#000080">);
            </font><font color="#FF0000"><b>except
              </b></font>obj<font color="#000080">.</font>Free<font color="#000080">;
              </font><font color="#FF0000"><b>raise</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font>objlist<font color="#000080">.</font>Add<font color="#000080">(</font>obj<font color="#000080">);
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>ReadListEnd<font color="#000080">;     </font><font color="#008000"><i>{object marker}
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>ReadListEnd<font color="#000080">;       </font><font color="#008000"><i>{outer list marker}
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>finally
      </b></font>reader<font color="#000080">.</font>Free<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>finally
    </b></font>stream<font color="#000080">.</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font>Well<font color="#000080">, </font>I don<font color="#800000">'t know how far this will get you.  I haven'</font>t tested ANY
<font color="#FF0000"><b>of </b></font>this code<font color="#000080">, </font>so who knows <font color="#FF0000"><b>if </b></font>it could ever possibly work<font color="#000080">.  </font>The most
doubtful part <font color="#FF0000"><b>is </b></font>the whole <font color="#FF0000"><b>dynamic </b></font>instantiation taking place <font color="#FF0000"><b>in
</b></font>LoadFromStream<font color="#000080">().  </font>Delphi provides a bunch <font color="#FF0000"><b>of </b></font>great functions <font color="#FF0000"><b>for
</b></font>registering TPersistent descendants <font color="#FF0000"><b>and </b></font>getting their <font color="#FF0000"><b>class </b></font>types
from their <font color="#FF0000"><b>class </b></font>names<font color="#000080">, </font>etc<font color="#000080">.:  </font>RegisterClass<font color="#000080">(), </font>FindFieldClass<font color="#000080">(),
</font>FindClass<font color="#000080">(), </font>GetClass<font color="#000080">(), </font>etc<font color="#000080">.  (</font>They use it <font color="#FF0000"><b>for </b></font>loading components
off <font color="#FF0000"><b>of </b></font>streams<font color="#000080">....</font>no surprise there<font color="#000080">.)  </font>However<font color="#000080">, </font><font color="#FF0000"><b>if </b></font>your objects
are <font color="#FF0000"><b>not </b></font>TPersistent descendants <font color="#000080">(</font><font color="#FF0000"><b>and </b></font>there<font color="#800000">'s no reason they should
</font>be<font color="#000080">), </font><font color="#FF0000"><b>then </b></font>you<font color="#800000">'re basically out of luck (read: &quot;you get to write
</font>your own RegisteredClass<font color="#000080">()&quot;).

</font>So<font color="#000080">, </font>give this a <font color="#FF0000"><b>try if </b></font>you<font color="#800000">'re feeling daring.  Just don'</font>t come running
after me <font color="#FF0000"><b>with </b></font>a shotgun complaining about little voices <font color="#FF0000"><b>in </b></font>your heads
<font color="#FF0000"><b>if </b></font>you <font color="#FF0000"><b>do</b></font><font color="#000080">.  </font>I suspect the above code will need a lot <font color="#FF0000"><b>of </b></font>polish before
it does what <font color="#FF0000"><b>is </b></font>expected <font color="#FF0000"><b>of </b></font>it<font color="#000080">...  </font>Nonetheless<font color="#000080">, </font>I hope you find it
interesting<font color="#000080">, </font><font color="#FF0000"><b>if </b></font>nothing <font color="#FF0000"><b>else</b></font><font color="#000080">.

----------------------------------------------------------------------

</font>Well<font color="#000080">, </font>shoot<font color="#000080">.  </font>After a bit <font color="#FF0000"><b>of </b></font>research <font color="#FF0000"><b>and </b></font>review<font color="#000080">, </font>I came <font color="#FF0000"><b>to </b></font>realize just
how unnecessary all <font color="#FF0000"><b>of </b></font>this work <font color="#FF0000"><b>with </b></font>trying <font color="#FF0000"><b>to </b></font>store plain objects
<font color="#FF0000"><b>on </b></font>a stream <font color="#FF0000"><b>is</b></font><font color="#000080">.  </font>When I wrote up the TStream2 <font color="#FF0000"><b>message </b></font>back <font color="#FF0000"><b>in </b></font>May
<font color="#000080">(</font>only shortly after Delphi came <font color="#FF0000"><b>out</b></font><font color="#000080">), </font>I did <font color="#FF0000"><b>not </b></font>have a good understanding
<font color="#FF0000"><b>of </b></font>the VCL <font color="#FF0000"><b>class </b></font>heirarchy<font color="#000080">.

</font>Here<font color="#800000">'s a quote from the Component Writer'</font>s Guide <font color="#000080">(</font>TPersistent<font color="#000080">):

</font>The TPersistent <font color="#FF0000"><b>object is </b></font>the <font color="#FF0000"><b>abstract </b></font>base <font color="#FF0000"><b>object for </b></font>all objects
stored <font color="#FF0000"><b>and </b></font>loaded <font color="#FF0000"><b>on </b></font>Delphi stream objects<font color="#000080">. </font><font color="#FF0000"><b>In </b></font>addition <font color="#FF0000"><b>to </b></font>the methods
it inherits from its ancestor<font color="#000080">, </font>TObject<font color="#000080">, </font>TPersistent defines three new
methods<font color="#000080">: </font>AssignTo <font color="#FF0000"><b>and </b></font>DefineProperties<font color="#000080">, </font>which are <font color="#FF0000"><b>protected</b></font><font color="#000080">, </font><font color="#FF0000"><b>and </b></font>Assign<font color="#000080">,
</font>which <font color="#FF0000"><b>is public</b></font><font color="#000080">.

</font>The GetClass<font color="#000080">() </font><font color="#FF0000"><b>and </b></font>RegisterClass<font color="#000080">() </font>functions work <font color="#FF0000"><b>for </b></font>TPersistent objects<font color="#000080">.

</font>So<font color="#000080">, </font>after being <font color="#FF0000"><b>in </b></font>the dark <font color="#FF0000"><b>for </b></font>so long<font color="#000080">, </font>I sat down <font color="#FF0000"><b>and </b></font>just took a
good long look at TPersistent <font color="#FF0000"><b>and </b></font>other related matters<font color="#000080">.  </font><font color="#FF0000"><b>Then</b></font><font color="#000080">, </font>after
looking back at what you wanted <font color="#FF0000"><b>to do</b></font><font color="#000080">, </font>I wrote up a little <font color="#FF0000"><b>program
and </b></font>tested it <font color="#FF0000"><b>out to </b></font>make sure it actually worked<font color="#000080">.  </font>Below <font color="#FF0000"><b>is </b></font>the result<font color="#000080">.

</font>Below I have included two units<font color="#000080">: </font>Unit1<font color="#000080">, </font>which <font color="#FF0000"><b>is </b></font>a form definition<font color="#000080">, </font><font color="#FF0000"><b>and
</b></font>Unit2<font color="#000080">, </font>which <font color="#FF0000"><b>contains </b></font>the TPlayer <font color="#FF0000"><b>and </b></font>TObjectList classes<font color="#000080">.  </font>The form
<font color="#000080">(</font>Unit1<font color="#000080">) </font>has <font color="#FF0000"><b>for </b></font>buttons labelled <font color="#000080">&quot;</font>Create<font color="#000080">,&quot; &quot;</font>Save<font color="#000080">,&quot; &quot;</font>Load<font color="#000080">,&quot; </font><font color="#FF0000"><b>and </b></font><font color="#000080">&quot;</font>Exit<font color="#000080">.&quot;

        </font>Create <font color="#000080">-- </font>create <font color="#800000">5 </font>TPlayers <font color="#FF0000"><b>and </b></font>add them <font color="#FF0000"><b>to </b></font>the <font color="#FF0000"><b>object </b></font>list
        Save   <font color="#000080">-- </font>save the <font color="#FF0000"><b>object </b></font>list <font color="#FF0000"><b>to </b></font>a <font color="#FF0000"><b>file
        </b></font>Load   <font color="#000080">-- </font>load the <font color="#FF0000"><b>object </b></font>list from a <font color="#FF0000"><b>file
        </b></font>Exit   <font color="#000080">-- </font>free the <font color="#FF0000"><b>object </b></font>list <font color="#FF0000"><b>and </b></font>exit

<font color="#FF0000"><b>In </b></font>Unit2<font color="#000080">, </font>the TPlayer <font color="#FF0000"><b>object is </b></font>declared <font color="#FF0000"><b>as </b></font>a TPersistent descendant
<font color="#FF0000"><b>and is </b></font>given two methods<font color="#000080">:  </font>ReadData<font color="#000080">() </font><font color="#FF0000"><b>and </b></font>WriteData<font color="#000080">().

        </font>ReadData<font color="#000080">()  -- </font>read <font color="#FF0000"><b>property </b></font>data <font color="#FF0000"><b>with </b></font>given TReader <font color="#FF0000"><b>object
        </b></font>WriteData<font color="#000080">() -- </font><font color="#FF0000"><b>write property </b></font>data <font color="#FF0000"><b>with </b></font>given TWriter <font color="#FF0000"><b>object

</b></font>The TPlayer <font color="#FF0000"><b>class is </b></font>registered <font color="#FF0000"><b>with </b></font>a call <font color="#FF0000"><b>to </b></font>RegisterClass <font color="#FF0000"><b>in </b></font>the
<font color="#FF0000"><b>initialization </b></font>section <font color="#FF0000"><b>of </b></font>Unit2 when the <font color="#FF0000"><b>program </b></font>first begins<font color="#000080">.

</font>Also <font color="#FF0000"><b>in </b></font>Unit2<font color="#000080">, </font>the TObjectList <font color="#FF0000"><b>class is </b></font>declared <font color="#FF0000"><b>as </b></font>a TList <font color="#FF0000"><b>and
</b></font>given the methods Clear<font color="#000080">(), </font>SaveToStream<font color="#000080">(), </font>LoadFromStream<font color="#000080">(),
</font>SaveToFile<font color="#000080">(), </font><font color="#FF0000"><b>and </b></font>LoadFromFile<font color="#000080">().  </font>The SaveToFile<font color="#000080">() </font><font color="#FF0000"><b>and </b></font>LoadFromFile<font color="#000080">()
</font>just create a TFileStream <font color="#FF0000"><b>object and then </b></font>pass it <font color="#FF0000"><b>to </b></font>the corresponding
SaveToStream<font color="#000080">()/</font>LoadFromStream<font color="#000080">() </font>method<font color="#000080">, </font>which <font color="#FF0000"><b>do </b></font>the actually accessing
via the TFiler objects <font color="#000080">(</font>TWriter <font color="#000080">&amp; </font>TReader<font color="#000080">).  </font>A <font color="#FF0000"><b>destructor </b></font>was also
added <font color="#FF0000"><b>to </b></font>TObjectList <font color="#FF0000"><b>to </b></font>ensure that it frees the items <font color="#FF0000"><b>in </b></font>the list
when it <font color="#FF0000"><b>is </b></font>destroyed<font color="#000080">.

</font>I think it would be a good idea <font color="#FF0000"><b>to </b></font>go back into the TObjectList <font color="#FF0000"><b>and
</b></font>add a new kind <font color="#FF0000"><b>of </b></font>Items <font color="#FF0000"><b>property </b></font>that <font color="#FF0000"><b>is </b></font>specifically typed <font color="#FF0000"><b>as
</b></font>TPersistent <font color="#FF0000"><b>or </b></font>TObject instead <font color="#FF0000"><b>of </b></font>just Pointer since many <font color="#FF0000"><b>of </b></font>the
operations we perform <font color="#FF0000"><b>on </b></font>its Items <font color="#FF0000"><b>property </b></font>could cause problems
<font color="#FF0000"><b>if </b></font>a non<font color="#000080">-</font><font color="#FF0000"><b>object </b></font>were accidentally <font color="#FF0000"><b>stored in </b></font>the list<font color="#000080">.  </font>It would also
reduce the need <font color="#FF0000"><b>for </b></font>all <font color="#FF0000"><b>of </b></font>the extra <font color="#FF0000"><b>type </b></font>casting<font color="#000080">.

</font>Anyhow<font color="#000080">, </font>here are the two units that worked <font color="#FF0000"><b>for </b></font>me<font color="#000080">.  </font>Let me know what you
think<font color="#000080">.

--</font>Mark Johnson

<font color="#000080">--------------------------------- </font>UNIT1<font color="#000080">.</font>PAS <font color="#000080">---------------------------------

</font><font color="#FF0000"><b>unit </b></font>Unit1<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
  </b></font>SysUtils<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Messages<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">, </font>Controls<font color="#000080">,
  </font>Forms<font color="#000080">, </font>Dialogs<font color="#000080">, </font>StdCtrls<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TForm1 <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TForm<font color="#000080">)
    </font>btnCreate<font color="#000080">: </font>TButton<font color="#000080">;
    </font>btnSave<font color="#000080">: </font>TButton<font color="#000080">;
    </font>btnLoad<font color="#000080">: </font>TButton<font color="#000080">;
    </font>btnExit<font color="#000080">: </font>TButton<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>btnCreateClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>btnSaveClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>btnLoadClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>btnExitClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
  </font><font color="#FF0000"><b>private
    </b></font><font color="#008000"><i>{ Private declarations }
  </i></font><font color="#FF0000"><b>public
    </b></font><font color="#008000"><i>{ Public declarations }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Form1<font color="#000080">: </font>TForm1<font color="#000080">;


</font><font color="#FF0000"><b>implementation

</b></font><font color="#008000"><i>{$R *.DFM}

</i></font><font color="#FF0000"><b>uses
  </b></font>Unit2<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>ObjFilename <font color="#000080">= </font><font color="#800000">'C:\players.dat'</font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>objList <font color="#000080">: </font>TObjectList<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>btnCreateClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>player <font color="#000080">: </font>TPlayer<font color="#000080">;
  </font>i      <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Creates five players and adds them to ObjList}
  </i></font>objList<font color="#000080">.</font>Clear<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">5 </font><font color="#FF0000"><b>do begin
    </b></font>player <font color="#000080">:= </font>TPlayer<font color="#000080">.</font>Create<font color="#000080">;
    </font><font color="#FF0000"><b>try
      with </b></font>player <font color="#FF0000"><b>do begin
        </b></font>Name       <font color="#000080">:= </font><font color="#800000">'Name' </font><font color="#000080">+ </font>IntToStr<font color="#000080">(</font>i<font color="#000080">);
        </font>EmpireName <font color="#000080">:= </font><font color="#800000">'EmpireName' </font><font color="#000080">+ </font>IntToStr<font color="#000080">(</font>i<font color="#000080">);
        </font>Wins       <font color="#000080">:= </font>i<font color="#000080">;
        </font>Losses     <font color="#000080">:= </font><font color="#800000">5 </font><font color="#000080">- </font>i<font color="#000080">;
        </font>Ranking    <font color="#000080">:= </font><font color="#800000">6 </font><font color="#000080">- </font>i<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>objList<font color="#000080">.</font>Add<font color="#000080">(</font>player<font color="#000080">);
    </font><font color="#FF0000"><b>except
      </b></font>player<font color="#000080">.</font>Free<font color="#000080">;
      </font><font color="#FF0000"><b>raise</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>btnSaveClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Stores objList to file}
  </i></font>objList<font color="#000080">.</font>SaveToFile<font color="#000080">(</font>ObjFilename<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>btnLoadClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Loads objList from file}
  </i></font>objList<font color="#000080">.</font>LoadFromFile<font color="#000080">(</font>ObjFilename<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TForm1<font color="#000080">.</font>btnExitClick<font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Frees objList (and everything in list) and exits}
  </i></font>objList<font color="#000080">.</font>Free<font color="#000080">;
  </font>Close<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>initialization
  </b></font>objList <font color="#000080">:= </font>TObjectList<font color="#000080">.</font>Create<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

--------------------------------- </font>UNIT2<font color="#000080">.</font>PAS <font color="#000080">---------------------------------

</font><font color="#FF0000"><b>unit </b></font>Unit2<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
  </b></font>Classes<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TPlayer <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TPersistent<font color="#000080">)
  </font><font color="#FF0000"><b>private
    </b></font>FName       <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
    </font>FEmpireName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
    </font>FWins       <font color="#000080">: </font>integer<font color="#000080">;
    </font>FLosses     <font color="#000080">: </font>integer<font color="#000080">;
    </font>FRanking    <font color="#000080">: </font>integer<font color="#000080">;
  </font><font color="#FF0000"><b>public
    procedure </b></font>ReadData<font color="#000080">(</font>reader <font color="#000080">: </font>TReader<font color="#000080">); </font><font color="#FF0000"><b>dynamic</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>WriteData<font color="#000080">(</font>writer <font color="#000080">: </font>TWriter<font color="#000080">); </font><font color="#FF0000"><b>dynamic</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>published
    property </b></font>Name <font color="#000080">: </font><font color="#FF0000"><b>string read </b></font>FName <font color="#FF0000"><b>write </b></font>FName<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>EmpireName <font color="#000080">: </font><font color="#FF0000"><b>string read </b></font>FEmpireName <font color="#FF0000"><b>write </b></font>FEmpireName<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Wins <font color="#000080">: </font>integer <font color="#FF0000"><b>read </b></font>FWins <font color="#FF0000"><b>write </b></font>FWins<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Losses <font color="#000080">: </font>integer <font color="#FF0000"><b>read </b></font>FLosses <font color="#FF0000"><b>write </b></font>FLosses<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Ranking <font color="#000080">: </font>integer <font color="#FF0000"><b>read </b></font>FRanking <font color="#FF0000"><b>write </b></font>FRanking<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>TObjectlist<font color="#000080">=</font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TList<font color="#000080">)
  </font><font color="#FF0000"><b>public
    destructor </b></font>Destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Clear<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>SaveToStream<font color="#000080">(</font>stream <font color="#000080">: </font>TStream<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>LoadFromStream<font color="#000080">(</font>stream <font color="#000080">: </font>TStream<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>SaveToFile<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>LoadFromFile<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>implementation

uses
  </b></font>SysUtils<font color="#000080">;

</font><font color="#008000"><i>{TPlayer}

</i></font><font color="#FF0000"><b>procedure </b></font>TPlayer<font color="#000080">.</font>ReadData<font color="#000080">(</font>reader <font color="#000080">: </font>TReader<font color="#000080">);
</font><font color="#FF0000"><b>begin
  with </b></font>reader <font color="#FF0000"><b>do begin
    </b></font>Name       <font color="#000080">:= </font>ReadString<font color="#000080">;
    </font>EmpireName <font color="#000080">:= </font>ReadString<font color="#000080">;
    </font>Wins       <font color="#000080">:= </font>ReadInteger<font color="#000080">;
    </font>Losses     <font color="#000080">:= </font>ReadInteger<font color="#000080">;
    </font>Ranking    <font color="#000080">:= </font>ReadInteger<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TPlayer<font color="#000080">.</font>WriteData<font color="#000080">(</font>writer <font color="#000080">: </font>Twriter<font color="#000080">);
</font><font color="#FF0000"><b>begin
  with </b></font>writer <font color="#FF0000"><b>do begin
    </b></font>WriteString<font color="#000080">(</font>Name<font color="#000080">);
    </font>WriteString<font color="#000080">(</font>EmpireName<font color="#000080">);
    </font>WriteInteger<font color="#000080">(</font>Wins<font color="#000080">);
    </font>WriteInteger<font color="#000080">(</font>Losses<font color="#000080">);
    </font>WriteInteger<font color="#000080">(</font>Ranking<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{TObjectList}

</i></font><font color="#FF0000"><b>destructor </b></font>TObjectList<font color="#000080">.</font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{deallocate objects in list before termination}
  </i></font>Clear<font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TObjectList<font color="#000080">.</font>Clear<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{This routine deallocates all resources inside this list}
  </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
    </b></font>TObject<font color="#000080">(</font>Items<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]).</font>Free<font color="#000080">;
    </font>Delete<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TObjectList<font color="#000080">.</font>SaveToStream<font color="#000080">(</font>stream <font color="#000080">: </font>TStream<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>writer <font color="#000080">: </font>TWriter<font color="#000080">;
  </font>i      <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
    </b></font>writer <font color="#000080">:= </font>TWriter<font color="#000080">.</font>Create<font color="#000080">(</font>stream<font color="#000080">, </font><font color="#800000">$ff</font><font color="#000080">);
    </font><font color="#FF0000"><b>try
      with </b></font>writer <font color="#FF0000"><b>do begin
        </b></font><font color="#008000"><i>{mark beginning of file and beginning of object list}
        </i></font>WriteSignature<font color="#000080">;
        </font>WriteListBegin<font color="#000080">;
        </font><font color="#008000"><i>{loop through this list}
        </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
          </b></font><font color="#008000"><i>{Store any TPersistent objects}
          </i></font><font color="#FF0000"><b>if </b></font>TObject<font color="#000080">(</font>Items<font color="#000080">[</font>i<font color="#000080">]) </font><font color="#FF0000"><b>is </b></font>TPersistent <font color="#FF0000"><b>then begin
            </b></font>WriteString<font color="#000080">(</font>TPersistent<font color="#000080">(</font>Items<font color="#000080">[</font>i<font color="#000080">]).</font>ClassName<font color="#000080">);
            </font><font color="#008000"><i>{Call WriteData() for TPlayer objects}
            </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>TPersistent<font color="#000080">(</font>Items<font color="#000080">[</font>i<font color="#000080">]) </font><font color="#FF0000"><b>is </b></font>TPlayer<font color="#000080">) </font><font color="#FF0000"><b>then
              </b></font>TPlayer<font color="#000080">(</font>Items<font color="#000080">[</font>i<font color="#000080">]).</font>WriteData<font color="#000080">(</font>writer<font color="#000080">);
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#008000"><i>{mark end of object list}
        </i></font>WriteListEnd<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>finally
      </b></font>writer<font color="#000080">.</font>Free<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TObjectList<font color="#000080">.</font>LoadFromStream<font color="#000080">(</font>stream <font color="#000080">: </font>TStream<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>reader <font color="#000080">: </font>TReader<font color="#000080">;
  </font>obj    <font color="#000080">: </font>TPersistent<font color="#000080">;
  </font>ctype  <font color="#000080">: </font>TPersistentClass<font color="#000080">;
  </font>cname  <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>i      <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>reader<font color="#000080">:=</font>TReader<font color="#000080">.</font>Create<font color="#000080">(</font>stream<font color="#000080">,</font><font color="#800000">$ff</font><font color="#000080">);
  </font><font color="#FF0000"><b>try
    with </b></font>reader <font color="#FF0000"><b>do begin
      </b></font><font color="#008000"><i>{read beginning of file and beginning of object list markers}
      </i></font>ReadSignature<font color="#000080">;
      </font>ReadListBegin<font color="#000080">;
      </font><font color="#008000"><i>{loop through file list of objects}
      </i></font><font color="#FF0000"><b>while not </b></font>EndOfList <font color="#FF0000"><b>do begin
        </b></font><font color="#008000"><i>{Load ClassName and use it to get ClassType}
        </i></font>cname <font color="#000080">:= </font>ReadString<font color="#000080">;
        </font>ctype <font color="#000080">:= </font>GetClass<font color="#000080">(</font>cname<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>Assigned<font color="#000080">(</font>ctype<font color="#000080">) </font><font color="#FF0000"><b>then begin  </b></font><font color="#008000"><i>{&quot;Assigned()&quot; == &quot; &lt;&gt; nil&quot; but quicker}
          {If a ClassType was found, create an instance}
          </i></font>obj <font color="#000080">:= </font>ctype<font color="#000080">.</font>Create<font color="#000080">;
          </font><font color="#FF0000"><b>try
            </b></font><font color="#008000"><i>{if obj is a TPlayer, call its ReadData() method}
            </i></font><font color="#FF0000"><b>if </b></font>obj <font color="#FF0000"><b>is </b></font>TPlayer <font color="#FF0000"><b>then
              </b></font>TPlayer<font color="#000080">(</font>obj<font color="#000080">).</font>ReadData<font color="#000080">(</font>reader<font color="#000080">);
          </font><font color="#FF0000"><b>except
            </b></font>obj<font color="#000080">.</font>free<font color="#000080">;
            </font><font color="#FF0000"><b>raise</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#008000"><i>{add object to this list}
          </i></font>Add<font color="#000080">(</font>obj<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>ReadListEnd<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>finally
    </b></font>reader<font color="#000080">.</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TObjectList<font color="#000080">.</font>SaveToFile<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>stream <font color="#000080">: </font>TFileStream<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>stream <font color="#000080">:= </font>TFileStream<font color="#000080">.</font>Create<font color="#000080">(</font>filename<font color="#000080">, </font>fmCreate <font color="#FF0000"><b>or </b></font>fmOpenWrite<font color="#000080">);
  </font><font color="#FF0000"><b>try
    </b></font>SaveToStream<font color="#000080">(</font>stream<font color="#000080">);
  </font><font color="#FF0000"><b>finally
    </b></font>stream<font color="#000080">.</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TObjectList<font color="#000080">.</font>LoadFromFile<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>filename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>stream <font color="#000080">: </font>TFileStream<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>stream <font color="#000080">:= </font>TFileStream<font color="#000080">.</font>Create<font color="#000080">(</font>filename<font color="#000080">, </font>fmOpenRead<font color="#000080">);
  </font><font color="#FF0000"><b>try
    </b></font>Clear<font color="#000080">;
    </font>LoadFromStream<font color="#000080">(</font>stream<font color="#000080">);
  </font><font color="#FF0000"><b>finally
    </b></font>stream<font color="#000080">.</font>Free<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>initialization
  </b></font><font color="#008000"><i>{register TPlayer class here when program begins}
  </i></font>RegisterClass<font color="#000080">(</font>TPlayer<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0082.PAS">Original</a><b>]</b></p></body>
</html>
