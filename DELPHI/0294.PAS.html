<html>
<head><title> "stream for a buffered line by line acces" by MARTIN WALDENBURG</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0294.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{+--------------------------------------------------------------------------+
 | Class:       TLineStream
 | Created:     8.97
 | Author:      Martin Waldenburg
 | Copyright    1997, all rights reserved.
 | Description: TLineStream gives a buffered access to the lines of a
file.
 |              Every line must end with CRLF. Don't forget to flush the
 |              Memory after writing.
 | Version:     1.2
 | State:       FreeWare
 | Disclaimer:
 | This is provided as is, expressly without a warranty of any kind.
 | You use it at your own risc.

+--------------------------------------------------------------------------+}

</i></font><font color="#FF0000"><b>unit </b></font>mwLineStream<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
  </b></font>SysUtils<font color="#000080">, </font>Classes<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TLineStream <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TFileStream<font color="#000080">)
  </font><font color="#FF0000"><b>private
    </b></font>fLineStart<font color="#000080">: </font>PChar<font color="#000080">;
    </font>fMaxMemorySize<font color="#000080">:</font>Longint<font color="#000080">;
    </font>fMaxLineSize<font color="#000080">:</font>Longint<font color="#000080">;
    </font>fMemorySize<font color="#000080">: </font>LongInt<font color="#000080">;
    </font>fLineSize<font color="#000080">:</font>Longint<font color="#000080">;
    </font>fMemory<font color="#000080">:</font>PChar<font color="#000080">;
    </font>fLine<font color="#000080">: </font>PChar<font color="#000080">;
    </font>fFileEof<font color="#000080">:</font>Boolean<font color="#000080">;
    </font>fMemoryPos<font color="#000080">: </font>LongInt<font color="#000080">;
    </font>fEof<font color="#000080">:</font>Boolean<font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetMemoryFull<font color="#000080">:</font>Boolean<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>SetMaxLineSize<font color="#000080">(</font>NewValue<font color="#000080">:</font>Longint<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>SetMaxMemorySize<font color="#000080">(</font>NewValue<font color="#000080">:</font>Longint<font color="#000080">);
  </font><font color="#FF0000"><b>protected
  public
    constructor </b></font>create<font color="#000080">(</font><font color="#FF0000"><b>Const </b></font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;  </font>Mode<font color="#000080">: </font>Word<font color="#000080">);
    </font><font color="#FF0000"><b>destructor </b></font>destroy<font color="#000080">;</font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>FillMemory<font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>ReadLine<font color="#000080">:</font>PChar<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>WriteLine<font color="#000080">(</font>NewLine<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>FlushMemory<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Reset<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>MaxMemorySize<font color="#000080">:</font>Longint <font color="#FF0000"><b>read </b></font>fMaxMemorySize <font color="#FF0000"><b>write
</b></font>SetMaxMemorySize<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>MaxLineSize<font color="#000080">:</font>Longint <font color="#FF0000"><b>read </b></font>fMaxLineSize <font color="#FF0000"><b>write </b></font>SetMaxLineSize<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Memory<font color="#000080">:</font>PChar <font color="#FF0000"><b>read </b></font>fMemory <font color="#FF0000"><b>write </b></font>fMemory<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>MemoryFull<font color="#000080">:</font>Boolean <font color="#FF0000"><b>read </b></font>GetMemoryFull<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>FileEof<font color="#000080">:</font>Boolean <font color="#FF0000"><b>read </b></font>fFileEof<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Eof<font color="#000080">:</font>Boolean <font color="#FF0000"><b>read </b></font>fEof <font color="#FF0000"><b>write </b></font>fEof<font color="#000080">;
  </font><font color="#FF0000"><b>published
  end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TLineStream }

</i></font><font color="#FF0000"><b>implementation

constructor </b></font>TLineStream<font color="#000080">.</font>create<font color="#000080">(</font><font color="#FF0000"><b>Const </b></font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;  </font>Mode<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>fHandle<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not </b></font>FileExists<font color="#000080">(</font>FileName<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>fHandle<font color="#000080">:= </font>FileCreate<font color="#000080">(</font>FileName<font color="#000080">);
      </font>FileClose<font color="#000080">(</font>fHandle<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>inherited </b></font>create<font color="#000080">(</font>FileName<font color="#000080">, </font>Mode<font color="#000080">);
  </font>fEof<font color="#000080">:= </font>False<font color="#000080">;
  </font>fFileEof<font color="#000080">:= </font>False<font color="#000080">;
  </font>MaxMemorySize<font color="#000080">:= </font><font color="#800000">65535</font><font color="#000080">;
  </font>fMemorySize<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>fMemoryPos<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>MaxLineSize<font color="#000080">:= </font><font color="#800000">4096</font><font color="#000080">;
  </font>Position<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ create }

</i></font><font color="#FF0000"><b>destructor </b></font>TLineStream<font color="#000080">.</font>destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ReallocMem<font color="#000080">(</font>fMemory<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>ReallocMem<font color="#000080">(</font>fLine<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>inherited </b></font>destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ destroy }


</i></font><font color="#FF0000"><b>procedure </b></font>TLineStream<font color="#000080">.</font>SetMaxMemorySize<font color="#000080">(</font>NewValue<font color="#000080">:</font>Longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>fMaxMemorySize<font color="#000080">:= </font>NewValue<font color="#000080">;
  </font>ReallocMem<font color="#000080">(</font>fMemory<font color="#000080">, </font>fMaxMemorySize <font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ SetMaxMemorySize }

</i></font><font color="#FF0000"><b>procedure </b></font>TLineStream<font color="#000080">.</font>SetMaxLineSize<font color="#000080">(</font>NewValue<font color="#000080">:</font>Longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>fMaxLineSize<font color="#000080">:= </font>NewValue<font color="#000080">;
  </font>ReallocMem<font color="#000080">(</font>fLine<font color="#000080">, </font>fMaxLineSize <font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ SetMaxLineSize }

</i></font><font color="#FF0000"><b>procedure </b></font>TLineStream<font color="#000080">.</font>FillMemory<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Readed<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Readed<font color="#000080">:= </font>Read<font color="#000080">(</font>fMemory<font color="#000080">^, </font>fMaxMemorySize<font color="#000080">);
  </font>fMemorySize<font color="#000080">:= </font>Readed<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Readed <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>fFileEof<font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>fMemorySize <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  while </b></font>fMemory<font color="#000080">[</font>fMemorySize <font color="#000080">-</font><font color="#800000">2</font><font color="#000080">] &lt;&gt; </font><font color="#800000">#13 </font><font color="#FF0000"><b>do  </b></font>dec<font color="#000080">(</font>fMemorySize<font color="#000080">);
  </font>fMemory<font color="#000080">[</font>fMemorySize<font color="#000080">]:= </font><font color="#800000">#0</font><font color="#000080">;
  </font>Position<font color="#000080">:= </font>Position <font color="#000080">-</font>Readed <font color="#000080">+ </font>fMemorySize <font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
  </font>fLineStart<font color="#000080">:= </font>fMemory<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{ FillMemory }

</i></font><font color="#FF0000"><b>function </b></font>TLineStream<font color="#000080">.</font>GetMemoryFull<font color="#000080">:</font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>fMemorySize <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Result<font color="#000080">:= </font>True <font color="#FF0000"><b>else </b></font>Result<font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ GetMemoryFull }

</i></font><font color="#FF0000"><b>function </b></font>TLineStream<font color="#000080">.</font>ReadLine<font color="#000080">:</font>PChar<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Run<font color="#000080">: </font>PChar<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>fMemorySize <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and not </b></font>FileEof <font color="#FF0000"><b>then </b></font>FillMemory<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>fMemorySize <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>Run<font color="#000080">:= </font>fLineStart<font color="#000080">;
    </font><font color="#FF0000"><b>while </b></font>Run<font color="#000080">^ &lt;&gt; </font><font color="#800000">#13 </font><font color="#FF0000"><b>do </b></font>inc<font color="#000080">(</font>Run<font color="#000080">);
    </font>fLineSize<font color="#000080">:= </font>Run <font color="#000080">- </font>fLineStart<font color="#000080">;
    </font>inc<font color="#000080">(</font>Run<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
    </font>StrLCopy<font color="#000080">(</font>fLine<font color="#000080">, </font>fLineStart<font color="#000080">, </font>fLineSize<font color="#000080">);
    </font>fLine<font color="#000080">[</font>fLineSize<font color="#000080">]:= </font><font color="#800000">#0</font><font color="#000080">;
    </font>Result<font color="#000080">:= </font>fLine<font color="#000080">;
    </font>fLineStart<font color="#000080">:= </font>Run<font color="#000080">;
    </font><font color="#FF0000"><b>Case </b></font>Run<font color="#000080">^ </font><font color="#FF0000"><b>of </b></font><font color="#800000">#0</font><font color="#000080">: </font>FillMemory <font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>fMemorySize <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>fEof<font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{ ReadLine }

</i></font><font color="#FF0000"><b>procedure </b></font>TLineStream<font color="#000080">.</font>WriteLine<font color="#000080">(</font>NewLine<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Count<font color="#000080">, </font>Pos<font color="#000080">: </font>Longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>NewLine<font color="#000080">:= </font>NewLine <font color="#000080">+ </font><font color="#800000">#13#10</font><font color="#000080">;
  </font>Count<font color="#000080">:= </font>Length<font color="#000080">(</font>NewLine<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>fMemoryPos <font color="#000080">&gt;= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Count <font color="#000080">&gt;= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>Pos <font color="#000080">:= </font>fMemoryPos <font color="#000080">+ </font>Count<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Pos <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      if </b></font>Pos <font color="#000080">&gt; </font>FMaxMemorySize <font color="#FF0000"><b>then
        begin
           </b></font>FlushMemory<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>StrECopy<font color="#000080">((</font>fMemory <font color="#000080">+ </font>fMemoryPos<font color="#000080">), </font>PChar<font color="#000080">(</font>NewLine<font color="#000080">));
      </font>fMemoryPos<font color="#000080">:= </font>fMemoryPos <font color="#000080">+ </font>Count<font color="#000080">;
      </font>fMemory<font color="#000080">[</font>fMemoryPos<font color="#000080">]:= </font><font color="#800000">#0</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ WriteLine }

</i></font><font color="#FF0000"><b>procedure </b></font>TLineStream<font color="#000080">.</font>FlushMemory<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Write<font color="#000080">(</font>fMemory<font color="#000080">^, </font>fMemoryPos<font color="#000080">);
  </font>fMemoryPos<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ FlushMemory }

</i></font><font color="#FF0000"><b>procedure </b></font>TLineStream<font color="#000080">.</font>Reset<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>fEof<font color="#000080">:= </font>False<font color="#000080">;
  </font>fFileEof<font color="#000080">:= </font>False<font color="#000080">;
  </font>fMemorySize<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>fMemoryPos<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Position<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Reset }

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0294.PAS">Original</a><b>]</b></p></body>
</html>
