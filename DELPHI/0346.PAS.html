<html>
<head><title> "Printing with Richedit" by JAMES BACUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0346.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">James V<font color="#000080">. </font>Bacus <font color="#000080">&lt;</font>bacuslab<font color="#000080">@</font>mcs<font color="#000080">.</font>net<font color="#000080">&gt;

</font>I have written a <font color="#FF0000"><b>program </b></font>that collects information that a user selects<font color="#000080">, </font>by
a number <font color="#FF0000"><b>of </b></font>checkboxes <font color="#FF0000"><b>and </b></font>buttons<font color="#000080">, </font><font color="#FF0000"><b>to </b></font>a non visible RichEdit box<font color="#000080">.  </font>The
<font color="#FF0000"><b>program </b></font>was written under Windows <font color="#800000">95 </font><font color="#FF0000"><b>and </b></font>works fine<font color="#000080">.  </font>But under NT <font color="#800000">4.0 </font>the
line <font color="#000080">...

</font>RichEdit1<font color="#000080">.</font>Print<font color="#000080">(</font><font color="#800000">''</font><font color="#000080">); 

</font>returns a Divide by Zero Error<font color="#000080">.  </font>The only way I have found round this <font color="#FF0000"><b>is to
</b></font>save the <font color="#FF0000"><b>file and </b></font>use Word <font color="#FF0000"><b>to </b></font>print the final <font color="#FF0000"><b>file</b></font><font color="#000080">.

</font>Does anyone have <font color="#FF0000"><b>or </b></font>know <font color="#FF0000"><b>of </b></font>any workrounds<font color="#000080">?

</font>Yes<font color="#000080">, </font>I have a solution <font color="#FF0000"><b>and </b></font>a fix<font color="#000080">...
</font><font color="#FF0000"><b>To </b></font>fix this problem <font color="#FF0000"><b>requires </b></font>a minor change <font color="#FF0000"><b>to </b></font>the VCL <font color="#FF0000"><b>unit </b></font>ComCtrls<font color="#000080">.</font>pas<font color="#000080">.

</font>I<font color="#800000">'ve tested this on many different systems running NT 4.0 and Win95, and all seems to work well now. It'</font>s actually a very simple fix<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>here it <font color="#FF0000"><b>is</b></font><font color="#000080">...



--------------------------------------------------------------------------------

</font><font color="#008000"><i>{
A compatibility problem exists with the original RichEdit.Print method
code and the release of NT 4.0.  A EDivByZero exception is caused because
accessing the Printer.Handle property outside of a BeginDoc/EndDoc block
returns an Information Context (IC) handle under NT 4.0 instead of a
Device Context (DC) handle.  The EM_FORMATRANGE attempts to use this IC
instead of a real printer DC, which causes the exception.  If the Handle
property is accessed AFTER the BeginDoc, a true Device Context handle is
returned, and I have modified the code to handle this correctly.  I have
left the original position of BeginDoc in the code but remarked it out to
indicate the difference.    J.V.Bacus 11/12/96
}
</i></font><font color="#FF0000"><b>procedure </b></font>TCustomRichEdit<font color="#000080">.</font>Print<font color="#000080">(</font><font color="#FF0000"><b>const </b></font>Caption<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Range<font color="#000080">: </font>TFormatRange<font color="#000080">;
  </font>LastChar<font color="#000080">, </font>MaxLen<font color="#000080">, </font>LogX<font color="#000080">, </font>LogY<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FillChar<font color="#000080">(</font>Range<font color="#000080">, </font>SizeOf<font color="#000080">(</font>TFormatRange<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>with </b></font>Printer<font color="#000080">, </font>Range <font color="#FF0000"><b>do
  begin
    </b></font>LogX <font color="#000080">:= </font>GetDeviceCaps<font color="#000080">(</font>Handle<font color="#000080">, </font>LOGPIXELSX<font color="#000080">);
    </font>LogY <font color="#000080">:= </font>GetDeviceCaps<font color="#000080">(</font>Handle<font color="#000080">, </font>LOGPIXELSY<font color="#000080">);
    </font><font color="#008000"><i>// The repositioned BeginDoc to now be compatible with
    // both NT 4.0 and Win95
    </i></font>BeginDoc<font color="#000080">;
    </font>hdc <font color="#000080">:= </font>Handle<font color="#000080">;
    </font>hdcTarget <font color="#000080">:= </font>hdc<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>IsRectEmpty<font color="#000080">(</font>PageRect<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>rc<font color="#000080">.</font>right <font color="#000080">:= </font>PageWidth <font color="#000080">* </font><font color="#800000">1440 </font><font color="#FF0000"><b>div </b></font>LogX<font color="#000080">;
      </font>rc<font color="#000080">.</font>bottom <font color="#000080">:= </font>PageHeight <font color="#000080">* </font><font color="#800000">1440 </font><font color="#FF0000"><b>div </b></font>LogY<font color="#000080">;
    </font><font color="#FF0000"><b>end
    else begin
      </b></font>rc<font color="#000080">.</font>left <font color="#000080">:= </font>PageRect<font color="#000080">.</font>Left <font color="#000080">* </font><font color="#800000">1440 </font><font color="#FF0000"><b>div </b></font>LogX<font color="#000080">;
      </font>rc<font color="#000080">.</font>top <font color="#000080">:= </font>PageRect<font color="#000080">.</font>Top <font color="#000080">* </font><font color="#800000">1440 </font><font color="#FF0000"><b>div </b></font>LogY<font color="#000080">;
      </font>rc<font color="#000080">.</font>right <font color="#000080">:= </font>PageRect<font color="#000080">.</font>Right <font color="#000080">* </font><font color="#800000">1440 </font><font color="#FF0000"><b>div </b></font>LogX<font color="#000080">;
      </font>rc<font color="#000080">.</font>bottom <font color="#000080">:= </font>PageRect<font color="#000080">.</font>Bottom <font color="#000080">* </font><font color="#800000">1440 </font><font color="#FF0000"><b>div </b></font>LogY<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>rcPage <font color="#000080">:= </font>rc<font color="#000080">;
    </font>Title <font color="#000080">:= </font>Caption<font color="#000080">;
    </font><font color="#008000"><i>// The original position of BeginDoc
    { BeginDoc; }
    </i></font>LastChar <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>MaxLen <font color="#000080">:= </font>GetTextLen<font color="#000080">;
    </font>chrg<font color="#000080">.</font>cpMax <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>repeat
      </b></font>chrg<font color="#000080">.</font>cpMin <font color="#000080">:= </font>LastChar<font color="#000080">;
      </font>LastChar <font color="#000080">:= </font>SendMessage<font color="#000080">(</font>Self<font color="#000080">.</font>Handle<font color="#000080">, </font>EM_FORMATRANGE<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>Longint<font color="#000080">(@</font>Range<font color="#000080">));
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>LastChar <font color="#000080">&lt; </font>MaxLen<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>LastChar <font color="#000080">&lt;&gt; -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>NewPage<font color="#000080">;
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>LastChar <font color="#000080">&gt;= </font>MaxLen<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>LastChar <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">);
    </font>EndDoc<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>SendMessage<font color="#000080">(</font>Handle<font color="#000080">, </font>EM_FORMATRANGE<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0346.PAS">Original</a><b>]</b></p></body>
</html>
