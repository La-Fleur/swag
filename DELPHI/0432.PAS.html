<html>
<head><title> "Shared memory in a DLL with Delphi 2.0" by JOHN CRANE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0432.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">From<font color="#000080">: </font>johnnysc<font color="#000080">@</font>ix<font color="#000080">.</font>netcom<font color="#000080">.</font>com <font color="#000080">(</font>John Crane<font color="#000080">)

</font>Sharing Memory Mapped Files<font color="#000080">... </font>Check <font color="#FF0000"><b>out </b></font>the following code<font color="#000080">:


--------------------------------------------------------------------------------

</font><font color="#FF0000"><b>var
  </b></font>HMapping<font color="#000080">: </font>THandle<font color="#000080">;
  </font>PMapData<font color="#000080">: </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>MAPFILESIZE <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>OpenMap<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>llInit<font color="#000080">: </font>Boolean<font color="#000080">;
  </font>lInt<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>HMapping <font color="#000080">:= </font>CreateFileMapping<font color="#000080">(</font><font color="#800000">$FFFFFFFF</font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>PAGE_READWRITE<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>MAPFILESIZE<font color="#000080">, </font>pchar<font color="#000080">(</font><font color="#800000">'MY MAP NAME GOES HERE'</font><font color="#000080">));
  </font><font color="#008000"><i>// Check if already exists
  </i></font>llInit <font color="#000080">:= (</font>GetLastError<font color="#000080">() &lt;&gt; </font>ERROR_ALREADY_EXISTS<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>hMapping <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
    </b></font>ShowMessage<font color="#000080">(</font><font color="#800000">'Can''t Create Memory Map'</font><font color="#000080">);
    </font>Application<font color="#000080">.</font>Terminate<font color="#000080">;
    </font>exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>PMapData <font color="#000080">:= </font>MapViewOfFile<font color="#000080">(</font>HMapping<font color="#000080">, </font>FILE_MAP_ALL_ACCESS<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>PMapData <font color="#000080">= </font><font color="#FF0000"><b>nil then begin
    </b></font>CloseHandle<font color="#000080">(</font>HMapping<font color="#000080">);
    </font>ShowMessage<font color="#000080">(</font><font color="#800000">'Can''t View Memory Map'</font><font color="#000080">);
    </font>Application<font color="#000080">.</font>Terminate<font color="#000080">;
    </font>exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>llInit<font color="#000080">) </font><font color="#FF0000"><b>then begin
    </b></font><font color="#008000"><i>// Init block to #0 if newly created
    </i></font>memset<font color="#000080">(</font>PMapData<font color="#000080">, </font><font color="#800000">#0</font><font color="#000080">, </font>MAPFILESIZE<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>CloseMap<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>PMapData <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
    </b></font>UnMapViewOfFile<font color="#000080">(</font>PMapData<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>HMapping <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font>CloseHandle<font color="#000080">(</font>HMapping<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

--------------------------------------------------------------------------------

</font>Any two <font color="#FF0000"><b>or </b></font>more applications <font color="#FF0000"><b>or </b></font>DLLs may obtain pointers <font color="#FF0000"><b>to </b></font>the same physical block <font color="#FF0000"><b>of </b></font>memory this way<font color="#000080">. </font>PMapData will point <font color="#FF0000"><b>to </b></font>a <font color="#800000">1000 </font>byte buffer <font color="#FF0000"><b>in </b></font>this example<font color="#000080">, </font>this buffer being initialized <font color="#FF0000"><b>to </b></font><font color="#800000">#0's the first time in. One potential problem is synchronizing access to the memory. You may accomplish this through the use of mutexes. Here'</font>s an example <font color="#FF0000"><b>of </b></font>that<font color="#000080">:


--------------------------------------------------------------------------------

</font><font color="#008000"><i>{ Call LockMap before writing (and reading?) to the memory mapped file.  Be sure to call UnlockMap immediately when done updating. }

</i></font><font color="#FF0000"><b>var
  </b></font>HMapMutex<font color="#000080">: </font>THandle<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>REQUEST_TIMEOUT <font color="#000080">= </font><font color="#800000">1000</font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>LockMap<font color="#000080">:</font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:= </font>true<font color="#000080">;
  </font>HMapMutex <font color="#000080">:= </font>CreateMutex<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>false<font color="#000080">, </font>pchar<font color="#000080">(</font><font color="#800000">'MY MUTEX NAME GOES HERE'</font><font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font>HMixMutex <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font>ShowMessage<font color="#000080">(</font><font color="#800000">'Can''t create map mutex'</font><font color="#000080">);
    </font>Result <font color="#000080">:= </font>false<font color="#000080">;
  </font><font color="#FF0000"><b>end else begin
    if </b></font>WaitForSingleObject<font color="#000080">(</font>HMapMutex<font color="#000080">,</font>REQUEST_TIMEOUT<font color="#000080">) = </font>WAIT_FAILED <font color="#FF0000"><b>then begin
      </b></font><font color="#008000"><i>// timeout
      </i></font>ShowMessage<font color="#000080">(</font><font color="#800000">'Can''t lock memory mapped file'</font><font color="#000080">);
      </font>Result <font color="#000080">:= </font>false<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>UnlockMap<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ReleaseMutex<font color="#000080">(</font>HMixMutex<font color="#000080">);
  </font>CloseHandle<font color="#000080">(</font>HMixMutex<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

--------------------------------------------------------------------------------

</font>Please excuse my unnecessary <font color="#FF0000"><b>begin</b></font><font color="#000080">..</font><font color="#FF0000"><b>end</b></font><font color="#800000">'s. I come from a Clipper background, and I prefer to see my logic blocks capped off with end'</font>s <font color="#000080">- </font>easier <font color="#FF0000"><b>to </b></font>follow<font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0432.PAS">Original</a><b>]</b></p></body>
</html>
