<html>
<head><title> "Execute a MS-DOS program in Delphi" by KEITH ANDERSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0292.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I need run a MS-DOS program at my program, and wait until MS-DOS program
&gt; finish its work.

Here is probably the most original way to do this, but works the best.
It creates a .PIF file and uses that to execute the DOS program.
Note that the first function &quot;exec&quot; runs a windows program and waits, etc.
(This is for Delphi 2.x only)

  Function Exec(Path,Params,WorkPath:string; Wait:Boolean; Runmode:integer):boolean;
  {Path       Full path to the executable
   Params     Parameters
   WorkPath   Default directory, '' if same path as executable
   Wait       TRUE if execution of current program waits until new program finishes
   RUNMODE    How the application is executed (0 for default SHOWNORMAL):

      Value                  Meaning
      SW_HIDE                Hides the window and activates another window.
      SW_MAXIMIZE            Maximizes the specified window.
      SW_MINIMIZE            Minimizes the specified window and activates the
                             next top-level window in the Z order.
      SW_RESTORE             Activates and displays the window. If the window
                             is minimized or maximized, Windows restores it to
                             its original size and position. An application
                             should specify this flag when restoring a minimized
                             window.
      SW_SHOW                Activates the window and displays it in its current
                             size and position.
      SW_SHOWDEFAULT         Sets the show state based on the SW_ flag specified
                             in the STARTUPINFO structure passed to the CreateProcess
                             function by the program that started the application. An
                             application should call ShowWindow with this flag to set
                             the initial show state of its main window.
      SW_SHOWMAXIMIZED       Activates the window and displays it as a maximized window.
      SW_SHOWMINIMIZED       Activates the window and displays it as a minimized window.
      SW_SHOWMINNOACTIVE     Displays the window as a minimized window. The active
                             window remains active.
      SW_SHOWNA              Displays the window in its current state. The active
                             window remains active.
      SW_SHOWNOACTIVATE      Displays a window in its most recent size and position.
                             The active window remains active.
      SW_SHOWNORMAL          Activates and displays a window. If the window is minimized
                             or maximized, Windows restores it to its original size and
                             position. An application should specify this flag when
                             displaying the window for the first time.}

  </i></font><font color="#FF0000"><b>var </b></font>name<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
      </font>handle<font color="#000080">:</font>integer<font color="#000080">;
      </font>startUpInfo <font color="#000080">: </font>TStartupInfo<font color="#000080">;
      </font>processInfo       <font color="#000080">: </font>TProcessInformation<font color="#000080">;
      </font>exeCmd <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>begin
      if </b></font>Runmode<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Runmode<font color="#000080">:=</font>SW_SHOWNORMAL<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>WorkPath<font color="#000080">=</font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font>WorkPath<font color="#000080">:=</font>extractfilepath<font color="#000080">(</font>path<font color="#000080">);

      </font><font color="#FF0000"><b>if </b></font>wait
        <font color="#FF0000"><b>then begin  </b></font><font color="#008000"><i>// wait for the process to end...
               // Check to make{ If the execution file does not exist, then try
               // adding the path, if that fails then you're stuffed }
               </i></font><font color="#FF0000"><b>if not </b></font>FileExists<font color="#000080">(</font>path<font color="#000080">) </font><font color="#FF0000"><b>then begin
                  </b></font>result <font color="#000080">:= </font>false<font color="#000080">;
                  </font>exit<font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

               </font><font color="#008000"><i>// Concat in the parameters
               </i></font>exeCmd <font color="#000080">:= </font>path <font color="#000080">+ </font><font color="#800000">' ' </font><font color="#000080">+ </font>params<font color="#000080">;

               </font><font color="#008000"><i>// Initialise the StartUpInfo record, which handles the creation of

               // a new main window for a process
               </i></font>FillChar<font color="#000080">(</font>startUpInfo<font color="#000080">, </font>SizeOf<font color="#000080">(</font>startUpInfo<font color="#000080">), </font>Chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">));
                    </font>StartUpInfo<font color="#000080">.</font>cb <font color="#000080">:= </font>SizeOf<font color="#000080">( </font>StartUpInfo <font color="#000080">);
                    </font>StartUpInfo<font color="#000080">.</font>dwFlags     <font color="#000080">:= </font>STARTF_USESHOWWINDOW<font color="#000080">;
                    </font>StartUpInfo<font color="#000080">.</font>wShowWindow <font color="#000080">:= </font>runmode<font color="#000080">;

               </font><font color="#008000"><i>// Spawn the process out.
                    </i></font><font color="#FF0000"><b>if not </b></font>CreateProcess<font color="#000080">(


                        </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>PChar<font color="#000080">(</font>exeCmd<font color="#000080">), </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>false<font color="#000080">,
                        </font>CREATE_NEW_CONSOLE <font color="#FF0000"><b>or </b></font>NORMAL_PRIORITY_CLASS<font color="#000080">, </font><font color="#FF0000"><b>nil</b></font><font color="#000080">,
                        </font>PChar<font color="#000080">(</font>ExtractFilePath<font color="#000080">(</font>path<font color="#000080">)), </font>startUpInfo<font color="#000080">, </font>processInfo
                      <font color="#000080">) </font><font color="#FF0000"><b>then begin
                  </b></font>result <font color="#000080">:= </font>false<font color="#000080">;
               </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

               </font><font color="#008000"><i>// Wait for ze old process to finish.
               </i></font>WaitForSingleObject<font color="#000080">(</font>processInfo<font color="#000080">.</font>hProcess<font color="#000080">, </font>INFINITE<font color="#000080">);
             </font><font color="#FF0000"><b>end
        else begin
               </b></font>handle<font color="#000080">:=</font>ShellExecute<font color="#000080">(</font>Application<font color="#000080">.</font>Handle<font color="#000080">,</font><font color="#800000">'open'</font><font color="#000080">,</font>pchar<font color="#000080">(</font>path<font color="#000080">),</font>pchar<font color="#000080">(</font>params<font color="#000080">),
                                    </font>pchar<font color="#000080">(</font>WorkPath<font color="#000080">),</font>RunMode<font color="#000080">);
             </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


  </font><font color="#FF0000"><b>Function </b></font>ExecDOS<font color="#000080">(</font>Path<font color="#000080">,</font>Params<font color="#000080">,</font>WorkPath<font color="#000080">,</font>Title<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Wait<font color="#000080">:</font>Boolean<font color="#000080">; </font>Minimized<font color="#000080">:</font>Boolean<font color="#000080">):</font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{Just for DOS programs, creates a PIF file then executes it, deleting it afterward.
   Path       Full path to the executable
   Params     Parameters
   WorkPath   Default directory, '' if same path as executable
   Title      Title to display at top of window
   Wait       TRUE if execution of current program waits until new program finishes
   Minimized  TRUE if program is to run minimized.}
  </i></font><font color="#FF0000"><b>var </b></font>f<font color="#000080">:</font><font color="#FF0000"><b>file</b></font><font color="#000080">;
      </font>pifpath<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
      </font>a<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
      </font>ierr<font color="#000080">:</font>integer<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      if </b></font>WorkPath<font color="#000080">=</font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font>WorkPath<font color="#000080">:=</font>extractfilepath<font color="#000080">(</font>path<font color="#000080">);

      </font><font color="#008000"><i>// this is a generic PIF image that we've hacked to pieces...settings:
      //   Idle sensitivity set lowest
      //   Default window
      //   Exit on terminate
      //   All memory resources used if needed
      //   Allow screen saver
      //   Not dynamic allocation
      </i></font>a<font color="#000080">:=</font><font color="#800000">#0#120#84#69#83#84#68#79#126#49#32#32#32#32#32#32#32#32#32#32</font><font color="#000080">+
      </font><font color="#800000">#32#32#32#32#32#32#32#32#32#32#32#32#128#2#0#0#68#58#92#116#101</font><font color="#000080">+
      </font><font color="#800000">#115#116#100#111#115#112#114#111#103#114#97#109#116#104#105#110</font><font color="#000080">+
      </font><font color="#800000">#103#46#101#120#101#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#16#0#101#58#92#116#101#109#112</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#45#101#120</font><font color="#000080">+
      </font><font color="#800000">#32#100#58#92#116#101#115#116#32#100#58#92#42#46#42#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#1#0#255#25#80#0#0#7#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#77#73</font><font color="#000080">+
      </font><font color="#800000">#67#82#79#83#79#70#84#32#80#73#70#69#88#0#135#1#0#0#113#1#87#73</font><font color="#000080">+
      </font><font color="#800000">#78#68#79#87#83#32#51#56#54#32#51#46#48#0#5#2#157#1#104#0#128</font><font color="#000080">+
      </font><font color="#800000">#2#0#0#100#0#50#0#255#255#0#0#255#255#0#0#2#0#2#0#159#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#45#101#120#32#100#58#92#116#101</font><font color="#000080">+
      </font><font color="#800000">#115#116#32#100#58#92#42#46#42#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#87</font><font color="#000080">+
      </font><font color="#800000">#73#78#68#79#87#83#32#86#77#77#32#52#46#48#0#255#255#27#2#172</font><font color="#000080">+
      </font><font color="#800000">#1#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#80#73#70</font><font color="#000080">+
      </font><font color="#800000">#77#71#82#46#68#76#76#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#2#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#129#0#0#0#0#0#0#0#0#0#0#0#1#0#0#0#5#0#25#0#3#0#200#0</font><font color="#000080">+
      </font><font color="#800000">#232#3#2#0#10#0#1#0#0#0#0#0#0#0#28#0#0#0#0#0#0#0#8#0#12#0#84#101</font><font color="#000080">+
      </font><font color="#800000">#114#109#105#110#97#108#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#76#117#99#105#100#97#32#67#111#110#115#111#108#101</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#3#0#0#0#80#0#25#0#128</font><font color="#000080">+
      </font><font color="#800000">#2#44#1#0#0#0#0#22#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0</font><font color="#000080">+
      </font><font color="#800000">#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#0#1#0</font><font color="#000080">;
      </font>title<font color="#000080">:=</font>spaces<font color="#000080">(</font>title<font color="#000080">,</font><font color="#800000">30</font><font color="#000080">);
      </font>move<font color="#000080">(</font>title<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>a<font color="#000080">[</font><font color="#800000">$02</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">],</font><font color="#800000">30</font><font color="#000080">);

      </font><font color="#FF0000"><b>if </b></font>length<font color="#000080">(</font>path<font color="#000080">)&gt;</font><font color="#800000">63 </font><font color="#FF0000"><b>then </b></font>path<font color="#000080">:=</font>copy<font color="#000080">(</font>path<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">);
      </font>path<font color="#000080">:=</font>path<font color="#000080">+</font><font color="#800000">#0</font><font color="#000080">;
      </font>move<font color="#000080">(</font>path<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>a<font color="#000080">[</font><font color="#800000">$24</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">],</font>length<font color="#000080">(</font>path<font color="#000080">));

      </font><font color="#FF0000"><b>if </b></font>length<font color="#000080">(</font>params<font color="#000080">)&gt;</font><font color="#800000">63 </font><font color="#FF0000"><b>then </b></font>params<font color="#000080">:=</font>copy<font color="#000080">(</font>params<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">);
      </font>params<font color="#000080">:=</font>params<font color="#000080">+</font><font color="#800000">#0</font><font color="#000080">;
      </font>move<font color="#000080">(</font>params<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>a<font color="#000080">[</font><font color="#800000">$a5</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">],</font>length<font color="#000080">(</font>params<font color="#000080">));
      </font>move<font color="#000080">(</font>params<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>a<font color="#000080">[</font><font color="#800000">$1c5</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">],</font>length<font color="#000080">(</font>params<font color="#000080">));

      </font><font color="#FF0000"><b>if </b></font>length<font color="#000080">(</font>workpath<font color="#000080">)&gt;</font><font color="#800000">63 </font><font color="#FF0000"><b>then </b></font>workpath<font color="#000080">:=</font>copy<font color="#000080">(</font>workpath<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">63</font><font color="#000080">);
      </font>workpath<font color="#000080">:=</font>workpath<font color="#000080">+</font><font color="#800000">#0</font><font color="#000080">;
      </font>move<font color="#000080">(</font>workpath<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>a<font color="#000080">[</font><font color="#800000">$65</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">],</font>length<font color="#000080">(</font>workpath<font color="#000080">));

      </font><font color="#FF0000"><b>if </b></font>minimized
        <font color="#FF0000"><b>then </b></font>a<font color="#000080">[</font><font color="#800000">$1af</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]:=</font><font color="#800000">#$12
        </font><font color="#FF0000"><b>else </b></font>a<font color="#000080">[</font><font color="#800000">$1af</font><font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]:=</font><font color="#800000">#$2</font><font color="#000080">;

      </font>result<font color="#000080">:=</font>false<font color="#000080">; </font><font color="#008000"><i>// default unsuccessful
      </i></font>pifpath<font color="#000080">:=</font>newfilename<font color="#000080">(</font>temppath<font color="#000080">+</font><font color="#800000">'00000000.pif'</font><font color="#000080">,</font>false<font color="#000080">);
      </font>assignfile<font color="#000080">(</font>f<font color="#000080">,</font>pifpath<font color="#000080">);
      </font>rewrite<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
      </font>ierr<font color="#000080">:=</font>ioresult<font color="#000080">;
      </font>blockwrite<font color="#000080">(</font>f<font color="#000080">,</font>a<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>length<font color="#000080">(</font>a<font color="#000080">),</font>ierr<font color="#000080">);
      </font>closefile<font color="#000080">(</font>f<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>ierr<font color="#000080">&lt;&gt;</font>length<font color="#000080">(</font>a<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
      </font>result<font color="#000080">:=</font>exec<font color="#000080">(</font>pifpath<font color="#000080">,</font><font color="#800000">''</font><font color="#000080">,</font><font color="#800000">''</font><font color="#000080">,</font>wait<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font>application<font color="#000080">.</font>processmessages<font color="#000080">;
      </font><font color="#FF0000"><b>if not </b></font>wait <font color="#FF0000"><b>then </b></font>delay<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">); </font><font color="#008000"><i>// we must wait one second for Windows to read file
      </i></font>deletefile<font color="#000080">(</font>pifpath<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0292.PAS">Original</a><b>]</b></p></body>
</html>
