<html>
<head><title> "[D2]-Single Instance of Application" by MARC BATCHELOR</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0330.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; after a bit of thought I created the attached component (4.54K) for
&gt; making sure only one instance of an app
&gt; is run.
&gt;
&gt; I have tested this in several apps with absolutely no reocurence.  It
&gt; just drops on the main form has two properties
&gt;
&gt; let me know what you think of it.
&gt;

I had a look at the source code, and had a few comments. I sincerely
hope you were looking for constructive criticism :-)

If you use a temporary disk file, you run the risk of encountering a
situation where you can't start up any instances of the program at all.
For example, if the program crashes, the temporary file will remain on
the hard disk. Nothing short of deleting the file will allow an instance
of the program to run.

I suggest you use Semaphores or Mutexes. Here is an example using
Mutexes:

--------------------------------Cut Here-------------------------------


  Unit Name: AppInit
  Purpose: The purpose of this unit is to indicate whether a previous
           instance of an application is running.

  Author: Marc Batchelor
  Date: 06/19/97

  Usage: Simply include this unit in your Delphi 16/32 project. From the
         Project's Initialization, check the variable
         AppInit.IsFirstInstance. If IsFirstInstance is false, then
         the application can bring the previous instance in focus and
         terminate.
}

</i></font><font color="#FF0000"><b>unit </b></font>AppInit<font color="#000080">;

</font><font color="#FF0000"><b>interface

var
</b></font><font color="#008000"><i>{$IFDEF WIN32}
  </i></font>InstanceMutexHandle<font color="#000080">: </font>THandle <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>UniqueApplicationString<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
  </i></font>IsFirstInstance<font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>implementation

uses
  </b></font>SysUtils<font color="#000080">, </font>WinProcs<font color="#000080">, </font>WinTypes<font color="#000080">, </font>Classes<font color="#000080">, </font>Forms<font color="#000080">,  </font>dialogs<font color="#000080">;

</font><font color="#008000"><i>{$IFDEF WIN32}
</i></font><font color="#FF0000"><b>procedure </b></font>SetUniqueAppString<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>times<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Setup Unique String for the Mutex }
  </i></font>UniqueApplicationString <font color="#000080">:= </font><font color="#800000">'APPLICATION-' </font><font color="#000080">+ </font>Application<font color="#000080">.</font>ExeName<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>times <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Length<font color="#000080">(</font>UniqueApplicationString<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font><font color="#008000"><i>{ Mutex names can't have '\' in them, so perform replacement }
    </i></font><font color="#FF0000"><b>if </b></font>UniqueApplicationString<font color="#000080">[</font>times<font color="#000080">] = </font><font color="#800000">'\' </font><font color="#FF0000"><b>then
      </b></font>UniqueApplicationString<font color="#000080">[</font>times<font color="#000080">] := </font><font color="#800000">'_'</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ Uppercase the string to prevent case sensitivity problems }
  </i></font>UniqueApplicationString <font color="#000080">:= </font>AnsiUppercase<font color="#000080">(</font>UniqueApplicationString<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>InitInstance<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Check to see if the mutex is already there }
  </i></font>InstanceMutexHandle <font color="#000080">:= </font>OpenMutex<font color="#000080">(</font>MUTEX_ALL_ACCESS<font color="#000080">, </font>false<font color="#000080">,
    </font>pchar<font color="#000080">(</font>UniqueApplicationString<font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font>InstanceMutexHandle <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font><font color="#008000"><i>{ This is the first instance }
    </i></font>InstanceMutexHandle <font color="#000080">:= </font>CreateMutex<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font>false<font color="#000080">,
      </font>pchar<font color="#000080">(</font>UniqueApplicationString<font color="#000080">));
    </font><font color="#008000"><i>{ Error checking to see if anyone beat us... }
    </i></font><font color="#FF0000"><b>if </b></font>InstanceMutexHandle <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>IsFirstInstance <font color="#000080">:= </font>false
    <font color="#FF0000"><b>else
      </b></font>IsFirstInstance <font color="#000080">:= </font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else
    </b></font>IsFirstInstance <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>initialization
</b></font><font color="#008000"><i>{$IFDEF WIN32}
  </i></font>IsFirstInstance <font color="#000080">:= </font>false<font color="#000080">;
  </font>SetUniqueAppString<font color="#000080">;
  </font>InitInstance<font color="#000080">;
</font><font color="#FF0000"><b>finalization
  if </b></font>IsFirstInstance <font color="#FF0000"><b>then
  begin
    </b></font>CloseHandle<font color="#000080">(</font>InstanceMutexHandle<font color="#000080">);
    </font>InstanceMutexHandle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>UniqueApplicationString <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
  </i></font>IsFirstInstance <font color="#000080">= (</font>hPrevInst <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

--------------------------------</font>Cut Here<font color="#000080">-------------------------------


--
</font>Marc Batchelor
AppSource Corporation
http<font color="#000080">:</font><font color="#008000"><i>//www.appsource.com
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0330.PAS">Original</a><b>]</b></p></body>
</html>
