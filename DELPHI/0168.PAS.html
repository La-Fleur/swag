<html>
<head><title> "Nice Handling of Keyboard keys" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0168.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#000000">Here <font color="#FF0000"><b>is </b></font>the poor man<font color="#800000">'s version:

 </font><font color="#FF0000"><b>procedure </b></font>keybd_Event<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">; </font><font color="#FF0000"><b>external </b></font><font color="#800000">'USER' </font>index <font color="#800000">289</font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>PostVKey<font color="#000080">(</font>bVirtKey<font color="#000080">: </font>byte<font color="#000080">; </font>Up<font color="#000080">: </font>Boolean<font color="#000080">);
 </font><font color="#FF0000"><b>var
  </b></font>AXReg<font color="#000080">,</font>BXReg <font color="#000080">: </font>Word<font color="#000080">;
  </font>AXHigh<font color="#000080">, </font>AXLow<font color="#000080">, </font>BXHigh<font color="#000080">, </font>BXLow <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>MakeWord<font color="#000080">(</font>L<font color="#000080">,</font>H<font color="#000080">: </font>Byte<font color="#000080">): </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>MakeWord <font color="#000080">:= (</font>H <font color="#FF0000"><b>shl </b></font><font color="#800000">8</font><font color="#000080">) + </font>L<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>AXLow <font color="#000080">:= </font>bVirtKey<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>up <font color="#FF0000"><b>then </b></font>AXHigh <font color="#000080">:= </font><font color="#800000">$80 </font><font color="#FF0000"><b>else </b></font>AXHigh <font color="#000080">:= </font><font color="#800000">$0</font><font color="#000080">;
  </font>AXreg <font color="#000080">:= </font>MakeWord<font color="#000080">(</font>AXLow<font color="#000080">,</font>AXHigh<font color="#000080">);
  </font>BXLow <font color="#000080">:= </font>VkKeyScan<font color="#000080">(</font>bVirtKey<font color="#000080">);
  </font>BXHigh <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>BXReg <font color="#000080">:= </font>MakeWord<font color="#000080">(</font>BXLow<font color="#000080">,</font>BXHigh<font color="#000080">);
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov bx,BXreg;
    mov ax,AXReg;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Keybd_Event<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>then to </b></font>simulate Shift<font color="#000080">+</font>Ins you need<font color="#000080">:-

</font>PostVKey<font color="#000080">(</font>VK_Shift<font color="#000080">,</font>false<font color="#000080">);
</font>PostVKey<font color="#000080">(</font>VK_Insert<font color="#000080">,</font>false<font color="#000080">);
</font>PostVKey<font color="#000080">(</font>VK_Insert<font color="#000080">,</font>True<font color="#000080">);
</font>PostVKey<font color="#000080">(</font>VK_Shift<font color="#000080">,</font>True<font color="#000080">);

</font>Here <font color="#FF0000"><b>is </b></font>the Rolls<font color="#000080">-</font>Royce version<font color="#000080">:
</font>Note<font color="#000080">:  </font>This <font color="#FF0000"><b>is </b></font>commercial <font color="#FF0000"><b>and </b></font>copyrighted code<font color="#000080">.  </font>The source code may <font color="#FF0000"><b>not </b></font>be sold <font color="#FF0000"><b>for </b></font>profit
<font color="#000080">(</font>unless Steve <font color="#FF0000"><b>is </b></font>doing the selling<font color="#000080">).

</font><font color="#008000"><i>{This unit is to be included in the app that you are running.}
</i></font><font color="#FF0000"><b>unit </b></font>SKeys<font color="#000080">;
</font><font color="#FF0000"><b>interface
type
  </b></font><font color="#008000"><i>{ Return values for SendKeys function }
  </i></font>TSendKeyError <font color="#000080">= (</font>sk_None<font color="#000080">, </font>sk_FailSetHook<font color="#000080">, </font>sk_InvalidToken<font color="#000080">, </font>sk_UnknownError<font color="#000080">);
</font><font color="#FF0000"><b>function </b></font>SendKeys<font color="#000080">(</font>S<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>TSendKeyError<font color="#000080">;
</font><font color="#FF0000"><b>implementation
function </b></font>SendKeys<font color="#000080">; </font><font color="#FF0000"><b>external </b></font><font color="#800000">'SendKey' </font>index <font color="#800000">2</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font><font color="#008000"><i>(********************************************)
{Here is the DLL that is used.}
</i></font><font color="#FF0000"><b>library </b></font>SendKey<font color="#000080">;
</font><font color="#FF0000"><b>uses
 </b></font>SysUtils<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Messages<font color="#000080">, </font>Classes<font color="#000080">, </font>KeyDefs<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font><font color="#008000"><i>{ Error codes }
  </i></font>TSendKeyError <font color="#000080">= (</font>sk_None<font color="#000080">, </font>sk_FailSetHook<font color="#000080">, </font>sk_InvalidToken<font color="#000080">, </font>sk_UnknownError<font color="#000080">);
  </font><font color="#008000"><i>{ exceptions }
  </i></font>ESendKeyError <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>Exception<font color="#000080">);
  </font>ESetHookError <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>ESendKeyError<font color="#000080">);
  </font>EInvalidToken <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>ESendKeyError<font color="#000080">);
  </font><font color="#008000"><i>{ a TList descendant that know how to dispose of its contents }
  </i></font>TMessageList <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TList<font color="#000080">)
  </font><font color="#FF0000"><b>public
    destructor </b></font>Destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>destructor </b></font>TMessageList<font color="#000080">.</font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ deallocate all the message records before discarding the list }
  </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count <font color="#000080">- </font><font color="#800000">1 </font><font color="#FF0000"><b>do
    </b></font>Dispose<font color="#000080">(</font>PEventMsg<font color="#000080">(</font>Items<font color="#000080">[</font>i<font color="#000080">]));
  </font><font color="#FF0000"><b>inherited </b></font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font><font color="#008000"><i>{ variables global to the DLL }
  </i></font>MsgCount<font color="#000080">: </font>word<font color="#000080">;
  </font>MessageBuffer<font color="#000080">: </font>TEventMsg<font color="#000080">;
  </font>HookHandle<font color="#000080">: </font>hHook<font color="#000080">;
  </font>Playing<font color="#000080">: </font>Boolean<font color="#000080">;
  </font>MessageList<font color="#000080">: </font>TMessageList<font color="#000080">;
  </font>AltPressed<font color="#000080">, </font>ControlPressed<font color="#000080">, </font>ShiftPressed<font color="#000080">: </font>Boolean<font color="#000080">;
  </font>NextSpecialKey<font color="#000080">: </font>TKeyString<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>MakeWord<font color="#000080">(</font>L<font color="#000080">, </font>H<font color="#000080">: </font>Byte<font color="#000080">): </font>Word<font color="#000080">;
</font><font color="#008000"><i>{ macro creates a word from low and high bytes }
</i></font><font color="#FF0000"><b>inline</b></font><font color="#000080">(
  </font><font color="#800000">$5A</font><font color="#000080">/            </font><font color="#008000"><i>{ pop dx }
  </i></font><font color="#800000">$58</font><font color="#000080">/            </font><font color="#008000"><i>{ pop ax }
  </i></font><font color="#800000">$8A</font><font color="#000080">/</font><font color="#800000">$E2</font><font color="#000080">);       </font><font color="#008000"><i>{ mov ah, dl }

</i></font><font color="#FF0000"><b>procedure </b></font>StopPlayback<font color="#000080">;
</font><font color="#008000"><i>{ Unhook the hook, and clean up }
</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ if Hook is currently active, then unplug it }
  </i></font><font color="#FF0000"><b>if </b></font>Playing <font color="#FF0000"><b>then
    </b></font>UnhookWindowsHookEx<font color="#000080">(</font>HookHandle<font color="#000080">);
  </font>MessageList<font color="#000080">.</font>Free<font color="#000080">;
  </font>Playing <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Play<font color="#000080">(</font>Code<font color="#000080">: </font>integer<font color="#000080">; </font>wParam<font color="#000080">: </font>word<font color="#000080">; </font>lParam<font color="#000080">: </font>Longint<font color="#000080">): </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;

</font><font color="#008000"><i>{ This is the JournalPlayback callback function.  It is called by Windows }
{ when Windows polls for hardware events.  The code parameter indicates what }
{ to do. }
</i></font><font color="#FF0000"><b>begin
  case </b></font>Code <font color="#FF0000"><b>of
    </b></font>hc_Skip<font color="#000080">: </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{ hc_Skip means to pull the next message out of our list. If we }
    { are at the end of the list, it's okay to unhook the JournalPlayback }
    { hook from here. }
      { increment message counter }
      </i></font>inc<font color="#000080">(</font>MsgCount<font color="#000080">);
      </font><font color="#008000"><i>{ check to see if all messages have been played }
      </i></font><font color="#FF0000"><b>if </b></font>MsgCount <font color="#000080">&gt;= </font>MessageList<font color="#000080">.</font>Count <font color="#FF0000"><b>then
        </b></font>StopPlayback
      <font color="#FF0000"><b>else
      </b></font><font color="#008000"><i>{ copy next message from list into buffer }
      </i></font>MessageBuffer <font color="#000080">:= </font>TEventMsg<font color="#000080">(</font>MessageList<font color="#000080">.</font>Items<font color="#000080">[</font>MsgCount<font color="#000080">]^);
      </font>Result <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>hc_GetNext<font color="#000080">: </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{ hc_GetNext means to fill the wParam and lParam with the proper }
    { values so that the message can be played back.  DO NOT unhook }
    { hook from within here.  Return value indicates how much time until }
    { Windows should playback message.  We'll return 0 so that it's }
    { processed right away. }
      { move message in buffer to message queue }
      </i></font>PEventMsg<font color="#000080">(</font>lParam<font color="#000080">)^ := </font>MessageBuffer<font color="#000080">;
      </font>Result <font color="#000080">:= </font><font color="#800000">0  </font><font color="#008000"><i>{ process immediately }
    </i></font><font color="#FF0000"><b>end
    else
      </b></font><font color="#008000"><i>{ if Code isn't hc_Skip or hc_GetNext, then call next hook in chain }
      </i></font>Result <font color="#000080">:= </font>CallNextHookEx<font color="#000080">(</font>HookHandle<font color="#000080">, </font>Code<font color="#000080">, </font>wParam<font color="#000080">, </font>lParam<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>StartPlayback<font color="#000080">;
</font><font color="#008000"><i>{ Initializes globals and sets the hook }
</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ grab first message from list and place in buffer in case we }
  { get a hc_GetNext before and hc_Skip }
  </i></font>MessageBuffer <font color="#000080">:= </font>TEventMsg<font color="#000080">(</font>MessageList<font color="#000080">.</font>Items<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]^);
  </font><font color="#008000"><i>{ initialize message count and play indicator }
  </i></font>MsgCount <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#008000"><i>{ initialize Alt, Control, and Shift key flags }
  </i></font>AltPressed <font color="#000080">:= </font>False<font color="#000080">;
  </font>ControlPressed <font color="#000080">:= </font>False<font color="#000080">;
  </font>ShiftPressed <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#008000"><i>{ set the hook! }
  </i></font>HookHandle <font color="#000080">:= </font>SetWindowsHookEx<font color="#000080">(</font>wh_JournalPlayback<font color="#000080">, </font>Play<font color="#000080">, </font>hInstance<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>HookHandle <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    raise </b></font>ESetHookError<font color="#000080">.</font>Create<font color="#000080">(</font><font color="#800000">'Couldn''t set hook'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>Playing <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>MakeMessage<font color="#000080">(</font>vKey<font color="#000080">: </font>byte<font color="#000080">; </font>M<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#008000"><i>{ procedure builds a TEventMsg record that emulates a keystroke and }
{ adds it to message list }
</i></font><font color="#FF0000"><b>var
  </b></font>E<font color="#000080">: </font>PEventMsg<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>New<font color="#000080">(</font>E<font color="#000080">);                                 </font><font color="#008000"><i>{ allocate a message record }
  </i></font><font color="#FF0000"><b>with </b></font>E<font color="#000080">^ </font><font color="#FF0000"><b>do begin
    Message </b></font><font color="#000080">:= </font>M<font color="#000080">;                         </font><font color="#008000"><i>{ set message field }
    { high byte of ParamL is the vk code, low byte is the scan code }
    </i></font>ParamL <font color="#000080">:= </font>MakeWord<font color="#000080">(</font>vKey<font color="#000080">, </font>MapVirtualKey<font color="#000080">(</font>vKey<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">));
    </font>ParamH <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;                          </font><font color="#008000"><i>{ repeat count is 1 }
    </i></font>Time <font color="#000080">:= </font>GetTickCount<font color="#000080">;                 </font><font color="#008000"><i>{ set time }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>MessageList<font color="#000080">.</font>Add<font color="#000080">(</font>E<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>KeyDown<font color="#000080">(</font>vKey<font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#008000"><i>{ Generates KeyDownMessage }
</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ don't generate a &quot;sys&quot; key if the control key is pressed (Windows quirk) }
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>AltPressed <font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>ControlPressed<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>vKey <font color="#FF0000"><b>in </b></font><font color="#000080">[</font>Ord<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">)..</font>Ord<font color="#000080">(</font><font color="#800000">'Z'</font><font color="#000080">)])) </font><font color="#FF0000"><b>or
     </b></font><font color="#000080">(</font>vKey <font color="#000080">= </font>vk_Menu<font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font>MakeMessage<font color="#000080">(</font>vKey<font color="#000080">, </font>wm_SysKeyDown<font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>MakeMessage<font color="#000080">(</font>vKey<font color="#000080">, </font>wm_KeyDown<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>KeyUp<font color="#000080">(</font>vKey<font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#008000"><i>{ Generates KeyUp message }
</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ don't generate a &quot;sys&quot; key if the control key is pressed (Windows quirk) }
  </i></font><font color="#FF0000"><b>if </b></font>AltPressed <font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>ControlPressed<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>vKey <font color="#FF0000"><b>in </b></font><font color="#000080">[</font>Ord<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">)..</font>Ord<font color="#000080">(</font><font color="#800000">'Z'</font><font color="#000080">)]) </font><font color="#FF0000"><b>then
    </b></font>MakeMessage<font color="#000080">(</font>vKey<font color="#000080">, </font>wm_SysKeyUp<font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>MakeMessage<font color="#000080">(</font>vKey<font color="#000080">, </font>wm_KeyUp<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>SimKeyPresses<font color="#000080">(</font>VKeyCode<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#008000"><i>{ This function simulates keypresses for the given key, taking into }
{ account the current state of Alt, Control, and Shift keys }
</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ press Alt key if flag has been set }
  </i></font><font color="#FF0000"><b>if </b></font>AltPressed <font color="#FF0000"><b>then
    </b></font>KeyDown<font color="#000080">(</font>vk_Menu<font color="#000080">);
  </font><font color="#008000"><i>{ press Control key if flag has been set }
  </i></font><font color="#FF0000"><b>if </b></font>ControlPressed <font color="#FF0000"><b>then
    </b></font>KeyDown<font color="#000080">(</font>vk_Control<font color="#000080">);
  </font><font color="#008000"><i>{ if shift is pressed, or shifted key and control is not pressed... }
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(((</font>Hi<font color="#000080">(</font>VKeyCode<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>ControlPressed<font color="#000080">)) </font><font color="#FF0000"><b>or </b></font>ShiftPressed <font color="#FF0000"><b>then
    </b></font>KeyDown<font color="#000080">(</font>vk_Shift<font color="#000080">);    </font><font color="#008000"><i>{ ...press shift }
  </i></font>KeyDown<font color="#000080">(</font>Lo<font color="#000080">(</font>VKeyCode<font color="#000080">));  </font><font color="#008000"><i>{ press key down }
  </i></font>KeyUp<font color="#000080">(</font>Lo<font color="#000080">(</font>VKeyCode<font color="#000080">));    </font><font color="#008000"><i>{ release key }
  { if shift is pressed, or shifted key and control is not pressed... }
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(((</font>Hi<font color="#000080">(</font>VKeyCode<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>ControlPressed<font color="#000080">)) </font><font color="#FF0000"><b>or </b></font>ShiftPressed <font color="#FF0000"><b>then
    </b></font>KeyUp<font color="#000080">(</font>vk_Shift<font color="#000080">);      </font><font color="#008000"><i>{ ...release shift }
  { if shift flag is set, reset flag }
  </i></font><font color="#FF0000"><b>if </b></font>ShiftPressed <font color="#FF0000"><b>then begin
    </b></font>ShiftPressed <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ Release Control key if flag has been set, reset flag }
  </i></font><font color="#FF0000"><b>if </b></font>ControlPressed <font color="#FF0000"><b>then begin
    </b></font>KeyUp<font color="#000080">(</font>vk_Control<font color="#000080">);
    </font>ControlPressed <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ Release Alt key if flag has been set, reset flag }
  </i></font><font color="#FF0000"><b>if </b></font>AltPressed <font color="#FF0000"><b>then begin
    </b></font>KeyUp<font color="#000080">(</font>vk_Menu<font color="#000080">);
    </font>AltPressed <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>ProcessKey<font color="#000080">(</font>S<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#008000"><i>{ This function parses each character in the string to create the message list }
</i></font><font color="#FF0000"><b>var
  </b></font>KeyCode<font color="#000080">: </font>word<font color="#000080">;
  </font>Key<font color="#000080">: </font>byte<font color="#000080">;
  </font>index<font color="#000080">: </font>integer<font color="#000080">;
  </font>Token<font color="#000080">: </font>TKeyString<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>index <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>repeat
    case </b></font>S<font color="#000080">[</font>index<font color="#000080">] </font><font color="#FF0000"><b>of
      </b></font>KeyGroupOpen <font color="#000080">: </font><font color="#FF0000"><b>begin
      </b></font><font color="#008000"><i>{ It's the beginning of a special token! }
        </i></font>Token <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
        </font>inc<font color="#000080">(</font>index<font color="#000080">);
        </font><font color="#FF0000"><b>while </b></font>S<font color="#000080">[</font>index<font color="#000080">] &lt;&gt; </font>KeyGroupClose <font color="#FF0000"><b>do begin
          </b></font><font color="#008000"><i>{ add to Token until the end token symbol is encountered }
          </i></font>Token <font color="#000080">:= </font>Token <font color="#000080">+ </font>S<font color="#000080">[</font>index<font color="#000080">];
          </font>inc<font color="#000080">(</font>index<font color="#000080">);
          </font><font color="#008000"><i>{ check to make sure the token's not too long }
          </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Length<font color="#000080">(</font>Token<font color="#000080">) = </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>S<font color="#000080">[</font>index<font color="#000080">] &lt;&gt; </font>KeyGroupClose<font color="#000080">) </font><font color="#FF0000"><b>then
            raise </b></font>EInvalidToken<font color="#000080">.</font>Create<font color="#000080">(</font><font color="#800000">'No closing brace'</font><font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#008000"><i>{ look for token in array, Key parameter will }
        { contain vk code if successful }
        </i></font><font color="#FF0000"><b>if not </b></font>FindKeyInArray<font color="#000080">(</font>Token<font color="#000080">, </font>Key<font color="#000080">) </font><font color="#FF0000"><b>then
          raise </b></font>EInvalidToken<font color="#000080">.</font>Create<font color="#000080">(</font><font color="#800000">'Invalid token'</font><font color="#000080">);
        </font><font color="#008000"><i>{ simulate keypress sequence }
        </i></font>SimKeyPresses<font color="#000080">(</font>MakeWord<font color="#000080">(</font>Key<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">));
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>AltKey <font color="#000080">: </font><font color="#FF0000"><b>begin
        </b></font><font color="#008000"><i>{ set Alt flag }
        </i></font>AltPressed <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>ControlKey <font color="#000080">: </font><font color="#FF0000"><b>begin
        </b></font><font color="#008000"><i>{ set Control flag }
        </i></font>ControlPressed <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>ShiftKey <font color="#000080">: </font><font color="#FF0000"><b>begin
        </b></font><font color="#008000"><i>{ set Shift flag }
        </i></font>ShiftPressed <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>else begin
      </b></font><font color="#008000"><i>{ A normal character was pressed }
        { convert character into a word where the high byte contains }
        { the shift state and the low byte contains the vk code }
        </i></font>KeyCode <font color="#000080">:= </font>vkKeyScan<font color="#000080">(</font>MakeWord<font color="#000080">(</font>Byte<font color="#000080">(</font>S<font color="#000080">[</font>index<font color="#000080">]), </font><font color="#800000">0</font><font color="#000080">));
        </font><font color="#008000"><i>{ simulate keypress sequence }
        </i></font>SimKeyPresses<font color="#000080">(</font>KeyCode<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>inc<font color="#000080">(</font>index<font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font>index <font color="#000080">&gt; </font>Length<font color="#000080">(</font>S<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>SendKeys<font color="#000080">(</font>S<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>TSendKeyError<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
</font><font color="#008000"><i>{ This is the one entry point.  Based on the string passed in the S  }
{ parameter, this function creates a list of keyup/keydown messages, }
{ sets a JournalPlayback hook, and replays the keystroke messages.   }
</i></font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  try
    </b></font>Result <font color="#000080">:= </font>sk_None<font color="#000080">;                   </font><font color="#008000"><i>{ assume success }
    </i></font>MessageList <font color="#000080">:= </font>TMessageList<font color="#000080">.</font>Create<font color="#000080">;  </font><font color="#008000"><i>{ create list of messages }
    </i></font>ProcessKey<font color="#000080">(</font>S<font color="#000080">);                       </font><font color="#008000"><i>{ create messages from string }
    </i></font>StartPlayback<font color="#000080">;                       </font><font color="#008000"><i>{ set hook and play back messages }
  </i></font><font color="#FF0000"><b>except
    </b></font><font color="#008000"><i>{ if an exception occurs, return an error code, and clean up }
    </i></font><font color="#FF0000"><b>on </b></font>E<font color="#000080">:</font>ESendKeyError <font color="#FF0000"><b>do begin
      </b></font>MessageList<font color="#000080">.</font>Free<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>E <font color="#FF0000"><b>is </b></font>ESetHookError <font color="#FF0000"><b>then
        </b></font>Result <font color="#000080">:= </font>sk_FailSetHook
      <font color="#FF0000"><b>else if </b></font>E <font color="#FF0000"><b>is </b></font>EInvalidToken <font color="#FF0000"><b>then
        </b></font>Result <font color="#000080">:= </font>sk_InvalidToken<font color="#000080">;
    </font><font color="#FF0000"><b>end
    else
      </b></font><font color="#008000"><i>{ Catch-all exception handler ensures than an exception }
      { doesn't walk up into application stack }
      </i></font>Result <font color="#000080">:= </font>sk_UnknownError<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>exports
  </b></font>SendKeys <font color="#FF0000"><b>index </b></font><font color="#800000">2</font><font color="#000080">;
</font><font color="#FF0000"><b>begin
end</b></font><font color="#000080">.

</font><font color="#008000"><i>(********************************************)
</i></font><font color="#FF0000"><b>unit </b></font>Keydefs<font color="#000080">;
</font><font color="#FF0000"><b>interface
uses </b></font>WinTypes<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>MaxKeys <font color="#000080">= </font><font color="#800000">24</font><font color="#000080">;
  </font>ControlKey <font color="#000080">= </font><font color="#800000">'^'</font><font color="#000080">;
  </font>AltKey <font color="#000080">= </font><font color="#800000">'@'</font><font color="#000080">;
  </font>ShiftKey <font color="#000080">= </font><font color="#800000">'~'</font><font color="#000080">;
  </font>KeyGroupOpen <font color="#000080">= </font><font color="#800000">'{'</font><font color="#000080">;
  </font>KeyGroupClose <font color="#000080">= </font><font color="#800000">'}'</font><font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>TKeyString <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">7</font><font color="#000080">];
  </font>TKeyDef <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>Key<font color="#000080">: </font>TKeyString<font color="#000080">;
    </font>vkCode<font color="#000080">: </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>KeyDefArray <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>MaxKeys<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>TKeyDef <font color="#000080">= (
    (</font>Key<font color="#000080">: </font><font color="#800000">'F1'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F1<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F2'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F2<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F3'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F3<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F4'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F4<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F5'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F5<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F6'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F6<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F7'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F7<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F8'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F8<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F9'</font><font color="#000080">;     </font>vkCode<font color="#000080">: </font>vk_F9<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F10'</font><font color="#000080">;    </font>vkCode<font color="#000080">: </font>vk_F10<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F11'</font><font color="#000080">;    </font>vkCode<font color="#000080">: </font>vk_F11<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'F12'</font><font color="#000080">;    </font>vkCode<font color="#000080">: </font>vk_F12<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'INSERT'</font><font color="#000080">; </font>vkCode<font color="#000080">: </font>vk_Insert<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'DELETE'</font><font color="#000080">; </font>vkCode<font color="#000080">: </font>vk_Delete<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'HOME'</font><font color="#000080">;   </font>vkCode<font color="#000080">: </font>vk_Home<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'END'</font><font color="#000080">;    </font>vkCode<font color="#000080">: </font>vk_End<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'PGUP'</font><font color="#000080">;   </font>vkCode<font color="#000080">: </font>vk_Prior<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'PGDN'</font><font color="#000080">;   </font>vkCode<font color="#000080">: </font>vk_Next<font color="#000080">),

    (</font>Key<font color="#000080">: </font><font color="#800000">'TAB'</font><font color="#000080">;    </font>vkCode<font color="#000080">: </font>vk_Tab<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'ENTER'</font><font color="#000080">;  </font>vkCode<font color="#000080">: </font>vk_Return<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'BKSP'</font><font color="#000080">;   </font>vkCode<font color="#000080">: </font>vk_Back<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'PRTSC'</font><font color="#000080">;  </font>vkCode<font color="#000080">: </font>vk_SnapShot<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'SHIFT'</font><font color="#000080">;  </font>vkCode<font color="#000080">: </font>vk_Shift<font color="#000080">),
    (</font>Key<font color="#000080">: </font><font color="#800000">'ESCAPE'</font><font color="#000080">; </font>vkCode<font color="#000080">: </font>vk_Escape<font color="#000080">));

</font><font color="#FF0000"><b>function </b></font>FindKeyInArray<font color="#000080">(</font>Key<font color="#000080">: </font>TKeyString<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Code<font color="#000080">: </font>Byte<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>implementation
uses </b></font>SysUtils<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>FindKeyInArray<font color="#000080">(</font>Key<font color="#000080">: </font>TKeyString<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Code<font color="#000080">: </font>Byte<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#008000"><i>{ function searches array for token passed in Key, and returns the }
{ virtual key code in Code. }
</i></font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font>Low<font color="#000080">(</font>KeyDefArray<font color="#000080">) </font><font color="#FF0000"><b>to </b></font>High<font color="#000080">(</font>KeyDefArray<font color="#000080">) </font><font color="#FF0000"><b>do
    if </b></font>UpperCase<font color="#000080">(</font>Key<font color="#000080">) = </font>KeyDefArray<font color="#000080">[</font>i<font color="#000080">].</font>Key <font color="#FF0000"><b>then begin
      </b></font>Code <font color="#000080">:= </font>KeyDefArray<font color="#000080">[</font>i<font color="#000080">].</font>vkCode<font color="#000080">;
      </font>Result <font color="#000080">:= </font>True<font color="#000080">;
      </font>Break<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0168.PAS">Original</a><b>]</b></p></body>
</html>
