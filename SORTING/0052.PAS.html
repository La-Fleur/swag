<html>
<head><title> "Very FAST Shell Sort" by IAN LIN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to SORTING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0052.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$A+,B-,D+,E-,F-,G+,I-,L+,N-,O-,R+,S+,V-,X+,M 4096,0,655360
NSORT version 3. Uses Shell sort instead of Insertion sort. Damn fast, still
handles all that can fit into conventional memory.
}

</i></font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">;

</font><font color="#FF0000"><b>type
 </b></font>pstring<font color="#000080">=^</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
 </font>prec<font color="#000080">=^</font>rec<font color="#000080">;
 </font>rec<font color="#000080">=</font><font color="#FF0000"><b>record
  </b></font>s<font color="#000080">:</font>pstring<font color="#000080">;
  </font>n<font color="#000080">:</font>prec<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
 </b></font>rsize<font color="#000080">=</font>sizeof<font color="#000080">(</font>rec<font color="#000080">);

</font><font color="#FF0000"><b>var
 </b></font>linet<font color="#000080">,</font>linec<font color="#000080">:</font>longint<font color="#000080">; </font><font color="#008000"><i>{line total, current}
 </i></font>list<font color="#000080">,</font>start<font color="#000080">,</font>lstptr<font color="#000080">,</font>next<font color="#000080">:</font>prec<font color="#000080">;
 </font><font color="#008000"><i>{list,
  start of sorting zone,
  list stroller,
  next item to be swapped}
 </i></font>infile<font color="#000080">,</font>outfile<font color="#000080">,</font>tmpline<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#008000"><i>{file names, input line}
 </i></font>textf<font color="#000080">:</font>text<font color="#000080">; </font><font color="#008000"><i>{input/output file variable}
 </i></font>tbuf<font color="#000080">:</font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8192</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">; </font><font color="#008000"><i>{text file buffer}

</i></font><font color="#FF0000"><b>procedure </b></font>progress<font color="#000080">;
</font><font color="#FF0000"><b>var
 </b></font>ctr<font color="#000080">,</font>indicator<font color="#000080">:</font>byte<font color="#000080">; </font><font color="#008000"><i>{show graphically, how many blocks}
</i></font><font color="#FF0000"><b>begin
 </b></font>inc<font color="#000080">(</font>linec<font color="#000080">); </font><font color="#008000"><i>{increase current line}
 </i></font>indicator<font color="#000080">:=</font><font color="#800000">100</font><font color="#000080">*</font>linec <font color="#FF0000"><b>div </b></font>linet<font color="#000080">; </font><font color="#008000"><i>{get %}
 </i></font>write<font color="#000080">(</font>indicator<font color="#000080">:</font><font color="#800000">5</font><font color="#000080">,</font><font color="#800000">'%  '</font><font color="#000080">);
 </font>indicator<font color="#000080">:=</font>indicator <font color="#FF0000"><b>div </b></font><font color="#800000">5</font><font color="#000080">; </font><font color="#008000"><i>{get 1/20th portion}
 </i></font><font color="#FF0000"><b>for </b></font>ctr<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">20 </font><font color="#FF0000"><b>do
  if </b></font>ctr<font color="#000080">&lt;=</font>indicator <font color="#FF0000"><b>then </b></font>write<font color="#000080">(</font><font color="#800000">'o'</font><font color="#000080">) </font><font color="#008000"><i>{o=5% done, .=5% remaining}
  </i></font><font color="#FF0000"><b>else </b></font>write<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">);
 </font>write<font color="#000080">(^</font>m<font color="#000080">); </font><font color="#008000"><i>{only carriage return: not new line too}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TheEnd<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>exitproc<font color="#000080">:=</font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>case </b></font>exitcode <font color="#FF0000"><b>of
  </b></font><font color="#800000">1</font><font color="#000080">:</font>writeln<font color="#000080">(</font><font color="#800000">'Input file not found'</font><font color="#000080">);
  </font><font color="#800000">2</font><font color="#000080">:</font>writeln<font color="#000080">(</font><font color="#800000">'Can''t open input file'</font><font color="#000080">);
  </font><font color="#800000">3</font><font color="#000080">:</font>writeln<font color="#000080">(</font><font color="#800000">'Out of memory'</font><font color="#000080">);
  </font><font color="#800000">4</font><font color="#000080">:</font>writeln<font color="#000080">(</font><font color="#800000">'Can''t create output file'</font><font color="#000080">);
  </font><font color="#800000">5</font><font color="#000080">:</font>writeln<font color="#000080">(</font><font color="#800000">'Can''t finish output file'</font><font color="#000080">);
  </font><font color="#800000">6</font><font color="#000080">:</font>writeln<font color="#000080">(</font><font color="#800000">'Insufficient disk space'</font><font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>writeln<font color="#000080">(</font><font color="#800000">'NSort version 3.'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'NetRunner of Assassin Technologies. Lum''s Place 613 531 1911'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>checkfit<font color="#000080">;
</font><font color="#FF0000"><b>var
 </b></font>f<font color="#000080">:</font><font color="#FF0000"><b>file</b></font><font color="#000080">;
 </font>size<font color="#000080">:</font>longint<font color="#000080">;
 </font>drive<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">];
</font><font color="#FF0000"><b>begin
 if </b></font>infile<font color="#000080">&lt;&gt;</font>outfile <font color="#FF0000"><b>then begin
  </b></font>assign<font color="#000080">(</font>f<font color="#000080">,</font>infile<font color="#000080">);
  </font>reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>size<font color="#000080">:=</font>filesize<font color="#000080">(</font>f<font color="#000080">);
  </font>drive<font color="#000080">:=</font>fexpand<font color="#000080">(</font>outfile<font color="#000080">);
  </font>dec<font color="#000080">(</font>drive<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>byte<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>size<font color="#000080">&gt;</font>diskfree<font color="#000080">(</font>byte<font color="#000080">(</font>drive<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">])) </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">6</font><font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>showhelp<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>writeln<font color="#000080">(</font><font color="#800000">'Heavy duty sorter. Syntax: NSORT infile outfile | /s'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'/s= use input name as output.'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'Batch file exit codes:'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'1 Input file not found'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'2 Can''t open input file'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'3 Out of memory'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'4 Can''t create output file'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'5 Can''t finish output file'</font><font color="#000080">);
 </font>writeln<font color="#000080">(</font><font color="#800000">'6 Insufficient disk space'</font><font color="#000080">);
 </font>halt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>swap<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p1<font color="#000080">,</font>p2<font color="#000080">:</font>pstring<font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>tmpptr<font color="#000080">:</font>pstring<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>tmpptr<font color="#000080">:=</font>p1<font color="#000080">;
 </font>p1<font color="#000080">:=</font>p2<font color="#000080">;
 </font>p2<font color="#000080">:=</font>tmpptr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>upstr<font color="#000080">(</font>s<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>c<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
 if </b></font>length<font color="#000080">(</font>s<font color="#000080">)&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then for </b></font>c<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>s<font color="#000080">) </font><font color="#FF0000"><b>do </b></font>s<font color="#000080">[</font>c<font color="#000080">]:=</font>upcase<font color="#000080">(</font>s<font color="#000080">[</font>c<font color="#000080">]);
 </font>upstr<font color="#000080">:=</font>s<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>fexist<font color="#000080">(</font>fn<font color="#000080">:</font>pathstr<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>f<font color="#000080">:</font><font color="#FF0000"><b>file</b></font><font color="#000080">; </font>it<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>assign<font color="#000080">(</font>f<font color="#000080">,</font>fn<font color="#000080">);
 </font>getfattr<font color="#000080">(</font>f<font color="#000080">,</font>it<font color="#000080">);
 </font>fexist<font color="#000080">:=</font>doserror<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
 </font>doserror<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>malloc<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">; </font>ram<font color="#000080">:</font>word<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
 if </b></font><font color="#000080">(</font>maxavail<font color="#000080">&gt;=</font>ram<font color="#000080">) </font><font color="#FF0000"><b>then begin
  if </b></font>ram<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>pointer<font color="#000080">(</font>p<font color="#000080">):=</font><font color="#FF0000"><b>nil </b></font><font color="#008000"><i>{0 is OK but not an allocation}
  </i></font><font color="#FF0000"><b>else </b></font>getmem<font color="#000080">(</font>pointer<font color="#000080">(</font>p<font color="#000080">),</font>ram<font color="#000080">); </font><font color="#008000"><i>{allocate if RAM &gt; 0}
  </i></font>malloc<font color="#000080">:=</font>true
 <font color="#FF0000"><b>end
 else begin </b></font><font color="#008000"><i>{not enough RAM}
  </i></font>malloc<font color="#000080">:=</font>false<font color="#000080">;
  </font>pointer<font color="#000080">(</font>p<font color="#000080">):=</font><font color="#FF0000"><b>nil
 end
end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
 </b></font>exitproc<font color="#000080">:=@</font>TheEnd<font color="#000080">; </font><font color="#008000"><i>{set exit procedure}
 </i></font>linec<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font><font color="#008000"><i>{init}
 </i></font>linet<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;

 </font><font color="#FF0000"><b>if </b></font>paramcount<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>showhelp<font color="#000080">; </font><font color="#008000"><i>{show online help, no cmd line}

 {set input/output files}

 </i></font>infile<font color="#000080">:=</font>upstr<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
 </font>outfile<font color="#000080">:=</font>upstr<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">));
 </font><font color="#FF0000"><b>if </b></font>outfile<font color="#000080">=</font><font color="#800000">'/S' </font><font color="#FF0000"><b>then </b></font>outfile<font color="#000080">:=</font>infile<font color="#000080">; </font><font color="#008000"><i>{/s as output file = same name}

 </i></font><font color="#FF0000"><b>if not </b></font>fexist<font color="#000080">(</font>infile<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">); </font><font color="#008000"><i>{stop if input doesn't exist}

 </i></font>checkfit<font color="#000080">; </font><font color="#008000"><i>{if output file too large/not enough space, this finds it}

 </i></font>assign<font color="#000080">(</font>textf<font color="#000080">,</font>infile<font color="#000080">); </font><font color="#008000"><i>{set input file}
 </i></font>settextbuf<font color="#000080">(</font>textf<font color="#000080">,</font>tbuf<font color="#000080">); </font><font color="#008000"><i>{set text buffer for speed}

 </i></font>reset<font color="#000080">(</font>textf<font color="#000080">);
 </font><font color="#FF0000"><b>if </b></font>ioresult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">); </font><font color="#008000"><i>{stop if error opening file}

 </i></font>list<font color="#000080">:=</font><font color="#FF0000"><b>nil</b></font><font color="#000080">;

 </font><font color="#008000"><i>{input file processing}

 </i></font><font color="#FF0000"><b>while not </b></font>eof<font color="#000080">(</font>textf<font color="#000080">) </font><font color="#FF0000"><b>do begin
  </b></font>readln<font color="#000080">(</font>textf<font color="#000080">,</font>tmpline<font color="#000080">); </font><font color="#008000"><i>{get input}
  </i></font>inc<font color="#000080">(</font>linet<font color="#000080">); </font><font color="#008000"><i>{total line count, setup in loop}
  </i></font><font color="#FF0000"><b>if </b></font>list<font color="#000080">=</font><font color="#FF0000"><b>nil then begin </b></font><font color="#008000"><i>{if list doesn't exist yet}
   </i></font><font color="#FF0000"><b>if not </b></font>malloc<font color="#000080">(</font>pointer<font color="#000080">(</font>list<font color="#000080">),</font>rsize<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">); </font><font color="#008000"><i>{allocate linked list rec}
   </i></font>next<font color="#000080">:=</font>list<font color="#000080">; </font><font color="#008000"><i>{next used to advance linked list}
  </i></font><font color="#FF0000"><b>end
  else begin </b></font><font color="#008000"><i>{current piece of list is not 1st}
   </i></font><font color="#FF0000"><b>if not </b></font>malloc<font color="#000080">(</font>pointer<font color="#000080">(</font>next<font color="#000080">^.</font>n<font color="#000080">),</font>rsize<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">); </font><font color="#008000"><i>{alloc linked list node}
   </i></font>next<font color="#000080">:=</font>next<font color="#000080">^.</font>n<font color="#000080">; </font><font color="#008000"><i>{advance placeholder}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if not </b></font>malloc<font color="#000080">(</font>pointer<font color="#000080">(</font>next<font color="#000080">^.</font>s<font color="#000080">),</font>length<font color="#000080">(</font>tmpline<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">3</font><font color="#000080">); </font><font color="#008000"><i>{allocate
line}  </i></font>move<font color="#000080">(</font>tmpline<font color="#000080">,</font>next<font color="#000080">^.</font>s<font color="#000080">^,</font>length<font color="#000080">(</font>tmpline<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">);
  </font>next<font color="#000080">^.</font>n<font color="#000080">:=</font><font color="#FF0000"><b>nil</b></font><font color="#000080">; </font><font color="#008000"><i>{set list end = nil}
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>close<font color="#000080">(</font>textf<font color="#000080">); </font><font color="#008000"><i>{close input file}

 {sorting begins here}

 </i></font>start<font color="#000080">:=</font>list<font color="#000080">;
 </font><font color="#FF0000"><b>while </b></font>start<font color="#000080">&lt;&gt;</font><font color="#FF0000"><b>nil do begin
  </b></font>next<font color="#000080">:=</font>start<font color="#000080">;
  </font>lstptr<font color="#000080">:=</font>start<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>lstptr<font color="#000080">&lt;&gt;</font><font color="#FF0000"><b>nil do begin
   if </b></font>lstptr<font color="#000080">^.</font>s<font color="#000080">^ &lt; </font>next<font color="#000080">^.</font>s<font color="#000080">^ </font><font color="#FF0000"><b>then </b></font>next<font color="#000080">:=</font>lstptr<font color="#000080">;
   </font>lstptr<font color="#000080">:=</font>lstptr<font color="#000080">^.</font>n<font color="#000080">; </font><font color="#008000"><i>{advance list pointer}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>swap<font color="#000080">(</font>start<font color="#000080">^.</font>s<font color="#000080">,</font>next<font color="#000080">^.</font>s<font color="#000080">);
  </font>progress<font color="#000080">;
  </font>start<font color="#000080">:=</font>start<font color="#000080">^.</font>n<font color="#000080">; </font><font color="#008000"><i>{advance start zone boundary, gradual reduction}
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>writeln<font color="#000080">;

 </font><font color="#008000"><i>{file output after complete sorting}

 </i></font>lstptr<font color="#000080">:=</font>list<font color="#000080">;
 </font>assign<font color="#000080">(</font>textf<font color="#000080">,</font>outfile<font color="#000080">);
 </font>rewrite<font color="#000080">(</font>textf<font color="#000080">);
 </font><font color="#FF0000"><b>if </b></font>ioresult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">);
 </font><font color="#FF0000"><b>while </b></font>lstptr<font color="#000080">&lt;&gt;</font><font color="#FF0000"><b>nil do begin
  </b></font>writeln<font color="#000080">(</font>textf<font color="#000080">,</font>lstptr<font color="#000080">^.</font>s<font color="#000080">^);
  </font><font color="#FF0000"><b>if </b></font>ioresult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
   </b></font>close<font color="#000080">(</font>textf<font color="#000080">);
   </font>halt<font color="#000080">(</font><font color="#800000">5</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>lstptr<font color="#000080">:=</font>lstptr<font color="#000080">^.</font>n<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>close<font color="#000080">(</font>textf<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to SORTING SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0052.PAS">Original</a><b>]</b></p></body>
</html>
