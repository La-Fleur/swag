<html>
<head><title> "FORMAT FLOPPY" by HENNING JORGENSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0055.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$R-,S-,I-,B-,F-,O+}

{---------------------------------------------------------
 BIOS disk I/O routines for floppy drives. Supports DOS
 real mode, DOS protected mode, and Windows. Requires
 TP6, TPW, or BP7.

 All functions are for floppy disks only; no hard drives.

 See the individual types and functions in the interface of
 this unit for more information. See the FMT.PAS sample
 program for an example of formatting disks.

 For status code definitions, see the implementation of
 function GetStatusStr.

 ---------------------------------------------------------
 Based on a unit provided by Henning Jorgensen of Denmark.
 Modified and cleaned up by TurboPower Software for pmode
 and Windows operation.

 TurboPower Software
 P.O. Box 49009
 Colorado Springs, CO 80949-9009

 CompuServe: 76004,2611

 Version 1.0  10/25/93
 Version 1.1  10/29/93
   fix a dumb bug in the MediaArray check
 ---------------------------------------------------------}

</i></font><font color="#FF0000"><b>unit </b></font>BDisk<font color="#000080">;
  </font><font color="#008000"><i>{-BIOS disk I/O routines for floppy drives}

</i></font><font color="#FF0000"><b>interface

const
  </b></font>MaxRetries <font color="#000080">: </font>Byte <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;          </font><font color="#008000"><i>{Number of automatic retries for
                                   read, write, verify, format}

</i></font><font color="#FF0000"><b>type
  </b></font>DriveNumber <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">;             </font><font color="#008000"><i>{Acceptable floppy drive numbers}
                                  {Generally, 0 = A, 1 = B}

  </i></font>DriveType <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">;               </font><font color="#008000"><i>{Floppy drive or disk types}
                                  {0 = unknown or error
                                   1 = 360K
                                   2 = 1.2M
                                   3 = 720K
                                   4 = 1.44M}

  </i></font>VolumeStr <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">11</font><font color="#000080">];         </font><font color="#008000"><i>{String for volume labels}

  </i></font>FormatAbortFunc <font color="#000080">=               </font><font color="#008000"><i>{Prototype for format abort func}
    </i></font><font color="#FF0000"><b>function </b></font><font color="#000080">(</font>Track <font color="#000080">: </font>Byte<font color="#000080">;       </font><font color="#008000"><i>{Track number being formatted, 0..MaxTrack}
              </i></font>MaxTrack <font color="#000080">: </font>Byte<font color="#000080">;    </font><font color="#008000"><i>{Maximum track number for this format}
              </i></font>Kind <font color="#000080">: </font>Byte         <font color="#008000"><i>{0 = format beginning}
                                  {1 = formatting Track}
                                  {2 = verifying Track}
                                  {3 = writing boot and FAT}
                                  {4 = format ending, Track = format status}
              </i></font><font color="#000080">) : </font>Boolean<font color="#000080">;        </font><font color="#008000"><i>{Return True to abort format}


</i></font><font color="#FF0000"><b>procedure </b></font>ResetDrive<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">);
  </font><font color="#008000"><i>{-Reset drive system (function $00). Call after any other
    disk function fails}


</i></font><font color="#FF0000"><b>function </b></font>GetDiskStatus <font color="#000080">: </font>Byte<font color="#000080">;
  </font><font color="#008000"><i>{-Get status of last int $13 operation (function $01)}


</i></font><font color="#FF0000"><b>function </b></font>GetStatusStr<font color="#000080">(</font>ErrNum <font color="#000080">: </font>Byte<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{-Return message string for any of the status codes used by
    this unit.}


</i></font><font color="#FF0000"><b>function </b></font>GetDriveType<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">) : </font>DriveType<font color="#000080">;
  </font><font color="#008000"><i>{-Get drive type (function $08). Note that this returns the
    type of the *drive*, not the type of the diskette in it.
    GetDriveType returns 0 for an invalid drive.}


</i></font><font color="#FF0000"><b>function </b></font>AllocBuffer<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>P <font color="#000080">: </font>Pointer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{-Allocate a buffer useable in real and protected mode.
    Buffers passed to ReadSectors and WriteSectors in pmode
    *MUST* be allocated by using this function. AllocBuffer returns
    False if sufficient memory is not available. P is also set to
    nil in that case.}


</i></font><font color="#FF0000"><b>procedure </b></font>FreeBuffer<font color="#000080">(</font>P <font color="#000080">: </font>Pointer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#008000"><i>{-Free buffer allocated by AllocBuffer. Size must match the
    size originally passed to AllocBuffer. FreeBuffer does
    nothing if P is nil.}


</i></font><font color="#FF0000"><b>function </b></font>ReadSectors<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">;
                     </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect <font color="#000080">: </font>Byte<font color="#000080">;
                     </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#008000"><i>{-Read absolute disk sectors (function $02). Track, Side,
    and SSect specify the location of the first sector to
    read. NSect is the number of sectors to read. Buffer
    must be large enough to hold these sectors. ReadSectors
    returns a status code, 0 for success.}


</i></font><font color="#FF0000"><b>function </b></font>WriteSectors<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">;
                      </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect <font color="#000080">: </font>Byte<font color="#000080">;
                      </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#008000"><i>{-Write absolute disk sectors (function $03). Track, Side,
    and SSect specify the location of the first sector to
    write. NSect is the number of sectors to write. Buffer
    must contain all the data to write. WriteSectors
    returns a status code, 0 for success.}


</i></font><font color="#FF0000"><b>function </b></font>VerifySectors<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">;
                       </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#008000"><i>{-Verify absolute disk sectors (function $04). This
    tests a computed CRC with the CRC stored along with the
    sector. Track, Side, and SSect specify the location of
    the first sector to verify. NSect is the number of
    sectors to verify. VerifySectors returns a status code,
    0 for success. Don't call VerifySectors on PC/XTs and
    PC/ATs with a BIOS from 1985. It will overwrite the
    stack.}


</i></font><font color="#FF0000"><b>function </b></font>FormatDisk<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">; </font>DType <font color="#000080">: </font>DriveType<font color="#000080">;
                    </font>Verify <font color="#000080">: </font>Boolean<font color="#000080">; </font>MaxBadSects <font color="#000080">: </font>Byte<font color="#000080">;
                    </font>VLabel <font color="#000080">: </font>VolumeStr<font color="#000080">;
                    </font>FAF <font color="#000080">: </font>FormatAbortFunc<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#008000"><i>{-Format drive that contains a disk of type DType. If Verify
    is True, each track is verified after it is formatted.
    MaxBadSects specifies the number of sectors that can be
    bad before the format is halted. If VLabel is not an
    empty string, FormatDisk puts the BIOS-level volume
    label onto the diskette. It does *not* add a DOS-level
    volume label. FAF is a user function hook that can be
    used to display status during the format, and to abort
    the format if the user so chooses. Parameters passed to
    this function are described in FormatAbortFunc above.
    FormatDisk also writes a boot sector and empty File
    Allocation Tables for the disk. FormatDisk returns a
    status code, 0 for success.}


</i></font><font color="#FF0000"><b>function </b></font>EmptyAbortFunc<font color="#000080">(</font>Track <font color="#000080">: </font>Byte<font color="#000080">; </font>MaxTrack <font color="#000080">: </font>Byte<font color="#000080">; </font>Kind <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{-Do-nothing abort function for FormatDisk}

  {========================================================================}

</i></font><font color="#FF0000"><b>implementation

uses
</b></font><font color="#008000"><i>{$IFDEF DPMI}
  </i></font>WinApi<font color="#000080">,
  </font>Dos<font color="#000080">;
  </font><font color="#008000"><i>{$DEFINE pmode}
{$ELSE}
{$IFDEF Windows}
  </i></font>WinApi<font color="#000080">,
  </font>WinDos<font color="#000080">;
  </font><font color="#008000"><i>{$DEFINE pmode}
{$ELSE}
  </i></font>Dos<font color="#000080">;
  </font><font color="#008000"><i>{$UNDEF pmode}
{$ENDIF}
{$ENDIF}

{$IFDEF Windows}
</i></font><font color="#FF0000"><b>type
  </b></font>Registers <font color="#000080">= </font>TRegisters<font color="#000080">;
  </font>DateTime <font color="#000080">= </font>TDateTime<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>type
  </b></font>DiskRec <font color="#000080">=
    </font><font color="#FF0000"><b>record
      </b></font>SSZ <font color="#000080">: </font>Byte<font color="#000080">;                 </font><font color="#008000"><i>{Sector size}
      </i></font>SPT <font color="#000080">: </font>Byte<font color="#000080">;                 </font><font color="#008000"><i>{Sectors/track}
      </i></font>TPD <font color="#000080">: </font>Byte<font color="#000080">;                 </font><font color="#008000"><i>{Tracks/disk}
      </i></font>SPF <font color="#000080">: </font>Byte<font color="#000080">;                 </font><font color="#008000"><i>{Sectors/FAT}
      </i></font>DSC <font color="#000080">: </font>Byte<font color="#000080">;                 </font><font color="#008000"><i>{Directory sectors}
      </i></font>FID <font color="#000080">: </font>Byte<font color="#000080">;                 </font><font color="#008000"><i>{Format id for FAT}
      </i></font>BRD <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">13</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{Variable boot record data}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>DiskRecs <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>DiskRec<font color="#000080">;
  </font>SectorArray <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">511</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>DData <font color="#000080">: </font>DiskRecs <font color="#000080">=              </font><font color="#008000"><i>{BRD starts at offset 13 of FAT}
  </i></font><font color="#000080">((</font>SSZ <font color="#000080">: </font><font color="#800000">$02</font><font color="#000080">; </font>SPT <font color="#000080">: </font><font color="#800000">$09</font><font color="#000080">; </font>TPD <font color="#000080">: </font><font color="#800000">$27</font><font color="#000080">; </font>SPF <font color="#000080">: </font><font color="#800000">$02</font><font color="#000080">; </font>DSC <font color="#000080">: </font><font color="#800000">$07</font><font color="#000080">; </font>FID <font color="#000080">: </font><font color="#800000">$FD</font><font color="#000080">; </font><font color="#008000"><i>{5.25&quot; - 360K}
    </i></font>BRD <font color="#000080">: (</font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$70</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$D0</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$FD</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">)),
   (</font>SSZ <font color="#000080">: </font><font color="#800000">$02</font><font color="#000080">; </font>SPT <font color="#000080">: </font><font color="#800000">$0F</font><font color="#000080">; </font>TPD <font color="#000080">: </font><font color="#800000">$4F</font><font color="#000080">; </font>SPF <font color="#000080">: </font><font color="#800000">$07</font><font color="#000080">; </font>DSC <font color="#000080">: </font><font color="#800000">$0E</font><font color="#000080">; </font>FID <font color="#000080">: </font><font color="#800000">$F9</font><font color="#000080">; </font><font color="#008000"><i>{5.25&quot; - 1.2M}
    </i></font>BRD <font color="#000080">: (</font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$E0</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$60</font><font color="#000080">, </font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">$F9</font><font color="#000080">, </font><font color="#800000">$07</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$0F</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">)),
   (</font>SSZ <font color="#000080">: </font><font color="#800000">$02</font><font color="#000080">; </font>SPT <font color="#000080">: </font><font color="#800000">$09</font><font color="#000080">; </font>TPD <font color="#000080">: </font><font color="#800000">$4F</font><font color="#000080">; </font>SPF <font color="#000080">: </font><font color="#800000">$03</font><font color="#000080">; </font>DSC <font color="#000080">: </font><font color="#800000">$07</font><font color="#000080">; </font>FID <font color="#000080">: </font><font color="#800000">$F9</font><font color="#000080">; </font><font color="#008000"><i>{3.50&quot; - 720K}
    </i></font>BRD <font color="#000080">: (</font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$70</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$A0</font><font color="#000080">, </font><font color="#800000">$05</font><font color="#000080">, </font><font color="#800000">$F9</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">)),
   (</font>SSZ <font color="#000080">: </font><font color="#800000">$02</font><font color="#000080">; </font>SPT <font color="#000080">: </font><font color="#800000">$12</font><font color="#000080">; </font>TPD <font color="#000080">: </font><font color="#800000">$4F</font><font color="#000080">; </font>SPF <font color="#000080">: </font><font color="#800000">$09</font><font color="#000080">; </font>DSC <font color="#000080">: </font><font color="#800000">$0E</font><font color="#000080">; </font>FID <font color="#000080">: </font><font color="#800000">$F0</font><font color="#000080">; </font><font color="#008000"><i>{3.50&quot; - 1.44M}
    </i></font>BRD <font color="#000080">: (</font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$E0</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$40</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$F0</font><font color="#000080">, </font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$12</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">)));

  </font>BootRecord <font color="#000080">: </font>SectorArray <font color="#000080">= </font><font color="#008000"><i>{Standard boot program}
  </i></font><font color="#000080">(</font><font color="#800000">$EB</font><font color="#000080">, </font><font color="#800000">$34</font><font color="#000080">, </font><font color="#800000">$90</font><font color="#000080">, </font><font color="#800000">$41</font><font color="#000080">, </font><font color="#800000">$4D</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$54</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$33</font><font color="#000080">, </font><font color="#800000">$2E</font><font color="#000080">, </font><font color="#800000">$30</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$E0</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$40</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$F0</font><font color="#000080">, </font><font color="#800000">$09</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">,
   </font><font color="#800000">$12</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$12</font><font color="#000080">,
   </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$FA</font><font color="#000080">, </font><font color="#800000">$33</font><font color="#000080">, </font><font color="#800000">$C0</font><font color="#000080">, </font><font color="#800000">$8E</font><font color="#000080">, </font><font color="#800000">$D0</font><font color="#000080">, </font><font color="#800000">$BC</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$07</font><font color="#000080">, </font><font color="#800000">$BB</font><font color="#000080">, </font><font color="#800000">$78</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$36</font><font color="#000080">, </font><font color="#800000">$C5</font><font color="#000080">, </font><font color="#800000">$37</font><font color="#000080">, </font><font color="#800000">$1E</font><font color="#000080">, </font><font color="#800000">$56</font><font color="#000080">,
   </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$BF</font><font color="#000080">, </font><font color="#800000">$2B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$B9</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$FC</font><font color="#000080">, </font><font color="#800000">$AC</font><font color="#000080">, </font><font color="#800000">$26</font><font color="#000080">, </font><font color="#800000">$80</font><font color="#000080">, </font><font color="#800000">$3D</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">, </font><font color="#800000">$26</font><font color="#000080">, </font><font color="#800000">$8A</font><font color="#000080">, </font><font color="#800000">$05</font><font color="#000080">, </font><font color="#800000">$AA</font><font color="#000080">, </font><font color="#800000">$8A</font><font color="#000080">, </font><font color="#800000">$C4</font><font color="#000080">, </font><font color="#800000">$E2</font><font color="#000080">, </font><font color="#800000">$F1</font><font color="#000080">,
   </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$1F</font><font color="#000080">, </font><font color="#800000">$89</font><font color="#000080">, </font><font color="#800000">$47</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$C7</font><font color="#000080">, </font><font color="#800000">$07</font><font color="#000080">, </font><font color="#800000">$2B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$FB</font><font color="#000080">, </font><font color="#800000">$CD</font><font color="#000080">, </font><font color="#800000">$13</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$67</font><font color="#000080">, </font><font color="#800000">$A0</font><font color="#000080">, </font><font color="#800000">$10</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$98</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$26</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">,
   </font><font color="#800000">$1C</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$0E</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$A3</font><font color="#000080">, </font><font color="#800000">$3F</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$A3</font><font color="#000080">, </font><font color="#800000">$37</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$B8</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$26</font><font color="#000080">, </font><font color="#800000">$11</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$8B</font><font color="#000080">, </font><font color="#800000">$1E</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">,
   </font><font color="#800000">$C3</font><font color="#000080">, </font><font color="#800000">$48</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$F3</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$37</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$BB</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$05</font><font color="#000080">, </font><font color="#800000">$A1</font><font color="#000080">, </font><font color="#800000">$3F</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$E8</font><font color="#000080">, </font><font color="#800000">$9F</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$B8</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$E8</font><font color="#000080">, </font><font color="#800000">$B3</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">,
   </font><font color="#800000">$19</font><font color="#000080">, </font><font color="#800000">$8B</font><font color="#000080">, </font><font color="#800000">$FB</font><font color="#000080">, </font><font color="#800000">$B9</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$BE</font><font color="#000080">, </font><font color="#800000">$D6</font><font color="#000080">, </font><font color="#800000">$7D</font><font color="#000080">, </font><font color="#800000">$F3</font><font color="#000080">, </font><font color="#800000">$A6</font><font color="#000080">, </font><font color="#800000">$75</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$8D</font><font color="#000080">, </font><font color="#800000">$7F</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$BE</font><font color="#000080">, </font><font color="#800000">$E1</font><font color="#000080">, </font><font color="#800000">$7D</font><font color="#000080">, </font><font color="#800000">$B9</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$F3</font><font color="#000080">, </font><font color="#800000">$A6</font><font color="#000080">,
   </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$18</font><font color="#000080">, </font><font color="#800000">$BE</font><font color="#000080">, </font><font color="#800000">$77</font><font color="#000080">, </font><font color="#800000">$7D</font><font color="#000080">, </font><font color="#800000">$E8</font><font color="#000080">, </font><font color="#800000">$6A</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$32</font><font color="#000080">, </font><font color="#800000">$E4</font><font color="#000080">, </font><font color="#800000">$CD</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$5E</font><font color="#000080">, </font><font color="#800000">$1F</font><font color="#000080">, </font><font color="#800000">$8F</font><font color="#000080">, </font><font color="#800000">$04</font><font color="#000080">, </font><font color="#800000">$8F</font><font color="#000080">, </font><font color="#800000">$44</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$CD</font><font color="#000080">, </font><font color="#800000">$19</font><font color="#000080">, </font><font color="#800000">$BE</font><font color="#000080">, </font><font color="#800000">$C0</font><font color="#000080">, </font><font color="#800000">$7D</font><font color="#000080">,
   </font><font color="#800000">$EB</font><font color="#000080">, </font><font color="#800000">$EB</font><font color="#000080">, </font><font color="#800000">$A1</font><font color="#000080">, </font><font color="#800000">$1C</font><font color="#000080">, </font><font color="#800000">$05</font><font color="#000080">, </font><font color="#800000">$33</font><font color="#000080">, </font><font color="#800000">$D2</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$36</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$FE</font><font color="#000080">, </font><font color="#800000">$C0</font><font color="#000080">, </font><font color="#800000">$A2</font><font color="#000080">, </font><font color="#800000">$3C</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$A1</font><font color="#000080">, </font><font color="#800000">$37</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$A3</font><font color="#000080">, </font><font color="#800000">$3D</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$BB</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">,
   </font><font color="#800000">$07</font><font color="#000080">, </font><font color="#800000">$A1</font><font color="#000080">, </font><font color="#800000">$37</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$E8</font><font color="#000080">, </font><font color="#800000">$49</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$A1</font><font color="#000080">, </font><font color="#800000">$18</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$2A</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$3B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$40</font><font color="#000080">, </font><font color="#800000">$38</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$3C</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$73</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">, </font><font color="#800000">$A0</font><font color="#000080">, </font><font color="#800000">$3C</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">,
   </font><font color="#800000">$50</font><font color="#000080">, </font><font color="#800000">$E8</font><font color="#000080">, </font><font color="#800000">$4E</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$58</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$C6</font><font color="#000080">, </font><font color="#800000">$28</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$3C</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$0C</font><font color="#000080">, </font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$37</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$26</font><font color="#000080">, </font><font color="#800000">$0B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">, </font><font color="#800000">$D8</font><font color="#000080">, </font><font color="#800000">$EB</font><font color="#000080">,
   </font><font color="#800000">$D0</font><font color="#000080">, </font><font color="#800000">$8A</font><font color="#000080">, </font><font color="#800000">$2E</font><font color="#000080">, </font><font color="#800000">$15</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$8A</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$FD</font><font color="#000080">, </font><font color="#800000">$7D</font><font color="#000080">, </font><font color="#800000">$8B</font><font color="#000080">, </font><font color="#800000">$1E</font><font color="#000080">, </font><font color="#800000">$3D</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$EA</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$70</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$AC</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$C0</font><font color="#000080">, </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$22</font><font color="#000080">, </font><font color="#800000">$B4</font><font color="#000080">,
   </font><font color="#800000">$0E</font><font color="#000080">, </font><font color="#800000">$BB</font><font color="#000080">, </font><font color="#800000">$07</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$CD</font><font color="#000080">, </font><font color="#800000">$10</font><font color="#000080">, </font><font color="#800000">$EB</font><font color="#000080">, </font><font color="#800000">$F2</font><font color="#000080">, </font><font color="#800000">$33</font><font color="#000080">, </font><font color="#800000">$D2</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$36</font><font color="#000080">, </font><font color="#800000">$18</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$FE</font><font color="#000080">, </font><font color="#800000">$C2</font><font color="#000080">, </font><font color="#800000">$88</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$3B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$33</font><font color="#000080">, </font><font color="#800000">$D2</font><font color="#000080">, </font><font color="#800000">$F7</font><font color="#000080">, </font><font color="#800000">$36</font><font color="#000080">,
   </font><font color="#800000">$1A</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$88</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$2A</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$A3</font><font color="#000080">, </font><font color="#800000">$39</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$C3</font><font color="#000080">, </font><font color="#800000">$B4</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">, </font><font color="#800000">$8B</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$39</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$B1</font><font color="#000080">, </font><font color="#800000">$06</font><font color="#000080">, </font><font color="#800000">$D2</font><font color="#000080">, </font><font color="#800000">$E6</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$36</font><font color="#000080">, </font><font color="#800000">$3B</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">,
   </font><font color="#800000">$8B</font><font color="#000080">, </font><font color="#800000">$CA</font><font color="#000080">, </font><font color="#800000">$86</font><font color="#000080">, </font><font color="#800000">$E9</font><font color="#000080">, </font><font color="#800000">$8A</font><font color="#000080">, </font><font color="#800000">$16</font><font color="#000080">, </font><font color="#800000">$FD</font><font color="#000080">, </font><font color="#800000">$7D</font><font color="#000080">, </font><font color="#800000">$8A</font><font color="#000080">, </font><font color="#800000">$36</font><font color="#000080">, </font><font color="#800000">$2A</font><font color="#000080">, </font><font color="#800000">$7C</font><font color="#000080">, </font><font color="#800000">$CD</font><font color="#000080">, </font><font color="#800000">$13</font><font color="#000080">, </font><font color="#800000">$C3</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$4E</font><font color="#000080">, </font><font color="#800000">$6F</font><font color="#000080">, </font><font color="#800000">$6E</font><font color="#000080">, </font><font color="#800000">$2D</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$79</font><font color="#000080">, </font><font color="#800000">$73</font><font color="#000080">,
   </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$6D</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$64</font><font color="#000080">, </font><font color="#800000">$69</font><font color="#000080">, </font><font color="#800000">$73</font><font color="#000080">, </font><font color="#800000">$6B</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$6F</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$64</font><font color="#000080">, </font><font color="#800000">$69</font><font color="#000080">, </font><font color="#800000">$73</font><font color="#000080">, </font><font color="#800000">$6B</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$6F</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">,
   </font><font color="#800000">$52</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$70</font><font color="#000080">, </font><font color="#800000">$6C</font><font color="#000080">, </font><font color="#800000">$61</font><font color="#000080">, </font><font color="#800000">$63</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$61</font><font color="#000080">, </font><font color="#800000">$6E</font><font color="#000080">, </font><font color="#800000">$64</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$73</font><font color="#000080">, </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$69</font><font color="#000080">, </font><font color="#800000">$6B</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$61</font><font color="#000080">, </font><font color="#800000">$6E</font><font color="#000080">, </font><font color="#800000">$79</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$6B</font><font color="#000080">,
   </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$79</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$77</font><font color="#000080">, </font><font color="#800000">$68</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$6E</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$61</font><font color="#000080">, </font><font color="#800000">$64</font><font color="#000080">, </font><font color="#800000">$79</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$44</font><font color="#000080">, </font><font color="#800000">$69</font><font color="#000080">, </font><font color="#800000">$73</font><font color="#000080">, </font><font color="#800000">$6B</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$42</font><font color="#000080">,
   </font><font color="#800000">$6F</font><font color="#000080">, </font><font color="#800000">$6F</font><font color="#000080">, </font><font color="#800000">$74</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$66</font><font color="#000080">, </font><font color="#800000">$61</font><font color="#000080">, </font><font color="#800000">$69</font><font color="#000080">, </font><font color="#800000">$6C</font><font color="#000080">, </font><font color="#800000">$75</font><font color="#000080">, </font><font color="#800000">$72</font><font color="#000080">, </font><font color="#800000">$65</font><font color="#000080">, </font><font color="#800000">$0D</font><font color="#000080">, </font><font color="#800000">$0A</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$49</font><font color="#000080">, </font><font color="#800000">$4F</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$59</font><font color="#000080">,
   </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$4D</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$44</font><font color="#000080">, </font><font color="#800000">$4F</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$20</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$59</font><font color="#000080">, </font><font color="#800000">$53</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">,
   </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$55</font><font color="#000080">, </font><font color="#800000">$AA</font><font color="#000080">);

  </font>MediaArray <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>DriveType<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">=
    ((</font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$00</font><font color="#000080">),     </font><font color="#008000"><i>{Unknown disk}
     </i></font><font color="#000080">(</font><font color="#800000">$01</font><font color="#000080">, </font><font color="#800000">$02</font><font color="#000080">),     </font><font color="#008000"><i>{360K disk}
     </i></font><font color="#000080">(</font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$03</font><font color="#000080">),     </font><font color="#008000"><i>{1.2M disk}
     </i></font><font color="#000080">(</font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$04</font><font color="#000080">),     </font><font color="#008000"><i>{720K disk}
     </i></font><font color="#000080">(</font><font color="#800000">$00</font><font color="#000080">, </font><font color="#800000">$04</font><font color="#000080">));    </font><font color="#008000"><i>{1.44M disk}

{$IFDEF pmode}
</i></font><font color="#FF0000"><b>type
  </b></font>DPMIRegisters <font color="#000080">=
    </font><font color="#FF0000"><b>record
      </b></font>DI <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>SI <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>BP <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>Reserved <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>BX <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>DX <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>CX <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>AX <font color="#000080">: </font>LongInt<font color="#000080">;
      </font>Flags <font color="#000080">: </font>Word<font color="#000080">;
      </font>ES <font color="#000080">: </font>Word<font color="#000080">;
      </font>DS <font color="#000080">: </font>Word<font color="#000080">;
      </font>FS <font color="#000080">: </font>Word<font color="#000080">;
      </font>GS <font color="#000080">: </font>Word<font color="#000080">;
      </font>IP <font color="#000080">: </font>Word<font color="#000080">;
      </font>CS <font color="#000080">: </font>Word<font color="#000080">;
      </font>SP <font color="#000080">: </font>Word<font color="#000080">;
      </font>SS <font color="#000080">: </font>Word<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>GetRealSelector<font color="#000080">(</font>RealPtr <font color="#000080">: </font>Pointer<font color="#000080">; </font>Limit <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
    </font><font color="#008000"><i>{-Set up a selector to point to RealPtr memory}
  </i></font><font color="#FF0000"><b>type
    </b></font>OS <font color="#000080">=
      </font><font color="#FF0000"><b>record
        </b></font>O<font color="#000080">, </font>S <font color="#000080">: </font>Word<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>Status <font color="#000080">: </font>Word<font color="#000080">;
    </font>Selector <font color="#000080">: </font>Word<font color="#000080">;
    </font>Base <font color="#000080">: </font>LongInt<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>GetRealSelector <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Selector <font color="#000080">:= </font>AllocSelector<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Selector <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font><font color="#008000"><i>{Assure a read/write selector}
    </i></font>Status <font color="#000080">:= </font>ChangeSelector<font color="#000080">(</font>CSeg<font color="#000080">, </font>Selector<font color="#000080">);
    </font>Base <font color="#000080">:= (</font>LongInt<font color="#000080">(</font>OS<font color="#000080">(</font>RealPtr<font color="#000080">).</font>S<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">)+</font>LongInt<font color="#000080">(</font>OS<font color="#000080">(</font>RealPtr<font color="#000080">).</font>O<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>SetSelectorBase<font color="#000080">(</font>Selector<font color="#000080">, </font>Base<font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>Selector <font color="#000080">:= </font>FreeSelector<font color="#000080">(</font>Selector<font color="#000080">);
      </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>Status <font color="#000080">:= </font>SetSelectorLimit<font color="#000080">(</font>Selector<font color="#000080">, </font>Limit<font color="#000080">);
    </font>GetRealSelector <font color="#000080">:= </font>Selector<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>GetRealIntVec<font color="#000080">(</font>IntNo <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Vector <font color="#000080">: </font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov     ax,0200h
    mov     bl,IntNo
    int     31h
    les     di,Vector
    mov     word ptr es:[di],dx
    mov     word ptr es:[di+2],cx
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>RealIntr<font color="#000080">(</font>IntNo <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Regs <font color="#000080">: </font>DPMIRegisters<font color="#000080">) : </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">xor     bx,bx
    mov     bl,IntNo
    xor     cx,cx        </font><font color="#008000"><i>{StackWords = 0}
    </i></font><font color="#FF00FF">les     di,Regs
    mov     ax,0300h
    int     31h
    jc      @@ExitPoint
    xor     ax,ax
  @@ExitPoint:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

  </i></font><font color="#FF0000"><b>procedure </b></font>Int13Call<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">);
    </font><font color="#008000"><i>{-Call int $13 for real or protected mode}
{$IFDEF pmode}
  </i></font><font color="#FF0000"><b>var
    </b></font>Base <font color="#000080">: </font>LongInt<font color="#000080">;
    </font>DRegs <font color="#000080">: </font>DPMIRegisters<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF pmode}
    {This pmode code is valid only for the AH values used in this unit}
    </i></font>FillChar<font color="#000080">(</font>DRegs<font color="#000080">, </font>SizeOf<font color="#000080">(</font>DPMIRegisters<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font>DRegs<font color="#000080">.</font>AX <font color="#000080">:= </font>Regs<font color="#000080">.</font>AX<font color="#000080">;
    </font>DRegs<font color="#000080">.</font>BX <font color="#000080">:= </font>Regs<font color="#000080">.</font>BX<font color="#000080">;
    </font>DRegs<font color="#000080">.</font>CX <font color="#000080">:= </font>Regs<font color="#000080">.</font>CX<font color="#000080">;
    </font>DRegs<font color="#000080">.</font>DX <font color="#000080">:= </font>Regs<font color="#000080">.</font>DX<font color="#000080">;
    </font><font color="#FF0000"><b>case </b></font>Regs<font color="#000080">.</font>AH <font color="#FF0000"><b>of
      </b></font><font color="#800000">2</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">5 </font><font color="#000080">:
        </font><font color="#008000"><i>{Calls that use ES as a buffer segment}
        </i></font><font color="#FF0000"><b>begin
          </b></font>Base <font color="#000080">:= </font>GetSelectorBase<font color="#000080">(</font>Regs<font color="#000080">.</font>ES<font color="#000080">);
          </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Base <font color="#000080">&lt;= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Base <font color="#000080">&gt; </font><font color="#800000">$FFFF0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
            </b></font>Regs<font color="#000080">.</font>Flags <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
            </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
            </font>Exit<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>DRegs<font color="#000080">.</font>ES <font color="#000080">:= </font>Base <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>RealIntr<font color="#000080">(</font><font color="#800000">$13</font><font color="#000080">, </font>DRegs<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>Regs<font color="#000080">.</font>Flags <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>end else begin
      </b></font>Regs<font color="#000080">.</font>Flags <font color="#000080">:= </font>DRegs<font color="#000080">.</font>Flags<font color="#000080">;
      </font>Regs<font color="#000080">.</font>AX <font color="#000080">:= </font>DRegs<font color="#000080">.</font>AX<font color="#000080">;
      </font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font>DRegs<font color="#000080">.</font>BX<font color="#000080">; </font><font color="#008000"><i>{BX is returned by GetDriveType function only}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$ELSE}
    </i></font>Intr<font color="#000080">(</font><font color="#800000">$13</font><font color="#000080">, </font>Regs<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>GetDriveType<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">) : </font>DriveType<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$08</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>DL <font color="#000080">:= </font>Drive<font color="#000080">;
    </font>Int13Call<font color="#000080">(</font>Regs<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>GetDriveType <font color="#000080">:= </font>Regs<font color="#000080">.</font>BL
    <font color="#FF0000"><b>else
      </b></font>GetDriveType <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>GetDiskStatus <font color="#000080">: </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$01</font><font color="#000080">;
    </font>Int13Call<font color="#000080">(</font>Regs<font color="#000080">);
    </font>GetDiskStatus <font color="#000080">:= </font>Regs<font color="#000080">.</font>AL<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>GetStatusStr<font color="#000080">(</font>ErrNum <font color="#000080">: </font>Byte<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>NumStr <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">3</font><font color="#000080">];
  </font><font color="#FF0000"><b>begin
    case </b></font>ErrNum <font color="#FF0000"><b>of
      </b></font><font color="#008000"><i>{Following codes are defined by the floppy BIOS}
      </i></font><font color="#800000">$00 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font><font color="#800000">$01 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Invalid command'</font><font color="#000080">;
      </font><font color="#800000">$02 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Address mark not found'</font><font color="#000080">;
      </font><font color="#800000">$03 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Disk write protected'</font><font color="#000080">;
      </font><font color="#800000">$04 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Sector not found'</font><font color="#000080">;
      </font><font color="#800000">$06 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Floppy disk removed'</font><font color="#000080">;
      </font><font color="#800000">$08 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'DMA overrun'</font><font color="#000080">;
      </font><font color="#800000">$09 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'DMA crossed 64KB boundary'</font><font color="#000080">;
      </font><font color="#800000">$0C </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Media type not found'</font><font color="#000080">;
      </font><font color="#800000">$10 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Uncorrectable CRC error'</font><font color="#000080">;
      </font><font color="#800000">$20 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Controller failed'</font><font color="#000080">;
      </font><font color="#800000">$40 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Seek failed'</font><font color="#000080">;
      </font><font color="#800000">$80 </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Disk timed out'</font><font color="#000080">;

      </font><font color="#008000"><i>{Following codes are added by this unit}
      </i></font><font color="#800000">$FA </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Format aborted'</font><font color="#000080">;
      </font><font color="#800000">$FB </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Invalid media type'</font><font color="#000080">;
      </font><font color="#800000">$FC </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Too many bad sectors'</font><font color="#000080">;
      </font><font color="#800000">$FD </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Disk bad'</font><font color="#000080">;
      </font><font color="#800000">$FE </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Invalid drive or type'</font><font color="#000080">;
      </font><font color="#800000">$FF </font><font color="#000080">: </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Insufficient memory'</font><font color="#000080">;
    </font><font color="#FF0000"><b>else
      </b></font>Str<font color="#000080">(</font>ErrNum<font color="#000080">, </font>NumStr<font color="#000080">);
      </font>GetStatusStr <font color="#000080">:= </font><font color="#800000">'Unknown error '</font><font color="#000080">+</font>NumStr<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>ResetDrive<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">);
  </font><font color="#FF0000"><b>var
    </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$00</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>DL <font color="#000080">:= </font>Drive<font color="#000080">;
    </font>Int13Call<font color="#000080">(</font>Regs<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>AllocBuffer<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>P <font color="#000080">: </font>Pointer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>L <font color="#000080">: </font>LongInt<font color="#000080">;
  </font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF pmode}
    </i></font>L <font color="#000080">:= </font>GlobalDosAlloc<font color="#000080">(</font>Size<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>L <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>P <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Word<font color="#000080">(</font>L <font color="#FF0000"><b>and </b></font><font color="#800000">$FFFF</font><font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
      </font>AllocBuffer <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end else begin
      </b></font>P <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
      </font>AllocBuffer <font color="#000080">:= </font>False
    <font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
    </i></font><font color="#FF0000"><b>if </b></font>MaxAvail <font color="#000080">&gt;= </font>Size <font color="#FF0000"><b>then begin
      </b></font>GetMem<font color="#000080">(</font>P<font color="#000080">, </font>Size<font color="#000080">);
      </font>AllocBuffer <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end else begin
      </b></font>P <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
      </font>AllocBuffer <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>FreeBuffer<font color="#000080">(</font>P <font color="#000080">: </font>Pointer<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#FF0000"><b>begin
    if </b></font>P <font color="#000080">= </font><font color="#FF0000"><b>nil then
      </b></font>Exit<font color="#000080">;
</font><font color="#008000"><i>{$IFDEF pmode}
    </i></font>Size <font color="#000080">:= </font>GlobalDosFree<font color="#000080">(</font>LongInt<font color="#000080">(</font>P<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">);
</font><font color="#008000"><i>{$ELSE}
    </i></font>FreeMem<font color="#000080">(</font>P<font color="#000080">, </font>Size<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>CheckParms<font color="#000080">(</font>DType <font color="#000080">: </font>DriveType<font color="#000080">; </font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">) : </font>Boolean<font color="#000080">;
    </font><font color="#008000"><i>{-Make sure drive and type are within range}
  </i></font><font color="#FF0000"><b>begin
    </b></font>CheckParms <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>DType <font color="#000080">&lt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>DType <font color="#000080">&gt; </font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Drive <font color="#000080">&gt; </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font>CheckParms <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>SubfSectors<font color="#000080">(</font>SubFunc <font color="#000080">: </font>Byte<font color="#000080">;
                       </font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">;
                       </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect <font color="#000080">: </font>Byte<font color="#000080">;
                       </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">) : </font>Byte<font color="#000080">;
    </font><font color="#008000"><i>{-Code shared by ReadSectors, WriteSectors, VerifySectors, FormatTrack}
  </i></font><font color="#FF0000"><b>var
    </b></font>Tries <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Done <font color="#000080">: </font>Boolean<font color="#000080">;
    </font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Tries <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font>Done <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>repeat
      </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font>SubFunc<font color="#000080">;
      </font>Regs<font color="#000080">.</font>AL <font color="#000080">:= </font>NSect<font color="#000080">;
      </font>Regs<font color="#000080">.</font>CH <font color="#000080">:= </font>Track<font color="#000080">;
      </font>Regs<font color="#000080">.</font>CL <font color="#000080">:= </font>SSect<font color="#000080">;
      </font>Regs<font color="#000080">.</font>DH <font color="#000080">:= </font>Side<font color="#000080">;
      </font>Regs<font color="#000080">.</font>DL <font color="#000080">:= </font>Drive<font color="#000080">;
      </font>Regs<font color="#000080">.</font>ES <font color="#000080">:= </font>Seg<font color="#000080">(</font>Buffer<font color="#000080">);
      </font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font>Ofs<font color="#000080">(</font>Buffer<font color="#000080">);
      </font>Int13Call<font color="#000080">(</font>Regs<font color="#000080">);

      </font><font color="#FF0000"><b>if </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
        </b></font>ResetDrive<font color="#000080">(</font>Drive<font color="#000080">);
        </font>Inc<font color="#000080">(</font>Tries<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>Tries <font color="#000080">&gt; </font>MaxRetries <font color="#FF0000"><b>then
          </b></font>Done <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end else
        </b></font>Done <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>until </b></font>Done<font color="#000080">;

    </font>SubfSectors <font color="#000080">:= </font>Regs<font color="#000080">.</font>AH<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>ReadSectors<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">;
                       </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect <font color="#000080">: </font>Byte<font color="#000080">;
                       </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>ReadSectors <font color="#000080">:= </font>SubfSectors<font color="#000080">(</font><font color="#800000">$02</font><font color="#000080">, </font>Drive<font color="#000080">, </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect<font color="#000080">, </font>Buffer<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>WriteSectors<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">;
                        </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect <font color="#000080">: </font>Byte<font color="#000080">;
                        </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>WriteSectors <font color="#000080">:= </font>SubfSectors<font color="#000080">(</font><font color="#800000">$03</font><font color="#000080">, </font>Drive<font color="#000080">, </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect<font color="#000080">, </font>Buffer<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>VerifySectors<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">;
                         </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>Dummy <font color="#000080">: </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>VerifySectors <font color="#000080">:= </font>SubfSectors<font color="#000080">(</font><font color="#800000">$04</font><font color="#000080">, </font>Drive<font color="#000080">, </font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>SSect<font color="#000080">, </font>NSect<font color="#000080">, </font>Dummy<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>SetDriveTable<font color="#000080">(</font>DType <font color="#000080">: </font>DriveType<font color="#000080">) : </font>Boolean<font color="#000080">;
    </font><font color="#008000"><i>{-Set drive table parameters for formatting}
  </i></font><font color="#FF0000"><b>var
    </b></font>P <font color="#000080">: </font>Pointer<font color="#000080">;
    </font>DBSeg <font color="#000080">: </font>Word<font color="#000080">;
    </font>DBOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>SetDriveTable <font color="#000080">:= </font>False<font color="#000080">;

</font><font color="#008000"><i>{$IFDEF pmode}
    </i></font>GetRealIntVec<font color="#000080">(</font><font color="#800000">$1E</font><font color="#000080">, </font>P<font color="#000080">);
    </font>DBSeg <font color="#000080">:= </font>GetRealSelector<font color="#000080">(</font>P<font color="#000080">, </font><font color="#800000">$FFFF</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>DBSeg <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font>DBOfs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
    </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$1E</font><font color="#000080">, </font>P<font color="#000080">);
    </font>DBSeg <font color="#000080">:= </font>LongInt<font color="#000080">(</font>P<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">16</font><font color="#000080">;
    </font>DBOfs <font color="#000080">:= </font>LongInt<font color="#000080">(</font>P<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$FFFF</font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

    {Set gap length for formatting}
    </i></font><font color="#FF0000"><b>case </b></font>DType <font color="#FF0000"><b>of
      </b></font><font color="#800000">1 </font><font color="#000080">: </font>Mem<font color="#000080">[</font>DBSeg<font color="#000080">:</font>DBOfs<font color="#000080">+</font><font color="#800000">7</font><font color="#000080">] := </font><font color="#800000">$50</font><font color="#000080">; </font><font color="#008000"><i>{360K}
      </i></font><font color="#800000">2 </font><font color="#000080">: </font>Mem<font color="#000080">[</font>DBSeg<font color="#000080">:</font>DBOfs<font color="#000080">+</font><font color="#800000">7</font><font color="#000080">] := </font><font color="#800000">$54</font><font color="#000080">; </font><font color="#008000"><i>{1.2M}
      </i></font><font color="#800000">3</font><font color="#000080">,
      </font><font color="#800000">4 </font><font color="#000080">: </font>Mem<font color="#000080">[</font>DBSeg<font color="#000080">:</font>DBOfs<font color="#000080">+</font><font color="#800000">7</font><font color="#000080">] := </font><font color="#800000">$6C</font><font color="#000080">; </font><font color="#008000"><i>{720K or 1.44M}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Set max sectors/track}
    </i></font>Mem<font color="#000080">[</font>DBSeg<font color="#000080">:</font>DBOfs<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">] := </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT<font color="#000080">;

</font><font color="#008000"><i>{$IFDEF pmode}
    </i></font>DBSeg <font color="#000080">:= </font>FreeSelector<font color="#000080">(</font>DBSeg<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}

    </i></font>SetDriveTable <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>GetMachineID <font color="#000080">: </font>Byte<font color="#000080">;
    </font><font color="#008000"><i>{-Return machine ID code}
{$IFDEF pmode}
  </i></font><font color="#FF0000"><b>var
    </b></font>SegFFFF <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF pmode}
    </i></font>SegFFFF <font color="#000080">:= </font>GetRealSelector<font color="#000080">(</font>Ptr<font color="#000080">(</font><font color="#800000">$FFFF</font><font color="#000080">, </font><font color="#800000">$0000</font><font color="#000080">), </font><font color="#800000">$FFFF</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>SegFFFF <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>GetMachineID <font color="#000080">:= </font><font color="#800000">0
    </font><font color="#FF0000"><b>else begin
      </b></font>GetMachineID <font color="#000080">:= </font>Mem<font color="#000080">[</font>SegFFFF<font color="#000080">:</font><font color="#800000">$000E</font><font color="#000080">];
      </font>SegFFFF <font color="#000080">:= </font>FreeSelector<font color="#000080">(</font>SegFFFF<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ELSE}
    </i></font>GetMachineID <font color="#000080">:= </font>Mem<font color="#000080">[</font><font color="#800000">$FFFF</font><font color="#000080">:</font><font color="#800000">$000E</font><font color="#000080">];
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>IsATMachine <font color="#000080">: </font>Boolean<font color="#000080">;
    </font><font color="#008000"><i>{-Return True if AT or better machine}
  </i></font><font color="#FF0000"><b>begin
    </b></font>IsATMachine <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Lo<font color="#000080">(</font>DosVersion<font color="#000080">) &gt;= </font><font color="#800000">3 </font><font color="#FF0000"><b>then
      case </b></font>GetMachineId <font color="#FF0000"><b>of
        </b></font><font color="#800000">$FC</font><font color="#000080">, </font><font color="#800000">$F8 </font><font color="#000080">:  </font><font color="#008000"><i>{AT or PS/2}
          </i></font>IsATMachine <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>GetChangeLineType<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>CLT <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;
    </font><font color="#008000"><i>{-Return change line type of drive}
  </i></font><font color="#FF0000"><b>var
    </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$15</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>DL <font color="#000080">:= </font>Drive<font color="#000080">;
    </font>Int13Call<font color="#000080">(</font>Regs<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Regs<font color="#000080">.</font>Flags <font color="#FF0000"><b>and </b></font>FCarry<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>GetChangeLineType <font color="#000080">:= </font>Regs<font color="#000080">.</font>AH<font color="#000080">;
      </font>CLT <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>end else begin
      </b></font>GetChangeLineType <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>CLT <font color="#000080">:= </font>Regs<font color="#000080">.</font>AH<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>SetFloppyType<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">; </font>FType <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;
    </font><font color="#008000"><i>{-Set floppy type for formatting}
  </i></font><font color="#FF0000"><b>var
    </b></font>Tries <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Done <font color="#000080">: </font>Boolean<font color="#000080">;
    </font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Tries <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font>Done <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>repeat
      </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$17</font><font color="#000080">;
      </font>Regs<font color="#000080">.</font>AL <font color="#000080">:= </font>FType<font color="#000080">;
      </font>Regs<font color="#000080">.</font>DL <font color="#000080">:= </font>Drive<font color="#000080">;
      </font>Int13Call<font color="#000080">(</font>Regs<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
        </b></font>ResetDrive<font color="#000080">(</font>Drive<font color="#000080">);
        </font>Inc<font color="#000080">(</font>Tries<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>Tries <font color="#000080">&gt; </font>MaxRetries <font color="#FF0000"><b>then
          </b></font>Done <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end else
        </b></font>Done <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>until </b></font>Done<font color="#000080">;

    </font>SetFloppyType <font color="#000080">:= </font>Regs<font color="#000080">.</font>AH<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>SetMediaType<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveType<font color="#000080">; </font>TPD <font color="#000080">: </font>Byte<font color="#000080">; </font>SPT <font color="#000080">: </font>Byte<font color="#000080">) : </font>Byte<font color="#000080">;
    </font><font color="#008000"><i>{-Set media type for formatting}
  </i></font><font color="#FF0000"><b>var
    </b></font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$18</font><font color="#000080">;
    </font>Regs<font color="#000080">.</font>DL <font color="#000080">:= </font>Drive<font color="#000080">;
    </font>Regs<font color="#000080">.</font>CH <font color="#000080">:= </font>TPD<font color="#000080">;
    </font>Regs<font color="#000080">.</font>CL <font color="#000080">:= </font>SPT<font color="#000080">;
    </font>Int13Call<font color="#000080">(</font>Regs<font color="#000080">);
    </font>SetMediaType <font color="#000080">:= </font>Regs<font color="#000080">.</font>AH<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>FormatDisk<font color="#000080">(</font>Drive <font color="#000080">: </font>DriveNumber<font color="#000080">; </font>DType <font color="#000080">: </font>DriveType<font color="#000080">;
                      </font>Verify <font color="#000080">: </font>Boolean<font color="#000080">; </font>MaxBadSects <font color="#000080">: </font>Byte<font color="#000080">;
                      </font>VLabel <font color="#000080">: </font>VolumeStr<font color="#000080">;
                      </font>FAF <font color="#000080">: </font>FormatAbortFunc<font color="#000080">) : </font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>label
    </b></font>ExitPoint<font color="#000080">;
  </font><font color="#FF0000"><b>type
    </b></font>CHRNRec <font color="#000080">=
      </font><font color="#FF0000"><b>record
        </b></font>CTrack <font color="#000080">: </font>Byte<font color="#000080">;            </font><font color="#008000"><i>{Track  0..?}
        </i></font>CSide <font color="#000080">: </font>Byte<font color="#000080">;             </font><font color="#008000"><i>{Side   0..1}
        </i></font>CSect <font color="#000080">: </font>Byte<font color="#000080">;             </font><font color="#008000"><i>{Sector 1..?}
        </i></font>CSize <font color="#000080">: </font>Byte<font color="#000080">;             </font><font color="#008000"><i>{Size   0..?}
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>CHRNArray <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">18</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>CHRNRec<font color="#000080">;
    </font>FATArray <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4607</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>Tries <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Track <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Side <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Sector <font color="#000080">: </font>Byte<font color="#000080">;
    </font>RWritten <font color="#000080">: </font>Byte<font color="#000080">;
    </font>RTotal <font color="#000080">: </font>Byte<font color="#000080">;
    </font>FatNum <font color="#000080">: </font>Byte<font color="#000080">;
    </font>BadSects <font color="#000080">: </font>Byte<font color="#000080">;
    </font>ChangeLine <font color="#000080">: </font>Byte<font color="#000080">;
    </font>DiskType <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Status <font color="#000080">: </font>Byte<font color="#000080">;
    </font>Done <font color="#000080">: </font>Boolean<font color="#000080">;
    </font>Trash <font color="#000080">: </font>Word<font color="#000080">;
    </font>DT <font color="#000080">: </font>DateTime<font color="#000080">;
    </font>VDate <font color="#000080">: </font>LongInt<font color="#000080">;
    </font>Regs <font color="#000080">: </font>Registers<font color="#000080">;
    </font>BootPtr <font color="#000080">: ^</font>SectorArray<font color="#000080">;
    </font>CHRN <font color="#000080">: ^</font>CHRNArray<font color="#000080">;
    </font>FATs <font color="#000080">: ^</font>FATArray<font color="#000080">;

    </font><font color="#FF0000"><b>procedure </b></font>MarkBadSector<font color="#000080">(</font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>Sector <font color="#000080">: </font>Byte<font color="#000080">);
    </font><font color="#FF0000"><b>const
      </b></font>BadMark <font color="#000080">= </font><font color="#800000">$FF7</font><font color="#000080">;             </font><font color="#008000"><i>{Bad cluster mark}
    </i></font><font color="#FF0000"><b>var
      </b></font>CNum <font color="#000080">: </font>Integer<font color="#000080">;             </font><font color="#008000"><i>{Cluster number}
      </i></font>FOfs <font color="#000080">: </font>Word<font color="#000080">;                </font><font color="#008000"><i>{Offset into fat for this cluster}
      </i></font>FVal <font color="#000080">: </font>Word<font color="#000080">;                </font><font color="#008000"><i>{FAT value for this cluster}
      </i></font>OFVal <font color="#000080">: </font>Word<font color="#000080">;               </font><font color="#008000"><i>{Old FAT value for this cluster}
    </i></font><font color="#FF0000"><b>begin
      </b></font>CNum <font color="#000080">:= (((((</font>Track<font color="#000080">*</font><font color="#800000">2</font><font color="#000080">)+</font>Side<font color="#000080">)*</font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT<font color="#000080">)+</font>Sector<font color="#000080">-</font>RTotal<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>div
              </b></font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>BRD<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])+</font><font color="#800000">2</font><font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>CNum <font color="#000080">&gt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then begin
        </b></font><font color="#008000"><i>{Sector is in data space}
        </i></font>FOfs <font color="#000080">:= (</font>CNum<font color="#000080">*</font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
        </font>Move<font color="#000080">(</font>FATs<font color="#000080">^[</font>FOfs<font color="#000080">], </font>FVal<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>Odd<font color="#000080">(</font>CNum<font color="#000080">) </font><font color="#FF0000"><b>then
          </b></font>OFVal <font color="#000080">:= (</font>FVal <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>BadMark <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">))
        </font><font color="#FF0000"><b>else
          </b></font>OFVal <font color="#000080">:= (</font>FVal <font color="#FF0000"><b>and </b></font>BadMark<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>OFVal <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
          </b></font><font color="#008000"><i>{Not already marked bad, mark it}
          </i></font><font color="#FF0000"><b>if </b></font>Odd<font color="#000080">(</font>CNum<font color="#000080">) </font><font color="#FF0000"><b>then
            </b></font>FVal <font color="#000080">:= (</font>FVal <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>BadMark <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">))
          </font><font color="#FF0000"><b>else
            </b></font>FVal <font color="#000080">:= (</font>FVal <font color="#FF0000"><b>or </b></font>BadMark<font color="#000080">);
          </font>Move<font color="#000080">(</font>FVal<font color="#000080">, </font>FATs<font color="#000080">^[</font>FOfs<font color="#000080">], </font><font color="#800000">2</font><font color="#000080">);
          </font><font color="#008000"><i>{Add to bad sector count}
          </i></font>Inc<font color="#000080">(</font>BadSects<font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>BRD<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{Validate parameters. Can't do anything unless these are reasonable}
    </i></font><font color="#FF0000"><b>if not </b></font>CheckParms<font color="#000080">(</font>DType<font color="#000080">, </font>Drive<font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;

    </font><font color="#008000"><i>{Initialize buffer pointers in case of failure}
    </i></font>FATs <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
    </font>CHRN <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
    </font>BootPtr <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Status proc: starting format}
    </i></font><font color="#FF0000"><b>if </b></font>FAF<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>TPD<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font>Status <font color="#000080">:= </font><font color="#800000">$FA</font><font color="#000080">;
      </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Error code for invalid drive or media type}
    </i></font>Status <font color="#000080">:= </font><font color="#800000">$FE</font><font color="#000080">;

    </font><font color="#FF0000"><b>case </b></font>GetDriveType<font color="#000080">(</font>Drive<font color="#000080">) </font><font color="#FF0000"><b>of
      </b></font><font color="#800000">1 </font><font color="#000080">: </font><font color="#008000"><i>{360K drive formats only 360K disks}
        </i></font><font color="#FF0000"><b>if </b></font>DType <font color="#000080">&lt;&gt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then
          goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#800000">2 </font><font color="#000080">: </font><font color="#008000"><i>{1.2M drive formats 360K or 1.2M disk}
        </i></font><font color="#FF0000"><b>if </b></font>DType <font color="#000080">&gt; </font><font color="#800000">2 </font><font color="#FF0000"><b>then
          goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#800000">3 </font><font color="#000080">: </font><font color="#008000"><i>{720K drive formats only 720K disks}
        </i></font><font color="#FF0000"><b>if </b></font>DType <font color="#000080">&lt;&gt; </font><font color="#800000">3 </font><font color="#FF0000"><b>then
          goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#800000">4 </font><font color="#000080">: </font><font color="#008000"><i>{1.44M drive formats 720K or 1.44M disks}
        </i></font><font color="#FF0000"><b>if </b></font>Dtype <font color="#000080">&lt; </font><font color="#800000">3 </font><font color="#FF0000"><b>then
          goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>else
      goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Error code for out-of-memory or DPMI error}
    </i></font>Status <font color="#000080">:= </font><font color="#800000">$FF</font><font color="#000080">;

    </font><font color="#008000"><i>{Allocate buffers}
    </i></font><font color="#FF0000"><b>if not </b></font>AllocBuffer<font color="#000080">(</font>Pointer<font color="#000080">(</font>FATs<font color="#000080">), </font>SizeOf<font color="#000080">(</font>FATArray<font color="#000080">)) </font><font color="#FF0000"><b>then
      goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>if not </b></font>AllocBuffer<font color="#000080">(</font>Pointer<font color="#000080">(</font>CHRN<font color="#000080">), </font>SizeOf<font color="#000080">(</font>CHRNArray<font color="#000080">)) </font><font color="#FF0000"><b>then
      goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>if not </b></font>AllocBuffer<font color="#000080">(</font>Pointer<font color="#000080">(</font>BootPtr<font color="#000080">), </font>SizeOf<font color="#000080">(</font>BootRecord<font color="#000080">)) </font><font color="#FF0000"><b>then
      goto </b></font>ExitPoint<font color="#000080">;

    </font><font color="#008000"><i>{Initialize boot record}
    </i></font>Move<font color="#000080">(</font>BootRecord<font color="#000080">, </font>BootPtr<font color="#000080">^, </font>SizeOf<font color="#000080">(</font>BootRecord<font color="#000080">));
    </font>Move<font color="#000080">(</font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>BRD<font color="#000080">, </font>BootPtr<font color="#000080">^[</font><font color="#800000">13</font><font color="#000080">], </font><font color="#800000">14</font><font color="#000080">);

    </font><font color="#008000"><i>{Initialize the FAT table}
    </i></font>FillChar<font color="#000080">(</font>FATs<font color="#000080">^, </font>SizeOf<font color="#000080">(</font>FATArray<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font>FATs<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">] := </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>FID<font color="#000080">;
    </font>FATs<font color="#000080">^[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">$FF</font><font color="#000080">;
    </font>FATs<font color="#000080">^[</font><font color="#800000">2</font><font color="#000080">] := </font><font color="#800000">$FF</font><font color="#000080">;

    </font><font color="#008000"><i>{Set drive table parameters by patching drive table in memory}
    </i></font><font color="#FF0000"><b>if not </b></font>SetDriveTable<font color="#000080">(</font>DType<font color="#000080">) </font><font color="#FF0000"><b>then
      goto </b></font>ExitPoint<font color="#000080">;

    </font><font color="#008000"><i>{On AT class machines, set format parameters via BIOS}
    </i></font><font color="#FF0000"><b>if </b></font>IsATMachine <font color="#FF0000"><b>then begin
      </b></font><font color="#008000"><i>{Get change line type: 1 -&gt; 360K drive, 2 -&gt; 1.2M or 3.5&quot; drive}
      </i></font>Status <font color="#000080">:= </font>GetChangeLineType<font color="#000080">(</font>Drive<font color="#000080">, </font>ChangeLine<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Status <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>ChangeLine <font color="#000080">&lt; </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>ChangeLine <font color="#000080">&gt; </font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font>Status <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
        </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#008000"><i>{Determine floppy type for SetFloppyType call}
      </i></font>DiskType <font color="#000080">:= </font>MediaArray<font color="#000080">[</font>DType<font color="#000080">, </font>ChangeLine<font color="#000080">];
      </font><font color="#FF0000"><b>if </b></font>DiskType <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
        </b></font>Status <font color="#000080">:= </font><font color="#800000">$FB</font><font color="#000080">;
        </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#008000"><i>{Set floppy type for drive}
      </i></font>Status <font color="#000080">:= </font>SetFloppyType<font color="#000080">(</font>Drive<font color="#000080">, </font>DiskType<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Status <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        goto </b></font>ExitPoint<font color="#000080">;

      </font><font color="#008000"><i>{Set media type for format}
      </i></font>Status <font color="#000080">:= </font>SetMediaType<font color="#000080">(</font>Drive<font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>TPD<font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Status <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Format each sector}
    </i></font>ResetDrive<font color="#000080">(</font>Drive<font color="#000080">);
    </font>BadSects <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

    </font><font color="#FF0000"><b>for </b></font>Track <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>TPD <font color="#FF0000"><b>do begin
      </b></font><font color="#008000"><i>{Status proc: formatting track}
      </i></font><font color="#FF0000"><b>if </b></font>FAF<font color="#000080">(</font>Track<font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>TPD<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font>Status <font color="#000080">:= </font><font color="#800000">$FA</font><font color="#000080">;
        </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>for </b></font>Side <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
        </b></font><font color="#008000"><i>{Initialize CHRN for this sector}
        </i></font><font color="#FF0000"><b>for </b></font>Sector <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT <font color="#FF0000"><b>do
          with </b></font>CHRN<font color="#000080">^[</font>Sector<font color="#000080">] </font><font color="#FF0000"><b>do begin
            </b></font>CTrack <font color="#000080">:= </font>Track<font color="#000080">;
            </font>CSide <font color="#000080">:= </font>Side<font color="#000080">;
            </font>CSect <font color="#000080">:= </font>Sector<font color="#000080">;
            </font>CSize <font color="#000080">:= </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SSZ<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font><font color="#008000"><i>{Format this sector, with retries}
        </i></font>Status <font color="#000080">:= </font>SubfSectors<font color="#000080">(</font><font color="#800000">$05</font><font color="#000080">, </font>Drive<font color="#000080">, </font>Track<font color="#000080">, </font>Side<font color="#000080">,
                              </font><font color="#800000">1</font><font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT<font color="#000080">, </font>CHRN<font color="#000080">^);
        </font><font color="#FF0000"><b>if </b></font>Status <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
          goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font>Verify <font color="#FF0000"><b>then begin
        </b></font><font color="#008000"><i>{Status proc: verifying track}
        </i></font><font color="#FF0000"><b>if </b></font>FAF<font color="#000080">(</font>Track<font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>TPD<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
          </b></font>Status <font color="#000080">:= </font><font color="#800000">$FA</font><font color="#000080">;
          </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

        </font><font color="#FF0000"><b>for </b></font>Side <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do
          </b></font><font color="#008000"><i>{Verify the entire track}
          </i></font><font color="#FF0000"><b>if </b></font>VerifySectors<font color="#000080">(</font>Drive<font color="#000080">, </font>Track<font color="#000080">, </font>Side<font color="#000080">,
                           </font><font color="#800000">1</font><font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
            if </b></font>Track <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
              </b></font><font color="#008000"><i>{Disk bad}
              </i></font>Status <font color="#000080">:= </font><font color="#800000">$FD</font><font color="#000080">;
              </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

            </font><font color="#FF0000"><b>for </b></font>Sector <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT <font color="#FF0000"><b>do
              if </b></font>VerifySectors<font color="#000080">(</font>Drive<font color="#000080">, </font>Track<font color="#000080">, </font>Side<font color="#000080">,
                               </font>Sector<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
                </b></font>MarkBadSector<font color="#000080">(</font>Track<font color="#000080">, </font>Side<font color="#000080">, </font>Sector<font color="#000080">);
                </font><font color="#FF0000"><b>if </b></font>BadSects <font color="#000080">&gt; </font>MaxBadSects <font color="#FF0000"><b>then begin
                  </b></font>Status <font color="#000080">:= </font><font color="#800000">$FC</font><font color="#000080">;
                  </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Status proc: writing boot and FAT}
    </i></font><font color="#FF0000"><b>if </b></font>FAF<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>TPD<font color="#000080">, </font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font>Status <font color="#000080">:= </font><font color="#800000">$FA</font><font color="#000080">;
      </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Write boot record}
    </i></font>Status <font color="#000080">:= </font>WriteSectors<font color="#000080">(</font>Drive<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>BootPtr<font color="#000080">^);
    </font><font color="#FF0000"><b>if </b></font>Status <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>Status <font color="#000080">:= </font><font color="#800000">$FD</font><font color="#000080">;
      </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Write FATs and volume label}
    </i></font>Track <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Side <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Sector <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
    </font>FatNum <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>RTotal <font color="#000080">:= (</font><font color="#800000">2</font><font color="#000080">*</font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPF<font color="#000080">)+</font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>DSC<font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>RWritten <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>RTotal<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
      if </b></font>Sector <font color="#000080">&gt; </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPT <font color="#FF0000"><b>then begin
        </b></font>Sector <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
        </font>Inc<font color="#000080">(</font>Side<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font>RWritten <font color="#000080">&lt; (</font><font color="#800000">2</font><font color="#000080">*</font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPF<font color="#000080">) </font><font color="#FF0000"><b>then begin
        if </b></font>FatNum <font color="#000080">&gt; </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPF<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>then
          </b></font>FatNum <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>end else begin
        </b></font>FillChar<font color="#000080">(</font>FATs<font color="#000080">^, </font><font color="#800000">512</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font><font color="#000080">((</font>VLabel <font color="#000080">&lt;&gt; </font><font color="#800000">''</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>RWritten <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">*</font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>SPF<font color="#000080">)) </font><font color="#FF0000"><b>then begin
          </b></font><font color="#008000"><i>{Put in volume label}
          </i></font><font color="#FF0000"><b>for </b></font>Trash <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Length<font color="#000080">(</font>VLabel<font color="#000080">) </font><font color="#FF0000"><b>do
            </b></font>VLabel<font color="#000080">[</font>Trash<font color="#000080">] := </font>Upcase<font color="#000080">(</font>VLabel<font color="#000080">[</font>Trash<font color="#000080">]);
          </font><font color="#FF0000"><b>while </b></font>Length<font color="#000080">(</font>VLabel<font color="#000080">) &lt; </font><font color="#800000">11 </font><font color="#FF0000"><b>do
            </b></font>VLabel <font color="#000080">:= </font>VLabel<font color="#000080">+</font><font color="#800000">' '</font><font color="#000080">;
          </font>Move<font color="#000080">(</font>VLabel<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>FATs<font color="#000080">^, </font><font color="#800000">11</font><font color="#000080">);
          </font>FATs<font color="#000080">^[</font><font color="#800000">11</font><font color="#000080">] := </font><font color="#800000">8</font><font color="#000080">;
          </font>GetDate<font color="#000080">(</font>DT<font color="#000080">.</font>Year<font color="#000080">, </font>DT<font color="#000080">.</font>Month<font color="#000080">, </font>DT<font color="#000080">.</font>Day<font color="#000080">, </font>Trash<font color="#000080">);
          </font>GetTime<font color="#000080">(</font>DT<font color="#000080">.</font>Hour<font color="#000080">, </font>DT<font color="#000080">.</font>Min<font color="#000080">, </font>DT<font color="#000080">.</font>Sec<font color="#000080">, </font>Trash<font color="#000080">);
          </font>PackTime<font color="#000080">(</font>DT<font color="#000080">, </font>VDate<font color="#000080">);
          </font>Move<font color="#000080">(</font>VDate<font color="#000080">, </font>FATs<font color="#000080">^[</font><font color="#800000">22</font><font color="#000080">], </font><font color="#800000">4</font><font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>FatNum <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font>WriteSectors<font color="#000080">(</font>Drive<font color="#000080">, </font>Track<font color="#000080">, </font>Side<font color="#000080">,
                      </font>Sector<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>FATs<font color="#000080">^[</font>FatNum<font color="#000080">*</font><font color="#800000">512</font><font color="#000080">]) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
        </b></font>Status <font color="#000080">:= </font><font color="#800000">$FD</font><font color="#000080">;
        </font><font color="#FF0000"><b>goto </b></font>ExitPoint<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font>Inc<font color="#000080">(</font>Sector<font color="#000080">);
      </font>Inc<font color="#000080">(</font>FatNum<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Success}
    </i></font>Status <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

</font>ExitPoint<font color="#000080">:
    </font>FreeBuffer<font color="#000080">(</font>BootPtr<font color="#000080">, </font>SizeOf<font color="#000080">(</font>BootRecord<font color="#000080">));
    </font>FreeBuffer<font color="#000080">(</font>CHRN<font color="#000080">, </font>SizeOf<font color="#000080">(</font>CHRNArray<font color="#000080">));
    </font>FreeBuffer<font color="#000080">(</font>FATs<font color="#000080">, </font>SizeOf<font color="#000080">(</font>FATArray<font color="#000080">));

    </font><font color="#008000"><i>{Status proc: ending format}
    </i></font>Done <font color="#000080">:= </font>FAF<font color="#000080">(</font>Status<font color="#000080">, </font>DData<font color="#000080">[</font>DType<font color="#000080">].</font>TPD<font color="#000080">, </font><font color="#800000">4</font><font color="#000080">);
    </font>FormatDisk <font color="#000080">:= </font>Status<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>EmptyAbortFunc<font color="#000080">(</font>Track<font color="#000080">, </font>MaxTrack <font color="#000080">: </font>Byte<font color="#000080">; </font>Kind <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>EmptyAbortFunc <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ -------------------------------    DEMO PROGRAM   -------------------- }
{ -------------------------------     CUT HERE      ---------------------}

{$R-,S-,I-}

</i></font><font color="#FF0000"><b>program </b></font>Fmt<font color="#000080">;
  </font><font color="#008000"><i>{-Simple formatting program to demonstate DISKB unit}

</i></font><font color="#FF0000"><b>uses
</b></font><font color="#008000"><i>{$IFDEF Windows}
  </i></font>WinCrt<font color="#000080">,
</font><font color="#008000"><i>{$ENDIF}
  </i></font>BDisk<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>ESC <font color="#000080">= </font><font color="#800000">#27</font><font color="#000080">;
  </font>CR <font color="#000080">= </font><font color="#800000">#13</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>CharSet <font color="#000080">= </font><font color="#FF0000"><b>set of </b></font>Char<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>DLet <font color="#000080">: </font>Char<font color="#000080">;
  </font>DTyp <font color="#000080">: </font>Char<font color="#000080">;
  </font>Verf <font color="#000080">: </font>Char<font color="#000080">;
  </font>GLet <font color="#000080">: </font>Char<font color="#000080">;
  </font>DNum <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Status <font color="#000080">: </font>Byte<font color="#000080">;
  </font>VStr <font color="#000080">: </font>VolumeStr<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>DriveTypeName <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>DriveType<font color="#000080">] </font><font color="#FF0000"><b>of string</b></font><font color="#000080">[</font><font color="#800000">5</font><font color="#000080">] =
    (</font><font color="#800000">'other'</font><font color="#000080">, </font><font color="#800000">'360K'</font><font color="#000080">, </font><font color="#800000">'1.2M'</font><font color="#000080">, </font><font color="#800000">'720K'</font><font color="#000080">, </font><font color="#800000">'1.44M'</font><font color="#000080">);

</font><font color="#008000"><i>{$IFNDEF Windows}
  </i></font><font color="#FF0000"><b>function </b></font>ReadKey <font color="#000080">: </font>Char<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
    </font><font color="#008000"><i>{-Low budget readkey routine}
  </i></font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">xor ah,ah
    int 16h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

  </i></font><font color="#FF0000"><b>function </b></font>GetKey<font color="#000080">(</font>Prompt <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>OKSet <font color="#000080">: </font>CharSet<font color="#000080">) : </font>Char<font color="#000080">;
    </font><font color="#008000"><i>{-Get and return a key in the OKSet}
  </i></font><font color="#FF0000"><b>var
    </b></font>Ch <font color="#000080">: </font>Char<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>Write<font color="#000080">(</font>Prompt<font color="#000080">);
    </font><font color="#FF0000"><b>repeat
      </b></font>Ch <font color="#000080">:= </font>Upcase<font color="#000080">(</font>ReadKey<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Ch <font color="#000080">= </font>ESC <font color="#FF0000"><b>then begin
        </b></font>WriteLn<font color="#000080">;
        </font>Halt<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>Ch <font color="#FF0000"><b>in </b></font>OKSet<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Ch <font color="#000080">&lt;&gt; </font>CR <font color="#FF0000"><b>then
      </b></font>Write<font color="#000080">(</font>Ch<font color="#000080">);
    </font>WriteLn<font color="#000080">;
    </font>GetKey <font color="#000080">:= </font>Ch<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>AbortFunc<font color="#000080">(</font>Track<font color="#000080">, </font>MaxTrack <font color="#000080">: </font>Byte<font color="#000080">; </font>Kind <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
    </font><font color="#008000"><i>{-Display formatting status. Could check for abort here too}
  </i></font><font color="#FF0000"><b>begin
    case </b></font>Kind <font color="#FF0000"><b>of
      </b></font><font color="#800000">0 </font><font color="#000080">: </font><font color="#008000"><i>{Format beginning}
        </i></font>Write<font color="#000080">(</font><font color="#800000">'Formatting     '</font><font color="#000080">);
      </font><font color="#800000">1 </font><font color="#000080">: </font><font color="#008000"><i>{Formatting track}
        </i></font>Write<font color="#000080">(^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">, ((</font>Track<font color="#000080">*</font><font color="#800000">100</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font>MaxTrack<font color="#000080">):</font><font color="#800000">3</font><font color="#000080">, </font><font color="#800000">'%'</font><font color="#000080">);
      </font><font color="#800000">2 </font><font color="#000080">: </font><font color="#008000"><i>{Verifying track}
        </i></font>Write<font color="#000080">(^</font>H<font color="#000080">, </font><font color="#800000">'V'</font><font color="#000080">);
      </font><font color="#800000">3 </font><font color="#000080">: </font><font color="#008000"><i>{Writing boot and FAT}
        </i></font>Write<font color="#000080">(^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">, </font><font color="#800000">'Writing boot and FAT'</font><font color="#000080">);
      </font><font color="#800000">4 </font><font color="#000080">: </font><font color="#008000"><i>{Format ending}
        </i></font><font color="#FF0000"><b>begin
          </b></font>Write<font color="#000080">(^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">^</font>H<font color="#000080">);
          </font><font color="#008000"><i>{Track returns final status code in this case}
          </i></font><font color="#FF0000"><b>if </b></font>Track <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
            </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Formatted successfully'</font><font color="#000080">)
          </font><font color="#FF0000"><b>else
            </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Format failed: '</font><font color="#000080">, </font>GetStatusStr<font color="#000080">(</font>Track<font color="#000080">));
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>AbortFunc <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Floppy Formatter: &lt;Esc&gt; to exit'</font><font color="#000080">);

  </font><font color="#008000"><i>{Get formatting parameters}
  </i></font>DLet <font color="#000080">:= </font>GetKey<font color="#000080">(</font><font color="#800000">'Drive to format? (A or B): '</font><font color="#000080">, [</font><font color="#800000">'A'</font><font color="#000080">..</font><font color="#800000">'B'</font><font color="#000080">]);
  </font>DTyp <font color="#000080">:= </font>GetKey<font color="#000080">(</font><font color="#800000">'Disk type? (1=360K, 2=1.2M, 3=720K, 4=1.44M): '</font><font color="#000080">, [</font><font color="#800000">'1'</font><font color="#000080">..</font><font color="#800000">'4'</font><font color="#000080">]);
  </font>Verf <font color="#000080">:= </font>GetKey<font color="#000080">(</font><font color="#800000">'Verify? (Y or N) '</font><font color="#000080">, [</font><font color="#800000">'N'</font><font color="#000080">, </font><font color="#800000">'Y'</font><font color="#000080">]);
  </font>Write<font color="#000080">(</font><font color="#800000">'Volume label? '</font><font color="#000080">);
  </font>ReadLn<font color="#000080">(</font>VStr<font color="#000080">);
  </font>GLet <font color="#000080">:= </font>GetKey<font color="#000080">(</font><font color="#800000">'Insert disk and press &lt;Enter&gt; '</font><font color="#000080">, [</font><font color="#800000">#13</font><font color="#000080">]);

  </font><font color="#008000"><i>{Compute drive number}
  </i></font>DNum <font color="#000080">:= </font>Byte<font color="#000080">(</font>DLet<font color="#000080">)-</font>Byte<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">);

  </font>WriteLn<font color="#000080">(</font><font color="#800000">'Drive type is '</font><font color="#000080">, </font>DriveTypeName<font color="#000080">[</font>GetDriveType<font color="#000080">(</font>DNum<font color="#000080">)]);

  </font>Status <font color="#000080">:= </font>FormatDisk<font color="#000080">(</font>DNum<font color="#000080">,                    </font><font color="#008000"><i>{drive number}
                       </i></font>Byte<font color="#000080">(</font>DTyp<font color="#000080">)-</font>Byte<font color="#000080">(</font><font color="#800000">'0'</font><font color="#000080">),    </font><font color="#008000"><i>{format type}
                       </i></font><font color="#000080">(</font>Verf <font color="#000080">= </font><font color="#800000">'Y'</font><font color="#000080">),            </font><font color="#008000"><i>{verify?}
                       </i></font><font color="#800000">10</font><font color="#000080">,                      </font><font color="#008000"><i>{max bad sectors}
                       </i></font>VStr<font color="#000080">,                    </font><font color="#008000"><i>{volume label}
                       </i></font>AbortFunc<font color="#000080">);              </font><font color="#008000"><i>{abort function}
  {AbortFunc reports the status}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0055.PAS">Original</a><b>]</b></p></body>
</html>
