<html>
<head><title> "Is Drive Valid" by JACOB STEDMAN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Does anyone know if there is a way For a Pascal Program to determine
&gt; whether a drive is a local hard drive, a network drive, a Dos
&gt; SUBSTituted drive, or a RAMDRIVE?

Hmm... I'm reading this one week after it got posted. and a month after the
original question. I haven't read last week's messages, hope you hadn't
recieved to many answers about this now. But because you apparently hadn't got
anything two weeks after asking, I thought you may want this, so here comes...

There is a service in Dos that identifies a given drive as local or remote.
This service also tells you if the drive is SUBSTed. You can also get info
about whether it Uses removable media from another service. There is no way to
detect a RAM-drive, as Far as I know, and I've got the facts from Microsoft's
own MSJ! The Dos 5 DosSHELL simple checks the volume identifier. if it's
'MS-RAMDRIVE', 'RDV' or 'VDISK', the drive is ASSUMED to be a RAM-disk. But
it's, again according to Microsoft Systems Journal, impossible to foolproof
check if a drive is a logical RAM-drive. A design flaw in Dos.

However, I will show a few lines of TP-code For checking if a drive is remote
or local, and SUBSTed or not. I use the TP 5.5 (and older) method of Intr-calls
For simulating Asm, of course if could be written clearer With TP6's
Asm-keyWord. The code consists of the actual Function and a test stub, cut the
stub when you have looked at it. Code Compiles and runs fine on my system; I
couldn't test if it work With remote drives, but it should. I've used similar
code that worked With that too, so...

}
</i></font><font color="#FF0000"><b>Program </b></font>TestDrv<font color="#000080">;

</font><font color="#008000"><i>{ --- A very short test-Program For Dos-IOCTL, Jacob Stedman 930223 --- }

</i></font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>IsDriveValid<font color="#000080">(</font>cDrive<font color="#000080">: </font>Char<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>bLocal<font color="#000080">, </font>bSUBST<font color="#000080">: </font>Boolean<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#008000"><i>{
  Parameters: cDrive is the drive letter, 'A' to 'Z', that's about
  to be checked. if not in this range, the Function will return False.

  Returns: Function returns True if the given drive is valid, else
  False (!). bLocal is set if drive is local, bSUBST if drive is
  substituted. if Function returns False, the Booleans are undefined.
}
</i></font><font color="#FF0000"><b>Var
  </b></font>rCPU<font color="#000080">: </font>Dos<font color="#000080">.</font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ --- Call Dos and process returns --- }
  </i></font><font color="#FF0000"><b>if not </b></font><font color="#000080">(</font>UpCase<font color="#000080">(</font>cDrive<font color="#000080">) </font><font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">'A'</font><font color="#000080">..</font><font color="#800000">'Z'</font><font color="#000080">]) </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ --- letter OK?--- }
    </i></font>IsDriveValid <font color="#000080">:= </font>False
  <font color="#FF0000"><b>else
  begin
    </b></font><font color="#008000"><i>{ --- Valid letter, set up For the Dos-call --- }
    </i></font>rCPU<font color="#000080">.</font>bx <font color="#000080">:= </font>ord<font color="#000080">(</font>UpCase<font color="#000080">(</font>cDrive<font color="#000080">))-</font>ord<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
    </font>rCPU<font color="#000080">.</font>ax <font color="#000080">:= </font><font color="#800000">$4409</font><font color="#000080">;
    </font><font color="#008000"><i>{ --- Call the Dos IOCTL (InOutConTroL)-Functions --- }
    </i></font>Intr<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">, </font>rCPU<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>rCPU<font color="#000080">.</font>ax <font color="#FF0000"><b>and </b></font>FCarry<font color="#000080">) = </font>FCarry <font color="#FF0000"><b>then
      </b></font>IsDriveValid <font color="#000080">:= </font>False
    <font color="#FF0000"><b>else
    begin </b></font><font color="#008000"><i>{ --- drive is valid, check status --- }
      </i></font>IsDriveValid <font color="#000080">:= </font>True<font color="#000080">;
      </font>bLocal <font color="#000080">:= ((</font>rCPU<font color="#000080">.</font>dx <font color="#FF0000"><b>and </b></font><font color="#800000">$1000</font><font color="#000080">) = </font><font color="#800000">$0000</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>bLocal <font color="#FF0000"><b>then
        </b></font>bSUBST <font color="#000080">:= ((</font>rCPU<font color="#000080">.</font>dx <font color="#FF0000"><b>and </b></font><font color="#800000">$8000</font><font color="#000080">) = </font><font color="#800000">$8000</font><font color="#000080">)
      </font><font color="#FF0000"><b>else
        </b></font>bSUBST <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>cCurChar <font color="#000080">: </font>Char<font color="#000080">;          </font><font color="#008000"><i>{ loop counter, drive }
  </i></font>bLocal<font color="#000080">,
  </font>bSUBST   <font color="#000080">: </font>Boolean<font color="#000080">;       </font><font color="#008000"><i>{ drive local/remote?; SUBSTed or not? }

</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ --- Write header --- }
  </i></font>Writeln<font color="#000080">; </font>Writeln<font color="#000080">(</font><font color="#800000">'  VALID DRIVES:'</font><font color="#000080">); </font>Writeln<font color="#000080">;
  </font><font color="#008000"><i>{ --- Loop from 'A' to 'Z', For each iteration check a drive --- }
  </i></font><font color="#FF0000"><b>For </b></font>cCurChar <font color="#000080">:= </font><font color="#800000">'A' </font><font color="#FF0000"><b>to </b></font><font color="#800000">'Z' </font><font color="#FF0000"><b>do
    if </b></font>IsDriveValid<font color="#000080">(</font>cCurChar<font color="#000080">, </font>bLocal<font color="#000080">, </font>bSUBST<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>Write<font color="#000080">(</font>cCurChar<font color="#000080">, </font><font color="#800000">': '</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>bLocal <font color="#FF0000"><b>then
        </b></font>Write<font color="#000080">(</font><font color="#800000">' local '</font><font color="#000080">)
      </font><font color="#FF0000"><b>else
        </b></font>Write<font color="#000080">(</font><font color="#800000">' remote'</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>bSUBST <font color="#FF0000"><b>then
        </b></font>Write<font color="#000080">(</font><font color="#800000">'   SUBSTed '</font><font color="#000080">)
      </font><font color="#FF0000"><b>else
        </b></font>Write<font color="#000080">(</font><font color="#800000">'   not SUBSTed'</font><font color="#000080">);
      </font>Writeln<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ --- Write footer --- }
  </i></font>Writeln<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
The code is simple. It calls the Dos IOCTL-service #09h, 'Is Drive Remote',
with the drive number (1-A:, 2-B:, ...) in the bl-register. if the drive isn't
valid, the carry flag is set. if valid, carry is clear, and the dx-register
contains bit-fields you're interested in. Bit 12 is 1 if remote, 0 if local. if
local, bit 15 is 1 if the drive is a substitution. In TP, you get access to
them, in this Case, by using the 'and'-binary operator.

I guess you're interested in making a Filemanager or a report util or that
like. then, you're maybe interested to get source For detection of CD-ROM
drives and floppys? if so, post me a new msg. I always like to recieve new
mail... I didn't include this here, this msg is too long without that extra
code. Feel free to Write if you get any problems.
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p></body>
</html>
