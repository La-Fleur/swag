<html>
<head><title> "Drive Locking" by CLAUS ZIEGLER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0108.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
RN &gt; Howdy All!

RN &gt; I &quot;had&quot; a small external program, that ran as a module for
RN &gt; one of my larger products.  This module allowed formatting
RN &gt; of floppy disks.

RN &gt; Since WIN95 this program no longer works, returns errors.

RN &gt; From my reading, is seems that DOS programs using IRQ ummmm,
RN &gt; 25 and ?? conflict with WIN95 system, unless they LOCK the
RN &gt; volume.

and Interrupt 13h, interrupt 26h and IOCTL functions

RN &gt; Can anybody tell me how, in a DOS program, to LOCK the
RN &gt; volume ID so that the floppy in that drive might be
RN &gt; formatted, under WIN95 OS?

I use:


------------------------- Cut begin (TEMP.TMP) ---------------------------
}
</i></font><font color="#FF0000"><b>Function </b></font>Lock<font color="#000080">(</font>DNum<font color="#000080">:</font>Byte<font color="#000080">):</font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>fejl <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font><font color="#008000"><i>{$ifdef Windows}
  </i></font>Lock<font color="#000080">:=</font>True<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font><font color="#000080">((</font>GetWinFlags <font color="#FF0000"><b>and </b></font><font color="#800000">$4000</font><font color="#000080">)&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Hi<font color="#000080">(</font>LoWord<font color="#000080">(</font>GetVersion<font color="#000080">))&lt;</font><font color="#800000">20</font><font color="#000080">) </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
  </font><font color="#008000"><i>{$Endif}
  </i></font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov fejl,1      </font><font color="#008000"><i>{Nothing is OK yet}
    </i></font><font color="#FF00FF">Mov ax,440dh    </font><font color="#008000"><i>{generic IOCTL}
    </i></font><font color="#FF00FF">Mov bh,0        </font><font color="#008000"><i>{Lock level, first lock on drive}
    </i></font><font color="#FF00FF">Mov bl,DNum     </font><font color="#008000"><i>{Number of drive}
    </i></font><font color="#FF00FF">Mov ch,08h      </font><font color="#008000"><i>{device catagory (Must be 08h)}
    </i></font><font color="#FF00FF">Mov cl,4bh      </font><font color="#008000"><i>{Lock physical volume}
    </i></font><font color="#FF00FF">Mov dx,0b       </font><font color="#008000"><i>{Permisions (First lock=0)}
    {$ifdef Windows}
    </i></font><font color="#FF00FF">Call Dos3Call   </font><font color="#008000"><i>{Do it}
    {$Else}
    </i></font><font color="#FF00FF">Int 21h
    </font><font color="#008000"><i>{$Endif}
    </i></font><font color="#FF00FF">jc @@Error      </font><font color="#008000"><i>{Error?}
    </i></font><font color="#FF00FF">Mov ax,440dh    </font><font color="#008000"><i>{generic IOCTL}
    </i></font><font color="#FF00FF">Mov bh,0        </font><font color="#008000"><i>{Lock level, second lock on drive}
    </i></font><font color="#FF00FF">Mov bl,DNum     </font><font color="#008000"><i>{Number of drive}
    </i></font><font color="#FF00FF">Mov ch,08h      </font><font color="#008000"><i>{Device catagory (Must be 08h)}
    </i></font><font color="#FF00FF">Mov cl,4bh      </font><font color="#008000"><i>{Lock physical volume}
    </i></font><font color="#FF00FF">Mov dx,100b     </font><font color="#008000"><i>{Lock for format}
    {$ifdef Windows}
    </i></font><font color="#FF00FF">Call Dos3Call   </font><font color="#008000"><i>{Do it}
    {$Else}
    </i></font><font color="#FF00FF">Int 21h
    </font><font color="#008000"><i>{$Endif}
    </i></font><font color="#FF00FF">jc @@Error2     </font><font color="#008000"><i>{Error?}
    </i></font><font color="#FF00FF">Mov Fejl,0      </font><font color="#008000"><i>{No, no error here}
    </i></font><font color="#FF00FF">Jmp @@Error     </font><font color="#008000"><i>{End this function}
    </i></font><font color="#FF00FF">@@Error2:
    Mov ax,440dh    </font><font color="#008000"><i>{Unlock first lock, if second failed}
    </i></font><font color="#FF00FF">Mov bl,DNum     </font><font color="#008000"><i>{Number of drive}
    </i></font><font color="#FF00FF">Mov ch,08h      </font><font color="#008000"><i>{Device catagory (Must be 08h)}
    </i></font><font color="#FF00FF">Mov cl,6bh      </font><font color="#008000"><i>{Unlock physical volume}
    {$ifdef Windows}
    </i></font><font color="#FF00FF">Call Dos3Call   </font><font color="#008000"><i>{Do it}
    {$Else}
    </i></font><font color="#FF00FF">Int 21h
    </font><font color="#008000"><i>{$Endif}
    </i></font><font color="#FF00FF">@@Error:
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>Lock<font color="#000080">:=(</font>Fejl<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>UnLock<font color="#000080">(</font>DNum<font color="#000080">:</font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Begin
  </b></font><font color="#008000"><i>{$ifdef Windows}
  </i></font><font color="#FF0000"><b>If </b></font><font color="#000080">((</font>GetWinFlags <font color="#FF0000"><b>and </b></font><font color="#800000">$4000</font><font color="#000080">)&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Hi<font color="#000080">(</font>LoWord<font color="#000080">(</font>GetVersion<font color="#000080">))&lt;</font><font color="#800000">20</font><font color="#000080">) </font><font color="#FF0000"><b>Then </b></font>Exit<font color="#000080">;
  </font><font color="#008000"><i>{$Endif}
  </i></font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">Mov ax,440dh    </font><font color="#008000"><i>{Generic IOCTL}
    </i></font><font color="#FF00FF">Mov bl,DNum     </font><font color="#008000"><i>{Drive number}
    </i></font><font color="#FF00FF">Mov ch,08h      </font><font color="#008000"><i>{Device catagory (Must be 08h)}
    </i></font><font color="#FF00FF">Mov cl,6bh      </font><font color="#008000"><i>{Unlock physical volume}
    {$ifdef Windows}
    </i></font><font color="#FF00FF">Call Dos3Call   </font><font color="#008000"><i>{Do it}
    {$Else}
    </i></font><font color="#FF00FF">Int 21h
    </font><font color="#008000"><i>{$Endif}
    </i></font><font color="#FF00FF">Mov ax,440dh    </font><font color="#008000"><i>{Generic IOCTL}
    </i></font><font color="#FF00FF">Mov bl,DNum     </font><font color="#008000"><i>{Drive number}
    </i></font><font color="#FF00FF">Mov ch,08h      </font><font color="#008000"><i>{Device catagory (Must be 08h)}
    </i></font><font color="#FF00FF">Mov cl,6bh      </font><font color="#008000"><i>{Unlock physical volume}
    {$ifdef Windows}
    </i></font><font color="#FF00FF">Call Dos3Call   </font><font color="#008000"><i>{Do it}
    {$Else}
    </i></font><font color="#FF00FF">Int 21h
    </font><font color="#008000"><i>{$Endif}
  </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

-------------------------- </font>Cut <font color="#FF0000"><b>end </b></font><font color="#000080">(</font>TEMP<font color="#000080">.</font>TMP<font color="#000080">)-----------------------------

</font>It <font color="#FF0000"><b>is </b></font>used <font color="#FF0000"><b>in </b></font>this way<font color="#000080">:

</font><font color="#FF0000"><b>If </b></font>Lock<font color="#000080">(</font>Drive<font color="#000080">) </font><font color="#FF0000"><b>then begin
  </b></font>Format<font color="#000080">(</font>Drive<font color="#000080">) </font><font color="#008000"><i>{or whatever}
  </i></font>UnLock<font color="#000080">(</font>Drive<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font>The drives are numbered<font color="#000080">: </font>A<font color="#000080">=</font><font color="#800000">0 </font>B<font color="#000080">=</font><font color="#800000">1
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0108.PAS">Original</a><b>]</b></p></body>
</html>
