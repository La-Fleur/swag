<html>
<head><title> "Detecting RAM Disks" by DESCLIN JEAN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0053.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Desclin Jean &lt;desclinj@ulb.ac.be&gt;

 a few days ago (sorry, I didn't write down the name of the person
 who posted the question :-(), someone asked how one could
 identify a drive as a ramdisk.
 Below is a solution, which I submit with the hope that someone
 else could show how to improve on it, since it is not 'fail-safe'.
 Here it comes...

Modified after Michael Tischer: Turbo Pascal 6 System Programming
ABACUS Publisher Grand Rapids, MI 49512  1991 ISBN 1-55755-124-3
I had to write the procedure Getdrives twice in order to take into
account the changes in the DPB structure which occurred from DOS
4.0 onwards. Mostly, Ramdisks have only one File Allocation Table,
whereas other drive types have two. That's what a procedure such
as GetDiskClass of TurboPower Object Professional (usual disclaimer
here ;-)) uses to decide whether the drive is a ramdisk or not. BUT
BEWARE! This is not necessarily so! Norton mentions, in his 'disk
companion', that depending on the device driver of the ramdisk, one
or two FATS may be implemented. I could verify this on 'STACKED'
ramdisks: they have two FATS, whereas only one FAT is present after
'unSTACKING' :-(. Thus, the solution below is somewhat shaky.
}


</i></font><font color="#FF0000"><b>program </b></font>idramdsk<font color="#000080">;
</font><font color="#FF0000"><b>uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>ver <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetDrives1<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>DPBPTR    <font color="#000080">= ^</font>DPB<font color="#000080">;                 </font><font color="#008000"><i>{ pointer to a DOS Parameter Block }
  </i></font>DPBPTRPTR <font color="#000080">= ^</font>DPBPTR<font color="#000080">;              </font><font color="#008000"><i>{ pointer to a pointer to a DPB }
  </i></font>DPB       <font color="#000080">= </font><font color="#FF0000"><b>record                </b></font><font color="#008000"><i>{ recreation of a DOS Parameter Block }
    </i></font>Code   <font color="#000080">: </font>byte<font color="#000080">;                  </font><font color="#008000"><i>{ drive code (0=A, 1=B etc. }
    </i></font>dummy1 <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">$07</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;</font><font color="#008000"><i>{irrelevant bytes}
    </i></font>FatNb  <font color="#000080">: </font>byte<font color="#000080">;                  </font><font color="#008000"><i>{Number of File Allocation Tables }
    </i></font>dummy2 <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">9</font><font color="#000080">..</font><font color="#800000">$17</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;</font><font color="#008000"><i>{irrelevant bytes}
    </i></font>Next   <font color="#000080">: </font>DPBPTR<font color="#000080">;                </font><font color="#008000"><i>{ pointer to next DPB }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                              </font><font color="#008000"><i>{ xxxx:FFFF marks last DPB }

</i></font><font color="#FF0000"><b>var
  </b></font>Regs     <font color="#000080">: </font>Registers<font color="#000080">;             </font><font color="#008000"><i>{ register for interrupt call }
  </i></font>CurrDpbP <font color="#000080">: </font>DPBPTR<font color="#000080">;                </font><font color="#008000"><i>{ pointer to DPBs in memory }

</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{-- get pointer to first DPB ------------------------------------}
  </i></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$52</font><font color="#000080">; </font><font color="#008000"><i>{function $52 returns ptr to DOS Information Block }
  </i></font>MsDos<font color="#000080">(</font>Regs<font color="#000080">);    </font><font color="#008000"><i>{that's an UNDOCUMENTED DOS function !             }
  </i></font>CurrDpbP <font color="#000080">:= </font>DPBPTRPTR<font color="#000080">(</font>ptr<font color="#000080">(</font>Regs<font color="#000080">.</font>ES<font color="#000080">, </font>Regs<font color="#000080">.</font>BX<font color="#000080">))^;

  </font><font color="#008000"><i>{-- follow the chain of DPBs--------------------------------------}
  </i></font><font color="#FF0000"><b>repeat
    </b></font>writeln<font color="#000080">(</font>chr<font color="#000080">(</font>ord<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">) + </font>CurrDpbP<font color="#000080">^.</font>Code<font color="#000080">),     </font><font color="#008000"><i>{display device code }
              </i></font><font color="#800000">':(FATS: '</font><font color="#000080">, </font>CurrDpbP<font color="#000080">^.</font>FatNb<font color="#000080">,</font><font color="#800000">')'</font><font color="#000080">); </font><font color="#008000"><i>{and number of FATs  }

    </i></font>CurrDpbP <font color="#000080">:= </font>CurrDpbP<font color="#000080">^.</font>Next<font color="#000080">;   </font><font color="#008000"><i>{ set pointer to next DPB        }
  </i></font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>Ofs<font color="#000080">(</font>CurrDpbP<font color="#000080">^) = </font><font color="#800000">$FFFF</font><font color="#000080">);  </font><font color="#008000"><i>{ until last DPB is reached }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetDrives2<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>DPBPTR    <font color="#000080">= ^</font>DPB<font color="#000080">;                 </font><font color="#008000"><i>{ pointer to a DOS Parameter Block }
  </i></font>DPBPTRPTR <font color="#000080">= ^</font>DPBPTR<font color="#000080">;              </font><font color="#008000"><i>{ pointer to a pointer to a DPB }
  </i></font>DPB       <font color="#000080">= </font><font color="#FF0000"><b>record                </b></font><font color="#008000"><i>{ recreation of a DOS Parameter Block }
    </i></font>Code   <font color="#000080">: </font>byte<font color="#000080">;                  </font><font color="#008000"><i>{ drive code (0=A, 1=B etc. }
    </i></font>dummy1 <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">$07</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;</font><font color="#008000"><i>{irrelevant bytes}
    </i></font>FatNb  <font color="#000080">: </font>byte<font color="#000080">;                  </font><font color="#008000"><i>{ Number of File Allocation Tables}
    </i></font>dummy2 <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">9</font><font color="#000080">..</font><font color="#800000">$18</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;</font><font color="#008000"><i>{irrelevant bytes}
    </i></font>Next   <font color="#000080">: </font>DPBPTR<font color="#000080">;                </font><font color="#008000"><i>{ pointer to next DPB }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                              </font><font color="#008000"><i>{ xxxx:FFFF marks last DPB }

</i></font><font color="#FF0000"><b>var
  </b></font>Regs     <font color="#000080">: </font>Registers<font color="#000080">;             </font><font color="#008000"><i>{ register for interrupt call }
  </i></font>CurrDpbP <font color="#000080">: </font>DPBPTR<font color="#000080">;                </font><font color="#008000"><i>{ pointer to DPBs in memory }

</i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{-- get pointer to first DPB-------------------------------------}
  </i></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$52</font><font color="#000080">; </font><font color="#008000"><i>{function $52 returns ptr to Dos Information Block }
  </i></font>MsDos<font color="#000080">(</font>Regs<font color="#000080">);    </font><font color="#008000"><i>{that's an UNDOCUMENTED DOS function !             }
  </i></font>CurrDpbP <font color="#000080">:= </font>DPBPTRPTR<font color="#000080">(</font>ptr<font color="#000080">(</font>Regs<font color="#000080">.</font>ES<font color="#000080">, </font>Regs<font color="#000080">.</font>BX<font color="#000080">))^;

  </font><font color="#008000"><i>{-- follow the chain of DPBs -------------------------------------}
  </i></font><font color="#FF0000"><b>repeat
    </b></font><font color="#008000"><i>{output device letter and number of FATs (1 for RAM disks)   }
    </i></font>writeln<font color="#000080">(</font>chr<font color="#000080">(</font>ord<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">) + </font>CurrDpbP<font color="#000080">^.</font>Code<font color="#000080">), </font><font color="#800000">':(FATS: '</font><font color="#000080">, </font>CurrDpbP<font color="#000080">^.</font>FatNb<font color="#000080">, </font><font color="#800000">')'</font><font color="#000080">);
    </font>CurrDpbP <font color="#000080">:= </font>CurrDpbP<font color="#000080">^.</font>Next<font color="#000080">;    </font><font color="#008000"><i>{ set pointer to next DPB        }
  </i></font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>Ofs<font color="#000080">(</font>CurrDpbP<font color="#000080">^) = </font><font color="#800000">$FFFF</font><font color="#000080">);  </font><font color="#008000"><i>{ until last DPB is reached }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>ver <font color="#000080">:= </font>Lo<font color="#000080">(</font>DosVersion<font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">#13#10'Installed drives: '#13#10</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ver <font color="#000080">&lt; </font><font color="#800000">4 </font><font color="#FF0000"><b>then
    </b></font>GetDrives1
  <font color="#FF0000"><b>else
    </b></font>GetDrives2
<font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0053.PAS">Original</a><b>]</b></p></body>
</html>
