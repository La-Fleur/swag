<html>
<head><title> "Extends GetDriveType Function" by K. CAMPBELL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0103.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{ ###################################################################

	Extends the Windows function GetDriveType()
	and provides the same function for Dos...

	This code by: K Campbell CompuServe [100064,1751]

	Some sections hacked out of code by:

		Dr. Peter Below CIS [100113.1101]

	&amp;

		Extended GetDriveType for Windows 3.0/3.1.
		Code ported from the C in Microsoft PSS document Q105922.
		by	Doug Wegscheid 3/22/94.

	No warrenties given! (Don't blame them, blame me.)

	Note:

	1)		this uses the convention: Drive 1 = A and not Drive 0 = A
			which the original GetDriveType() uses!!!

	2)		works OK with CDRoms and RAMDisks, but I can't test on a
			network (as I'm not on one!) If you use it on a networked
			drive or a removable drive, let me know if it works!

	This code is released to the public domain!
################################################################### }

</i></font><font color="#FF0000"><b>unit </b></font>TestDrive<font color="#000080">;

</font><font color="#FF0000"><b>interface

</b></font><font color="#008000"><i>{$IFDEF WINDOWS}
</i></font><font color="#FF0000"><b>uses</b></font>	WinProcs<font color="#000080">, </font>WinDos<font color="#000080">, </font>Strings<font color="#000080">;

</font><font color="#008000"><i>{$ELSE}
</i></font><font color="#FF0000"><b>uses</b></font>	Dos<font color="#000080">, </font>Strings<font color="#000080">;

</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>const</b></font>	dt_NotFound		<font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;</font> 			<font color="#008000"><i>{ Not detected }
</i></font>		dt_Removable	<font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;        </font><font color="#008000"><i>{ Unknown removable type }
</i></font>		dt_HardDisk    <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;        </font><font color="#008000"><i>{ Standard hard disk }
</i></font>		dt_Networked	<font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;        </font><font color="#008000"><i>{ Remote drive on a network }
</i></font>		dt_CDRom		 	<font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;        </font><font color="#008000"><i>{ CD Rom drive }
</i></font>		dt_Floppy     	<font color="#000080">= </font><font color="#800000">5</font><font color="#000080">;        </font><font color="#008000"><i>{ Floppy drive }
</i></font>		dt_RAMDisk    	<font color="#000080">= </font><font color="#800000">6</font><font color="#000080">;        </font><font color="#008000"><i>{ RAM disk }

</i></font><font color="#FF0000"><b>type</b></font>	DeviceParams <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>			bSpecFunc	<font color="#000080">: </font>byte<font color="#000080">;</font>			<font color="#008000"><i>{ Special functions }
</i></font>			bDevType	<font color="#000080">: </font>byte<font color="#000080">;</font>				<font color="#008000"><i>{ Device type }
</i></font>			wDevAttr	<font color="#000080">: </font>word<font color="#000080">;</font>     		<font color="#008000"><i>{ Device attributes }
</i></font>			wCylinders	<font color="#000080">: </font>word<font color="#000080">;</font>			<font color="#008000"><i>{ Number of cylinders }
</i></font>			bMediaType	<font color="#000080">: </font>byte<font color="#000080">;</font>			<font color="#008000"><i>{ Media type }
</i></font>												<font color="#008000"><i>{ Beginning of BIOS parameter block (BPB) }
</i></font>			wBytesPerSec	<font color="#000080">: </font>word<font color="#000080">;</font>		<font color="#008000"><i>{ Bytes per sector }
</i></font>			bSecPerClust	<font color="#000080">: </font>byte<font color="#000080">;</font>		<font color="#008000"><i>{ Sectors per cluster }
</i></font>			wResSectors	<font color="#000080">: </font>word<font color="#000080">;</font>     	<font color="#008000"><i>{ Number of reserved sectors }
</i></font>			bFATs		<font color="#000080">: </font>byte<font color="#000080">;</font>        	<font color="#008000"><i>{ Number of FATs }
</i></font>			wRootDirEnts	<font color="#000080">: </font>word<font color="#000080">;</font>  	<font color="#008000"><i>{ Number of root-directory entries }
</i></font>			wSectors	<font color="#000080">: </font>word<font color="#000080">;</font>        	<font color="#008000"><i>{ Total number of sectors }
</i></font>			bMedia	<font color="#000080">: </font>byte<font color="#000080">;</font>        	<font color="#008000"><i>{ Media descriptor }
</i></font>			wFATsecs	<font color="#000080">: </font>word<font color="#000080">;</font>        	<font color="#008000"><i>{ Number of sectors per FAT }
</i></font>			wSecPerTrack	<font color="#000080">: </font>word<font color="#000080">;</font>  	<font color="#008000"><i>{ Number of sectors per track }
</i></font>			wHeads	<font color="#000080">: </font>word<font color="#000080">;</font>        	<font color="#008000"><i>{ Number of heads }
</i></font>			dwHiddenSecs	<font color="#000080">: </font>longint<font color="#000080">;  </font><font color="#008000"><i>{ Number of hidden sectors }
</i></font>			dwHugeSectors	<font color="#000080">: </font>longint<font color="#000080">;  </font><font color="#008000"><i>{ Number of sectors if wSectors == 0 }
</i></font>												<font color="#008000"><i>{ End of BIOS parameter block (BPB) }
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>GetDeviceParameters<font color="#000080">(</font>Drive <font color="#000080">: </font>word <font color="#000080">; </font><font color="#FF0000"><b>var </b></font>dp <font color="#000080">: </font>DeviceParams<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>GetDriveTypeEx<font color="#000080">(</font>D <font color="#000080">: </font>byte<font color="#000080">) : </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>IsCDRomDrive<font color="#000080">(</font>D <font color="#000080">: </font>Byte<font color="#000080">) : </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>implementation


function </b></font>GetDeviceParameters<font color="#000080">(</font>Drive <font color="#000080">: </font>word <font color="#000080">; </font><font color="#FF0000"><b>var </b></font>dp <font color="#000080">: </font>DeviceParams<font color="#000080">) : </font>boolean<font color="#000080">;

</font><font color="#008000"><i>{$IFDEF WINDOWS}
</i></font><font color="#FF0000"><b>var </b></font>Reg <font color="#000080">: </font>TRegisters<font color="#000080">;

</font><font color="#008000"><i>{$ELSE}
</i></font><font color="#FF0000"><b>var </b></font>Reg <font color="#000080">: </font>Registers<font color="#000080">;

</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>begin
</b></font>	FillChar<font color="#000080">(</font>Reg<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Reg<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);</font>			<font color="#008000"><i>{ clean up registers to avoid GPF }
</i></font>	Reg<font color="#000080">.</font>ax <font color="#000080">:= </font><font color="#800000">$440D</font><font color="#000080">;</font>								<font color="#008000"><i>{ IOCTL }
</i></font>	Reg<font color="#000080">.</font>ch <font color="#000080">:= </font><font color="#800000">$08</font><font color="#000080">;</font>									<font color="#008000"><i>{ block device }
</i></font>	Reg<font color="#000080">.</font>cl <font color="#000080">:= </font><font color="#800000">$60</font><font color="#000080">;</font>									<font color="#008000"><i>{ get device parameters }
</i></font>	Reg<font color="#000080">.</font>bx <font color="#000080">:= </font>Drive<font color="#000080">;</font>								<font color="#008000"><i>{ 1 = A:, 2 = B:, etc... }
</i></font>	Reg<font color="#000080">.</font>ds <font color="#000080">:= </font>seg<font color="#000080">(</font>dp<font color="#000080">);
</font>	Reg<font color="#000080">.</font>dx <font color="#000080">:= </font>ofs<font color="#000080">(</font>dp<font color="#000080">);
</font>	MSDos<font color="#000080">(</font>Reg<font color="#000080">);
</font>	GetDeviceParameters <font color="#000080">:= (</font>Reg<font color="#000080">.</font>flags <font color="#FF0000"><b>and </b></font>fCarry<font color="#000080">) = </font><font color="#800000">0
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>function </b></font>GetDriveTypeEx<font color="#000080">(</font>D <font color="#000080">: </font>byte<font color="#000080">) : </font>byte<font color="#000080">;

</font><font color="#008000"><i>{$IFNDEF WINDOWS}
</i></font><font color="#FF0000"><b>var</b></font>	Reg <font color="#000080">: </font>Registers<font color="#000080">;

</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>var   </b></font>Result<font color="#000080">, </font>uType <font color="#000080">: </font>byte<font color="#000080">;
</font>		dp	<font color="#000080">: </font>DeviceParams<font color="#000080">;

</font><font color="#FF0000"><b>begin
</b></font>	Result <font color="#000080">:= </font>dt_NotFound<font color="#000080">;
</font>	FillChar <font color="#000080">(</font>dp<font color="#000080">, </font>SizeOf<font color="#000080">(</font>dp<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);</font>	<font color="#008000"><i>{ clear the DPB }

{$IFDEF WINDOWS}
</i></font>	uType <font color="#000080">:= </font>GetDriveType<font color="#000080">(</font>D <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">);</font>		<font color="#008000"><i>{ make a rough guess }

{$ELSE}
</i></font>	uType <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font>	FillChar<font color="#000080">(</font>Reg<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Reg<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);
</font>	Reg<font color="#000080">.</font>ax <font color="#000080">:= </font><font color="#800000">$4408</font><font color="#000080">;</font>          					<font color="#008000"><i>{ IOCTL is drive changeable function }
</i></font>	Reg<font color="#000080">.</font>bl <font color="#000080">:= </font>D<font color="#000080">;
</font>	MSDos<font color="#000080">(</font>Reg<font color="#000080">);
</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">(</font>fCarry <font color="#FF0000"><b>and </b></font>Reg<font color="#000080">.</font>Flags<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
</b></font>	<font color="#008000"><i>{ error, check error code in ax }
</i></font>	<font color="#FF0000"><b>begin
</b></font>		<font color="#008000"><i>{ Driver does not support this call, so guess as a hard disk }
</i></font>		<font color="#FF0000"><b>if </b></font>Reg<font color="#000080">.</font>ax <font color="#000080">= </font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font>uType <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;
</font>	<font color="#FF0000"><b>end
</b></font>	<font color="#FF0000"><b>else
</b></font>	<font color="#FF0000"><b>begin
</b></font>		<font color="#FF0000"><b>if </b></font>Reg<font color="#000080">.</font>ax <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font>						<font color="#008000"><i>{ media changeable, floppy, WORM or MO }
</i></font>			uType <font color="#000080">:= </font><font color="#800000">2
</font>		<font color="#FF0000"><b>else</b></font>              						<font color="#008000"><i>{ else hard disk, ramdisk or CD-ROM }
</i></font>			uType <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;
</font>	<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	<font color="#008000"><i>{ check if drive is remote }
</i></font>	Reg<font color="#000080">.</font>ax <font color="#000080">:= </font><font color="#800000">$4409</font><font color="#000080">;</font>  							<font color="#008000"><i>{ IOCTL is redirected device function }
</i></font>	Reg<font color="#000080">.</font>bl <font color="#000080">:= </font>D<font color="#000080">;
</font>	MSDos<font color="#000080">(</font>Reg<font color="#000080">);
</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font><font color="#000080">((</font>fCarry <font color="#FF0000"><b>and </b></font>Reg<font color="#000080">.</font>Flags<font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Reg<font color="#000080">.</font>dx <font color="#000080">= </font><font color="#800000">$1000</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>uType <font color="#000080">:= </font><font color="#800000">4</font><font color="#000080">;

</font><font color="#008000"><i>{$ENDIF}
</i></font>	<font color="#FF0000"><b>case </b></font>uType <font color="#FF0000"><b>of
</b></font>		<font color="#800000">2 </font><font color="#000080">:</font>	<font color="#008000"><i>{ Removable }
</i></font>			<font color="#008000"><i>{	0=320/360kb floppy, 1=1.2Mb, 2=720kb, 3=8&quot; single density,
				4=8&quot; double density, 7=1.44Mb, 8=optical, 9=2.88Mb.}
</i></font>			<font color="#FF0000"><b>if </b></font>GetDeviceParameters<font color="#000080">(</font>D<font color="#000080">, </font>dp<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>dp<font color="#000080">.</font>bDevType <font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">7</font><font color="#000080">,</font><font color="#800000">9</font><font color="#000080">]) </font><font color="#FF0000"><b>then
</b></font>				Result <font color="#000080">:= </font>dt_Floppy
			<font color="#FF0000"><b>else
</b></font>				Result <font color="#000080">:= </font>dt_Removable<font color="#000080">;
</font>		<font color="#800000">3 </font><font color="#000080">:</font>	<font color="#008000"><i>{ Fixed }
</i></font>			<font color="#FF0000"><b>if </b></font>GetDeviceParameters<font color="#000080">(</font>D<font color="#000080">, </font>dp<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>dp<font color="#000080">.</font>bDevType <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>				Result <font color="#000080">:= </font>dt_HardDisk
			<font color="#FF0000"><b>else
</b></font>				Result <font color="#000080">:= </font>dt_RAMDisk<font color="#000080">;
</font>		<font color="#800000">4 </font><font color="#000080">:   </font><font color="#008000"><i>{ Remote }
</i></font>			<font color="#FF0000"><b>if </b></font>IsCDRomDrive<font color="#000080">(</font>D<font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>				Result <font color="#000080">:= </font>dt_CDRom
			<font color="#FF0000"><b>else
</b></font>				Result <font color="#000080">:= </font>dt_Networked<font color="#000080">;
</font>	<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	GetDriveTypeEx <font color="#000080">:= </font>Result<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Returns TRUE if Drive is a CD-ROM drive, FALSE if it isn't.}
</i></font><font color="#FF0000"><b>function </b></font>IsCDRomDrive<font color="#000080">(</font>D <font color="#000080">: </font>Byte<font color="#000080">) : </font>boolean<font color="#000080">;

</font><font color="#008000"><i>{$IFDEF WINDOWS}
</i></font><font color="#FF0000"><b>var </b></font>Reg <font color="#000080">: </font>TRegisters<font color="#000080">;

</font><font color="#008000"><i>{$ELSE}
</i></font><font color="#FF0000"><b>var </b></font>Reg <font color="#000080">: </font>Registers<font color="#000080">;

</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>begin
</b></font>	FillChar<font color="#000080">(</font>Reg<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Reg<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);
</font>	Reg<font color="#000080">.</font>ax <font color="#000080">:= </font><font color="#800000">$150B</font><font color="#000080">;</font>			<font color="#008000"><i>{ MSCDEX installation check }
</i></font>	Reg<font color="#000080">.</font>cx <font color="#000080">:= (</font>D <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">);</font>		<font color="#008000"><i>{ D: 1 = A:, 2 = B:, etc... }
</i></font>	Intr <font color="#000080">(</font><font color="#800000">$2F</font><font color="#000080">, </font>Reg<font color="#000080">);</font>			<font color="#008000"><i>{ do it }
</i></font>	IsCDRomDrive <font color="#000080">:= (</font>Reg<font color="#000080">.</font>bx <font color="#000080">= </font><font color="#800000">$ADAD</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Reg<font color="#000080">.</font>ax <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0103.PAS">Original</a><b>]</b></p></body>
</html>
