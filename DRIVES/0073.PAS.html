<html>
<head><title> "CD-ROM Dectection" by PAUL WEST</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 JM&gt;Would you happen to have any example code to determine if a drive is a
 JM&gt;hard disk, cd-rom, ramdrive etc. ?

Here is a unit that will at least tell you a little about the CD-ROM.   Not all
MSCDEX functions are implemented, but enough to identify the CD-ROMS.
}
</i></font><font color="#FF0000"><b>unit </b></font>CDROM<font color="#000080">;

</font><font color="#008000"><i>{$X+}   { Extended Syntax Rules }

</i></font><font color="#FF0000"><b>interface

type
  </b></font>CDR_DL_ENTRY <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>UNITNO  <font color="#000080">: </font>byte<font color="#000080">;
    </font>OFFSET  <font color="#000080">: </font>word<font color="#000080">;
    </font>SEGMENT <font color="#000080">: </font>word<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>CDR_DL_BUFFER   <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">26</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>CDR_DL_ENTRY<font color="#000080">;
  </font>CDR_DRIVE_UNITS <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">25</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>CDR_VTOC        <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2048</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;

</font><font color="#008000"><i>{ 00h } </i></font><font color="#FF0000"><b>procedure </b></font>CDR_GET_DRIVE_COUNT   <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>COUNT<font color="#000080">, </font>FIRST<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#008000"><i>{ 01h } </i></font><font color="#FF0000"><b>procedure </b></font>CDR_GET_DRIVE_LIST    <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>LIST<font color="#000080">: </font>CDR_DL_BUFFER<font color="#000080">);
</font><font color="#008000"><i>{ 02h } </i></font><font color="#FF0000"><b>function  </b></font>CDR_GET_COPR_NAME     <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#008000"><i>{ 03h } </i></font><font color="#FF0000"><b>function  </b></font>CDR_GET_ABSTRACT_NAME <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#008000"><i>{ 04h } </i></font><font color="#FF0000"><b>function  </b></font>CDR_GET_BIBLIO_NAME   <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#008000"><i>{ 05h Read VTOC }
{ 06h Reserved }
{ 07h Reserved }
{ 08h Absolute Disk Read }
{ 09h Absolute Disk Write }
{ 0ah Reserved }
{ 0bh } </i></font><font color="#FF0000"><b>function  </b></font>CDR_DRIVE_CHECK       <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ 0ch } </i></font><font color="#FF0000"><b>function  </b></font>CDR_VERSION<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#008000"><i>{ 0dh } </i></font><font color="#FF0000"><b>procedure </b></font>CDR_GET_DRIVE_UNITS   <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>BUFFER<font color="#000080">: </font>CDR_DRIVE_UNITS<font color="#000080">);
</font><font color="#008000"><i>{ 0eh Get or Set VDR }
{ 0fh Get Dir Entry }
{ 10h Send Device Request }

</i></font><font color="#FF0000"><b>implementation

uses </b></font>dos<font color="#000080">, </font>strings<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>CDROM_INTERRUPT <font color="#000080">= </font><font color="#800000">$2f</font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>REG <font color="#000080">: </font>registers<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>CDR_GET_DRIVE_COUNT <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>COUNT<font color="#000080">, </font>FIRST<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns the total number of CD-ROM Drives in the system }
{ and the logical drive number of the first drive.        }

{ In a system that contains multiple CD-ROM Drives and is }
{ also networked, the CD-ROM drives might not be assigned }
{ as consecutive logical units.  See also MSCDEX Function }
{ 0Dh (Get CD-ROM Drive Letters)                          }

</i></font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax, 1500h
  xor bx, bx
  int CDROM_INTERRUPT
  les di, COUNT
  mov es:[di], bx
  les di, FIRST
  mov es:[di], cx
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>CDR_GET_DRIVE_LIST <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>LIST<font color="#000080">: </font>CDR_DL_BUFFER<font color="#000080">);
</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns a driver unit identifier for each CD-ROM drive  }
{ in the system, along with the address of the header for }
{ the device driver that controls the drive.              }

{ The driver unit code returned in the buffer is not the  }
{ systemwide logical drive identifier but is the relative }
{ unit for that particular driver.  For example if three  }
{ CD-ROM drivers are installed, each supporting one phy-  }
{ sical drive, the driver unit code in each 5 byte entry  }
{ will be 0.  The systemwide drive identifiers for each   }
{ CD-ROM unit can be obtained with MSCDEX Function 0Dh    }
{ (Get CD-ROM Drive Letters).                             }

</i></font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax, 1501h
  les bx, LIST
  int CDROM_INTERRUPT
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function  </b></font>CDR_GET_COPR_NAME <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns the name of the copyright file from the volume  }
{ table of contents (VTOC) of the specified CD-ROM Drive. }

{ CD-ROM Specs allow for a 31 character filename followed }
{ by a semicolon (;) and a 5 digit version number.        }

{ On disks that comply with the High Sierra standard,     }
{ the filename has an MS-DOS compatable (8/3) format.     }

</i></font><font color="#FF0000"><b>var
  </b></font>BUFFER <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">38</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>REG<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">$1502</font><font color="#000080">;
  </font>REG<font color="#000080">.</font>CX <font color="#000080">:= </font>DRIVE<font color="#000080">;
  </font>REG<font color="#000080">.</font>ES <font color="#000080">:= </font>seg<font color="#000080">(</font>BUFFER<font color="#000080">);
  </font>REG<font color="#000080">.</font>BX <font color="#000080">:= </font>ofs<font color="#000080">(</font>BUFFER<font color="#000080">);
  </font>intr<font color="#000080">(</font>CDROM_INTERRUPT<font color="#000080">, </font>REG<font color="#000080">);
  </font>CDR_GET_COPR_NAME <font color="#000080">:= </font>strpas<font color="#000080">(</font>BUFFER<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function  </b></font>CDR_GET_ABSTRACT_NAME <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns the name of the abstract file from the volume   }
{ table of contents (VTOC) for the specified CD-ROM drive.}

{ CD-ROM Specs allow for a 31 character filename followed }
{ by a semicolon (;) and a 5 digit version number.        }

{ On disks that comply with the High Sierra standard,     }
{ the filename has an MS-DOS compatable (8/3) format.     }

</i></font><font color="#FF0000"><b>var
  </b></font>BUFFER <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">38</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>REG<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">$1503</font><font color="#000080">;
  </font>REG<font color="#000080">.</font>CX <font color="#000080">:= </font>DRIVE<font color="#000080">;
  </font>REG<font color="#000080">.</font>ES <font color="#000080">:= </font>seg<font color="#000080">(</font>BUFFER<font color="#000080">);
  </font>REG<font color="#000080">.</font>BX <font color="#000080">:= </font>ofs<font color="#000080">(</font>BUFFER<font color="#000080">);
  </font>intr<font color="#000080">(</font>CDROM_INTERRUPT<font color="#000080">, </font>REG<font color="#000080">);
  </font>CDR_GET_ABSTRACT_NAME <font color="#000080">:= </font>strpas<font color="#000080">(</font>BUFFER<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function  </b></font>CDR_GET_BIBLIO_NAME <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns the name if the bibliographic file from the     }
{ volume table of contents (VTOC) for the specified drive.}

{ CD-ROM Specs allow for a 31 character filename followed }
{ by a semicolon (;) and a 5 digit version number.        }

{ This function is provided for compatability with the    }
{ ISO-9660 standard.  A null string is returned for disks }
{ complying with the High Sierra standard.                }

</i></font><font color="#FF0000"><b>var
  </b></font>BUFFER <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">38</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>REG<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">$1504</font><font color="#000080">;
  </font>REG<font color="#000080">.</font>CX <font color="#000080">:= </font>DRIVE<font color="#000080">;
  </font>REG<font color="#000080">.</font>ES <font color="#000080">:= </font>seg<font color="#000080">(</font>BUFFER<font color="#000080">);
  </font>REG<font color="#000080">.</font>BX <font color="#000080">:= </font>ofs<font color="#000080">(</font>BUFFER<font color="#000080">);
  </font>intr<font color="#000080">(</font>CDROM_INTERRUPT<font color="#000080">, </font>REG<font color="#000080">);
  </font>CDR_GET_BIBLIO_NAME <font color="#000080">:= </font>strpas<font color="#000080">(</font>BUFFER<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>CDR_DRIVE_CHECK <font color="#000080">(</font>DRIVE<font color="#000080">: </font>byte<font color="#000080">): </font>boolean<font color="#000080">;

</font><font color="#008000"><i>{ Returns a code indicating whether a particular logical  }
{ unit is supported by the Microsoft CD-ROM Extensions    }
{ module (MSCDEX).                                        }

</i></font><font color="#FF0000"><b>begin
  </b></font>REG<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">$150b</font><font color="#000080">;
  </font>REG<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">$0000</font><font color="#000080">;
  </font>REG<font color="#000080">.</font>CX <font color="#000080">:= </font>DRIVE<font color="#000080">;
  </font>intr<font color="#000080">(</font>CDROM_INTERRUPT<font color="#000080">, </font>REG<font color="#000080">);
  </font>CDR_DRIVE_CHECK <font color="#000080">:= (</font>REG<font color="#000080">.</font>AX <font color="#000080">&lt;&gt; </font><font color="#800000">$0000</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>REG<font color="#000080">.</font>BX <font color="#000080">= </font><font color="#800000">$adad</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function  </b></font>CDR_VERSION<font color="#000080">: </font>word<font color="#000080">;

</font><font color="#008000"><i>{ Returns the version number of the Microsoft CD-ROM Extensions }

{ The Major Version number is returned in the High Order byte   }
{ and the Minor Version Number is returned in the Lo order      }
{ byte.  IE if the MSCDEX Version is 2.10, this routine will    }
{ return $0210.                                                 }

</i></font><font color="#FF0000"><b>begin
  </b></font>REG<font color="#000080">.</font>AX <font color="#000080">:= </font><font color="#800000">$150c</font><font color="#000080">;
  </font>REG<font color="#000080">.</font>BX <font color="#000080">:= </font><font color="#800000">$0000</font><font color="#000080">;
  </font>intr<font color="#000080">(</font>CDROM_INTERRUPT<font color="#000080">, </font>REG<font color="#000080">);

  </font><font color="#008000"><i>{ Version 1.0 Returns 0 instead of actual Version Number }
  { So we will fix it so that this routine returns 1.0     }

  </i></font><font color="#FF0000"><b>if </b></font>REG<font color="#000080">.</font>BX <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font>CDR_VERSION <font color="#000080">:= </font><font color="#800000">$0100</font><font color="#000080">;
  </font><font color="#FF0000"><b>end else begin
    </b></font>CDR_VERSION <font color="#000080">:= </font>REG<font color="#000080">.</font>BX<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>CDR_GET_DRIVE_UNITS<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>BUFFER<font color="#000080">: </font>CDR_DRIVE_UNITS<font color="#000080">);
</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns a list of the systemwide logical drive identifers     }
{ that are assigned to CD-ROM drives.                           }

{ Upon return the buffer contains a series of 1 byte entries.   }
{ Each entry is a logical unit code assigned to a CD-ROM drive  }
{ (0 = A, 1 = B, etc); the units might not be consecutive.      }

{ The number of valid entries can be determined by MSCDEX       }
{ function 00h.                                                 }

</i></font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax, 150dh
  les bx, BUFFER
  int CDROM_INTERRUPT
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p></body>
</html>
