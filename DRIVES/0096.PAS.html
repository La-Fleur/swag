<html>
<head><title> "IDE HDD Parameters?" by ARNE DE.BRUIJN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 RP&gt; Has anyone any ideas how to interrogate an IDE drive to get
 RP&gt; its setup parameters
}

{ Read IDE drive info, Arne de Bruijn, 1994, PD }
{ Information from 'Alles over PC Hardware' by Hans-Peter Messmer }

{$G+}
</i></font><font color="#FF0000"><b>uses </b></font>Crt<font color="#000080">,</font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>var
 </b></font>Buffer<font color="#000080">:</font>pointer<font color="#000080">;
</font><font color="#008000"><i>{ Buffer filled with following information (word offsets):
  0 configuration:
    bit 0 reserved
        1 1=hard-sector drive
        2 1=soft-sector drive
        3 1=RLL/ARLL format
        4 1=headswitchdelay is 15 ms
        5 1=less currency mode implented
        6 1=hard disk
        7 1=exchangable medium (mostly CD-ROM drive)
        8 1=internal datatransfer &lt;5 Mbit/s
        9 1=internal datatransfer between 5 and 10 Mbit/s
       10 1=internal datatransfer &gt;10 Mbit/s
       11 1=rotation speed toleration &gt;0,5% (notebook)
       12-15 reserved
  1 no of physical cylinders
  2 reserved
  3 no of heads
  4 no of not-formatted bytes per physical sector
  5 no of not-formatted bytes per sector
  6 no of physical sectors
  7-9 reserved for manufacturer
 10-19 ASCII serial number
 20 buffertype (01h one-directional, 02h bi-directional, 03h=cache buffer)
 21 buffersize/512
 22 no of ECC bytes transferred at read/writelong cmds
 23-26 ASCII controller-firmware ID
 27-46 ASCII modelnumber
 47 bit 0..7 no of sectors between two interrupts, bit 8..15 reserved
 48 bit 0: 1=32 bit-I/O, 0 no 32 bit-I/O, bit 1..7 reserved
 49 bit 0..7 reserved, bit 8: 1=DMA, 0=no DMA, bit 9: 1=LBA, 0=no LBA
 50 reserved
 51 bit 0..7 reserved, bit 8..15 PIO cyclus time
    (0=600ns, 1=380ns, 2=240ns, 3=180ns)
 52 bit 0..7 reserved, bit 8..15 DMA cyclus time
    (0=960ns, 1=380ns, 2=240ns, 3=150ns)
 53 reserved
 54 no of logical cylinders
 55 no of logical heads
 56 no of logical sectors per track
 57-58 Bytes per logical sector
 59 bit 0..7 no of sectors
 60-61 addressable sectors in LBA mode
 62 single DMA: bit 0..7=supported modes, bit 8..15=active modes
 63 multiple DMA: bit 0..7=supported modes, bit 8..15=active modes
 64-127 reserved
 128-159 manufacturer specific
 160-255 reserved
}
 </i></font>GotData<font color="#000080">:</font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>SwitchChars<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>X<font color="#000080">; </font>Len<font color="#000080">:</font>byte<font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Returns Len bytes from X, each word swapped }
</i></font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">push ds
 les di,@Result
 xor ah,ah
 mov al,Len
 mov cx,ax
 shl al,1
 stosb
 jcxz @NoCopy
 lds si,X
@Copy:
 lodsw
 xchg al,ah
 stosw
 loop @Copy
@NoCopy:
 pop ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>HDInt<font color="#000080">; </font>interrupt<font color="#000080">;
</font><font color="#008000"><i>{ Interrupt called when data is ready }
</i></font><font color="#FF0000"><b>begin
 if </b></font>Port<font color="#000080">[</font><font color="#800000">$1f7</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">8</font><font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
   asm
    </b></font><font color="#FF00FF">mov dx,1f0h
    les di,Buffer
    mov cx,256
    rep insw            </font><font color="#008000"><i>{ Get 256 words (512 bytes) }
   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>GotData<font color="#000080">:=</font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>Port<font color="#000080">[</font><font color="#800000">$a0</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;        </font><font color="#008000"><i>{ Send EOI to PIC 2 }
 </i></font>Port<font color="#000080">[</font><font color="#800000">$20</font><font color="#000080">]:=</font><font color="#800000">$20</font><font color="#000080">;        </font><font color="#008000"><i>{ Send EOI to PIC 1 }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>type
 </b></font>AWord<font color="#000080">=</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">32766</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
</font><font color="#FF0000"><b>var
 </b></font>Timer<font color="#000080">:</font>longint <font color="#FF0000"><b>absolute </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$6c</font><font color="#000080">;
 </font>Slave<font color="#000080">:</font>boolean<font color="#000080">;
 </font>LastTimer<font color="#000080">,</font>T<font color="#000080">:</font>byte<font color="#000080">;
 </font>OldInt<font color="#000080">:</font>pointer<font color="#000080">;
 </font>OldPic1M<font color="#000080">,</font>OldPic2M<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>Clrscr<font color="#000080">;
 </font>Slave<font color="#000080">:=</font>false<font color="#000080">; </font><font color="#008000"><i>{ True is check for slave, false check for master }
 </i></font>GetMem<font color="#000080">(</font>Buffer<font color="#000080">,</font><font color="#800000">512</font><font color="#000080">);
 </font>T<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">;         </font><font color="#008000"><i>{ Wait 2 clock ticks }
 </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>Port<font color="#000080">[</font><font color="#800000">$1f7</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$c0</font><font color="#000080">&lt;&gt;</font><font color="#800000">$40</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>T<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do
  if </b></font>byte<font color="#000080">(</font>Timer<font color="#000080">)&lt;&gt;</font>LastTimer <font color="#FF0000"><b>then begin </b></font>Dec<font color="#000080">(</font>T<font color="#000080">); </font>LastTimer<font color="#000080">:=</font>byte<font color="#000080">(</font>Timer<font color="#000080">); </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>if </b></font>Port<font color="#000080">[</font><font color="#800000">$1f7</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$c0</font><font color="#000080">&lt;&gt;</font><font color="#800000">$40 </font><font color="#FF0000"><b>then
  begin
   </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Timeout 1!'</font><font color="#000080">);
   </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>GetIntVec<font color="#000080">(</font><font color="#800000">$76</font><font color="#000080">,</font>OldInt<font color="#000080">);   </font><font color="#008000"><i>{ Set interrupt (IRQ 14 = int $76) }
 </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$76</font><font color="#000080">,@</font>HDInt<font color="#000080">);
 </font>OldPic1M<font color="#000080">:=</font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]; </font>OldPic2M<font color="#000080">:=</font>Port<font color="#000080">[</font><font color="#800000">$a1</font><font color="#000080">]; </font><font color="#008000"><i>{ Save PIC masks }
 </i></font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>OldPic1M <font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font><font color="#800000">4</font><font color="#000080">);   </font><font color="#008000"><i>{ Enable IRQ 14 }
 </i></font>Port<font color="#000080">[</font><font color="#800000">$a1</font><font color="#000080">]:=</font>OldPic2M <font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font><font color="#800000">64</font><font color="#000080">);
 </font>GotData<font color="#000080">:=</font>false<font color="#000080">;
 </font>Port<font color="#000080">[</font><font color="#800000">$1f6</font><font color="#000080">]:=</font><font color="#800000">$a0</font><font color="#000080">+</font>byte<font color="#000080">(</font>Slave<font color="#000080">)*</font><font color="#800000">16</font><font color="#000080">;    </font><font color="#008000"><i>{ Send drive no }
 </i></font>Port<font color="#000080">[</font><font color="#800000">$1f7</font><font color="#000080">]:=</font><font color="#800000">$EC</font><font color="#000080">;                   </font><font color="#008000"><i>{ Send command code }
 </i></font>T<font color="#000080">:=</font><font color="#800000">3</font><font color="#000080">;
 </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>GotData<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>T<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do
  if </b></font>byte<font color="#000080">(</font>Timer<font color="#000080">)&lt;&gt;</font>LastTimer <font color="#FF0000"><b>then begin </b></font>Dec<font color="#000080">(</font>T<font color="#000080">); </font>LastTimer<font color="#000080">:=</font>byte<font color="#000080">(</font>Timer<font color="#000080">); </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>Port<font color="#000080">[</font><font color="#800000">$21</font><font color="#000080">]:=</font>OldPic1M<font color="#000080">; </font>Port<font color="#000080">[</font><font color="#800000">$a1</font><font color="#000080">]:=</font>OldPic2M<font color="#000080">; </font><font color="#008000"><i>{ Restore PIC masks }
 </i></font>SetIntVec<font color="#000080">(</font><font color="#800000">$76</font><font color="#000080">,</font>OldInt<font color="#000080">);   </font><font color="#008000"><i>{ Restore interrupt }
 </i></font><font color="#FF0000"><b>if not </b></font>GotData <font color="#FF0000"><b>then
  begin
   </b></font>WriteLn<font color="#000080">(</font><font color="#800000">'Timeout 2!'</font><font color="#000080">);
   </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>WriteLn<font color="#000080">(</font><font color="#800000">'Heads:'</font><font color="#000080">,</font>AWord<font color="#000080">(</font>Buffer<font color="#000080">^)[</font><font color="#800000">3</font><font color="#000080">],</font><font color="#800000">' Cylinders:'</font><font color="#000080">,</font>AWord<font color="#000080">(</font>Buffer<font color="#000080">^)[</font><font color="#800000">1</font><font color="#000080">],
  </font><font color="#800000">' Sectors:'</font><font color="#000080">,</font>AWord<font color="#000080">(</font>Buffer<font color="#000080">^)[</font><font color="#800000">6</font><font color="#000080">]);
 </font>WriteLn<font color="#000080">(</font><font color="#800000">'Serial number:'</font><font color="#000080">,</font>SwitchChars<font color="#000080">(</font>AWord<font color="#000080">(</font>Buffer<font color="#000080">^)[</font><font color="#800000">10</font><font color="#000080">],</font><font color="#800000">10</font><font color="#000080">));
 </font>WriteLn<font color="#000080">(</font><font color="#800000">'Controller firmware ID:'</font><font color="#000080">,</font>SwitchChars<font color="#000080">(</font>AWord<font color="#000080">(</font>Buffer<font color="#000080">^)[</font><font color="#800000">23</font><font color="#000080">],</font><font color="#800000">4</font><font color="#000080">));
 </font>WriteLn<font color="#000080">(</font><font color="#800000">'Modelnumber:'</font><font color="#000080">,</font>SwitchChars<font color="#000080">(</font>AWord<font color="#000080">(</font>Buffer<font color="#000080">^)[</font><font color="#800000">27</font><font color="#000080">],</font><font color="#800000">20</font><font color="#000080">));
 </font>Port<font color="#000080">[</font><font color="#800000">$1F6</font><font color="#000080">]:=</font><font color="#800000">$a0</font><font color="#000080">+</font>byte<font color="#000080">(</font>Slave<font color="#000080">)*</font><font color="#800000">16</font><font color="#000080">;
 </font>FreeMem<font color="#000080">(</font>Buffer<font color="#000080">,</font><font color="#800000">512</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p></body>
</html>
