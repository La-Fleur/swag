<html>
<head><title> "Reading Boot Sectors" by SELOM OFORI</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0110.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{please use only on floppy.
 It reads sector 0 which is the boot sector for a floppy and
 the partition table for a hard disk.
 It never writes to disk anyways....
}
</i></font><font color="#FF0000"><b>program </b></font>readboot<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">, </font>crt<font color="#000080">;
</font><font color="#FF0000"><b>type
 </b></font>boot_structure <font color="#000080">= </font><font color="#FF0000"><b>record
  </b></font>jmp_instruction <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>oem_name <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>bytes_per_sector <font color="#000080">: </font>word<font color="#000080">;
  </font>sectors_per_cluster <font color="#000080">: </font>byte<font color="#000080">;
  </font>reserved_sectors <font color="#000080">: </font>word<font color="#000080">;
  </font>fat_copies <font color="#000080">: </font>byte<font color="#000080">;
  </font>root_entries <font color="#000080">: </font>word<font color="#000080">;
  </font>total_sectors <font color="#000080">: </font>word<font color="#000080">;
  </font>media_descriptor <font color="#000080">: </font>byte<font color="#000080">;
  </font>sectors_per_fat <font color="#000080">: </font>word<font color="#000080">;
  </font>sectors_per_track <font color="#000080">: </font>word<font color="#000080">;
  </font>number_of_heads <font color="#000080">: </font>word<font color="#000080">;
  </font>hidden_sectors <font color="#000080">: </font>word<font color="#000080">;
  </font>total_sector_fixed <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
  </font>drive_number <font color="#000080">: </font>byte<font color="#000080">;
  </font>reserved <font color="#000080">: </font>byte<font color="#000080">;
  </font>ext_boot_sig <font color="#000080">: </font>byte<font color="#000080">;
  </font>serial_number <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
  </font>volume_name <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">11</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>file_system_id <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>boot_program_code <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">450</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>signature_bytes <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
 </b></font>bootbuf <font color="#000080">: </font>boot_structure<font color="#000080">;
 </font>ch <font color="#000080">: </font>char<font color="#000080">;
 </font>arg <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
 </font>drive <font color="#000080">: </font>byte<font color="#000080">;
 </font>result <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#008000"><i>{ for this procedure..  its in ASM ( doesn't make it any faster.. :)  )
  VAR BUF can either be an array, pointer or record
  DRIVE is the drive number ( A=0, B=1 etc )
  NUMBER is the number of sectors to read
  LOGICAL is the sector to which to start reading
}
</i></font><font color="#FF0000"><b>procedure </b></font>absread<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>buf<font color="#000080">; </font>drive <font color="#000080">: </font>byte<font color="#000080">;
     </font>number<font color="#000080">, </font>logical <font color="#000080">: </font>word <font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">push bp
 push ds
 xor ax,ax
 mov result,ax
 mov al,drive
 mov cx,number
 mov dx,logical
 lds bx,buf
 int 25h       </font><font color="#008000"><i>{ you can change to 26h to write to disk }
 </i></font><font color="#FF00FF">pop bx
 pop ds
 pop bp
 jnb @1
 mov result,ax
     @1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>commandline_help<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>writeln<font color="#000080">(</font><font color="#800000">'Usage: Readboot &lt; drive &gt; '</font><font color="#000080">);
 </font>halt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>commandline<font color="#000080">;
</font><font color="#FF0000"><b>var     </b></font>regs <font color="#000080">: </font>registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
 case </b></font>paramcount <font color="#FF0000"><b>of
 </b></font><font color="#800000">1 </font><font color="#000080">: </font><font color="#FF0000"><b>begin
  </b></font>arg <font color="#000080">:= </font>paramstr<font color="#000080">( </font><font color="#800000">1 </font><font color="#000080">);
  </font>ch <font color="#000080">:= </font>arg<font color="#000080">[ </font><font color="#800000">1 </font><font color="#000080">];
  </font>ch <font color="#000080">:= </font>upcase<font color="#000080">( </font>ch <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ch <font color="#FF0000"><b>in </b></font><font color="#000080">[ </font><font color="#800000">#65</font><font color="#000080">..</font><font color="#800000">#90 </font><font color="#000080">] </font><font color="#FF0000"><b>then </b></font>drive <font color="#000080">:= </font>ord<font color="#000080">( </font>ch <font color="#000080">) - </font><font color="#800000">65</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$36</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>DL <font color="#000080">:= </font>drive <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>msdos<font color="#000080">( </font>regs <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">$FFFF </font><font color="#FF0000"><b>then
   begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Drive '</font><font color="#000080">, </font>ch<font color="#000080">, </font><font color="#800000">':\ does not exist!'</font><font color="#000080">);
    </font>halt<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>else    </b></font>commandline_help<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>display_boot<font color="#000080">;
</font><font color="#FF0000"><b>begin
 with </b></font>bootbuf <font color="#FF0000"><b>do
 begin
  </b></font>write<font color="#000080">(</font><font color="#800000">'OEM Name......... : '</font><font color="#000080">:</font><font color="#800000">30 </font><font color="#000080">);
  </font>highvideo<font color="#000080">; </font>writeln<font color="#000080">( </font>oem_name <font color="#000080">); </font>normvideo<font color="#000080">;
  </font>write<font color="#000080">(</font><font color="#800000">'Bytes Per Sector. : '</font><font color="#000080">:</font><font color="#800000">30 </font><font color="#000080">);
  </font>highvideo<font color="#000080">; </font>writeln<font color="#000080">( </font>bytes_per_sector <font color="#000080">); </font>normvideo<font color="#000080">;
  </font><font color="#008000"><i>{ etc, etc.... }
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
 </b></font>commandline<font color="#000080">;
 </font>absread<font color="#000080">( </font>bootbuf<font color="#000080">, </font>drive<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">0 </font><font color="#000080">);
 </font>display_boot<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>Here<font color="#800000">'s the structure of the boot sector

</font><font color="#008000"><i>{ DOS Volume Boot Sector Format [DVB]
  Offset        Size            Description
   00h          3 BYTEs         jump instruction to boot program code
   03h          8 BYTEs         OEM name and DOS version (&quot;IBM 4.0&quot;)
   0Bh          1 WORD          bytes per sector( usually 512 )
   0Dh          1 BYTE          sectors per cluster( must be power of 2 )
   0Eh          1 WORD          reserved sectors( boot sectors - usually 1 )
   10h          1 BYTE          FAT copies ( usually 2 )
   11h          1 WORD          maximum root diretory entries ( usually 512 )
   13h          1 WORD          total sectors( if partition &lt;= 32M, else 0 )
   15h          1 BYTE          media descriptor byte ( F8h for hard disks )
   16h          1 WORD          sectors per FAT
   18h          1 WORD          sectors per track
   1Ah          1 WORD          number of heads
   1Ch          1 DWORD         hidden sectors(if partition &lt;= 32M,
      1 word only)

The following information is for DOS 4.0 and later version else 00h:
   20h          1 DWORD         total sectos( if partition &gt; 32M, else 0 )
   24h          1 BYTE          physical drive number (00h=floppy, 80h=fixed)
   25h          1 BYTE          reserved( 00h )
   26h          1 BYTE          extended boot record signature( 29h )

   27h          1 DWORD         volume serial number
   2Bh          11 BYTEs        volume label(&quot;NO NAME  &quot; stored if no label)
   36h          8 BYTEs         file system ID (&quot;FAT12  &quot; or &quot;FAT16  &quot;)

The following information applies to all DOS versions:
   3Eh          450 BYTEs       Boot program code
   1FEh         2 BYTEs         signature bytes ( 55AAh )
}

</i></font>please use only <font color="#FF0000"><b>on </b></font>floppy<font color="#000080">.
</font>It reads sector <font color="#800000">0 </font>which <font color="#FF0000"><b>is </b></font>the boot sector <font color="#FF0000"><b>for </b></font>a floppy <font color="#FF0000"><b>and
</b></font>the partition table <font color="#FF0000"><b>for </b></font>a hard disk<font color="#000080">.
</font>It never writes <font color="#FF0000"><b>to </b></font>disk anyways<font color="#000080">....
</font>It will read the boot sector from a floppy <font color="#FF0000"><b>and </b></font>display it<font color="#000080">.

</font>___<font color="#000080">------------------&lt; </font>Cut here <font color="#000080">&gt;-----------------------------------------
</font><font color="#FF0000"><b>program </b></font>readboot<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">, </font>crt<font color="#000080">;
</font><font color="#FF0000"><b>type
 </b></font>boot_structure <font color="#000080">= </font><font color="#FF0000"><b>record
  </b></font>jmp_instruction <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>oem_name <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>bytes_per_sector <font color="#000080">: </font>word<font color="#000080">;
  </font>sectors_per_cluster <font color="#000080">: </font>byte<font color="#000080">;
  </font>reserved_sectors <font color="#000080">: </font>word<font color="#000080">;
  </font>fat_copies <font color="#000080">: </font>byte<font color="#000080">;
  </font>root_entries <font color="#000080">: </font>word<font color="#000080">;
  </font>total_sectors <font color="#000080">: </font>word<font color="#000080">;
  </font>media_descriptor <font color="#000080">: </font>byte<font color="#000080">;
  </font>sectors_per_fat <font color="#000080">: </font>word<font color="#000080">;
  </font>sectors_per_track <font color="#000080">: </font>word<font color="#000080">;
  </font>number_of_heads <font color="#000080">: </font>word<font color="#000080">;
  </font>hidden_sectors <font color="#000080">: </font>word<font color="#000080">;
  </font>total_sector_fixed <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
  </font>drive_number <font color="#000080">: </font>byte<font color="#000080">;
  </font>reserved <font color="#000080">: </font>byte<font color="#000080">;
  </font>ext_boot_sig <font color="#000080">: </font>byte<font color="#000080">;
  </font>serial_number <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;
  </font>volume_name <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">11</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>file_system_id <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>boot_program_code <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">450</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>signature_bytes <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
 </b></font>bootbuf <font color="#000080">: </font>boot_structure<font color="#000080">;
 </font>ch <font color="#000080">: </font>char<font color="#000080">;
 </font>arg <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
 </font>drive <font color="#000080">: </font>byte<font color="#000080">;
 </font>result <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#008000"><i>{ for this procedure..  its in ASM ( doesn't make it any faster.. :)  )
  VAR BUF can either be an array, pointer or record
  DRIVE is the drive number ( A=0, B=1 etc )
  NUMBER is the number of sectors to read
  LOGICAL is the sector to which to start reading
}
</i></font><font color="#FF0000"><b>procedure </b></font>absread<font color="#000080">( </font><font color="#FF0000"><b>var </b></font>buf<font color="#000080">; </font>drive <font color="#000080">: </font>byte<font color="#000080">;
     </font>number<font color="#000080">, </font>logical <font color="#000080">: </font>word <font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
 </b></font><font color="#FF00FF">push bp
 push ds
 xor ax,ax
 mov result,ax
 mov al,drive
 mov cx,number
 mov dx,logical
 lds bx,buf
 int 25h       </font><font color="#008000"><i>{ you can change to 26h to write to disk }
 </i></font><font color="#FF00FF">pop bx
 pop ds
 pop bp
 jnb @1
 mov result,ax
     @1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>commandline_help<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>writeln<font color="#000080">(</font><font color="#800000">'Usage: Readboot &lt; drive &gt; '</font><font color="#000080">);
 </font>halt<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>commandline<font color="#000080">;
</font><font color="#FF0000"><b>var     </b></font>regs <font color="#000080">: </font>registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
 case </b></font>paramcount <font color="#FF0000"><b>of
 </b></font><font color="#800000">1 </font><font color="#000080">: </font><font color="#FF0000"><b>begin
  </b></font>arg <font color="#000080">:= </font>paramstr<font color="#000080">( </font><font color="#800000">1 </font><font color="#000080">);
  </font>ch <font color="#000080">:= </font>arg<font color="#000080">[ </font><font color="#800000">1 </font><font color="#000080">];
  </font>ch <font color="#000080">:= </font>upcase<font color="#000080">( </font>ch <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>ch <font color="#FF0000"><b>in </b></font><font color="#000080">[ </font><font color="#800000">#65</font><font color="#000080">..</font><font color="#800000">#90 </font><font color="#000080">] </font><font color="#FF0000"><b>then </b></font>drive <font color="#000080">:= </font>ord<font color="#000080">( </font>ch <font color="#000080">) - </font><font color="#800000">65</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$36</font><font color="#000080">;
  </font>regs<font color="#000080">.</font>DL <font color="#000080">:= </font>drive <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;
  </font>msdos<font color="#000080">( </font>regs <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>regs<font color="#000080">.</font>AX <font color="#000080">= </font><font color="#800000">$FFFF </font><font color="#FF0000"><b>then
   begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'Drive '</font><font color="#000080">, </font>ch<font color="#000080">, </font><font color="#800000">':\ does not exist!'</font><font color="#000080">);
    </font>halt<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>else    </b></font>commandline_help<font color="#000080">;
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>display_boot<font color="#000080">;
</font><font color="#FF0000"><b>begin
 with </b></font>bootbuf <font color="#FF0000"><b>do
 begin
  </b></font>write<font color="#000080">(</font><font color="#800000">'OEM Name......... : '</font><font color="#000080">:</font><font color="#800000">30 </font><font color="#000080">);
  </font>highvideo<font color="#000080">; </font>writeln<font color="#000080">( </font>oem_name <font color="#000080">); </font>normvideo<font color="#000080">;
  </font>write<font color="#000080">(</font><font color="#800000">'Bytes Per Sector. : '</font><font color="#000080">:</font><font color="#800000">30 </font><font color="#000080">);
  </font>highvideo<font color="#000080">; </font>writeln<font color="#000080">( </font>bytes_per_sector <font color="#000080">); </font>normvideo<font color="#000080">;
  </font><font color="#008000"><i>{ etc, etc.... }
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
 </b></font>commandline<font color="#000080">;
 </font>absread<font color="#000080">( </font>bootbuf<font color="#000080">, </font>drive<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">0 </font><font color="#000080">);
 </font>display_boot<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0110.PAS">Original</a><b>]</b></p></body>
</html>
