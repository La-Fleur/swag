<html>
<head><title> "Media ID" by MICHAEL PHILLIPS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0060.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Can someone please post some code on how to read a disk label/serial
&gt; number from a disk. I plan to use it as a copy protection method (read
&gt; the label/serial number on installation and only the program to install
&gt; on a drive the same label/serial number) Thanks!

Do you realise that the serial number on a disk is changed when the disk is
formatted?  Therefore if someone crashes their system and has to format their
hard disk and restore your software from their backups your protection method
would be triggered!  Not a very good method to use for copy protection.
}
</i></font><font color="#FF0000"><b>Program     </b></font>MediaID<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>Tmid <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>midInfoLevel   <font color="#000080">: </font>Word<font color="#000080">;                        </font><font color="#008000"><i>{ information level ? }
    </i></font>midSerialNum   <font color="#000080">: </font>LongInt<font color="#000080">;                           </font><font color="#008000"><i>{ serial number }
    </i></font>midVolLabel    <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">11</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">; </font><font color="#008000"><i>{ ASCII volume label }
    </i></font>midFileSysType <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;   </font><font color="#008000"><i>{ ASCII file system }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{ of Tmid }

</i></font><font color="#FF0000"><b>Var
  </b></font>MID <font color="#000080">: </font>Tmid<font color="#000080">;
  </font>DriveChar <font color="#000080">: </font>Char<font color="#000080">;
  </font>DriveNum <font color="#000080">: </font>Word<font color="#000080">;
  </font>DirInfo <font color="#000080">: </font>SearchRec<font color="#000080">;
  </font>Volume <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>Function    </b></font>Hex4<font color="#000080">(</font>w <font color="#000080">: </font>Word<font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>const
    </b></font>HexStr <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">$00</font><font color="#000080">..</font><font color="#800000">$0F</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char <font color="#000080">= </font><font color="#800000">'0123456789ABCDEF'</font><font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font>ndx <font color="#000080">: </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin  </b></font><font color="#008000"><i>{ of Hex4 }
    </i></font>s <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
    </font><font color="#FF0000"><b>for </b></font>ndx <font color="#000080">:= </font><font color="#800000">3 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do
      begin
        </b></font>s <font color="#000080">:= </font>s <font color="#000080">+ </font>HexStr<font color="#000080">[(</font>W <font color="#FF0000"><b>shr </b></font><font color="#000080">(</font>ndx<font color="#000080">*</font><font color="#800000">4</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">];
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>Hex4 <font color="#000080">:= </font>s<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{ of Hex4 }

  </i></font><font color="#FF0000"><b>Function    </b></font>GetMediaID<font color="#000080">(</font>Drive <font color="#000080">: </font>Word<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{---------------------------------------------------------------------}
  {    This routine reads the VolumeLabel, SerialNumber from the boot   }
  {  sector of the specified drive.  Requires MSDOS5 or above.          }
  {---------------------------------------------------------------------}
  </i></font><font color="#FF0000"><b>begin  </b></font><font color="#008000"><i>{ of GetMediaID }
    </i></font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov   bx, Drive                       </font><font color="#008000"><i>{ 0=default, 1=A:, 2=B: etc }
      </i></font><font color="#FF00FF">mov   ch, 08h                     </font><font color="#008000"><i>{ device category (must be 08h) }
      </i></font><font color="#FF00FF">mov   cl, 66h                                      </font><font color="#008000"><i>{ Get Media ID }
      </i></font><font color="#FF00FF">mov   dx, seg MID                </font><font color="#008000"><i>{ ds:dx pointer to MID structure }
      </i></font><font color="#FF00FF">mov   ds, dx
      mov   dx, offset MID
      mov   ax, 440Dh                          </font><font color="#008000"><i>{ IOCTL for block device }
      </i></font><font color="#FF00FF">int   21h
      jc    @1                      </font><font color="#008000"><i>{ carry is set if there is an error }
      </i></font><font color="#FF00FF">mov   ax, 0000h                             </font><font color="#008000"><i>{ no error - clear ax }
    </i></font><font color="#FF00FF">@1:
      mov   @result, ax                             </font><font color="#008000"><i>{ return error code }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{ of GetMediaID }

  </i></font><font color="#FF0000"><b>Function    </b></font>VolumeLabel<font color="#000080">(</font>Drive <font color="#000080">: </font>Char<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>VolLabel <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{---------------------------------------------------------------------}
  {    This routine reads the VolumeLabel from the root directory of    }
  {  the specified drive.                                               }
  {---------------------------------------------------------------------}
  </i></font><font color="#FF0000"><b>begin  </b></font><font color="#008000"><i>{ of VolLabel }
    </i></font>FindFirst<font color="#000080">(</font>Drive<font color="#000080">+</font><font color="#800000">':\*.*'</font><font color="#000080">, </font>VolumeID<font color="#000080">, </font>DirInfo<font color="#000080">);
    </font>VolumeLabel <font color="#000080">:= </font>DosError<font color="#000080">;
    </font>VolLabel <font color="#000080">:= </font>DirInfo<font color="#000080">.</font>Name<font color="#000080">;
    </font><font color="#008000"><i>{ delete a &quot;.&quot; which would be the 9th character }
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Length<font color="#000080">(</font>VolLabel<font color="#000080">) &gt; </font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Delete<font color="#000080">(</font>VolLabel<font color="#000080">, </font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{ of VolLabel }

</i></font><font color="#FF0000"><b>begin  </b></font><font color="#008000"><i>{ of MediaID }

  </i></font>DriveChar <font color="#000080">:= </font><font color="#800000">'C'</font><font color="#000080">;
  </font>DriveNum <font color="#000080">:= </font>ord<font color="#000080">(</font>DriveChar<font color="#000080">) - </font><font color="#800000">64</font><font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>GetMediaID<font color="#000080">(</font>DriveNum<font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>Writeln<font color="#000080">(</font>output<font color="#000080">, </font><font color="#800000">'InfoLevel = '</font><font color="#000080">, </font>MID<font color="#000080">.</font>midInfoLevel<font color="#000080">);
      </font>Writeln<font color="#000080">(</font>output<font color="#000080">, </font><font color="#800000">'SerialNum = '</font><font color="#000080">,
        </font>Hex4<font color="#000080">((</font>MID<font color="#000080">.</font>midSerialNum <font color="#FF0000"><b>shr </b></font><font color="#800000">$10</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$FFFF</font><font color="#000080">), </font><font color="#800000">'-'</font><font color="#000080">,
        </font>Hex4<font color="#000080">(</font>MID<font color="#000080">.</font>midSerialNum <font color="#FF0000"><b>and </b></font><font color="#800000">$FFFF</font><font color="#000080">));
      </font>Writeln<font color="#000080">(</font>output<font color="#000080">, </font><font color="#800000">'VolLabel    = &quot;'</font><font color="#000080">, </font>MID<font color="#000080">.</font>midVolLabel<font color="#000080">, </font><font color="#800000">'&quot;'</font><font color="#000080">);
      </font>Writeln<font color="#000080">(</font>output<font color="#000080">, </font><font color="#800000">'FileSysType = &quot;'</font><font color="#000080">, </font>MID<font color="#000080">.</font>midFileSysType<font color="#000080">, </font><font color="#800000">'&quot;'</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
  else
    begin
      </b></font><font color="#008000"><i>{ function not supported or error }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>Writeln<font color="#000080">(</font>output<font color="#000080">);

  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>VolumeLabel<font color="#000080">(</font>DriveChar<font color="#000080">, </font>Volume<font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font>Writeln<font color="#000080">(</font>output<font color="#000080">, </font><font color="#800000">'VolLabel    = &quot;'</font><font color="#000080">, </font>Volume<font color="#000080">, </font><font color="#800000">'&quot;'</font><font color="#000080">)
  </font><font color="#FF0000"><b>else
    begin
      </b></font><font color="#008000"><i>{ error }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.   </font><font color="#008000"><i>{ of MediaID }
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0060.PAS">Original</a><b>]</b></p></body>
</html>
