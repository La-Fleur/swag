<html>
<head><title> "Boot Sectors and MBR's" by CAREY W. STARZINGER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0099.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; Has anyone any ideas how to interrogate an IDE drive to get
&gt; its setup parameters, ie. number of cylinders, heads and
&gt; sectors, as  some of the more recent BIOS's seem to be able to do?

Read cylinder 0, head 0, sector 1 which is the first sector on the
hard drive.  This sector contains the partition table.  The partition table
contains this information.  This could be done faster in ASM code but for the
interests of the purists in this echo, I will use the registers and set it up
in Pascal.  This example was used in a large program that did many other
things and that is why there is no parameter passing to the procedure and the
device is global. Sample Code to read the partition table:
}

</i></font><font color="#FF0000"><b>Uses </b></font>CRT<font color="#000080">, </font>DOS<font color="#000080">;

</font><font color="#FF0000"><b>var

   </b></font>buffermbr <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[ </font><font color="#800000">0 </font><font color="#000080">.. </font><font color="#800000">512 </font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;  </font><font color="#008000"><i>{ Buffer for Master Boot Record }
   </i></font>regs      <font color="#000080">: </font>registers<font color="#000080">;   </font><font color="#008000"><i>{ Predefined data type }
   </i></font>device    <font color="#000080">: </font>word<font color="#000080">;
   </font>s         <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>readpart<font color="#000080">;

</font><font color="#FF0000"><b>begin
     with </b></font>regs <font color="#FF0000"><b>do
     begin
          </b></font>ah <font color="#000080">:= </font><font color="#800000">$02</font><font color="#000080">;  </font><font color="#008000"><i>{ Read sector service request }
          </i></font>al <font color="#000080">:= </font><font color="#800000">$01</font><font color="#000080">;  </font><font color="#008000"><i>{ Number of sectors to read }
          </i></font>ch <font color="#000080">:= </font><font color="#800000">$00</font><font color="#000080">;  </font><font color="#008000"><i>{ Cylinder number or track number for floppies }
          </i></font>cl <font color="#000080">:= </font><font color="#800000">$01</font><font color="#000080">;  </font><font color="#008000"><i>{ Sector Number, bits 6,7 -two high bits of 10 bit
                        cylinder number }
          </i></font>dh <font color="#000080">:= </font><font color="#800000">$00</font><font color="#000080">;  </font><font color="#008000"><i>{ Head Number }
          </i></font>dl <font color="#000080">:= </font>device<font color="#000080">; </font><font color="#008000"><i>{ Specifies which drive C=80h, D=81H, etc }
          </i></font>es <font color="#000080">:= </font>seg<font color="#000080">( </font>buffermbr <font color="#000080">);
          </font>bx <font color="#000080">:= </font>ofs<font color="#000080">( </font>buffermbr <font color="#000080">);
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
             </font>intr<font color="#000080">( </font><font color="#800000">$13</font><font color="#000080">, </font>regs <font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ The below main body has been stripped of the code to verify the number of
parameters that were entered as well as the validity of the parameter string
entered ( 'c', 'd', etc. ).  }
</i></font><font color="#FF0000"><b>begin
   </b></font>clrscr<font color="#000080">;
   </font>s <font color="#000080">:= </font>paramstr<font color="#000080">( </font><font color="#800000">1 </font><font color="#000080">);
   </font>s<font color="#000080">[ </font><font color="#800000">1 </font><font color="#000080">] := </font>upcase<font color="#000080">( </font>s<font color="#000080">[ </font><font color="#800000">1 </font><font color="#000080">] );
   </font><font color="#FF0000"><b>if </b></font>s<font color="#000080">[ </font><font color="#800000">1 </font><font color="#000080">] = </font><font color="#800000">'C' </font><font color="#FF0000"><b>then
     begin
        </b></font>device <font color="#000080">:= </font><font color="#800000">$80</font><font color="#000080">;
     </font><font color="#FF0000"><b>end
   else
     begin
        </b></font>device <font color="#000080">:= </font>Ord<font color="#000080">( </font>s<font color="#000080">[ </font><font color="#800000">1 </font><font color="#000080">] )  - </font>Ord<font color="#000080">( </font><font color="#800000">'A' </font><font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>device <font color="#000080">&gt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then
           </b></font>device <font color="#000080">:= </font><font color="#800000">$80 </font><font color="#000080">+ ( </font>device <font color="#000080">- </font><font color="#800000">2 </font><font color="#000080">);
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>readpart<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font><font color="#008000"><i>{
Partition Table Information and location:

Format of hard disk master boot record:
. Offset  Size    Description
. 000h 446 BYTEs  Master bootstrap loader code
. 1BEh 16 BYTEs   partition record for partition 1 ( Byte definition below )
. 1CEh 16 BYTEs   partition record for partition 2
. 1DEh 16 BYTEs   partition record for partition 3
. 1EEh 16 BYTEs   partition record for partition 4
. 1FEh    WORD    signature, AA55h indicates valid BIOS extension block
.
Format of partition record:
Offset  Size    Description
 00h    BYTE    boot indicator (80h = active, 00H = inactive )
 01h    BYTE    partition start head
 02h    BYTE    partition start sector (bits 0-5)
 03h    BYTE    partition start track (bits 8,9 in bits 6,7 of sector)
 04h    BYTE    operating system indicator (see below)
 05h    BYTE    partition end head
 06h    BYTE    partition end sector (bits 0-5)
 07h    BYTE    partition end track (bits 8,9 in bits 6,7 of sector)
 08h    DWORD   sectors preceding partition
 0Ch    DWORD   length of partition in sectors

        Robert, you can use whatever information you need from this table.  I
also use a routine to read the CMOS setup data but there is varience between
manufacturers and it is a lot more difficult to decode the information you are
looking for.  I just stripped this code out and have not run it as a
stand-alone program.  Let me know how it worked for you and if you need any
more assistance with it, just drop me a message.
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DRIVES SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0099.PAS">Original</a><b>]</b></p></body>
</html>
