<html>
<head><title> "Joystick Reading" by LOU DUCHEZ</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to JOYSTICK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
The basic approach to reading a joystick is to monitor port 201h.  The eight
bits at that port correspond to:

01h - Joystick A, &quot;X&quot; position
02h - Joystick A, &quot;Y&quot; position
04h - Joystick B, &quot;X&quot; position
08h - Joystick B, &quot;Y&quot; position
10h - Joystick A, button 1
20h - Joystick A, button 2
40h - Joystick B, button 1
80h - Joystick B, button 2

The buttons are easy: a bit of &quot;0&quot; means &quot;pressed&quot; and &quot;1&quot; means &quot;not
pressed&quot;.  But a single bit to read a joystick position?!?  Here's what
you do:

1)  Write a value -- any value -- to port 201h.  The four lowest bits
    will then all assume a value of &quot;1&quot;.

2)  Start a counter, and see how many iterations it takes for your
    desired bit to go to zero.  The number of iterations = the joystick
    position, with lower values corresponding to &quot;left&quot; or &quot;up&quot; and
    higher values corresponding to &quot;right&quot; or &quot;down&quot;.

Like any joystick code, thess routines return the button statuses and the
joystick positions.  They also return boolean indicators of whether the
stick is left or right, up or down, based on a sensitivity you define.

The routines you call are:

procedure calibrate(r: real) -- Call this at the beginning of your program.
                                Determines presence of joysticks and how
                                far the stick has to be moved to constitute
                                L/R/U/D.  &quot;r&quot; is a real value from 0 to 1;
                                a value of 0.25 means that the stick has to
                                move 25% from center to count as L/R/U/D.
procedure readsticks         -- Reads sticks and buttons.  Call this once
                                every round of play or whatever.

THE CODE:
{--------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>unit </b></font>joystick<font color="#000080">;

</font><font color="#FF0000"><b>interface

var </b></font>jax<font color="#000080">, </font>jay<font color="#000080">, </font>jbx<font color="#000080">, </font>jby<font color="#000080">: </font>word<font color="#000080">;                 </font><font color="#008000"><i>{ Joystick positions }
    </i></font>ja1<font color="#000080">, </font>ja2<font color="#000080">, </font>jaleft<font color="#000080">, </font>jaright<font color="#000080">, </font>jaup<font color="#000080">, </font>jadown<font color="#000080">,  </font><font color="#008000"><i>{ JA1, JA2, JB1, JB2 = buttons }
    </i></font>jb1<font color="#000080">, </font>jb2<font color="#000080">, </font>jbleft<font color="#000080">, </font>jbright<font color="#000080">, </font>jbup<font color="#000080">, </font>jbdown<font color="#000080">,  </font><font color="#008000"><i>{ GotJoystickA/B record which }
    </i></font>gotjoysticka<font color="#000080">, </font>gotjoystickb<font color="#000080">: </font>boolean<font color="#000080">;      </font><font color="#008000"><i>{   joysticks are present }

   { lefts, rights, ups, downs are determined when the joysticks are read:
       if the stick is sufficiently off-center, L, R, U, and/or D will be
       flagged appropriately }

</i></font><font color="#FF0000"><b>procedure </b></font>readsticks<font color="#000080">;                         </font><font color="#008000"><i>{ reads joysticks }
</i></font><font color="#FF0000"><b>procedure </b></font>calibrate<font color="#000080">(</font>offcenterthresh<font color="#000080">: </font>real<font color="#000080">);   </font><font color="#008000"><i>{ determines what stick values
                                                  constitute L/R/U/D }
{--------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>implementation

var </b></font>jal<font color="#000080">, </font>jar<font color="#000080">, </font>jau<font color="#000080">, </font>jad<font color="#000080">, </font>jbl<font color="#000080">, </font>jbr<font color="#000080">, </font>jbu<font color="#000080">, </font>jbd<font color="#000080">: </font>word<font color="#000080">;   </font><font color="#008000"><i>{ thresholds for L/R/U/D }
{--------------------------------------------------------------------------}
</i></font><font color="#FF0000"><b>procedure </b></font>calibrate<font color="#000080">(</font>offcenterthresh<font color="#000080">: </font>real<font color="#000080">);   </font><font color="#008000"><i>{ get base figures for sticks }
</i></font><font color="#FF0000"><b>begin
  </b></font>gotjoysticka <font color="#000080">:= </font>true<font color="#000080">;                       </font><font color="#008000"><i>{ initially assume both sticks }
  </i></font>gotjoystickb <font color="#000080">:= </font>true<font color="#000080">;                       </font><font color="#008000"><i>{   are present }
  </i></font>readsticks<font color="#000080">;                                 </font><font color="#008000"><i>{ get stick positions }
  </i></font>gotjoysticka <font color="#000080">:= (</font>jax <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>jay <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">);     </font><font color="#008000"><i>{ if joystick reads as position }
  </i></font>gotjoystickb <font color="#000080">:= (</font>jbx <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>jby <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">);     </font><font color="#008000"><i>{   (0,0), it doesn't exist }
  </i></font>jal <font color="#000080">:= </font>round<font color="#000080">(</font>jax<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">- </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{ OFFCENTERTHRESH is a real }
  </i></font>jar <font color="#000080">:= </font>round<font color="#000080">(</font>jax<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">+ </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{   from 0 to 1 that tells the }
  </i></font>jau <font color="#000080">:= </font>round<font color="#000080">(</font>jay<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">- </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{   system how far off-center }
  </i></font>jad <font color="#000080">:= </font>round<font color="#000080">(</font>jay<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">+ </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{   the stick has to be to get }
  </i></font>jbl <font color="#000080">:= </font>round<font color="#000080">(</font>jbx<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">- </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{   counted as L/R/U/D.  For }
  </i></font>jbr <font color="#000080">:= </font>round<font color="#000080">(</font>jbx<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">+ </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{   example, a value of &quot;0.25&quot; }
  </i></font>jbu <font color="#000080">:= </font>round<font color="#000080">(</font>jby<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">- </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{   means the stick has to be }
  </i></font>jbd <font color="#000080">:= </font>round<font color="#000080">(</font>jby<font color="#000080">*(</font><font color="#800000">1 </font><font color="#000080">+ </font>offcenterthresh<font color="#000080">));    </font><font color="#008000"><i>{   25% below base to be L / U, }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                                        </font><font color="#008000"><i>{   or 25% above to be R / D. }

</i></font><font color="#FF0000"><b>procedure </b></font>readsticks<font color="#000080">;                       </font><font color="#008000"><i>{ Reads sticks &amp; buttons. }
</i></font><font color="#FF0000"><b>var </b></font>gotax<font color="#000080">, </font>gotay<font color="#000080">, </font>gotbx<font color="#000080">, </font>gotby<font color="#000080">: </font>boolean<font color="#000080">;    </font><font color="#008000"><i>{ whether we have a stick value }
    </i></font>cnter<font color="#000080">: </font>word<font color="#000080">;                            </font><font color="#008000"><i>{ just a counter }
</i></font><font color="#FF0000"><b>begin
  if </b></font>gotjoysticka <font color="#FF0000"><b>or </b></font>gotjoystickb <font color="#FF0000"><b>then begin  </b></font><font color="#008000"><i>{ if no sticks, skip reading them }
    </i></font>ja1 <font color="#000080">:= (</font>port<font color="#000080">[</font><font color="#800000">$201</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$10</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;          </font><font color="#008000"><i>{ read the buttons }
    </i></font>ja2 <font color="#000080">:= (</font>port<font color="#000080">[</font><font color="#800000">$201</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$20</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;
    </font>jb1 <font color="#000080">:= (</font>port<font color="#000080">[</font><font color="#800000">$201</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$40</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;
    </font>jb2 <font color="#000080">:= (</font>port<font color="#000080">[</font><font color="#800000">$201</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$80</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">;
    </font>gotax <font color="#000080">:= </font><font color="#FF0000"><b>not </b></font>gotjoysticka<font color="#000080">;              </font><font color="#008000"><i>{ Flags: do we have values yet? }
    </i></font>gotay <font color="#000080">:= </font><font color="#FF0000"><b>not </b></font>gotjoysticka<font color="#000080">;              </font><font color="#008000"><i>{ Set to &quot;true&quot; for nonexistent }
    </i></font>gotbx <font color="#000080">:= </font><font color="#FF0000"><b>not </b></font>gotjoystickb<font color="#000080">;              </font><font color="#008000"><i>{   stick -- no need to give    }
    </i></font>gotby <font color="#000080">:= </font><font color="#FF0000"><b>not </b></font>gotjoystickb<font color="#000080">;              </font><font color="#008000"><i>{   them a second thought }
    </i></font>jax <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                               </font><font color="#008000"><i>{ set actual stick positions to }
    </i></font>jay <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                               </font><font color="#008000"><i>{   zero -- on &quot;existing&quot; sticks }
    </i></font>jbx <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                               </font><font color="#008000"><i>{   the number will increase }
    </i></font>jby <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov  cx, 0000h   </font><font color="#008000"><i>{ set counter to zero }
      </i></font><font color="#FF00FF">mov  al, 0fh     </font><font color="#008000"><i>{ AL contains &quot;new&quot; port value (initialized to 0fh) }
      </i></font><font color="#FF00FF">mov  ah, al      </font><font color="#008000"><i>{ AH contains &quot;old&quot; port value (initialized to 0fh) }
      </i></font><font color="#FF00FF">mov  dx, 0201h   </font><font color="#008000"><i>{ load up joystick port }
      </i></font><font color="#FF00FF">out  dx, al      </font><font color="#008000"><i>{ &quot;prime&quot; joystick port by writing 0fh to it }
      </i></font><font color="#FF00FF">@beginloop:      </font><font color="#008000"><i>{ the stick-reading loop }

      </i></font><font color="#FF00FF">in   al, dx      </font><font color="#008000"><i>{ read joystick port }
      </i></font><font color="#FF00FF">and  al, 0fh     </font><font color="#008000"><i>{ &quot;and&quot; it with 0fh to &quot;eliminate&quot; the button bits }
      </i></font><font color="#FF00FF">cmp  al, ah      </font><font color="#008000"><i>{ compare to the &quot;old&quot; port value }
      </i></font><font color="#FF00FF">je   @endloop    </font><font color="#008000"><i>{ if no change, skip past position checking }

      </i></font><font color="#FF00FF">@chkax:          </font><font color="#008000"><i>{ checking &quot;X&quot; value on joystick &quot;A&quot; }
      </i></font><font color="#FF00FF">cmp  gotax, 01h  </font><font color="#008000"><i>{ see if &quot;gotax&quot; equals 1: if so, we've already got }
      </i></font><font color="#FF00FF">je   @chkay      </font><font color="#008000"><i>{   a reading on it, and skip to &quot;ay&quot; readings }
      </i></font><font color="#FF00FF">test al, 01h     </font><font color="#008000"><i>{ if first bit of BL is a 1: if so, we don't have a }
      </i></font><font color="#FF00FF">jnz  @chkay      </font><font color="#008000"><i>{   value for &quot;ax&quot;, so jump over to &quot;ay&quot; }
      </i></font><font color="#FF00FF">mov  gotax, 01h  </font><font color="#008000"><i>{ set boolean &quot;gotax&quot; to &quot;true&quot; }
      </i></font><font color="#FF00FF">mov  jax, cx     </font><font color="#008000"><i>{ record counter value }

      </i></font><font color="#FF00FF">@chkay:          </font><font color="#008000"><i>{ checking &quot;Y&quot; value on joystick &quot;A&quot; }
      </i></font><font color="#FF00FF">cmp  gotay, 01h
      je   @chkbx
      test al, 02h
      jnz  @chkbx
      mov  gotay, 01h
      mov  jay, cx

      @chkbx:          </font><font color="#008000"><i>{ checking &quot;X&quot; value on joystick &quot;B&quot; }
      </i></font><font color="#FF00FF">cmp  gotbx, 01h
      je   @chkby
      test al, 04h
      jnz  @chkby
      mov  gotbx, 01h
      mov  jbx, cx

      @chkby:          </font><font color="#008000"><i>{ checking &quot;Y&quot; value on joystick &quot;B&quot; }
      </i></font><font color="#FF00FF">cmp  gotby, 01h
      je   @endloop
      test al, 08h
      jnz  @endloop
      mov  gotby, 01h
      mov  jby, cx

      @endloop:        </font><font color="#008000"><i>{ counter increments and data-evaluating }
      </i></font><font color="#FF00FF">mov  ah, al      </font><font color="#008000"><i>{ store &quot;new&quot; port value as &quot;old&quot; value for next pass }
      </i></font><font color="#FF00FF">inc  cx          </font><font color="#008000"><i>{ increment counter }
      </i></font><font color="#FF00FF">cmp  cx, 65535   </font><font color="#008000"><i>{ compare counter to 65535 }
      </i></font><font color="#FF00FF">je   @ending     </font><font color="#008000"><i>{ if counter = 65535, get out of loop }
      </i></font><font color="#FF00FF">cmp  gotax, 01h  </font><font color="#008000"><i>{ see if we have a value for &quot;ax&quot;; }
      </i></font><font color="#FF00FF">jne  @beginloop  </font><font color="#008000"><i>{   if not, jump to top of loop for another pass }
      </i></font><font color="#FF00FF">cmp  gotay, 01h  </font><font color="#008000"><i>{ check &quot;ay&quot; }
      </i></font><font color="#FF00FF">jne  @beginloop
      cmp  gotbx, 01h  </font><font color="#008000"><i>{ check &quot;bx&quot; }
      </i></font><font color="#FF00FF">jne  @beginloop
      cmp  gotby, 01h  </font><font color="#008000"><i>{ check &quot;by&quot; }
      </i></font><font color="#FF00FF">jne  @beginloop
      @ending:         </font><font color="#008000"><i>{ we're past the end of the loop }
      </i></font><font color="#FF00FF">mov  cnter,cx    </font><font color="#008000"><i>{ store counter value into &quot;Pascal&quot; variable }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>jaleft <font color="#000080">:= (</font>jax <font color="#000080">&lt; </font>jal<font color="#000080">);  </font>jaright <font color="#000080">:= (</font>jax <font color="#000080">&gt; </font>jar<font color="#000080">);  </font><font color="#008000"><i>{ determine L/R/U/D }
  </i></font>jaup   <font color="#000080">:= (</font>jay <font color="#000080">&lt; </font>jau<font color="#000080">);  </font>jadown  <font color="#000080">:= (</font>jay <font color="#000080">&gt; </font>jad<font color="#000080">);
  </font>jbleft <font color="#000080">:= (</font>jbx <font color="#000080">&lt; </font>jbl<font color="#000080">);  </font>jbright <font color="#000080">:= (</font>jbx <font color="#000080">&gt; </font>jbr<font color="#000080">);
  </font>jbup   <font color="#000080">:= (</font>jby <font color="#000080">&lt; </font>jbu<font color="#000080">);  </font>jbdown  <font color="#000080">:= (</font>jby <font color="#000080">&gt; </font>jbd<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{--------------------------------------------------------------------------}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to JOYSTICK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p></body>
</html>
