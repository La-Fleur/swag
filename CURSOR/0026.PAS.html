<html>
<head><title> "Animated Cursor" by JONATHAN ANDERSON & KELLY SMALL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to CURSOR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{ Updated CURSOR.SWG on May 26, 1995 }

{
Hi everyone.  Recently, I made a program to animate the cursor, and
when I added support for hiding and showing the cursor, my program
ceased to work like it should (all int 10h functions (video) didn't
work right.)  If anyone has any suggestions, optimizations, or ways
to get this to take up less memory, please reply.

----8&lt;-cut-here-
Program AnimateCursor;
{ AnimateCursor Copyright (C) 1995 by Jonathan Anderson }
{ This program does what it says -- it makes the cursor move up and down }
{ thanks to John Baldwin for nice description of cursor handling }

{-$DEFINE Debug}        { Define this if changing the code }
{$DEFINE Use286}       { Define this to use 286 code }

{$IFDEF Debug}

{$M $1000,0,0}   { 4K stack, no heap }
{$A+,B-,D+,E-,F-,G-,I-,L+,N-,O-,R-,S+,V+,X-}     { TP6 compile options }

{$ELSE}

{$M $400,0,0}    { 1K stack, no heap }
{$A+,B-,D-,E-,F-,G-,I-,L-,N-,O-,R-,S-,V-,X-}

{$ENDIF}

{$IFDEF Use286}
{$G+}
{$ENDIF}

</i></font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Var </b></font>OldInt1C<font color="#000080">, </font>OldInt09 <font color="#000080">: </font><font color="#FF0000"><b>Procedure</b></font><font color="#000080">;
    </font>OldInt10           <font color="#000080">: </font>Pointer<font color="#000080">;     </font><font color="#008000"><i>{ status = cursor blink pattern }
    </i></font>x<font color="#000080">, </font>z<font color="#000080">, </font>status       <font color="#000080">: </font>Byte<font color="#000080">;        </font><font color="#008000"><i>{ x = top scan line for cursor }
    </i></font>y                  <font color="#000080">: </font>Boolean<font color="#000080">;     </font><font color="#008000"><i>{ z = width (in scan lines) of cursor }
                                      { y = cursor going up (F) or down (T) }

</i></font><font color="#FF0000"><b>Procedure </b></font>RemoveAnimate<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm                  </b></font><font color="#008000"><i>{ thanks to Luis Mezquita Raya for this... }
  </i></font><font color="#FF00FF">cli
  mov   ah,1
  mov   ch,6                </font><font color="#008000"><i>{ this procedure (c) Jul 94 Luis Mezquita Raya }
  </i></font><font color="#FF00FF">mov   cl,7
  int   10h
  mov   ah,49h
  mov   es,PrefixSeg
  push  es
  mov   es,es:[2ch]
  int   21h
  pop   es
  mov   ah,49h
  int   21h
  sti
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{$F+}
</i></font><font color="#FF0000"><b>Procedure </b></font>NewInt09<font color="#000080">; </font>Interrupt<font color="#000080">;      </font><font color="#008000"><i>{ KBD handler for unloading hotkey }
</i></font><font color="#FF0000"><b>Var </b></font>KB <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>KB <font color="#000080">:= </font>Port<font color="#000080">[</font><font color="#800000">$60</font><font color="#000080">];
  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$9C</font><font color="#000080">);                      </font><font color="#008000"><i>{ pushf }
  </i></font>OldInt09<font color="#000080">;                         </font><font color="#008000"><i>{ call old interrupt }
  </i></font><font color="#FF0000"><b>If </b></font>KB <font color="#000080">= </font><font color="#800000">88 </font><font color="#FF0000"><b>Then                   </b></font><font color="#008000"><i>{ Use F12 to unload from memory }
    </i></font><font color="#FF0000"><b>Begin
      </b></font>SetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">, @</font>OldInt1C<font color="#000080">);
      </font>SetIntVec<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">, </font>OldInt10<font color="#000080">);
      </font>SetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, @</font>OldInt09<font color="#000080">);
      </font>RemoveAnimate<font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>NewInt10<font color="#000080">; </font>Interrupt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;  </font><font color="#008000"><i>{ handler to allow programs  }
</i></font><font color="#FF0000"><b>Asm                                        </b></font><font color="#008000"><i>{ to hide &amp; show cursor...   }
{$IFDEF Use286}                            { right now, it doesn't work }
  </i></font><font color="#FF00FF">pusha
</font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF00FF">push  ax
  push  bx
  push  cx
  push  dx
  push  si
  push  di
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF00FF">cmp   ah,1                               </font><font color="#008000"><i>{ check for cursor change }
  </i></font><font color="#FF00FF">jnz   @Skip                              </font><font color="#008000"><i>{ request &amp; jump if not   }
  </i></font><font color="#FF00FF">mov   status,ch
  and   status,60h                         </font><font color="#008000"><i>{ isolate bits 5 and 6 }
</i></font><font color="#FF00FF">@Skip:
</font><font color="#008000"><i>{$IFDEF Use286}
  </i></font><font color="#FF00FF">popa
</font><font color="#008000"><i>{$ELSE}
  </i></font><font color="#FF00FF">pop   ax
  pop   bx
  pop   cx
  pop   dx
  pop   si
  pop   di
</font><font color="#008000"><i>{$ENDIF}
  </i></font><font color="#FF00FF">call  oldint10                           </font><font color="#008000"><i>{ call olt interrupt }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>NewInt1C<font color="#000080">; </font>Interrupt<font color="#000080">;             </font><font color="#008000"><i>{ timer handler; changes cursor }
</i></font><font color="#FF0000"><b>Var </b></font>ctype <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  If </b></font><font color="#000080">(</font>x<font color="#000080">=</font><font color="#800000">129</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>x<font color="#000080">=</font><font color="#800000">143</font><font color="#000080">-</font>z<font color="#000080">) </font><font color="#FF0000"><b>Then </b></font>y <font color="#000080">:= </font><font color="#FF0000"><b>Not</b></font><font color="#000080">(</font>y<font color="#000080">);  </font><font color="#008000"><i>{ reverse direction of cursor }
  </i></font><font color="#FF0000"><b>If </b></font>y <font color="#FF0000"><b>Then Asm </b></font><font color="#FF00FF">dec x </font><font color="#FF0000"><b>End                  </b></font><font color="#008000"><i>{ why use Inc() and Dec() ? }
  </i></font><font color="#FF0000"><b>Else Asm </b></font><font color="#FF00FF">inc x </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>ctype <font color="#000080">:= </font>status <font color="#FF0000"><b>OR </b></font>x<font color="#000080">;            </font><font color="#008000"><i>{ combine status bits with position bits }
  </i></font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov  ah,1                      </font><font color="#008000"><i>{ request cursor change }
    </i></font><font color="#FF00FF">mov  ch,ctype                  </font><font color="#008000"><i>{ set top scan line }
    </i></font><font color="#FF00FF">mov  cl,ctype                  </font><font color="#008000"><i>{ set bottom scan line }
    </i></font><font color="#FF00FF">add  cl,z
    call OldInt10      </font><font color="#008000"><i>{ call oldint instead of wasting time calling new one }
  </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$9C</font><font color="#000080">);         </font><font color="#008000"><i>{ pushf }
  </i></font>OldInt1C<font color="#000080">;            </font><font color="#008000"><i>{ call old interrupt }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}

</i></font><font color="#FF0000"><b>Begin
  </b></font>x <font color="#000080">:= </font><font color="#800000">129</font><font color="#000080">;  </font><font color="#008000"><i>{ had to mess with this value for use of all scan lines in char }
  </i></font>z <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;                    </font><font color="#008000"><i>{ cusor width = 1 }
  </i></font>status <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;               </font><font color="#008000"><i>{ normal cursor }
  </i></font>y <font color="#000080">:= </font>True<font color="#000080">;                 </font><font color="#008000"><i>{ MUST be true...}
  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, @</font>OldInt09<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">$09</font><font color="#000080">, @</font>NewInt09<font color="#000080">);
  </font>GetIntVec<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">, </font>OldInt10<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">, @</font>NewInt10<font color="#000080">); </font><font color="#008000"><i>{ comment this line for prog. to work w/o int10 }
  </i></font>GetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">, @</font>OldInt1C<font color="#000080">);
  </font>SetIntVec<font color="#000080">(</font><font color="#800000">$1C</font><font color="#000080">, @</font>NewInt1C<font color="#000080">);
  </font>Keep<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);                   </font><font color="#008000"><i>{ terminate, stay resident }
</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font><font color="#008000"><i>(*
  From: Kelly Small

You don't restore the registers properly during the Int $10 ISR.
You need to pop them in the reverse order that they were pushed:

&gt;Procedure NewInt10; Interrupt; Assembler;  { handler to allow programs  }
&gt;Asm                                        { to hide &amp; show cursor...   }
&gt;  push  ax
&gt;  push  bx
&gt;  push  cx
&gt;  push  dx
&gt;  push  si
&gt;  push  di


&gt;  pop   ax
&gt;  pop   bx
&gt;  pop   cx
&gt;  pop   dx
&gt;  pop   si
&gt;  pop   di

After this you would have ax = di
                          bx = si etc.

Reverse the order of your pop's and it should work.
*)
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to CURSOR SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p></body>
</html>
