<html>
<head><title> "Copy File #4" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to COPYMOVE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0004.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{I am having a bit of a problem in Pascal.  I am writing a routine to
copy Files.  The Program is to be used in an area where anything at
all can happen, so it has to be totally bullet-proof.  All is well,
except one little thing.  Should the Program encounter a major disk
error (for example, the user removes the disk While the copy is taking
place), the Program breaks into Dos after an 'Abort, Retry, Fail'
prompt.  Now comes the weird part.  This crash to Dos only occurs only
once the Program terminates.  It processes the error perfectly, and only
gives the error once my entire Program is at an end!  Following is the
source code in question:
}
</i></font><font color="#FF0000"><b>Program </b></font>FileTest<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>FileCopy<font color="#000080">(</font>SrcPath<font color="#000080">, </font>DstPath<font color="#000080">, </font>FSpec <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>ExStat <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>DirInfo <font color="#000080">: </font>SearchRec<font color="#000080">;
  </font>Done    <font color="#000080">: </font>Boolean<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Process<font color="#000080">(</font>X <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>Source<font color="#000080">,
  </font>Dest     <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>Buffer   <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4096</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>ReadCnt<font color="#000080">,
  </font>WriteCnt <font color="#000080">: </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{$I-}
  </i></font>ExStat<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font>Assign<font color="#000080">(</font>Source<font color="#000080">,</font>SrcPath<font color="#000080">+</font>X<font color="#000080">);
  </font>Reset<font color="#000080">(</font>Source<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>ExStat <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>ExStat <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>Assign<font color="#000080">(</font>Dest<font color="#000080">,</font>DstPath<font color="#000080">+</font>X<font color="#000080">);
    </font>ReWrite<font color="#000080">(</font>Dest<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>ExStat <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font>ExStat <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      Repeat
        </b></font>BlockRead<font color="#000080">(</font>Source<font color="#000080">,</font>Buffer<font color="#000080">,</font>Sizeof<font color="#000080">(</font>Buffer<font color="#000080">),</font>ReadCnt<font color="#000080">);
        </font>BlockWrite<font color="#000080">(</font>Dest<font color="#000080">,</font>Buffer<font color="#000080">,</font>ReadCnt<font color="#000080">,</font>WriteCnt<font color="#000080">);
        </font><font color="#FF0000"><b>If </b></font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
          </b></font>ExStat <font color="#000080">:= </font><font color="#800000">3</font><font color="#000080">;
      </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>ReadCnt <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>WriteCnt <font color="#000080">&lt;&gt; </font>ReadCnt<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>ExStat <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);
      </font>Close<font color="#000080">(</font>Dest<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>Close<font color="#000080">(</font>Source<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{$I+}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{$I-}
    </i></font>ExStat <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>FindFirst<font color="#000080">(</font>SrcPath <font color="#000080">+ </font>FSpec<font color="#000080">, </font>Archive<font color="#000080">, </font>DirInfo<font color="#000080">);
    </font>Done <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>While Not </b></font>Done <font color="#FF0000"><b>do
    begin
      </b></font>Write<font color="#000080">(</font><font color="#800000">'Copying '</font><font color="#000080">,</font>DirInfo<font color="#000080">.</font>Name<font color="#000080">,</font><font color="#800000">' '</font><font color="#000080">);
      </font>Process<font color="#000080">(</font>DirInfo<font color="#000080">.</font>Name<font color="#000080">);
      </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>ExStat <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>FindNext<font color="#000080">(</font>DirInfo<font color="#000080">);
        </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>DosError<font color="#000080">&lt;&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
          </b></font>Done <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end
      else
        </b></font>Done <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{$I+}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Main<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>ExC <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FileCopy<font color="#000080">(</font><font color="#800000">'C:\Dos\'</font><font color="#000080">,</font><font color="#800000">'A:\'</font><font color="#000080">,</font><font color="#800000">'*.BAS'</font><font color="#000080">,</font>ExC<font color="#000080">);
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Exit Code:'</font><font color="#000080">,</font>ExC<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Main<font color="#000080">;
  </font>Writeln<font color="#000080">(</font><font color="#800000">'Program is Complete'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font><font color="#008000"><i>{
That's it.  All errors get logged normally, and right after 'Program is
Complete', I get an 'Abort, Retry, Fail'.  It must be a File left open,
and TP tries to close it once the Program terminates, but I can't
imagine which File it might be!
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to COPYMOVE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0004.PAS">Original</a><b>]</b></p></body>
</html>
