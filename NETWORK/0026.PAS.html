<html>
<head><title> "Call NETAPI.DLL function" by ROBIN BOWES</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to NETWORK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
From: ROBIN@plato.ucsalf.ac.uk (Robin Bowes)

I'm trying to call a function in a Windows .dll from
Turbo Pascal for Windows v1.5.

The .dll in question is NETAPI.DLL.  The function I want to call is
defined as follows (in C format):

(from Microsoft LAN Manager Programmer's Reference, )

NetWkstaGetInfo ( const char far *  pszServer,
       short      sLevel,
       char far *    pbBuffer,
       unsigned short   cbBuffer,
       unsigned short far * pcbTotalAvail
      );

where

pszServer
 contains the name of the server on which to execute NetWkstGetInfo.

sLevel
 specfies the level of detail to be supplied in the return buffer

pbBuffer
 points to the buffer in which data is returned

cbBuffer
 specifies the size of the buffer pointed to by pbBuffer

pcbTotalAvail
 points to an unsigned integer in which the number of bytes of
 information available is returned.


The detail level I require is 10 which means that the buffer returned
will contain a wksta_info_10 structure which is defined as follows:

struct wksta_info_10 {
 char far *  wki10_computername;
 char far *  wki10_username;
 char far *  wki10_langroup;
 unsigned char wki10_ver_major;
 unsigned char wki10_ver_minor;
 char far *  wki10_logon_domain;
 char far *  wki10_oth_domains;
};


I am having trouble getting this function to work.  It will be a .dll
eventually but for now I'm jsut coding it as a program using WinCrt.

My code so far looks something like this:
*)
</i></font><font color="#FF0000"><b>program </b></font>Username<font color="#000080">;

</font><font color="#FF0000"><b>uses </b></font>WinTypes<font color="#000080">, </font>WinCrt<font color="#000080">;

</font><font color="#FF0000"><b>const
 </b></font>NERR_BufTooSmall <font color="#000080">= </font><font color="#800000">2123</font><font color="#000080">;
  </font>NERR_Success   <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;

</font><font color="#FF0000"><b>type
 </b></font>Wksta_info_10 <font color="#000080">=
  </font><font color="#FF0000"><b>record
   </b></font>wki10_computername <font color="#000080">: </font>pChar<font color="#000080">;
   </font>wki10_username   <font color="#000080">: </font>pChar<font color="#000080">;
   </font>wki10_langroup   <font color="#000080">: </font>pChar<font color="#000080">;
   </font>wki10_ver_major   <font color="#000080">: </font>Byte<font color="#000080">;
   </font>wki10_ver_minor   <font color="#000080">: </font>Byte<font color="#000080">;
   </font>wki10_logon_domain <font color="#000080">: </font>pChar<font color="#000080">;
   </font>wki10_oth_domains  <font color="#000080">: </font>pChar<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>pWksta_info_10 <font color="#000080">= ^</font>Wksta_info_10<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>NetWkstaGetInfo<font color="#000080">( </font>pszServer     <font color="#000080">: </font>pChar<font color="#000080">;
             </font>sLevel      <font color="#000080">: </font>Integer<font color="#000080">;
             </font><font color="#FF0000"><b>var </b></font>pbBuffer   <font color="#000080">: </font>pWksta_info_10<font color="#000080">;
             </font>cbBuffer     <font color="#000080">: </font>Word<font color="#000080">;
             </font><font color="#FF0000"><b>var </b></font>pcbTotalAvail <font color="#000080">: </font>pWord
            <font color="#000080">) : </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">; </font><font color="#FF0000"><b>external </b></font><font color="#800000">'NETAPI'</font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>getUsername<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Username <font color="#000080">: </font>pChar<font color="#000080">) : </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>var
 </b></font>pWI        <font color="#000080">: </font>pWksta_info_10<font color="#000080">;
 </font>sWorkStationInfo <font color="#000080">: </font>Word<font color="#000080">;
 </font>pbBufLen     <font color="#000080">: </font>pWord<font color="#000080">;
 </font>pbTotalAvail   <font color="#000080">: </font>pWord<font color="#000080">;
 </font>uRetCode     <font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
 </b></font><font color="#008000"><i>{first call will fail but should return the size of the
 buffer needed to hold all the available data}
 </i></font>getMem<font color="#000080">(</font>pbBufLen<font color="#000080">, </font>sizeOf<font color="#000080">(</font>pbBufLen<font color="#000080">));
  </font>pwI <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
 </font>uRetCode <font color="#000080">:= </font>NetWkstaGetInfo<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">,   </font><font color="#008000"><i>{Servername (nil -&gt; local machine)}
               </i></font><font color="#800000">10</font><font color="#000080">,    </font><font color="#008000"><i>{Reporting level}    
               </i></font>pWI<font color="#000080">,   </font><font color="#008000"><i>{target buffer for info}
               </i></font><font color="#800000">0</font><font color="#000080">,    </font><font color="#008000"><i>{Size of target buffer}
               </i></font>pbBufLen <font color="#008000"><i>{Count of bytes available}
               </i></font><font color="#000080">);
 </font><font color="#008000"><i>{check the return code from the function}
 </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>uRetCode <font color="#000080">= </font>NERR_BufTooSmall<font color="#000080">) </font><font color="#FF0000"><b>then
  </b></font><font color="#008000"><i>{ check available memory }
  </i></font><font color="#FF0000"><b>begin
  if </b></font>maxAvail <font color="#000080">&lt; </font>pbBufLen<font color="#000080">^ </font><font color="#FF0000"><b>then
   begin
   </b></font>getUsername <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
      </font>Exit
   <font color="#FF0000"><b>end
    else
   </b></font><font color="#008000"><i>{allocate memory for buffer to hold information}
   </i></font><font color="#FF0000"><b>begin
   </b></font>getMem<font color="#000080">(</font>pWI<font color="#000080">, </font>pbBufLen<font color="#000080">^)
   </font><font color="#FF0000"><b>end
  end
 else
   </b></font><font color="#008000"><i>{Unexpected error returned}
  </i></font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{Pass return code back to calling program}
  </i></font>getUsername <font color="#000080">:= </font>uRetCode<font color="#000080">;
  </font>Exit
  <font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#008000"><i>{second call to get information}
 </i></font>getMem<font color="#000080">(</font>pbTotalAvail<font color="#000080">, </font>sizeOf<font color="#000080">(</font>pbTotalAvail<font color="#000080">));
 </font>uRetCode <font color="#000080">:= </font>NetWkstaGetInfo<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">, </font><font color="#800000">10</font><font color="#000080">, </font>pWI<font color="#000080">,  </font>pbBufLen<font color="#000080">^, </font>pbTotalAvail<font color="#000080">);
 </font>getUsername <font color="#000080">:= </font>uRetCode<font color="#000080">;
 </font><font color="#FF0000"><b>if </b></font>uRetCode <font color="#000080">= </font>NERR_Success <font color="#FF0000"><b>then
   begin
  </b></font>Username <font color="#000080">:= </font>pWI<font color="#000080">^.</font>wki10_username<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>freeMem<font color="#000080">(</font>pbBufLen<font color="#000080">, </font>sizeOf<font color="#000080">(</font>pbBufLen<font color="#000080">));
 </font>freeMem<font color="#000080">(</font>pbTotalAvail<font color="#000080">, </font>sizeOf<font color="#000080">(</font>pbTotalAvail<font color="#000080">))
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{exports
 getUsername  index 1;}

</i></font><font color="#FF0000"><b>var
 </b></font>retVal <font color="#000080">: </font>Integer<font color="#000080">;
 </font>uName <font color="#000080">: </font>pChar<font color="#000080">;

</font><font color="#FF0000"><b>begin
</b></font>getMem<font color="#000080">(</font>uName<font color="#000080">, </font>sizeOf<font color="#000080">(</font>uName<font color="#000080">));
</font>retVal <font color="#000080">:= </font>getUserName<font color="#000080">(</font>uName<font color="#000080">);
</font><font color="#FF0000"><b>if </b></font>retVal <font color="#000080">= </font>NERR_Success <font color="#FF0000"><b>then
 </b></font>writeln<font color="#000080">(</font>uName<font color="#000080">)
</font><font color="#FF0000"><b>else
 </b></font>writeln<font color="#000080">(</font><font color="#800000">'Error returned: '</font><font color="#000080">, </font>retVal<font color="#000080">);
</font>freeMem<font color="#000080">(</font>uName<font color="#000080">, </font>sizeOf<font color="#000080">(</font>uName<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font><font color="#008000"><i>{

This compiles OK but throws a GPF in NETAPI.DLL.

I'm fairly sure it's the conversion of the structure type that's causing
the problem.

Has anybody got any ideas ?

}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to NETWORK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p></body>
</html>
