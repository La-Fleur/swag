<html>
<head><title> "Netware Bindary Object" by ROBERT KOHLBUS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to NETWORK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Robert C. Kohlbus

        I'm trying to compile and run a program that I wrote, with BP70
'real' mode, in 'Protected Mode'.  This program uses Interrupt 21h
functions B80Xh and E3h, the Novell Netware ones.  The program worked fine
in 'real' mode, but gives incorrect information in 'Protected Mode'.  After
calling Borland, they said it was because the DPMI overlay file didn't know
how to handle the interrupts I was trying to access.  They suggested that I
look at a file from their BBS called READWRTE.PAS that shows how to handle
interrupts in a 'Protected Mode' program.  Basically this example file, just
interrupt 31h (Simulate Real Mode Interrupt).  My problem is that my program
continues to hang up, even after following their example.  Below is a sample
part of my program.  If anyone can lend a hand, I would be in their debt.
}

</i></font><font color="#FF0000"><b>Program </b></font>Getid<font color="#000080">;      </font><font color="#008000"><i>{ Get unique Id for Novell Netware Bindery Object }

</i></font><font color="#FF0000"><b>uses
  </b></font>Dos<font color="#000080">, </font>Crt<font color="#000080">, </font>WinApi<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TDPMIRegs <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>edi<font color="#000080">, </font>esi<font color="#000080">, </font>ebp<font color="#000080">, </font>reserved<font color="#000080">, </font>ebx<font color="#000080">, </font>edx<font color="#000080">, </font>ecx<font color="#000080">, </font>eax<font color="#000080">: </font>LongInt<font color="#000080">;
    </font>flags<font color="#000080">, </font>es<font color="#000080">, </font>ds<font color="#000080">, </font>fs<font color="#000080">, </font>gs<font color="#000080">, </font>ip<font color="#000080">, </font>cs<font color="#000080">, </font>sp<font color="#000080">, </font>ss <font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Hexid <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>R<font color="#000080">: </font>TDPMIRegs<font color="#000080">;

  </font>RequestBuffer <font color="#000080">: </font><font color="#FF0000"><b>record
      </b></font>PacketLength  <font color="#000080">: </font>integer<font color="#000080">;
      </font>functionval   <font color="#000080">: </font>byte<font color="#000080">;
      </font>ObjectType    <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
      </font>NameLength    <font color="#000080">: </font>byte<font color="#000080">;
      </font>ObjectName    <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">47</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>ReplyBuffer  <font color="#000080">: </font><font color="#FF0000"><b>record
      </b></font>ReturnLength  <font color="#000080">: </font>integer<font color="#000080">;
      </font>UniqueID1  <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
      </font>UniqueID2  <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
      </font>ObjectType <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
      </font>ObjectName <font color="#000080">: </font><font color="#FF0000"><b>packed array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">48</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>function </b></font>DPMIRealInt<font color="#000080">(</font>IntNo<font color="#000080">, </font>CopyWords<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>R<font color="#000080">: </font>TDPMIRegs<font color="#000080">): </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax, 0300h
  mov bx, IntNo
  mov cx, CopyWords
  les di, R
  int 31h
  jc  @error
  mov ax, 1
  jmp @done
@error:
  xor ax, ax
  @Done:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>LongFromBytes<font color="#000080">(</font>HighByte<font color="#000080">, </font>LowByte<font color="#000080">: </font>Byte<font color="#000080">): </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx, 0
  mov ah, HighByte
  mov al, LowByte
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>LongFromWord<font color="#000080">(</font>LoWord<font color="#000080">: </font>Word<font color="#000080">): </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov dx, 0
  mov ax, LoWord;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>RealToProt<font color="#000080">(</font>P<font color="#000080">: </font>Pointer<font color="#000080">; </font>Size<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>Sel<font color="#000080">: </font>Word<font color="#000080">): </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>SetSelectorBase<font color="#000080">(</font>Sel<font color="#000080">, </font>LongInt<font color="#000080">(</font>HiWord<font color="#000080">(</font>LongInt<font color="#000080">(</font>P<font color="#000080">))) </font><font color="#FF0000"><b>Shl </b></font><font color="#800000">4 </font><font color="#000080">+ </font>LoWord<font color="#000080">(</font>LongInt<font color="#000080">(</font>P<font color="#000080">)));
  </font>SetSelectorLimit<font color="#000080">(</font>Sel<font color="#000080">, </font>Size<font color="#000080">);
  </font>RealToProt <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Sel<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>GetObjectID<font color="#000080">(</font>Name <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>ObjType <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>const
    </b></font>HEXDIGITS <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#000080">= </font><font color="#800000">'0123456789ABCDEF'</font><font color="#000080">;

</font><font color="#FF0000"><b>var </b></font>Reg <font color="#000080">: </font>Registers<font color="#000080">;
    </font>i <font color="#000080">: </font>integer<font color="#000080">;
    </font>Hex_ID<font color="#000080">, </font>S <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
    </font>ErrorCode <font color="#000080">: </font>word<font color="#000080">;
    </font>ObjectId  <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;


</font><font color="#FF0000"><b>begin
  with </b></font>RequestBuffer <font color="#FF0000"><b>do
  begin
     </b></font>PacketLength  <font color="#000080">:= </font><font color="#800000">52</font><font color="#000080">;
     </font>FunctionVal   <font color="#000080">:= </font><font color="#800000">$35</font><font color="#000080">;
     </font>ObjectType<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">$0</font><font color="#000080">;
     </font>ObjectType<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>ObjType<font color="#000080">;
     </font>NameLength    <font color="#000080">:= </font>length<font color="#000080">(</font>Name<font color="#000080">);
     </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>Name<font color="#000080">) </font><font color="#FF0000"><b>do
       </b></font>ObjectName<font color="#000080">[</font>i<font color="#000080">] := </font>Name<font color="#000080">[</font>i<font color="#000080">];
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ReplyBuffer<font color="#000080">.</font>ReturnLength <font color="#000080">:= </font><font color="#800000">55</font><font color="#000080">;

  </font><font color="#008000"><i>{ Original Code that worked in Real Mode }
{
  Reg.ah := $E3;
  Reg.ds := seg(RequestBuffer);
  Reg.si := ofs(RequestBuffer);
  Reg.es := seg(ReplyBuffer);
  Reg.di := ofs(ReplyBuffer);

  MsDos(Reg);
}

  { New Code From Borland Example }
  </i></font>FillChar<font color="#000080">(</font>R<font color="#000080">, </font>SizeOf<font color="#000080">(</font>TDPMIRegs<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);
  </font>R<font color="#000080">.</font>Eax <font color="#000080">:= </font><font color="#800000">$E3</font><font color="#000080">;
  </font>R<font color="#000080">.</font>ds  <font color="#000080">:= </font>seg<font color="#000080">(</font>RequestBuffer<font color="#000080">);
  </font>R<font color="#000080">.</font>Esi <font color="#000080">:= </font>LongFromWord<font color="#000080">(</font>ord<font color="#000080">(</font>RequestBuffer<font color="#000080">));
  </font>R<font color="#000080">.</font>es  <font color="#000080">:= </font>seg<font color="#000080">(</font>ReplyBuffer<font color="#000080">);
  </font>R<font color="#000080">.</font>Edi <font color="#000080">:= </font>LongFromWord<font color="#000080">(</font>ord<font color="#000080">(</font>ReplyBuffer<font color="#000080">));
  </font>DPMIRealInt<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>R<font color="#000080">);

</font><font color="#008000"><i>{
  S := 'None';
  Errorcode := Reg.al;
  if Errorcode = $96 then S := 'Server out of memory';
  if Errorcode = $EF then S := 'Invalid name';
  if Errorcode = $F0 then S := 'Wildcard not allowed';
  if Errorcode = $FC then S := 'No such object *'+QueueName+'*';
  if Errorcode = $FE then S := 'Server bindery locked';
  if Errorcode = $FF then S := 'Bindery failure';
  S := 'Error : '+ S;
  Writeln(S);
}
  </i></font>Hex_ID <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;

  </font>Hex_ID <font color="#000080">:= </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID1<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">];
  </font>Hex_ID <font color="#000080">:= </font>Hex_ID <font color="#000080">+ </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID1<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">];
  </font>Hex_ID <font color="#000080">:= </font>Hex_ID <font color="#000080">+ </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID1<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">];
  </font>Hex_ID <font color="#000080">:= </font>Hex_ID <font color="#000080">+ </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID1<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">];
  </font>Hex_ID <font color="#000080">:= </font>Hex_ID <font color="#000080">+ </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID2<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">];
  </font>Hex_ID <font color="#000080">:= </font>Hex_ID <font color="#000080">+ </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID2<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">];
  </font>Hex_ID <font color="#000080">:= </font>Hex_ID <font color="#000080">+ </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">];
  </font>Hex_ID <font color="#000080">:= </font>Hex_ID <font color="#000080">+ </font>hexdigits<font color="#000080">[</font>ReplyBuffer<font color="#000080">.</font>UniqueID2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">];
  </font><font color="#FF0000"><b>while </b></font>Hex_ID<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">'0' </font><font color="#FF0000"><b>do
      </b></font>Hex_ID <font color="#000080">:= </font>copy<font color="#000080">(</font>Hex_ID<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">,</font>length<font color="#000080">(</font>Hex_ID<font color="#000080">));

  </font>Hexid <font color="#000080">:= </font>Hex_ID<font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>Hexid <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
   </font>ClrScr<font color="#000080">;

   </font><font color="#008000"><i>{ Get An Objects Id
     Parameters (2)  Object Name, Object Type
     Object Name = String[8];
     Object Type = Word;
          1  User
          2  User Group
          3  Print Queue
          4  File Server
          5  Job Server
          6  Gateway
          7  Print Server
   }
   </i></font>GetObjectID<font color="#000080">(</font><font color="#800000">'BUSINESS'</font><font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);     </font><font color="#008000"><i>{ Get Print Queue's ID }
   </i></font>Writeln<font color="#000080">(</font><font color="#800000">'Hexid for BUSINESS is '</font><font color="#000080">,</font>hexid<font color="#000080">);

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to NETWORK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p></body>
</html>
