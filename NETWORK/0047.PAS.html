<html>
<head><title> "Excellent IPX Unit" by JACK NEELY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to NETWORK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
I have an IPX unit I would like to contribute to SWAG.  It uses the
advanced calls in Netware 2.0a and above.  (INT 2F/AX = 7A00)  This is
now the recomended way to interface the IPX unlike INT 7A.  I have seen
a few IPX units but they all use INT 7A.  Mine is the only one I have
seen using the new procedures.

Thanks!
Jack Neely
}

</i></font><font color="#FF0000"><b>unit </b></font>IPX<font color="#000080">;
</font><font color="#008000"><i>{Version 1.0  Copyright 1997 Jack Neely.  All rights reserved.}

{This unit provides IPX interface.  Requirements are Novell
NetWare 2.0a or higher.  This uses the new IPX call INT 2F/AX=7A00h.
This calls no interrupts save for in the init section.  TSR safe.

If needed (by you or anyone) there are other IPX functions that can be added
to this unit.  If you would like to contact me for whatever reason my e-mail
address is below.  Enjoy!

Jack Neely
hneely@ac.net
http://www.ac.net/~hneely/
}

</i></font><font color="#FF0000"><b>interface

type
</b></font>	netAddr  <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;    </font><font color="#008000"><i>{ The address of a network }
</i></font>	nodeAddr <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;    </font><font color="#008000"><i>{ The address of a node in a network }
</i></font>	address  <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word<font color="#000080">;    </font><font color="#008000"><i>{ A pointer to the data 0=offset 1=seg }
</i></font>	netAddress <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>		Net    <font color="#000080">: </font>netAddr<font color="#000080">;   </font><font color="#008000"><i>{ network address }
</i></font>		Node   <font color="#000080">: </font>nodeAddr<font color="#000080">;  </font><font color="#008000"><i>{ node address }
</i></font>		Socket <font color="#000080">: </font>word<font color="#000080">;      </font><font color="#008000"><i>{ Big endian socket number}
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	localAddrT <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>		Net    <font color="#000080">: </font>netAddr<font color="#000080">;   </font><font color="#008000"><i>{ my network address }
</i></font>		Node   <font color="#000080">: </font>nodeAddr<font color="#000080">;  </font><font color="#008000"><i>{ my node address }
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	ECBType <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>		link      <font color="#000080">: </font>address<font color="#000080">;    </font><font color="#008000"><i>{ Pointer to next ECB? }
</i></font>		ESR       <font color="#000080">: </font>address<font color="#000080">;    </font><font color="#008000"><i>{ Event Service Routine 00000000h if none }
</i></font>		inUse     <font color="#000080">: </font>byte<font color="#000080">;       </font><font color="#008000"><i>{ In use flag }
</i></font>		complete  <font color="#000080">: </font>byte<font color="#000080">;       </font><font color="#008000"><i>{ Completeing flag }
</i></font>		socket    <font color="#000080">: </font>word<font color="#000080">;       </font><font color="#008000"><i>{ Big endian socket number }
</i></font>		IPXwork   <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;  </font><font color="#008000"><i>{ IPX work space }
</i></font>		Dwork     <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">12</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">; </font><font color="#008000"><i>{ Driver work space }
</i></font>		immedAddr <font color="#000080">: </font>nodeAddr<font color="#000080">;   </font><font color="#008000"><i>{ Immediate local node address }
</i></font>		fragCount <font color="#000080">: </font>word<font color="#000080">;       </font><font color="#008000"><i>{ Fragment count }
</i></font>		fragData  <font color="#000080">: </font>address<font color="#000080">;    </font><font color="#008000"><i>{ Pointer to data fragment }
</i></font>		fragSize  <font color="#000080">: </font>word<font color="#000080">;       </font><font color="#008000"><i>{ Size of data fragment }
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	IPXheader <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>		check  <font color="#000080">: </font>word<font color="#000080">;                </font><font color="#008000"><i>{ big endian checksum }
</i></font>		length <font color="#000080">: </font>word<font color="#000080">;                </font><font color="#008000"><i>{ big endian length in bytes }
</i></font>		tc     <font color="#000080">: </font>byte<font color="#000080">;                </font><font color="#008000"><i>{ transport control }
</i></font>		pType  <font color="#000080">: </font>byte<font color="#000080">;                </font><font color="#008000"><i>{ packet type }
</i></font>		dest   <font color="#000080">: </font>netAddress<font color="#000080">;          </font><font color="#008000"><i>{ destination network address }
</i></font>		src    <font color="#000080">: </font>netAddress<font color="#000080">;          </font><font color="#008000"><i>{ source network address }
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
</b></font>	BROADCAST <font color="#000080">: </font>nodeAddr <font color="#000080">= (</font><font color="#800000">$ff</font><font color="#000080">,</font><font color="#800000">$ff</font><font color="#000080">,</font><font color="#800000">$ff</font><font color="#000080">,</font><font color="#800000">$ff</font><font color="#000080">,</font><font color="#800000">$ff</font><font color="#000080">,</font><font color="#800000">$ff</font><font color="#000080">);  </font><font color="#008000"><i>{ Address for broadcast }

</i></font><font color="#FF0000"><b>var
        </b></font>IPXInstalled<font color="#000080">:</font>boolean<font color="#000080">;  </font><font color="#008000"><i>{You MUST check this BEFORE calling ANY procs}
        </i></font>API<font color="#000080">:</font><font color="#FF0000"><b>procedure</b></font><font color="#000080">;         </font><font color="#008000"><i>{FAR entry point.}
        </i></font>localAddr<font color="#000080">:</font>localAddrT<font color="#000080">;   </font><font color="#008000"><i>{Filled during init}
        </i></font>major<font color="#000080">, </font>minor<font color="#000080">:</font>word<font color="#000080">;     </font><font color="#008000"><i>{Verson of IPX}
        </i></font>t1<font color="#000080">, </font>t2<font color="#000080">:</font>word<font color="#000080">;           </font><font color="#008000"><i>{temps}

</i></font><font color="#FF0000"><b>procedure </b></font>InitSendPacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>ecb<font color="#000080">:</font>ecbType<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ipx<font color="#000080">:</font>ipxHeader<font color="#000080">; </font>size<font color="#000080">, </font>sock<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#008000"><i>{Constructs and preinitializes Transmission packet.  Required before usage.}

</i></font><font color="#FF0000"><b>procedure </b></font>InitReceivePacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>ecb<font color="#000080">:</font>ecbType<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ipx<font color="#000080">:</font>ipxHeader<font color="#000080">; </font>size<font color="#000080">, </font>sock<font color="#000080">:</font>word<font color="#000080">);
</font><font color="#008000"><i>{Constructs and preinitializes reception packet.  Required before usage.}

</i></font><font color="#FF0000"><b>function  </b></font>IPXopenSocket<font color="#000080">(</font>longevity <font color="#000080">: </font>byte<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>socketNumber <font color="#000080">: </font>word<font color="#000080">):</font>byte<font color="#000080">;
</font><font color="#008000"><i>{Open a socket for use.  You must open a socket to use the IPX.
   LONGEVITY is 0 for open until close or terminate, FF for open until
   close.  TSRs need to use FF, non-resident programs should use 0.
   SOCKETNUMBER can by 0000 for dynamic allocation.  Retunrs 0 if
   successful.}

</i></font><font color="#FF0000"><b>procedure </b></font>IPXcloseSocket<font color="#000080">(</font>socketNumber <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#008000"><i>{Closes SOCKETNUMBER socket.  This cancels all pending events set by any
   ECBs.  Applications should close all sockets before termination.}

</i></font><font color="#FF0000"><b>procedure </b></font>IPXsendPacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>E <font color="#000080">: </font>ECBtype<font color="#000080">);
</font><font color="#008000"><i>{E is an ECB.  This procedure attemps to send a packet in the background,
   therefore it always returns imediantly.}

</i></font><font color="#FF0000"><b>function  </b></font>IPXlistenForPacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>E <font color="#000080">: </font>ECBtype<font color="#000080">):</font>byte<font color="#000080">;
</font><font color="#008000"><i>{E is an ECB.  Returns 00 if successful else FF.  This provides the IPX
   with an ECB for recieving an IPX packet, but does not wait for a
   packet to arrive.  The calling app must have opend a socket and
   initilizied the ECB.  There is no limit to the number of packets that
   can be listening on the same socket.}

</i></font><font color="#FF0000"><b>procedure </b></font>GetLocalAddress<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>localAddr<font color="#000080">:</font>localAddrT<font color="#000080">);
</font><font color="#008000"><i>{Returns intrernetwork address.}

</i></font><font color="#FF0000"><b>procedure </b></font>Idle<font color="#000080">;
</font><font color="#008000"><i>{This call returns nothing but tells the IPX driver that the app is idle
   and permits the IPX driver to do some work.}


</i></font><font color="#FF0000"><b>implementation

function  </b></font>IPXopenSocket<font color="#000080">(</font>longevity <font color="#000080">: </font>byte<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>socketNumber <font color="#000080">: </font>word<font color="#000080">):</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>return<font color="#000080">:</font>byte<font color="#000080">;
   </font>n<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>n<font color="#000080">:= </font>swap<font color="#000080">(</font>socketnumber<font color="#000080">);
   </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov bx, 0000h;
      mov al, longevity;
      mov dx, n;
      call API;
      mov return, al;
      mov n, dx;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>socketnumber<font color="#000080">:= </font>swap<font color="#000080">(</font>n<font color="#000080">);
   </font>IPXOpenSocket<font color="#000080">:= </font>return<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>IPXcloseSocket<font color="#000080">(</font>socketNumber <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>socketnumber<font color="#000080">:= </font>swap<font color="#000080">(</font>socketnumber<font color="#000080">);
   </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov bx, 0001h;
      mov dx, socketnumber;
      call API;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>IPXsendPacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>E <font color="#000080">: </font>ECBtype<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>t1<font color="#000080">:= </font>seg<font color="#000080">(</font>e<font color="#000080">);
   </font>t2<font color="#000080">:= </font>ofs<font color="#000080">(</font>e<font color="#000080">);
   </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov bx, 0003h;
      mov es, t1;
      mov si, t2;
      call API;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function  </b></font>IPXlistenForPacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>E <font color="#000080">: </font>ECBtype<font color="#000080">):</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>return<font color="#000080">:</font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>t1<font color="#000080">:= </font>seg<font color="#000080">(</font>e<font color="#000080">);
   </font>t2<font color="#000080">:= </font>ofs<font color="#000080">(</font>e<font color="#000080">);
   </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov bx, 0004h;
      mov es, t1;
      mov si, t2;
      call API;
      mov return, al;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>IPXListenforPacket<font color="#000080">:= </font>return<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetLocalAddress<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>localAddr<font color="#000080">:</font>localAddrT<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>t1<font color="#000080">:= </font>seg<font color="#000080">(</font>localaddr<font color="#000080">);
   </font>t2<font color="#000080">:= </font>ofs<font color="#000080">(</font>localaddr<font color="#000080">);
   </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov bx, 0009h;
      mov es, t1;
      mov si, t2;
      call API;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>Idle<font color="#000080">;
</font><font color="#FF0000"><b>begin
   asm
      </b></font><font color="#FF00FF">mov bx, 000Ah;
      call API;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>InitSendPacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>ecb <font color="#000080">: </font>ecbType<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ipx <font color="#000080">: </font>ipxHeader<font color="#000080">; </font>size<font color="#000080">,</font>sock <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
</b></font>	fillChar<font color="#000080">(</font>ecb<font color="#000080">,</font>sizeOf<font color="#000080">(</font>ecb<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
</font>	fillChar<font color="#000080">(</font>ipx<font color="#000080">,</font>sizeOf<font color="#000080">(</font>ipx<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
</font>	<font color="#FF0000"><b>with </b></font>ecb <font color="#FF0000"><b>do begin
</b></font>		socket<font color="#000080">:=</font>swap<font color="#000080">(</font>sock<font color="#000080">);               </font><font color="#008000"><i>{ Big endian socket number }
</i></font>		fragCount<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;                     </font><font color="#008000"><i>{ Fragment count }
</i></font>		fragData<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>ofs<font color="#000080">(</font>IPX<font color="#000080">);            </font><font color="#008000"><i>{ Pointer to data fragment }
</i></font>		fragData<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:=</font>seg<font color="#000080">(</font>IPX<font color="#000080">);
</font>		fragSize<font color="#000080">:=</font>sizeof<font color="#000080">(</font>IPX<font color="#000080">)+</font>size<font color="#000080">;       </font><font color="#008000"><i>{ Size of data fragment }
</i></font>		immedAddr<font color="#000080">:=</font>BROADCAST<font color="#000080">;             </font><font color="#008000"><i>{ Needs to be BROADCAST?? }
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	<font color="#FF0000"><b>with </b></font>ipx <font color="#FF0000"><b>do begin
</b></font>		check<font color="#000080">:=</font><font color="#800000">$ffff</font><font color="#000080">;                     </font><font color="#008000"><i>{ NO CHECKSUM }
</i></font>		ptype<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;                         </font><font color="#008000"><i>{ Packet exchange packet }
</i></font>		dest<font color="#000080">.</font>net<font color="#000080">:=</font>localAddr<font color="#000080">.</font>net<font color="#000080">;          </font><font color="#008000"><i>{ Send to this network }
</i></font>		dest<font color="#000080">.</font>node<font color="#000080">:=</font>BROADCAST<font color="#000080">;             </font><font color="#008000"><i>{ Send to everybody! }
</i></font>		dest<font color="#000080">.</font>socket<font color="#000080">:=</font>swap<font color="#000080">(</font>sock<font color="#000080">);          </font><font color="#008000"><i>{ Send to my socket }
</i></font>		src<font color="#000080">.</font>net<font color="#000080">:=</font>localAddr<font color="#000080">.</font>net<font color="#000080">;           </font><font color="#008000"><i>{ From this net }
</i></font>		src<font color="#000080">.</font>node<font color="#000080">:=</font>localAddr<font color="#000080">.</font>node<font color="#000080">;         </font><font color="#008000"><i>{ From ME }
</i></font>		src<font color="#000080">.</font>socket<font color="#000080">:=</font>swap<font color="#000080">(</font>sock<font color="#000080">);           </font><font color="#008000"><i>{ From my socket }
</i></font>		<font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>InitReceivePacket<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>ecb <font color="#000080">: </font>ecbType<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>ipx <font color="#000080">: </font>ipxHeader<font color="#000080">; </font>size<font color="#000080">,</font>sock <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>fillChar<font color="#000080">(</font>ecb<font color="#000080">,</font>sizeOf<font color="#000080">(</font>ecb<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font>fillChar<font color="#000080">(</font>ipx<font color="#000080">,</font>sizeOf<font color="#000080">(</font>ipx<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);
  </font><font color="#FF0000"><b>with </b></font>ecb <font color="#FF0000"><b>do begin
</b></font>	inUse<font color="#000080">:=</font><font color="#800000">$1d</font><font color="#000080">;                               </font><font color="#008000"><i>{ ???? }
</i></font>	socket<font color="#000080">:=</font>swap<font color="#000080">(</font>sock<font color="#000080">);                       </font><font color="#008000"><i>{ Big endian socket number }
</i></font>	fragCount<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;                             </font><font color="#008000"><i>{ Fragment count }
</i></font>	fragData<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>ofs<font color="#000080">(</font>IPX<font color="#000080">);                    </font><font color="#008000"><i>{ Pointer to data fragment }
</i></font>	fragData<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:=</font>seg<font color="#000080">(</font>IPX<font color="#000080">);
</font>	fragSize<font color="#000080">:=</font>sizeof<font color="#000080">(</font>IPX<font color="#000080">)+</font>size<font color="#000080">;               </font><font color="#008000"><i>{ Size of data fragment }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
   </b></font>t<font color="#000080">:</font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
   asm
      </b></font><font color="#FF00FF">mov ax, 7a00h;
      int 2fh;
      mov t, al;
      mov major, es;
      mov minor, bx;
      mov t1, es;
      mov t2, di;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>IPXInstalled<font color="#000080">:= (</font>t<font color="#000080">=</font><font color="#800000">$FF</font><font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>IPXInstalled <font color="#FF0000"><b>then
      begin
         </b></font><font color="#000080">@</font>API<font color="#000080">:= </font>ptr<font color="#000080">(</font>t1<font color="#000080">, </font>t2<font color="#000080">);
         </font>getlocaladdress<font color="#000080">(</font>localaddr<font color="#000080">);
      </font><font color="#FF0000"><b>end
   else
      </b></font><font color="#000080">@</font>API<font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to NETWORK SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p></body>
</html>
