<html>
<head><title> "Text-Device with PChars" by NICK VERMEULEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0101.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
this unit implements a text-device that links to a PChar string. When you
want to use a Pascal string, you can patch it, or convert your string to
PChar before using it. An example is included.
From: master@alterdial.uu.net (Nick Vermeulen)
}
</i></font><font color="#FF0000"><b>Unit </b></font>StrDev<font color="#000080">;
</font><font color="#008000"><i>(*
    This unit allows string manipulation with standard Read/Write proc's,
    using dataconversion and variable parameter-count as implemented by
    Read/Write proc's.

    example:

    Uses Strings, StrDev;

    Var  f: Text;
         s: Array[0..30] of Char;
         i: Integer;

    Begin
      AssignStrDevice(f, s, SizeOf(s));  { link s to f }
      Rewrite(f);                        { s will be overwritten }
      i := 12;
      Write(f, 'testing', i:12);         { write string + integer to s }
      Close(f);                          { NEEDED! buffer flushes to s }
      WriteLn(s);                        { show result }
      Append(f);                         { demonstrate appending }
      Write(f, 'appending!');            { try to make s smaller! }
      Close(f);
      WriteLn(s);
      StrCopy(s, '1 2 3');               { fill s with data }
      Reset(f);                          { open for reading }
      While not Eof(f) Do
      Begin
        Read(f, i);                      { read integers from s }
        WriteLn(i);
      End;
      Close(f);
    End.
*)

</i></font><font color="#FF0000"><b>Interface

Uses </b></font>Strings<font color="#000080">, </font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AssignStrDevice<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>T<font color="#000080">: </font>Text<font color="#000080">; </font>aStr<font color="#000080">: </font>PChar<font color="#000080">; </font>aSize<font color="#000080">: </font>Word<font color="#000080">);

</font><font color="#FF0000"><b>Implementation

Type
  </b></font>UData <font color="#000080">= </font><font color="#FF0000"><b>Record          </b></font><font color="#008000"><i>{ typecasted over device's UserData (16 bytes) }
            </i></font>Str  <font color="#000080">: </font>PChar<font color="#000080">; </font><font color="#008000"><i>{ 4 bytes, string to use }
            </i></font>Size <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ 2 bytes, size of the string }
            </i></font>p    <font color="#000080">: </font>PChar<font color="#000080">; </font><font color="#008000"><i>{ 4 bytes, current pos in string }
            </i></font>fill <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>WindowRead<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>TextRec<font color="#000080">): </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#008000"><i>{}
</i></font><font color="#FF0000"><b>Begin
  With </b></font>F<font color="#000080">, </font>UData<font color="#000080">(</font>UserData<font color="#000080">) </font><font color="#FF0000"><b>Do
  Begin
    </b></font>BufEnd <font color="#000080">:= </font>StrEnd<font color="#000080">(</font>Str<font color="#000080">)-</font>p<font color="#000080">;
    </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>BufEnd <font color="#000080">&gt; </font>BufSize<font color="#000080">) </font><font color="#FF0000"><b>Then
      </b></font>BufEnd <font color="#000080">:= </font>BufSize<font color="#000080">;
    </font>BufPos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>StrLCopy<font color="#000080">(</font>PChar<font color="#000080">(</font>BufPtr<font color="#000080">), </font>p<font color="#000080">, </font>BufEnd<font color="#000080">);
    </font>Inc<font color="#000080">(</font>p<font color="#000080">, </font>BufEnd<font color="#000080">);
    </font>WindowRead <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>WindowWrite<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>TextRec<font color="#000080">): </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#008000"><i>{}
</i></font><font color="#FF0000"><b>Begin
  With </b></font>F<font color="#000080">, </font>UData<font color="#000080">(</font>UserData<font color="#000080">) </font><font color="#FF0000"><b>do
  Begin
    </b></font>StrLCopy<font color="#000080">(</font>p<font color="#000080">, </font>PChar<font color="#000080">(</font>BufPtr<font color="#000080">), </font>Size<font color="#000080">-(</font>p<font color="#000080">-</font>Str<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
    </font>Inc<font color="#000080">(</font>p<font color="#000080">, </font>Size<font color="#000080">-(</font>p<font color="#000080">-</font>Str<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
    </font>BufPos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>WindowWrite <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>WindowOpen<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>TextRec<font color="#000080">): </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#008000"><i>{}
</i></font><font color="#FF0000"><b>Begin
  </b></font>WindowOpen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>With </b></font>F<font color="#000080">, </font>UData<font color="#000080">(</font>UserData<font color="#000080">) </font><font color="#FF0000"><b>do
  Begin
    Case </b></font>Mode <font color="#FF0000"><b>of
      </b></font>fmInput<font color="#000080">:
        </font><font color="#FF0000"><b>Begin
          </b></font>InOutFunc <font color="#000080">:= @</font>WindowRead<font color="#000080">;
          </font>FlushFunc <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
          </font>p         <font color="#000080">:= </font>Str<font color="#000080">;
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font>fmInOut<font color="#000080">:
        </font><font color="#FF0000"><b>Begin
          </b></font>InOutFunc <font color="#000080">:= @</font>WindowWrite<font color="#000080">;
          </font>FlushFunc <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
          </font>Mode      <font color="#000080">:= </font>fmOutput<font color="#000080">;
          </font>p         <font color="#000080">:= </font>StrEnd<font color="#000080">(</font>Str<font color="#000080">);
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font>fmOutput<font color="#000080">:
        </font><font color="#FF0000"><b>Begin
          </b></font>InOutFunc  <font color="#000080">:= @</font>WindowWrite<font color="#000080">;
          </font>FlushFunc  <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
          </font>p          <font color="#000080">:= </font>Str<font color="#000080">;
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>WindowClose<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>TextRec<font color="#000080">): </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#008000"><i>{}
</i></font><font color="#FF0000"><b>Begin
  </b></font>WindowClose <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AssignStrDevice<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>T<font color="#000080">: </font>Text<font color="#000080">; </font>aStr<font color="#000080">: </font>PChar<font color="#000080">; </font>aSize<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#008000"><i>{}
</i></font><font color="#FF0000"><b>Begin
  With </b></font>TextRec<font color="#000080">(</font>T<font color="#000080">), </font>UData<font color="#000080">(</font>UserData<font color="#000080">) </font><font color="#FF0000"><b>do
  Begin
    </b></font>Handle <font color="#000080">:= </font><font color="#800000">$FFFF</font><font color="#000080">;
    </font>Mode <font color="#000080">:= </font>fmClosed<font color="#000080">;
    </font>BufSize <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>Buffer<font color="#000080">);
    </font>BufPtr <font color="#000080">:= @</font>Buffer<font color="#000080">;
    </font>Str <font color="#000080">:= </font>aStr<font color="#000080">;
    </font>Size <font color="#000080">:= </font>aSize<font color="#000080">;
    </font>OpenFunc <font color="#000080">:= @</font>WindowOpen<font color="#000080">;
    </font>CloseFunc <font color="#000080">:= @</font>WindowClose<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0101.PAS">Original</a><b>]</b></p></body>
</html>
