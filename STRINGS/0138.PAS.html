<html>
<head><title> "Fast Searching for a String" by SCOTT BUSSINGER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0138.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{$R-,S+,I-,D-,T-,F-,V-,B-,N-}

</i></font><font color="#FF0000"><b>unit </b></font>Searches<font color="#000080">;

</font><font color="#008000"><i>{ A unit for rapidly searching a buffer for a string.

  Version 1.00 - 10/26/1987 - First general release

  Scott Bussinger
  Professional Practice Systems
  110 South 131st Street
  Tacoma, WA  98444
  (206)531-8944
  Compuserve 72247,2671

  BlockPos was originally written by Randy Forgaard for use with Turbo
  Pascal version 3.0.

  The Boyer-Moore routines were originally written by Van Hall for Turbo
  Pascal version 3.0 and have been extensively rearranged for optimum use
  with Turbo Pascal 4.0.  Note that the Boyer-Moore routines are MUCH, MUCH
  slower than using BlockPos (which is written with inline code). }


</i></font><font color="#FF0000"><b>interface

function </b></font>BlockPos<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">;</font>Size<font color="#000080">: </font>word<font color="#000080">;</font>S<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">): </font>integer<font color="#000080">;
  </font><font color="#008000"><i>{ Search in Buffer of Size bytes for the string S }

</i></font><font color="#FF0000"><b>type </b></font>BoyerTable <font color="#000080">= </font><font color="#FF0000"><b>record
       </b></font>Match<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
       </font>MatchLength<font color="#000080">: </font>byte<font color="#000080">;
       </font>Table<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>char<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte
       <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>MakeBoyerTable<font color="#000080">(</font>MatchString<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font><font color="#FF0000"><b>var </b></font>Table<font color="#000080">: </font>BoyerTable<font color="#000080">);
  </font><font color="#008000"><i>{ Generate the necessary table for doing a Boyer-Moore search }

</i></font><font color="#FF0000"><b>function </b></font>BoyerMoore<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>BufferAddr<font color="#000080">;</font>Size<font color="#000080">: </font>word<font color="#000080">;</font>Start<font color="#000080">: </font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>Table<font color="#000080">: </font>BoyerTable<font color="#000080">): </font>word<font color="#000080">;
  </font><font color="#008000"><i>{ Search a Buffer of Size characters beginning at Start for the match string defined in Table }


</i></font><font color="#FF0000"><b>implementation

function </b></font>BlockPos<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">;</font>Size<font color="#000080">: </font>word<font color="#000080">;</font>S<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">): </font>integer<font color="#000080">;
  </font><font color="#008000"><i>{ Search in Buffer of Size bytes for the string S }
  </i></font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Load &quot;buffer&quot; address into ES:DI, &quot;buffer&quot; offset into BX, Length(s) -
    1 into DX, contents of &quot;s[1]&quot; into AL, offset of &quot;s[2]&quot; into SI, and
    &quot;size&quot; - Length(s) + 1 into CX.  If &quot;size&quot; &lt; Length(s), or if
    Length(s) = 0, return zero. }

  </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$1E</font><font color="#000080">/               </font><font color="#008000"><i>{        PUSH    DS           }
         </i></font><font color="#800000">$16</font><font color="#000080">/               </font><font color="#008000"><i>{        PUSH    SS           }
         </i></font><font color="#800000">$1F</font><font color="#000080">/               </font><font color="#008000"><i>{        POP     DS           }
         </i></font><font color="#800000">$C4</font><font color="#000080">/</font><font color="#800000">$BE</font><font color="#000080">/&gt;</font>buffer<font color="#000080">/   </font><font color="#008000"><i>{        LES     DI,buffer[BP]}
         </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$FB</font><font color="#000080">/           </font><font color="#008000"><i>{        MOV     BX,DI        }
         </i></font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$8E</font><font color="#000080">/&gt;</font>size<font color="#000080">/     </font><font color="#008000"><i>{        MOV     CX,size[bp]  }
         </i></font><font color="#800000">$8D</font><font color="#000080">/</font><font color="#800000">$B6</font><font color="#000080">/&gt;</font>s<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">/      </font><font color="#008000"><i>{        LEA     SI,s+2[bp]   }
         </i></font><font color="#800000">$8A</font><font color="#000080">/</font><font color="#800000">$86</font><font color="#000080">/&gt;</font>s<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">/      </font><font color="#008000"><i>{        MOV     AL,s+1[bp]   }
         </i></font><font color="#800000">$8A</font><font color="#000080">/</font><font color="#800000">$96</font><font color="#000080">/&gt;</font>s<font color="#000080">/        </font><font color="#008000"><i>{        MOV     DL,s[bp]     }
         </i></font><font color="#800000">$84</font><font color="#000080">/</font><font color="#800000">$D2</font><font color="#000080">/           </font><font color="#008000"><i>{        TEST    DL,DL        }
         </i></font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$23</font><font color="#000080">/           </font><font color="#008000"><i>{        JZ      ERROR        }
         </i></font><font color="#800000">$FE</font><font color="#000080">/</font><font color="#800000">$CA</font><font color="#000080">/           </font><font color="#008000"><i>{        DEC     DL           }
         </i></font><font color="#800000">$30</font><font color="#000080">/</font><font color="#800000">$F6</font><font color="#000080">/           </font><font color="#008000"><i>{        XOR     DH,DH        }
         </i></font><font color="#800000">$29</font><font color="#000080">/</font><font color="#800000">$D1</font><font color="#000080">/           </font><font color="#008000"><i>{        SUB     CX,DX        }
         </i></font><font color="#800000">$76</font><font color="#000080">/</font><font color="#800000">$1B</font><font color="#000080">/           </font><font color="#008000"><i>{        JBE     ERROR        }

  { Scan the ES:DI buffer, looking for the first occurrence of &quot;s[1].&quot;  If
    not found prior to reaching Length(s) characters before the end of the
    buffer, return zero.  If Length(s) = 1, the entire string has been
    found, so report success. }

       </i></font><font color="#800000">$FC</font><font color="#000080">/               </font><font color="#008000"><i>{        CLD                  }
       </i></font><font color="#800000">$F2</font><font color="#000080">/               </font><font color="#008000"><i>{NEXT:   REPNE                }
       </i></font><font color="#800000">$AE</font><font color="#000080">/               </font><font color="#008000"><i>{        SCASB                }
       </i></font><font color="#800000">$75</font><font color="#000080">/</font><font color="#800000">$16</font><font color="#000080">/           </font><font color="#008000"><i>{        JNE     ERROR        }
       </i></font><font color="#800000">$85</font><font color="#000080">/</font><font color="#800000">$D2</font><font color="#000080">/           </font><font color="#008000"><i>{        TEST    DX,DX        }
       </i></font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$0C</font><font color="#000080">/           </font><font color="#008000"><i>{        JZ      FOUND        }

  { Compare &quot;s&quot; (which is at SS:SI) with the ES:DI buffer, in both cases
    starting with the first byte just past the length byte of the string.
    If &quot;s&quot; does not match what is at the DI position of the buffer, reset
    the registers to the values they had just prior to the comparison, and
    look again for the next occurrence of the length byte. }

         </i></font><font color="#800000">$51</font><font color="#000080">/               </font><font color="#008000"><i>{        PUSH    CX           }
         </i></font><font color="#800000">$57</font><font color="#000080">/               </font><font color="#008000"><i>{        PUSH    DI           }
         </i></font><font color="#800000">$56</font><font color="#000080">/               </font><font color="#008000"><i>{        PUSH    SI           }
         </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$D1</font><font color="#000080">/           </font><font color="#008000"><i>{        MOV     CX,DX        }
         </i></font><font color="#800000">$F3</font><font color="#000080">/               </font><font color="#008000"><i>{        REPE                 }
         </i></font><font color="#800000">$A6</font><font color="#000080">/               </font><font color="#008000"><i>{        CMPSB                }
         </i></font><font color="#800000">$5E</font><font color="#000080">/               </font><font color="#008000"><i>{        POP     SI           }
         </i></font><font color="#800000">$5F</font><font color="#000080">/               </font><font color="#008000"><i>{        POP     DI           }
         </i></font><font color="#800000">$59</font><font color="#000080">/               </font><font color="#008000"><i>{        POP     CX           }
         </i></font><font color="#800000">$75</font><font color="#000080">/</font><font color="#800000">$EC</font><font color="#000080">/           </font><font color="#008000"><i>{        JNE     NEXT         }

  { String found in buffer.  Set AX to the offset, within buffer, of the
    first byte of the string (the length byte), assuming that the first
    byte of the buffer is at offset 1. }

         </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$F8</font><font color="#000080">/           </font><font color="#008000"><i>{FOUND:  MOV     AX,DI        }
         </i></font><font color="#800000">$29</font><font color="#000080">/</font><font color="#800000">$D8</font><font color="#000080">/           </font><font color="#008000"><i>{        SUB     AX,BX        }
         </i></font><font color="#800000">$EB</font><font color="#000080">/</font><font color="#800000">$02</font><font color="#000080">/           </font><font color="#008000"><i>{        JMP     SHORT RETURN }

  { An &quot;error&quot; condition.  Return zero. }

         </i></font><font color="#800000">$31</font><font color="#000080">/</font><font color="#800000">$C0</font><font color="#000080">/           </font><font color="#008000"><i>{ERROR:  XOR     AX,AX        }
         </i></font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$46</font><font color="#000080">/</font><font color="#800000">$FE</font><font color="#000080">/       </font><font color="#008000"><i>{RETURN: MOV     [BP-2],AX    }
         </i></font><font color="#800000">$1F</font><font color="#000080">)               </font><font color="#008000"><i>{        POP     DS           }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>MakeBoyerTable<font color="#000080">(</font>MatchString<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font><font color="#FF0000"><b>var </b></font>Table<font color="#000080">: </font>BoyerTable<font color="#000080">);
  </font><font color="#008000"><i>{ Generate the necessary table for doing a Boyer-Moore search }
  </i></font><font color="#FF0000"><b>var </b></font>Counter<font color="#000080">: </font>byte<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  with </b></font>Table <font color="#FF0000"><b>do
    begin
    </b></font>Match <font color="#000080">:= </font>MatchString<font color="#000080">;
    </font>MatchLength <font color="#000080">:= </font>length<font color="#000080">(</font>MatchString<font color="#000080">);
    </font>fillChar<font color="#000080">(</font>Table<font color="#000080">,</font>sizeof<font color="#000080">(</font>Table<font color="#000080">),</font>MatchLength<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>MatchLength <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      for </b></font>Counter <font color="#000080">:= </font>pred<font color="#000080">(</font>MatchLength<font color="#000080">) </font><font color="#FF0000"><b>downto </b></font><font color="#800000">1 </font><font color="#FF0000"><b>do
        if </b></font>Table<font color="#000080">[</font>Match<font color="#000080">[</font>Counter<font color="#000080">]] = </font>MatchLength <font color="#FF0000"><b>then
            </b></font>Table<font color="#000080">[</font>Match<font color="#000080">[</font>Counter<font color="#000080">]] := </font>MatchLength<font color="#000080">-</font>Counter
    <font color="#FF0000"><b>end
  end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>BoyerMoore<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>BufferAddr<font color="#000080">;</font>Size<font color="#000080">: </font>word<font color="#000080">;</font>Start<font color="#000080">: </font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>Table<font color="#000080">: </font>BoyerTable<font color="#000080">): </font>word<font color="#000080">;
  </font><font color="#008000"><i>{ Search a Buffer of Size characters beginning at Start for the match string defined in Table }
  </i></font><font color="#FF0000"><b>type </b></font>Ptr <font color="#000080">= </font><font color="#FF0000"><b>record
         case </b></font>integer <font color="#FF0000"><b>of
           </b></font><font color="#800000">0</font><font color="#000080">: (</font>Ptr<font color="#000080">: ^</font>char<font color="#000080">);
           </font><font color="#800000">1</font><font color="#000080">: (</font>Offset<font color="#000080">: </font>word<font color="#000080">;
               </font>Segment<font color="#000080">: </font>word<font color="#000080">)
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>var </b></font>Buffer<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">$FFF1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#FF0000"><b>absolute </b></font>BufferAddr<font color="#000080">;
      </font>BufferPtr<font color="#000080">: </font>Ptr<font color="#000080">;
      </font>BufferEndOfs<font color="#000080">: </font>word<font color="#000080">;
      </font>MatchPtr<font color="#000080">: </font>Ptr<font color="#000080">;
      </font>MatchEndPtr<font color="#000080">: </font>Ptr<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  with </b></font>Table <font color="#FF0000"><b>do
    if </b></font>MatchLength <font color="#000080">= </font><font color="#800000">0                           </font><font color="#008000"><i>{ Are we looking for an empty string? }
     </i></font><font color="#FF0000"><b>then
      </b></font>BoyerMoore <font color="#000080">:= </font><font color="#800000">0
     </font><font color="#FF0000"><b>else
      begin
      </b></font>MatchEndPtr<font color="#000080">.</font>Ptr <font color="#000080">:= @</font>Match<font color="#000080">[</font>MatchLength<font color="#000080">];
      </font>MatchPtr <font color="#000080">:= </font>MatchEndPtr<font color="#000080">;
      </font>BufferPtr<font color="#000080">.</font>Ptr <font color="#000080">:= @</font>Buffer<font color="#000080">[</font>pred<font color="#000080">(</font>Start<font color="#000080">+</font>MatchLength<font color="#000080">)];
      </font>BufferEndOfs <font color="#000080">:= </font>ofs<font color="#000080">(</font>Buffer<font color="#000080">[</font>Size<font color="#000080">]);
      </font><font color="#FF0000"><b>repeat
        if </b></font>BufferPtr<font color="#000080">.</font>Ptr<font color="#000080">^ = </font>MatchPtr<font color="#000080">.</font>Ptr<font color="#000080">^
         </font><font color="#FF0000"><b>then
          begin
          </b></font>dec<font color="#000080">(</font>BufferPtr<font color="#000080">.</font>Offset<font color="#000080">);
          </font>dec<font color="#000080">(</font>MatchPtr<font color="#000080">.</font>Offset<font color="#000080">)
          </font><font color="#FF0000"><b>end
         else
          begin
          </b></font>MatchPtr <font color="#000080">:= </font>MatchEndPtr<font color="#000080">;
          </font>inc<font color="#000080">(</font>BufferPtr<font color="#000080">.</font>Offset<font color="#000080">,</font>Table<font color="#000080">[</font>BufferPtr<font color="#000080">.</font>Ptr<font color="#000080">^])
          </font><font color="#FF0000"><b>end
      until </b></font><font color="#000080">(</font>MatchPtr<font color="#000080">.</font>Ptr<font color="#000080">=@</font>Match<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>ofs<font color="#000080">(</font>BufferPtr<font color="#000080">.</font>Ptr<font color="#000080">^)&gt;=</font>BufferEndOfs<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>MatchPtr<font color="#000080">.</font>Ptr <font color="#000080">= @</font>Match
       <font color="#FF0000"><b>then
        </b></font>BoyerMoore <font color="#000080">:= </font>ofs<font color="#000080">(</font>BufferPtr<font color="#000080">.</font>Ptr<font color="#000080">^) - </font>ofs<font color="#000080">(</font>Buffer<font color="#000080">) + </font><font color="#800000">2
       </font><font color="#FF0000"><b>else
        </b></font>BoyerMoore <font color="#000080">:= </font><font color="#800000">0
      </font><font color="#FF0000"><b>end
  end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0138.PAS">Original</a><b>]</b></p></body>
</html>
