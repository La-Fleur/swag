<html>
<head><title> "Strnig Patterns" by WILLIAM ARTHUR BARATH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0112.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Unit </b></font>USPat<font color="#000080">; </font><font color="#008000"><i>{String pattern a-la Messy-DOS}
{ (C) 1994 William Arthur Barath.   Permission granted for free use in
  Commercial and Non-Commercial software. }

{ written oct 17/94 for TOMMY by WSEM at the request of Weird Al}
{ For use in UFO's text/file scanner.  Fast enough? }

</i></font><font color="#FF0000"><b>Interface

Type </b></font>pString <font color="#000080">= ^</font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Var </b></font>SpatStr<font color="#000080">:</font>pString<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>UpCaseStr<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#008000"><i>{call to convert a VAR ARG string to upper case.  Don't use w/ PCHAR!}
</i></font><font color="#FF0000"><b>Procedure </b></font>SetSPat<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#008000"><i>{call to set the pattern to test against with each following call to
 Spat.  This sets a global pointer to the given string and converts that
 string to a format that can be read optimally fast, which saves passing
 the pattern arguement to the SPat PROC via the stack, which saves many
 many clock cycles and memory R\W accesses. 'S' *must* be a string of at
 least 12 characters, or a typecast region of memory of at least 13 bytes
 formatted as a Pascal-style STRING or ugly things may happen.}
</i></font><font color="#FF0000"><b>Function </b></font>SPat<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Boolean<font color="#000080">;
</font><font color="#008000"><i>{tests the given VAR ARG string against the string pattern pointed to by
 the Public SpatStr global pointer.  Passing a VAR ARG takes much less
 time since only a 4-byte pointer is pushed onto the stack prior to calling
 this PROC, as opposed to a full STRING, which may be 256 bytes and would 
be
 pushed a single char at a time... yawn...}
</i></font><font color="#FF0000"><b>Function </b></font>UCSPat<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Boolean<font color="#000080">;
</font><font color="#008000"><i>{tests the given VAR ARG string against the string pattern pointed to by
 the Public SpatStr global pointer.  Passing a VAR ARG takes much less
 time since only a 4-byte pointer is pushed onto the stack prior to calling
 this PROC, as opposed to a full STRING, which may be 256 bytes and would 
be
 pushed a single char at a time... yawn... Works with UPCASE'd data}

</i></font><font color="#FF0000"><b>Implementation

Procedure </b></font>UpCaseStr<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#008000"><i>{up to 15 times faster than Borland's ASM demo code}
</i></font><font color="#FF0000"><b>asm </b></font><font color="#FF00FF">Push ds;Lds si,s;Xor ch,ch;Lodsb;Mov cl,al;Jcxz @Done;Mov dx,'az';
Mov ah,'a'-'A';Mov bx,-1;@Loop: Lodsb;Cmp al,dh;Jb @Upper;Cmp al,dl;
ja @Upper;Sub al,ah;Mov [si+bx],al;@Upper: Loop @Loop;@Done: Pop ds;</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetSPat<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#008000"><i>{I'd write this in ASM as well, but it isn't likely to enter a loop so
 speed isn't really critical, and it may be useful to edit this to alter
 the personality of the pattern matching algorhythm.}
</i></font><font color="#FF0000"><b>Type </b></font>str12 <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">12</font><font color="#000080">];
</font><font color="#FF0000"><b>Var </b></font>l<font color="#000080">,</font>p<font color="#000080">:</font>Word<font color="#000080">;</font>pat<font color="#000080">:</font>Str12<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  If </b></font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]=</font><font color="#800000">#0 </font><font color="#FF0000"><b>then </b></font>s<font color="#000080">:=</font><font color="#800000">'*.*'</font><font color="#000080">;
   </font>UpCaseStr<font color="#000080">(</font>s<font color="#000080">);</font>p<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>For </b></font>l<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">12 </font><font color="#FF0000"><b>do Case </b></font>s<font color="#000080">[</font>p<font color="#000080">] </font><font color="#FF0000"><b>of
     </b></font><font color="#800000">'*'</font><font color="#000080">:</font><font color="#FF0000"><b>If </b></font>l<font color="#000080">=</font><font color="#800000">9 </font><font color="#FF0000"><b>then Begin </b></font>Dec<font color="#000080">(</font>l<font color="#000080">);</font>Inc<font color="#000080">(</font>p<font color="#000080">);</font><font color="#FF0000"><b>end else </b></font>pat<font color="#000080">[</font>l<font color="#000080">]:=</font><font color="#800000">'?'</font><font color="#000080">;
     </font><font color="#800000">'.'</font><font color="#000080">:</font><font color="#FF0000"><b>If </b></font>l<font color="#000080">=</font><font color="#800000">9 </font><font color="#FF0000"><b>then Begin </b></font>pat<font color="#000080">[</font>l<font color="#000080">]:=</font><font color="#800000">'.'</font><font color="#000080">;</font>Inc <font color="#000080">(</font>p<font color="#000080">);</font><font color="#FF0000"><b>end else </b></font>pat<font color="#000080">[</font>l<font color="#000080">]:=</font><font color="#800000">' '</font><font color="#000080">;
     </font><font color="#FF0000"><b>Else Begin </b></font>pat<font color="#000080">[</font>l<font color="#000080">]:=</font>s<font color="#000080">[</font>p<font color="#000080">];</font><font color="#FF0000"><b>If </b></font>Char<font color="#000080">(</font>p<font color="#000080">)&lt;</font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] </font><font color="#FF0000"><b>then </b></font>Inc<font color="#000080">(</font>p<font color="#000080">);</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Pat<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>Char<font color="#000080">(</font>l<font color="#000080">);
  </font>s<font color="#000080">:=</font>pat<font color="#000080">;</font>SPatStr<font color="#000080">:=@</font>s<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SPat<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Boolean<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">Push ds           </font><font color="#008000"><i>{do this or die... :-) }
    </i></font><font color="#FF00FF">Lds si,SpatStr  </font><font color="#008000"><i>{location of the pattern string}
    </i></font><font color="#FF00FF">Les di,s        </font><font color="#008000"><i>{location of the test string}
    </i></font><font color="#FF00FF">Lodsb
    Mov cl,es:[di]  </font><font color="#008000"><i>{length of the test string}
    </i></font><font color="#FF00FF">xor ch,ch
    Jcxz @BadMatch  </font><font color="#008000"><i>{if the test string is NULL then never match}
    </i></font><font color="#FF00FF">Inc di
@Search:
    Mov ah,es:[di]
    Cmp ah,'a'
    Jb  @Search2
    Cmp ah,'z'
    Ja  @Search2
    Sub ah,'a'-'A'  </font><font color="#008000"><i>{convert the test string char to CAPS}
</i></font><font color="#FF00FF">@Search2:
    Lodsb           </font><font color="#008000"><i>{read and advance a char in pattern}
    </i></font><font color="#FF00FF">Cmp ah,al
    Jz  @Match2     </font><font color="#008000"><i>{if the characters are = }
    </i></font><font color="#FF00FF">Cmp al,'?'
    Jnz @BadMatch   </font><font color="#008000"><i>{pattern didn't match}
</i></font><font color="#FF00FF">@Match:
    Cmp ah,'.'      </font><font color="#008000"><i>{if '?' tries to match a dot, we try the next}
    </i></font><font color="#FF00FF">jz  @search2    </font><font color="#008000"><i>{char, which should be either '.' or '?'}
</i></font><font color="#FF00FF">@Match2:
    Inc di          </font><font color="#008000"><i>{advance to the next test string char}
    </i></font><font color="#FF00FF">Loop @Search    </font><font color="#008000"><i>{test for # of chars in test string}
    </i></font><font color="#FF00FF">Mov al,True
    Jnz @Done       </font><font color="#008000"><i>{return 'True'}
</i></font><font color="#FF00FF">@BadMatch:
    xor ax,ax       </font><font color="#008000"><i>{return 'False'}
</i></font><font color="#FF00FF">@Done:
  Pop ds            </font><font color="#008000"><i>{do this or die... :-) }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>UCSPat<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Boolean<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">Push ds           </font><font color="#008000"><i>{do this or die... :-) }
    </i></font><font color="#FF00FF">Lds si,SpatStr  </font><font color="#008000"><i>{location of the pattern string}
    </i></font><font color="#FF00FF">Les di,s        </font><font color="#008000"><i>{location of the test string}
    </i></font><font color="#FF00FF">Mov cl,[di]     </font><font color="#008000"><i>{length of the test string}
    </i></font><font color="#FF00FF">xor ch,ch
    Jcxz @Bad       </font><font color="#008000"><i>{if the test string is NULL then never match}
    </i></font><font color="#FF00FF">Inc cx          </font><font color="#008000"><i>{use length+1, so when we hit 0 we know we're done}
    </i></font><font color="#FF00FF">CMPSB           </font><font color="#008000"><i>{sneaky way to INC DI and INC SI with one byte :-) }
    </i></font><font color="#FF00FF">Mov dx,'?.'
    Mov bx,-1       </font><font color="#008000"><i>{offset to last character.  faster than using immed. 
data}
</i></font><font color="#FF00FF">@Search:
    REPZ CMPSB      </font><font color="#008000"><i>{compare bytes until one doesn't match or CX = 0}
    </i></font><font color="#FF00FF">Jcxz @Good      </font><font color="#008000"><i>{when we hit 0, we're done.  Last comparison was 
garbage}
    </i></font><font color="#FF00FF">cmp dh,[si+bx]  </font><font color="#008000"><i>{If last pattern byte &lt;&gt; '?' then match is bad}
    </i></font><font color="#FF00FF">Jnz @Bad
    cmp dl,[di+bx]  </font><font color="#008000"><i>{If last test byte &lt;&gt; '.' then check next chars}
    </i></font><font color="#FF00FF">Jnz @Search
    Dec di          </font><font color="#008000"><i>{otherwise, make sure remaining pattern chars}
    </i></font><font color="#FF00FF">Inc cx          </font><font color="#008000"><i>{are '?'.  Otherwise, pattern should fail}
    </i></font><font color="#FF00FF">Jmp @Search
@Good:
    Inc ch          </font><font color="#008000"><i>{change the exit condition in ch from 0 to 1}
</i></font><font color="#FF00FF">@Bad:
    Mov al,ch
  Pop ds            </font><font color="#008000"><i>{do this or die... :-) }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0112.PAS">Original</a><b>]</b></p></body>
</html>
