<html>
<head><title> "Fast String Add Functions" by JOEL LICHTENWALNER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0127.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
    The below listed program tests representives of the various methods
available.  The third method does not check for overflow, but is about 3.0
times faster than those presented so far by my bench mark test.
                           Joel Lichtenwalner in Ogden Utah.

RESULTS (TURBO7 USING [Don't laugh] 386DX 25):
  Test concatenation functions
  Testing Pascal's &quot;+&quot; function Performance = 131.100000 Loops per tick
  Testing STRCONT function Performance = 129.466667 Loops per tick
  Testing ATTACH procedure  Performance = 394.900000 Loops per tick
}
{$A+,N+,R-,S+,V-,X+,Y+}
{$M 16384,0,655360}
</i></font><font color="#FF0000"><b>PROGRAM </b></font>TEST_CONCAT<font color="#000080">;  </font><font color="#008000"><i>{ TESTS VARIOUS METHODS OF CONCATENATING STRINGS }
  </i></font><font color="#FF0000"><b>USES
    </b></font>CRT<font color="#000080">;
  </font><font color="#FF0000"><b>CONST
    </b></font>ADD_STR     <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">[</font><font color="#800000">22</font><font color="#000080">] = </font><font color="#800000">'Test string 1234567890'</font><font color="#000080">;
    </font>TICKS       <font color="#000080">= </font><font color="#800000">90</font><font color="#000080">;           </font><font color="#008000"><i>{ LOOP FOR APPROX 5 SECONDS }
  </i></font><font color="#FF0000"><b>VAR
    </b></font>CLOCK_TICKS <font color="#000080">: </font>WORD <font color="#FF0000"><b>ABSOLUTE </b></font><font color="#800000">$40</font><font color="#000080">:</font><font color="#800000">$6C</font><font color="#000080">;  </font><font color="#008000"><i>{ Updated every 58 ms by system }
    </i></font>TIME_SAVE   <font color="#000080">: </font>WORD<font color="#000080">;         </font><font color="#008000"><i>{ Variable used to keep track of time     }
    </i></font>LOOPS       <font color="#000080">: </font>LONGINT<font color="#000080">;      </font><font color="#008000"><i>{ Loop control counter                    }
    </i></font>TARG        <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">[</font><font color="#800000">255</font><font color="#000080">];  </font><font color="#008000"><i>{ Target string, to be added too          }
    </i></font>COMPUTE     <font color="#000080">: </font>EXTENDED<font color="#000080">;

  </font><font color="#FF0000"><b>function </b></font>strcont<font color="#000080">(</font>s1<font color="#000080">,</font>s2<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">push ds
      cld
      lds si,s1         </font><font color="#008000"><i>{Load addresses of s1}
      </i></font><font color="#FF00FF">les di,s2         </font><font color="#008000"><i>{Load addresses of s2}
      </i></font><font color="#FF00FF">xor ah,ah         </font><font color="#008000"><i>{Clear ah &amp; bh}
      </i></font><font color="#FF00FF">xor bh,bh         </font><font color="#008000"><i>{     &quot;&quot;      }
      </i></font><font color="#FF00FF">mov al,ds:[si]    </font><font color="#008000"><i>{Get the length of first string, copy into al}
      </i></font><font color="#FF00FF">mov bl,es:[di]    </font><font color="#008000"><i>{Get the length of second string, copy into bl}
      </i></font><font color="#FF00FF">add ax,bx         </font><font color="#008000"><i>{Add length of s1 to length s2}
      </i></font><font color="#FF00FF">cmp ax,255        </font><font color="#008000"><i>{Compare}
      </i></font><font color="#FF00FF">ja @toolarge      </font><font color="#008000"><i>{Jump to @toolarge if length(s1)+length(s2)&gt;255}
      </i></font><font color="#FF00FF">les di,@result    </font><font color="#008000"><i>{Copy location of @result into es:di}
      </i></font><font color="#FF00FF">mov cl,1          </font><font color="#008000"><i>{Make sure at least one byte of beginning string}
      </i></font><font color="#FF00FF">xor ch,ch         </font><font color="#008000"><i>{is transferred to @result.}
      </i></font><font color="#FF00FF">add cl,ds:[si]    </font><font color="#008000"><i>{Add length of string to cl.}
      </i></font><font color="#FF00FF">rep movsb         </font><font color="#008000"><i>{Copy first string into @result}
      </i></font><font color="#FF00FF">lds si,s2         </font><font color="#008000"><i>{Get address of second string}
      </i></font><font color="#FF00FF">mov cl,ds:[si]    </font><font color="#008000"><i>{Get length of second string, copy into cl}
      </i></font><font color="#FF00FF">cmp cl,0          </font><font color="#008000"><i>{If second string is blank, skip adding it.}
      </i></font><font color="#FF00FF">je @</font><font color="#FF0000"><b>end           </b></font><font color="#008000"><i>{Jump to end if length of second string is zero.}
      </i></font>inc si            <font color="#008000"><i>{Move pointer (si) to start of second string}
      </i></font>mov al<font color="#000080">,</font>cl         <font color="#008000"><i>{Save length of second string in al}
      </i></font>rep movsb         <font color="#008000"><i>{Copy second string into @result}
      </i></font>lds si<font color="#000080">,@</font>result    <font color="#008000"><i>{Get location of @result}
      </i></font>add ds<font color="#000080">:[</font>si<font color="#000080">],</font>al    <font color="#008000"><i>{Add lengths together}
      </i></font>jmp <font color="#000080">@</font><font color="#FF0000"><b>end          </b></font><font color="#008000"><i>{Skip to end}
     </i></font><font color="#000080">@</font>toolarge<font color="#000080">:         </font><font color="#008000"><i>{If added strings total larger than 255, this sub}
      </i></font>les di<font color="#000080">,@</font>result    <font color="#008000"><i>{is called.}
      </i></font><font color="#FF0000"><b>xor </b></font>al<font color="#000080">,</font>al         <font color="#008000"><i>{Make sure al is a zero.}
      </i></font>mov es<font color="#000080">:[</font>di<font color="#000080">],</font>al    <font color="#008000"><i>{Move a &quot;0&quot; into the beginning of @result, making it}
     </i></font><font color="#000080">@</font><font color="#FF0000"><b>end</b></font><font color="#000080">:              </font><font color="#008000"><i>{a null string.}
      </i></font>pop ds            <font color="#008000"><i>{Return DS to normal so Pascal doesn't screw up.}
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>PROCEDURE </b></font>ATTACH<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>DEST<font color="#000080">,</font>SOURCE<font color="#000080">:</font><font color="#FF0000"><b>STRING</b></font><font color="#000080">);
    </font><font color="#FF0000"><b>VAR
      </b></font>DESTL   <font color="#000080">: </font>BYTE <font color="#FF0000"><b>ABSOLUTE </b></font>DEST<font color="#000080">;
      </font>SOURCEL <font color="#000080">: </font>BYTE <font color="#FF0000"><b>ABSOLUTE </b></font>SOURCE<font color="#000080">;
    </font><font color="#FF0000"><b>BEGIN
      </b></font>MOVE<font color="#000080">(</font>SOURCE<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>DEST<font color="#000080">[</font>SUCC<font color="#000080">(</font>DESTL<font color="#000080">)],</font>SOURCEL<font color="#000080">);
      </font>INC<font color="#000080">(</font>DESTL<font color="#000080">,</font>SOURCEL<font color="#000080">);
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>BEGIN
    </b></font>CLRSCR<font color="#000080">;  </font>WRITELN<font color="#000080">(</font><font color="#800000">'Test concatenation functions'</font><font color="#000080">);
    </font><font color="#008000"><i>{ -------- FIRST TEST -------- }
    </i></font>WRITE<font color="#000080">(</font><font color="#800000">'Testing Pascal''s &quot;+&quot; function'</font><font color="#000080">);
    </font>LOOPS <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>TIME_SAVE <font color="#000080">:= </font>CLOCK_TICKS<font color="#000080">;    </font><font color="#008000"><i>{ WAIT UNTIL THE CLOCK TURNS OVER }
    </i></font><font color="#FF0000"><b>REPEAT UNTIL </b></font>CLOCK_TICKS <font color="#000080">&lt;&gt; </font>TIME_SAVE<font color="#000080">;
    </font>TIME_SAVE <font color="#000080">:= </font>CLOCK_TICKS <font color="#000080">+ </font>TICKS<font color="#000080">;  </font><font color="#008000"><i>{ Set loop time }
      </i></font><font color="#FF0000"><b>REPEAT
      </b></font>TARG <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font>TARG <font color="#000080">:= </font>TARG <font color="#000080">+ </font>ADD_STR<font color="#000080">;  </font><font color="#008000"><i>{  22 }
      </i></font>TARG <font color="#000080">:= </font>TARG <font color="#000080">+ </font>ADD_STR<font color="#000080">;  </font><font color="#008000"><i>{  44 }
      </i></font>TARG <font color="#000080">:= </font>TARG <font color="#000080">+ </font>ADD_STR<font color="#000080">;  </font><font color="#008000"><i>{  66 }
      </i></font>TARG <font color="#000080">:= </font>TARG <font color="#000080">+ </font>ADD_STR<font color="#000080">;  </font><font color="#008000"><i>{  88 }
      </i></font>TARG <font color="#000080">:= </font>TARG <font color="#000080">+ </font>ADD_STR<font color="#000080">;  </font><font color="#008000"><i>{ 110 }
      </i></font>TARG <font color="#000080">:= </font>TARG <font color="#000080">+ </font>TARG<font color="#000080">;     </font><font color="#008000"><i>{ 220 }
      </i></font>TARG <font color="#000080">:= </font>TARG <font color="#000080">+ </font>ADD_STR<font color="#000080">;  </font><font color="#008000"><i>{ 242 }
      </i></font>INC<font color="#000080">(</font>LOOPS<font color="#000080">);
      </font><font color="#FF0000"><b>UNTIL </b></font>CLOCK_TICKS <font color="#000080">= </font>TIME_SAVE<font color="#000080">;
    </font>COMPUTE <font color="#000080">:= </font>LOOPS<font color="#000080">;
    </font>COMPUTE <font color="#000080">:= </font>COMPUTE <font color="#000080">/ </font>TICKS<font color="#000080">;
    </font>WRITELN<font color="#000080">(</font><font color="#800000">' Performance = '</font><font color="#000080">,</font>COMPUTE<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">' Loops per tick'</font><font color="#000080">);
    </font><font color="#008000"><i>{ -------- SECOND TEST -------- }
    </i></font>WRITE<font color="#000080">(</font><font color="#800000">'Testing STRCONT function'</font><font color="#000080">);
    </font>LOOPS <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>TIME_SAVE <font color="#000080">:= </font>CLOCK_TICKS<font color="#000080">;    </font><font color="#008000"><i>{ WAIT UNTIL THE CLOCK TURNS OVER }
    </i></font><font color="#FF0000"><b>REPEAT UNTIL </b></font>CLOCK_TICKS <font color="#000080">&lt;&gt; </font>TIME_SAVE<font color="#000080">;
    </font>TIME_SAVE <font color="#000080">:= </font>CLOCK_TICKS <font color="#000080">+ </font>TICKS<font color="#000080">;  </font><font color="#008000"><i>{ Set loop time }
      </i></font><font color="#FF0000"><b>REPEAT
      </b></font>TARG <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font>TARG <font color="#000080">:= </font>strcont<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  22 }
      </i></font>TARG <font color="#000080">:= </font>strcont<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  44 }
      </i></font>TARG <font color="#000080">:= </font>strcont<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  66 }
      </i></font>TARG <font color="#000080">:= </font>strcont<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  88 }
      </i></font>TARG <font color="#000080">:= </font>strcont<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{ 110 }
      </i></font>TARG <font color="#000080">:= </font>strcont<font color="#000080">(</font>TARG<font color="#000080">,</font>TARG<font color="#000080">);     </font><font color="#008000"><i>{ 220 }
      </i></font>TARG <font color="#000080">:= </font>strcont<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{ 242 }
      </i></font>INC<font color="#000080">(</font>LOOPS<font color="#000080">);
      </font><font color="#FF0000"><b>UNTIL </b></font>CLOCK_TICKS <font color="#000080">= </font>TIME_SAVE<font color="#000080">;
    </font>COMPUTE <font color="#000080">:= </font>LOOPS<font color="#000080">; </font>COMPUTE <font color="#000080">:= </font>COMPUTE <font color="#000080">/ </font>TICKS<font color="#000080">;
    </font>WRITELN<font color="#000080">(</font><font color="#800000">' Performance = '</font><font color="#000080">,</font>COMPUTE<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">' Loops per tick'</font><font color="#000080">);
    </font><font color="#008000"><i>{ -------- THIRD TEST -------- }
    </i></font>WRITE<font color="#000080">(</font><font color="#800000">'Testing ATTACH procedure '</font><font color="#000080">);
    </font>LOOPS <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>TIME_SAVE <font color="#000080">:= </font>CLOCK_TICKS<font color="#000080">;    </font><font color="#008000"><i>{ WAIT UNTIL THE CLOCK TURNS OVER }
    </i></font><font color="#FF0000"><b>REPEAT UNTIL </b></font>CLOCK_TICKS <font color="#000080">&lt;&gt; </font>TIME_SAVE<font color="#000080">;
    </font>TIME_SAVE <font color="#000080">:= </font>CLOCK_TICKS <font color="#000080">+ </font>TICKS<font color="#000080">;  </font><font color="#008000"><i>{ Set loop time }
      </i></font><font color="#FF0000"><b>REPEAT
      </b></font>TARG <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
      </font>ATTACH<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  22 }
      </i></font>ATTACH<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  44 }
      </i></font>ATTACH<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  66 }
      </i></font>ATTACH<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{  88 }
      </i></font>ATTACH<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{ 110 }
      </i></font>ATTACH<font color="#000080">(</font>TARG<font color="#000080">,</font>TARG<font color="#000080">);     </font><font color="#008000"><i>{ 220 }
      </i></font>ATTACH<font color="#000080">(</font>TARG<font color="#000080">,</font>ADD_STR<font color="#000080">);  </font><font color="#008000"><i>{ 242 }
      </i></font>INC<font color="#000080">(</font>LOOPS<font color="#000080">);
      </font><font color="#FF0000"><b>UNTIL </b></font>CLOCK_TICKS <font color="#000080">= </font>TIME_SAVE<font color="#000080">;
    </font>COMPUTE <font color="#000080">:= </font>LOOPS<font color="#000080">; </font>COMPUTE <font color="#000080">:= </font>COMPUTE <font color="#000080">/ </font>TICKS<font color="#000080">;
    </font>WRITELN<font color="#000080">(</font><font color="#800000">' Performance = '</font><font color="#000080">,</font>COMPUTE<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">:</font><font color="#800000">6</font><font color="#000080">,</font><font color="#800000">' Loops per tick'</font><font color="#000080">);
    </font>READLN<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0127.PAS">Original</a><b>]</b></p></body>
</html>
