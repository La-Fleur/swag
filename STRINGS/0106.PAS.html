<html>
<head><title> "Another FAST Uppercase" by JOHN O'HARROW</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0106.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
In SWAG9408, Jose Campione provided TXLATE5, a fast case conversion
procedure.  In response to the included request for suggestions and
improvements, please find attached my uppercase translation procedure,
which although very similar, is approx 10-15% faster.  This is
primarily achieved by using DEC CX and JNZ @Dest instead of LOOP @Dest
in the conversion loop (much faster on 386/486's).

Feel free to include the source code in the next SWAG release if you
wish to.

====================================================================
}
</i></font><font color="#FF0000"><b>UNIT </b></font>XLAT<font color="#000080">;

</font><font color="#008000"><i>{$S-}

</i></font><font color="#FF0000"><b>INTERFACE

VAR
  </b></font>Upper <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font>Char<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Char<font color="#000080">; </font><font color="#008000"><i>{Uppercase Translation Table}
{
This case translation table is initialised according to the country  
code information specified in the CONFIG.SYS file (DOS 4.0+).      
For older DOS versions, the standard character translations are used.

The 'Upper' array may also be accessed directly, eg: Ch := Upper['x']. 
This is the fastest possible replacement for the Upcase() function. 
}
  </i></font><font color="#FF0000"><b>PROCEDURE </b></font>MakeUppercase<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>S <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);

</font><font color="#FF0000"><b>IMPLEMENTATION

  PROCEDURE </b></font>MakeUppercase<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>S <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">LES   DI,S
    MOV   CL,ES:[DI]
    AND   CX,00FFh
    JZ    @@Done
    MOV   BX,Offset Upper
  @@Loop:
    INC   DI
    MOV   AL,ES:[DI]
    XLAT
    MOV   ES:[DI],AL
    DEC   CX
    JNZ   @@Loop
  @@Done:
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{-Non Interfaced Routines (Initialise translation table)------------}

  </i></font><font color="#FF0000"><b>FUNCTION </b></font>DosMajorVersion <font color="#000080">: </font>Byte<font color="#000080">;
    </font><font color="#008000"><i>{-Return DOS Major Version Number}
  </i></font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(
    </font><font color="#800000">$B4</font><font color="#000080">/</font><font color="#800000">$30</font><font color="#000080">/  </font><font color="#008000"><i>{mov ah,$30}
    </i></font><font color="#800000">$CD</font><font color="#000080">/</font><font color="#800000">$21</font><font color="#000080">); </font><font color="#008000"><i>{int $21}

  </i></font><font color="#FF0000"><b>PROCEDURE </b></font>SetCountrySpecificUppercase<font color="#000080">;
    </font><font color="#008000"><i>{-Convert 'Upper' into its country specific uppercase equivalent}
  </i></font><font color="#FF0000"><b>INLINE</b></font><font color="#000080">(
    </font><font color="#800000">$BA</font><font color="#000080">/&gt;</font>Upper<font color="#000080">/ </font><font color="#008000"><i>{mov dx,Upper}
    </i></font><font color="#800000">$B9</font><font color="#000080">/&gt;</font><font color="#800000">256</font><font color="#000080">/   </font><font color="#008000"><i>{mov cx,256}
    </i></font><font color="#800000">$B8</font><font color="#000080">/&gt;</font><font color="#800000">$6521</font><font color="#000080">/ </font><font color="#008000"><i>{mov ax,$6521}
    </i></font><font color="#800000">$CD</font><font color="#000080">/</font><font color="#800000">$21</font><font color="#000080">);   </font><font color="#008000"><i>{int $21}

  </i></font><font color="#FF0000"><b>PROCEDURE </b></font>InitialiseCaseConversion<font color="#000080">;
  </font><font color="#FF0000"><b>VAR
    </b></font>C <font color="#000080">: </font>Char<font color="#000080">;
  </font><font color="#FF0000"><b>BEGIN
    FOR </b></font>C <font color="#000080">:= </font><font color="#800000">#0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">#255 </font><font color="#FF0000"><b>DO
      </b></font>Upper<font color="#000080">[</font>C<font color="#000080">] := </font>C<font color="#000080">;
    </font><font color="#FF0000"><b>IF </b></font>DosMajorVersion <font color="#000080">&lt; </font><font color="#800000">4 </font><font color="#FF0000"><b>THEN
      FOR </b></font>C <font color="#000080">:= </font><font color="#800000">#0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">#255 </font><font color="#FF0000"><b>DO
        </b></font>Upper<font color="#000080">[</font>C<font color="#000080">] := </font>System<font color="#000080">.</font>UpCase<font color="#000080">(</font>C<font color="#000080">) </font><font color="#008000"><i>{Use Standard Case Conversion}
    </i></font><font color="#FF0000"><b>ELSE
      </b></font>SetCountrySpecificUppercase<font color="#000080">; </font><font color="#008000"><i>{Use International Case Conversion}
  </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{InitialiseCaseConversion}

{=Unit Initialisation==============================================}

</i></font><font color="#FF0000"><b>BEGIN
  </b></font>InitialiseCaseConversion<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to STRINGS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0106.PAS">Original</a><b>]</b></p></body>
</html>
