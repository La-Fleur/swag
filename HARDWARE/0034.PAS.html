<html>
<head><title> "CMOS reading" by PETER VAN DER LANDEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0034.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: landen@cir.frg.eur.nl (Peter van der Landen)

&gt;I am attempting to write a program in TP6.0 that reads the CMOS memory
&gt;(IBM PC) and saves the settings to a disk file.  I know there are 255
&gt;locations, but I don't know where.  If someone could point me to the
&gt;correct memory addresses, I'd really appreciate it.  Thanks (in advance)!

This unit (by an unknown other) shows you how it's done. The CMOS memory is
not part of the PC's main memory. Values are written/read by accessing an
I/O port.

}
</i></font><font color="#FF0000"><b>unit </b></font>CMOS<font color="#000080">;

</font><font color="#FF0000"><b>Interface

const
     </b></font>ClockSec  <font color="#000080">= </font><font color="#800000">$00</font><font color="#000080">;    </font><font color="#008000"><i>{ RTclock seconds }
     </i></font>ClockMin  <font color="#000080">= </font><font color="#800000">$02</font><font color="#000080">;    </font><font color="#008000"><i>{ RTclock minutes }
     </i></font>ClockHour <font color="#000080">= </font><font color="#800000">$04</font><font color="#000080">;    </font><font color="#008000"><i>{ RTclock hours }
     </i></font>ClockDOW  <font color="#000080">= </font><font color="#800000">$06</font><font color="#000080">;    </font><font color="#008000"><i>{ RTclock day of week }
     </i></font>ClockDay  <font color="#000080">= </font><font color="#800000">$07</font><font color="#000080">;    </font><font color="#008000"><i>{ RTclock day in month }
     </i></font>ClockMon  <font color="#000080">= </font><font color="#800000">$08</font><font color="#000080">;    </font><font color="#008000"><i>{ RTclock month }
     </i></font>ClockYear <font color="#000080">= </font><font color="#800000">$09</font><font color="#000080">;    </font><font color="#008000"><i>{ RTclock year (mod 100)}
     </i></font>AlarmSec  <font color="#000080">= </font><font color="#800000">$01</font><font color="#000080">;    </font><font color="#008000"><i>{ Alarm seconds }
     </i></font>AlarmMin  <font color="#000080">= </font><font color="#800000">$03</font><font color="#000080">;    </font><font color="#008000"><i>{ Alarm minutes }
     </i></font>AlarmHour <font color="#000080">= </font><font color="#800000">$05</font><font color="#000080">;    </font><font color="#008000"><i>{ Alarm hours }
     </i></font>Diskettes <font color="#000080">= </font><font color="#800000">$10</font><font color="#000080">;    </font><font color="#008000"><i>{ Floppy disk type byte }
     </i></font>HardDisk  <font color="#000080">= </font><font color="#800000">$12</font><font color="#000080">;    </font><font color="#008000"><i>{ Regular hard disk type }
     </i></font>HDExt1    <font color="#000080">= </font><font color="#800000">$19</font><font color="#000080">;    </font><font color="#008000"><i>{ Extended hard disk type, unit 1 }
     </i></font>HDExt2    <font color="#000080">= </font><font color="#800000">$1A</font><font color="#000080">;    </font><font color="#008000"><i>{ Extended hard disk type, unit 2 }
     </i></font>Equipment <font color="#000080">= </font><font color="#800000">$14</font><font color="#000080">;    </font><font color="#008000"><i>{ Equipment list }
     </i></font>CheckLo   <font color="#000080">= </font><font color="#800000">$2F</font><font color="#000080">;    </font><font color="#008000"><i>{ Checksum low }
     </i></font>CheckHi   <font color="#000080">= </font><font color="#800000">$2E</font><font color="#000080">;    </font><font color="#008000"><i>{ Checksum high }
     </i></font>BaseLo    <font color="#000080">= </font><font color="#800000">$15</font><font color="#000080">;    </font><font color="#008000"><i>{ Base mem low }
     </i></font>BaseHi    <font color="#000080">= </font><font color="#800000">$16</font><font color="#000080">;    </font><font color="#008000"><i>{ Base mem high }
     </i></font>ExpdLo    <font color="#000080">= </font><font color="#800000">$17</font><font color="#000080">;    </font><font color="#008000"><i>{ Expansion mem size low }
     </i></font>ExpdHi    <font color="#000080">= </font><font color="#800000">$18</font><font color="#000080">;    </font><font color="#008000"><i>{ Expansion mem size high }
     </i></font>StatRegA  <font color="#000080">= </font><font color="#800000">$0A</font><font color="#000080">;    </font><font color="#008000"><i>{ Status Register A }
     </i></font>StatRegB  <font color="#000080">= </font><font color="#800000">$0B</font><font color="#000080">;    </font><font color="#008000"><i>{ Status register B }
     </i></font>StatRegC  <font color="#000080">= </font><font color="#800000">$0C</font><font color="#000080">;    </font><font color="#008000"><i>{ Status register C }
     </i></font>StatRegD  <font color="#000080">= </font><font color="#800000">$0D</font><font color="#000080">;    </font><font color="#008000"><i>{ Status register D }
     </i></font>DiagStat  <font color="#000080">= </font><font color="#800000">$0E</font><font color="#000080">;    </font><font color="#008000"><i>{ Diagnostic status byte }
     </i></font>ShutDown  <font color="#000080">= </font><font color="#800000">$0F</font><font color="#000080">;    </font><font color="#008000"><i>{ Shutdown status byte }
     </i></font>Century   <font color="#000080">= </font><font color="#800000">$32</font><font color="#000080">;    </font><font color="#008000"><i>{ BCD Century number }
     </i></font>AltExpdLo <font color="#000080">= </font><font color="#800000">$30</font><font color="#000080">;    </font><font color="#008000"><i>{ Expansion mem size low (alternate) }
     </i></font>AltExpdHi <font color="#000080">= </font><font color="#800000">$31</font><font color="#000080">;    </font><font color="#008000"><i>{ Expansion mem size high (alternate) }
     </i></font>InfoFlags <font color="#000080">= </font><font color="#800000">$33</font><font color="#000080">;    </font><font color="#008000"><i>{ Bit 7 set = top 128k installed, bit
                           6 set = first user message (?) }

</i></font><font color="#FF0000"><b>function </b></font>ReadCmos<font color="#000080">(</font>Address<font color="#000080">: </font>byte<font color="#000080">): </font>byte<font color="#000080">;
          </font><font color="#008000"><i>{ Returns the byte at the given CMOS ADDRESS }

</i></font><font color="#FF0000"><b>procedure </b></font>WriteCmos<font color="#000080">(</font>Address<font color="#000080">, </font>Data<font color="#000080">: </font>byte<font color="#000080">);
          </font><font color="#008000"><i>{ Writes DATA to ADDRESS in CMOS ram }

</i></font><font color="#FF0000"><b>procedure </b></font>SetCMOSCheckSum<font color="#000080">;
          </font><font color="#008000"><i>{ Sets the CMOS checksum after you've messed with it :-}

{ The following bytes are RESERVED: $11, $13, $1B-$2D, and
  $34-$3F ($3F marks the end of the CMOS area).  You'll note that
  some of these are included in the checksum calculation. }

</i></font><font color="#FF0000"><b>implementation

const
     </b></font>CmosAddr  <font color="#000080">= </font><font color="#800000">$70</font><font color="#000080">;    </font><font color="#008000"><i>{ CMOS control port }
     </i></font>CmosData  <font color="#000080">= </font><font color="#800000">$71</font><font color="#000080">;    </font><font color="#008000"><i>{ CMOS data port }

</i></font><font color="#FF0000"><b>function </b></font>ReadCmos<font color="#000080">(</font>Address<font color="#000080">: </font>byte<font color="#000080">): </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>port<font color="#000080">[</font>CmosAddr<font color="#000080">] := </font>Address<font color="#000080">;
     </font>ReadCmos <font color="#000080">:= </font>port<font color="#000080">[</font>CmosData<font color="#000080">]
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ReadCmos}

</i></font><font color="#FF0000"><b>procedure </b></font>WriteCmos<font color="#000080">(</font>Address<font color="#000080">, </font>Data<font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>begin
     </b></font>port<font color="#000080">[</font>CmosAddr<font color="#000080">] := </font>Address<font color="#000080">;
     </font>port<font color="#000080">[</font>CmosData<font color="#000080">] := </font>Data
yend<font color="#000080">; </font><font color="#008000"><i>{WriteCmos}

</i></font><font color="#FF0000"><b>procedure </b></font>SetCMOSCheckSum<font color="#000080">;
</font><font color="#008000"><i>{ The checksum is simply the sum of $10 to $2D 
  (some of these bytes are reserved) }

</i></font><font color="#FF0000"><b>var
     </b></font>I<font color="#000080">, </font>Sum<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
     </b></font>Sum <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
     </font><font color="#FF0000"><b>for </b></font>I<font color="#000080">:= </font><font color="#800000">$10 </font><font color="#FF0000"><b>to </b></font><font color="#800000">$2D </font><font color="#FF0000"><b>do </b></font>Sum <font color="#000080">:= </font>Sum <font color="#000080">+ </font>ReadCmos<font color="#000080">(</font>I<font color="#000080">);
     </font>WriteCmos<font color="#000080">(</font>CheckHi<font color="#000080">, </font>Hi<font color="#000080">(</font>sum<font color="#000080">));
     </font>WriteCmos<font color="#000080">(</font>CheckLo<font color="#000080">, </font>Lo<font color="#000080">(</font>sum<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{SetCMOSCheckSum}

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0034.PAS">Original</a><b>]</b></p></body>
</html>
