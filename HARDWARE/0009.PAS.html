<html>
<head><title> "SECTORIO.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{... so there I was, sitting in a bar when a known C Programmer  }
{comes up to me and sniggers &quot;still doing it in Pascal eh?&quot;      }
{&quot;Yup&quot; I replied, and tossed the bartender another hundred.      }
{&quot;Yeah well, when you're ready For a Real language, only C has   }
{all the aces.&quot;                                                  }
{I'm a Pascal Programmer.  I don't have to take that.  &quot;Such as?&quot;}
{I hoped he'd bite and he did.                                   }
{&quot;Such as disk sector reading and writing For starters.&quot;         }
{&quot;Well I hope you're not bluffin', 'cause here's a trick that    }
{I'll bet you ain't covered.&quot;                                    }
{I pulled it out With a swish and laid it on the table.  &quot;Even   }
{provides support For &gt;32M volumes, which the C run-time library }
{manual Forgets to tell you it won't do.&quot;                        }
{&quot;Huh?  Where?&quot;                                                  }
{&quot;Right here&quot; I said.  &quot;Just where it says...                    }

</i></font><font color="#FF0000"><b>Program </b></font>AbsReadTest<font color="#000080">;

</font><font color="#008000"><i>{This Program demonstrates a C-style absread and absWrite For TP.}
{As is, it reads the boot sector off drive A:, and optionally    }
{Writes it out to the very last sector on drive A: (assumes 1.2Meg}
{This Program IS dangerous, and is released to the public domain.}
{I take no responsibility For use or misuse, deliberate or       }
{accidental, of this Program or any Program which Uses the       }
{techniques described herein.                                    }

{Author: Mitch Davis 3:634/384.6 +61-3-890-2062 v1.0 28-Jun-92.  }

</i></font><font color="#FF0000"><b>Var </b></font>bp<font color="#000080">:</font>Pointer<font color="#000080">; </font><font color="#008000"><i>{Will point to the buffer For the sector data}

</i></font><font color="#FF0000"><b>Function </b></font>absread <font color="#000080">(</font>drive<font color="#000080">:</font>Char<font color="#000080">; </font>nsects<font color="#000080">:</font>Word<font color="#000080">; </font>lsect<font color="#000080">:</font>Word<font color="#000080">; </font>buffer<font color="#000080">:</font>Pointer<font color="#000080">):</font>Boolean<font color="#000080">;

</font><font color="#008000"><i>{Works just like the C runtime one- including being restricted to 32M volumes!}

{drive is a Character, nsects is the number of sectors, and lsect is the first}
{sector.  buffer points to the buffer you'd like filled from disk.  Function  }
{returns True if there was an error, or False if all went well.               }

</i></font><font color="#FF0000"><b>Var </b></font>kludgebuff<font color="#000080">:</font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">$1f</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{Read Ralf Brown's interrupt listing}
    </i></font>kludgePtr<font color="#000080">:</font>Pointer<font color="#000080">;                 </font><font color="#008000"><i>{Int 25h - ES:[BP+1E] may change    }

</i></font><font color="#FF0000"><b>begin
  </b></font>kludgePtr <font color="#000080">:= @</font>kludgebuff<font color="#000080">;
  </font>absread <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&lt; </font><font color="#800000">'A' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&gt; </font><font color="#800000">'Z' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push  es
    push  bp
    push  di
    les   di, kludgePtr
    mov   al, drive      </font><font color="#008000"><i>{ Gets the passed parameter. }
    </i></font><font color="#FF00FF">and   al, 1fh        </font><font color="#008000"><i>{ Cvt from ASCII to drive num }
    </i></font><font color="#FF00FF">dec   al             </font><font color="#008000"><i>{ Adjust because A: is drive 0 }
    </i></font><font color="#FF00FF">mov   cx, nsects     </font><font color="#008000"><i>{ number of sectors to read }
    </i></font><font color="#FF00FF">mov   dx, lsect      </font><font color="#008000"><i>{ starting at sector.. }
    </i></font><font color="#FF00FF">push  ds
    lds   bx, buffer      </font><font color="#008000"><i>{ Get the address of the buffer }
    </i></font><font color="#FF00FF">mov   bp, di
    push  si
    int   25h            </font><font color="#008000"><i>{ Do the drive read. }
    </i></font><font color="#FF00FF">pop   si             </font><font color="#008000"><i>{ Remove the flags int 25h leaves on stack}
    </i></font><font color="#FF00FF">pop   si
    pop   ds
    pop   di
    pop   bp
    pop   es
    jc    @1
    mov   ah, 0          </font><font color="#008000"><i>{ No errors, so set Function to False }
    </i></font><font color="#FF00FF">@1:
    mov   @result, ah
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>absWrite
            <font color="#000080">(</font>drive<font color="#000080">:</font>Char<font color="#000080">; </font>nsects<font color="#000080">:</font>Word<font color="#000080">; </font>lsect<font color="#000080">:</font>Word<font color="#000080">; </font>buffer<font color="#000080">:</font>Pointer<font color="#000080">):</font>Boolean<font color="#000080">;

</font><font color="#008000"><i>{Works just like the C one - including being restricted to 32M volumes!}

{drive is a Character, nsects is the number of sectors, and lsect is the first}
{sector.  buffer points to the buffer you'd like filled from disk.  Function  }
{returns True if there was an error, or False if all went well.               }

</i></font><font color="#FF0000"><b>Var </b></font>kludgebuff<font color="#000080">:</font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">$1f</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
    </font>kludgePtr<font color="#000080">:</font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>kludgePtr <font color="#000080">:= @</font>kludgebuff<font color="#000080">;
  </font>absWrite <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&lt; </font><font color="#800000">'A' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&gt; </font><font color="#800000">'Z' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push  es
    push  bp
    push  di
    les   di, kludgePtr
    mov   al, drive      </font><font color="#008000"><i>{ Gets the passed parameter. }
    </i></font><font color="#FF00FF">and   al, 1fh        </font><font color="#008000"><i>{ Cvt from ASCII to drive num }
    </i></font><font color="#FF00FF">dec   al             </font><font color="#008000"><i>{ Adjust because A: is drive 0 }
    </i></font><font color="#FF00FF">mov   cx, nsects     </font><font color="#008000"><i>{ number of sectors to Write }
    </i></font><font color="#FF00FF">mov   dx, lsect      </font><font color="#008000"><i>{ starting at sector.. }
    </i></font><font color="#FF00FF">push  ds
    lds   bx, buffer      </font><font color="#008000"><i>{ Get the address of the buffer }
    </i></font><font color="#FF00FF">mov   bp, di
    push  si
    int   26h            </font><font color="#008000"><i>{ Do the drive Write. }
    </i></font><font color="#FF00FF">pop   si             </font><font color="#008000"><i>{ Remove the flags int 26h leaves on stack}
    </i></font><font color="#FF00FF">pop   si
    pop   ds
    pop   di
    pop   bp
    pop   es
    jc    @1
    mov   ah, 0
    @1:
    mov   @result, ah
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>absLread <font color="#000080">(</font>drive<font color="#000080">:</font>Char<font color="#000080">; </font>nsects<font color="#000080">:</font>Word<font color="#000080">; </font>lsect<font color="#000080">:</font>LongInt<font color="#000080">;
</font>buffer<font color="#000080">:</font>Pointer<font color="#000080">):</font>Boolean<font color="#000080">;

</font><font color="#008000"><i>{This Function reads sectors on disks which have the &gt;32M style made popular}
{by Compaq Dos 3.31, MS-Dos 4+ and DR-Dos 5+.                               }

</i></font><font color="#FF0000"><b>Var </b></font>packet<font color="#000080">:</font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{disk request packet - see Ralf Brown's ints}

</i></font><font color="#FF0000"><b>begin
  </b></font>absLread <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&lt; </font><font color="#800000">'A' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&gt; </font><font color="#800000">'Z' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov   ax, Word ptr lsect     </font><font color="#008000"><i>{Get the LSB of the start sector}
    </i></font><font color="#FF00FF">mov   Word ptr packet[0], ax </font><font color="#008000"><i>{Store it in the packet         }
    </i></font><font color="#FF00FF">mov   ax, Word ptr lsect + 2 </font><font color="#008000"><i>{Get the MSB of the start sector}
    </i></font><font color="#FF00FF">mov   Word ptr packet[2], ax </font><font color="#008000"><i>{Store this one too.            }
    </i></font><font color="#FF00FF">mov   ax, nsects             </font><font color="#008000"><i>{How many sectors to read       }
    </i></font><font color="#FF00FF">mov   Word ptr packet[4], ax
    </font><font color="#008000"><i>{Insert the Pointer to the data buffer into the packet}
    </i></font><font color="#FF00FF">push  bp ; push ds
    lds   dx, buffer      </font><font color="#008000"><i>{ Get the address of the buffer }
    </i></font><font color="#FF00FF">mov   Word ptr packet[6], dx
    mov   dx, ds
    mov   Word ptr packet[8], dx
    mov   al, drive      </font><font color="#008000"><i>{ Gets the passed parameter. }
    </i></font><font color="#FF00FF">and   al, 1fh        </font><font color="#008000"><i>{ Cvt from ASCII to drive num }
    </i></font><font color="#FF00FF">dec   al             </font><font color="#008000"><i>{ Adjust because A: is drive 0 }
    </i></font><font color="#FF00FF">int   25h            </font><font color="#008000"><i>{ Do the drive read. }
    </i></font><font color="#FF00FF">pop   si             </font><font color="#008000"><i>{ Remove the flags int 25h leaves on stack}
    </i></font><font color="#FF00FF">pop   ds
    pop   bp
    jc    @1
    mov   ah, 0
    @1:
    mov   @result, ah
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>absLWrite <font color="#000080">(</font>drive<font color="#000080">:</font>Char<font color="#000080">; </font>nsects<font color="#000080">:</font>Word<font color="#000080">; </font>lsect<font color="#000080">:</font>LongInt<font color="#000080">;
</font>buffer<font color="#000080">:</font>Pointer<font color="#000080">):</font>Boolean<font color="#000080">;

</font><font color="#008000"><i>{This Function Writes sectors on disks which have the &gt;32M style made popular}
{by Compaq Dos 3.31, MS-Dos 4+ and DR-Dos 5+.                                }

</i></font><font color="#FF0000"><b>Var </b></font>packet<font color="#000080">:</font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>absLWrite <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&lt; </font><font color="#800000">'A' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&gt; </font><font color="#800000">'Z' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">mov   ax, Word ptr lsect
    mov   Word ptr packet[0], ax
    mov   ax, Word ptr lsect + 2
    mov   Word ptr packet[2], ax
    mov   ax, nsects
    mov   Word ptr packet[4], ax
    push  bp ; push ds
    lds   dx, buffer
    mov   Word ptr packet[6], dx
    mov   dx, ds
    mov   Word ptr packet[8], dx
    mov   al, drive      </font><font color="#008000"><i>{ Gets the passed parameter. }
    </i></font><font color="#FF00FF">and   al, 1fh        </font><font color="#008000"><i>{ Cvt from ASCII to drive num }
    </i></font><font color="#FF00FF">dec   al             </font><font color="#008000"><i>{ Adjust because A: is drive 0 }
    </i></font><font color="#FF00FF">int   26h            </font><font color="#008000"><i>{ Do the drive Write. }
    </i></font><font color="#FF00FF">pop   si             </font><font color="#008000"><i>{ Remove the flags int 26h leaves on stack}
    </i></font><font color="#FF00FF">pop   ds
    pop   bp
    jc    @1
    mov   ah, 0
    @1:
    mov   @result, ah
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>LongNeeded <font color="#000080">(</font>drive<font color="#000080">:</font>Char<font color="#000080">):</font>Boolean<font color="#000080">;

</font><font color="#008000"><i>{This Function returns True or False depending on whether the long versions}
{of absread/absWrite needed to be invoked; that is, it's a drive Formatted }
{in the Dos 4+ &gt;32M style.                                                 }
{I strongly suggest you see Ralf Brown's interrupt listing For int21h subfs}
{440d and 53 - they'll tell you all you know to understand the guts of this}
{Function.                                                                 }

</i></font><font color="#FF0000"><b>Label </b></font>Escape<font color="#000080">;

</font><font color="#FF0000"><b>Var </b></font>drivestats<font color="#000080">:</font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">31</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>LongNeeded <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&lt; </font><font color="#800000">'A' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>drive <font color="#000080">&gt; </font><font color="#800000">'Z' </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">push ds
    mov  dx, ss
    mov  ds, dx
    lea  dx, drivestats
    mov  bl, drive      </font><font color="#008000"><i>{ Gets the passed parameter. }
    </i></font><font color="#FF00FF">and  bl, 1fh        </font><font color="#008000"><i>{ Cvt from ASCII to drive num }
    </i></font><font color="#FF00FF">mov  ax, 440Dh
    mov  cx, 0860h
    int  21h
    jc   Escape
    mov  ax, Word ptr drivestats[0Fh]
    or   ax, ax
    jnz Escape
    mov  @Result, 1
  Escape:
    pop  ds
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>getmem <font color="#000080">(</font>bp<font color="#000080">,</font><font color="#800000">2048</font><font color="#000080">);
  </font>Writeln <font color="#000080">(</font>LongNeeded <font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">));
  </font>Writeln <font color="#000080">(</font>LongNeeded <font color="#000080">(</font><font color="#800000">'C'</font><font color="#000080">));
  </font>Writeln <font color="#000080">(</font>absread  <font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font>bp<font color="#000080">));
</font><font color="#008000"><i>(*  Writeln (absWrite ('A',1,2399,bp)); *) {remove the comments at your own}
                                           {risk!!!}
  </i></font>freemem <font color="#000080">(</font>bp<font color="#000080">,</font><font color="#800000">2048</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{So I bought him a drink.  The poor guy looked like he needed one....}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p></body>
</html>
