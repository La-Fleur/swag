<html>
<head><title> "Detecting 486s" by MICHAL SZOKOLO</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I only have TASM 2.2 or something and can't get to to compile CPUID and
&gt; don't know the opcodes to code it with a couple of DB statements in
&gt; Pascal's BASM...

 DB $F,$A2
 EAX must be set to 0 or 1 to request 2 modes of CPUID. Try looking in

Interrupt List for more info...

&gt; Oh, and finally, I notice CPUID is being INCLUDED in the latest mask of

 [...]

&gt; As CPUID is accepted as being the pentium detector code, some software out
&gt; there may be getting it wrong! CPUID does (correctly) report a 4 for
&gt; family type (logical as a pentium reports 5) but even so, I didn't know
&gt; intel had started doing this!
&gt; Oh, and checking for ability to toggle the appropriate bit in eflags to
&gt; test for CPUID ability works too...

A lot of software recognizes Pentium only by this bit...

&gt; Finally, if you know any way to identify a 386DX from a 386SX, please let
&gt; me know!

 By timing memory transfers. 386sx and 486slc have 16 bit access while 386dx
and 486dlc do 32 bits at a time. Below is my procedure, mostly BASM :-( It may
get wrong if there are interrupts occuring while test.
}

</i></font><font color="#FF0000"><b>function </b></font>dx386 <font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{
 Checks whether CPU is 386SX or DX. This is done by timing memory transfers:
 - on SX, there is very small difference between 32 bit moves and double
   16 bit moves, because SX does them 16 bit at a time anyway
 - on DX, dbl 16 bit moves are slower than 32 bit ones, because it does them
   at 32 bits anyway, so half of them is misaligned (requiring two movs).
 On SX, mov32/2*mov16 gives about 1.0-1.1 (with loop/timer int overhead)
 On DX, mov32/2*mov16 gives about 1.5     (ditto)

}
</i></font><font color="#FF0000"><b>label
   </b></font>notest<font color="#000080">;
</font><font color="#FF0000"><b>const
   </b></font>r1    <font color="#000080">: </font>word <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
   </font>r2    <font color="#000080">: </font>word <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
   </font>ratio <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>const
   </b></font>block <font color="#000080">= </font><font color="#800000">$1000</font><font color="#000080">;
   </font>dx    <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">7</font><font color="#000080">; </font><font color="#008000"><i>{value is stored to avoid multiple runs of (slow) test
code}</i></font><font color="#FF0000"><b>begin
     if </b></font>processor<font color="#000080">&lt;</font><font color="#800000">7 </font><font color="#FF0000"><b>then </b></font>exit<font color="#000080">; </font><font color="#008000"><i>{must be 386 or better}
     </i></font><font color="#FF0000"><b>if </b></font>dx<font color="#000080">&lt;&gt;</font><font color="#800000">7 </font><font color="#FF0000"><b>then goto </b></font>notest<font color="#000080">;
     </font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">in   al,$21
        sti
        push ax
        mov  al,$FE
        out  $21,al
        push ds
        mov  bx,0
        mov  es,Seg0040
        mov  ds,Seg0040
        mov  ax,es:[$6c]
      @1:
        cmp  ax,es:[$6c]
        je   @1
        mov  ax,es:[$6c]
      @2:
        mov  di,0
        mov  si,di
        mov  cx,block
        db $f3,$66,$a5 </font><font color="#008000"><i>{rep movsd}
        </i></font><font color="#FF00FF">inc  bx
        cmp  ax,es:[$6c]
        je   @2
        pop ds
        mov  r1,bx
        mov  bx,0
        push ds
        mov  ds,Seg0040
        mov  ax,es:[$6c]
      @3:
        cmp  ax,es:[$6c]
        je   @3
        mov  ax,es:[$6c]
      @4:
        mov  di,0
        mov  si,di
        mov  cx,block*2
        rep  movsw
        inc  bx
        cmp  ax,es:[$6c]
        je   @4
        pop  ds
        pop  ax
        out  $21,al
        mov  r2,bx
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>ratio<font color="#000080">:=</font><font color="#800000">10</font><font color="#000080">*</font>r1 <font color="#FF0000"><b>div </b></font>r2<font color="#000080">;
     </font>dx<font color="#000080">:=</font>ord<font color="#000080">(</font>ratio<font color="#000080">&gt;=</font><font color="#800000">13</font><font color="#000080">);
</font><font color="#008000"><i>{     writeln('r=',ratio,' t1=',r1,' t2=',r2);}
</i></font>notest<font color="#000080">:
     </font>dx386<font color="#000080">:=(</font>dx<font color="#000080">=</font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p></body>
</html>
