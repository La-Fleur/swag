<html>
<head><title> "Rebooting PC" by TIMO SALMI</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 Q: How is the code for rebooting the PC written in Turbo Pascal?

 A: This item draws from the information and the C-code example in
Stan Brown's comp.os.msdos.programmer FAQ, garbo.uwasa.fi:
/pc/doc-net/faqp9317.zip (at the time of writing this), from
memory.lst and interrup.b in /pc/programming/inter39b.zip, and from
/pc/programming/helppc21.zip. The Turbo Pascal code is my adaptation
of the C-code. It is not a one-to-one replica.
   The usually advocated warm-boot method is storing $1234 in the
word at $0040:$0072 and jumping to address $FFFF:$0000. The problem
with this approach is that files must first be closed, potential
caches flushed. This is how to do this
}

  </i></font><font color="#FF0000"><b>procedure </b></font>REBOOT<font color="#000080">;
  </font><font color="#FF0000"><b>label </b></font>next<font color="#000080">;
  </font><font color="#FF0000"><b>var </b></font>regs  <font color="#000080">: </font>registers<font color="#000080">;
      </font>i     <font color="#000080">: </font>byte<font color="#000080">;
      </font>ticks <font color="#000080">: </font>longint<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font><font color="#008000"><i>{... &quot;press&quot; alt-ctrl ...}
    </i></font>mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$0017</font><font color="#000080">] := </font>mem<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$0017</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font><font color="#800000">$0C</font><font color="#000080">;  </font><font color="#008000"><i>{ 00001100 }
    {... &quot;press&quot; del, try a few times ...}
    </i></font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">10 </font><font color="#FF0000"><b>do
      begin
        </b></font>FillChar <font color="#000080">(</font>regs<font color="#000080">, </font>sizeOf<font color="#000080">(</font>regs<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);  </font><font color="#008000"><i>{ initialize }
        </i></font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$4F</font><font color="#000080">;  </font><font color="#008000"><i>{ service number }
        </i></font>regs<font color="#000080">.</font>al <font color="#000080">:= </font><font color="#800000">$53</font><font color="#000080">;  </font><font color="#008000"><i>{ del key's scan code }
        </i></font>regs<font color="#000080">.</font>flags <font color="#000080">:= </font>FCarry<font color="#000080">;  </font><font color="#008000"><i>{ &quot;sentinel for ignoring key&quot; }
        </i></font>Intr <font color="#000080">(</font><font color="#800000">$15</font><font color="#000080">, </font>regs<font color="#000080">);
        </font><font color="#008000"><i>{... check if the del key registered, if not retry ...}
        </i></font><font color="#FF0000"><b>if </b></font>regs<font color="#000080">.</font>flags <font color="#FF0000"><b>and </b></font>Fcarry <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then goto </b></font>next<font color="#000080">;
        </font><font color="#008000"><i>{... waste some time, watch out for midnight ...}
        </i></font>ticks <font color="#000080">:= </font>MemL <font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">];
        </font><font color="#FF0000"><b>repeat until </b></font><font color="#000080">(</font>MemL<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">] - </font>ticks <font color="#000080">&gt; </font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>or
                     </b></font><font color="#000080">(</font>MemL<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$006C</font><font color="#000080">] - </font>ticks <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">)
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{for}
    </i></font>exit<font color="#000080">;
  </font>next<font color="#000080">:
    </font><font color="#008000"><i>{... disk reset: writes all modified disk buffers to disk ...}
    </i></font>FillChar <font color="#000080">(</font>regs<font color="#000080">, </font>sizeOf<font color="#000080">(</font>regs<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
    </font>regs<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$0D</font><font color="#000080">;
    </font>MsDos <font color="#000080">(</font>regs<font color="#000080">);
    </font><font color="#008000"><i>{... set post-reset flag, use $0000 instead of $1234 for coldboot ...}
    </i></font>memW<font color="#000080">[</font><font color="#800000">$0040</font><font color="#000080">:</font><font color="#800000">$0072</font><font color="#000080">] := </font><font color="#800000">$1234</font><font color="#000080">;
    </font><font color="#008000"><i>{... jump to $FFFF:0000 BIOS reset ...}
    </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$EA</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>(* reboot *)
{
One slight problem with this approach is that the keyboard intercept
interrupt $15 service $4F requires at least an AT according to
inter39b.zip. A simple test based on &quot;FFFF:E byte ROM machine id&quot;
(the previous definition is from helppc21.zip) is:
}
  </i></font><font color="#FF0000"><b>function </b></font>ISATFN <font color="#000080">: </font>boolean<font color="#000080">;
  </font><font color="#FF0000"><b>begin
     case </b></font>Mem<font color="#000080">[</font><font color="#800000">$F000</font><font color="#000080">:</font><font color="#800000">$FFFE</font><font color="#000080">] </font><font color="#FF0000"><b>of
       </b></font><font color="#800000">$FC</font><font color="#000080">, </font><font color="#800000">$FA</font><font color="#000080">, </font><font color="#800000">$F8 </font><font color="#000080">: </font>isatfn <font color="#000080">:= </font>true<font color="#000080">;
       </font><font color="#FF0000"><b>else </b></font>isatfn <font color="#000080">:= </font>false<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{case}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>(* isatfn *)
{
For a more comprehensive test use CPUFN &quot;Get the type of the
processor chip&quot; from TSUNTH in garbo.uwasa.fi:/pc/ts/tspa*.zip or
see the TP + ASM code in Michael Ticher (1992), PC Intern System
Programming, pp. 725-727.
   An addition by Per Bergland (d6caps@dtek.chalmers.se): I recently
downloaded the FAQ for this newsgroup, and studied the code for
rebooting a PC. The problem with that code (calling FFFF:0000) is
that it will not work in protected mode programs such as those
compiled for Windows or BP7 DPMI, or even in a DOS program run in a
Windows DOS session. The solution provided has been tested on
various COMPAQ PC:s, but I think it will work on any AT-class
machine. It involves using the 8042 keyboard controller chip output
pin 0, which is physically connected to the reset pin of the CPU.
There is unfortunately no way to perform a &quot;warm&quot; reboot this way,
and the warnings about disk caches etc apply to this code, too (see
FAQ). The code is written in BP7 assembly lingo, because that's what
I normally write code in, but anyone could rewrite it in C or high
level Pascal.
}

  </i></font><font color="#FF0000"><b>UNIT </b></font>Reboot<font color="#000080">;
  </font><font color="#FF0000"><b>INTERFACE
    procedure </b></font>DoReboot<font color="#000080">;
  </font><font color="#FF0000"><b>IMPLEMENTATION
    procedure </b></font>DoReboot<font color="#000080">;</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">cli
  @@WaitOutReady:       </font><font color="#008000"><i>{ Busy-wait until 8042 is ready for new command}
      </i></font><font color="#FF00FF">in al,64h         </font><font color="#008000"><i>{ read 8042 status byte}
      </i></font><font color="#FF00FF">test al,00000010b </font><font color="#008000"><i>{ Bit 1 of status indicates input buffer full }
      </i></font><font color="#FF00FF">jnz @@WaitOutReady
      mov al,0FEh       </font><font color="#008000"><i>{ Pulse &quot;reset&quot; = 8042 pin 0 }
      </i></font><font color="#FF00FF">out 64h,al
      </font><font color="#008000"><i>{ The PC will reboot now }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p></body>
</html>
