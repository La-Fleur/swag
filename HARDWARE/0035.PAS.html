<html>
<head><title> "Processor Speed Independe" by TERJE MATHISEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0035.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: terjem@hda.hydro.com (Terje Mathisen)

&gt;I need the source code to (in TP and/or Assembly) setup a processor
&gt;independant delay.  The one I have is way faster on a 486 than on a 386.
&gt;I need something that tests the machines speed when a unit is initialized
&gt;and saves a number to a variable and then a delay procedure that uses
&gt;that number.

Well, the Delay() procedure in the Crt unit is designed to do exactly this,
but if you cannot use Crt, try this replacement which I wrote almost
10 years ago, and later converted to a Unit.
}

{$R-,S-}
</i></font><font color="#FF0000"><b>Unit </b></font>Delays<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

CONST </b></font>loop_count <font color="#000080">: </font>WORD <font color="#000080">= </font><font color="#800000">250</font><font color="#000080">;

</font><font color="#FF0000"><b>PROCEDURE </b></font>Delay<font color="#000080">(</font>ms <font color="#000080">: </font>WORD<font color="#000080">);

</font><font color="#FF0000"><b>IMPLEMENTATION

PROCEDURE </b></font>Delay<font color="#000080">(</font>ms <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
Inline</b></font><font color="#000080">(
  </font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$76</font><font color="#000080">/&lt;</font>MS            <font color="#008000"><i>{    mov si,[bp&lt;ms]}
  </i></font><font color="#000080">/</font><font color="#800000">$09</font><font color="#000080">/</font><font color="#800000">$F6               </font><font color="#008000"><i>{    or si,si}
  </i></font><font color="#000080">/</font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$09               </font><font color="#008000"><i>{    jz d2}
  </i></font><font color="#000080">/</font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$0E</font><font color="#000080">/&gt;</font>LOOP_COUNT   <font color="#008000"><i>{d0: mov cx,[&gt;loop_count]}
  </i></font><font color="#000080">/</font><font color="#800000">$E2</font><font color="#000080">/</font><font color="#800000">$FE               </font><font color="#008000"><i>{d1: loop d1}
  </i></font><font color="#000080">/</font><font color="#800000">$4E                   </font><font color="#008000"><i>{    dec si}
  </i></font><font color="#000080">/</font><font color="#800000">$75</font><font color="#000080">/</font><font color="#800000">$F7               </font><font color="#008000"><i>{    jnz d0}
</i></font><font color="#000080">);                       </font><font color="#008000"><i>{d2:}
</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
InLine</b></font><font color="#000080">(
  </font><font color="#800000">$B8</font><font color="#000080">/</font><font color="#800000">$40</font><font color="#000080">/</font><font color="#800000">$00            </font><font color="#008000"><i>{    mov ax,$40}
  </i></font><font color="#000080">/</font><font color="#800000">$8E</font><font color="#000080">/</font><font color="#800000">$C0               </font><font color="#008000"><i>{    mov es,ax}
  </i></font><font color="#000080">/</font><font color="#800000">$BB</font><font color="#000080">/</font><font color="#800000">$6C</font><font color="#000080">/</font><font color="#800000">$00           </font><font color="#008000"><i>{    mov bx,$6C}
  </i></font><font color="#000080">/</font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$37           </font><font color="#008000"><i>{d3: es: mov si,[bx]}
  </i></font><font color="#000080">/</font><font color="#800000">$31</font><font color="#000080">/</font><font color="#800000">$FF               </font><font color="#008000"><i>{    xor di,di}
  </i></font><font color="#000080">/</font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$3B</font><font color="#000080">/</font><font color="#800000">$37           </font><font color="#008000"><i>{d4: es: cmp si,[bx]}
  </i></font><font color="#000080">/</font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$FB               </font><font color="#008000"><i>{    je d4}
  </i></font><font color="#000080">/</font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$37           </font><font color="#008000"><i>{    es: mov si,[bx]}
  </i></font><font color="#000080">/</font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$0E</font><font color="#000080">/&gt;</font>LOOP_COUNT   <font color="#008000"><i>{d5: mov cx,[&gt;loop_count]}
  </i></font><font color="#000080">/</font><font color="#800000">$E2</font><font color="#000080">/</font><font color="#800000">$FE               </font><font color="#008000"><i>{d6: loop d6}
  </i></font><font color="#000080">/</font><font color="#800000">$47                   </font><font color="#008000"><i>{    inc di}
  </i></font><font color="#000080">/</font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$3B</font><font color="#000080">/</font><font color="#800000">$37           </font><font color="#008000"><i>{    es: cmp si,[bx]}
  </i></font><font color="#000080">/</font><font color="#800000">$74</font><font color="#000080">/</font><font color="#800000">$F4               </font><font color="#008000"><i>{    je d5}
  </i></font><font color="#000080">/</font><font color="#800000">$A1</font><font color="#000080">/&gt;</font>LOOP_COUNT       <font color="#008000"><i>{    mov ax,[&gt;loop_count]}
  </i></font><font color="#000080">/</font><font color="#800000">$F7</font><font color="#000080">/</font><font color="#800000">$E7               </font><font color="#008000"><i>{    mul di}
  </i></font><font color="#000080">/</font><font color="#800000">$B9</font><font color="#000080">/</font><font color="#800000">$37</font><font color="#000080">/</font><font color="#800000">$00           </font><font color="#008000"><i>{    mov cx,55}
  </i></font><font color="#000080">/</font><font color="#800000">$F7</font><font color="#000080">/</font><font color="#800000">$F1               </font><font color="#008000"><i>{    div cx}
  </i></font><font color="#000080">/</font><font color="#800000">$A3</font><font color="#000080">/&gt;</font>LOOP_COUNT       <font color="#008000"><i>{    mov [&gt;loop_count],ax}
  </i></font><font color="#000080">/</font><font color="#800000">$81</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$1E</font><font color="#000080">/</font><font color="#800000">$00       </font><font color="#008000"><i>{    cmp di,30}
  </i></font><font color="#000080">/</font><font color="#800000">$72</font><font color="#000080">/</font><font color="#800000">$D4               </font><font color="#008000"><i>{    jb d3}
</i></font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0035.PAS">Original</a><b>]</b></p></body>
</html>
