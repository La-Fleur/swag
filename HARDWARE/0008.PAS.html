<html>
<head><title> "SCSICODE.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 &gt; I am trying to issue an SCSI START/StoP Unit via Adaptec's ASPI SCSI
 &gt; manager and an 1542B host adaptor.  This is For an application I am
 &gt; writing in BP.  Adaptec is of no help.  if anyone here has any
 &gt; comments
 &gt; or suggestions please respond in this Forum.
}

</i></font><font color="#FF0000"><b>Unit </b></font>Aspi<font color="#000080">;

</font><font color="#008000"><i>{ I/O Error reporting:

  AspiSenseKey is the primary source of error inFormation.

    0:    I/O Complete.
          Warnings (Filemark, Short block, etc) may be posted in Sense.

    1-E:  Error occured.
          Examine SRBStat, HostStat, TargStat, Sense For details.

    F:    Severe error detected, no SCSI info available.

  -------------------------------------------------------------------- }

</i></font><font color="#FF0000"><b>Interface

Const
  </b></font>SrbIn <font color="#000080">= </font><font color="#800000">$08</font><font color="#000080">;
  </font>SRBOut <font color="#000080">= </font><font color="#800000">$10</font><font color="#000080">;
  </font>SRBNone <font color="#000080">= </font><font color="#800000">$18</font><font color="#000080">;
  </font>AspiPtr<font color="#000080">:  </font>Pointer <font color="#000080">= </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Type
  </b></font>AspiSrb <font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>SrbCmd<font color="#000080">:      </font>Byte<font color="#000080">;
    </font>SrbStat<font color="#000080">:     </font>Byte<font color="#000080">;
    </font>SrbHost<font color="#000080">:     </font>Byte<font color="#000080">;
    </font>SrbReqFlags<font color="#000080">: </font>Byte<font color="#000080">;
    </font>SrbHdrFill<font color="#000080">:  </font>LongInt<font color="#000080">;
    </font><font color="#FF0000"><b>Case </b></font>Integer <font color="#FF0000"><b>of
     </b></font><font color="#800000">2</font><font color="#000080">: (</font>Srb2TargetID<font color="#000080">: </font>Byte<font color="#000080">;
         </font>Srb2LUN<font color="#000080">:      </font>Byte<font color="#000080">;
         </font>Srb2DataLen<font color="#000080">:  </font>LongInt<font color="#000080">;
         </font>Srb2SenseLen<font color="#000080">: </font>Byte<font color="#000080">;
         </font>Srb2DataPtr<font color="#000080">:  </font>Pointer<font color="#000080">;
         </font>Srb2LinkPtr<font color="#000080">:  </font>Pointer<font color="#000080">;
         </font>Srb2CDBLen<font color="#000080">:   </font>Byte<font color="#000080">;
         </font>Srb2HAStat<font color="#000080">:   </font>Byte<font color="#000080">;
         </font>Srb2TargStat<font color="#000080">: </font>Byte<font color="#000080">;
         </font>Srb2PostAddr<font color="#000080">: </font>Pointer<font color="#000080">;
         </font>Srb2Filler<font color="#000080">:   </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">34</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
         </font><font color="#008000"><i>{ Sense data follows CDB }
         </i></font>Srb2CDB<font color="#000080">:      </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">50</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">);
     </font><font color="#800000">1</font><font color="#000080">: (</font>Srb1TargetID<font color="#000080">: </font>Byte<font color="#000080">;
         </font>Srb1LUN<font color="#000080">:      </font>Byte<font color="#000080">;
         </font>Srb1DevType<font color="#000080">:  </font>Byte<font color="#000080">);
     </font><font color="#800000">0</font><font color="#000080">: (</font>Srb0Cnt<font color="#000080">:      </font>Byte<font color="#000080">;
         </font>Srb0TargetID<font color="#000080">: </font>Byte<font color="#000080">;
         </font>Srb0MgrID<font color="#000080">:    </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">16</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
         </font>Srb0HostID<font color="#000080">:   </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">16</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
         </font>Srb0HostParm<font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">16</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>AspiSRBStat<font color="#000080">:      </font>Byte<font color="#000080">;
  </font>AspiHostStat<font color="#000080">:     </font>Byte<font color="#000080">;
  </font>AspiTargStat<font color="#000080">:     </font>Byte<font color="#000080">;
  </font>AspiSenseKey<font color="#000080">:     </font>Byte<font color="#000080">;
  </font>AspiSense<font color="#000080">:        </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">17</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
  </font>AspiSenseCode<font color="#000080">:    </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>AspiOpen<font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AspiCall <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>SRB<font color="#000080">: </font>AspiSrb<font color="#000080">);
</font><font color="#008000"><i>{ Call ASPI Handler With SRB }
</i></font><font color="#FF0000"><b>Inline </b></font><font color="#000080">(</font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$1E</font><font color="#000080">/&gt;</font>AspiPtr<font color="#000080">/
        </font><font color="#800000">$58</font><font color="#000080">/</font><font color="#800000">$58</font><font color="#000080">);

</font><font color="#FF0000"><b>Procedure </b></font>AspiWait <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>SRB<font color="#000080">: </font>AspiSrb<font color="#000080">);

</font><font color="#FF0000"><b>Function </b></font>AspiClose<font color="#000080">: </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Uses </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>AspiWait <font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>SRB<font color="#000080">: </font>AspiSRB<font color="#000080">);
</font><font color="#008000"><i>{ Call ASPI Handler With SRB and wait For Completion }
</i></font><font color="#FF0000"><b>begin
  if </b></font>AspiPtr <font color="#000080">= </font><font color="#FF0000"><b>Nil
    then begin
      </b></font>AspiSenseKey <font color="#000080">:= </font><font color="#800000">$0F</font><font color="#000080">;
      </font>Exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>With </b></font>Srb <font color="#FF0000"><b>do begin
    </b></font>SrbStat <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>AspiCall <font color="#000080">(</font>Srb<font color="#000080">);
    </font><font color="#FF0000"><b>While </b></font>SrbStat <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>do </b></font><font color="#000080">;
    </font>AspiSrbStat   <font color="#000080">:= </font>SrbStat<font color="#000080">;
    </font>AspiHostStat  <font color="#000080">:= </font>Srb2HAStat<font color="#000080">;
    </font>AspiTargStat  <font color="#000080">:= </font>Srb2TargStat<font color="#000080">;
    </font>AspiSenseKey  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>FillChar <font color="#000080">(</font>AspiSense<font color="#000080">, </font>Sizeof <font color="#000080">(</font>AspiSense<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);
    </font>Move <font color="#000080">(</font>Srb2CDB <font color="#000080">[</font>Srb2CDBLen<font color="#000080">], </font>AspiSense<font color="#000080">, </font>Sizeof <font color="#000080">(</font>AspiSense<font color="#000080">));
    </font>AspiSenseKey <font color="#000080">:= </font>AspiSense<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font><font color="#800000">$0F</font><font color="#000080">;
    </font>AspiSenseCode <font color="#000080">:= (</font>AspiSense <font color="#000080">[</font><font color="#800000">12</font><font color="#000080">] </font><font color="#FF0000"><b>SHL </b></font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font>AspiSense <font color="#000080">[</font><font color="#800000">13</font><font color="#000080">];
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>AspiOpen<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Const
  </b></font>AspiName<font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char <font color="#000080">= </font><font color="#800000">'SCSIMGR$'#0</font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>R<font color="#000080">:       </font>Registers<font color="#000080">;
  </font>AspiHan<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>R <font color="#FF0000"><b>do begin
    </b></font><font color="#008000"><i>{ Assume failure }
    </i></font>AspiOpen <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
    </font>AspiPtr <font color="#000080">:= </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">;

    </font><font color="#008000"><i>{ Open ASPI device driver }
    </i></font>AX <font color="#000080">:= </font><font color="#800000">$3D00</font><font color="#000080">;
    </font>DS <font color="#000080">:= </font>Seg <font color="#000080">(</font>AspiName<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
    </font>DX <font color="#000080">:= </font>ofs <font color="#000080">(</font>AspiName<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
    </font>MSDos <font color="#000080">(</font>R<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>odd <font color="#000080">(</font>Flags<font color="#000080">)
      </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
    </font>AspiHan <font color="#000080">:= </font>AX<font color="#000080">;

    </font><font color="#008000"><i>{ Do IOCtl Read to get Pointer to ASPI handler }
    </i></font>AX <font color="#000080">:= </font><font color="#800000">$4402</font><font color="#000080">;
    </font>BX <font color="#000080">:= </font>AspiHan<font color="#000080">;
    </font>CX <font color="#000080">:= </font><font color="#800000">4</font><font color="#000080">;
    </font>DS <font color="#000080">:= </font>Seg <font color="#000080">(</font>AspiPtr<font color="#000080">);
    </font>DX <font color="#000080">:= </font>ofs <font color="#000080">(</font>AspiPtr<font color="#000080">);
    </font>MSDos <font color="#000080">(</font>R<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Odd <font color="#000080">(</font>flags<font color="#000080">)
      </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;

    </font><font color="#008000"><i>{ Close device driver }
    </i></font>AX <font color="#000080">:= </font><font color="#800000">$3E00</font><font color="#000080">;
    </font>BX <font color="#000080">:= </font>AspiHan<font color="#000080">;
    </font>MsDos <font color="#000080">(</font>R<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Odd <font color="#000080">(</font>Flags<font color="#000080">)
      </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Indicate success  and Exit }
  </i></font>AspiOpen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ AspiOpen }</i></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>AspiClose<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>AspiClose <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ AspiClose }</i></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0008.PAS">Original</a><b>]</b></p></body>
</html>
