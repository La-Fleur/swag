<html>
<head><title> "CPU Info" by BRUCE LACKLORE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Unit </b></font>CPUInfo<font color="#000080">;

</font><font color="#008000"><i>{        Version 1.1.0.P

        Requires Borland Turbo Pascal version 6.0 or later to compile.
        Author:  Bruce J. Lackore.  Created Saturday, October 9, 1993.
}

{$IFDEF Test}
        {$A+,B-,D+,F-,G-,I+,L+,O-,R+,S+,V-,X+}
{$ELSE}
        {$A+,B-,D-,F-,G-,I-,L-,O-,R-,S-,V-,X+}
{$ENDIF}

{        This unit contains a handy gadget for determining the CPU speed.  It is NOT
        coded for the Pentium family (if anyone wants to take a shot at it, please
        let me know the results)!
}

</i></font><font color="#FF0000"><b>Interface

Const
        </b></font>Cpu8086                                                                          <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
        </font>Cpu80286                                                                         <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
        </font>Cpu80386                                                                         <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;
        </font>Cpu80486                                                                         <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>WhatCPU<font color="#000080">:  </font>Word<font color="#000080">;

</font><font color="#008000"><i>{        This function examines the CPU and returns a number corresponding to the
        CPU type;  1 for 8086, 3 for 80386, etc.  This procedure came right out of
        Neil Rubenking's Turbo Pascal 6.0 Techniques and Utilities (thanx Neil!).
}

</i></font><font color="#FF0000"><b>Procedure </b></font>CPUSpd<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>MHz<font color="#000080">, </font>KHz<font color="#000080">:  </font>Word<font color="#000080">);

</font><font color="#008000"><i>{        This procedure is a ROUGH estimation of how fast the CPU is running in
        MegaHertz.  It was adapted from a C program found in the Intel forum of
        CIS written by Glenn Dill.  I had to do some finagling of the original code
        because C allows for a 32-bit UNSIGNED integer, whereas Pascal allows for a
        32-bit SIGNED integer (the LongInt), therefore, I was forced to reduce all
        calculations by 10 in order to get it to fit properly.
}

{ ************************************************************************** }

</i></font><font color="#FF0000"><b>Implementation

Function </b></font>WhatCPU<font color="#000080">;  </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

        </font><font color="#FF0000"><b>Asm  </b></font><font color="#008000"><i>{ Function WhatCPU }
                        </i></font><font color="#FF00FF">MOV            DX,Cpu8086
                        PUSH           SP
                        POP            AX
                        CMP            SP,AX
                        JNE                 @OUT
                        MOV                 DX,Cpu80286
                        PUSHF
                        POP            AX
                        OR             AX,4000h
                        PUSH           AX
                        POPF
                        PUSHF
                        POP            AX
                        TEST           AX,4000h
                        JE             @OUT
                        MOV                 DX,Cpu80386                        </font><font color="#008000"><i>{        &quot;DB 66h&quot; makes '386 extended instruction }
                        </i></font><font color="#FF00FF">DB 66h; MOV BX,SP              </font><font color="#008000"><i>{        MOV EBX,ESP }
                        </i></font><font color="#FF00FF">DB 66h, 83h, 0E4h, 0FCh </font><font color="#008000"><i>{        AND ESP,FFFC        }
                        </i></font><font color="#FF00FF">DB 66h; PUSHF           </font><font color="#008000"><i>{        PUSHFD }
                        </i></font><font color="#FF00FF">DB 66h; POP AX          </font><font color="#008000"><i>{        POP EAX        }
                        </i></font><font color="#FF00FF">DB 66h; MOV CX, AX      </font><font color="#008000"><i>{        MOV ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66h, 35h, 00h
                        DB 00h, 04h, 00         </font><font color="#008000"><i>{        XOR EAX,00040000        }
                        </i></font><font color="#FF00FF">DB 66h; PUSH AX         </font><font color="#008000"><i>{        PUSH EAX }
                        </i></font><font color="#FF00FF">DB 66h; POPF            </font><font color="#008000"><i>{        POPFD }
                        </i></font><font color="#FF00FF">DB 66h; PUSHF           </font><font color="#008000"><i>{        PUSHFD }
                        </i></font><font color="#FF00FF">DB 66h; POP AX          </font><font color="#008000"><i>{        POP EAX }
                        </i></font><font color="#FF00FF">DB 66h, 25h,00h
                        DB 00h, 04h,00h                </font><font color="#008000"><i>{        AND EAX,00040000 }
                        </i></font><font color="#FF00FF">DB 66h, 81h,0E1h,00h
                        DB 00h, 04h,00h                </font><font color="#008000"><i>{        AND ECX,00040000 }
                        </i></font><font color="#FF00FF">DB 66h; CMP AX,CX              </font><font color="#008000"><i>{        CMP EAX,ECX }
                        </i></font><font color="#FF00FF">JE @Not486
                        MOV DX, Cpu80486
                @Not486:
                        DB 66h; PUSH CX         </font><font color="#008000"><i>{        PUSH ECX }
                        </i></font><font color="#FF00FF">DB 66h; POPF            </font><font color="#008000"><i>{        POPFD }
                        </i></font><font color="#FF00FF">DB 66h; MOV SP, BX      </font><font color="#008000"><i>{        MOV ESP,EBX }
                </i></font><font color="#FF00FF">@Out:
                        MOV AX, DX
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;        </font><font color="#008000"><i>{ Function WhatCPU }

</i></font><font color="#FF0000"><b>Procedure </b></font>CPUSpd<font color="#000080">;

        </font><font color="#FF0000"><b>Const
                </b></font>Processor_cycles<font color="#000080">:                                </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte <font color="#000080">= (</font><font color="#800000">165</font><font color="#000080">, </font><font color="#800000">165</font><font color="#000080">, </font><font color="#800000">25</font><font color="#000080">, </font><font color="#800000">103</font><font color="#000080">, </font><font color="#800000">42</font><font color="#000080">);
                                                                                                                </font><font color="#008000"><i>{        Cycle times of 8086, 80186, 80286, 80386, 80486}

                {        Notice that here I have defined the 8086 as a Processor type of 0 vice
                        the returned value of 1 from WhatCPU.  Since the original code did not
                        distinguish between the 8086 and the 80186, I can get away with this.
                }

        </i></font><font color="#FF0000"><b>Var
                </b></font>Ticks<font color="#000080">,
                </font>Cycles<font color="#000080">,
                </font>CPS<font color="#000080">:                                                                                </font>LongInt<font color="#000080">;
                </font>Which_CPU<font color="#000080">:                                                        </font>Word<font color="#000080">;

        </font><font color="#FF0000"><b>Function </b></font>i86_to_i286<font color="#000080">:  </font>Word<font color="#000080">;  </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

                </font><font color="#FF0000"><b>Asm  </b></font><font color="#008000"><i>{ Function i86_to_i286 }
                        </i></font><font color="#FF00FF">CLI
                        MOV                CX,1234
                        XOR                DX,DX
                        XOR                AX,AX
                        MOV                AL,$B8
                        OUT                $43,AL
                        IN                AL,$61
                        OR                AL,1
                        OUT                $61,AL
                        XOR                AL,AL
                        OUT                $42,AL
                        OUT                $42,AL
                        XOR                AX,AX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IDIV        CX
                        IN                AL,$42
                        MOV                AH,AL
                        IN                AL,$42
                        XCHG        AL,AH
                        NEG                AX
                        STI
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Function i86_to_i286 }

        </i></font><font color="#FF0000"><b>Function </b></font>i386_to_i486<font color="#000080">:  </font>Word<font color="#000080">;        </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

                </font><font color="#FF0000"><b>Asm  </b></font><font color="#008000"><i>{ Function i386_to_i486 }
                        </i></font><font color="#FF00FF">CLI
                        MOV                AL,$B8
                        OUT                $43,AL
                        IN                AL,$61
                        OR                AL,1
                        OUT                $61,AL
                        XOR                AL,AL
                        OUT                $42,AL
                        OUT                $42,AL
                        DB 66H,$B8,00h,00h,00h,80h;
                        DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">DB 66H,0FH,$BC,$C8;                                </font><font color="#008000"><i>{        BSF        ECX,EAX }
                        </i></font><font color="#FF00FF">IN                AL,42H
                        MOV   AH,AL
                        IN                AL,42H
                        XCHG        AL,AH
                        NEG                AX
                        STI
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Function i386_to_486 }

        </i></font><font color="#FF0000"><b>Begin  </b></font><font color="#008000"><i>{ Procedure CPUSpd }
                </i></font>Which_CPU <font color="#000080">:= </font>WhatCPU<font color="#000080">;
                </font><font color="#FF0000"><b>If </b></font>Which_cpu <font color="#000080">&lt; </font><font color="#800000">3 </font><font color="#FF0000"><b>Then
                        </b></font>Ticks <font color="#000080">:= </font>i86_to_i286
                <font color="#FF0000"><b>Else
                        </b></font>Ticks <font color="#000080">:= </font>i386_to_i486<font color="#000080">;
                </font>Cycles <font color="#000080">:= </font><font color="#800000">20 </font><font color="#000080">* </font>Processor_cycles<font color="#000080">[</font>Which_CPU<font color="#000080">];
                </font>CPS <font color="#000080">:= (</font>Cycles <font color="#000080">* </font><font color="#800000">119318</font><font color="#000080">) </font><font color="#FF0000"><b>Div </b></font>Ticks<font color="#000080">;
                </font>MHz <font color="#000080">:= </font>CPS <font color="#FF0000"><b>Div </b></font><font color="#800000">100000</font><font color="#000080">;
                </font>KHz <font color="#000080">:= (</font>CPS <font color="#FF0000"><b>Mod </b></font><font color="#800000">100000 </font><font color="#000080">+ </font><font color="#800000">500</font><font color="#000080">) </font><font color="#FF0000"><b>Div </b></font><font color="#800000">1000
        </font><font color="#FF0000"><b>End</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Procedure CPUSpd }

</i></font><font color="#FF0000"><b>End</b></font><font color="#000080">.  </font><font color="#008000"><i>{ Unit CPUInfo }

{ ---------------------   TEST PROGRAM --------------------------}

</i></font><font color="#FF0000"><b>Program </b></font>CPUSpeed<font color="#000080">;

</font><font color="#008000"><i>{        Version 1.0.0.T.

        Requires Borland Turbo Pascal version 6.0 or later to compile.

        Author:  Bruce J. Lackore.  Created Saturday, October 9, 1993.
}

{$IFDEF Test}
        {$A+,B-,D+,E+,F-,G-,I+,L+,N-,R+,S+,V-,X+}
{$ELSE}
        {$A+,B-,D-,E+,F-,G-,I-,L-,N-,R-,S-,V-,X+}
{$ENDIF}

{$M 1024, 0, 0}

</i></font><font color="#FF0000"><b>Uses </b></font>CPUInfo<font color="#000080">;

</font><font color="#FF0000"><b>Var
        </b></font>MHz<font color="#000080">,
        </font>KHz<font color="#000080">:                                                                                        </font>Word<font color="#000080">;

</font><font color="#FF0000"><b>Begin  </b></font><font color="#008000"><i>{ Program: Cpuspeed }
        </i></font>CpuSpd<font color="#000080">(</font>MHz<font color="#000080">, </font>KHz<font color="#000080">);
        </font>Writeln<font color="#000080">(</font><font color="#800000">'The CPU speed is '</font><font color="#000080">, </font>MHz<font color="#000080">, </font><font color="#800000">'.'</font><font color="#000080">, </font>KHz<font color="#000080">, </font><font color="#800000">' MHz.'</font><font color="#000080">)
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.  </font><font color="#008000"><i>{ Program:  Cpuspeed }
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0013.PAS">Original</a><b>]</b></p></body>
</html>
