<html>
<head><title> "New CPU Type with Pentium Detection" by DAN NASH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
&gt; I'm upgrading my CPU Detection code to handle pentium... It's mostly
&gt; inline assembler in a pascal shell...

 I got this program from the Borland BBS. The description says &quot;Detect CPUs
 up to Pentium in your code&quot;.

Here is the code I use, adapted from the Intel Pentium Processor User's
Manual, Chapter 5.  It sets the Test8086 global variable, making the values
of Test8086:


   0 = 8086
   1 = 80186/80286
   2 = 80386
   3 = 80386   (new)
   4 = 80486   (new)
   5 = Pentium (new)
   6 = ??

Note that for Pentium and higher CPUs, the new CPUID instruction is used to
retrieve the processor family number.  This code should work on post-Pentium
(80686-class) CPUs and Pentium compatibles, and could return numbers &gt; 5.
}

 </i></font><font color="#FF0000"><b>program </b></font>CPUTest<font color="#000080">;

 </font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>Test8086 <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>then         </b></font><font color="#008000"><i>{ RTL check stops at 2 = 386}
  </i></font><font color="#FF0000"><b>asm
             </b></font><font color="#FF00FF">inc    Test8086     </font><font color="#008000"><i>{ 3 = 386, for consistency }
    { Do we have a 386 or a 486? }
    { Does pushf/popf preserve the Alignment Check bit? (386=no, 486=yes) }
             </i></font><font color="#FF00FF">mov    bx, sp       </font><font color="#008000"><i>{ save current stack pointer }
             </i></font><font color="#FF00FF">and    sp, not 3    </font><font color="#008000"><i>{ align stack to avoid AC fault }
    </i></font><font color="#FF00FF">db $66;  pushf
    db $66;  pop    ax
    db $66;  mov    cx, ax
    db $66, $35; dd $40000       </font><font color="#008000"><i>{ xor AC bit in EFLAGS }
    </i></font><font color="#FF00FF">db $66;  push   ax
    db $66;  popf
    db $66;  pushf
    db $66;  pop    ax
    db $66;  xor    ax, cx       </font><font color="#008000"><i>{ Is AC bit toggled? }
             </i></font><font color="#FF00FF">je @@1              </font><font color="#008000"><i>{ if not, we have a 386 }
             </i></font><font color="#FF00FF">and    sp, not 3    </font><font color="#008000"><i>{ align stack to avoid AC fault }
    </i></font><font color="#FF00FF">db $66;  push   cx
    db $66;  popf                </font><font color="#008000"><i>{ restore original AC bit }
             </i></font><font color="#FF00FF">mov    sp, bx       </font><font color="#008000"><i>{ restore original stack pointer }
             </i></font><font color="#FF00FF">mov  Test8086, 4    </font><font color="#008000"><i>{ we know we have at least a 486 }

    { Do we have a 486 or a Pentium? }
    { Does pushf/popf preserve the CPUID bit? (486=no, P5=yes) }
    </i></font><font color="#FF00FF">db $66;  mov    ax, cx       </font><font color="#008000"><i>{ get original EFLAGS}
    </i></font><font color="#FF00FF">db $66, $35; dd $200000      </font><font color="#008000"><i>{ XOR id bit in flags}
    </i></font><font color="#FF00FF">db $66;  push   ax
    db $66;  popf
    db $66;  pushf
    db $66;  pop    ax
    db $66;  xor    ax, cx      </font><font color="#008000"><i>{ Is CPUID bit toggled? }
             </i></font><font color="#FF00FF">je @@1             </font><font color="#008000"><i>{ if not, we have a 486 }
    </i></font><font color="#FF00FF">db $66;  xor    ax, ax
    db $f,$a2                   </font><font color="#008000"><i>{ CPUID, AX = 0 (get CPUID caps) }
    </i></font><font color="#FF00FF">db $66;  cmp    ax, 1
             jl @@1             </font><font color="#008000"><i>{ if &lt; 1, then exit }
    </i></font><font color="#FF00FF">db $66;  xor    ax, ax
    db $66;  inc    ax
    db $f,$a2                   </font><font color="#008000"><i>{ CPUID, AX = 1 (get CPU info)   }
             </i></font><font color="#FF00FF">and    ax, $f00    </font><font color="#008000"><i>{ mask out all but family id }
             </i></font><font color="#FF00FF">shr    ax, 8
             mov    Test8086, al      </font><font color="#008000"><i>{ Pentium family = 5 }
   </i></font><font color="#FF00FF">@@1:
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>writeln<font color="#000080">(</font><font color="#800000">'Test8086: '</font><font color="#000080">,</font>Test8086<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to HARDWARE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p></body>
</html>
