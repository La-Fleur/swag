<html>
<head><title> "VERY FAST Boyer-Moore" by COSTAS MENICO</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to FINDREPL SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
  The originial benchmark program was to demonstrate the speed difference
  between the POS() in Turbo Pascal 4 or 5 brute-force
  and the Boyer-Moore method function POSBM()
  Program author: Costas Menico

   Call: posbm(pat,buf,buflen);
   or if you are using a string buffer:
         posbm(pat,s[1],length(s));
}

</i></font><font color="#FF0000"><b>program </b></font>bufSearch<font color="#000080">;

</font><font color="#FF0000"><b>uses
  </b></font>dos<font color="#000080">, </font>crt<font color="#000080">;


</font><font color="#008000"><i>{$F+}
</i></font><font color="#FF0000"><b>function </b></font>posbm<font color="#000080">(</font>pat<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>buf<font color="#000080">; </font>buflen<font color="#000080">:</font>word<font color="#000080">):</font>word<font color="#000080">; </font><font color="#FF0000"><b>EXTERNAL</b></font><font color="#000080">;
</font><font color="#008000"><i>{$L BM.OBJ}
{$F-}

</i></font><font color="#FF0000"><b>function </b></font>bruteForce<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>such<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>buf<font color="#000080">; </font>buflen<font color="#000080">:</font>word<font color="#000080">):</font>word<font color="#000080">; </font><font color="#FF0000"><b>ASSEMBLER</b></font><font color="#000080">;
</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">cld
        push ds
        les        di,buf
        mov        cx,buflen
        jcxz @@30
        lds        si,such
        mov  al,[si]
        or   al,al
        je   @@30
        xor  ah,ah
        cmp  ax,cx
        ja   @@30
        mov  bx,si
        dec  cx
  @@10:
        mov  si,bx
        lodsw
        xchg al,ah          </font><font color="#008000"><i>{ AH=Stringl„nge, AL=Suchchar }
        </i></font><font color="#FF00FF">repne scasb
        jne  @@30
        dec  ah
        or   ah,ah
        je   @@20

        inc  cx             </font><font color="#008000"><i>{ CX++ nach rep... }
        </i></font><font color="#FF00FF">xchg cx,ax
        mov  cl,ch
        xor  ch,ch
        mov  dx,di
        repe        cmpsb
        mov  di,dx
        mov  cx,ax
        loopne @@10
  @@20:
        mov  ax,buflen
        sub  ax,cx
        dec  ax
        jmp  @@40
  @@30:
        xor  ax,ax
  @@40:
        pop  ds
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;



</font><font color="#FF0000"><b>procedure </b></font>showtime<font color="#000080">(</font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>t <font color="#000080">: </font>registers<font color="#000080">);

</font><font color="#FF0000"><b>begin
  </b></font>writeln<font color="#000080">(</font>s<font color="#000080">, </font><font color="#800000">' Hrs:'</font><font color="#000080">, </font>t<font color="#000080">.</font>ch<font color="#000080">, </font><font color="#800000">' Min:'</font><font color="#000080">, </font>t<font color="#000080">.</font>cl<font color="#000080">, </font><font color="#800000">' Sec:'</font><font color="#000080">, </font>t<font color="#000080">.</font>dh<font color="#000080">, </font><font color="#800000">' Milsec:'</font><font color="#000080">, </font>t<font color="#000080">.</font>dl<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>pat    <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>i<font color="#000080">,
  </font>j      <font color="#000080">: </font>integer<font color="#000080">;
  </font>start<font color="#000080">,
  </font>finish <font color="#000080">: </font>registers<font color="#000080">;
  </font>arr    <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">4096</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>longloop <font color="#000080">= </font><font color="#800000">5000</font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>clrscr<font color="#000080">;
  </font>randomize<font color="#000080">;
  </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">4096 </font><font color="#FF0000"><b>do
    </b></font>arr<font color="#000080">[</font>i<font color="#000080">] := </font>chr<font color="#000080">(</font>random<font color="#000080">(</font><font color="#800000">255</font><font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">);

  </font>move<font color="#000080">(</font>arr<font color="#000080">[</font><font color="#800000">4090</font><font color="#000080">],</font>pat<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font><font color="#800000">5</font><font color="#000080">); </font>pat<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#5</font><font color="#000080">;

  </font>writeln<font color="#000080">(</font><font color="#800000">'Search using Brute-Force Method &lt;please wait&gt;'</font><font color="#000080">);
  </font>start<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$2C</font><font color="#000080">;
  </font>msdos<font color="#000080">(</font>start<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>longloop <font color="#FF0000"><b>do
    </b></font>i <font color="#000080">:= </font>bruteForce<font color="#000080">(</font>pat<font color="#000080">,</font>arr<font color="#000080">,</font><font color="#800000">4096</font><font color="#000080">);
  </font>finish<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$2C</font><font color="#000080">;
  </font>msdos<font color="#000080">(</font>finish<font color="#000080">);
  </font>showtime<font color="#000080">(</font><font color="#800000">'Start  '</font><font color="#000080">, </font>start<font color="#000080">);
  </font>showtime<font color="#000080">(</font><font color="#800000">'Finish '</font><font color="#000080">, </font>finish<font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'Pattern found at position '</font><font color="#000080">, </font>i<font color="#000080">);
  </font>writeln<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'Search using Boyer-Moore Method &lt;please wait&gt;'</font><font color="#000080">);
  </font>start<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$2C</font><font color="#000080">;
  </font>msdos<font color="#000080">(</font>start<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>j <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>longloop <font color="#FF0000"><b>do
    </b></font>i <font color="#000080">:= </font>posbm<font color="#000080">(</font>pat<font color="#000080">, </font>arr<font color="#000080">,</font><font color="#800000">4096</font><font color="#000080">);
  </font>finish<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$2C</font><font color="#000080">;
  </font>msdos<font color="#000080">(</font>finish<font color="#000080">);
  </font>showtime<font color="#000080">(</font><font color="#800000">'Start  '</font><font color="#000080">, </font>start<font color="#000080">);
  </font>showtime<font color="#000080">(</font><font color="#800000">'Finish '</font><font color="#000080">, </font>finish<font color="#000080">);
  </font>writeln<font color="#000080">(</font><font color="#800000">'Pattern found at position '</font><font color="#000080">, </font>i<font color="#000080">);
  </font>writeln<font color="#000080">;
  </font>writeln<font color="#000080">(</font><font color="#800000">'Done ... Press Enter'</font><font color="#000080">);
  </font>readln<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ --------------------------   XX34 OBJECT CODE  ----------------------- }
{ ------------------------- CUT OUT AND SAVE AS BM.XX  ------------------}
{ ------------------------  USE XX3401 D BM.XX   ------------------------}

</i></font><font color="#000080">*</font>XX3401<font color="#000080">-</font><font color="#800000">000392</font><font color="#000080">-</font><font color="#800000">050693</font><font color="#000080">--</font><font color="#800000">68</font><font color="#000080">--</font><font color="#800000">85</font><font color="#000080">-</font><font color="#800000">03573</font><font color="#000080">----------</font>BM<font color="#000080">.</font>OBJ<font color="#000080">--</font><font color="#800000">1</font><font color="#000080">-</font><font color="#FF0000"><b>OF</b></font><font color="#000080">--</font><font color="#800000">1
</font>U<font color="#000080">-</font>M<font color="#000080">+</font><font color="#800000">32</font>AuL3<font color="#000080">--</font>IoB<font color="#000080">-</font>H3l<font color="#000080">-</font>IopQEYoiEJBBYcUU<font color="#000080">++++</font><font color="#800000">53</font>FpQa7j623nQqJhMalZQW<font color="#000080">+</font>UJaJm
QqZjPW<font color="#000080">+</font>n9X8NW<font color="#000080">-</font>k<font color="#000080">+</font>ECbfXgIO32AuL3<font color="#000080">--</font>IoB<font color="#000080">-</font>H3l<font color="#000080">-</font>IopQEYoiEJBB<font color="#000080">+</font>sU1<font color="#000080">+</font><font color="#800000">21</font>dH7M0<font color="#000080">++-</font>c
W<font color="#000080">+</font>A<font color="#000080">+</font>E84IZUM<font color="#000080">+-</font><font color="#800000">2</font>BDF2J3a<font color="#000080">+</font>Q<font color="#000080">+</font>OCQ<font color="#000080">++</font>U2<font color="#000080">-</font><font color="#800000">1</font>d<font color="#000080">+</font>A<font color="#000080">+++--</font>J<font color="#000080">-</font>DIo7B<font color="#000080">++++</font>rMU2<font color="#000080">+</font><font color="#800000">20</font>W<font color="#000080">+</font>N4Uuk<font color="#000080">+-
++-</font>JUSkA<font color="#000080">+</font>Mjg5X9YzAKq4<font color="#000080">+</font><font color="#800000">4</font>AbUM<font color="#000080">-</font>f<font color="#000080">+</font>f<font color="#000080">+</font>REDdjU09m6Z4<font color="#000080">+</font><font color="#800000">6</font>aq<font color="#000080">-+</font><font color="#800000">53</font>hVE<font color="#000080">-</font>X7s8<font color="#000080">+</font>Mi42U29
k5I1uO6<font color="#000080">+</font>WIM0WPM6<font color="#000080">+</font>MDt<font color="#000080">+</font>LIPlPM2<font color="#000080">+</font>On2jUU<font color="#000080">-</font>Wos0weto<font color="#000080">+</font>ya1<font color="#000080">+</font><font color="#800000">6</font>jrUys0uqyEXLs2XB8C
kcd4<font color="#000080">+</font><font color="#800000">6</font>fUiM<font color="#000080">++</font>wuj3hUE<font color="#000080">-</font>XJs2Wos<font color="#000080">+</font>GMjRXKs2AiGgWzW60y9tf6jsW<font color="#000080">+</font>i9uwKq0<font color="#000080">+</font><font color="#800000">4</font>BTUG9
JU78WoM<font color="#000080">+</font>G19zzGjEQXE1w6cQBcc<font color="#000080">-</font><font color="#800000">0</font>g<font color="#000080">-</font>pwMjSWos<font color="#000080">+</font>l9s2<font color="#000080">+</font>Iw1yTCaR<font color="#000080">+</font>ms<font color="#000080">+</font>E0BTUG9wn9z
uxK9lgKq0<font color="#000080">+</font><font color="#800000">2</font>flUI0<font color="#000080">+</font>Cg0Aw1w5sjZUQEA<font color="#000080">+</font>Jr80U<font color="#000080">-</font>fWU6<font color="#000080">++</font><font color="#800000">5E</font><font color="#000080">+
***** </font><font color="#FF0000"><b>END OF </b></font>XX<font color="#000080">-</font>BLOCK <font color="#000080">*****

</font><font color="#008000"><i>{ --------------------------   ASSEMBLER CODE  ------------------------- }
{ ------------------------- CUT OUT AND SAVE AS BM.AMS ------------------}
{ ------------------------  USE TASM TO ASSEMBLE ------------------------}

</i></font><font color="#000080">; </font>filename<font color="#000080">: </font>BM<font color="#000080">.</font><font color="#FF0000"><b>ASM
</b></font><font color="#FF00FF">; fast search routine to search strings in ARRAYS OF CHARS
; function in Turbo Pascal &gt;= 4. Based on the Boyer-Moore algorithm.
; program author: Costas Menico.
; Very small modifications for using an ARRAY OF CHAR buffer instead of
; a string made by Jochen Magnus in May 93.
; declare as follows:
; </font><font color="#008000"><i>{$F+}
</i></font><font color="#FF00FF">; </font><font color="#008000"><i>{$L BM.OBJ}
</i></font><font color="#FF00FF">; function posbm(pat:string; var buffer; buflen:word):WORD; external;
; call as follows from Turbo 4..7:
; location := posbm(pat, buf, buflen);
; call for a search in a string typed buffer:
; location := posbm(pat, str[1], length(str));


skiparrlength        equ        256

; function work stack

dstk                struc
patlen                dw        ?
strlen                dw        ?
skiparr                db        skiparrlength dup(?)
pattxt                dd        0
strtxt                dd        0
dstk                ends

; total stack (callers plus work stack)

cstk                struc
ourdata                db        size dstk dup(?)
bpsave                dw        0
retaddr                dd        0
paramlen       dw   0                                                           ; JO
straddr                dd        0
pataddr                dd        0
cstk                ends

paramsize        equ        size pataddr+size straddr +size paramlen           ; +2  JO

code                segment        para public
                assume cs:code

; entry point to posbm function

posbm                proc        far
                public        posbm

                push        bp
                         sub        sp, size dstk
                         mov        bp, sp
                         push    ds
                         xor        ah, ah
                         cld

; get and save the length and address of the pattern

                lds        si, [bp.pataddr]
                         mov        word ptr [bp.pattxt][2], ds
                         lodsb
                         or        al, al
                         jne        notnullp
                         jmp        nomatch

notnullp:
                mov        cx, ax
                         mov        [bp.patlen], ax
                         mov        word ptr [bp.pattxt], si

; get and save the length and address of the string text

                lds        si, [bp.straddr]
                         mov        word ptr [bp.strtxt][2], ds
                         mov ax,[bp.paramlen]                                          ; JO
                         or  ax,ax                                                              ; JO
                         jne        notnulls
                         jmp        nomatch

notnulls:
                mov        [bp.strlen], ax
                         mov        word ptr [bp.strtxt], si
                         cmp        cx, 1
                         jne        do_boyer_moore
                         lds        si, [bp.pattxt]
                         lodsb
                         les        di, [bp.strtxt]
                         mov        cx, [bp.strlen]
                         repne        scasb
                         jz        match1
                         jmp        nomatch

match1:
                mov        si, di
                         sub        si, 2
                         jmp        exactmatch

do_boyer_moore:

; fill the ASCII character skiparray with the
; length of the pattern

                lea        di, [bp.skiparr]
                         mov        dx, ss
                         mov        es, dx
                         mov        al, byte ptr [bp.patlen]
                         mov        ah, al
                         mov        cx, skiparrlength/2
                         rep        stosw

; replace in the ASCII skiparray the corresponding
; character offset from the </font><font color="#FF0000"><b>end of </b></font>the pattern minus <font color="#800000">1

                </font>lds        si<font color="#000080">, [</font>bp<font color="#000080">.</font>pattxt<font color="#000080">]
                         </font>lea        bx<font color="#000080">, [</font>bp<font color="#000080">.</font>skiparr<font color="#000080">]
                         </font>mov        cx<font color="#000080">, [</font>bp<font color="#000080">.</font>patlen<font color="#000080">]
                         </font>dec        cx
                         mov        bx<font color="#000080">, </font>bp
                         lea        bp<font color="#000080">, [</font>bp<font color="#000080">.</font>skiparr<font color="#000080">]
                         </font><font color="#FF0000"><b>xor        </b></font>ah<font color="#000080">, </font>ah

fill_skiparray<font color="#000080">:
                </font>lodsb
                         mov        di<font color="#000080">, </font>ax
                         mov        <font color="#000080">[</font>bp<font color="#000080">+</font>di<font color="#000080">], </font>cl
                         loop        fill_skiparray
                         lodsb
                         mov        di<font color="#000080">, </font>ax
                         mov        <font color="#000080">[</font>bp<font color="#000080">+</font>di<font color="#000080">], </font>cl
                         mov        bp<font color="#000080">, </font>bx

<font color="#000080">; </font>now initialize our pattern <font color="#FF0000"><b>and string </b></font>text pointers <font color="#FF0000"><b>to
</b></font><font color="#000080">; </font>start searching

                lds        si<font color="#000080">, [</font>bp<font color="#000080">.</font>strtxt<font color="#000080">]
                         </font>lea        di<font color="#000080">, [</font>bp<font color="#000080">.</font>skiparr<font color="#000080">]
                         </font>mov        dx<font color="#000080">, [</font>bp<font color="#000080">.</font>strlen<font color="#000080">]
                         </font>dec        dx
                         mov        ax<font color="#000080">, [</font>bp<font color="#000080">.</font>patlen<font color="#000080">]
                         </font>dec        ax
                         <font color="#FF0000"><b>xor        </b></font>bh<font color="#000080">, </font>bh
                         std

<font color="#000080">; </font>get character from text<font color="#000080">. </font>use the character <font color="#FF0000"><b>as </b></font>an index
<font color="#000080">; </font>into the skiparray<font color="#000080">, </font>looking <font color="#FF0000"><b>for </b></font>a skip value <font color="#FF0000"><b>of </b></font><font color="#800000">0.
</font><font color="#000080">; </font><font color="#FF0000"><b>if </b></font>found<font color="#000080">, </font>execute a brute<font color="#000080">-</font>force search <font color="#FF0000"><b>on </b></font>the pattern

searchlast<font color="#000080">:
                </font>sub        dx<font color="#000080">, </font>ax
                         jc        nomatch
                         add        si<font color="#000080">, </font>ax
                         mov        bl<font color="#000080">, [</font>si<font color="#000080">]
                         </font>mov        al<font color="#000080">, </font>ss<font color="#000080">:[</font>di<font color="#000080">+</font>bx<font color="#000080">]
                         </font><font color="#FF0000"><b>or        </b></font>al<font color="#000080">, </font>al
                         jne        searchlast

<font color="#000080">; </font>we have a possible match<font color="#000080">, </font>therefore
<font color="#000080">; </font><font color="#FF0000"><b>do </b></font>the reverse brute<font color="#000080">-</font>force compare

                mov        bx<font color="#000080">, </font>si
                         mov        cx<font color="#000080">, [</font>bp<font color="#000080">.</font>patlen<font color="#000080">]
                         </font>les        di<font color="#000080">, [</font>bp<font color="#000080">.</font>pattxt<font color="#000080">]
                         </font>dec        di
                         add        di<font color="#000080">, </font>cx
                         repe        cmpsb
                         je        exactmatch
                         mov        ax<font color="#000080">, </font><font color="#800000">1
                         </font>lea        di<font color="#000080">, [</font>bp<font color="#000080">.</font>skiparr<font color="#000080">]
                         </font>mov        si<font color="#000080">, </font>bx
                         <font color="#FF0000"><b>xor        </b></font>bh<font color="#000080">, </font>bh
                         jmp        short searchlast

exactmatch<font color="#000080">:
                </font>mov        ax<font color="#000080">, </font>si
                         lds        si<font color="#000080">, [</font>bp<font color="#000080">.</font>strtxt<font color="#000080">]
                         </font>sub        ax<font color="#000080">, </font>si
                         add        ax<font color="#000080">, </font><font color="#800000">2
                         </font>jmp        short endsearch

nomatch<font color="#000080">:
                </font><font color="#FF0000"><b>xor        </b></font>ax<font color="#000080">, </font>ax

endsearch<font color="#000080">:
                </font>cld
                         pop        ds
                         mov        sp<font color="#000080">, </font>bp
                         add        sp<font color="#000080">, </font>size dstk
                         pop        bp
                         ret        paramsize
posbm                endp

code                ends
                <font color="#FF0000"><b>end
</b></font><font color="#008000"><i>{-----------------------   END OF ASSEMBLER CODE -------------------------}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to FINDREPL SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p></body>
</html>
