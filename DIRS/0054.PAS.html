<html>
<head><title> "Long File Names" by DAVID O'SHEA</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DIRS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Okay everyone, a temporary kludge.. it works at least.  I'll try releasing a
full Windows 95 unit later on which will replace all the DOS functions with
new ones or something along those lines.  I ended up buying _Programmer's
Guide to Microsoft Windows 95_ from Microsoft Press.
*** D:\BP\WORK\LFN.PAS }

</i></font><font color="#FF0000"><b>program </b></font>LFNDir<font color="#000080">;
</font><font color="#008000"><i>{$N+}

{si=1 instead of 0 gives a normal DOS date/time instead of the 100ns
stuff}

</i></font><font color="#FF0000"><b>uses </b></font>DOS<font color="#000080">, </font>Strings<font color="#000080">;

</font><font color="#FF0000"><b>const

</b></font><font color="#008000"><i>{ File attribute constants }

  </i></font>ReadOnly  <font color="#000080">= </font><font color="#800000">$0001</font><font color="#000080">;
  </font>Hidden    <font color="#000080">= </font><font color="#800000">$0002</font><font color="#000080">;
  </font>SysFile   <font color="#000080">= </font><font color="#800000">$0004</font><font color="#000080">;
  </font>VolumeID  <font color="#000080">= </font><font color="#800000">$0008</font><font color="#000080">;
  </font>Directory <font color="#000080">= </font><font color="#800000">$0010</font><font color="#000080">;
  </font>Archive   <font color="#000080">= </font><font color="#800000">$0020</font><font color="#000080">;
  </font>AnyFile   <font color="#000080">= </font><font color="#800000">$003F</font><font color="#000080">;
  </font>TempFile  <font color="#000080">= </font><font color="#800000">$0100</font><font color="#000080">;

</font><font color="#FF0000"><b>var

</b></font><font color="#008000"><i>{ Error status variable }

</i></font>LFNError<font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>type

  </b></font>FindData <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>Attributes<font color="#000080">: </font>longint<font color="#000080">;
  </font>CreationTime<font color="#000080">,
  </font>LastAccessTime<font color="#000080">,
  </font>ModificationTime<font color="#000080">: </font>comp<font color="#000080">;  </font><font color="#008000"><i>{&lt;- old MS-DOS one}
  </i></font>FileSizeHigh<font color="#000080">,
  </font>FileSizeLow<font color="#000080">: </font>longint<font color="#000080">;
  </font>Reserved<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>LongFileName<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">260</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>FileName<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">14</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ASCIZToString <font color="#000080">(</font>ASCIZ<font color="#000080">: </font><font color="#FF0000"><b>array of </b></font>Char<font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font>ASCIZToString <font color="#000080">:= </font>StrPas <font color="#000080">(@</font>ASCIZ<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>FindFirst <font color="#000080">(</font>Path<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>Attr<font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>FindData<font color="#000080">): </font>word<font color="#000080">;
</font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov     LFNError, 0

push    ds
  lds     si, Path
  mov     dx, si
  inc     dx
  mov     cl, [si]

@@StringToPChar:
  inc     si
  dec     cl
  jnz     @@StringToPChar

  inc     si
  mov     byte ptr [si], 0

  les     di, F

  mov     cx, Attr
  mov     ax, 714Eh
  mov     si, 1

  int     21h                          ;</font><font color="#008000"><i>{CF set on error}
  </i></font><font color="#FF00FF">pop     ds
  jnc     @@NoCarry

  mov     LFNError, ax
  jmp     @@Exit

@@NoCarry:
cmp     ax, 7100h
  jne     @@Exit

  mov     LFNError, ax

@@Exit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>FindNext <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>FindData<font color="#000080">; </font>FileFindHandle<font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov     LFNError, 0

  mov     ax, 714Fh
  mov     si, 1
  mov     bx, FileFindHandle
  les     di, F

  int     21h

  jnc     @@NoCarry

  mov     LFNError, ax
  jmp     @@Exit

@@NoCarry:
cmp     ax, 7100h
  jne     @@Exit

  mov     LFNError, ax

@@Exit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>FindClose <font color="#000080">(</font>FileFindHandle<font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov     LFNError, 0

  mov     ax, 71A1h
  mov     bx, FileFindHandle

  int     21h

  jnc     @@NoCarry

  mov     LFNError, ax
  jmp     @@Exit

@@NoCarry:
cmp     ax, 7100h
  jne     @@Exit

  mov     LFNError, ax

@@Exit:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
</b></font>nshpers<font color="#000080">: </font>longint <font color="#000080">= </font><font color="#800000">1000000000 </font><font color="#FF0000"><b>div </b></font><font color="#800000">100</font><font color="#000080">;
</font>sixty<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">60</font><font color="#000080">;
  </font>thirtysixhundred<font color="#000080">:</font>word<font color="#000080">=</font><font color="#800000">3600</font><font color="#000080">;
  </font>hoursconst<font color="#000080">:</font>longint<font color="#000080">=</font><font color="#800000">86400</font><font color="#000080">;

</font><font color="#008000"><i>{procedure extime (time:comp;var dt:DateTime); assembler;
asm
  les     di, dt
  add     di, OFFSET DateTime. Minute
  mov     ax, es:[di]
end;}
(*
procedure expandtime (time: comp; var dt:DateTime);
assembler;
{
time = number of 100 nanosecond intervals since midnight, 1st January, 1601
yes, 1601.
second = (time / 10000000) mod 60
minute = ((time / 10000000) mod 3600) div 60

}
var
Dummy: Word;

asm

;{
COMMENT ENDCOMMENT
  blah
  blah
ENDCOMMENT
;}

  les     di, dt
  add     di, OFFSET DateTime. Sec

  ;{find seconds}
  finit                                ;{clear the stack for me!}
  fild    time                         ;{load the time into ST(0)}
  fidiv   nshpers                      ;{get the number of seconds since..}
  fst     ST(1)                        ;{save a copy for later..}
  fild    sixty                        ;{ST(0) := 60; (time -&gt; ST(1))}
  fxch                                 ;{swap ST(1) and (0)}
  fprem                                ;{ST(0) := ST(0) mod ST(1);}
  fistp   word ptr es:[di]             ;{dt. sec := ST(0)}
  sub     di, 2                        ;{es:[di] points to dt. min}

  ;{find minutes}
  fistp   Dummy                        ;{get rid of ST(0) (60)}
  fst     ST(2)                        ;{save a copy of new time for later..}
  fild    thirtysixhundred             ;{ST(0) := 3600; (time -&gt; ST(1))}
  fxch                                 ;{exchange ST0/1}
  fprem                                ;{ST(0) := ST(0) mod ST(1);}
  fxch                                 ;{exchange ST0/1}
  fistp   Dummy                        ;{get rid of ST(0) (3600)}
  fidiv   sixty                        ;{ST(0) := ST(0) / ST(1) (60)}
  fst     ST(1)                        ;{make a copy of minutes for later..}
  frndint                              ;{round off ST(1) to nearest int.}
  fcom                                 ;{compare rounded &amp; unrounded}
  fstsw   ax                           ;{store FPU status to ax}
  sahf                                 ;{store ah to CPU status}
{ jp      Error}                       ;{C2 (-&gt;parity) set on compare error}
  jc      @@NotGreater                 ;{C0 (-&gt;carry) set on less or error}
  jz      @@NotGreater                 ;{C3 (-&gt;zero) set on equal or error}
                                       ;{correct for rounding up! (no trunc)}
  fld1                                 ;{ST(0) := 1 (round (minutes) -&gt; ST(1))
  fsub                                 ;{ST(0) := ST(0) - ST(1) (minutes-1)}
@@NotGreater:                          ;{minutes was rounded down, or cont.}
  fistp   word ptr es:[di]             ;{dt. min := ST(0)}
  sub     di, 2                        ;{es:[di] points to dt. hour}

  ;{find hours}
  fistp   Dummy                        ;{get rid of ST(0) (60)}
  fst     ST(2)                        ;{save a copy of new time for later..}
  fild    hoursconst                   ;{ST(0) := 3600*24; (time -&gt; ST(1))}
  fxch                                 ;{exchange ST0/1}
  fprem                                ;{ST(0) := ST(0) mod ST(1);}
  fxch                                 ;{exchange ST0/1}
  fistp   Dummy                        ;{get rid of ST(0) (3600)}
  fidiv   thirtysixhundred             ;{ST(0) := ST(0) / ST(1) (3600)}
  fst     ST(1)                        ;{make a copy of minutes for later..}
  frndint                              ;{round off ST(1) to nearest int.}
  fcom                                 ;{compare rounded &amp; unrounded}
  fstsw   ax                           ;{store FPU status to ax}
  sahf                                 ;{store ah to CPU status}
{ jp      Error}                       ;{C2 (-&gt;parity) set on compare error}
  jc      @@NotGreater2                ;{C0 (-&gt;carry) set on less or error}
  jz      @@NotGreater2                ;{C3 (-&gt;zero) set on equal or error}
                                       ;{correct for rounding up! (no trunc)}
  fld1                                 ;{ST(0) := 1 (round (minutes) -&gt; ST(1))
  fsub                                 ;{ST(0) := ST(0) - ST(1) (minutes-1)}
@@NotGreater2:                         ;{minutes was rounded down, or cont.}
  fistp   word ptr es:[di]             ;{dt. min := ST(0)}
  sub     di, 2                        ;{es:[di] points to dt. hour}

end;


{  fxchg
  fild    nshpers

  fdiv}

{begin
  time := trunc (time / (1000*1000*1000/100));
  second := time mod 60;
  minute := time mod (60*60) div 60;
  hour := time mod (60*60*60) div (60*60);
end;}
*)
</i></font><font color="#FF0000"><b>function </b></font>long <font color="#000080">(</font>c<font color="#000080">: </font>comp<font color="#000080">):</font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
</b></font><font color="#FF00FF">mov dx, word ptr c[2]
  mov ax, word ptr c[0]
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
</b></font>Find<font color="#000080">: </font>FindData<font color="#000080">;
  </font>FileFindHandle<font color="#000080">: </font>Word<font color="#000080">;
  </font>dt<font color="#000080">: </font>DateTime<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ change this to suit your drive !! }
  </i></font>FileFindHandle <font color="#000080">:= </font>FindFirst <font color="#000080">(</font><font color="#800000">'d:\PROGRAM FILES\*.*'</font><font color="#000080">, </font><font color="#800000">255</font><font color="#000080">, </font>Find<font color="#000080">);

  </font><font color="#FF0000"><b>repeat
  If Not </b></font><font color="#000080">(</font>LFNError <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>Then begin
      </b></font>halt<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>unpacktime <font color="#000080">(</font>long <font color="#000080">(</font>find<font color="#000080">. </font>modificationtime<font color="#000080">), </font>dt<font color="#000080">);
    </font><font color="#008000"><i>{expandtime (find. modificationtime, dt);}

  </i></font>WriteLn <font color="#000080">(</font>ASCIZToString <font color="#000080">(</font>Find<font color="#000080">. </font>FileName<font color="#000080">),
</font>ASCIZToString <font color="#000080">(</font>Find<font color="#000080">. </font>LongFileName<font color="#000080">), </font>dt<font color="#000080">. </font>hour<font color="#000080">, </font><font color="#800000">':'</font><font color="#000080">, </font>dt<font color="#000080">. </font>min<font color="#000080">, </font><font color="#800000">':'</font><font color="#000080">, </font>dt<font color="#000080">. </font>sec<font color="#000080">);
</font><font color="#008000"><i>{    writeln (x);}
    </i></font>FindNext <font color="#000080">(</font>Find<font color="#000080">, </font>FileFindHandle<font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>LFNError <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);

  </font>FindClose <font color="#000080">(</font>FileFindHandle<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DIRS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0054.PAS">Original</a><b>]</b></p></body>
</html>
