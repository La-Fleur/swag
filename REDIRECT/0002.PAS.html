<html>
<head><title> "DUALOUT.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to REDIRECT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0002.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Unit </b></font>dualout<font color="#000080">;

</font><font color="#008000"><i>{ This Unit is designed to demonstrate directing all screen output to a File }
{ in addition to the normal display.  This means that any Write or Writeln   }
{ will display normally on the screen and also be Recorded in a Text File.   }
{ The File name For the output can be supplied by a command line parameter   }
{ in the Format -  dual=c:\test\output.dat or you can provide an environment }
{ Variable named dual that supplies the File name or it will default to the  }
{ current directory and output.dat.                                          }

</i></font><font color="#FF0000"><b>Interface

Uses
  </b></font>globals<font color="#000080">,  </font><font color="#008000"><i>{ contains the Function exist, which tests For the existence of  }
            { a File.  It also defines the Type str80 as String[80]          }
  </i></font>Dos<font color="#000080">,
  </font>tpString<font color="#000080">; </font><font color="#008000"><i>{ from TPro. Needed For StUpCase Function in Procedure initialise}

</i></font><font color="#FF0000"><b>Const 
  </b></font>DualOn   <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">;
  </font>DualOK   <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">;
  </font>fname    <font color="#000080">: </font>str80   <font color="#000080">= </font><font color="#800000">'output.dat'</font><font color="#000080">;  </font><font color="#008000"><i>{ The default File name For the output }
  
</i></font><font color="#FF0000"><b>Type
  </b></font>DriverFunc <font color="#000080">= </font><font color="#FF0000"><b>Function</b></font><font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f<font color="#000080">: </font>TextRec<font color="#000080">): </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>OldExitProc    <font color="#000080">: </font>Pointer<font color="#000080">;                  </font><font color="#008000"><i>{ For saving old Exit Procedure }
  </i></font>OldInOutOutput<font color="#000080">,                            </font><font color="#008000"><i>{ The old output InOut Function }
  </i></font>OldFlushOutput <font color="#000080">: </font>DriverFunc<font color="#000080">;               </font><font color="#008000"><i>{ The old output Flush Function }
  </i></font>dualf          <font color="#000080">: </font>Text<font color="#000080">;

</font><font color="#FF0000"><b>Procedure  </b></font>dual<font color="#000080">(</font>status<font color="#000080">: </font>Boolean<font color="#000080">);

</font><font color="#008000"><i>{===========================================================================}
</i></font><font color="#FF0000"><b>Implementation

Var
  </b></font>cmdline <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  
</font><font color="#FF0000"><b>Procedure </b></font>DualWrite<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f<font color="#000080">: </font>TextRec<font color="#000080">);
  </font><font color="#008000"><i>{ Writes the output from stdout to a File }
  </i></font><font color="#FF0000"><b>Var
    </b></font>x <font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    For </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>pred<font color="#000080">(</font>f<font color="#000080">.</font>BufPos<font color="#000080">) </font><font color="#FF0000"><b>do
      </b></font>Write<font color="#000080">(</font>dualf<font color="#000080">, </font>f<font color="#000080">.</font>BufPtr<font color="#000080">^[</font>x<font color="#000080">]);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ DualWrite }

{$F+}
</i></font><font color="#FF0000"><b>Function </b></font>InOutOutput<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f<font color="#000080">: </font>TextRec<font color="#000080">): </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>DualWrite<font color="#000080">(</font>f<font color="#000080">);                                        </font><font color="#008000"><i>{ Write to the File }
    </i></font>InOutOutput <font color="#000080">:= </font>OldInOutOutput<font color="#000080">(</font>f<font color="#000080">);                </font><font color="#008000"><i>{ Call the old Function }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ InOutOutput }

</i></font><font color="#FF0000"><b>Function </b></font>FlushOutput<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f<font color="#000080">: </font>TextRec<font color="#000080">): </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>DualWrite<font color="#000080">(</font>f<font color="#000080">);                                        </font><font color="#008000"><i>{ Write to the File }
    </i></font>FlushOutput <font color="#000080">:= </font>OldFlushOutput<font color="#000080">(</font>f<font color="#000080">);                </font><font color="#008000"><i>{ Call the old Function }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ FlushOutput }

</i></font><font color="#FF0000"><b>Procedure </b></font>DualExitProc<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>close<font color="#000080">(</font>dualf<font color="#000080">);
    </font>ExitProc <font color="#000080">:= </font>OldExitProc<font color="#000080">;                </font><font color="#008000"><i>{ Restore the old Exit Procedure }
    </i></font><font color="#FF0000"><b>With </b></font>TextRec<font color="#000080">(</font>output<font color="#000080">) </font><font color="#FF0000"><b>do begin
      </b></font>InOutFunc <font color="#000080">:= @</font>OldInOutOutput<font color="#000080">;          </font><font color="#008000"><i>{ Restore the old output Record }
      </i></font>FlushFunc <font color="#000080">:= @</font>OldFlushOutput<font color="#000080">;           </font><font color="#008000"><i>{ Restore the old flush Record }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ With }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ DualExitProc }

{$F-,I-}
</i></font><font color="#FF0000"><b>Procedure </b></font>dual<font color="#000080">(</font>status<font color="#000080">: </font>Boolean<font color="#000080">);
  </font><font color="#FF0000"><b>Var
    </b></font>ErrorCode <font color="#000080">: </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    if </b></font>status <font color="#FF0000"><b>then begin
      </b></font>assign<font color="#000080">(</font>dualf<font color="#000080">,</font>fname<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Exist<font color="#000080">(</font>fname<font color="#000080">) </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{ open For writing }
        </i></font>append<font color="#000080">(</font>dualf<font color="#000080">)
      </font><font color="#FF0000"><b>else </b></font><font color="#008000"><i>{ start new File }
        </i></font>reWrite<font color="#000080">(</font>dualf<font color="#000080">);
      </font>ErrorCode <font color="#000080">:= </font>Ioresult<font color="#000080">;   
      </font><font color="#FF0000"><b>if </b></font>ErrorCode <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then 
        </b></font>halt<font color="#000080">(</font>ErrorCode<font color="#000080">);
      </font><font color="#FF0000"><b>With </b></font>TextRec<font color="#000080">(</font>output<font color="#000080">) </font><font color="#FF0000"><b>do begin
        </b></font><font color="#008000"><i>{ This is where the old output Functions are rerouted }
        </i></font>OldInOutOutput <font color="#000080">:= </font>DriverFunc<font color="#000080">(</font>InOutFunc<font color="#000080">);
        </font>OldFlushOutput <font color="#000080">:= </font>DriverFunc<font color="#000080">(</font>FlushFunc<font color="#000080">);
        </font>InOutFunc <font color="#000080">:= @</font>InOutOutput<font color="#000080">;
        </font>FlushFunc <font color="#000080">:= @</font>FlushOutput<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ With }
      </i></font>OldExitProc <font color="#000080">:= </font>ExitProc<font color="#000080">;            </font><font color="#008000"><i>{ Save the current Exit Procedure }
      </i></font>ExitProc    <font color="#000080">:= @</font>DualExitProc<font color="#000080">;            </font><font color="#008000"><i>{ Install new Exit Procedure }
      </i></font>DualOn      <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ if status }  
    </i></font><font color="#FF0000"><b>else </b></font><font color="#008000"><i>{ switch dual output off } </i></font><font color="#FF0000"><b>begin  
      if </b></font>DualOn <font color="#FF0000"><b>then begin
        </b></font>close<font color="#000080">(</font>dualf<font color="#000080">);  </font><font color="#FF0000"><b>if </b></font>Ioresult <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then</b></font><font color="#000080">;                   </font><font color="#008000"><i>{ dummy call }
        </i></font>ExitProc <font color="#000080">:= </font>OldExitProc<font color="#000080">;           </font><font color="#008000"><i>{ Restore the old Exit Procedure }
        </i></font>OldExitProc <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>With </b></font>TextRec<font color="#000080">(</font>output<font color="#000080">) </font><font color="#FF0000"><b>do begin
          </b></font>InOutFunc <font color="#000080">:= @</font>OldInOutOutput<font color="#000080">;     </font><font color="#008000"><i>{ Restore the old output Record }
          </i></font>FlushFunc <font color="#000080">:= @</font>OldFlushOutput<font color="#000080">;      </font><font color="#008000"><i>{ Restore the old flush Record }
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ With }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if DualOn }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ else }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ dual }
{$I+}  


</i></font><font color="#FF0000"><b>Procedure </b></font>Initialise<font color="#000080">;
  </font><font color="#008000"><i>{ Determines if a File name For the output has been provided. }
  </i></font><font color="#FF0000"><b>begin
    if </b></font>GetEnv<font color="#000080">(</font><font color="#800000">'DUAL'</font><font color="#000080">) &lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>then
      </b></font>fname <font color="#000080">:= </font>GetEnv<font color="#000080">(</font><font color="#800000">'DUAL'</font><font color="#000080">)
    </font><font color="#FF0000"><b>else begin
      if </b></font>ParamCount <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
        </b></font>cmdline <font color="#000080">:= </font><font color="#FF0000"><b>String</b></font><font color="#000080">(</font>ptr<font color="#000080">(</font>PrefixSeg<font color="#000080">,</font><font color="#800000">$80</font><font color="#000080">)^);
        </font>cmdline <font color="#000080">:= </font>StUpCase<font color="#000080">(</font>cmdline<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>pos<font color="#000080">(</font><font color="#800000">'DUAL='</font><font color="#000080">,</font>cmdline<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
          </b></font>fname <font color="#000080">:= </font>copy<font color="#000080">(</font>cmdline<font color="#000080">,</font>pos<font color="#000080">(</font><font color="#800000">'DUAL='</font><font color="#000080">,</font>cmdline<font color="#000080">)+</font><font color="#800000">5</font><font color="#000080">,</font><font color="#800000">80</font><font color="#000080">);
          </font><font color="#FF0000"><b>if </b></font>pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">,</font>fname<font color="#000080">) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
            </b></font>fname <font color="#000080">:= </font>copy<font color="#000080">(</font>fname<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">,</font>pos<font color="#000080">(</font><font color="#800000">' '</font><font color="#000080">,</font>fname<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ if pos('Dual... }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ if ParamCount... }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ else }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ Initialise }
  
</i></font><font color="#FF0000"><b>begin
  </b></font>Initialise<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.  

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to REDIRECT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0002.PAS">Original</a><b>]</b></p></body>
</html>
