<html>
<head><title> "REDIRCT1.PAS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to REDIRECT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
All these solutions of using a shell to redirect output.

There are two Dos interrupts that allow Filehandles to be duplicated.

Redirec and unredirec allow easy access to dup and dup2 For standard in
and out (input and output are reserved TP Words) to a Text File that you
have previously opened (reset/reWrite/append as appropriate). It must be
opened - this allocates a File handle (a Byte - you declare this, you'll
need it later to get your output back). if you don't unredirec to the
right handle you could loose all your output to the File or a black hole -
be warned.

You could make similar Procedures to redirec/unredirec For redirection of
other standard handles (3 is Printer (LST), 4 I think is STDERR  and 5
is AUX aren't they?)

Here's the Unit:
}

{$O+ $F+}

</i></font><font color="#FF0000"><b>Unit </b></font>ReDIRECt<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Function </b></font>dup <font color="#000080">(</font>hand <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>error <font color="#000080">: </font>Boolean<font color="#000080">) : </font>Byte<font color="#000080">;
   </font><font color="#008000"><i>{ provides a new handle For an already opened device or File.
     if error, then the return is the error code - 4 no handles available or
     6, invalid handle.}

</i></font><font color="#FF0000"><b>Procedure </b></font>dup2 <font color="#000080">(</font>source<font color="#000080">, </font>destination <font color="#000080">: </font>Byte<font color="#000080">;  </font><font color="#FF0000"><b>Var </b></font>err <font color="#000080">: </font>Byte<font color="#000080">);
   </font><font color="#008000"><i>{ Makes two File handles refer to the same opened File at the same
     location. The destination is closed first.
     Err returns 0 if no error or error code as For dup.
     to redirect then return to normal - do as follows:
     1. Use DUP to save the handle to be directed (the source).
     2. Assign and reWrite/reset the destination.
     3. Redirect the handle using DUP2.
     4. Do the exec
     5. Use dup2 again restoring the saved handle.
     6. reset/reWrite the redirected items &amp; close the destination}

</i></font><font color="#FF0000"><b>Function </b></font>Redirec <font color="#000080">(</font>op <font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>f<font color="#000080">:</font>Text<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>hand <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{redirects standard out to (if op True) or standard in from File fn.
   returns handle in handle to be used by undirec, below, and True if
   successful.}

</i></font><font color="#FF0000"><b>Procedure </b></font>Undirec <font color="#000080">(</font>op <font color="#000080">: </font>Boolean<font color="#000080">; </font>hand <font color="#000080">: </font>Byte<font color="#000080">);
   </font><font color="#008000"><i>{undoes the redirection from the previous redirec. Assumes File closed
    by caller.}

</i></font><font color="#FF0000"><b>Function </b></font>getFilehandle<font color="#000080">(</font>Filename <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>error <font color="#000080">: </font>Boolean<font color="#000080">) : </font>Integer<font color="#000080">;

</font><font color="#008000"><i>{////////////////////////////////////////////////////////////////////////}
</i></font><font color="#FF0000"><b>Implementation

Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>dup <font color="#000080">(</font>hand <font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>error <font color="#000080">: </font>Boolean<font color="#000080">) : </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>regs <font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>regs <font color="#FF0000"><b>do
  begin
    </b></font>AH <font color="#000080">:= </font><font color="#800000">$45</font><font color="#000080">;
    </font>BX <font color="#000080">:= </font>hand<font color="#000080">;

    </font>MsDos <font color="#000080">(</font>regs<font color="#000080">);

    </font>error <font color="#000080">:= </font>flags <font color="#FF0000"><b>and </b></font>fcarry <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">;  </font><font color="#008000"><i>{error if carry set}

    </i></font>dup <font color="#000080">:= </font>AX<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>dup2 <font color="#000080">(</font>source<font color="#000080">, </font>destination <font color="#000080">: </font>Byte<font color="#000080">;  </font><font color="#FF0000"><b>Var </b></font>err <font color="#000080">: </font>Byte<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>regs <font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>regs <font color="#FF0000"><b>do
  begin
    </b></font>AH <font color="#000080">:= </font><font color="#800000">$46</font><font color="#000080">;
    </font>BX <font color="#000080">:= </font>source<font color="#000080">;
    </font>CX <font color="#000080">:= </font>destination <font color="#000080">;

    </font>MsDos <font color="#000080">(</font>regs<font color="#000080">);

    </font><font color="#FF0000"><b>if </b></font>flags <font color="#FF0000"><b>and </b></font>fcarry <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font><font color="#008000"><i>{error if carry set}
      </i></font>err <font color="#000080">:= </font>AX
    <font color="#FF0000"><b>else
      </b></font>err <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Redirec <font color="#000080">(</font>op <font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>f<font color="#000080">:</font>Text<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>hand <font color="#000080">: </font>Byte<font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{redirects standard out to (if op True) or standard in from File fn.
   returns handle in handle to be used by undirec, below, and True if
   successful.}
</i></font><font color="#FF0000"><b>Var
  </b></font>err     <font color="#000080">: </font>Byte<font color="#000080">;
  </font>error   <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>redirec <font color="#000080">:= </font>False<font color="#000080">;
  </font>err <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>op <font color="#FF0000"><b>then
  begin
    </b></font>flush <font color="#000080">(</font>output<font color="#000080">);
    </font>hand <font color="#000080">:= </font>dup <font color="#000080">(</font>Textrec<font color="#000080">(</font>output<font color="#000080">).</font>handle<font color="#000080">, </font>error<font color="#000080">)
  </font><font color="#FF0000"><b>end
  else
  begin
    </b></font>flush <font color="#000080">(</font>input<font color="#000080">);
    </font>hand <font color="#000080">:= </font>dup <font color="#000080">(</font>Textrec<font color="#000080">(</font>input<font color="#000080">).</font>handle<font color="#000080">, </font>error<font color="#000080">)
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>error <font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;
  </font><font color="#008000"><i>{$i-}
  </i></font><font color="#FF0000"><b>if </b></font>op <font color="#FF0000"><b>then
    </b></font>reWrite <font color="#000080">(</font>f<font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>reset <font color="#000080">(</font>f<font color="#000080">);
  </font><font color="#008000"><i>{$i+}
  </i></font><font color="#FF0000"><b>if </b></font>ioresult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>op <font color="#FF0000"><b>then
    </b></font>dup2 <font color="#000080">(</font>Textrec<font color="#000080">(</font>f<font color="#000080">).</font>handle<font color="#000080">, </font>Textrec<font color="#000080">(</font>output<font color="#000080">).</font>handle<font color="#000080">,</font>err<font color="#000080">)
  </font><font color="#FF0000"><b>else
    </b></font>dup2 <font color="#000080">(</font>Textrec<font color="#000080">(</font>f<font color="#000080">).</font>handle<font color="#000080">, </font>Textrec<font color="#000080">(</font>input<font color="#000080">).</font>handle<font color="#000080">,</font>err<font color="#000080">);

  </font>redirec <font color="#000080">:= (</font>err <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Undirec <font color="#000080">(</font>op <font color="#000080">: </font>Boolean<font color="#000080">; </font>hand <font color="#000080">: </font>Byte<font color="#000080">);
   </font><font color="#008000"><i>{undoes the redirection from the previous redirec. Assumes File closed
    by caller.}
</i></font><font color="#FF0000"><b>Var
  </b></font>err <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>op <font color="#FF0000"><b>then
  begin
    </b></font>dup2 <font color="#000080">(</font>hand<font color="#000080">, </font>Textrec<font color="#000080">(</font>output<font color="#000080">).</font>handle<font color="#000080">, </font>err<font color="#000080">);
    </font>reWrite <font color="#000080">(</font>output<font color="#000080">)
  </font><font color="#FF0000"><b>end
  else
  begin
    </b></font>dup2 <font color="#000080">(</font>hand<font color="#000080">, </font>Textrec<font color="#000080">(</font>input<font color="#000080">).</font>handle<font color="#000080">, </font>err<font color="#000080">);
    </font>reset <font color="#000080">(</font>input<font color="#000080">)
  </font><font color="#FF0000"><b>end
end</b></font><font color="#000080">; </font><font color="#008000"><i>{undirec}


</i></font><font color="#FF0000"><b>Function </b></font>getFilehandle<font color="#000080">( </font>Filename <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>error <font color="#000080">: </font>Boolean<font color="#000080">) : </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>regs <font color="#000080">: </font>Registers<font color="#000080">;
  </font>i <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Filename <font color="#000080">:= </font>Filename <font color="#000080">+ </font><font color="#800000">#0</font><font color="#000080">;
  </font>fillChar<font color="#000080">(</font>regs<font color="#000080">, </font>sizeof<font color="#000080">(</font>regs<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);

  </font><font color="#FF0000"><b>With </b></font>regs <font color="#FF0000"><b>do
  begin
    </b></font>ah <font color="#000080">:= </font><font color="#800000">$3D</font><font color="#000080">;
    </font>AL <font color="#000080">:= </font><font color="#800000">$00</font><font color="#000080">;
    </font>ds <font color="#000080">:= </font>seg<font color="#000080">(</font>Filename<font color="#000080">);
    </font>dx <font color="#000080">:= </font>ofs<font color="#000080">(</font>Filename<font color="#000080">) + </font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>MsDos<font color="#000080">(</font>Regs<font color="#000080">);

  </font>I <font color="#000080">:= </font>regs<font color="#000080">.</font>ax<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>lo<font color="#000080">(</font>regs<font color="#000080">.</font>flags<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$01</font><font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>error <font color="#000080">:= </font>True<font color="#000080">;
    </font>getFilehandle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Exit
  <font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>getFilehandle <font color="#000080">:= </font>i<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ Here's a demo }

</i></font><font color="#FF0000"><b>Program </b></font>dupdemo<font color="#000080">;

</font><font color="#008000"><i>{$M 2000,0,0}
</i></font><font color="#FF0000"><b>Uses
  </b></font>Direc<font color="#000080">, </font>Dos<font color="#000080">;


</font><font color="#FF0000"><b>Var
  </b></font>arcname <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>tempFile <font color="#000080">: </font>Text<font color="#000080">;
  </font>op <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>handle <font color="#000080">: </font>Byte<font color="#000080">;
  </font>Handle2 <font color="#000080">: </font>Byte<font color="#000080">;
  </font>err <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>Error <font color="#000080">: </font>Byte<font color="#000080">;
  </font>InFile <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>Handle <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

  </font>Handle2 <font color="#000080">:= </font>Dup<font color="#000080">(</font>Handle<font color="#000080">,</font>Err<font color="#000080">);

  </font><font color="#FF0000"><b>if </b></font>Err <font color="#FF0000"><b>then
  begin
     </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Error getting another handle'</font><font color="#000080">);
     </font>halt<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>arcname <font color="#000080">:= </font><font color="#800000">'C:\qmpro\download\qmpro102.ZIP'</font><font color="#000080">;
  </font>assign <font color="#000080">(</font>tempFile<font color="#000080">, </font><font color="#800000">'C:\qmpro\download\TEMP.FIL'</font><font color="#000080">);
  </font>ReWrite<font color="#000080">(</font>TempFile<font color="#000080">);

  </font>Dup2<font color="#000080">(</font>Handle<font color="#000080">, </font>Handle2<font color="#000080">, </font>Error<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Error <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
     </b></font>Writeln<font color="#000080">(</font><font color="#800000">'ERRor: '</font><font color="#000080">,</font>Error<font color="#000080">);
     </font>Halt<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


  </font><font color="#FF0000"><b>if </b></font>redirec<font color="#000080">(</font>op<font color="#000080">, </font>tempFile<font color="#000080">, </font>handle2<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>SwapVectors<font color="#000080">;
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Running ZIP!'</font><font color="#000080">);
    </font>Exec<font color="#000080">(</font><font color="#800000">'PKUNZIP'</font><font color="#000080">,</font><font color="#800000">' -V ' </font><font color="#000080">+ </font>ArcName<font color="#000080">);
    </font>SwapVectors<font color="#000080">;
    </font>close <font color="#000080">(</font>tempFile<font color="#000080">);
    </font>undirec <font color="#000080">(</font>op<font color="#000080">, </font>handle2<font color="#000080">);
  </font><font color="#FF0000"><b>end
  else
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Error!'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
I wrote the DUPDEMO Program, but the Unit is the brainchild of an author that I
can't remember, but I use this regularly.  It will work up to TP 7.0, I've
never tested it With TP 7.0 because I don't own it.
}

</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to REDIRECT SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0003.PAS">Original</a><b>]</b></p></body>
</html>
