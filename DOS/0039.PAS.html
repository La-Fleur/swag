<html>
<head><title> "DOS Environment Unit" by MARUIS ELLEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: MARIUS ELLEN
Subj: DOS Environment
}

</i></font><font color="#FF0000"><b>Program </b></font>Environment<font color="#000080">;
</font><font color="#008000"><i>{$M $1000,32776,32776 }
{    1K stack, 32k+8 bytes heap }
{$T- No @ Typed checking}
{$X+ Extended function syntax}
{$Q- No overflow checking}
{$A+ Word align data}
{$S+ Stack checking}

</i></font><font color="#FF0000"><b>uses

    </b></font>dos<font color="#000080">,
    </font>strings<font color="#000080">;

</font><font color="#FF0000"><b>type

    </b></font>PJFTRec <font color="#000080">= ^</font>TJFTRec<font color="#000080">;
    </font>TJFTRec <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>JFTtable <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">20</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font>PMCBrec <font color="#000080">= ^</font>TMCBrec<font color="#000080">;
    </font>TMCBrec <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>Next     <font color="#000080">: </font>char<font color="#000080">;      </font><font color="#008000"><i>{4d &quot;M&quot;, of 5a &quot;Z&quot;}
      </i></font>PSPOwner <font color="#000080">: </font>word<font color="#000080">;
      </font>Length   <font color="#000080">: </font>word<font color="#000080">;
      </font>Filler   <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">10</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font>PPSPrec <font color="#000080">= ^</font>TPSPrec<font color="#000080">;
    </font>TPSPrec <font color="#000080">= </font><font color="#FF0000"><b>record       </b></font><font color="#008000"><i>{ofs, length }
      </i></font>INT20   <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{00h  2 BYTEs   INT 20 instruction for CP/M CALL 0
                                           program termination the CDh 20h
                                           here is often used as a signature
                                           for a valid PSP }
      </i></font>FreeSeg <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{02h    WORD    segment of first byte beyond
                                           memory allocated to program}
      </i></font>UnUsed04<font color="#000080">:</font>byte<font color="#000080">;       </font><font color="#008000"><i>{04h    BYTE    unused filler }
      </i></font>CMPCall <font color="#000080">:</font>byte<font color="#000080">;       </font><font color="#008000"><i>{05h    BYTE    CP/M CALL 5 service request
                                           (FAR JMP to 000C0h) BUG: (DOS 2+)
                                           PSPs created by INT 21/AH=4Bh
                                           point at 000BEh}
      </i></font>CPMSize <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{06h    WORD    CP/M compatibility--size of
                                           first segment for .COM files}
      </i></font>CPMrem  <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{08h  2 BYTEs   remainder of FAR JMP at 05h}
      </i></font>INT22   <font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{0Ah    DWORD   stored INT 22 termination address}
      </i></font>INT23   <font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{0Eh    DWORD   stored INT 23 control-Break addr.}
      </i></font>INT24   <font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{12h    DWORD   DOS 1.1+ stored INT 24 address}
      </i></font>ParPSP  <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{16h    WORD    segment of parent PSP}
      </i></font>JFT     <font color="#000080">:</font>TJFTRec<font color="#000080">;    </font><font color="#008000"><i>{18h 20 BYTEs   DOS 2+ Job File Table, one byte
                                           per file handle, FFh = closed}
      </i></font>SEGEnv  <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{2Ch    WORD    DOS 2+ segment of environment
                                           for process}
      </i></font>SSSP    <font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{2Eh    DWORD   DOS 2+ process's SS:SP on entry
                                           to last INT 21 call}
      </i></font>JFTCount<font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{32h    WORD    DOS 3+ number of entries in JFT
                                           (default is 20)}
      </i></font>JFTPtr  <font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{34h    DWORD   DOS 3+ pointer to JFT
                                           (default PSP:0018h)}
      </i></font>PrevPSP <font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{38h    DWORD   DOS 3+ pointer to previous PSP
                                           (default FFFFFFFFh in 3.x)
                                           used by SHARE in DOS 3.3}
      </i></font>UnUsed3c<font color="#000080">:</font>byte<font color="#000080">;       </font><font color="#008000"><i>{3Ch    BYTE    apparently unused by DOS
                                           versions &lt;= 6.00}
      </i></font>UnUsed3d<font color="#000080">:</font>byte<font color="#000080">;       </font><font color="#008000"><i>{3Dh    BYTE    apparently used by some versions
                                           of APPEND}
      </i></font>NovFlag <font color="#000080">:</font>byte<font color="#000080">;       </font><font color="#008000"><i>{3Eh    BYTE    (Novell NetWare) flag: next byte
                                           initialized if CEh}
      </i></font>NovTask <font color="#000080">:</font>byte<font color="#000080">;       </font><font color="#008000"><i>{3Fh    BYTE    (Novell Netware) Novell task
                                           number if previous byte is CEh}
      </i></font>DosVers <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{40h  2 BYTEs   DOS 5+ version to return on
                                           INT 21/AH=30h}
      </i></font>NextPSP <font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{42h    WORD    (MSWin3) selector of next PSP
                                           (PDB) in linked list. Windows
                                           keeps a linked list of Windows
                                           programs only}
      </i></font>UnUsed44<font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{44h  4 BYTEs   unused by DOS versions &lt;= 6.00}
      </i></font>WinFlag <font color="#000080">:</font>byte<font color="#000080">;       </font><font color="#008000"><i>{48h    BYTE    (MSWindows3) bit 0 set if non-
                                           Windows application (WINOLDAP)}
      </i></font>UnUsed49<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">6</font><font color="#000080">];  </font><font color="#008000"><i>{49h  7 BYTEs   unused by DOS versions &lt;= 6.00}
      </i></font>RETF21  <font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];  </font><font color="#008000"><i>{50h  3 BYTEs   DOS 2+ service request (INT
                                           21/RETF instructions)}
      </i></font>UnUsed53<font color="#000080">:</font>word<font color="#000080">;       </font><font color="#008000"><i>{53h  2 BYTEs   unused in DOS versions &lt;= 6.00}
      </i></font>UnUsed55<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">6</font><font color="#000080">];  </font><font color="#008000"><i>{55h  7 BYTEs   unused in DOS versions &lt;= 6.00;
                                           can be used to make first FCB
                                           into an extended FCB }
      </i></font>FCB1    <font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">15</font><font color="#000080">]; </font><font color="#008000"><i>{5Ch 16 BYTEs   first default FCB, filled in
                                           from first commandline argument
                                           overwrites second FCB if opened}
      </i></font>FCB2    <font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">15</font><font color="#000080">]; </font><font color="#008000"><i>{6Ch 16 BYTEs   second default FCB, filled in
                                           from second commandline
                                           argument, overwrites beginning
                                           of commandline if opened}
      </i></font>UnUsed7c<font color="#000080">:</font>pointer<font color="#000080">;    </font><font color="#008000"><i>{7Ch  4 BYTEs   unused}
      </i></font>DTAArea <font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">127</font><font color="#000080">];</font><font color="#008000"><i>{80h 128 BYTEs  commandline / default DTA
                                           command tail is BYTE for length
                                           of tail, N BYTEs for the tail,
                                           followed by a BYTE containing
                                           0Dh}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font>PMCBPSPrec <font color="#000080">= ^</font>TMCBPSPrec<font color="#000080">;
    </font>TMCBPSPrec <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>MCB <font color="#000080">:</font>TMCBRec<font color="#000080">;
      </font>PSP <font color="#000080">:</font>TPSPRec<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var

    </b></font>MainEnvSeg<font color="#000080">:</font>word<font color="#000080">;
    </font>MainEnvSize<font color="#000080">:</font>word<font color="#000080">;


</font><font color="#008000"><i>{$ifndef TryAssembler}
    {Find DOS master environment, command/4dos etc...}
    </i></font><font color="#FF0000"><b>procedure </b></font>GetMainEnvironment<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>envseg<font color="#000080">,</font>envsize<font color="#000080">:</font>word<font color="#000080">);
    </font><font color="#FF0000"><b>var </b></font>R<font color="#000080">:</font>PMCBPSPrec<font color="#000080">;
      </font>Rrec<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>word <font color="#FF0000"><b>absolute </b></font>R<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      asm
        </b></font><font color="#FF00FF">mov     ah,52h            </font><font color="#008000"><i>{Get First MCB, }
        </i></font><font color="#FF00FF">int     $21               </font><font color="#008000"><i>{DOS Memory Control Block (MCB)}
        </i></font><font color="#FF00FF">mov     ax,es:[bx-2]      </font><font color="#008000"><i>{Bevind zich 2 terug}
        </i></font><font color="#FF00FF">mov     R.word[0],0       </font><font color="#008000"><i>{Offset is altijd 0}
        </i></font><font color="#FF00FF">mov     R.word[2],ax      </font><font color="#008000"><i>{MCB:=first DOS mcb}
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>while </b></font>true <font color="#FF0000"><b>do begin
        if </b></font>pos<font color="#000080">(</font>R<font color="#000080">^.</font>mcb<font color="#000080">.</font>next<font color="#000080">,</font><font color="#800000">'MZ'</font><font color="#000080">)=</font><font color="#800000">0
        </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">7</font><font color="#000080">);             </font><font color="#008000"><i>{Memory control block destroyed}

        </i></font><font color="#FF0000"><b>if </b></font>R<font color="#000080">^.</font>mcb<font color="#000080">.</font>PSPOwner<font color="#000080">=</font>R<font color="#000080">^.</font>PSP<font color="#000080">.</font>ParPSP <font color="#FF0000"><b>then begin </b></font><font color="#008000"><i>{found}
          </i></font>EnvSeg <font color="#000080">:=</font>R<font color="#000080">^.</font>PSP<font color="#000080">.</font>SegEnv<font color="#000080">;
          </font>R<font color="#000080">:=</font>Ptr<font color="#000080">(</font>EnvSeg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
          </font>EnvSize<font color="#000080">:=</font>R<font color="#000080">^.</font>mcb<font color="#000080">.</font>length <font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>EnvSize<font color="#000080">&gt;</font><font color="#800000">32767
          </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">10</font><font color="#000080">);          </font><font color="#008000"><i>{Environment invalid (usually &gt;32K)}
          </i></font>exit<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>if </b></font>R<font color="#000080">^.</font>mcb<font color="#000080">.</font>next<font color="#000080">=</font><font color="#800000">'Z'
        </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">(</font><font color="#800000">9</font><font color="#000080">);             </font><font color="#008000"><i>{Memory block address invalid}
                                  {Er moet een environment zijn!}
        </i></font>R<font color="#000080">:=</font>ptr<font color="#000080">((</font>Rrec<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]+(</font>R<font color="#000080">^.</font>mcb<font color="#000080">.</font>length<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{$else}
    </i></font><font color="#FF0000"><b>procedure </b></font>HaltIndirect<font color="#000080">(</font>error<font color="#000080">:</font>word<font color="#000080">);
    </font><font color="#FF0000"><b>begin
      </b></font>halt<font color="#000080">(</font>error<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font><font color="#008000"><i>{Find DOS master environment, command/4dos etc...}
    </i></font><font color="#FF0000"><b>procedure </b></font>GetMainEnvironment<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>envsegP<font color="#000080">,</font>envsizeP<font color="#000080">:</font>word<font color="#000080">);
    </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">:</font>pointer<font color="#000080">;
    </font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">mov     ah,52h            </font><font color="#008000"><i>{Get First MCB, }
        </i></font><font color="#FF00FF">int     $21               </font><font color="#008000"><i>{DOS Memory Control Block (MCB)}
        </i></font><font color="#FF00FF">sub     bx,2
        xor     dx,dx             </font><font color="#008000"><i>{offset altijd 0000}
        </i></font><font color="#FF00FF">mov     ax,es:[bx]
        mov     mcb.word[0],dx
        mov     mcb.word[2],ax    </font><font color="#008000"><i>{MCB:=first DOS mcb}

    </i></font><font color="#FF00FF">@repeat:
        les     di,mcb
        mov     bl,es:[di]
        cmp     bl,4dH
        je      @MCBOk
        cmp     bl,5aH            </font><font color="#008000"><i>{was het de laatste MCB}
        </i></font><font color="#FF00FF">jne     @MCBError         </font><font color="#008000"><i>{zo ja dan halt(9)}
    </i></font><font color="#FF00FF">@MCBOk:
        mov     ax,es:[01h]       </font><font color="#008000"><i>{is segment v/h prg bij deze MCB}
        </i></font><font color="#FF00FF">cmp     ax,es:[26h]       </font><font color="#008000"><i>{gelijk aan EnvSegment van het prg}
        </i></font><font color="#FF00FF">je      @found            </font><font color="#008000"><i>{zo ja dan is ie gevonden}

        </i></font><font color="#FF00FF">cmp     bl,5ah            </font><font color="#008000"><i>{is dit de laatste mcb ?}
        </i></font><font color="#FF00FF">je      @MCBMissing       </font><font color="#008000"><i>{!?!? MCB main env weg!?!?}
        </i></font><font color="#FF00FF">les     di,mcb            </font><font color="#008000"><i>{volgende MCB zit op}
        </i></font><font color="#FF00FF">mov     ax,es             </font><font color="#008000"><i>{oude MCB+next}
        </i></font><font color="#FF00FF">add     ax,es:[3]         </font><font color="#008000"><i>{+volgende}
        </i></font><font color="#FF00FF">inc     ax                </font><font color="#008000"><i>{+1}
        </i></font><font color="#FF00FF">mov     mcb.word[2],ax
        jmp     @repeat           </font><font color="#008000"><i>{herhaal tot gevonden}

    </i></font><font color="#FF00FF">@MCBError:
        mov     al,7              </font><font color="#008000"><i>{Memory control block destroyed}
        </i></font><font color="#FF00FF">db      0a9h              </font><font color="#008000"><i>{skip next mov al,xx=opcode test ax,w}
    </i></font><font color="#FF00FF">@MCBMissing:
        mov     al,9              </font><font color="#008000"><i>{Memory block address invalid}
        </i></font><font color="#FF00FF">db      0a9h              </font><font color="#008000"><i>{kan ook environment not found zijn!}
    </i></font><font color="#FF00FF">@SizeErr:
        mov     al,10             </font><font color="#008000"><i>{Environment invalid (usually &gt;32K)}
        </i></font><font color="#FF00FF">push    ax
        call    HaltIndirect

    @found:
        mov     ax,es:[3ch]       </font><font color="#008000"><i>{Get segment environment}
        </i></font><font color="#FF00FF">mov     dx,es             </font><font color="#008000"><i>{save es}
        </i></font><font color="#FF00FF">les     di,EnvSegP        </font><font color="#008000"><i>{ptr van VAR parameter}
        </i></font><font color="#FF00FF">mov     es:[di],ax        </font><font color="#008000"><i>{Store environment segment}
        </i></font><font color="#FF00FF">mov     es,dx             </font><font color="#008000"><i>{rest es}

        </i></font><font color="#FF00FF">dec     ax                </font><font color="#008000"><i>{MCB van env. is 1 paragraaf terug}
        </i></font><font color="#FF00FF">mov     es,ax             </font><font color="#008000"><i>{Get Size van env. uit MCB}
        </i></font><font color="#FF00FF">mov     ax,es:[3]         </font><font color="#008000"><i>{deze is in paragrafen}
        </i></font><font color="#FF00FF">mov     cl,4              </font><font color="#008000"><i>{en wordt geconverteerd}
        </i></font><font color="#FF00FF">shl     ax,cl             </font><font color="#008000"><i>{naar bytes..}

        </i></font><font color="#FF00FF">les     di,EnvSizeP       </font><font color="#008000"><i>{ptr van VAR parameter}
        </i></font><font color="#FF00FF">mov     es:[di],ax        </font><font color="#008000"><i>{Store environment size}
        </i></font><font color="#FF00FF">cmp     ax,32768          </font><font color="#008000"><i>{size moet &lt;32k}
        </i></font><font color="#FF00FF">jae     @SizeErr          </font><font color="#008000"><i>{anders een foutmelding}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$endif}

    {Seperate Variable and return parameters}
    </i></font><font color="#FF0000"><b>function </b></font>StripEnvVariable<font color="#000080">(</font>Variable<font color="#000080">:</font>pchar<font color="#000080">):</font>pchar<font color="#000080">;
    </font><font color="#FF0000"><b>const </b></font>stop<font color="#000080">=</font><font color="#800000">'='#32#0</font><font color="#000080">;
    </font><font color="#FF0000"><b>begin
      While </b></font>pos<font color="#000080">(</font>Variable<font color="#000080">^,</font>stop<font color="#000080">)=</font><font color="#800000">0 </font><font color="#FF0000"><b>do </b></font>inc<font color="#000080">(</font>Variable<font color="#000080">);
      </font>StripEnvVariable<font color="#000080">:=</font>Variable<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
      </font>Variable<font color="#000080">^:=</font><font color="#800000">#0</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font><font color="#008000"><i>{like bp's getenv, this time removing spaces}
    </i></font><font color="#FF0000"><b>function </b></font>GetMainEnv<font color="#000080">(</font>variable<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>var </b></font>MainPtr<font color="#000080">,</font>Params<font color="#000080">:</font>pchar<font color="#000080">;
      </font>data<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">512</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      </b></font>MainPtr<font color="#000080">:=</font>ptr<font color="#000080">(</font>MainEnvSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font>StrPCopy<font color="#000080">(@</font>variable<font color="#000080">,</font>variable<font color="#000080">);
      </font>StrUpper<font color="#000080">(@</font>variable<font color="#000080">);
      </font>StripEnvVariable<font color="#000080">(@</font>variable<font color="#000080">);

      </font><font color="#FF0000"><b>if </b></font>variable<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]&lt;&gt;</font><font color="#800000">#0 </font><font color="#FF0000"><b>then begin
        while </b></font><font color="#000080">(</font>MainPtr<font color="#000080">^&lt;&gt;</font><font color="#800000">#0</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
          </b></font>StrCopy<font color="#000080">(</font>Data<font color="#000080">,</font>MainPtr<font color="#000080">);
          </font>Params<font color="#000080">:=</font>StripEnvVariable<font color="#000080">(</font>data<font color="#000080">);
          </font><font color="#FF0000"><b>if </b></font>StrComp<font color="#000080">(</font>Data<font color="#000080">,@</font>Variable<font color="#000080">)=</font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
            </b></font>GetMainEnv<font color="#000080">:=</font>StrPas<font color="#000080">(</font>Params<font color="#000080">);
            </font>exit<font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font>MainPtr<font color="#000080">:=</font>StrEnd<font color="#000080">(</font>MainPtr<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>GetMainEnv<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font><font color="#008000"><i>{like bp's EnvCount}
    </i></font><font color="#FF0000"><b>function </b></font>MainEnvCount<font color="#000080">:</font>integer<font color="#000080">;
    </font><font color="#FF0000"><b>var </b></font>MainPtr<font color="#000080">:</font>pchar<font color="#000080">;
      </font>index<font color="#000080">:</font>integer<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      </b></font>index<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font>MainPtr<font color="#000080">:=</font>ptr<font color="#000080">(</font>MainEnvSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>MainPtr<font color="#000080">^&lt;&gt;</font><font color="#800000">#0</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
        </b></font>MainPtr<font color="#000080">:=</font>StrEnd<font color="#000080">(</font>MainPtr<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
        </font>inc<font color="#000080">(</font>index<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>MainEnvCount<font color="#000080">:=</font>index<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font><font color="#008000"><i>{like bp's EnvStr}
    </i></font><font color="#FF0000"><b>function </b></font>MainEnvStr<font color="#000080">(</font>index<font color="#000080">:</font>integer<font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>var </b></font>MainPtr<font color="#000080">:</font>pchar<font color="#000080">;
    </font><font color="#FF0000"><b>begin
      </b></font>MainPtr<font color="#000080">:=</font>ptr<font color="#000080">(</font>MainEnvSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>MainPtr<font color="#000080">^&lt;&gt;</font><font color="#800000">#0</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
        </b></font>dec<font color="#000080">(</font>index<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>index<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
          </b></font>MainEnvStr<font color="#000080">:=</font>StrPas<font color="#000080">(</font>MainPtr<font color="#000080">);
          </font>exit<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>MainPtr<font color="#000080">:=</font>StrEnd<font color="#000080">(</font>MainPtr<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>MainEnvStr<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


    </font><font color="#008000"><i>{change environment &quot;variable&quot;, returning succes}
    </i></font><font color="#FF0000"><b>function </b></font>MainEnvChange<font color="#000080">(</font>variable<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>param<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">):</font>boolean<font color="#000080">;
    </font><font color="#FF0000"><b>var </b></font>data<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">512</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
      </font>Mem<font color="#000080">,</font>MainPtr<font color="#000080">,</font>EnvPtr<font color="#000080">:</font>pchar<font color="#000080">;
      </font>NewSize<font color="#000080">:</font>word <font color="#FF0000"><b>absolute </b></font>EnvPtr<font color="#000080">;
      </font>EnvPtrLong<font color="#000080">:^</font>Longint <font color="#FF0000"><b>absolute </b></font>EnvPtr<font color="#000080">;


      </font><font color="#FF0000"><b>procedure </b></font>EnvStrCopy<font color="#000080">(</font>src<font color="#000080">:</font>pchar<font color="#000080">);
      </font><font color="#FF0000"><b>begin
        if </b></font>NewSize<font color="#000080">+</font>StrLen<font color="#000080">(</font>src<font color="#000080">)&lt;=</font>MainEnvSize<font color="#000080">-</font><font color="#800000">4
        </font><font color="#FF0000"><b>then begin
          </b></font>StrCopy<font color="#000080">(</font>EnvPtr<font color="#000080">,</font>Src<font color="#000080">);
          </font>EnvPtr<font color="#000080">:=</font>StrEnd<font color="#000080">(</font>EnvPtr<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
        </font><font color="#FF0000"><b>end
        else </b></font>MainEnvChange<font color="#000080">:=</font>false<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>procedure </b></font>PutVariable<font color="#000080">;
      </font><font color="#FF0000"><b>begin
        if </b></font><font color="#000080">(</font>Variable<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]&lt;&gt;</font><font color="#800000">#0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>param<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]&lt;&gt;</font><font color="#800000">#0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
          </b></font>StrCopy<font color="#000080">(</font>Data<font color="#000080">,@</font>variable<font color="#000080">);
          </font>StrCat<font color="#000080">(</font>Data<font color="#000080">,</font><font color="#800000">'='</font><font color="#000080">);
          </font>StrCat<font color="#000080">(</font>Data<font color="#000080">,@</font>param<font color="#000080">);
          </font>EnvStrCopy<font color="#000080">(</font>Data<font color="#000080">);
          </font>variable<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#0</font><font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>begin
      </b></font>getmem<font color="#000080">(</font>Mem<font color="#000080">,</font>MainEnvSize<font color="#000080">);
      </font>MainPtr<font color="#000080">:=</font>ptr<font color="#000080">(</font>MainEnvSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
      </font>EnvPtr<font color="#000080">:=</font>Mem<font color="#000080">;

      </font>StrPCopy<font color="#000080">(@</font>variable<font color="#000080">,</font>variable<font color="#000080">);
      </font>StrUpper<font color="#000080">(@</font>variable<font color="#000080">);
      </font>StripEnvVariable<font color="#000080">(@</font>variable<font color="#000080">);
      </font>StrPCopy<font color="#000080">(@</font>param<font color="#000080">,</font>param<font color="#000080">);
      </font>MainEnvChange<font color="#000080">:=</font>variable<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]&lt;&gt;</font><font color="#800000">#0</font><font color="#000080">;

      </font><font color="#FF0000"><b>while </b></font>MainPtr<font color="#000080">^&lt;&gt;</font><font color="#800000">#0 </font><font color="#FF0000"><b>do begin
        </b></font>StrCopy<font color="#000080">(</font>Data<font color="#000080">,</font>MainPtr<font color="#000080">);
        </font>StripEnvVariable<font color="#000080">(</font>data<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font>StrComp<font color="#000080">(</font>Data<font color="#000080">,@</font>Variable<font color="#000080">)=</font><font color="#800000">0
        </font><font color="#FF0000"><b>then </b></font>PutVariable
        <font color="#FF0000"><b>else </b></font>EnvStrCopy<font color="#000080">(</font>MainPtr<font color="#000080">);
        </font>MainPtr<font color="#000080">:=</font>StrEnd<font color="#000080">(</font>MainPtr<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>if </b></font>variable<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]&lt;&gt;</font><font color="#800000">#0
      </font><font color="#FF0000"><b>then </b></font>PutVariable<font color="#000080">;

      </font>EnvPtrLong<font color="#000080">^:=</font><font color="#800000">0</font><font color="#000080">; </font><font color="#008000"><i>{4 terminating zero's}
      {1 byte terminating environment}
      {2 word counting trailing strings}
      {1 byte terminating the strings}
      {. last three disables paramstr(0)}
      </i></font>move<font color="#000080">(</font>Mem<font color="#000080">^,</font>Ptr<font color="#000080">(</font>MainEnvSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)^,</font>NewSize<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">);
      </font>freeMem<font color="#000080">(</font>Mem<font color="#000080">,</font>MainEnvSize<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>var </b></font>oldprmp<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetMainEnvironment<font color="#000080">(</font>MainEnvSeg<font color="#000080">,</font>MainEnvSize<font color="#000080">);
  </font>memw<font color="#000080">[</font>prefixseg<font color="#000080">:</font><font color="#800000">$2c</font><font color="#000080">]:=</font>MainEnvSeg<font color="#000080">;

  </font>oldprmp<font color="#000080">:=</font>GetMainEnv<font color="#000080">(</font><font color="#800000">'fprompt'</font><font color="#000080">);
  </font>MainEnvChange<font color="#000080">(</font><font color="#800000">'prompt'</font><font color="#000080">,</font><font color="#800000">'Please type EXIT!'#13#10</font><font color="#000080">+</font><font color="#800000">'$p$g'</font><font color="#000080">);

  </font>swapvectors<font color="#000080">;
  </font>exec<font color="#000080">(</font>GetMainEnv<font color="#000080">(</font><font color="#800000">'comspec'</font><font color="#000080">),</font><font color="#800000">''</font><font color="#000080">);
  </font>swapvectors<font color="#000080">;

  </font>MainEnvChange<font color="#000080">(</font><font color="#800000">'prompt'</font><font color="#000080">,</font>oldprmp<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0039.PAS">Original</a><b>]</b></p></body>
</html>
