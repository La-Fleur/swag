<html>
<head><title> "Edit DOS Environment" by TURBOPOWER SOFTWARE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0005.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$R-,S-,V-,I-,B-,F-}

{Disable the following define if you don't have Turbo Professional}
{$DEFINE UseTpro}

{*********************************************************}
{*                    TPENV.PAS 1.02                     *}
{*                by TurboPower Software                 *}
{*********************************************************}

{
  Version 1.01 11/7/88
    Find master environment in Dos 3.3 and 4.0
  Version 1.02 11/14/88
    Correctly find master environment when run
      Within AUTOEXEC.BAT
}

</i></font><font color="#FF0000"><b>Unit </b></font>TpEnv<font color="#000080">;
  </font><font color="#008000"><i>{-Manipulate the environment}

</i></font><font color="#FF0000"><b>Interface

Uses </b></font>Opus<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>EnvArray <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">32767</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>EnvArrayPtr <font color="#000080">= ^</font>EnvArray<font color="#000080">;
  </font>EnvRec <font color="#000080">=
    </font><font color="#FF0000"><b>Record
      </b></font>EnvSeg <font color="#000080">: </font>Word<font color="#000080">;              </font><font color="#008000"><i>{Segment of the environment}
      </i></font>EnvLen <font color="#000080">: </font>Word<font color="#000080">;              </font><font color="#008000"><i>{Usable length of the environment}
      </i></font>EnvPtr <font color="#000080">: </font>Pointer<font color="#000080">;           </font><font color="#008000"><i>{Nil except when allocated on heap}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>ShellUserProc <font color="#000080">: </font>Pointer <font color="#000080">= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;  </font><font color="#008000"><i>{Put address of ExecDos user proc here if desi

Procedure MasterEnv(Var Env : EnvRec);
  {-Return master environment Record}

</i></font><font color="#FF0000"><b>Procedure </b></font>CurrentEnv<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Return current environment Record}

</i></font><font color="#FF0000"><b>Procedure </b></font>NewEnv<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#008000"><i>{-Allocate a new environment on the heap}

</i></font><font color="#FF0000"><b>Procedure </b></font>DisposeEnv<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Deallocate an environment previously allocated on heap}

</i></font><font color="#FF0000"><b>Procedure </b></font>SetCurrentEnv<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Specify a different environment For the current Program}

</i></font><font color="#FF0000"><b>Procedure </b></font>CopyEnv<font color="#000080">(</font>Src<font color="#000080">, </font>Dest <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Copy contents of Src environment to Dest environment}

</i></font><font color="#FF0000"><b>Function </b></font>EnvFree<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{-Return Bytes free in environment}

</i></font><font color="#FF0000"><b>Function </b></font>GetEnvStr<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Search <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{-Return a String from the environment}

</i></font><font color="#FF0000"><b>Function </b></font>SetEnvStr<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Search<font color="#000080">, </font>Value <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{-Set environment String, returning True if successful}

</i></font><font color="#FF0000"><b>Procedure </b></font>DumpEnv<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Dump the environment to StdOut}

</i></font><font color="#FF0000"><b>Function </b></font>ProgramStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{-Return the complete path to the current Program, '' if Dos &lt; 3.0}

</i></font><font color="#FF0000"><b>Function </b></font>SetProgramStr<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Path <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{-Add a Program name to the end of an environment if sufficient space}

  {$IFDEF UseTpro}
</i></font><font color="#FF0000"><b>Function </b></font>ShellWithPrompt<font color="#000080">(</font>Prompt <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Integer<font color="#000080">;
  </font><font color="#008000"><i>{-Shell to Dos With a new prompt}
  {$endIF}

</i></font><font color="#FF0000"><b>Procedure </b></font>DisposeEnv<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Deallocate an environment previously allocated on heap}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do
    if </b></font>EnvPtr <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
      </b></font>FreeMem<font color="#000080">(</font>EnvPtr<font color="#000080">, </font>EnvLen<font color="#000080">+</font><font color="#800000">31</font><font color="#000080">);
      </font>ClearEnvRec<font color="#000080">(</font>Env<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetCurrentEnv<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Specify a different environment For the current Program}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do
    if </b></font>EnvSeg <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">] := </font>EnvSeg<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>CopyEnv<font color="#000080">(</font>Src<font color="#000080">, </font>Dest <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Copy contents of Src environment to Dest environment}
</i></font><font color="#FF0000"><b>Var
  </b></font>Size <font color="#000080">: </font>Word<font color="#000080">;
  </font>SPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
  </font>DPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>Src<font color="#000080">.</font>EnvSeg <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Dest<font color="#000080">.</font>EnvSeg <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>Src<font color="#000080">.</font>EnvLen <font color="#000080">&lt;= </font>Dest<font color="#000080">.</font>EnvLen <font color="#FF0000"><b>then
    </b></font><font color="#008000"><i>{Space For the whole thing}
    </i></font>Size <font color="#000080">:= </font>Src<font color="#000080">.</font>EnvLen
  <font color="#FF0000"><b>else
    </b></font><font color="#008000"><i>{Take what fits}
    </i></font>Size <font color="#000080">:= </font>Dest<font color="#000080">.</font>EnvLen<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;

  </font>SPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Src<font color="#000080">.</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>DPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Dest<font color="#000080">.</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>Move<font color="#000080">(</font>SPtr<font color="#000080">^, </font>DPtr<font color="#000080">^, </font>Size<font color="#000080">);
  </font>FillChar<font color="#000080">(</font>DPtr<font color="#000080">^[</font>Size<font color="#000080">], </font>Dest<font color="#000080">.</font>EnvLen<font color="#000080">-</font>Size<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SkipAsciiZ<font color="#000080">(</font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>EOfs <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#008000"><i>{-Skip to end of current AsciiZ String}
</i></font><font color="#FF0000"><b>begin
  While </b></font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] &lt;&gt; </font><font color="#800000">#0 </font><font color="#FF0000"><b>do
    </b></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>EnvNext<font color="#000080">(</font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{-Return the next available location in environment at EPtr^}
</i></font><font color="#FF0000"><b>Var
  </b></font>EOfs <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>EOfs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>EPtr <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
    While </b></font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] &lt;&gt; </font><font color="#800000">#0 </font><font color="#FF0000"><b>do begin
      </b></font>SkipAsciiZ<font color="#000080">(</font>EPtr<font color="#000080">, </font>EOfs<font color="#000080">);
      </font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>EnvNext <font color="#000080">:= </font>EOfs<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>EnvFree<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{-Return Bytes free in environment}
</i></font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do
    if </b></font>EnvSeg <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>EnvFree <font color="#000080">:= </font>EnvLen<font color="#000080">-</font>EnvNext<font color="#000080">(</font>Ptr<font color="#000080">(</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">))-</font><font color="#800000">1
    </font><font color="#FF0000"><b>else
      </b></font>EnvFree <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$IFNDEF UseTpro}
</i></font><font color="#FF0000"><b>Function </b></font>StUpcase<font color="#000080">(</font>S <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{-Uppercase a String}
</i></font><font color="#FF0000"><b>Var
  </b></font>SLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>S<font color="#000080">;
  </font>I <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  For </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>SLen <font color="#FF0000"><b>do
    </b></font>S<font color="#000080">[</font>I<font color="#000080">] := </font>UpCase<font color="#000080">(</font>S<font color="#000080">[</font>I<font color="#000080">]);
  </font>StUpcase <font color="#000080">:= </font>S<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>SearchEnv<font color="#000080">(</font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
                   </font><font color="#FF0000"><b>Var </b></font>Search <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{-Return the position of Search in environment, or $FFFF if not found.
    Prior to calling SearchEnv, assure that
      EPtr is not nil,
      Search is not empty
  }
</i></font><font color="#FF0000"><b>Var
  </b></font>SLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>Search<font color="#000080">;
  </font>EOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>MOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>SOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>Match <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Force upper Case search}
  </i></font>Search <font color="#000080">:= </font>Upper<font color="#000080">(</font>Search<font color="#000080">);

  </font><font color="#008000"><i>{Assure search String ends in =}
  </i></font><font color="#FF0000"><b>if </b></font>Search<font color="#000080">[</font>SLen<font color="#000080">] &lt;&gt; </font><font color="#800000">'=' </font><font color="#FF0000"><b>then begin
    </b></font>Inc<font color="#000080">(</font>SLen<font color="#000080">);
    </font>Search<font color="#000080">[</font>SLen<font color="#000080">] := </font><font color="#800000">'='</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>EOfs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] &lt;&gt; </font><font color="#800000">#0 </font><font color="#FF0000"><b>do begin
    </b></font><font color="#008000"><i>{At the start of a new environment element}
    </i></font>SOfs <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font>MOfs <font color="#000080">:= </font>EOfs<font color="#000080">;
    </font><font color="#FF0000"><b>Repeat
      </b></font>Match <font color="#000080">:= (</font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] = </font>Search<font color="#000080">[</font>SOfs<font color="#000080">]);
      </font><font color="#FF0000"><b>if </b></font>Match <font color="#FF0000"><b>then begin
        </b></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
        </font>Inc<font color="#000080">(</font>SOfs<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>Until not </b></font>Match <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>SOfs <font color="#000080">&gt; </font>SLen<font color="#000080">);

    </font><font color="#FF0000"><b>if </b></font>Match <font color="#FF0000"><b>then begin
      </b></font><font color="#008000"><i>{Found a match, return index of start of match}
      </i></font>SearchEnv <font color="#000080">:= </font>MOfs<font color="#000080">;
      </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Skip to end of this environment String}
    </i></font>SkipAsciiZ<font color="#000080">(</font>EPtr<font color="#000080">, </font>EOfs<font color="#000080">);

    </font><font color="#008000"><i>{Skip to start of next environment String}
    </i></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{No match}
  </i></font>SearchEnv <font color="#000080">:= </font><font color="#800000">$FFFF</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>GetAsciiZ<font color="#000080">(</font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>EOfs <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>EStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
  </font><font color="#008000"><i>{-Collect AsciiZ String starting at EPtr^[EOfs]}
</i></font><font color="#FF0000"><b>Var
  </b></font>ELen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>EStr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ELen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] &lt;&gt; </font><font color="#800000">#0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>ELen <font color="#000080">&lt; </font><font color="#800000">255</font><font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>Inc<font color="#000080">(</font>ELen<font color="#000080">);
    </font>EStr<font color="#000080">[</font>ELen<font color="#000080">] := </font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">];
    </font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>GetEnvStr<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Search <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{-Return a String from the environment}
</i></font><font color="#FF0000"><b>Var
  </b></font>SLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>Search<font color="#000080">;
  </font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
  </font>EOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>EStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>ELen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>EStr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do begin
    </b></font>ELen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>EnvSeg <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>SLen <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font><font color="#008000"><i>{Find the search String}
      </i></font>EPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
      </font>EOfs <font color="#000080">:= </font>SearchEnv<font color="#000080">(</font>EPtr<font color="#000080">, </font>Search<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>EOfs <font color="#000080">&lt;&gt; </font><font color="#800000">$FFFF </font><font color="#FF0000"><b>then begin
        </b></font><font color="#008000"><i>{Skip over the search String}
        </i></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">, </font>SLen<font color="#000080">);
        </font><font color="#008000"><i>{Build the result String}
        </i></font>GetAsciiZ<font color="#000080">(</font>EPtr<font color="#000080">, </font>EOfs<font color="#000080">, </font>EStr<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>GetEnvStr <font color="#000080">:= </font>EStr<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Implementation

Type
</b></font>SO <font color="#000080">=
  </font><font color="#FF0000"><b>Record
    </b></font>O <font color="#000080">: </font>Word<font color="#000080">;
    </font>S <font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>ClearEnvRec<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Initialize an environment Record}
</i></font><font color="#FF0000"><b>begin
  </b></font>FillChar<font color="#000080">(</font>Env<font color="#000080">, </font>SizeOf<font color="#000080">(</font>Env<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>MasterEnv<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Return master environment Record}
</i></font><font color="#FF0000"><b>Var
  </b></font>Owner <font color="#000080">: </font>Word<font color="#000080">;
  </font>Mcb <font color="#000080">: </font>Word<font color="#000080">;
  </font>Eseg <font color="#000080">: </font>Word<font color="#000080">;
  </font>Done <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do begin
    </b></font>ClearEnvRec<font color="#000080">(</font>Env<font color="#000080">);

    </font><font color="#008000"><i>{Interrupt $2E points into COMMAND.COM}
    </i></font>Owner <font color="#000080">:= </font>MemW<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">:(</font><font color="#800000">2</font><font color="#000080">+</font><font color="#800000">4</font><font color="#000080">*</font><font color="#800000">$2E</font><font color="#000080">)];

    </font><font color="#008000"><i>{Mcb points to memory control block For COMMAND}
    </i></font>Mcb <font color="#000080">:= </font>Owner<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Mem<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">] &lt;&gt; </font>Byte<font color="#000080">(</font><font color="#800000">'M'</font><font color="#000080">)) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font>Owner<font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;

    </font><font color="#008000"><i>{Read segment of environment from PSP of COMMAND}
    </i></font>Eseg <font color="#000080">:= </font>MemW<font color="#000080">[</font>Owner<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">];

    </font><font color="#008000"><i>{Earlier versions of Dos don't store environment segment there}
    </i></font><font color="#FF0000"><b>if </b></font>Eseg <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font><font color="#008000"><i>{Master environment is next block past COMMAND}
      </i></font>Mcb <font color="#000080">:= </font>Owner<font color="#000080">+</font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">];
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Mem<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">] &lt;&gt; </font>Byte<font color="#000080">(</font><font color="#800000">'M'</font><font color="#000080">)) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font>Owner<font color="#000080">) </font><font color="#FF0000"><b>then
        </b></font><font color="#008000"><i>{Not the right memory control block}
        </i></font>Exit<font color="#000080">;
      </font>Eseg <font color="#000080">:= </font>Mcb<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>end else
      </b></font>Mcb <font color="#000080">:= </font>Eseg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;

    </font><font color="#008000"><i>{Return segment and length of environment}
    </i></font>EnvSeg <font color="#000080">:= </font>Eseg<font color="#000080">;
    </font>EnvLen <font color="#000080">:= </font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>CurrentEnv<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Return current environment Record}
</i></font><font color="#FF0000"><b>Var
  </b></font>ESeg <font color="#000080">: </font>Word<font color="#000080">;
  </font>Mcb <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do begin
    </b></font>ClearEnvRec<font color="#000080">(</font>Env<font color="#000080">);
    </font>ESeg <font color="#000080">:= </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">];
    </font>Mcb <font color="#000080">:= </font>ESeg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Mem<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">] &lt;&gt; </font>Byte<font color="#000080">(</font><font color="#800000">'M'</font><font color="#000080">)) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font>PrefixSeg<font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font>EnvSeg <font color="#000080">:= </font>ESeg<font color="#000080">;
    </font>EnvLen <font color="#000080">:= </font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>NewEnv<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
  </font><font color="#008000"><i>{-Allocate a new environment (on the heap)}
</i></font><font color="#FF0000"><b>Var
  </b></font>Mcb <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do
    if </b></font>MaxAvail <font color="#000080">&lt; </font>Size<font color="#000080">+</font><font color="#800000">31 </font><font color="#FF0000"><b>then
      </b></font><font color="#008000"><i>{Insufficient space}
      </i></font>ClearEnvRec<font color="#000080">(</font>Env<font color="#000080">)
    </font><font color="#FF0000"><b>else begin
      </b></font><font color="#008000"><i>{31 extra Bytes For paraGraph alignment, fake MCB}
      </i></font>GetMem<font color="#000080">(</font>EnvPtr<font color="#000080">, </font>Size<font color="#000080">+</font><font color="#800000">31</font><font color="#000080">);
      </font>EnvSeg <font color="#000080">:= </font>SO<font color="#000080">(</font>EnvPtr<font color="#000080">).</font>S<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>SO<font color="#000080">(</font>EnvPtr<font color="#000080">).</font>O <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        </b></font>Inc<font color="#000080">(</font>EnvSeg<font color="#000080">);
      </font>EnvLen <font color="#000080">:= </font>Size<font color="#000080">;
      </font><font color="#008000"><i>{Fill it With nulls}
      </i></font>FillChar<font color="#000080">(</font>EnvPtr<font color="#000080">^, </font>Size<font color="#000080">+</font><font color="#800000">31</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
      </font><font color="#008000"><i>{Make a fake MCB below it}
      </i></font>Mcb <font color="#000080">:= </font>EnvSeg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;
      </font>Mem<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">] := </font>Byte<font color="#000080">(</font><font color="#800000">'M'</font><font color="#000080">);
      </font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">1</font><font color="#000080">] := </font>PrefixSeg<font color="#000080">;
      </font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">] := (</font>Size<font color="#000080">+</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SetEnvStr<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Search<font color="#000080">, </font>Value <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{-Set environment String, returning True if successful}
</i></font><font color="#FF0000"><b>Var
  </b></font>SLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>Search<font color="#000080">;
  </font>VLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>Value<font color="#000080">;
  </font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
  </font>ENext <font color="#000080">: </font>Word<font color="#000080">;
  </font>EOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>MOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>OldLen <font color="#000080">: </font>Word<font color="#000080">;
  </font>NewLen <font color="#000080">: </font>Word<font color="#000080">;
  </font>NulLen <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do begin
    </b></font>SetEnvStr <font color="#000080">:= </font>False<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>EnvSeg <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>SLen <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font>EPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

    </font><font color="#008000"><i>{Find the search String}
    </i></font>EOfs <font color="#000080">:= </font>SearchEnv<font color="#000080">(</font>EPtr<font color="#000080">, </font>Search<font color="#000080">);

    </font><font color="#008000"><i>{Get the index of the next available environment location}
    </i></font>ENext <font color="#000080">:= </font>EnvNext<font color="#000080">(</font>EPtr<font color="#000080">);

    </font><font color="#008000"><i>{Get total length of new environment String}
    </i></font>NewLen <font color="#000080">:= </font>SLen<font color="#000080">+</font>VLen<font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font>EOfs <font color="#000080">&lt;&gt; </font><font color="#800000">$FFFF </font><font color="#FF0000"><b>then begin
      </b></font><font color="#008000"><i>{Search String exists}
      </i></font>MOfs <font color="#000080">:= </font>EOfs<font color="#000080">+</font>SLen<font color="#000080">;
      </font><font color="#008000"><i>{Scan to end of String}
      </i></font>SkipAsciiZ<font color="#000080">(</font>EPtr<font color="#000080">, </font>MOfs<font color="#000080">);
      </font>OldLen <font color="#000080">:= </font>MOfs<font color="#000080">-</font>EOfs<font color="#000080">;
      </font><font color="#008000"><i>{No extra nulls to add}
      </i></font>NulLen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>end else begin
      </b></font>OldLen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#008000"><i>{One extra null to add}
      </i></font>NulLen <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font>VLen <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font><font color="#008000"><i>{Not a pure deletion}
      </i></font><font color="#FF0000"><b>if </b></font>ENext<font color="#000080">+</font>NewLen<font color="#000080">+</font>NulLen <font color="#000080">&gt;= </font>EnvLen<font color="#000080">+</font>OldLen <font color="#FF0000"><b>then
        </b></font><font color="#008000"><i>{New String won't fit}
        </i></font>Exit<font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font>OldLen <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font><font color="#008000"><i>{OverWrite previous environment String}
      </i></font>Move<font color="#000080">(</font>EPtr<font color="#000080">^[</font>MOfs<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">], </font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">], </font>ENext<font color="#000080">-</font>MOfs<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#008000"><i>{More space free now}
      </i></font>Dec<font color="#000080">(</font>ENext<font color="#000080">, </font>OldLen<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Append new String}
    </i></font><font color="#FF0000"><b>if </b></font>VLen <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>Move<font color="#000080">(</font>Search<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>EPtr<font color="#000080">^[</font>ENext<font color="#000080">], </font>SLen<font color="#000080">);
      </font>Inc<font color="#000080">(</font>ENext<font color="#000080">, </font>SLen<font color="#000080">);
      </font>Move<font color="#000080">(</font>Value<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>EPtr<font color="#000080">^[</font>ENext<font color="#000080">], </font>VLen<font color="#000080">);
      </font>Inc<font color="#000080">(</font>ENext<font color="#000080">, </font>VLen<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#008000"><i>{Clear out the rest of the environment}
    </i></font>FillChar<font color="#000080">(</font>EPtr<font color="#000080">^[</font>ENext<font color="#000080">], </font>EnvLen<font color="#000080">-</font>ENext<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

    </font>SetEnvStr <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DumpEnv<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">);
  </font><font color="#008000"><i>{-Dump the environment to StdOut}
</i></font><font color="#FF0000"><b>Var
  </b></font>EOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  With </b></font>Env <font color="#FF0000"><b>do begin
    if </b></font>EnvSeg <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font>EPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
    </font>EOfs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>WriteLn<font color="#000080">;
    </font><font color="#FF0000"><b>While </b></font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] &lt;&gt; </font><font color="#800000">#0 </font><font color="#FF0000"><b>do begin
      While </b></font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] &lt;&gt; </font><font color="#800000">#0 </font><font color="#FF0000"><b>do begin
        </b></font>Write<font color="#000080">(</font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">]);
        </font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>WriteLn<font color="#000080">;
      </font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'Bytes free: '</font><font color="#000080">, </font>EnvFree<font color="#000080">(</font>Env<font color="#000080">));
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$IFDEF UseTpro}
</i></font><font color="#FF0000"><b>Function </b></font>ShellWithPrompt<font color="#000080">(</font>Prompt <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Integer<font color="#000080">;
  </font><font color="#008000"><i>{-Shell to Dos With a new prompt}
</i></font><font color="#FF0000"><b>Const
  </b></font>PromptStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">7</font><font color="#000080">] = </font><font color="#800000">'PROMPT='</font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>PLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>Prompt<font color="#000080">;
  </font>NSize <font color="#000080">: </font>Word<font color="#000080">;
  </font>Status <font color="#000080">: </font>Integer<font color="#000080">;
  </font>CE <font color="#000080">: </font>EnvRec<font color="#000080">;
  </font>NE <font color="#000080">: </font>EnvRec<font color="#000080">;
  </font>OldP <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>OldPLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>OldP<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Point to current environment}
  </i></font>CurrentEnv<font color="#000080">(</font>CE<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>CE<font color="#000080">.</font>EnvSeg <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font><font color="#008000"><i>{Error getting environment}
    </i></font>ShellWithPrompt <font color="#000080">:= -</font><font color="#800000">5</font><font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{Compute size of new environment}
  </i></font>OldP <font color="#000080">:= </font>GetEnvStr<font color="#000080">(</font>CE<font color="#000080">, </font>PromptStr<font color="#000080">);
  </font>NSize <font color="#000080">:= </font>CE<font color="#000080">.</font>EnvLen<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>OldPLen <font color="#000080">&lt; </font>PLen <font color="#FF0000"><b>then
    </b></font>Inc<font color="#000080">(</font>NSize<font color="#000080">, </font>PLen<font color="#000080">-</font>OldPLen<font color="#000080">);

  </font><font color="#008000"><i>{Allocate and initialize a new environment}
  </i></font>NewEnv<font color="#000080">(</font>NE<font color="#000080">, </font>NSize<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>NE<font color="#000080">.</font>EnvSeg <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font><font color="#008000"><i>{Insufficient memory For new environment}
    </i></font>ShellWithPrompt <font color="#000080">:= -</font><font color="#800000">6</font><font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>CopyEnv<font color="#000080">(</font>CE<font color="#000080">, </font>NE<font color="#000080">);

  </font><font color="#008000"><i>{Get the Program name from the current environment}
  </i></font>OldP <font color="#000080">:= </font>ProgramStr<font color="#000080">;

  </font><font color="#008000"><i>{Set the new prompt String}
  </i></font><font color="#FF0000"><b>if not </b></font>SetEnvStr<font color="#000080">(</font>NE<font color="#000080">, </font>PromptStr<font color="#000080">, </font>Prompt<font color="#000080">) </font><font color="#FF0000"><b>then begin
    </b></font><font color="#008000"><i>{Program error, should have enough space}
    </i></font>ShellWithPrompt <font color="#000080">:= -</font><font color="#800000">7</font><font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{Transfer Program name to new environment if possible}
  </i></font><font color="#FF0000"><b>if not </b></font>SetProgramStr<font color="#000080">(</font>NE<font color="#000080">, </font>OldP<font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font><font color="#000080">;

  </font><font color="#008000"><i>{Point to new environment}
  </i></font>SetCurrentEnv<font color="#000080">(</font>NE<font color="#000080">);

  </font><font color="#008000"><i>{Shell to Dos With new prompt in place}
  {Status := Exec('', True, ShellUserProc);}

  {Restore previous environment}
  </i></font>SetCurrentEnv<font color="#000080">(</font>CE<font color="#000080">);

  </font><font color="#008000"><i>{Release the heap space}
  </i></font><font color="#FF0000"><b>if </b></font>Status <font color="#000080">&gt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>DisposeEnv<font color="#000080">(</font>NE<font color="#000080">);

  </font><font color="#008000"><i>{Return exec status}
  </i></font>ShellWithPrompt <font color="#000080">:= </font>Status<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$endIF}

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ EXAMPLE PROGRAM }

</i></font><font color="#FF0000"><b>Function </b></font>DosVersion <font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{-Return the Dos version, major part in AX}
</i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(
  </font><font color="#800000">$B4</font><font color="#000080">/</font><font color="#800000">$30</font><font color="#000080">/                 </font><font color="#008000"><i>{mov ah,$30}
  </i></font><font color="#800000">$CD</font><font color="#000080">/</font><font color="#800000">$21</font><font color="#000080">/                 </font><font color="#008000"><i>{int $21}
  </i></font><font color="#800000">$86</font><font color="#000080">/</font><font color="#800000">$C4</font><font color="#000080">);                </font><font color="#008000"><i>{xchg ah,al}

</i></font><font color="#FF0000"><b>Function </b></font>ProgramStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font><font color="#008000"><i>{-Return the name of the current Program, '' if Dos &lt; 3.0}
</i></font><font color="#FF0000"><b>Var
  </b></font>EOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>Env <font color="#000080">: </font>EnvRec<font color="#000080">;
  </font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
  </font>PStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ProgramStr <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>DosVersion <font color="#000080">&lt; </font><font color="#800000">$0300 </font><font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;
  </font>CurrentEnv<font color="#000080">(</font>Env<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Env<font color="#000080">.</font>EnvSeg <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;
  </font><font color="#008000"><i>{Find the end of the current environment}
  </i></font>EPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Env<font color="#000080">.</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>EOfs <font color="#000080">:= </font>EnvNext<font color="#000080">(</font>EPtr<font color="#000080">);
  </font><font color="#008000"><i>{Skip to start of path name}
  </i></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">, </font><font color="#800000">3</font><font color="#000080">);
  </font><font color="#008000"><i>{Collect the path name}
  </i></font>GetAsciiZ<font color="#000080">(</font>EPtr<font color="#000080">, </font>EOfs<font color="#000080">, </font>PStr<font color="#000080">);
  </font>ProgramStr <font color="#000080">:= </font>PStr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>SetProgramStr<font color="#000080">(</font>Env <font color="#000080">: </font>EnvRec<font color="#000080">; </font>Path <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{-Add a Program name to the end of an environment if sufficient space}
</i></font><font color="#FF0000"><b>Var
  </b></font>PLen <font color="#000080">: </font>Byte <font color="#FF0000"><b>Absolute </b></font>Path<font color="#000080">;
  </font>EOfs <font color="#000080">: </font>Word<font color="#000080">;
  </font>Numb <font color="#000080">: </font>Word<font color="#000080">;
  </font>EPtr <font color="#000080">: </font>EnvArrayPtr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>SetProgramStr <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>With </b></font>Env <font color="#FF0000"><b>do begin
    if </b></font>EnvSeg <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font><font color="#008000"><i>{Find the end of the current environment}
    </i></font>EPtr <font color="#000080">:= </font>Ptr<font color="#000080">(</font>EnvSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
    </font>EOfs <font color="#000080">:= </font>EnvNext<font color="#000080">(</font>EPtr<font color="#000080">);
    </font><font color="#008000"><i>{Assure space For path}
    </i></font><font color="#FF0000"><b>if </b></font>EnvLen <font color="#000080">&lt; </font>PLen<font color="#000080">+</font>EOfs<font color="#000080">+</font><font color="#800000">4 </font><font color="#FF0000"><b>then
      </b></font>Exit<font color="#000080">;
    </font><font color="#008000"><i>{Put in the count field}
    </i></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">);
    </font>Numb <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font>Move<font color="#000080">(</font>Numb<font color="#000080">, </font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">], </font><font color="#800000">2</font><font color="#000080">);
    </font><font color="#008000"><i>{Skip to start of path name}
    </i></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
    </font><font color="#008000"><i>{Move the path into place}
    </i></font>Path <font color="#000080">:= </font>Upper<font color="#000080">(</font>Path<font color="#000080">);
    </font>Move<font color="#000080">(</font>Path<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">], </font>PLen<font color="#000080">);
    </font><font color="#008000"><i>{Null terminate}
    </i></font>Inc<font color="#000080">(</font>EOfs<font color="#000080">, </font>PLen<font color="#000080">);
    </font>EPtr<font color="#000080">^[</font>EOfs<font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;
    </font>SetProgramStr <font color="#000080">:= </font>True<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0005.PAS">Original</a><b>]</b></p></body>
</html>
