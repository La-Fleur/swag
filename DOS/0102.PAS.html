<html>
<head><title> "Direct DOS File Functions" by VIKTOR OSTASHEV</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0102.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$x+}

</i></font><font color="#FF0000"><b>unit </b></font>dosfile<font color="#000080">;

</font><font color="#FF0000"><b>interface

var
     </b></font>ferror              <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#008000"><i>{
DOS error
}


</i></font><font color="#FF0000"><b>function </b></font>fopen<font color="#000080">(</font>name <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>mode <font color="#000080">: </font>char<font color="#000080">) : </font>word<font color="#000080">;
</font><font color="#008000"><i>{
name - filename (with path), mode - r - read, w - write, + - r/w,
a - append.
return: handle or $ffff if error
If file opened for write or append and don't exist, then create it
If file opened for write, truncated it to pos 0
}

</i></font><font color="#FF0000"><b>function </b></font>fclose<font color="#000080">(</font>handle <font color="#000080">: </font>word<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{
Close file. If error then return FALSE
}

</i></font><font color="#FF0000"><b>function </b></font>fseek<font color="#000080">(</font>handle <font color="#000080">: </font>word<font color="#000080">; </font>offset <font color="#000080">: </font>longint<font color="#000080">; </font>mode <font color="#000080">: </font>byte<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{
Seek file pointer to offset bytes
mode 0 - from begin 1 - from current 2 - from end
}

</i></font><font color="#FF0000"><b>function </b></font>fread<font color="#000080">(</font>handle<font color="#000080">, </font>count <font color="#000080">: </font>word<font color="#000080">; </font>dest <font color="#000080">: </font>pointer<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{
Read count bytes to dest buffer
}

</i></font><font color="#FF0000"><b>function </b></font>fwrite<font color="#000080">(</font>handle<font color="#000080">, </font>count <font color="#000080">: </font>word<font color="#000080">; </font>sourc <font color="#000080">: </font>pointer<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{
Write count bytes from sourc buffer
}

</i></font><font color="#FF0000"><b>function </b></font>fflush<font color="#000080">(</font>handle <font color="#000080">: </font>word<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{
Flush file
}

</i></font><font color="#FF0000"><b>implementation

     function </b></font>fopen<font color="#000080">;
     </font><font color="#FF0000"><b>var
          </b></font>asciiz              <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">255</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
          </font>i<font color="#000080">, </font>acs              <font color="#000080">: </font>byte<font color="#000080">;
          </font>nptr                <font color="#000080">: </font>pointer<font color="#000080">;
          </font>hnd                 <font color="#000080">: </font>word<font color="#000080">;
     </font><font color="#FF0000"><b>begin
          for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>ord<font color="#000080">(</font>name<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]) </font><font color="#FF0000"><b>do </b></font>asciiz<font color="#000080">[</font>i<font color="#000080">] := </font>name<font color="#000080">[</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">];
          </font>asciiz<font color="#000080">[</font>ord<font color="#000080">(</font>name<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])] := </font><font color="#800000">#0</font><font color="#000080">;
          </font>nptr <font color="#000080">:= @</font>asciiz<font color="#000080">;
          </font>ferror <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#FF0000"><b>case </b></font>mode <font color="#FF0000"><b>of
               </b></font><font color="#800000">'r' </font><font color="#000080">: </font>acs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
               </font><font color="#800000">'w' </font><font color="#000080">: </font>acs <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
               </font><font color="#800000">'+' </font><font color="#000080">: </font>acs <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;
               </font><font color="#800000">'a' </font><font color="#000080">: </font>acs <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>asm
               </b></font><font color="#FF00FF">cmp  mode, 'w'
               je   @trunc
               push ds
               push dx
               mov  ah, 3Dh
               mov  al, acs
               lds  dx, nptr
               int  21h
               pop  dx
               pop  ds
               jnc  @noerr
               cmp  mode, 'a'
               jne  @err
               cmp  ax, 0002h
               jne  @err
               @trunc:
               push ds
               push dx
               push cx
               xor  cx, cx
               mov  ah, 3Ch
               lds  dx, nptr
               int  21h
               pop  cx
               pop  dx
               pop  ds
               jnc  @noerr
               @err:
               mov  ferror, ax
               mov  ax, 0FFFFh
               @noerr:
               mov  hnd, ax
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>mode <font color="#000080">= </font><font color="#800000">'a'</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>ferror <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>fseek<font color="#000080">(</font>hnd<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);
          </font>fopen <font color="#000080">:= </font>hnd<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>function </b></font>fclose<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>asm
          </b></font><font color="#FF00FF">push bx
          mov  ferror, 0
          mov  bx, handle
          mov  ah, 3Eh
          int  21h
          mov  bx, ax
          mov  ax, 01h
          jnc  @noerr
          mov  ferror, bx
          xor  ax, ax
          @noerr:
          pop  bx
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>function </b></font>fseek<font color="#000080">;
     </font><font color="#FF0000"><b>type
          </b></font>tlong <font color="#000080">= </font><font color="#FF0000"><b>record
                       case </b></font>boolean <font color="#FF0000"><b>of
                            </b></font>true <font color="#000080">: (</font>long <font color="#000080">: </font>longint<font color="#000080">);
                            </font>false <font color="#000080">: (</font>lword<font color="#000080">, </font>hword <font color="#000080">: </font>word<font color="#000080">);
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>var
          </b></font>offs                <font color="#000080">: </font>tlong<font color="#000080">;
     </font><font color="#FF0000"><b>begin
          </b></font>offs<font color="#000080">.</font>long <font color="#000080">:= </font>offset<font color="#000080">;
          </font>ferror <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#FF0000"><b>asm
               </b></font><font color="#FF00FF">push bx
               push cx
               push dx
               mov  ah, 42h
               mov  al, mode
               mov  bx, handle
               mov  cx, offs.hword
               mov  dx, offs.lword
               int  21h
               jnc  @noerr
               mov  ferror, ax
               @noerr:
               pop  dx
               pop  cx
               pop  bx
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font>ferror <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>fseek <font color="#000080">:= </font>true
                        <font color="#FF0000"><b>else </b></font>fseek <font color="#000080">:= </font>false<font color="#000080">;
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>function </b></font>fread<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>asm
          </b></font><font color="#FF00FF">push bx
          push cx
          push dx
          push ds
          mov  ferror, 0
          mov  ah, 3Fh
          mov  bx, handle
          mov  cx, count
          lds  dx, dest
          int  21h
          pop  ds
          jnc  @noerr
          mov  ferror, ax
          xor  ax, ax
          @noerr:
          pop  dx
          pop  cx
          pop  bx
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>function </b></font>fwrite<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>asm
          </b></font><font color="#FF00FF">push bx
          push cx
          push dx
          push ds
          mov  ferror, 0
          mov  ah, 40h
          mov  bx, handle
          mov  cx, count
          lds  dx, sourc
          int  21h
          pop  ds
          jnc  @noerr
          mov  ferror, ax
          xor  ax, ax
          @noerr:
          pop  dx
          pop  cx
          pop  bx
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font><font color="#FF0000"><b>function </b></font>fflush<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
     </font><font color="#FF0000"><b>asm
          </b></font><font color="#FF00FF">push bx
          mov  ferror, 0
          mov  ah, 68h
          mov  bx, handle
          int  21h
          mov  bx, ax
          mov  ax, 0001h
          jnc  @noerr
          mov  ferror, bx
          xor  ax, ax
          @noerr:
          pop  bx
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0102.PAS">Original</a><b>]</b></p></body>
</html>
