<html>
<head><title> "DPMI File Extender" by KIM KOKKONEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$R-,S-}

{PEXTEND
 ------------------------------------------------------------------
 This unit provides a single function, DpmiExtendHandles, for
 extending the file handle table for DOS protected mode applications
 under Borland Pascal 7.0.

 The standard DOS call for this purpose (AH = $67) does odd things to
 DOS memory when run from a BP7 pmode program. If you Exec from a
 program that has extended the handle table, DOS memory will be
 fragmented, leaving a stranded block of almost 64K at the top of DOS
 memory. The function implemented here avoids this problem.

 If you haven't used an ExtendHandles function before, note that you
 cannot get more handles than the FILES= statement in CONFIG.SYS
 allows. (Other utilities such as FILES.COM provided with QEMM do the
 same thing.) However, even if you have FILES=255, any single program
 cannot open more than 20 files (and DOS uses up 5 of those) unless
 you use a routine like DpmiExtendHandles. This routine allows up to
 255 open files as long as the FILES= statement provides for them.

 This code works only for DOS 3.0 or later. Since (to my knowledge)
 DPMI cannot be used with earlier versions of DOS, the code doesn't
 check the DOS version.

 Don't call this function more than once in the same program.

 Version 1.0,
   Written 12/15/92, Kim Kokkonen, TurboPower Software
}

{$IFNDEF DPMI}
  </i></font><font color="#000080">!! </font>Error<font color="#000080">: </font>this <font color="#FF0000"><b>unit for </b></font>DPMI applications only
<font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>unit </b></font>PExtend<font color="#000080">;
  </font><font color="#008000"><i>{-Extend handle table for DOS protected mode applications}

</i></font><font color="#FF0000"><b>interface

function </b></font>DpmiExtendHandles<font color="#000080">(</font>Handles <font color="#000080">: </font>Byte<font color="#000080">) : </font>Word<font color="#000080">;
  </font><font color="#008000"><i>{-Extend handle table to Handles size.
    Returns 0 for success, else a DOS error code.
    Does nothing and returns 0 if Handles &lt;= 20.}

</i></font><font color="#FF0000"><b>implementation

uses
  </b></font>WinApi<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>DpmiExtendHandles<font color="#000080">(</font>Handles <font color="#000080">: </font>Byte<font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>DosMemRec <font color="#000080">=
    </font><font color="#FF0000"><b>record
      </b></font>Sele<font color="#000080">, </font>Segm <font color="#000080">: </font>Word<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>OldTable <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>OldSize <font color="#000080">: </font>Word<font color="#000080">;
  </font>NewTable <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>DosMem <font color="#000080">: </font>DosMemRec<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DpmiExtendHandles <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Handles <font color="#000080">&lt;= </font><font color="#800000">20 </font><font color="#FF0000"><b>then
    </b></font>Exit<font color="#000080">;

  </font><font color="#008000"><i>{Allocate new table area in DOS memory}
  </i></font>LongInt<font color="#000080">(</font>DosMem<font color="#000080">) := </font>GlobalDosAlloc<font color="#000080">(</font>Handles<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>LongInt<font color="#000080">(</font>DosMem<font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
    </b></font>DpmiExtendHandles <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{Initialize new table with closed handles}
  </i></font>NewTable <font color="#000080">:= </font>Ptr<font color="#000080">(</font>DosMem<font color="#000080">.</font>Sele<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
  </font>FillChar<font color="#000080">(</font>NewTable<font color="#000080">^, </font>Handles<font color="#000080">, </font><font color="#800000">$FF</font><font color="#000080">);

  </font><font color="#008000"><i>{Copy old table to new. Assume old table in PrefixSeg}
  </i></font>OldTable <font color="#000080">:= </font>Ptr<font color="#000080">(</font>PrefixSeg<font color="#000080">, </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$34</font><font color="#000080">]);
  </font>OldSize <font color="#000080">:= </font>Mem<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$32</font><font color="#000080">];
  </font>move<font color="#000080">(</font>OldTable<font color="#000080">^, </font>NewTable<font color="#000080">^, </font>OldSize<font color="#000080">);

  </font><font color="#008000"><i>{Set new handle table size and pointer}
  </i></font>Mem<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$32</font><font color="#000080">] := </font>Handles<font color="#000080">;
  </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$34</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
  </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$36</font><font color="#000080">] := </font>DosMem<font color="#000080">.</font>Segm<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0050.PAS">Original</a><b>]</b></p></body>
</html>
