<html>
<head><title> "SETENV Unit" by RICHARD MARKS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0115.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>unit </b></font>setenv<font color="#000080">;
</font><font color="#FF0000"><b>interface
type  </b></font>s24 <font color="#000080">= </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>SetTheEnv <font color="#000080">(</font>symbol<font color="#000080">, </font>val <font color="#000080">: </font>s24<font color="#000080">) : </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>implementation
</b></font><font color="#008000"><i>{uses asciiz;}
</i></font><font color="#FF0000"><b>const
   </b></font>arena_size <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">;
   </font>NORMAL_ATYPE <font color="#000080">= </font><font color="#800000">#$4D</font><font color="#000080">;
   </font>LAST_ATYPE   <font color="#000080">= </font><font color="#800000">#$5A</font><font color="#000080">;
   </font>COMSPEC <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">8</font><font color="#000080">] = </font><font color="#800000">'COMSPEC='</font><font color="#000080">;

</font><font color="#FF0000"><b>type
    </b></font>PSP <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>	fill1              <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">10</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>PrevTermHandlerPtr <font color="#000080">: ^</font>integer<font color="#000080">;
</font>	PrevCtrlCptr       <font color="#000080">: ^</font>integer<font color="#000080">;
</font>	PrevCritErrPtr     <font color="#000080">: ^</font>integer<font color="#000080">;
</font>	fill2              <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">22</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
</font>	EnvirSeg           <font color="#000080">: </font>word<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>Arena <font color="#000080">= </font><font color="#FF0000"><b>record
</b></font>	ArenaType     <font color="#000080">: </font>char<font color="#000080">;
</font>	PspSegment    <font color="#000080">: </font>word<font color="#000080">;
</font>	NumOfSegments <font color="#000080">: </font>word<font color="#000080">;
        </font>fill3         <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">11</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
        </font>ArenaData     <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font><font color="#008000"><i>{ca}
        </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

     </font>str4 <font color="#000080">= </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];

</font><font color="#FF0000"><b>var
    </b></font>ap    <font color="#000080">: ^</font>arena<font color="#000080">;

</font><font color="#008000"><i>{$ifdef Debug}
</i></font><font color="#FF0000"><b>Function </b></font>HexStr <font color="#000080">(</font>n<font color="#000080">:</font>word<font color="#000080">):</font>str4<font color="#000080">;
   </font><font color="#FF0000"><b>const </b></font>ha<font color="#000080">:</font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">=(</font><font color="#800000">'0'</font><font color="#000080">,</font><font color="#800000">'1'</font><font color="#000080">,</font><font color="#800000">'2'</font><font color="#000080">,</font><font color="#800000">'3'</font><font color="#000080">,</font><font color="#800000">'4'</font><font color="#000080">,</font><font color="#800000">'5'</font><font color="#000080">,</font><font color="#800000">'6'</font><font color="#000080">,</font><font color="#800000">'7'</font><font color="#000080">,</font><font color="#800000">'8'</font><font color="#000080">,</font><font color="#800000">'9'</font><font color="#000080">,</font><font color="#800000">'a'</font><font color="#000080">,</font><font color="#800000">'b'</font><font color="#000080">,</font><font color="#800000">'c'</font><font color="#000080">,</font><font color="#800000">'d'</font><font color="#000080">,</font><font color="#800000">'e'</font><font color="#000080">,</font><font color="#800000">'f'</font><font color="#000080">);
   </font><font color="#FF0000"><b>var </b></font>str <font color="#000080">: </font>str4<font color="#000080">;
   </font><font color="#FF0000"><b>begin
   </b></font>str<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>chr<font color="#000080">(</font><font color="#800000">4</font><font color="#000080">);
   </font>str<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]:=</font>ha<font color="#000080">[</font>hi<font color="#000080">(</font>n<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">];
   </font>str<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">]:=</font>ha<font color="#000080">[</font>hi<font color="#000080">(</font>n<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$F</font><font color="#000080">];
   </font>str<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">]:=</font>ha<font color="#000080">[(</font>n <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">$F</font><font color="#000080">];
   </font>str<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">]:=</font>ha<font color="#000080">[</font>n <font color="#FF0000"><b>and </b></font><font color="#800000">$F</font><font color="#000080">];
   </font>HexStr <font color="#000080">:= </font>str<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$endif}


</i></font><font color="#FF0000"><b>Function </b></font>GetNextArena <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>ap<font color="#000080">:</font>arena<font color="#000080">) : </font>pointer<font color="#000080">;
   </font><font color="#FF0000"><b>var </b></font>tp <font color="#000080">: </font>pointer<font color="#000080">;
   </font><font color="#FF0000"><b>begin
   </b></font>tp <font color="#000080">:= </font>Ptr<font color="#000080">( </font>Seg<font color="#000080">(</font>ap<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">+</font>ap<font color="#000080">.</font>NumOfSegments<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
   </font>GetNextArena <font color="#000080">:= </font>tp<font color="#000080">;
   </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{GetNextArena}</i></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>IsValidArena <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>ar<font color="#000080">:</font>arena<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var </b></font>ap1 <font color="#000080">: ^</font>arena<font color="#000080">;
   </font><font color="#FF0000"><b>begin
   </b></font>IsValidArena <font color="#000080">:= </font>false<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>ar<font color="#000080">.</font>ArenaType <font color="#000080">&lt;&gt; </font>NORMAL_ATYPE   <font color="#FF0000"><b>then  </b></font>Exit<font color="#000080">;
   </font>ap1 <font color="#000080">:= </font>GetNextArena <font color="#000080">(</font>ar<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>ap1<font color="#000080">^.</font>ArenaType <font color="#000080">&lt;&gt; </font>NORMAL_ATYPE <font color="#FF0000"><b>then  </b></font>Exit<font color="#000080">;

   </font>ap1 <font color="#000080">:= </font>GetNextArena <font color="#000080">(</font>ap1<font color="#000080">^);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>ap1<font color="#000080">^.</font>ArenaType <font color="#000080">&lt;&gt; </font>NORMAL_ATYPE<font color="#000080">) </font><font color="#FF0000"><b>and
      </b></font><font color="#000080">(</font>ap1<font color="#000080">^.</font>ArenaType <font color="#000080">&lt;&gt; </font>LAST_ATYPE<font color="#000080">)        </font><font color="#FF0000"><b>then  </b></font>Exit<font color="#000080">;
   </font>IsValidArena<font color="#000080">:=</font>true<font color="#000080">;
   </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{IsValidArena}</i></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>GetFirstArena <font color="#000080">: </font>pointer<font color="#000080">;
</font><font color="#008000"><i>{ return pointer to the first arena.
  scan memory for a 0x4D on a segment start,
  see if this points to another two levels of arena. }
</i></font><font color="#FF0000"><b>var
   </b></font>ap<font color="#000080">, </font>ap1  <font color="#000080">: ^</font>arena<font color="#000080">;
   </font>segment  <font color="#000080">: </font>word<font color="#000080">;

   </font><font color="#FF0000"><b>begin
        for </b></font>segment<font color="#000080">:=</font><font color="#800000">60 </font><font color="#FF0000"><b>to </b></font>Cseg <font color="#FF0000"><b>do
            begin
            </b></font>ap <font color="#000080">:= </font>ptr<font color="#000080">(</font>segment<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
            </font><font color="#FF0000"><b>if </b></font>IsValidArena <font color="#000080">(</font>ap<font color="#000080">^)  </font><font color="#FF0000"><b>then
               begin  </b></font>GetFirstArena <font color="#000080">:= </font>ap<font color="#000080">;  </font>Exit<font color="#000080">;  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	GetFirstArena <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{GetFirstArena}</i></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>IsValidEnv <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>ad<font color="#000080">:</font>ca<font color="#000080">; </font>NumSegs<font color="#000080">:</font>integer<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>COMSPECa <font color="#000080">: </font>ca<font color="#000080">;
   </font>adp      <font color="#000080">: </font>cap<font color="#000080">;
   </font>BaseAD   <font color="#000080">: </font>word<font color="#000080">;

   </font><font color="#FF0000"><b>begin
   </b></font>BaseAD <font color="#000080">:= </font>ofs <font color="#000080">(</font>ad<font color="#000080">);
   </font>adp    <font color="#000080">:= @</font>ad<font color="#000080">;
   </font>PtoA <font color="#000080">(</font>COMSPEC<font color="#000080">, </font>COMSPECa<font color="#000080">);
   </font><font color="#FF0000"><b>while </b></font><font color="#000080">( </font>adp<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">] &lt;&gt; </font><font color="#800000">#0 </font><font color="#000080">) </font><font color="#FF0000"><b>and
         </b></font><font color="#000080">( (</font>ofs<font color="#000080">(</font>adp<font color="#000080">^)-</font>BaseAD<font color="#000080">) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4 </font><font color="#000080">&lt; </font>NumSegs <font color="#000080">) </font><font color="#FF0000"><b>do
        begin
        if </b></font><font color="#000080">(</font>strnicmp<font color="#000080">(</font>adp<font color="#000080">^, </font>COMSPECa<font color="#000080">, </font><font color="#800000">8</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
            begin  </b></font>IsValidEnv<font color="#000080">:=</font>true<font color="#000080">;  </font>Exit<font color="#000080">;  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>adp <font color="#000080">:= @</font>adp<font color="#000080">^[</font>strlen<font color="#000080">(</font>adp<font color="#000080">^) + </font><font color="#800000">1</font><font color="#000080">];
        </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{while}</i></font><font color="#000080">;
   </font>IsValidEnv <font color="#000080">:= </font>false<font color="#000080">;
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{IsValidEnv}</i></font><font color="#000080">;


</font><font color="#FF0000"><b>Function </b></font>GetArenaOfEnvironment <font color="#000080">: </font>pointer<font color="#000080">;
</font><font color="#008000"><i>{  First get segment of COMMAND.COM from segment of previous critical err code.
   then go to this COMMAND.COM, and go get its ENV block,
   check that it is an ENV block }

</i></font><font color="#FF0000"><b>Label </b></font>L1<font color="#000080">, </font>L2<font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>ap       <font color="#000080">: ^</font>arena<font color="#000080">;
   </font>Mypsp    <font color="#000080">: ^</font>psp<font color="#000080">;
   </font>CCpsp    <font color="#000080">: ^</font>psp<font color="#000080">;
   </font>CCseg<font color="#000080">, </font>i <font color="#000080">: </font>word<font color="#000080">;
   </font>EnvSeg   <font color="#000080">: </font>word<font color="#000080">;
   </font>ad       <font color="#000080">: </font>cap<font color="#000080">;

   </font><font color="#FF0000"><b>begin
   </b></font>GetArenaOfEnvironment <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;

   </font><font color="#008000"><i>{ set Mypspp to psp of this program }
   </i></font>Mypsp <font color="#000080">:= </font>Ptr <font color="#000080">(</font>PrefixSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

   </font><font color="#008000"><i>{ set CCpsp to psp of COMMAND.COM }
   </i></font>CCseg <font color="#000080">:= </font>Seg <font color="#000080">(</font>Mypsp<font color="#000080">^.</font>PrevCritErrPtr<font color="#000080">^);
   </font>i <font color="#000080">:= </font>CCseg <font color="#000080">- </font><font color="#800000">32</font><font color="#000080">;   </font><font color="#FF0000"><b>if </b></font>i<font color="#000080">&lt;</font><font color="#800000">60 </font><font color="#FF0000"><b>then </b></font>i<font color="#000080">:=</font><font color="#800000">60</font><font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font>CCseg <font color="#000080">&gt; </font>i <font color="#FF0000"><b>do
         begin
         </b></font>ap <font color="#000080">:= </font>Ptr <font color="#000080">(</font>CCseg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font>IsValidArena <font color="#000080">(</font>ap<font color="#000080">^) </font><font color="#FF0000"><b>then  goto </b></font>L1<font color="#000080">;
         </font>dec <font color="#000080">(</font>CCseg<font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>exit<font color="#000080">;   </font><font color="#008000"><i>{error}

</i></font>L1<font color="#000080">: </font>inc <font color="#000080">(</font>CCseg<font color="#000080">);
    </font>CCpsp <font color="#000080">:= </font>Ptr <font color="#000080">(</font>CCseg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

   </font><font color="#008000"><i>{$ifdef Debug}
      </i></font>writeln <font color="#000080">(</font><font color="#800000">'prog psp='</font><font color="#000080">, </font>HexStr<font color="#000080">(</font>seg<font color="#000080">(</font>Mypsp<font color="#000080">^)),
               </font><font color="#800000">' prog crit_err_seg='</font><font color="#000080">, </font>HexStr<font color="#000080">(</font>CCseg<font color="#000080">) );
   </font><font color="#008000"><i>{$endif}

   {first see if the env seg in command.com points at a good env block?}
   </i></font>EnvSeg <font color="#000080">:= </font>CCpsp<font color="#000080">^.</font>EnvirSeg<font color="#000080">;
   </font>ap <font color="#000080">:= </font>Ptr <font color="#000080">(</font>EnvSeg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

   </font><font color="#008000"><i>{$ifdef Debug}
      </i></font>writeln <font color="#000080">(</font><font color="#800000">'Env '</font><font color="#000080">, </font>HexStr<font color="#000080">(</font>seg<font color="#000080">(</font>ap<font color="#000080">^)),
                    </font><font color="#800000">',  psp in env='</font><font color="#000080">, </font>HexStr<font color="#000080">(</font>ap<font color="#000080">^.</font>PspSegment<font color="#000080">));
   </font><font color="#008000"><i>{$endif}

   { if a valid arena, then search the entire arena for validity,
     if not a valid arena, then maybe it is one of these fabricated
     guys that shells like &quot;4DOS&quot; set up, search the first 128 bytes
     only }

   </i></font>i <font color="#000080">:= </font>ap<font color="#000080">^.</font>NumOfSegments<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;

   </font><font color="#FF0000"><b>if not </b></font>IsValidArena<font color="#000080">(</font>ap<font color="#000080">^) </font><font color="#FF0000"><b>then
      </b></font>i <font color="#000080">:= </font><font color="#800000">9
   </font><font color="#FF0000"><b>else
      if  </b></font>ap<font color="#000080">^.</font>PspSegment <font color="#000080">&lt;&gt; </font>CCseg  <font color="#FF0000"><b>then  goto </b></font>L2<font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font>IsValidEnv<font color="#000080">(</font>ap<font color="#000080">^.</font>ArenaData<font color="#000080">, </font>i<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
      </b></font>GetArenaOfEnvironment <font color="#000080">:= </font>ap<font color="#000080">;
      </font><font color="#008000"><i>{$ifdef Debug} </i></font>writeln<font color="#000080">(</font><font color="#800000">'env found'</font><font color="#000080">);  </font><font color="#008000"><i>{$endif}
      </i></font>Exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#008000"><i>{command.com did not have a good env segment, lets search all MCB's }
</i></font>L2<font color="#000080">:
   </font>ap <font color="#000080">:= </font>GetFirstArena<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>ap<font color="#000080">=</font><font color="#FF0000"><b>NIL then </b></font>Exit<font color="#000080">;
   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>ap<font color="#000080">^.</font>ArenaType <font color="#000080">&lt;&gt; </font>LAST_ATYPE<font color="#000080">) </font><font color="#FF0000"><b>do
        begin
        </b></font><font color="#008000"><i>{$ifdef Debug} </i></font>Writeln <font color="#000080">(</font><font color="#800000">'arena '</font><font color="#000080">, </font>HexStr<font color="#000080">(</font>seg<font color="#000080">(</font>ap<font color="#000080">^)));  </font><font color="#008000"><i>{$endif}
        </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>ap<font color="#000080">^.</font>PspSegment<font color="#000080">=</font>CCseg<font color="#000080">) </font><font color="#FF0000"><b>and
            </b></font>IsValidEnv<font color="#000080">(</font>ap<font color="#000080">^.</font>ArenaData<font color="#000080">, </font>ap<font color="#000080">^.</font>NumOfSegments<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
           begin
           </b></font>GetArenaOfEnvironment <font color="#000080">:= </font>ap<font color="#000080">;
           </font><font color="#008000"><i>{$ifdef Debug} </i></font>writeln<font color="#000080">(</font><font color="#800000">'env found'</font><font color="#000080">); </font><font color="#008000"><i>{$endif}
           </i></font>Exit<font color="#000080">;
           </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>ap <font color="#000080">:= </font>GetNextArena <font color="#000080">(</font>ap<font color="#000080">^);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{GetArenaOfEnvironment}</i></font><font color="#000080">;

</font><font color="#008000"><i>{*****************************************************************************}

</i></font><font color="#FF0000"><b>Function </b></font>SetTheEnv <font color="#000080">(</font>symbol<font color="#000080">, </font>val <font color="#000080">: </font>s24<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
    </b></font>TotalEnvSize<font color="#000080">,
    </font>NeededSize<font color="#000080">,
    </font>strlength     <font color="#000080">: </font>integer<font color="#000080">;
    </font>sp<font color="#000080">, </font>op<font color="#000080">, </font>envir <font color="#000080">: </font>cap<font color="#000080">;
    </font>SymbolLen     <font color="#000080">: </font>integer<font color="#000080">;
    </font>SymbolA<font color="#000080">, </font>ValA <font color="#000080">: </font>ca<font color="#000080">;
    </font>Found         <font color="#000080">: </font>boolean<font color="#000080">;
    </font>ap            <font color="#000080">: ^</font>arena<font color="#000080">;

    </font><font color="#FF0000"><b>begin
    </b></font>NeededSize <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Found      <font color="#000080">:= </font>false<font color="#000080">;
    </font>SetTheEnv  <font color="#000080">:= </font>false<font color="#000080">;

    </font>PtoA  <font color="#000080">(</font>Symbol<font color="#000080">, </font>SymbolA<font color="#000080">);
    </font>PtoA  <font color="#000080">(</font>Val<font color="#000080">, </font>ValA<font color="#000080">);
    </font>strupr<font color="#000080">(</font>symbolA<font color="#000080">);
    </font>SymbolLen <font color="#000080">:= </font>strlen <font color="#000080">(</font>symbolA<font color="#000080">);
    </font>SymbolA <font color="#000080">[</font>SymbolLen<font color="#000080">]   := </font><font color="#800000">'='</font><font color="#000080">;
    </font>SymbolA <font color="#000080">[</font>SymbolLen<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;

    </font><font color="#008000"><i>{ first, can the COMMAND.COM envir block be found ? }
    </i></font>ap <font color="#000080">:= </font>GetArenaOfEnvironment<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">( </font>ap <font color="#000080">= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">) </font><font color="#FF0000"><b>then  </b></font>exit<font color="#000080">;


    </font><font color="#008000"><i>{ search to end of the envir block, get sizes }
    </i></font>TotalEnvSize <font color="#000080">:= </font><font color="#800000">16 </font><font color="#000080">* </font>ap<font color="#000080">^.</font>NumOfSegments<font color="#000080">;
    </font>envir <font color="#000080">:= @</font>ap<font color="#000080">^.</font>ArenaData<font color="#000080">;
    </font>op    <font color="#000080">:= </font>envir<font color="#000080">;
    </font>sp    <font color="#000080">:= </font>envir<font color="#000080">;

    </font><font color="#FF0000"><b>while </b></font>sp<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">] &lt;&gt; </font><font color="#800000">#0 </font><font color="#FF0000"><b>do
        begin
</b></font>	strlength <font color="#000080">:= </font>strlen<font color="#000080">(</font>sp<font color="#000080">^)+</font><font color="#800000">1</font><font color="#000080">;
</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">( </font>strnicmp<font color="#000080">(</font>sp<font color="#000080">^, </font>symbolA<font color="#000080">, </font>SymbolLen<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">) = </font><font color="#800000">0 </font><font color="#000080">)  </font><font color="#FF0000"><b>then
</b></font>	     found <font color="#000080">:= </font>true
	<font color="#FF0000"><b>else
             begin
             </b></font>NeededSize <font color="#000080">:= </font>NeededSize <font color="#000080">+ </font>strlength<font color="#000080">;
             </font><font color="#FF0000"><b>if </b></font>found <font color="#FF0000"><b>then  </b></font>strcpy<font color="#000080">(</font>op<font color="#000080">^  , </font>sp<font color="#000080">^);
             </font>op <font color="#000080">:= @</font>op<font color="#000080">^[</font>strlength<font color="#000080">];
</font>	     <font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>	sp <font color="#000080">:= @</font>sp<font color="#000080">^[</font>strlength<font color="#000080">];
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>op<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>strlen<font color="#000080">(</font>valA<font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
        begin
</b></font>	NeededSize <font color="#000080">:= </font>NeededSize <font color="#000080">+ </font><font color="#800000">3 </font><font color="#000080">+ </font>SymbolLen <font color="#000080">+ </font>strlen<font color="#000080">(</font>valA<font color="#000080">);

</font>	<font color="#FF0000"><b>if </b></font><font color="#000080">(</font>NeededSize <font color="#000080">&gt; </font>TotalEnvSize<font color="#000080">) </font><font color="#FF0000"><b>then
</b></font>		Exit<font color="#000080">;    </font><font color="#008000"><i>{could mess with environment expansion here}

</i></font>	strcpy<font color="#000080">(</font>op<font color="#000080">^, </font>symbolA<font color="#000080">);  </font>strcat<font color="#000080">(</font>op<font color="#000080">^, </font>valA<font color="#000080">);
</font>	op <font color="#000080">:= @</font>op<font color="#000080">^[</font>strlen<font color="#000080">(</font>op<font color="#000080">^)+</font><font color="#800000">1</font><font color="#000080">];
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>op<font color="#000080">^[</font><font color="#800000">0</font><font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;
    </font>SetTheEnv <font color="#000080">:= </font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{SetTheEnv}</i></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0115.PAS">Original</a><b>]</b></p></body>
</html>
