<html>
<head><title> "Which Compiler" by LARRY HADLEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0056.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Hi !

   Here is some source code I acquired from a Pascal echo some time
   ago. It shows one method of detecting which TP compiler created
   an .EXE:

-------------------------------------------------------------------
{ to compile type: tpc foo.pas }
{ exe: 9776 bytes by TP5.5 }

{$A+,B-,E-,F-,I+,N-,O-,V+}
{$M 4500,0,0}
{$ifndef debug}
{$D-,L-,R-,S-}
{$else}
{$D+,L+,R+,S+}
{$endif}

</i></font><font color="#FF0000"><b>Program </b></font>foo<font color="#000080">;

</font><font color="#FF0000"><b>Uses
   </b></font>DOS<font color="#000080">;  </font><font color="#008000"><i>{ dos unit from turbo pascal }

</i></font><font color="#FF0000"><b>TYPE              </b></font><font color="#008000"><i>{ normal exe file header }
    </i></font>EXEH <font color="#000080">= </font><font color="#FF0000"><b>RECORD
          </b></font>id<font color="#000080">,            </font><font color="#008000"><i>{ exe signature }
          </i></font>Lpage<font color="#000080">,         </font><font color="#008000"><i>{ exe file size mod 512 bytes; &lt; 512 bytes }
          </i></font>Fpages<font color="#000080">,        </font><font color="#008000"><i>{ exe file size div 512 bytes; + 1 if Lpage &gt; 0 }
          </i></font>relocitems<font color="#000080">,    </font><font color="#008000"><i>{ number of relocation table items }
          </i></font>size<font color="#000080">,          </font><font color="#008000"><i>{ exe header size in 16-byte paragraphs }
          </i></font>minalloc<font color="#000080">,      </font><font color="#008000"><i>{ min mem. required in additional to exe image }
          </i></font>maxalloc<font color="#000080">,      </font><font color="#008000"><i>{ extra max. mem. desired beyond that required
                           to hold exe's image }
          </i></font>ss<font color="#000080">,            </font><font color="#008000"><i>{ displacement of stack segment }
          </i></font>sp<font color="#000080">,            </font><font color="#008000"><i>{ initial SP register value }
          </i></font>chk_sum<font color="#000080">,       </font><font color="#008000"><i>{ complemented checksum }
          </i></font>ip<font color="#000080">,            </font><font color="#008000"><i>{ initial IP register value }
          </i></font>cs<font color="#000080">,            </font><font color="#008000"><i>{ displacement of code segment }
          </i></font>ofs_rtbl<font color="#000080">,      </font><font color="#008000"><i>{ offset to first relocation item }
          </i></font>ovr_num <font color="#000080">: </font>word<font color="#000080">; </font><font color="#008000"><i>{ overlay numbers }
       </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;
                </font><font color="#008000"><i>{ window exe file header }
    </i></font>WINH <font color="#000080">= </font><font color="#FF0000"><b>RECORD
          </b></font>id <font color="#000080">: </font>word<font color="#000080">;     </font><font color="#008000"><i>{ ignore the rest of data structures }
       </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;

    </font>str2  <font color="#000080">= </font><font color="#FF0000"><b>string </b></font><font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
    </font>str4  <font color="#000080">= </font><font color="#FF0000"><b>string </b></font><font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];
    </font>str10 <font color="#000080">= </font><font color="#FF0000"><b>string </b></font><font color="#000080">[</font><font color="#800000">10</font><font color="#000080">];

</font><font color="#FF0000"><b>CONST
    </b></font>no_error  <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;        </font><font color="#008000"><i>{ no system error }
    </i></font>t         <font color="#000080">= </font><font color="#800000">#9</font><font color="#000080">;       </font><font color="#008000"><i>{ ascii: hortizon tab }
    </i></font>dt        <font color="#000080">= </font>t<font color="#000080">+</font>t<font color="#000080">;
    </font>tt        <font color="#000080">= </font>t<font color="#000080">+</font>t<font color="#000080">+</font>t<font color="#000080">;
    </font>qt        <font color="#000080">= </font>t<font color="#000080">+</font>t<font color="#000080">+</font>t<font color="#000080">+</font>t<font color="#000080">;
    </font>cr        <font color="#000080">= </font><font color="#800000">#13#10</font><font color="#000080">;   </font><font color="#008000"><i>{ ascii: carriage return and line feed }

</i></font><font color="#FF0000"><b>VAR
    </b></font>f        <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;      </font><font color="#008000"><i>{ source file, untyped }
    </i></font>exehdr   <font color="#000080">: </font>exeh<font color="#000080">;      </font><font color="#008000"><i>{ exe header contents }
    </i></font>winhdr   <font color="#000080">: </font>winh<font color="#000080">;      </font><font color="#008000"><i>{ window exe header contents }
    </i></font>blocks_r <font color="#000080">: </font>word<font color="#000080">;      </font><font color="#008000"><i>{ number of blocks actually read }

    </i></font>exe_size <font color="#000080">,            </font><font color="#008000"><i>{ exe file length }
    </i></font>hdr_size <font color="#000080">,            </font><font color="#008000"><i>{ exe header size }
    </i></font>img_size <font color="#000080">,            </font><font color="#008000"><i>{ load module or exe image size }
    </i></font>min_xmem <font color="#000080">,            </font><font color="#008000"><i>{ min. extra memory needed }
    </i></font>max_xmem <font color="#000080">,            </font><font color="#008000"><i>{ max. extra memory wanted }
    </i></font>o_starup <font color="#000080">: </font>longint<font color="#000080">;   </font><font color="#008000"><i>{ offset to start up code }

    </i></font>dirfile    <font color="#000080">: </font>searchrec<font color="#000080">;
    </font>compressed <font color="#000080">: </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Hex<font color="#000080">(</font>B <font color="#000080">:</font>byte<font color="#000080">) :</font>str2<font color="#000080">;
 </font><font color="#FF0000"><b>CONST  </b></font>strdex <font color="#000080">:</font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">$F</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#000080">= </font><font color="#800000">'0123456789ABCDEF'</font><font color="#000080">;
 </font><font color="#FF0000"><b>BEGIN  </b></font>Hex <font color="#000080">:= </font>concat<font color="#000080">(</font>strdex<font color="#000080">[</font>B <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">], </font>strdex<font color="#000080">[</font>B <font color="#FF0000"><b>and </b></font><font color="#800000">$F</font><font color="#000080">]); </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>HexW<font color="#000080">(</font>W <font color="#000080">:</font>word<font color="#000080">) :</font>str4<font color="#000080">;
 </font><font color="#FF0000"><b>VAR    </b></font>byt <font color="#000080">:</font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte <font color="#FF0000"><b>absolute </b></font>W<font color="#000080">;
 </font><font color="#FF0000"><b>BEGIN  </b></font>HexW <font color="#000080">:= </font>Hex<font color="#000080">(</font>byt<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">])+</font>Hex<font color="#000080">(</font>byt<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]); </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>HexL<font color="#000080">(</font>L <font color="#000080">:</font>longint<font color="#000080">) :</font>str10<font color="#000080">;
 </font><font color="#FF0000"><b>TYPE   </b></font>Cast <font color="#000080">= </font><font color="#FF0000"><b>RECORD
                </b></font>Lo <font color="#000080">:</font>word<font color="#000080">;
                </font>Hi <font color="#000080">:</font>word<font color="#000080">;
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
 </font><font color="#FF0000"><b>BEGIN  </b></font>HexL <font color="#000080">:= </font>HexW<font color="#000080">(</font>Cast<font color="#000080">(</font>L<font color="#000080">).</font>Hi<font color="#000080">)+</font><font color="#800000">' '</font><font color="#000080">+</font>HexW<font color="#000080">(</font>Cast<font color="#000080">(</font>L<font color="#000080">).</font>Lo<font color="#000080">); </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>print_info<font color="#000080">;
   </font><font color="#FF0000"><b>CONST
      </b></font>psp_size <font color="#000080">= </font><font color="#800000">$100</font><font color="#000080">; </font><font color="#008000"><i>{ size of psp, bytes }
   </i></font><font color="#FF0000"><b>VAR   </b></font>i <font color="#000080">: </font>byte<font color="#000080">;
   </font><font color="#FF0000"><b>BEGIN
      </b></font>hdr_size <font color="#000080">:= </font>longint<font color="#000080">(</font>exehdr<font color="#000080">.</font>size<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;       </font><font color="#008000"><i>{ exe header size, bytes }
      </i></font>img_size <font color="#000080">:= </font>longint<font color="#000080">(</font>exe_size<font color="#000080">) - </font>hdr_size<font color="#000080">;     </font><font color="#008000"><i>{ exe image size, bytes }
      </i></font>min_xmem <font color="#000080">:= </font>longint<font color="#000080">(</font>exehdr<font color="#000080">.</font>minalloc<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;   </font><font color="#008000"><i>{ mim xtra mem, bytes }
      </i></font>max_xmem <font color="#000080">:= </font>longint<font color="#000080">(</font>exehdr<font color="#000080">.</font>maxalloc<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;   </font><font color="#008000"><i>{ max xtra mem, bytes }
      </i></font>o_starup <font color="#000080">:= </font>hdr_size <font color="#000080">+ </font>longint<font color="#000080">(</font>exehdr<font color="#000080">.</font>cs<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4
                  </font><font color="#000080">+</font>longint<font color="#000080">(</font>exehdr<font color="#000080">.</font>ip<font color="#000080">);              </font><font color="#008000"><i>{ ofs to start up code  }
      </i></font>writeln<font color="#000080">(
         </font>qt<font color="#000080">, </font><font color="#800000">'Dec'</font><font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">6</font><font color="#000080">, </font><font color="#800000">'Hex'</font><font color="#000080">, </font>cr<font color="#000080">,
         </font><font color="#800000">'EXE file size:'</font><font color="#000080">, </font>tt<font color="#000080">, </font>exe_size<font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexl<font color="#000080">(</font>exe_size<font color="#000080">), </font>cr<font color="#000080">,
         </font><font color="#800000">'EXE header size:'</font><font color="#000080">, </font>dt<font color="#000080">, </font>hdr_size<font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexl<font color="#000080">(</font>hdr_size<font color="#000080">), </font>cr<font color="#000080">,
         </font><font color="#800000">'Code + initialized data size:'</font><font color="#000080">, </font>t<font color="#000080">, </font>img_size<font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexl<font color="#000080">(</font>img_size<font color="#000080">)
             );

      </font>writeln<font color="#000080">(
         </font><font color="#800000">'Pre-relocated SS:SP'</font><font color="#000080">, </font>tt<font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexw<font color="#000080">(</font>exehdr<font color="#000080">.</font>ss<font color="#000080">), </font><font color="#800000">':'</font><font color="#000080">, </font>hexw<font color="#000080">(</font>exehdr<font color="#000080">.</font>sp<font color="#000080">)
         , </font>cr<font color="#000080">,
         </font><font color="#800000">'Pre-relocated CS:IP'</font><font color="#000080">, </font>tt<font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexw<font color="#000080">(</font>exehdr<font color="#000080">.</font>cs<font color="#000080">), </font><font color="#800000">':'</font><font color="#000080">, </font>hexw<font color="#000080">(</font>exehdr<font color="#000080">.</font>ip<font color="#000080">)
             );

      </font>writeln<font color="#000080">(
         </font><font color="#800000">'Min. extra memory required:'</font><font color="#000080">, </font>t<font color="#000080">, </font>min_xmem<font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexl<font color="#000080">(</font>min_xmem<font color="#000080">), </font>cr<font color="#000080">,
         </font><font color="#800000">'Max. extra memory wanted:'</font><font color="#000080">, </font>t<font color="#000080">, </font>max_xmem<font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexl<font color="#000080">(</font>max_xmem<font color="#000080">), </font>cr<font color="#000080">,
         </font><font color="#800000">'Offset to start up code:'</font><font color="#000080">, </font>dt<font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexl<font color="#000080">(</font>o_starup<font color="#000080">), </font>cr<font color="#000080">,
         </font><font color="#800000">'Offset to relocation table:'</font><font color="#000080">, </font>dt<font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexw<font color="#000080">(</font>exehdr<font color="#000080">.</font>ofs_rtbl<font color="#000080">):</font><font color="#800000">9
             </font><font color="#000080">);

     </font>writeln<font color="#000080">(
         </font><font color="#800000">'Number of relocation pointers:'</font><font color="#000080">, </font>t<font color="#000080">, </font>exehdr<font color="#000080">.</font>relocitems<font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font>cr<font color="#000080">,
         </font><font color="#800000">'Number of MS overlays:'</font><font color="#000080">, </font>dt<font color="#000080">, </font>exehdr<font color="#000080">.</font>ovr_num<font color="#000080">:</font><font color="#800000">8</font><font color="#000080">, </font>cr<font color="#000080">,
         </font><font color="#800000">'File checksum value:'</font><font color="#000080">, </font>tt<font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">, </font>hexw<font color="#000080">(</font>exehdr<font color="#000080">.</font>chk_sum<font color="#000080">):</font><font color="#800000">9</font><font color="#000080">, </font>cr<font color="#000080">,
         </font><font color="#800000">'Memory needed to start:'</font><font color="#000080">, </font>dt<font color="#000080">, </font>img_size<font color="#000080">+</font>min_xmem<font color="#000080">+</font>psp_size<font color="#000080">:</font><font color="#800000">8
            </font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{ print_info }

</i></font><font color="#FF0000"><b>procedure </b></font>id_signature<font color="#000080">;    </font><font color="#008000"><i>{ the core of this program }
   </i></font><font color="#FF0000"><b>CONST
      </b></font>o_01    <font color="#000080">=  </font><font color="#800000">14</font><font color="#000080">;        </font><font color="#008000"><i>{ relative offset from cstr0 to cstr1 }
      </i></font>o_02    <font color="#000080">=  </font><font color="#800000">16</font><font color="#000080">;        </font><font color="#008000"><i>{   &quot;        &quot;      &quot;  cstr0 to cstr2 }
      </i></font>o_03    <font color="#000080">=  </font><font color="#800000">47</font><font color="#000080">;        </font><font color="#008000"><i>{   &quot;        &quot;      &quot;  cstr0 to cstr3 }
      </i></font>cstr0   <font color="#000080">= </font><font color="#800000">'ntime'</font><font color="#000080">;    </font><font color="#008000"><i>{ constant string existed in v4-6 }
      </i></font>cstr1   <font color="#000080">= </font><font color="#800000">'at '#0'.'</font><font color="#000080">; </font><font color="#008000"><i>{ constant string existed in v4-6 }
      </i></font>cstr2   <font color="#000080">= </font><font color="#800000">'$4567'</font><font color="#000080">;    </font><font color="#008000"><i>{ constant string existed in v5-6 }
      </i></font>cstr3   <font color="#000080">= </font><font color="#800000">'83,90'</font><font color="#000080">;    </font><font color="#008000"><i>{ constant string existed in v6 only }
      </i></font>strlen  <font color="#000080">=   </font><font color="#800000">5</font><font color="#000080">;        </font><font color="#008000"><i>{ length of cstr? }
      </i></font>ar_itm  <font color="#000080">=   </font><font color="#800000">3</font><font color="#000080">;        </font><font color="#008000"><i>{ items+1 of string array }

   { the following figures have been turn-up explicitly and
     should not be changed }

      </i></font>ofs_rte <font color="#000080">=  </font><font color="#800000">25 </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;  </font><font color="#008000"><i>{ get close to 'run time error' str contants }
      </i></font>maxchar <font color="#000080">=  </font><font color="#800000">11 </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;  </font><font color="#008000"><i>{ max. size of buffer; for scanning }

   </i></font><font color="#FF0000"><b>TYPE
      </b></font>arstr  <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>ar_itm<font color="#000080">] </font><font color="#FF0000"><b>of string</b></font><font color="#000080">[</font>strlen<font color="#000080">];
      </font>arbuf  <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>maxchar<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;

   </font><font color="#FF0000"><b>VAR
      </b></font>i<font color="#000080">, </font>j<font color="#000080">, </font>k <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ index counter for array buffer }
      </i></font>cstr    <font color="#000080">: </font>arstr<font color="#000080">;   </font><font color="#008000"><i>{ signatures generated by tp compiler }
      </i></font>o_fseg  <font color="#000080">: </font>word<font color="#000080">;    </font><font color="#008000"><i>{ to hold segment value of any far call }
      </i></font>o_sysseg<font color="#000080">: </font>longint<font color="#000080">; </font><font color="#008000"><i>{ offset to tp system_unit_segment }
      </i></font>buffer  <font color="#000080">: </font>arbuf<font color="#000080">;   </font><font color="#008000"><i>{ searching for target strings }

   </i></font><font color="#FF0000"><b>BEGIN
</b></font><font color="#008000"><i>{d}   </i></font>Seek<font color="#000080">(</font>f<font color="#000080">, </font>o_starup <font color="#000080">+ </font><font color="#800000">3</font><font color="#000080">);                       </font><font color="#008000"><i>{ move file pointer 
forward 3 bytes }
{d}   </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>o_fseg<font color="#000080">, </font>sizeof<font color="#000080">(</font>o_fseg<font color="#000080">));        </font><font color="#008000"><i>{ get far call segment 
value }
      </i></font>o_sysseg <font color="#000080">:= </font>longint<font color="#000080">(</font>o_fseg<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4 </font><font color="#000080">+</font>hdr_size<font color="#000080">; </font><font color="#008000"><i>{ ofs to system obj code }
      </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>o_sysseg <font color="#000080">+ </font>ofs_rte <font color="#000080">&lt;= </font>dirfile<font color="#000080">.</font>size<font color="#000080">) </font><font color="#FF0000"><b>then
      BEGIN
</b></font><font color="#008000"><i>{d}      </i></font>Seek<font color="#000080">(</font>f<font color="#000080">, </font>o_sysseg<font color="#000080">+</font>ofs_rte<font color="#000080">);                </font><font color="#008000"><i>{ offset nearby tp 
signatures }
{d}      </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>buffer<font color="#000080">, </font>sizeof<font color="#000080">(</font>buffer<font color="#000080">), </font>blocks_r<font color="#000080">);
         </font><font color="#FF0000"><b>for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>ar_itm <font color="#FF0000"><b>do
         BEGIN
             </b></font>cstr<font color="#000080">[</font>i<font color="#000080">][</font><font color="#800000">0</font><font color="#000080">] := </font>char<font color="#000080">(</font>strlen<font color="#000080">);
             </font>fillchar<font color="#000080">(</font>cstr<font color="#000080">[</font>i<font color="#000080">][</font><font color="#800000">1</font><font color="#000080">], </font>strlen<font color="#000080">, </font><font color="#800000">'*'</font><font color="#000080">);
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font>i <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">; </font>j <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">; </font>k <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
         </font><font color="#FF0000"><b>repeat
            if </b></font>buffer<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">'n'</font><font color="#000080">,</font><font color="#800000">'t'</font><font color="#000080">,</font><font color="#800000">'i'</font><font color="#000080">,</font><font color="#800000">'m'</font><font color="#000080">,</font><font color="#800000">'e'</font><font color="#000080">] </font><font color="#FF0000"><b>then
            BEGIN
               if </b></font><font color="#000080">(</font>k <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>k <font color="#000080">= </font>i <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
                  </b></font>inc<font color="#000080">(</font>j<font color="#000080">);
               </font>cstr<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">][</font>j<font color="#000080">] := </font>buffer<font color="#000080">[</font>i<font color="#000080">];
               </font>k <font color="#000080">:= </font>i<font color="#000080">;
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
            </font>inc<font color="#000080">(</font>i<font color="#000080">);
         </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>cstr<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] = </font>cstr0<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>i <font color="#000080">&gt; </font>maxchar<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>j <font color="#000080">&gt; </font>strlen<font color="#000080">);
         </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>i<font color="#000080">+</font>o_03 <font color="#000080">&lt;= </font>maxchar<font color="#000080">) </font><font color="#FF0000"><b>then
         BEGIN
            </b></font>dec<font color="#000080">(</font>i<font color="#000080">, </font>strlen<font color="#000080">);
            </font>move<font color="#000080">(</font>buffer<font color="#000080">[</font>i<font color="#000080">+</font>o_01<font color="#000080">], </font>cstr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">][</font><font color="#800000">1</font><font color="#000080">], </font>strlen<font color="#000080">);
            </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>cstr<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font>cstr1<font color="#000080">) </font><font color="#FF0000"><b>then
            BEGIN
               </b></font>writeln<font color="#000080">(
                    </font>cr<font color="#000080">, </font><font color="#800000">'Offset to TP system code:'</font><font color="#000080">, </font>dt<font color="#000080">, </font><font color="#800000">''</font><font color="#000080">:</font><font color="#800000">3</font><font color="#000080">,
                    </font>hexl<font color="#000080">(</font>o_sysseg<font color="#000080">):</font><font color="#800000">9
                      </font><font color="#000080">);

               </font>write<font color="#000080">(</font><font color="#800000">'Compiled by Borland TP v'</font><font color="#000080">);

               </font>move<font color="#000080">(</font>buffer<font color="#000080">[</font>i<font color="#000080">-</font>o_02<font color="#000080">], </font>cstr<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">][</font><font color="#800000">1</font><font color="#000080">], </font>strlen<font color="#000080">);

               </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>cstr<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] = </font>cstr2<font color="#000080">) </font><font color="#FF0000"><b>then
               BEGIN
                  </b></font>move<font color="#000080">(</font>buffer<font color="#000080">[</font>i<font color="#000080">+</font>o_03<font color="#000080">], </font>cstr<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">][</font><font color="#800000">1</font><font color="#000080">], </font>strlen<font color="#000080">);
                  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>cstr<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">] = </font>cstr3<font color="#000080">) </font><font color="#FF0000"><b>THEN
                     </b></font>writeln<font color="#000080">(</font><font color="#800000">'6.0'</font><font color="#000080">)
                  </font><font color="#FF0000"><b>ELSE
                     </b></font>writeln<font color="#000080">(</font><font color="#800000">'5.0/5.5'</font><font color="#000080">);
               </font><font color="#FF0000"><b>END
               ELSE
                  </b></font>writeln<font color="#000080">(</font><font color="#800000">'4.0'</font><font color="#000080">);
            </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{procedure}

</i></font><font color="#FF0000"><b>procedure </b></font>process_exefile<font color="#000080">;
   </font><font color="#FF0000"><b>CONST
      </b></font>ofs_whdr  <font color="#000080">= </font><font color="#800000">$3C</font><font color="#000080">;      </font><font color="#008000"><i>{ offset to MS-Window exe file id }
      </i></font>exwid     <font color="#000080">= </font><font color="#800000">$454E</font><font color="#000080">;    </font><font color="#008000"><i>{ MS-Window exe file id }
   </i></font><font color="#FF0000"><b>VAR
      </b></font>o_sign<font color="#000080">,
      </font>fsize   <font color="#000080">:</font>longint<font color="#000080">;
   </font><font color="#FF0000"><b>BEGIN
      if </b></font><font color="#000080">(</font>exe_size <font color="#000080">= </font>dirfile<font color="#000080">.</font>size<font color="#000080">) </font><font color="#FF0000"><b>then
      BEGIN
         </b></font>print_info<font color="#000080">;
         </font><font color="#FF0000"><b>if not </b></font>compressed <font color="#FF0000"><b>then
            </b></font>id_signature<font color="#000080">;
         </font>writeln<font color="#000080">;
      </font><font color="#FF0000"><b>END
      else
      BEGIN
</b></font><font color="#008000"><i>{d}      </i></font>Seek<font color="#000080">(</font>f<font color="#000080">, </font>ofs_whdr<font color="#000080">);        </font><font color="#008000"><i>{ offset to 'offset to window exe 
signature' }
{d}      </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>hdr_size<font color="#000080">, </font>sizeof<font color="#000080">(</font>hdr_size<font color="#000080">));
</font><font color="#008000"><i>{d}      </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>hdr_size <font color="#000080">&lt;= </font>dirfile<font color="#000080">.</font>size<font color="#000080">) </font><font color="#FF0000"><b>then
         BEGIN
            </b></font>Seek<font color="#000080">(</font>f<font color="#000080">, </font>hdr_size<font color="#000080">);     </font><font color="#008000"><i>{ offset to new exe signature }
{d}         </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>winhdr<font color="#000080">, </font>sizeof<font color="#000080">(</font>winhdr<font color="#000080">));
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
         </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>winhdr<font color="#000080">.</font>id <font color="#000080">= </font>exwid<font color="#000080">) </font><font color="#FF0000"><b>then
         BEGIN
            </b></font>writeln<font color="#000080">(</font><font color="#800000">'Dos/MS-Window EXE or DLL file'</font><font color="#000080">);
            </font>print_info<font color="#000080">;
            </font>EXIT<font color="#000080">;
         </font><font color="#FF0000"><b>END
         else
         BEGIN
            </b></font>print_info<font color="#000080">;
            </font>writeln<font color="#000080">(
               </font>cr<font color="#000080">,
               </font><font color="#800000">'file size ('</font><font color="#000080">, </font>exe_size<font color="#000080">, </font><font color="#800000">') calculated from EXE header '</font><font color="#000080">,
               </font><font color="#800000">'(load by DOS upon exec)'</font><font color="#000080">, </font>cr<font color="#000080">,
               </font><font color="#800000">'doesn''t match with file size ('</font><font color="#000080">, </font>dirfile<font color="#000080">.</font>size<font color="#000080">, </font><font color="#800000">') '</font><font color="#000080">,
               </font><font color="#800000">'recorded on file directory.'</font><font color="#000080">, </font>cr<font color="#000080">, </font>cr<font color="#000080">,
               </font><font color="#800000">'* EXE file saved with extra bytes at eof (e.g. debug info)'</font><font color="#000080">, </font>cr<font color="#000080">,
               </font><font color="#800000">'* EXE file may contain overlays'</font><font color="#000080">, </font>cr<font color="#000080">,
               </font><font color="#800000">'* possible a corrupted EXE file'</font><font color="#000080">, </font>cr
                   <font color="#000080">);

            </font>EXIT<font color="#000080">;
         </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>id_file<font color="#000080">;
   </font><font color="#FF0000"><b>CONST
      </b></font>exeid <font color="#000080">= </font><font color="#800000">$5A4D</font><font color="#000080">;    </font><font color="#008000"><i>{ MS-DOS exe file id }

   </i></font><font color="#FF0000"><b>VAR
      </b></font>zero <font color="#000080">: </font>str2<font color="#000080">;

   </font><font color="#FF0000"><b>BEGIN
      if </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>id <font color="#000080">= </font>exeid<font color="#000080">) </font><font color="#FF0000"><b>then
      BEGIN
         if </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>cs <font color="#000080">= </font><font color="#800000">$FFF0</font><font color="#000080">) </font><font color="#FF0000"><b>and
            </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>ip <font color="#000080">= </font><font color="#800000">$0100</font><font color="#000080">) </font><font color="#FF0000"><b>and
            </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>ofs_rtbl <font color="#000080">= </font><font color="#800000">$50</font><font color="#000080">) </font><font color="#FF0000"><b>or
            </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>ofs_rtbl <font color="#000080">= </font><font color="#800000">$52</font><font color="#000080">) </font><font color="#FF0000"><b>then
          BEGIN
             </b></font>writeln<font color="#000080">(</font><font color="#800000">'Compressed by PKLITE'</font><font color="#000080">);
             </font>compressed <font color="#000080">:= </font>true<font color="#000080">;
          </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>size <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>chk_sum <font color="#000080">= </font><font color="#800000">$899D</font><font color="#000080">) </font><font color="#FF0000"><b>then
          BEGIN
             </b></font>writeln<font color="#000080">( </font><font color="#800000">'Compressed by DIET'</font><font color="#000080">);
             </font>compressed <font color="#000080">:= </font>true<font color="#000080">;
          </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>exehdr<font color="#000080">.</font>Lpage <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
             </b></font>exe_size <font color="#000080">:= </font>longint<font color="#000080">(</font>exehdr<font color="#000080">.</font>Fpages <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">9</font><font color="#000080">+</font>exehdr<font color="#000080">.</font>Lpage
          <font color="#FF0000"><b>else
             </b></font>exe_size <font color="#000080">:= </font>longint<font color="#000080">(</font>exehdr<font color="#000080">.</font>Fpages<font color="#000080">) </font><font color="#FF0000"><b>shl </b></font><font color="#800000">9</font><font color="#000080">;
          </font>process_exefile<font color="#000080">;
      </font><font color="#FF0000"><b>END
      else
         </b></font>writeln<font color="#000080">(</font><font color="#800000">'Not EXE file'</font><font color="#000080">);
   </font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{procedure}

</i></font><font color="#FF0000"><b>CONST
   </b></font>blocksize <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">; </font><font color="#008000"><i>{ file r/w block size in one-byte unit }

</i></font><font color="#FF0000"><b>VAR
   </b></font>path <font color="#000080">: </font>dirstr<font color="#000080">;
   </font>name <font color="#000080">: </font>namestr<font color="#000080">;
   </font>ext  <font color="#000080">: </font>extstr<font color="#000080">;
   </font>fstr <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">48</font><font color="#000080">];
   </font>n    <font color="#000080">: </font>byte<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
   if </b></font>paramcount <font color="#000080">&lt; </font><font color="#800000">1 </font><font color="#FF0000"><b>then
      </b></font>n <font color="#000080">:= </font><font color="#800000">0
   </font><font color="#FF0000"><b>else
      </b></font>n <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;

   </font>fsplit<font color="#000080">(</font>paramstr<font color="#000080">(</font>n<font color="#000080">), </font>path<font color="#000080">, </font>name<font color="#000080">, </font>ext<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>name<font color="#000080">+</font>ext <font color="#000080">= </font><font color="#800000">'*.*'</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>name<font color="#000080">+</font>ext <font color="#000080">= </font><font color="#800000">'.' </font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>name<font color="#000080">+</font>ext <font color="#000080">= </font><font color="#800000">'' </font><font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>fstr <font color="#000080">:= </font>path<font color="#000080">+</font><font color="#800000">'*.exe'
   </font><font color="#FF0000"><b>else
      if </b></font><font color="#000080">(</font>path<font color="#000080">+</font>ext <font color="#000080">= </font><font color="#800000">''</font><font color="#000080">) </font><font color="#FF0000"><b>then
         </b></font>fstr <font color="#000080">:= </font>paramstr<font color="#000080">(</font>n<font color="#000080">)+</font><font color="#800000">'.exe'
      </font><font color="#FF0000"><b>else
         if not </b></font>boolean<font color="#000080">(</font>pos<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">, </font>ext<font color="#000080">)) </font><font color="#FF0000"><b>then
         BEGIN
            </b></font>path <font color="#000080">:= </font>path<font color="#000080">+</font>name<font color="#000080">+</font><font color="#800000">'\'</font><font color="#000080">;
            </font>fstr <font color="#000080">:= </font>path<font color="#000080">+</font><font color="#800000">'*.exe'</font><font color="#000080">;
         </font><font color="#FF0000"><b>END
         else
            </b></font>fstr <font color="#000080">:= </font>paramstr<font color="#000080">(</font>n<font color="#000080">);

    </font>n <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#008000"><i>{d} </i></font>findfirst<font color="#000080">(</font>fstr<font color="#000080">, </font>anyfile<font color="#000080">, </font>dirfile<font color="#000080">);
    </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>doserror <font color="#000080">= </font>no_error<font color="#000080">) </font><font color="#FF0000"><b>do
    BEGIN
       if </b></font><font color="#000080">(</font>dirfile<font color="#000080">.</font>attr <font color="#FF0000"><b>and </b></font>volumeid <font color="#000080">&lt;&gt; </font>volumeid<font color="#000080">) </font><font color="#FF0000"><b>and
          </b></font><font color="#000080">(</font>dirfile<font color="#000080">.</font>attr <font color="#FF0000"><b>and </b></font>directory <font color="#000080">&lt;&gt; </font>directory<font color="#000080">) </font><font color="#FF0000"><b>and
          </b></font><font color="#000080">(</font>dirfile<font color="#000080">.</font>attr <font color="#FF0000"><b>and </b></font>sysfile <font color="#000080">&lt;&gt; </font>sysfile<font color="#000080">) </font><font color="#FF0000"><b>then
       BEGIN
          </b></font>compressed <font color="#000080">:= </font>false<font color="#000080">;
          </font>Assign<font color="#000080">(</font>f<font color="#000080">, </font>path<font color="#000080">+</font>dirfile<font color="#000080">.</font>name<font color="#000080">); </font><font color="#008000"><i>{$I-}
{d}       </i></font>Reset<font color="#000080">(</font>f<font color="#000080">, </font>blocksize<font color="#000080">); </font><font color="#008000"><i>{$I+}
          </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>IOResult <font color="#000080">= </font>no_error<font color="#000080">) </font><font color="#FF0000"><b>then
          BEGIN
             </b></font>writeln<font color="#000080">(</font>cr<font color="#000080">, </font>dirfile<font color="#000080">.</font>name<font color="#000080">);
</font><font color="#008000"><i>{d}          </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>exehdr<font color="#000080">, </font>sizeof<font color="#000080">(</font>exehdr<font color="#000080">), </font>blocks_r<font color="#000080">);
             </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>blocks_r <font color="#000080">= </font>sizeof<font color="#000080">(</font>exehdr<font color="#000080">)) </font><font color="#FF0000"><b>then
                </b></font>id_file
             <font color="#FF0000"><b>else
                </b></font>writeln<font color="#000080">(</font><font color="#800000">'err:main'</font><font color="#000080">);
             </font>close<font color="#000080">(</font>f<font color="#000080">);
             </font>inc<font color="#000080">(</font>n<font color="#000080">);
          </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
       </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#008000"><i>{d}    </i></font>findnext<font color="#000080">(</font>dirfile<font color="#000080">);
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>n <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
       if </b></font>doserror <font color="#000080">= </font><font color="#800000">3 </font><font color="#FF0000"><b>then
          </b></font>writeln<font color="#000080">(</font><font color="#800000">'path not found'</font><font color="#000080">)
       </font><font color="#FF0000"><b>else
          </b></font>writeln<font color="#000080">(</font><font color="#800000">'file not found'</font><font color="#000080">)
       </font><font color="#FF0000"><b>else
          </b></font>writeln<font color="#000080">(</font>n<font color="#000080">,</font><font color="#800000">' files found'</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0056.PAS">Original</a><b>]</b></p></body>
</html>
