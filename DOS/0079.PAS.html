<html>
<head><title> "Opening Many Files at a time" by RAPHAEL VANNEY</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0079.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here's a unit that will let you open more than the default
maximum number of files (up to about 200, FILES statement
in CONFIG.SYS permitting) :
}

{$o-,f-,r-,s-}
{$IfDef DPMI}
     {$c Moveable PreLoad Discardable}
{$EndIf}

</i></font><font color="#FF0000"><b>Unit </b></font>ExtHandl <font color="#000080">;

</font><font color="#FF0000"><b>Interface

</b></font><font color="#008000"><i>{$IfNDef DPMI}
</i></font><font color="#FF0000"><b>Procedure </b></font>DOSRealloc<font color="#000080">(</font>p <font color="#000080">: </font>Pointer<font color="#000080">) ;
</font><font color="#008000"><i>{$EndIf}

</i></font><font color="#FF0000"><b>Implementation

</b></font><font color="#008000"><i>{$IfNDef DPMI}
</i></font><font color="#FF0000"><b>Procedure </b></font>DOSRealloc<font color="#000080">(</font>p <font color="#000080">: </font>Pointer<font color="#000080">) ; </font><font color="#FF0000"><b>Assembler </b></font><font color="#000080">;
</font><font color="#008000"><i>{ This procedures changes the size of the memory block allocated to the
  program. It proceeds the same way than the SetMemTop procedure of the
  Memory unit does. }
</i></font><font color="#FF0000"><b>Asm
     </b></font><font color="#FF00FF">Mov  BX, Word Ptr [p]                   </font><font color="#008000"><i>{ offset }
     </i></font><font color="#FF00FF">Add  BX, $0f
     Mov  CL, 4
     ShR  BX, CL
     Add  BX, Word Ptr [p+2]                 </font><font color="#008000"><i>{ segment }
     </i></font><font color="#FF00FF">Mov  AX, PrefixSeg
     Sub  BX, AX
     Mov  ES, AX
     </font><font color="#008000"><i>{ ES contains the program's PSP, BX is the new number of paragraphs
       of the memory block. }
     </i></font><font color="#FF00FF">Mov  AH, $4a                            </font><font color="#008000"><i>{ Modify memory allocation }
     </i></font><font color="#FF00FF">Int  $21
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;
</font><font color="#008000"><i>{$EndIf}

</i></font><font color="#FF0000"><b>Const
     </b></font>FreeParas      <font color="#000080">= </font><font color="#800000">1024 </font><font color="#FF0000"><b>Div </b></font><font color="#800000">16 </font><font color="#000080">;     </font><font color="#008000"><i>{ We're going to make sure DOS     }
                                        { still has some RAM               }
     </i></font>Reallocating   <font color="#000080">= </font><font color="#800000">1 </font><font color="#000080">;
     </font>TPLacksRAM     <font color="#000080">= </font><font color="#800000">2 </font><font color="#000080">;
     </font>GettingHandles <font color="#000080">= </font><font color="#800000">3 </font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>PrintError<font color="#000080">(</font>ErrNo <font color="#000080">: </font>Word <font color="#000080">; </font>Location <font color="#000080">: </font>Word<font color="#000080">) ;
</font><font color="#FF0000"><b>Begin
     </b></font>WriteLn<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) ;
     </font>WriteLn<font color="#000080">(</font><font color="#800000">'ExtHandl : Startup error #'</font><font color="#000080">, </font>ErrNo<font color="#000080">, </font><font color="#800000">', location='</font><font color="#000080">, </font>Location<font color="#000080">) ;
     </font>WriteLn<font color="#000080">(</font><font color="#800000">'MaxAvail='</font><font color="#000080">, </font>MaxAvail<font color="#000080">) ;
     </font>Write<font color="#000080">(</font><font color="#800000">'[Enter] pour continuer...'</font><font color="#000080">) ;
     </font>ReadLn <font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
     </b></font><font color="#008000"><i>{ This initialisation code makes sure DOS is still able to assume
       memory allocation requests that are likely to occur (whether by
       Spawno or a &quot;Set Handle Count&quot; request).
       This allows the main program to use whatever $m statement it needs. }
     </i></font><font color="#FF0000"><b>Asm
</b></font><font color="#008000"><i>{$IfNDef DPMI}
          </i></font><font color="#FF00FF">Mov  AH, $48                  </font><font color="#008000"><i>{ Allocate memory }
          </i></font><font color="#FF00FF">Mov  BX, $ffff                </font><font color="#008000"><i>{ More than DOS can give us }
          </i></font><font color="#FF00FF">Int  $21
          Cmp  BX, FreeParas            </font><font color="#008000"><i>{ BX contains avail paragraphs }
          </i></font><font color="#FF00FF">JNC  @DOSHasEnough
          </font><font color="#008000"><i>{ Let's check that the heap contains more than needed bytes }
          </i></font><font color="#FF00FF">Mov  AX, Word Ptr [HeapPtr+2]
          Add  AX, FreeParas
          Cmp  AX, Word Ptr [HeapEnd+2]
          JNC  @NotEnoughRAM            </font><font color="#008000"><i>{ Actually, TP hasn't enough }
          </i></font><font color="#FF00FF">Sub  Word Ptr [HeapEnd+2], FreeParas
          Push Word Ptr [HeapEnd+2]
          Push Word Ptr [HeapEnd]
          Call DOSRealloc
          JNC  @DOSHasEnough
          Push AX
          Mov  AX, Reallocating
          Push AX
          Call PrintError
          Jmp  #DOSHasEnough
     @NotEnoughRAM:
          XOr  AX, AX
          Push AX
          Mov  AX, TPLacksRAM
          Push AX
          Call PrintError
     @DOSHasEnough:
</font><font color="#008000"><i>{$EndIf}
          { Augmentation du nombre de handles disponibles }
          </i></font><font color="#FF00FF">Mov  AH, $67                  </font><font color="#008000"><i>{ Extend handles }
          </i></font><font color="#FF00FF">Mov  BX, 199                  </font><font color="#008000"><i>{ Gi'me 2 hundreds of 'em }
          </i></font><font color="#FF00FF">Int  $21
          JNC  @PasDErreur              </font><font color="#008000"><i>{ Si CF=1, erreur }
          </i></font><font color="#FF00FF">Push AX
          Mov  AX, GettingHandles
          Push AX
          Call PrintError
     @PasDErreur:
     </font><font color="#FF0000"><b>End </b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0079.PAS">Original</a><b>]</b></p></body>
</html>
