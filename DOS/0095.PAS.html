<html>
<head><title> "Expanded DOS Library" by ALEX RUSSKIH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0095.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$A-,B-,D-,E-,F+,G-,I-,L-,N-,O+,P-,R-,S-,V-,X+}
</i></font><font color="#FF0000"><b>Unit </b></font>AltDos<font color="#000080">;
</font><font color="#FF0000"><b>Interface
</b></font><font color="#008000"><i>{$IFDEF VIRTUALPASCAL}
</i></font><font color="#FF0000"><b>Uses </b></font>Use32<font color="#000080">,</font>Dos<font color="#000080">;
</font><font color="#008000"><i>{$DEFINE OS2}
{$ELSE}
</i></font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

{$IFNDEF OS2}
</i></font><font color="#FF0000"><b>function </b></font>Execute<font color="#000080">(</font>ExeFile<font color="#000080">,</font>ComLine<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
</i></font><font color="#FF0000"><b>Function </b></font>DosShell<font color="#000080">(</font>command<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>FileExists<font color="#000080">(</font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>DirExists<font color="#000080">(</font>FileName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">): </font>boolean<font color="#000080">;

</font><font color="#008000"><i>{$IFNDEF VIRTUALPASCAL}
</i></font><font color="#FF0000"><b>Procedure </b></font>GetFileMode<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>TextFilePos<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>TextFileSize<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>TextSeek<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">; </font>n <font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>procedure </b></font>CopyFile<font color="#000080">(</font>FromN<font color="#000080">,</font>ToN<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);

</font><font color="#008000"><i>{$IFNDEF OS2}
</i></font><font color="#FF0000"><b>Function </b></font>GetMemSize<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>Implementation
</b></font><font color="#008000"><i>{$IFNDEF OS2}
{$IFNDEF DPMI}
</i></font><font color="#FF0000"><b>Function </b></font>DosShell<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>OldHeapEnd<font color="#000080">,
  </font>NewHeapEnd<font color="#000080">: </font>Word<font color="#000080">;
  </font>Error<font color="#000080">:</font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>Error<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>MemAvail<font color="#000080">&lt;</font><font color="#800000">$1000
    </font><font color="#FF0000"><b>then </b></font>Error<font color="#000080">:=</font><font color="#800000">8</font><font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>Error<font color="#000080">=</font><font color="#800000">0
    </font><font color="#FF0000"><b>then
      begin
        </b></font>NewHeapEnd<font color="#000080">:=</font>Seg<font color="#000080">(</font>HeapPtr<font color="#000080">^)-</font>PrefixSeg<font color="#000080">;
        </font>OldHeapEnd<font color="#000080">:=</font>Seg<font color="#000080">(</font>HeapEnd<font color="#000080">^)-</font>PrefixSeg<font color="#000080">;
        </font><font color="#FF0000"><b>asm
          </b></font><font color="#FF00FF">mov ah,4Ah
          mov bx,NewHeapEnd
          mov es,PrefixSeg
          Int 21h
          jnc @EXIT
          mov Error,ax
          @EXIT:
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font><font color="#FF0000"><b>If </b></font>Error<font color="#000080">=</font><font color="#800000">0
          </font><font color="#FF0000"><b>then
            begin
              </b></font>SwapVectors<font color="#000080">;
              </font>Exec<font color="#000080">(</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font>command<font color="#000080">);
              </font>SwapVectors<font color="#000080">;
              </font><font color="#FF0000"><b>asm
                </b></font><font color="#FF00FF">mov ah,4Ah
                mov bx,OldHeapEnd
                mov es,PrefixSeg
                Int 21h
                jnc @EXIT
                mov Error,ax
                @EXIT:
              </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>DosShell<font color="#000080">:=</font>Error<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;     </font><font color="#008000"><i>{Function}
{$ENDIF}
{$ENDIF}

{$IFDEF DPMI}
</i></font><font color="#FF0000"><b>Function </b></font>DosShell<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>SwapVectors<font color="#000080">;
  </font>Exec<font color="#000080">(</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font>command<font color="#000080">);
  </font>SwapVectors<font color="#000080">;
  </font>DosShell<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;     </font><font color="#008000"><i>{Function}
{$ENDIF}

{$IFDEF OS2}
</i></font><font color="#FF0000"><b>Function </b></font>DosShell<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>Exec<font color="#000080">(</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font>command<font color="#000080">);
  </font>DosShell<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;     </font><font color="#008000"><i>{Function}
{$ENDIF}

{$IFNDEF OS2}
</i></font><font color="#FF0000"><b>function </b></font>Execute<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>EF  <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">;
  </font>Dir <font color="#000080">: </font>DirStr <font color="#000080">;
  </font>Name<font color="#000080">: </font>NameStr<font color="#000080">;
  </font>Ext <font color="#000080">: </font>ExtStr <font color="#000080">;
</font><font color="#008000"><i>{$IFNDEF DPMI}
  </i></font>OldHeapEnd<font color="#000080">,
  </font>NewHeapEnd<font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
  </i></font>Error<font color="#000080">:</font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FSplit<font color="#000080">(</font>ExeFile<font color="#000080">,</font>Dir<font color="#000080">,</font>Name<font color="#000080">,</font>Ext<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Name<font color="#000080">+</font>Ext<font color="#000080">=</font><font color="#800000">'COMMAND.COM'
    </font><font color="#FF0000"><b>then </b></font>Error<font color="#000080">:=</font>DosShell<font color="#000080">(</font>ComLine<font color="#000080">)
    </font><font color="#FF0000"><b>else
      begin
        if </b></font><font color="#000080">(</font>Dir<font color="#000080">[</font>byte<font color="#000080">(</font>Dir<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])]=</font><font color="#800000">'\'</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>byte<font color="#000080">(</font>Dir<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])&gt;</font><font color="#800000">0</font><font color="#000080">)
          </font><font color="#FF0000"><b>then </b></font>Dir<font color="#000080">[</font>byte<font color="#000080">(</font>Dir<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])]:=</font><font color="#800000">';'
          </font><font color="#FF0000"><b>else
            if </b></font><font color="#000080">(</font>byte<font color="#000080">(</font>Dir<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">])&gt;</font><font color="#800000">0</font><font color="#000080">)
              </font><font color="#FF0000"><b>then </b></font>Dir<font color="#000080">:=</font>Dir<font color="#000080">+</font><font color="#800000">';'</font><font color="#000080">;
        </font>EF<font color="#000080">:=</font>FSearch<font color="#000080">(</font>ExeFile<font color="#000080">,</font>Dir<font color="#000080">+</font>GetEnv<font color="#000080">(</font><font color="#800000">'PATH'</font><font color="#000080">));
        </font><font color="#FF0000"><b>if </b></font>EF<font color="#000080">=</font><font color="#800000">''
          </font><font color="#FF0000"><b>then </b></font>Execute<font color="#000080">:=</font>false
          <font color="#FF0000"><b>else
            begin
</b></font><font color="#008000"><i>{$IFNDEF DPMI}
            </i></font>Error<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
            </font><font color="#FF0000"><b>If </b></font>MemAvail<font color="#000080">&lt;</font><font color="#800000">$1000
              </font><font color="#FF0000"><b>then </b></font>Error<font color="#000080">:=</font><font color="#800000">8</font><font color="#000080">;
            </font><font color="#FF0000"><b>If </b></font>Error<font color="#000080">=</font><font color="#800000">0
              </font><font color="#FF0000"><b>then
                begin
                  </b></font>NewHeapEnd<font color="#000080">:=</font>Seg<font color="#000080">(</font>HeapPtr<font color="#000080">^)-</font>PrefixSeg<font color="#000080">;
                  </font>OldHeapEnd<font color="#000080">:=</font>Seg<font color="#000080">(</font>HeapEnd<font color="#000080">^)-</font>PrefixSeg<font color="#000080">;
                  </font><font color="#FF0000"><b>asm
                    </b></font><font color="#FF00FF">mov ah,4Ah
                    mov bx,NewHeapEnd
                    mov es,PrefixSeg
                    Int 21h
                    jnc @EXIT
                    mov Error,ax
                  @EXIT:
                  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                 </font><font color="#FF0000"><b>If </b></font>Error<font color="#000080">=</font><font color="#800000">0
                   </font><font color="#FF0000"><b>then
                     begin
</b></font><font color="#008000"><i>{$ENDIF}
                       </i></font>SwapVectors<font color="#000080">;
                       </font>Exec<font color="#000080">(</font>EF<font color="#000080">,</font>ComLine<font color="#000080">);
                       </font>SwapVectors<font color="#000080">;
</font><font color="#008000"><i>{$IFNDEF DPMI}
                       </i></font><font color="#FF0000"><b>asm
                         </b></font><font color="#FF00FF">mov ah,4Ah
                         mov bx,OldHeapEnd
                         mov es,PrefixSeg
                         Int 21h
                         jnc @EXIT
                         mov Error,ax
                       @EXIT:
                     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
              </i></font>Execute<font color="#000080">:=</font>true<font color="#000080">;
            </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

{$IFDEF VIRTUALPASCAL}
{$UNDEF OS2}
{$ENDIF}

{$IFNDEF VIRTUALPASCAL}
</i></font><font color="#FF0000"><b>Procedure </b></font>GetFileMode<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">CLC
  CMP    ES:[DI].TextRec.Mode, fmInput
  JE     @1
  MOV    [InOutRes], 104         </font><font color="#008000"><i>{ 'File not opened For reading' }
  </i></font><font color="#FF00FF">xor    AX, AX                  </font><font color="#008000"><i>{ Zero out Function result }
  </i></font><font color="#FF00FF">xor    DX, DX
  STC
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ GetFileMode }

</i></font><font color="#FF0000"><b>Function </b></font>TextFilePos<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">LES    DI, f
  CALL   GetFileMode
  JC     @1
  xor    CX, CX                  </font><font color="#008000"><i>{ Get position of File Pointer }
  </i></font><font color="#FF00FF">xor    DX, DX
  MOV    BX, ES:[DI].TextRec.handle
  MOV    AX, 4201h
  inT    21h                     </font><font color="#008000"><i>{ offset := offset-Bufend+BufPos }
  </i></font><font color="#FF00FF">xor    BX, BX
  SUB    AX, ES:[DI].TextRec.Bufend
  SBB    DX, BX
  ADD    AX, ES:[DI].TextRec.BufPos
  ADC    DX, BX
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextFilePos }

</i></font><font color="#FF0000"><b>Function </b></font>TextFileSize<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">LES    DI, f
  CALL   GetFileMode
  JC     @1
  xor    CX, CX                  </font><font color="#008000"><i>{ Get position of File Pointer }
  </i></font><font color="#FF00FF">xor    DX, DX
  MOV    BX, ES:[DI].TextRec.handle
  MOV    AX, 4201h
  inT    21h
  PUSH   DX                      </font><font color="#008000"><i>{ Save current offset on the stack }
  </i></font><font color="#FF00FF">PUSH   AX
  xor    DX, DX                  </font><font color="#008000"><i>{ Move File Pointer to Eof }
  </i></font><font color="#FF00FF">MOV    AX, 4202h
  inT    21h
  POP    SI
  POP    CX
  PUSH   DX                      </font><font color="#008000"><i>{ Save Eof position }
  </i></font><font color="#FF00FF">PUSH   AX
  MOV    DX, SI                  </font><font color="#008000"><i>{ Restore old offset }
  </i></font><font color="#FF00FF">MOV    AX, 4200h
  inT    21h
  POP    AX                      </font><font color="#008000"><i>{ Return result}
  </i></font><font color="#FF00FF">POP    DX
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextFileSize }

</i></font><font color="#FF0000"><b>Procedure </b></font>TextSeek<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">; </font>n <font color="#000080">: </font>LongInt<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">LES    DI, f
  CALL   GetFileMode
  JC     @2
  MOV    CX, Word Ptr n+2        </font><font color="#008000"><i>{ Move File Pointer }
  </i></font><font color="#FF00FF">MOV    DX, Word Ptr n
  MOV    BX, ES:[DI].TextRec.Handle
  MOV    AX, 4200h
  inT    21h
  JNC    @1                      </font><font color="#008000"><i>{ Carry flag = reading past Eof }
  </i></font><font color="#FF00FF">MOV    [InOutRes], AX
  JMP    @2
  </font><font color="#008000"><i>{ Force read next time }
</i></font><font color="#FF00FF">@1:
  MOV    AX, ES:[DI].TextRec.Bufend
  MOV    ES:[DI].TextRec.BufPos, AX
@2:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextSeek }
{$ENDIF}

</i></font><font color="#FF0000"><b>function </b></font>FileExists<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>SR<font color="#000080">: </font>SearchRec<font color="#000080">;
</font><font color="#FF0000"><b>begin
</b></font><font color="#008000"><i>{$IFDEF OS2}
  </i></font>FindFirst<font color="#000080">(</font>FileName<font color="#000080">,</font>AnyFile<font color="#000080">-</font>Directory<font color="#000080">,</font>SR<font color="#000080">);
</font><font color="#008000"><i>{$ELSE}
  </i></font>FindFirst<font color="#000080">(</font>FileName<font color="#000080">,</font>AnyFile<font color="#000080">-</font>VolumeID<font color="#000080">-</font>Directory<font color="#000080">,</font>SR<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
  </i></font>FileExists<font color="#000080">:=</font>DosError<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>DirExists<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>SR<font color="#000080">: </font>SearchRec<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FindFirst<font color="#000080">(</font>FileName<font color="#000080">,</font>Directory<font color="#000080">,</font>SR<font color="#000080">);
  </font>DirExists<font color="#000080">:=</font>DosError<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>CopyFile<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>FromF<font color="#000080">,</font>ToF<font color="#000080">: </font><font color="#FF0000"><b>file   </b></font><font color="#000080">;
  </font>NrRead<font color="#000080">,
  </font>NrWriteln<font color="#000080">: </font>word   <font color="#000080">;
  </font>Buf      <font color="#000080">: </font>pointer<font color="#000080">;
  </font>Block    <font color="#000080">: </font>word   <font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>FromF<font color="#000080">,</font>FromN<font color="#000080">);
  </font>Assign<font color="#000080">(</font>ToF<font color="#000080">,</font>ToN<font color="#000080">);
  </font>Reset<font color="#000080">(</font>FromF<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>Rewrite<font color="#000080">(</font>ToF<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
  </font>Block<font color="#000080">:=</font>MaxAvail<font color="#000080">;
  </font>GetMem<font color="#000080">(</font>Buf<font color="#000080">,</font>Block<font color="#000080">);
  </font><font color="#FF0000"><b>repeat
    </b></font>BlockRead<font color="#000080">(</font>FromF<font color="#000080">,</font>Buf<font color="#000080">^,</font>Block<font color="#000080">,</font>NrRead<font color="#000080">);
    </font>BlockWrite<font color="#000080">(</font>ToF<font color="#000080">,</font>Buf<font color="#000080">^,</font>NrRead<font color="#000080">,</font>NrWriteLn<font color="#000080">);
  </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>NrRead<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>NrWriteLn<font color="#000080">&lt;&gt;</font>NrRead<font color="#000080">);
  </font>FreeMem<font color="#000080">(</font>Buf<font color="#000080">,</font>Block<font color="#000080">);
  </font>Close<font color="#000080">(</font>FromF<font color="#000080">);
  </font>Close<font color="#000080">(</font>ToF<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$IFDEF VIRTUALPASCAL}
{$DEFINE OS2}
{$ENDIF}

{$IFNDEF OS2}
</i></font><font color="#FF0000"><b>Function </b></font>GetMemSize<font color="#000080">;
</font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">Int 12h
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0095.PAS">Original</a><b>]</b></p></body>
</html>
