<html>
<head><title> "Trap DOS Error" by ALEXANDER KUGEL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Alexander Kugel

   There was a discussion about  how to trap  floating point errors
in  TP.  Here  is  the   solution that traps   any kind of run-time
errors.  The idea is not mine. I saw it in a russian  book about TP
and OOP.

   The idea is quite simple.  Instead of trying to trap all kind of
errors, we  can let TP to do  the job For  us.   Whenever  TP stops
execution of the  Program ( because   of a run  time  error or just
because  the Program  stops in a  natural  way )  it   executes the
default Procedure of Exit : ExitProc.  Then TP checks the status of
two Variables from  the SYSTEM Unit  : ErrorAddr and  ExitCode.  If
there was a run  time error then ErrorAddr  is not NIL and ExitCode
containes the run time error code. Otherwise ExitCode containes the
errorlevel  that  will be    set  For  Dos and  ErrorAddr  is  NIL.
Fortunatly  we can easily  redefine   the  ExitProc,   and  thus to
overtake the control from TP. The problem is that we got to be able
to get back or to jump to any point  of the Program  ( even to jump
inside a Procedure / Function). The author of the book claimed that
he took his routines from Turbo Professional.

   Well, there are two Files you are gonna need. Save the first one
as JUMP.PAS Compile it as a Unit. The second one is a short Program
that shows  how to use  it. It  asks For   two numbers, divides the
first  by the second and takes  a  natural logarithm of the result.
Try to divide by zero, logarithm of a negative number. Try entering
letters instead of numbers and see how the Program recovers.

   The trapping   works  fine under Windows/Dos.   To  run  it With
WindowS recompile the JUMP Unit For Windows target. Then add WinCrt
to the Uses statement and remove Mark/Release lines ( because there
is no Mark/Release For Windows ).

------------------------------jump.pas-----------------------------
}

</i></font><font color="#FF0000"><b>Unit </b></font>Jump<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Type
  </b></font>JumpRecord <font color="#000080">= </font><font color="#FF0000"><b>Record
    </b></font>SpReg<font color="#000080">,
    </font>BpReg  <font color="#000080">: </font>Word<font color="#000080">;
    </font>JmpPt  <font color="#000080">: </font>Pointer<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>SetJump<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>JumpDest <font color="#000080">: </font>JumpRecord<font color="#000080">);
</font><font color="#008000"><i>{Storing SP,BP and the address}
</i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(
  </font><font color="#800000">$5F</font><font color="#000080">/                   </font><font color="#008000"><i>{pop di           }
  </i></font><font color="#800000">$07</font><font color="#000080">/                   </font><font color="#008000"><i>{pop es           }
  </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$25</font><font color="#000080">/           </font><font color="#008000"><i>{mov es:[di],sp   }
  </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$6D</font><font color="#000080">/</font><font color="#800000">$02</font><font color="#000080">/       </font><font color="#008000"><i>{mov es:[di+2],bp }
  </i></font><font color="#800000">$E8</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/           </font><font color="#008000"><i>{call null        }
                         {null:            }
  </i></font><font color="#800000">$58</font><font color="#000080">/                   </font><font color="#008000"><i>{pop ax           }
  </i></font><font color="#800000">$05</font><font color="#000080">/</font><font color="#800000">$0C</font><font color="#000080">/</font><font color="#800000">$00</font><font color="#000080">/           </font><font color="#008000"><i>{add ax,12        }
  </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$89</font><font color="#000080">/</font><font color="#800000">$45</font><font color="#000080">/</font><font color="#800000">$04</font><font color="#000080">/       </font><font color="#008000"><i>{mov es:[di+4],ax }
  </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$8C</font><font color="#000080">/</font><font color="#800000">$4D</font><font color="#000080">/</font><font color="#800000">$06</font><font color="#000080">);      </font><font color="#008000"><i>{mov es:[di+6],cs }
                         {next:            }

</i></font><font color="#FF0000"><b>Procedure </b></font>LongJump<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>JumpDest <font color="#000080">: </font>JumpRecord<font color="#000080">);
</font><font color="#008000"><i>{Restore everything and jump}
</i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(
  </font><font color="#800000">$5F</font><font color="#000080">/                   </font><font color="#008000"><i>{pop di           }
  </i></font><font color="#800000">$07</font><font color="#000080">/                   </font><font color="#008000"><i>{pop es           }
  </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$25</font><font color="#000080">/           </font><font color="#008000"><i>{mov sp,es:[di]   }
  </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$8B</font><font color="#000080">/</font><font color="#800000">$6D</font><font color="#000080">/</font><font color="#800000">$02</font><font color="#000080">/       </font><font color="#008000"><i>{mov bp,es:[di+2] }
  </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$FF</font><font color="#000080">/</font><font color="#800000">$6D</font><font color="#000080">/</font><font color="#800000">$04</font><font color="#000080">);      </font><font color="#008000"><i>{jmp far es:[di+4]}

</i></font><font color="#FF0000"><b>Implementation

end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ ------------------------------try.pas------------------------------ }

</i></font><font color="#FF0000"><b>Program Try</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Uses
  </b></font>Jump<font color="#000080">;                                 </font><font color="#008000"><i>{Uses Jump,WinCrt;}

</i></font><font color="#FF0000"><b>Var
  </b></font>OldExit <font color="#000080">: </font>Pointer<font color="#000080">;
  </font>MyAddr  <font color="#000080">: </font>JumpRecord<font color="#000080">;
  </font>MyHeap  <font color="#000080">: </font>Pointer<font color="#000080">;

  </font>a1<font color="#000080">,</font>a2<font color="#000080">,
  </font>a3<font color="#000080">,</font>a4   <font color="#000080">: </font>Real<font color="#000080">;


</font><font color="#008000"><i>{$F+}
</i></font><font color="#FF0000"><b>Procedure </b></font>MyExit<font color="#000080">;
</font><font color="#008000"><i>{You can add your error handler here}
</i></font><font color="#FF0000"><b>begin
  if </b></font>ErrorAddr <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>Nil Then
  begin
    Case </b></font>ExitCode <font color="#FF0000"><b>of
      </b></font><font color="#800000">106 </font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Invalid numeric format'</font><font color="#000080">);
      </font><font color="#800000">200 </font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Division by zero'</font><font color="#000080">);
      </font><font color="#800000">205 </font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Floating point overflow'</font><font color="#000080">);
      </font><font color="#800000">206 </font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Floating point underflow'</font><font color="#000080">);
      </font><font color="#800000">207 </font><font color="#000080">: </font>Writeln<font color="#000080">(</font><font color="#800000">'Invalid floating point  operation'</font><font color="#000080">);
      </font><font color="#FF0000"><b>else  </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Hmmm... How did you do that ?'</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>ErrorAddr <font color="#000080">:= </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">;
    </font>LongJump<font color="#000080">(</font>MyAddr<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>ExitProc <font color="#000080">:= </font>OldExit<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}

</i></font><font color="#FF0000"><b>begin
  </b></font>OldExit <font color="#000080">:= </font>ExitProc<font color="#000080">;
  </font>Mark<font color="#000080">(</font>MyHeap<font color="#000080">);
  </font><font color="#008000"><i>{Just an example of how to restore the heap }
  {Actually we don't have to do that in       }
  {this Program, because we dont use heap     }
  {at all. But anyway here it goes            }

        {Don't forget to remove when compiling this }
        {for Windows        }

  </i></font>SetJump<font color="#000080">(</font>MyAddr<font color="#000080">);

  </font><font color="#008000"><i>{We'll get back here whenever a run time    }
  {error occurs                               }
  {This line should always be before          }
  {     ExitProc:=MyExit;                     }
  {Don't ask me why... It's much easier For me}
  {to follow the rule then to understand it :)}

  </i></font>ExitProc <font color="#000080">:= @</font>MyExit<font color="#000080">;

  </font>Release<font color="#000080">(</font>MyHeap<font color="#000080">);
  </font><font color="#008000"><i>{restoring the heap after a run time error }
        {Remove this if you are compiling it For   }
        {Windows                                   }

  {Try entering whatever you want at the     }
  {prompt. It should trap every runtime error}
  {you could possibly get.                   }

  </i></font><font color="#FF0000"><b>Repeat
    </b></font>Writeln<font color="#000080">;
    </font>Write<font color="#000080">(</font><font color="#800000">'Enter a number a1='</font><font color="#000080">);
    </font>Readln<font color="#000080">(</font>a1<font color="#000080">);
    </font>Write<font color="#000080">(</font><font color="#800000">'Enter a number a2='</font><font color="#000080">);
    </font>Readln<font color="#000080">(</font>a2<font color="#000080">);
    </font>a3 <font color="#000080">:= </font>a1 <font color="#000080">/ </font>a2<font color="#000080">;
    </font>Writeln<font color="#000080">(</font><font color="#800000">'a1/a2='</font><font color="#000080">, </font>a3 <font color="#000080">: </font><font color="#800000">10 </font><font color="#000080">: </font><font color="#800000">5</font><font color="#000080">);
    </font>a4 <font color="#000080">:= </font>ln<font color="#000080">(</font>a3<font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'ln(a1/a2)='</font><font color="#000080">, </font>a4 <font color="#000080">: </font><font color="#800000">10 </font><font color="#000080">: </font><font color="#800000">5</font><font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font>a3 <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p></body>
</html>
