<html>
<head><title> "Self-modifying Batch File" by LARS FOSDAL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#000000">LARS FOSDAL

<font color="#000080">&gt; </font>Hi all<font color="#000080">.  </font>I<font color="#800000">'ve got a little Program that brings up a Window and several
</font><font color="#000080">&gt; </font>buttons <font color="#FF0000"><b>in </b></font>TP <font color="#800000">7.  </font>The buttons have the names <font color="#FF0000"><b>of </b></font>Various batch Files <font color="#FF0000"><b>on </b></font>them
<font color="#000080">&gt; </font>which are executed when they are pressed<font color="#000080">.  </font>The batch Files start up Various
<font color="#000080">&gt; </font>other Programs<font color="#000080">.  </font>This launchpad <font color="#FF0000"><b>requires </b></font>about <font color="#800000">100</font>K <font color="#FF0000"><b>of </b></font>RAM <font color="#FF0000"><b>as </b></font>currently
<font color="#000080">&gt; </font>written<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>I<font color="#800000">'m wondering about ways to reduce this amount significantly.
</font><font color="#000080">&gt; </font>According <font color="#FF0000"><b>to </b></font>the BP <font color="#800000">7 </font>manual resource Files can be used <font color="#FF0000"><b>to </b></font>reduce RAM by <font color="#800000">8</font><font color="#000080">-
&gt; </font><font color="#800000">10</font><font color="#000080">%.  </font>Right now the Various buttons<font color="#800000">' Labels and commands are stored in
</font><font color="#000080">&gt; </font>simple Arrays<font color="#000080">, </font>which are <font color="#FF0000"><b>not </b></font>the most efficient memory<font color="#000080">-</font>wise<font color="#000080">, </font>but I don<font color="#800000">'t
</font><font color="#000080">&gt; </font>think that making them Records will significantly reduce RAM need<font color="#000080">.  </font>I<font color="#800000">'d like
</font><font color="#000080">&gt; </font><font color="#FF0000"><b>to </b></font>reduce RAM usage an order <font color="#FF0000"><b>of </b></font>magnitude<font color="#000080">, </font><font color="#FF0000"><b>to </b></font>about <font color="#800000">10</font>K<font color="#000080">.  </font>Any chance <font color="#FF0000"><b>of
</b></font><font color="#000080">&gt; </font>doing this<font color="#000080">?

</font>There <font color="#FF0000"><b>is </b></font>a dirty way <font color="#FF0000"><b>of </b></font>doing this<font color="#000080">, </font><font color="#FF0000"><b>and </b></font>it works <font color="#FF0000"><b>With </b></font>every Dos <font color="#000080">/
</font>command<font color="#000080">-</font>interpreter that I<font color="#800000">'ve tried it under, including Dos 6.0
</font><font color="#FF0000"><b>in </b></font>a Window under Windows<font color="#000080">, </font><font color="#FF0000"><b>and </b></font><font color="#800000">4</font>Dos<font color="#000080">.

</font>The Really nice thing about this way <font color="#FF0000"><b>to do </b></font>it<font color="#000080">, </font><font color="#FF0000"><b>is </b></font>that you can even
load TSR<font color="#800000">'s etc. since the menu Program is not in memory at all and there is
</font>no secondary command interpreter when the user executes his choice<font color="#000080">.

</font>The trick <font color="#FF0000"><b>is </b></font>that you run your <font color="#FF0000"><b>Program </b></font>from a <font color="#000080">&quot;</font>self<font color="#000080">-</font>modifying<font color="#000080">&quot; </font>batchFile<font color="#000080">.

--- </font>MENU<font color="#000080">.</font>BAT <font color="#000080">---
:</font>StartAgain
<font color="#FF0000"><b>SET </b></font>MENU<font color="#000080">=</font>C<font color="#000080">:\</font>Dos<font color="#000080">\</font>MENU<font color="#000080">.</font>BAT  <font color="#000080">; </font>Check this environment <font color="#FF0000"><b>Var </b></font>from your menu<font color="#000080">-</font>prog
GOMENU<font color="#000080">.</font>EXE                <font color="#000080">; </font><font color="#FF0000"><b>and </b></font>abort <font color="#FF0000"><b>if </b></font>it <font color="#FF0000"><b>is not set
SET </b></font>MENU<font color="#000080">=
----------------

</font>Lets say you want <font color="#FF0000"><b>to </b></font>run another batchFile from a menu choice f<font color="#000080">.</font>x MY<font color="#000080">.</font>BAT<font color="#000080">.
</font>Let your <font color="#FF0000"><b>Program </b></font>modify the MENU<font color="#000080">.</font>BAT <font color="#FF0000"><b>to</b></font><font color="#000080">:
---
:</font>StartAgain
<font color="#FF0000"><b>SET </b></font>MENU<font color="#000080">=</font>C<font color="#000080">:\</font>Dos<font color="#000080">\</font>MENU<font color="#000080">.</font>BAT
GOMENU<font color="#000080">.</font>EXE
<font color="#FF0000"><b>SET </b></font>MENU<font color="#000080">=
</font>CALL MY<font color="#000080">.</font>BAT
<font color="#FF0000"><b>GOTO </b></font>StartAgain
<font color="#000080">---

</font>When you want <font color="#FF0000"><b>to </b></font>terminate your menu<font color="#000080">-</font>loop<font color="#000080">, </font>simply modify the MENU<font color="#000080">.</font>BAT
back <font color="#FF0000"><b>to </b></font>it<font color="#800000">'s original state.

</font>The menu <font color="#FF0000"><b>Program </b></font>can be shared from a network server<font color="#000080">.  </font>There <font color="#FF0000"><b>is </b></font>no
limitations at all<font color="#000080">.  </font>You can <font color="#FF0000"><b>do </b></font>Dos commands from the menu Without
having <font color="#FF0000"><b>to </b></font>load a second shell<font color="#000080">.

</font>Following my <font color="#000080">.</font>sig there <font color="#FF0000"><b>is </b></font>a short example <font color="#FF0000"><b>Program</b></font><font color="#000080">.  </font>It can<font color="#800000">'t be run
</font>directly since it <font color="#FF0000"><b>Uses </b></font>some libraries <font color="#FF0000"><b>of </b></font>mine<font color="#000080">, </font>but you<font color="#800000">'ll get an idea
</font><font color="#FF0000"><b>of </b></font>how <font color="#FF0000"><b>to do </b></font>it<font color="#000080">.


</font><font color="#FF0000"><b>Program </b></font>HitAndRun<font color="#000080">; </font><font color="#008000"><i>{Menusystem}
</i></font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">, </font>Crt<font color="#000080">, </font>LFsystem<font color="#000080">, </font>LFCrt<font color="#000080">, </font>LFinput<font color="#000080">;
</font><font color="#008000"><i>{
  Written by Lars Fosdal
  May 5th, 1991

  Released to the public domain, May 15th, 1993
}
</i></font><font color="#FF0000"><b>Const
  </b></font>HitAndRunMsg <font color="#000080">= </font><font color="#800000">'Written by Lars Fosdal '</font><font color="#000080">;
  </font>Prog         <font color="#000080">= </font><font color="#800000">'HIT&amp;RUN'</font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>path <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#008000"><i>{----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure Message</b></font><font color="#000080">(</font>MessageIndex <font color="#000080">: </font>Integer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>Writeln<font color="#000080">(</font>Output<font color="#000080">);
  </font>Writeln<font color="#000080">(</font>Output<font color="#000080">, </font>Prog<font color="#000080">, </font><font color="#800000">' - '</font><font color="#000080">, </font>HitAndRunMsg<font color="#000080">);
  </font>Write<font color="#000080">(</font>Output<font color="#000080">, </font><font color="#800000">'Error: '</font><font color="#000080">);
  </font><font color="#FF0000"><b>Case </b></font>MessageIndex <font color="#FF0000"><b>OF
    </b></font><font color="#000080">-</font><font color="#800000">1 </font><font color="#000080">:
      </font><font color="#FF0000"><b>begin
        </b></font>Write<font color="#000080">(</font>Output<font color="#000080">, </font>Prog<font color="#000080">, </font><font color="#800000">' must be started from '</font><font color="#000080">);
        </font>Writeln<font color="#000080">(</font>Output<font color="#000080">,</font>Path <font color="#000080">+ </font><font color="#800000">'MENU.BAT'</font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Write<font color="#000080">(</font>Output<font color="#000080">,^</font>G<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>BuildBatchFile<font color="#000080">(</font>Execute <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>BatchFile <font color="#000080">: </font>Text<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>BatchFile<font color="#000080">, </font>Path <font color="#000080">+ </font><font color="#800000">'MENU.BAT'</font><font color="#000080">);
  </font>ReWrite<font color="#000080">(</font>BatchFile<font color="#000080">);
  </font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font><font color="#800000">'@ECHO OFF'</font><font color="#000080">);
  </font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font><font color="#800000">'REM ' </font><font color="#000080">+ </font>Prog <font color="#000080">+ </font><font color="#800000">' Menu Minder'</font><font color="#000080">);
  </font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font><font color="#800000">'REM ' </font><font color="#000080">+ </font>HitAndRunMsg<font color="#000080">);
  </font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font><font color="#800000">':HitAgain'</font><font color="#000080">);
  </font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font><font color="#800000">'SET H&amp;R=BATCH'</font><font color="#000080">);
  </font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font>path <font color="#000080">+ </font><font color="#800000">'HIT&amp;RUN'</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Execute<font color="#000080">&lt;&gt;</font><font color="#800000">'' </font><font color="#FF0000"><b>then
  begin
    </b></font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font>Execute<font color="#000080">);
    </font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font><font color="#800000">'GOTO HitAgain'</font><font color="#000080">);
  </font><font color="#FF0000"><b>end
  else
    </b></font>Writeln<font color="#000080">(</font>BatchFile<font color="#000080">, </font><font color="#800000">'SET H&amp;R='</font><font color="#000080">);
  </font>Close<font color="#000080">(</font>BatchFile<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>InitOK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>OK <font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>path   <font color="#000080">:= </font>BeforeLast<font color="#000080">(</font><font color="#800000">'\'</font><font color="#000080">, </font>ParamStr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) + </font><font color="#800000">'\'</font><font color="#000080">;
  </font>OK     <font color="#000080">:= </font>GetEnv<font color="#000080">(</font><font color="#800000">'H&amp;R'</font><font color="#000080">) = </font><font color="#800000">'BATCH'</font><font color="#000080">;
  </font>InitOK <font color="#000080">:= </font>OK<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>HitAndRunMenu<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>Mnu <font color="#000080">: </font>aMenu<font color="#000080">;
  </font>win <font color="#000080">: </font>aWindow<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>wDef<font color="#000080">(</font>Win<font color="#000080">, </font><font color="#800000">70</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">80</font><font color="#000080">, </font><font color="#800000">25</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>Col<font color="#000080">(</font>Blue<font color="#000080">, </font>LightGray<font color="#000080">), </font>Col<font color="#000080">(</font>Blue<font color="#000080">, </font>White<font color="#000080">));
  </font>ItemSeparator<font color="#000080">:= </font><font color="#800000">'`'</font><font color="#000080">;
  </font>mBarDefault <font color="#000080">:= </font>Red <font color="#000080">* </font><font color="#800000">16 </font><font color="#000080">+ </font>Yellow<font color="#000080">;
  </font>mNew<font color="#000080">(</font>Mnu<font color="#000080">, </font><font color="#800000">'Pick an item to run'</font><font color="#000080">,
       </font><font color="#800000">'Quit Menu`COMMAND`DIR /P`D:\BIN\NI'
      </font><font color="#000080">+ </font><font color="#800000">'`D:\BIN\MAPMEM`D:\BIN\X3\XTG'
      </font><font color="#000080">+ </font><font color="#800000">'`D:\BIN\LIST C:\Dos\MENY.BAT'</font><font color="#000080">);
  </font>Menu<font color="#000080">(</font>Win<font color="#000080">, </font>Mnu<font color="#000080">);
  </font><font color="#FF0000"><b>Case </b></font>Mnu<font color="#000080">.</font>Entry <font color="#FF0000"><b>OF
    </b></font><font color="#800000">1 </font><font color="#000080">: </font>BuildBatchFile<font color="#000080">(</font><font color="#800000">''</font><font color="#000080">);
    </font><font color="#FF0000"><b>else
      </b></font>BuildBatchFile<font color="#000080">(</font>Mnu<font color="#000080">.</font>Items<font color="#000080">[</font>Mnu<font color="#000080">.</font>Entry<font color="#000080">]^);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;</font><font color="#008000"><i>{HitAndRunMenu}

</i></font><font color="#FF0000"><b>begin
  if </b></font>InitOK <font color="#FF0000"><b>then
    </b></font>HitAndRunMenu
  <font color="#FF0000"><b>else
  begin
    Message</b></font><font color="#000080">(-</font><font color="#800000">1</font><font color="#000080">);
    </font>BuildBatchFile<font color="#000080">(</font><font color="#800000">''</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Writeln<font color="#000080">(</font>OutPut<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p></body>
</html>
