<html>
<head><title> "Sharing Files" by LEE ARONER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{

   I've been puzzling over Share myself the last week. Here's some
   tips from what I've found:

   1. Remember, if you are trying to write to the same region from
   both processes, you will *still* get a sharing violation with
   access denied to the last one to ask ! There is a subfunc, (440Bh
   I think) for changing the default number of tries that share will
   retry for access. You might want to look into that. Otherwise you
   could use something like the OpenTxtFile routine below, modified
   for use on non-text files, or both. (You aren't trying to share
   text files are you? If so, there IS a way to do it, let me know).

   2. Also note that you set the filemode AFTER assignment, and
   BEFORE a reset, rewrite or append.

   3. The following are 2 functions I've put together to handle my
   stuff. Note that the first is for non-text files, the second is
   for text files. The text file routine uses an external TFDD unit
   to set up the filemode variable so it works with text files.
   Holler if you want the unit also.........

           (* Call this to lock or unlock the ENTIRE file
****** use lock =$00 &amp; unlock = $01 constants for action *********
              ***** SHARE.EXE MUST be loaded ! *******
             Do NOT use on Text Files ! will NOT work !
You could modify this to only lock certain regions by passing values
for a start and stop region. Load CX/DX and DI/SI as done below. *)
}

</i></font><font color="#FF0000"><b>Function </b></font>LockFile<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>f<font color="#000080">; </font>action<font color="#000080">:</font>byte<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>Var
   </b></font>fsize <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>Begin
 if </b></font>GotShare <font color="#FF0000"><b>then                         </b></font><font color="#008000"><i>(* Share loaded ? *)
   </i></font><font color="#FF0000"><b>begin
     </b></font>fsize <font color="#000080">:= </font>longint<font color="#000080">(</font>filesize<font color="#000080">(</font><font color="#FF0000"><b>file</b></font><font color="#000080">(</font>f<font color="#000080">)));   </font><font color="#008000"><i>(* Get filesize *)
     </i></font>Regs<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$5C</font><font color="#000080">;                             </font><font color="#008000"><i>(* Subfunc *)
     </i></font>Regs<font color="#000080">.</font>AL <font color="#000080">:= </font>Action<font color="#000080">;           </font><font color="#008000"><i>(* $00=Lock or $01=unlock *)
     </i></font>Regs<font color="#000080">.</font>BX <font color="#000080">:= </font>FileRec<font color="#000080">(</font>f<font color="#000080">).</font>Handle<font color="#000080">;        </font><font color="#008000"><i>(* Git the handle *)
     </i></font>Regs<font color="#000080">.</font>CX <font color="#000080">:= </font>Hi<font color="#000080">(</font><font color="#800000">$00</font><font color="#000080">);                   </font><font color="#008000"><i>(* Start of file *)
     </i></font>Regs<font color="#000080">.</font>DX <font color="#000080">:= </font>Lo<font color="#000080">(</font><font color="#800000">$00</font><font color="#000080">);
     </font>Regs<font color="#000080">.</font>DI <font color="#000080">:= </font>Lo<font color="#000080">(</font>fsize<font color="#000080">);           </font><font color="#008000"><i>(* Compute end of file *)
     </i></font>Regs<font color="#000080">.</font>SI <font color="#000080">:= </font>Hi<font color="#000080">(</font>fsize<font color="#000080">);
     </font>Intr<font color="#000080">(</font><font color="#800000">$21</font><font color="#000080">, </font>Regs<font color="#000080">);
     </font><font color="#FF0000"><b>if </b></font><font color="#000080">((</font>Regs<font color="#000080">.</font>FLAGS <font color="#FF0000"><b>and </b></font><font color="#800000">$01</font><font color="#000080">) = </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>LockFile <font color="#000080">:= </font>true
     <font color="#FF0000"><b>else
       begin
         </b></font>IORes <font color="#000080">:= </font>regs<font color="#000080">.</font>AX<font color="#000080">;      </font><font color="#008000"><i>(* If fails, errcode is in AX *)
         </i></font>LockFile <font color="#000080">:= </font>false<font color="#000080">;    </font><font color="#008000"><i>(* IORes is a global that gets *)
       </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                   </font><font color="#008000"><i>(* used in IOReport if an error *)
   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>(*-------------------------------------------------------------*)
  (* Share compatable  Will retry if access denied, tries times
           5 Tries is equivilent to a 1/2 second wait

                                  ----- Sharing Method -----
 Access         Compatibility   Deny   Deny    Deny   Deny
 Method            Mode         Both   Write   Read   None
 ---------------------------------------------------------
 Read Only           0           16     32      48     64
 Write Only          1           17     33      49     65
 Read/Write          2*          18     34      50     66
                        * = default                        *)

</i></font><font color="#FF0000"><b>FUNCTION </b></font>OpenTxtFile<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>f<font color="#000080">; </font>fname<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font>tries<font color="#000080">:</font>word<font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>VAR
   </b></font>i  <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>i <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
 </font><font color="#FF0000"><b>if </b></font>GotShare <font color="#FF0000"><b>then                       </b></font><font color="#008000"><i>(* Share loaded ? *)
   </i></font><font color="#FF0000"><b>begin
     </b></font>AssignText<font color="#000080">(</font>text<font color="#000080">(</font>f<font color="#000080">),</font>Fname<font color="#000080">);         </font><font color="#008000"><i>(* From TxtShare unit *)
     </i></font>FileMode <font color="#000080">:= </font><font color="#800000">34</font><font color="#000080">;            </font><font color="#008000"><i>(* Open in r/w-deny write mode *)
   </i></font><font color="#FF0000"><b>end
 else  </b></font>Assign<font color="#000080">(</font>text<font color="#000080">(</font>f<font color="#000080">),</font>Fname<font color="#000080">);
 </font><font color="#FF0000"><b>Repeat
  </b></font><font color="#008000"><i>{$I-} </i></font>Reset<font color="#000080">(</font>text<font color="#000080">(</font>f<font color="#000080">));
  </font>IORes <font color="#000080">:= </font>IoResult<font color="#000080">; </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>if </b></font>IORes <font color="#000080">= </font><font color="#800000">5 </font><font color="#FF0000"><b>then              </b></font><font color="#008000"><i>(* Only repeat if denied access *)
    </i></font><font color="#FF0000"><b>begin
      </b></font>wait<font color="#000080">(</font><font color="#800000">100</font><font color="#000080">);                </font><font color="#008000"><i>(* Wait 1/10 second before retry *)
      </i></font>INC<font color="#000080">(</font>i<font color="#000080">);                 </font><font color="#008000"><i>(* Use your own delay routine here *)
    </i></font><font color="#FF0000"><b>end
  else </b></font>i <font color="#000080">:= </font>tries<font color="#000080">;                </font><font color="#008000"><i>(*  Quit if not a sharing deny *)
 </i></font><font color="#FF0000"><b>Until </b></font><font color="#000080">(</font>IORes <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>OR </b></font><font color="#000080">(</font>i <font color="#000080">&gt;= </font>tries<font color="#000080">);
 </font><font color="#FF0000"><b>if </b></font>GotShare <font color="#FF0000"><b>then </b></font>FileMode <font color="#000080">:= </font><font color="#800000">2</font><font color="#000080">;      </font><font color="#008000"><i>(* Set FileMode to default *)
 </i></font>OpenTxtFile <font color="#000080">:= </font>IORes <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{    ****** Here's a quick SHARE detect routine ********* }

</i></font><font color="#FF0000"><b>Function </b></font>ShareInstalled <font color="#000080">: </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>asm
  </b></font><font color="#FF00FF">mov ax,$1000
  int $2f
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0048.PAS">Original</a><b>]</b></p></body>
</html>
