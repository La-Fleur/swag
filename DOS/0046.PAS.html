<html>
<head><title> "Setting DOS Prompt" by TREVOR CARLSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0046.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
TF&gt;How does one alter a DOS environment variable in PASCAL and have the change
TF&gt;reflected after the program terminates, leaving the user in DOS, and the use
TF&gt;types SET?  This has been bugging me for a while. I know that there are two
TF&gt;copies of the environment and I need to access the top one, but I don't know
TF&gt;how.

The following example shows how to change the prompt: }

</i></font><font color="#FF0000"><b>function </b></font>MastEnvSeg<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Envlen<font color="#000080">: </font>word<font color="#000080">): </font>word<font color="#000080">;
  </font><font color="#008000"><i>{-returns the master environment segment }
  </i></font><font color="#FF0000"><b>var
    </b></font>mcb<font color="#000080">,</font>temp<font color="#000080">,</font>handle <font color="#000080">: </font>word<font color="#000080">;
    </font>lastmcb <font color="#000080">: </font>boolean<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>MastEnvSeg <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Envlen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>handle <font color="#000080">:= </font>MemW<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">: </font><font color="#800000">$ba</font><font color="#000080">]; </font><font color="#008000"><i>{-$2e * 4 + 2}
    {-The interrupt vector $2e points to the first paragraph of
      allocated to the command processor}
    </i></font>mcb <font color="#000080">:= </font>pred<font color="#000080">(</font>handle<font color="#000080">);
    </font><font color="#008000"><i>{-mcb now points to the memory control block for the command processor}
    </i></font><font color="#FF0000"><b>repeat
      </b></font>temp <font color="#000080">:= </font>Mcb<font color="#000080">+</font>MemW<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">]+</font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Mem<font color="#000080">[</font>temp<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">] = </font><font color="#800000">$4d</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>MemW<font color="#000080">[</font>temp<font color="#000080">:</font><font color="#800000">1</font><font color="#000080">] = </font>handle<font color="#000080">) </font><font color="#FF0000"><b>then begin
        </b></font>lastmcb <font color="#000080">:= </font>false<font color="#000080">;
        </font>mcb     <font color="#000080">:= </font>temp<font color="#000080">;
      </font><font color="#FF0000"><b>end
      else
        </b></font>lastmcb <font color="#000080">:= </font>true<font color="#000080">;
    </font><font color="#FF0000"><b>until </b></font>lastmcb<font color="#000080">;
    </font>EnvLen <font color="#000080">:= </font>Mem<font color="#000080">[</font>Mcb<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>shl </b></font><font color="#800000">4</font><font color="#000080">;
    </font>MastEnvSeg <font color="#000080">:= </font>succ<font color="#000080">(</font>Mcb<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


  </font><font color="#FF0000"><b>procedure </b></font>InitNewPrompt<font color="#000080">;
  </font><font color="#008000"><i>{-set up a new prompt for shelling to dos}
  </i></font><font color="#FF0000"><b>type
    </b></font>_2karray  <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2048</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>SegPtr    <font color="#000080">= ^</font>_2karray<font color="#000080">;
  </font><font color="#FF0000"><b>const
    </b></font>NewPrompt <font color="#000080">: </font><font color="#FF0000"><b>string </b></font><font color="#000080">=
    (</font><font color="#800000">'PROMPT=Type EXIT to return to program$_$p$g'</font><font color="#000080">+</font><font color="#800000">#0</font><font color="#000080">);
  </font><font color="#FF0000"><b>var
    </b></font>EnvSegment<font color="#000080">,
    </font>NewEnvSeg      <font color="#000080">: </font>word<font color="#000080">;
    </font>PtrSeg<font color="#000080">,
    </font>NewEnv         <font color="#000080">: </font>SegPtr<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>EnvSegment <font color="#000080">:= </font>memw<font color="#000080">[</font>prefixseg<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">];
    </font><font color="#008000"><i>{-this gets the actual starting segment of the current program's env}

    </i></font>PtrSeg <font color="#000080">:= </font>ptr<font color="#000080">(</font>pred<font color="#000080">(</font>EnvSegment<font color="#000080">),</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#008000"><i>{-The segment of the program's MCB - (Memory control block) }

    </i></font>getmem<font color="#000080">(</font>NewEnv<font color="#000080">,</font><font color="#800000">1072</font><font color="#000080">+</font>length<font color="#000080">(</font>NewPrompt<font color="#000080">));
    </font><font color="#008000"><i>{-Allocate heap memory and allow enough room for a dummy mcb }

    </i></font><font color="#FF0000"><b>if </b></font>ofs<font color="#000080">(</font>NewEnv<font color="#000080">^) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>NewEnvSeg <font color="#000080">:= </font>seg<font color="#000080">(</font>NewEnv<font color="#000080">^) + </font><font color="#800000">2
    </font><font color="#FF0000"><b>else
      </b></font>NewEnvSeg <font color="#000080">:= </font>succ<font color="#000080">(</font>seg<font color="#000080">(</font>NewEnv<font color="#000080">^));
    </font><font color="#008000"><i>{-Force the new environment to start at paragraph boundary}

    </i></font>move<font color="#000080">(</font>PtrSeg<font color="#000080">^,</font>mem<font color="#000080">[</font>pred<font color="#000080">(</font>NewEnvSeg<font color="#000080">):</font><font color="#800000">0</font><font color="#000080">],</font><font color="#800000">16</font><font color="#000080">);
    </font><font color="#008000"><i>{-copy the old mcb and force to paragraph boundary}

    </i></font>memw<font color="#000080">[</font>pred<font color="#000080">(</font>NewEnvSeg<font color="#000080">):</font><font color="#800000">3</font><font color="#000080">] := (</font><font color="#800000">1072</font><font color="#000080">+</font>length<font color="#000080">(</font>NewPrompt<font color="#000080">)) </font><font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">;
    </font><font color="#008000"><i>{-Alter the environment length by changing the dummy mcb}

    </i></font>move<font color="#000080">(</font>NewPrompt<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>memw<font color="#000080">[</font>NewEnvSeg<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">],</font>length<font color="#000080">(</font>NewPrompt<font color="#000080">));
    </font><font color="#008000"><i>{-install new prompt}

    </i></font>memw<font color="#000080">[</font>prefixseg<font color="#000080">:</font><font color="#800000">$2C</font><font color="#000080">] := </font>NewEnvSeg<font color="#000080">;
    </font><font color="#008000"><i>{-let the program know where the new env is}

    </i></font>move<font color="#000080">(</font>mem<font color="#000080">[</font>EnvSegment<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">],</font>mem<font color="#000080">[</font>NewEnvSeg<font color="#000080">:</font>length<font color="#000080">(</font>NewPrompt<font color="#000080">)],</font><font color="#800000">1024</font><font color="#000080">);
    </font><font color="#008000"><i>{-shift the old env to the new area}
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0046.PAS">Original</a><b>]</b></p></body>
</html>
