<html>
<head><title> "Extend DOS to 255 Files" by MARK LEWIS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
MARK LEWIS

&gt; The problem is that Without allocating a new FCB For Dos, you
&gt; can't have more than 15 or so Files open at a time in TP, no
&gt; matter WHAT the CONFIG.SYS FileS= statement says.  (By default,

i cannot remember exactly what INT $21 Function $6700 is but here's a PD Unit
i got from borland's bbs the other day... i've trimmed the Text down for
posting... if anyone Really needs everything that comes With it, they should
look For EXTend6.*
}

</i></font><font color="#FF0000"><b>Unit </b></font>Extend<font color="#000080">;
</font><font color="#008000"><i>{ This extends the number of File handles from 20 to 255 }
{ Dos requires 5 For itself. Applications can use up to 250 }

</i></font><font color="#FF0000"><b>Interface

Implementation
Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>Handles <font color="#000080">= </font><font color="#800000">255</font><font color="#000080">;
  </font><font color="#008000"><i>{ You can reduce the value passed to Handles if fewer Files are required. }

</i></font><font color="#FF0000"><b>Var
  </b></font>Reg <font color="#000080">: </font>Registers<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ Check the Dos Version - This technique only works For Dos 3.0 or later }
  </i></font>Reg<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$30</font><font color="#000080">;
  </font>MsDos<font color="#000080">(</font>Reg<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Reg<font color="#000080">.</font>al<font color="#000080">&lt;</font><font color="#800000">3 </font><font color="#FF0000"><b>then
  begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Extend Unit Require Dos 3.0 or greater'</font><font color="#000080">);
    </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{Reset the FreePtr - This reduces the heap space used by Turbo Pascal}
  </i></font><font color="#FF0000"><b>if </b></font>HeapOrg <font color="#000080">&lt;&gt; </font>HeapPtr <font color="#FF0000"><b>then
  </b></font><font color="#008000"><i>{Checks to see if the Heap is empty}
  </i></font><font color="#FF0000"><b>begin
    </b></font>Write<font color="#000080">(</font><font color="#800000">'Heap must be empty before Extend Unit initializes'</font><font color="#000080">);
    </font>Writeln<font color="#000080">;
    </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Heapend <font color="#000080">:= </font>ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>Heapend<font color="#000080">^) - (</font>Handles <font color="#FF0000"><b>div </b></font><font color="#800000">8 </font><font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">), </font>Ofs<font color="#000080">(</font>Heapend<font color="#000080">^));

  </font><font color="#008000"><i>{Determine how much memory is allocated to Program}
  {Reg.Bx will return how many paraGraphs used by Program}
  </i></font>Reg<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$4A</font><font color="#000080">;
  </font>Reg<font color="#000080">.</font>es <font color="#000080">:= </font>PrefixSeg<font color="#000080">;
  </font>Reg<font color="#000080">.</font>bx <font color="#000080">:= </font><font color="#800000">$FFFF</font><font color="#000080">;
  </font>msDos<font color="#000080">(</font>Reg<font color="#000080">);

  </font><font color="#008000"><i>{Set the Program size to the allow For new handles}
  </i></font>Reg<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$4A</font><font color="#000080">;
  </font>Reg<font color="#000080">.</font>es <font color="#000080">:= </font>PrefixSeg<font color="#000080">;
  </font>Reg<font color="#000080">.</font>bx <font color="#000080">:= </font>reg<font color="#000080">.</font>bx <font color="#000080">- (</font>Handles <font color="#FF0000"><b>div </b></font><font color="#800000">8 </font><font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
  </font>msDos<font color="#000080">(</font>Reg<font color="#000080">);

  </font><font color="#008000"><i>{Error when a Block Size is not appropriate}
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Reg<font color="#000080">.</font>flags <font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">) = </font><font color="#800000">1 </font><font color="#FF0000"><b>then
  begin
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Runtime Error '</font><font color="#000080">, </font>Reg<font color="#000080">.</font>ax<font color="#000080">, </font><font color="#800000">' in Extend.'</font><font color="#000080">);
    </font>halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{Allocate Space For Additional Handles}
  </i></font>reg<font color="#000080">.</font>ah <font color="#000080">:= </font><font color="#800000">$67</font><font color="#000080">;
  </font>reg<font color="#000080">.</font>bx <font color="#000080">:= </font>Handles<font color="#000080">;
  </font>MsDos<font color="#000080">(</font>reg<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{
Write the following Program to a separate File. This Program tests the EXTend
Unit. This test should be done on systems equipped With a hard disk.
}

</i></font><font color="#FF0000"><b>Program </b></font>TestEx<font color="#000080">;

</font><font color="#FF0000"><b>Uses
  </b></font>EXTend<font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>FileArray <font color="#000080">= </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">250</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Text<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>f <font color="#000080">: ^</font>FileArray<font color="#000080">;
  </font>i <font color="#000080">: </font>Integer<font color="#000080">;
  </font>s <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{Allocate Space For fILE Variable Table}
  </i></font>new<font color="#000080">(</font>f<font color="#000080">);
  </font><font color="#008000"><i>{oPEN 250 Files simultaneously}
  </i></font><font color="#FF0000"><b>For </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">250 </font><font color="#FF0000"><b>do
  begin
    </b></font>str<font color="#000080">(</font>i<font color="#000080">,</font>s<font color="#000080">);
    </font>Assign<font color="#000080">(</font>f<font color="#000080">^[</font>i<font color="#000080">],</font><font color="#800000">'Dum'</font><font color="#000080">+</font>s<font color="#000080">+</font><font color="#800000">'.txt'</font><font color="#000080">);
    </font>reWrite<font color="#000080">(</font>f<font color="#000080">^[</font>i<font color="#000080">]);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Open #'</font><font color="#000080">,</font>s<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{Write some Text to the Files}
  </i></font><font color="#FF0000"><b>For </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">250 </font><font color="#FF0000"><b>do
  </b></font>Write<font color="#000080">(</font>f<font color="#000080">^[</font>i<font color="#000080">],</font><font color="#800000">'This is a test File'</font><font color="#000080">);
  </font><font color="#008000"><i>{Close the Files}
  </i></font><font color="#FF0000"><b>For </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">250 </font><font color="#FF0000"><b>do
  begin
    </b></font>close<font color="#000080">(</font>f<font color="#000080">^[</font>i<font color="#000080">]);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Closing #'</font><font color="#000080">,</font>i<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{Erase the Files}
  </i></font><font color="#FF0000"><b>For </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">250 </font><font color="#FF0000"><b>do
  begin
    </b></font>erase<font color="#000080">(</font>f<font color="#000080">^[</font>i<font color="#000080">]);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'Erasing #'</font><font color="#000080">,</font>i<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p></body>
</html>
