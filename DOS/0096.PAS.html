<html>
<head><title> "Dos Redirection" by HENNING RUST</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 LG&gt; I am trying to write a routine using PKZIP.  I can get it to work
 LG&gt; except I am having a problem using the -z &lt;comment.fil option with
 LG&gt; EXEC.
the trouble is that the exec procedure doesn't support redirection of standard
input and standard output devices using the &quot;&gt;&quot; and &quot;&lt;&quot; chars, i.e. PKZIP
usually expects the comment to come from the &quot;STDIN&quot; standard input device
which normally is the keyboard. and with &lt;MYBANNER.TXT from the commandline
you redirect the STDIN to the file MYBANNER.TXTSo you have to do the
redirection yourself ;)
That's how it works:

(The STDIN file handle is always handle #0.)
1. copy this STDIN handle into a new one (to restore it afterwards)
2. open your redirection file
3. force the duplication of your redirection file's handle into the
   STDIN handle #0 (and close the redirection file's hadle)
4. the STDIN handle now no longer refers to the keyboard, but to your
   redirection file. Run EXEC without the &quot;&lt;blabla...&quot; stuff.
5. restore the old STDIN handle by forcing the duplication of your
   saved handle (from 1.) into handle 0.

hey, don't worry .. i did it for you ;)
i did a little error handling .. but it still could not work if there are too
few free file handles .. but this usually doesn't happen ;) and if it happens,
increase your FILES=?? in your CONFIG.SYSand if you change it in order to make
it fit into your prog: remember that ASCIIZfilename must always be declared as
a global variable!!

=== Cut ===
{$M 4096, 0, 0}
</i></font><font color="#FF0000"><b>program </b></font>redirection<font color="#000080">;

</font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">;

</font><font color="#FF0000"><b>const </b></font>STDIN <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;

</font><font color="#FF0000"><b>var   </b></font>error  <font color="#000080">: </font>boolean<font color="#000080">;
      </font>ASCIIZfilename <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>MyExec<font color="#000080">(</font>Path<font color="#000080">, </font>CmdLine<font color="#000080">, </font>STDINFile <font color="#000080">: </font><font color="#FF0000"><b>STRING</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var </b></font>filehandle     <font color="#000080">: </font>word<font color="#000080">;
    </font>dupSTDINhandle <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>asciizfilename <font color="#000080">:= </font>STDINfile <font color="#000080">+ </font><font color="#800000">#0</font><font color="#000080">;
  </font>error <font color="#000080">:= </font>false<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ax, 3d00h               </font><font color="#008000"><i>{OPEN A FILE}
    </i></font><font color="#FF00FF">mov dx, offset asciizfilename
    inc dx
    int 21h
    jnc @noerror
    mov error, 1
   @noerror:
    mov filehandle, ax
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>error <font color="#FF0000"><b>then begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'redirection file not found!'</font><font color="#000080">);
    </font>exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ah, 45h
    mov bx, STDIN  </font><font color="#008000"><i>{set bx to 0 = STDIN handle}
    </i></font><font color="#FF00FF">int 21h        </font><font color="#008000"><i>{DUPLICATE FILE HANDLE}
    </i></font><font color="#FF00FF">jnc @noerror2
    mov error, 1
   @noerror2:
    mov dupSTDINhandle, ax
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>error <font color="#FF0000"><b>then begin
    </b></font>writeln<font color="#000080">(</font><font color="#800000">'cannot duplicate STDIN handle'</font><font color="#000080">);
    </font><font color="#FF0000"><b>asm
      </b></font><font color="#FF00FF">mov ah, 3eh   </font><font color="#008000"><i>{CLOSE FILE}
      </i></font><font color="#FF00FF">mov bx, filehandle
      int 21h
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ah, 46h      </font><font color="#008000"><i>{FORCE DUPLICATE HANDLE}
    </i></font><font color="#FF00FF">mov bx, filehandle
    mov cx, STDIN
    int 21h
    mov ah, 3eh      </font><font color="#008000"><i>{CLOSE FILE}
    </i></font><font color="#FF00FF">mov bx, filehandle
    int 21h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>swapvectors<font color="#000080">;
  </font>exec<font color="#000080">(</font>Path<font color="#000080">, </font>CmdLine<font color="#000080">);
  </font>swapvectors<font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov ah, 46h      </font><font color="#008000"><i>{FORCE DUPLICATE HANDLE}
    </i></font><font color="#FF00FF">mov bx, dupSTDINhandle
    mov cx, STDIN
    int 21h
    mov ah, 3eh      </font><font color="#008000"><i>{CLOSE FILE}
    </i></font><font color="#FF00FF">mov bx, dupSTDINhandle
    int 21h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>myexec<font color="#000080">(</font><font color="#800000">'PKZIP.EXE'</font><font color="#000080">, </font><font color="#800000">'MYZIP.ZIP -z'</font><font color="#000080">, </font><font color="#800000">'MYCOMMENT.TXT'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0096.PAS">Original</a><b>]</b></p></body>
</html>
