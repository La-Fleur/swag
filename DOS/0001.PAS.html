<html>
<head><title> "Expand DOS File Handles" by TREVOR CARLSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0001.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Unit </b></font>expfht<font color="#000080">;

  </font><font color="#008000"><i>{ Author: Trevor J Carlsen  Released into the public domain }
  {         PO Box 568                                        }
  {         Port Hedland                                      }
  {         Western Australia 6721                            }
  {         Voice +61 91 732 026                              }

  { EXPFHT: This Unit allows an application to expand the number of File }
  { handles in use. It is limited to the number permitted by Dos and     }
  { initialised in the FileS= of the config.sys File.                    }

</i></font><font color="#FF0000"><b>Interface

Const
  </b></font>NumbFiles<font color="#000080">= </font><font color="#800000">105</font><font color="#000080">;
  </font><font color="#008000"><i>{ Set to the number of File handles needed. 99 will be the max With }
  { Dos 2.x and 254 With Dos 3.x. (I don't know why not 255!)         }
</i></font><font color="#FF0000"><b>Type
  </b></font>fht      <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font>NumbFiles<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>NewFHT   <font color="#000080">: </font>fht<font color="#000080">;
  </font>OldFHT   <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>OldSize  <font color="#000080">: </font>Word<font color="#000080">;
                    
</font><font color="#FF0000"><b>Function </b></font>MakeNewFHT<font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>RestoreOldFHT<font color="#000080">;


</font><font color="#FF0000"><b>Implementation

Const
  </b></font>Successful <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>OldExitProc  <font color="#000080">: </font>Pointer<font color="#000080">;

</font><font color="#008000"><i>{$R-}
</i></font><font color="#FF0000"><b>Function </b></font>MakeNewFHT <font color="#000080">: </font>Boolean<font color="#000080">;
  </font><font color="#008000"><i>{ create a new expanded File handle table - True if successful }
  </i></font><font color="#FF0000"><b>Const
    </b></font>AlreadyUsed <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    if not </b></font>AlreadyUsed <font color="#FF0000"><b>then begin
      </b></font>AlreadyUsed <font color="#000080">:= </font>True<font color="#000080">;
      </font>MakeNewFHT <font color="#000080">:= </font>True<font color="#000080">;
      </font>Successful <font color="#000080">:= </font>True<font color="#000080">;
      </font>OldFHT  <font color="#000080">:= </font>MemL<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$34</font><font color="#000080">];            </font><font color="#008000"><i>{ Store the old FHT address }
      </i></font>FillChar<font color="#000080">(</font>NewFHT<font color="#000080">,</font>NumbFiles<font color="#000080">,</font><font color="#800000">$ff</font><font color="#000080">);              </font><font color="#008000"><i>{ Fill new table With 255 }
      </i></font>Oldsize <font color="#000080">:= </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$32</font><font color="#000080">];               </font><font color="#008000"><i>{ Store the old FHT size }
      </i></font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$32</font><font color="#000080">] := </font>NumbFiles<font color="#000080">;            </font><font color="#008000"><i>{ Put new size in the psp }
      </i></font>MemL<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$34</font><font color="#000080">] := </font>LongInt<font color="#000080">(@</font>NewFHT<font color="#000080">);      </font><font color="#008000"><i>{ new FHT address in psp }
      </i></font>move<font color="#000080">(</font>Mem<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$19</font><font color="#000080">],</font>NewFHT<font color="#000080">,</font><font color="#800000">$15</font><font color="#000080">);      </font><font color="#008000"><i>{ put contents of old to new }
    </i></font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ if not AllreadyUsed }
    </i></font><font color="#FF0000"><b>else </b></font>MakeNewFHT <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ MakeNewFHT }
{$R+}

{$F+}
</i></font><font color="#FF0000"><b>Procedure </b></font>RestoreOldFHT<font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>ExitProc <font color="#000080">:= </font>OldExitProc<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>Successful <font color="#FF0000"><b>then begin
      </b></font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$32</font><font color="#000080">] := </font>OldSize<font color="#000080">;
      </font>MemL<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$34</font><font color="#000080">] := </font>OldFHT<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;  
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>{$F-}

</i></font><font color="#FF0000"><b>begin
  </b></font>OldExitProc <font color="#000080">:= </font>ExitProc<font color="#000080">;
  </font>ExitProc    <font color="#000080">:= @</font>RestoreOldFHT<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0001.PAS">Original</a><b>]</b></p></body>
</html>
