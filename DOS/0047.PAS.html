<html>
<head><title> "Loading Overlays in XMS" by REINHARDT MUELLER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{
With this unit, it doesn't matter if the overlay is separate,
or tacked onto the end of the .EXE file -- the program will
run either way.

As written, this unit also uses OVERXMS, a PD unit written
Wilbert Van Leijen.  Floating around the BBS's as OVERXMS.ZIP
You may delete the references to XMS.
The XMS stuff is in there because the program I copied this
code from will run on a 486 and just about all of the college
machines have XMS memory -- few if any have EMS. }

{$A-,B+,D-,F+,I-,L-,N-,O-,Q+,R-,S-,V-}

</i></font><font color="#FF0000"><b>UNIT </b></font>RVOVRLAY<font color="#000080">;

</font><font color="#008000"><i>{ This unit starts the overlay manager }

</i></font><font color="#FF0000"><b>INTERFACE
Const
  </b></font>ovrNoXMSDriver <font color="#000080">= -</font><font color="#800000">7</font><font color="#000080">;   </font><font color="#008000"><i>{ No XMS driver installed }
  </i></font>ovrNoXMSMemory <font color="#000080">= -</font><font color="#800000">8</font><font color="#000080">;   </font><font color="#008000"><i>{ Insufficient XMS memory available }


</i></font><font color="#FF0000"><b>IMPLEMENTATION

USES </b></font>DOS<font color="#000080">, </font>OVERLAY<font color="#000080">;

</font><font color="#008000"><i>{ OVERXMS - Loads overlays in XMS.
  Assembly-language portion written by Wilbert van Leijen }
</i></font><font color="#FF0000"><b>Procedure </b></font>OvrInitXMS<font color="#000080">; </font><font color="#FF0000"><b>External</b></font><font color="#000080">;
</font><font color="#008000"><i>{$L OVERXMS.OBJ }

</i></font><font color="#FF0000"><b>Function </b></font>Exist<font color="#000080">(</font>Filename<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">):</font>boolean<font color="#000080">;
</font><font color="#008000"><i>{returns true if file exists}

</i></font><font color="#FF0000"><b>var </b></font>Inf<font color="#000080">: </font>SearchRec<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>FindFirst<font color="#000080">(</font>Filename<font color="#000080">,</font>AnyFile<font color="#000080">,</font>Inf<font color="#000080">);
  </font>Exist <font color="#000080">:= (</font>DOSError <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{Func Exist}


</i></font><font color="#FF0000"><b>Procedure </b></font>S_Write <font color="#000080">(</font>Msg <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);

</font><font color="#FF0000"><b>BEGIN  </b></font><font color="#008000"><i>{Dirty trick to generate less code}
  </i></font>Write <font color="#000080">(</font>msg<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>Procedure </b></font>WriteOvrErrMsg<font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>garbage<font color="#000080">:</font>char<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  </b></font>WRITE <font color="#000080">(</font><font color="#800000">'Overlay error: '</font><font color="#000080">,</font>OvrResult<font color="#000080">,</font><font color="#800000">'  '</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrOk<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'Ok - No error'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrError<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'Missing Overlay error'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrNotFound<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'Overlay file not found'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrNoMemory<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'No Memory for overlays'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrIOError<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'Overlay IO Error'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrNoEMSDriver<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'No EMS Driver'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrNoEMSMemory<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'No EMS Memory'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrNoXMSDriver<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'No XMS Driver'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrNoXMSMemory<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>S_WRITE <font color="#000080">(</font><font color="#800000">'No XMS Memory'</font><font color="#000080">);
  </font>S_WRITE <font color="#000080">(^</font>M<font color="#000080">^</font>J<font color="#000080">);
  </font>read <font color="#000080">(</font>garbage<font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font>OvrResult <font color="#000080">&lt;&gt; </font>OvrOK <font color="#FF0000"><b>THEN </b></font>HALT <font color="#000080">(</font><font color="#800000">98</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;  </font><font color="#008000"><i>{ Procedure WriteOvrErrMsg }


</i></font><font color="#FF0000"><b>BEGIN      </b></font><font color="#008000"><i>{ main }

  </i></font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>lo<font color="#000080">(</font>DosVersion<font color="#000080">) &lt; </font><font color="#800000">3</font><font color="#000080">) </font><font color="#FF0000"><b>THEN
    BEGIN
      </b></font>WriteLn <font color="#000080">(</font><font color="#800000">'You are using DOS version '</font><font color="#000080">,</font>Lo<font color="#000080">(</font>DosVersion<font color="#000080">),
               </font><font color="#800000">'.'</font><font color="#000080">,</font>Hi<font color="#000080">(</font>DosVersion<font color="#000080">));
      </font>Writeln <font color="#000080">(</font><font color="#800000">'Mulesoft Revenge requires DOS v3.0 or greater.'</font><font color="#000080">);
      </font>HALT <font color="#000080">(</font><font color="#800000">99</font><font color="#000080">);
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Start overlay manager and assume that overlay is in
    the .EXE file.  If not found in .EXE file, assume the
    overlay file is separate from the .EXE file. }

  </i></font>OVRINIT <font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">));

  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>OvrResult <font color="#000080">= </font>ovrError<font color="#000080">) </font><font color="#FF0000"><b>THEN  </b></font><font color="#008000"><i>{ Overlay not at end of .EXE file }
    </i></font>OVRINIT <font color="#000080">(</font>copy<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">), </font><font color="#800000">1</font><font color="#000080">, </font>Length<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">))-</font><font color="#800000">3</font><font color="#000080">) + </font><font color="#800000">'OVR'</font><font color="#000080">);
  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">&lt;&gt; </font>OvrOk<font color="#000080">) </font><font color="#FF0000"><b>THEN
      </b></font>WriteOvrErrMsg
  <font color="#FF0000"><b>ELSE     </b></font><font color="#008000"><i>{ Try to load the overlay into XMS memory }
    </i></font><font color="#FF0000"><b>BEGIN
      </b></font>OvrInitXms<font color="#000080">;
      </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>OvrResult <font color="#000080">&lt;&gt; </font>OvrOk<font color="#000080">) </font><font color="#FF0000"><b>THEN
        </b></font>OvrInitEms<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font><font color="#008000"><i>{------------------------- snip, snip ----------------------------}

   </i></font>Here <font color="#FF0000"><b>is </b></font>the <font color="#000080">.</font>OBJ <font color="#FF0000"><b>file </b></font>that goes <font color="#FF0000"><b>with </b></font>this <font color="#FF0000"><b>file </b></font><font color="#000080">...
   </font>you will need XX3402 o decode this output<font color="#000080">:

   </font>Cut this <font color="#FF0000"><b>out to </b></font>a <font color="#FF0000"><b>file </b></font>named OVERXMS<font color="#000080">.</font>XX<font color="#000080">.
   </font>Execute XX3402 d OVERXMS<font color="#000080">.</font>XX

   You will <font color="#FF0000"><b>then </b></font>get the <font color="#FF0000"><b>file </b></font>OVERXMS<font color="#000080">.</font>OBJ <font color="#FF0000"><b>to </b></font>compile this <font color="#FF0000"><b>unit

</b></font><font color="#000080">*</font>XX3402<font color="#000080">-</font><font color="#800000">000913</font><font color="#000080">-</font><font color="#800000">020294</font><font color="#000080">--</font><font color="#800000">72</font><font color="#000080">--</font><font color="#800000">85</font><font color="#000080">-</font><font color="#800000">48736</font><font color="#000080">-----</font>OVERXMS<font color="#000080">.</font>OBJ<font color="#000080">--</font><font color="#800000">1</font><font color="#000080">-</font><font color="#FF0000"><b>OF</b></font><font color="#000080">--</font><font color="#800000">1
</font>U<font color="#000080">+</font>o<font color="#000080">+</font><font color="#800000">0</font>qxqNL7sPLAiEJBBFMUU<font color="#000080">++++</font><font color="#800000">53</font>FpQa7j623nQqJhMalZQW<font color="#000080">+</font>UJaJmQqZjPW<font color="#000080">+</font>n9X8NW<font color="#000080">-</font>A<font color="#000080">+
</font>ECafC26Q0qxqNL7sPLAiEJBBnMU1<font color="#000080">+</font><font color="#800000">21</font>dH7M0<font color="#000080">++-</font>cW<font color="#000080">+</font>A<font color="#000080">+</font>E84IZUM<font color="#000080">+-</font><font color="#800000">2</font>F<font color="#000080">-</font>J234a<font color="#000080">+</font>Q<font color="#000080">+</font>G<font color="#000080">-</font>c<font color="#000080">++</font>U2<font color="#000080">-
</font>ytM4<font color="#000080">++</font>F1HoF3FNU5<font color="#000080">+</font><font color="#800000">0</font>Wi<font color="#000080">+</font>EA<font color="#000080">-+</font>MKAJ<font color="#000080">++</font><font color="#800000">7</font>I373FYZMIoJ5<font color="#000080">++</font>V3K2ZII37DEk<font color="#000080">+</font><font color="#800000">7</font>HpNGIYJHJIlI
<font color="#000080">++</font>hDJZ71HoF3H2ZHJ<font color="#000080">++</font>AHpNGF2xHG23CF2l3<font color="#000080">++</font>dDJZ76FI3EHp75<font color="#000080">++</font>dDJZ7GFI32EZJ4<font color="#000080">+</font><font color="#800000">0</font>OE
<font color="#800000">2E</font><font color="#000080">+++</font>UdDJZ77HYZIK2pHCE2<font color="#000080">+</font>xcU2<font color="#000080">+</font><font color="#800000">20</font>W<font color="#000080">+</font>N4UgU20<font color="#000080">++</font><font color="#800000">093</font>VU<font color="#000080">+</font>h<font color="#000080">+</font>fz5U<font color="#000080">++</font>l<font color="#000080">+</font>M2<font color="#000080">+</font><font color="#800000">8</font>A<font color="#000080">++</font><font color="#800000">6</font>k4<font color="#000080">+</font>U19
Aw<font color="#000080">+</font>nocgS<font color="#000080">+++</font><font color="#800000">15</font>U<font color="#000080">++</font>UwAEXgAa<font color="#000080">+</font>kM6<font color="#000080">+</font><font color="#800000">6</font>DG<font color="#000080">+</font><font color="#800000">0</font>O95Us<font color="#000080">+</font><font color="#800000">0</font>xhptfg<font color="#000080">+-</font>DTnYY8o0TwS<font color="#000080">+++</font><font color="#800000">9</font>k5E2WFMM
<font color="#000080">+</font>ABJWymCFUMacEU<font color="#000080">+</font>ckU<font color="#000080">+</font>Aw0X0U0V4<font color="#000080">+</font><font color="#800000">0</font>X1<font color="#000080">++</font>acFM<font color="#000080">+</font>cks<font color="#000080">+</font><font color="#800000">7e2</font>M<font color="#000080">+</font><font color="#800000">8</font>AE<font color="#000080">+</font><font color="#800000">1</font>D<font color="#000080">+</font>cl6<font color="#000080">+</font>clE<font color="#000080">+</font><font color="#800000">7e2E</font><font color="#000080">+</font><font color="#800000">8</font>AK
<font color="#000080">+</font><font color="#800000">9E9</font>jUU<font color="#000080">+</font>zls<font color="#000080">+++</font>j<font color="#000080">+</font>R<font color="#000080">+</font>F6ukGEiDnzLQc0<font color="#000080">+</font><font color="#800000">0</font>O93UU<font color="#000080">+</font>xw6<font color="#000080">-+</font><font color="#800000">5E4E</font>WPz<font color="#000080">-</font>UU<font color="#000080">+</font>WFM6<font color="#000080">+</font><font color="#800000">1</font>D<font color="#000080">+</font>ckc<font color="#000080">+</font>ckk<font color="#000080">+
</font>cks<font color="#000080">+</font>cE<font color="#000080">++</font>cl<font color="#000080">++</font>cFU<font color="#000080">+</font>cl6<font color="#000080">+</font>WHsI<font color="#000080">+</font><font color="#800000">6</font>YS3U0o0vs6<font color="#000080">+</font>DwS<font color="#000080">+++</font><font color="#800000">1</font>ycDH<font color="#000080">++</font>j<font color="#000080">+</font>R<font color="#000080">+</font><font color="#800000">9</font>skzb1JMjgcE<font color="#000080">++</font>AwY1
<font color="#000080">-</font>U<font color="#000080">++-</font>F<font color="#000080">++</font>Xg<font color="#000080">-</font>EEGOV1U<font color="#000080">+</font><font color="#800000">9</font>k5LhAxgnzkRFcE<font color="#000080">++</font><font color="#800000">7e</font>AE<font color="#000080">+</font><font color="#800000">0</font>O75VU<font color="#000080">+</font><font color="#800000">7</font>cYy3U<font color="#000080">-</font>HJkM4zls<font color="#000080">+++</font>RTKmP5
<font color="#000080">-</font>V<font color="#000080">++++</font><font color="#800000">1</font>rq566u4jzQUBNsgy9tJr1Aw<font color="#000080">+</font>v<font color="#000080">-</font>U<font color="#000080">++</font>REF6uqOEi<font color="#000080">+-</font><font color="#800000">1</font>nGwwU5E4iDbzupSEi<font color="#000080">--</font><font color="#800000">1</font>nGy7
<font color="#800000">5</font>U<font color="#000080">++</font>X<font color="#000080">+</font>M0<font color="#000080">+</font>CWmzbI4iDXzunyEu5PzQl093VU<font color="#000080">+</font>h<font color="#000080">+</font>fz5U<font color="#000080">++</font>iDnzumeEWls<font color="#000080">++</font><font color="#800000">9E</font>ynG55<font color="#000080">-</font>U<font color="#000080">++</font>HU0A
<font color="#800000">1</font>U6<font color="#000080">+</font>l<font color="#000080">+</font>M<font color="#000080">++</font><font color="#800000">8</font>A2<font color="#000080">+</font><font color="#800000">6</font>k4<font color="#000080">-</font>U15<font color="#000080">-</font>U<font color="#000080">++++</font><font color="#800000">0</font>A1U6<font color="#000080">+</font>Aw0X<font color="#000080">++</font><font color="#800000">19</font>RdnW<font color="#000080">+</font>AE0J<font color="#000080">+</font><font color="#800000">5203E</font><font color="#000080">-</font>l<font color="#000080">+</font>lI<font color="#000080">+</font>QED<font color="#000080">-</font>U20l<font color="#000080">-</font>A4
<font color="#000080">+</font>E925<font color="#000080">+</font>M<font color="#000080">--</font>AEU<font color="#000080">-</font>U2<font color="#000080">-</font>l2BI<font color="#000080">+</font>QF9J<font color="#000080">+</font><font color="#800000">52</font>KJE<font color="#000080">-</font>l3tI<font color="#000080">+</font>QFVJ<font color="#000080">+</font><font color="#800000">52</font>N3E<font color="#000080">-</font>l4hI<font color="#000080">+</font>QFmJ<font color="#000080">+</font><font color="#800000">52</font>RpE<font color="#000080">-</font>l5dI<font color="#000080">+</font>QG<font color="#000080">-
</font>J<font color="#000080">+</font><font color="#800000">52</font>VZE<font color="#000080">-</font>l6dI<font color="#000080">+</font>QGiJ<font color="#000080">+</font><font color="#800000">52</font>gpE<font color="#000080">-</font>l9NI<font color="#000080">+</font>QGtJ<font color="#000080">+</font><font color="#800000">52</font>j<font color="#000080">+</font>M<font color="#000080">--</font>gGzJ<font color="#000080">+</font><font color="#800000">52</font>kZE<font color="#000080">-</font>lAJI<font color="#000080">+</font>QH7J<font color="#000080">+</font><font color="#800000">52</font>nJE<font color="#000080">-</font>lB7I
<font color="#000080">+</font>QHKJ<font color="#000080">+</font><font color="#800000">52</font>uEM<font color="#000080">--</font>AHj<font color="#000080">-</font>U2<font color="#000080">-</font>lEQ4<font color="#000080">+</font>EP35EM<font color="#000080">--</font>wIx<font color="#000080">-</font>U23lJhI<font color="#000080">+</font>QJTJ<font color="#000080">+</font><font color="#800000">53</font>QpE<font color="#000080">-</font>lLZI<font color="#000080">+</font>QK1<font color="#000080">-</font>U23lMg4
<font color="#000080">+</font>ET3XJE0lN24<font color="#000080">+</font>ET3ZEM<font color="#000080">-+</font>gKMJ<font color="#000080">+</font><font color="#800000">53</font>b3E<font color="#000080">-</font>lO<font color="#000080">+</font><font color="#800000">4</font><font color="#000080">+</font>E93cZE0lOM4<font color="#000080">+</font>E93ekM<font color="#000080">-+</font>z88<font color="#000080">+</font>U<font color="#000080">++</font>R<font color="#000080">+++
***** </font><font color="#FF0000"><b>END OF </b></font>BLOCK <font color="#800000">1 </font><font color="#000080">*****

</font><font color="#008000"><i>{---------------------         OVERXMS.ASM   --------------------- }
{                          NEED MASM,TASM to compile               }

</i></font>TITLE Turbo <font color="#FF0000"><b>Pascal </b></font>XMS support <font color="#FF0000"><b>for </b></font>loading overlays <font color="#000080">- </font>By Wilbert van Leijen
PAGE <font color="#800000">65</font><font color="#000080">, </font><font color="#800000">132
</font>LOCALS <font color="#000080">@@

</font>Data       SEGMENT Word <font color="#FF0000"><b>Public
           </b></font>ASSUME  DS<font color="#000080">:</font>Data

<font color="#000080">;  </font>XMS block move <font color="#FF0000"><b>record

</b></font>XmsMoveType STRUC
           BlkSize     DD    <font color="#000080">?
           </font>SrcHandle   DW    <font color="#000080">?
           </font>SrcOffset   DD    <font color="#000080">?
           </font>DestHandle  DW    <font color="#000080">?
           </font>DestOffset  DD    <font color="#000080">?
</font>XmsMoveType ENDS

<font color="#000080">;  </font>TP overlay manager <font color="#FF0000"><b>record

</b></font>OvrHeader  STRUC
           ReturnAddr  DD    <font color="#000080">?         ; </font><font color="#FF0000"><b>Virtual </b></font>return address
           FileOfs     DD    <font color="#000080">?         ; </font>Offset into overlay <font color="#FF0000"><b>file
           </b></font>CodeSize    DW    <font color="#000080">?         ; </font>Size <font color="#FF0000"><b>of </b></font>overlay
           FixupSize   DW    <font color="#000080">?         ; </font>Size <font color="#FF0000"><b>of </b></font>fixup table
           EntryPts    DW    <font color="#000080">?         ; </font>Number <font color="#FF0000"><b>of </b></font>procedures
           CodeListNext DW   <font color="#000080">?         ; </font>Segment <font color="#FF0000"><b>of </b></font>next overlay
           LoadSeg     DW    <font color="#000080">?         ; </font>Start segment <font color="#FF0000"><b>in </b></font>memory
           Reprieved   DW    <font color="#000080">?         ; </font>Loaded <font color="#FF0000"><b>in </b></font>memory flag
           LoadListNext DW   <font color="#000080">?         ; </font>Segment <font color="#FF0000"><b>of </b></font>next <font color="#FF0000"><b>in </b></font>load list
           XmsOffset   DD    <font color="#000080">?         ; </font>Offset into allocated XMS block
           UserData    DW    <font color="#800000">3 </font>DUP<font color="#000080">(?)
</font>OvrHeader  ENDS

XmsDriver  DD      <font color="#000080">?                   ; </font>Entry point <font color="#FF0000"><b>of </b></font>XMS driver
ExitSave   DD      <font color="#000080">?                   ; </font>Pointer <font color="#FF0000"><b>to </b></font>previous exit proc
XmsMove    XmsMoveType <font color="#000080">&lt;&gt;
</font>OvrXmsHandle DW    <font color="#000080">?                   ; </font>Returned by XMS driver

           Extrn   PrefixSeg <font color="#000080">: </font>Word
           Extrn   ExitProc <font color="#000080">: </font>DWord
           Extrn   OvrResult <font color="#000080">: </font>Word
           Extrn   OvrCodeList <font color="#000080">: </font>Word
           Extrn   OvrDosHandle <font color="#000080">: </font>Word
           Extrn   OvrHeapOrg <font color="#000080">: </font>Word
           Extrn   OvrReadBuf <font color="#000080">: </font>DWord
Data       ENDS

Code       SEGMENT Byte <font color="#FF0000"><b>Public
           </b></font>ASSUME  CS<font color="#000080">:</font>Code
           <font color="#FF0000"><b>Public  </b></font>OvrInitXMS

ovrIOError     EQU     <font color="#000080">-</font><font color="#800000">4
</font>ovrNoXMSDriver EQU     <font color="#000080">-</font><font color="#800000">7
</font>ovrNoXMSMemory EQU     <font color="#000080">-</font><font color="#800000">8

</font>OvrXmsExit PROC

<font color="#000080">; </font>Release handle <font color="#FF0000"><b>and </b></font>XMS memory

        MOV    DX<font color="#000080">, [</font>OvrXmsHandle<font color="#000080">]
        </font>MOV    AH<font color="#000080">, </font><font color="#800000">10
        </font>CALL   <font color="#000080">[</font>XmsDriver<font color="#000080">]

; </font>Restore pointer <font color="#FF0000"><b>to </b></font>previous exit <font color="#FF0000"><b>procedure

        </b></font>LES    AX<font color="#000080">, [</font>ExitSave<font color="#000080">]
        </font>MOV    Word Ptr <font color="#000080">[</font>ExitProc<font color="#000080">], </font>AX
        MOV    Word Ptr <font color="#000080">[</font>ExitProc<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>ES
        RETF
OvrXmsExit ENDP

AllocateXms PROC

<font color="#000080">;  </font>Determine the size <font color="#FF0000"><b>of </b></font>the XMS block <font color="#FF0000"><b>to </b></font>allocate<font color="#000080">:
;  </font>Walk the CodeListNext chain
<font color="#000080">;  </font>Store the total codesize <font color="#FF0000"><b>in </b></font>DX<font color="#000080">:</font>AX

        <font color="#FF0000"><b>XOR    </b></font>AX<font color="#000080">, </font>AX
        <font color="#FF0000"><b>XOR    </b></font>DX<font color="#000080">, </font>DX
        MOV    BX<font color="#000080">, [</font>OvrCodeList<font color="#000080">]
@@</font><font color="#800000">1</font><font color="#000080">:    </font>ADD    BX<font color="#000080">, [</font>PrefixSeg<font color="#000080">]
        </font>ADD    BX<font color="#000080">, </font><font color="#800000">10</font>h
        MOV    ES<font color="#000080">, </font>BX
        ADD    AX<font color="#000080">, </font>ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>CodeSize<font color="#000080">]
        </font>ADC    DX<font color="#000080">, </font><font color="#800000">0
        </font>MOV    BX<font color="#000080">, </font>ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>CodeListNext<font color="#000080">]
        </font><font color="#FF0000"><b>OR     </b></font>BX<font color="#000080">, </font>BX
        JNZ    <font color="#000080">@@</font><font color="#800000">1

</font><font color="#000080">;  </font>Obtain number <font color="#FF0000"><b>of </b></font>kilobytes <font color="#FF0000"><b>to </b></font>allocate

        MOV    BX<font color="#000080">, </font><font color="#800000">1024
        </font><font color="#FF0000"><b>DIV    </b></font>BX
        XCHG   DX<font color="#000080">, </font>AX
        INC    DX

<font color="#000080">;  </font>Allocate the block

        MOV    AH<font color="#000080">, </font><font color="#800000">9
        </font>CALL   <font color="#000080">[</font>XmsDriver<font color="#000080">]
        </font><font color="#FF0000"><b>OR     </b></font>AX<font color="#000080">, </font>AX
        JZ     <font color="#000080">@@</font><font color="#800000">2
        </font>MOV    <font color="#000080">[</font>OvrXmsHandle<font color="#000080">], </font>DX
<font color="#000080">@@</font><font color="#800000">2</font><font color="#000080">:    </font>RETN
AllocateXms ENDP

<font color="#000080">;  </font><font color="#FF0000"><b>Function </b></font>XmsReadFunc<font color="#000080">(</font>OvrSeg <font color="#000080">: </font>Word<font color="#000080">) : </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>Far</b></font><font color="#000080">;

</font>XmsReadFunc PROC

<font color="#000080">;  </font>Swap the code from XMS <font color="#FF0000"><b>to </b></font>the heap

        PUSH   BP
        MOV    BP<font color="#000080">, </font>SP
        MOV    ES<font color="#000080">, [</font>BP<font color="#000080">+</font><font color="#800000">6</font><font color="#000080">]
        </font>MOV    AX<font color="#000080">, </font>ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>CodeSize<font color="#000080">]
        </font>MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>BlkSize<font color="#000080">], </font>AX
        <font color="#FF0000"><b>XOR    </b></font>AX<font color="#000080">, </font>AX
        MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>BlkSize<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>AX
        MOV    AX<font color="#000080">, [</font>OvrXmsHandle<font color="#000080">]
        </font>MOV    <font color="#000080">[</font>XmsMove<font color="#000080">.</font>SrcHandle<font color="#000080">], </font>AX
        MOV    AX<font color="#000080">, </font>Word Ptr ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>XmsOffset<font color="#000080">]
        </font>MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>SrcOffset<font color="#000080">], </font>AX
        MOV    AX<font color="#000080">, </font>Word Ptr ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>XmsOffset<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">]
        </font>MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>SrcOffset<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>AX
        <font color="#FF0000"><b>XOR    </b></font>AX<font color="#000080">, </font>AX
        MOV    <font color="#000080">[</font>XmsMove<font color="#000080">.</font>DestHandle<font color="#000080">], </font>AX
        MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>DestOffset<font color="#000080">], </font>AX
        MOV    AX<font color="#000080">, </font>ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>LoadSeg<font color="#000080">]
        </font>MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>DestOffset<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>AX
        MOV    AH<font color="#000080">, </font><font color="#800000">11
        </font>LEA    SI<font color="#000080">, </font>XmsMove
        CALL   <font color="#000080">[</font>XmsDriver<font color="#000080">]
        </font><font color="#FF0000"><b>OR     </b></font>AX<font color="#000080">, </font>AX
        JZ     <font color="#000080">@@</font><font color="#800000">1
        </font>DEC    AX
        JMP    <font color="#000080">@@</font><font color="#800000">2

</font><font color="#000080">@@</font><font color="#800000">1</font><font color="#000080">:    </font>MOV    AX<font color="#000080">, </font>ovrIOError
<font color="#000080">@@</font><font color="#800000">2</font><font color="#000080">:    </font>POP    BP
        RETF   <font color="#800000">2
</font>XmsReadFunc ENDP

<font color="#000080">;  </font>Copy an overlaid <font color="#FF0000"><b>unit </b></font>from the heap <font color="#FF0000"><b>to </b></font>XMS
<font color="#000080">;  </font><font color="#FF0000"><b>If </b></font>successful<font color="#000080">, </font>carry flag <font color="#FF0000"><b>is </b></font>cleared
<font color="#000080">;  </font><font color="#FF0000"><b>In</b></font><font color="#000080">/</font><font color="#FF0000"><b>Out</b></font><font color="#000080">:
;    </font>BX<font color="#000080">:</font>DI <font color="#000080">= </font>offset into XMS memory block

CopyUnitToXms PROC

<font color="#000080">;  </font>XMS <font color="#FF0000"><b>requires </b></font>that an even number <font color="#FF0000"><b>of </b></font>bytes <font color="#FF0000"><b>is </b></font>moved

        MOV    DX<font color="#000080">, </font>ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>CodeSize<font color="#000080">]
        </font>TEST   DX<font color="#000080">, </font><font color="#800000">1
        </font>JZ     <font color="#000080">@@</font><font color="#800000">1
        </font>INC    DX
        INC    ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>CodeSize<font color="#000080">]

;  </font>Get the fields <font color="#FF0000"><b>of </b></font>the XMS block move structure

<font color="#000080">@@</font><font color="#800000">1</font><font color="#000080">:    </font>MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>BlkSize<font color="#000080">], </font>DX
        <font color="#FF0000"><b>XOR    </b></font>AX<font color="#000080">, </font>AX
        MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>BlkSize<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>AX
        MOV    <font color="#000080">[</font>XmsMove<font color="#000080">.</font>SrcHandle<font color="#000080">], </font>AX
        MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>SrcOffset<font color="#000080">], </font>AX
        MOV    AX<font color="#000080">, [</font>OvrHeapOrg<font color="#000080">]
        </font>MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>SrcOffset<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>AX
        MOV    AX<font color="#000080">, [</font>OvrXmsHandle<font color="#000080">]
        </font>MOV    <font color="#000080">[</font>XmsMove<font color="#000080">.</font>DestHandle<font color="#000080">], </font>AX
        MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>DestOffset<font color="#000080">], </font>DI
        MOV    Word Ptr <font color="#000080">[</font>XmsMove<font color="#000080">.</font>DestOffset<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>BX
        MOV    AH<font color="#000080">, </font><font color="#800000">11
        </font>LEA    SI<font color="#000080">, </font>XmsMove
        CALL   <font color="#000080">[</font>XmsDriver<font color="#000080">]

;  </font>Bump code size

        ADD    DI<font color="#000080">, </font>DX
        ADC    BX<font color="#000080">, </font><font color="#800000">0

</font><font color="#000080">;  </font>Check return code from XMS driver

        <font color="#FF0000"><b>OR     </b></font>AX<font color="#000080">, </font>AX
        JZ     <font color="#000080">@@</font><font color="#800000">2
        </font>CLC
        RETN

<font color="#000080">@@</font><font color="#800000">2</font><font color="#000080">:    </font>STC
        RETN
CopyUnitToXms ENDP

OvrXmsLoad PROC
        PUSH   BP
        MOV    BP<font color="#000080">, </font>SP

<font color="#000080">;  </font>Walk the CodeList chain
<font color="#000080">;  </font>First segment <font color="#FF0000"><b>is </b></font>PrefixSeg<font color="#000080">+</font><font color="#800000">10</font>h<font color="#000080">+</font>OvrCodeList
<font color="#000080">;  </font>Push each element <font color="#FF0000"><b>of </b></font>overlaid <font color="#FF0000"><b>unit </b></font>list <font color="#FF0000"><b>on </b></font>the stack
<font color="#000080">;  </font>Keep the size <font color="#FF0000"><b>of </b></font>the linked list <font color="#FF0000"><b>in </b></font>CX

        MOV    AX<font color="#000080">, [</font>OvrCodeList<font color="#000080">]
        </font><font color="#FF0000"><b>XOR    </b></font>CX<font color="#000080">, </font>CX
<font color="#000080">@@</font><font color="#800000">1</font><font color="#000080">:    </font>ADD    AX<font color="#000080">, [</font>PrefixSeg<font color="#000080">]
        </font>ADD    AX<font color="#000080">, </font><font color="#800000">10</font>h
        MOV    ES<font color="#000080">, </font>AX
        PUSH   AX
        INC    CX
        MOV    AX<font color="#000080">, </font>ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>CodeListNext<font color="#000080">]
        </font><font color="#FF0000"><b>OR     </b></font>AX<font color="#000080">, </font>AX
        JNZ    <font color="#000080">@@</font><font color="#800000">1

</font><font color="#000080">;  </font>Loop<font color="#000080">:
;    </font>Pop each element <font color="#FF0000"><b>of </b></font>the overlaid <font color="#FF0000"><b>unit </b></font>list from the stack

        <font color="#FF0000"><b>XOR    </b></font>BX<font color="#000080">, </font>BX
        <font color="#FF0000"><b>XOR    </b></font>DI<font color="#000080">, </font>DI
<font color="#000080">@@</font><font color="#800000">2</font><font color="#000080">:    </font>POP    ES
        PUSH   CX
        MOV    AX<font color="#000080">, [</font>OvrHeapOrg<font color="#000080">]
        </font>MOV    ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>LoadSeg<font color="#000080">], </font>AX
        MOV    Word Ptr ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>XmsOffset<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>BX
        MOV    Word Ptr ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>XmsOffset<font color="#000080">], </font>DI

<font color="#000080">;  </font>Load overlay from disk

        PUSH   BX
        PUSH   DI
        PUSH   ES
        PUSH   ES
        CALL   <font color="#000080">[</font>OvrReadBuf<font color="#000080">]
        </font>POP    ES
        POP    DI
        POP    BX

<font color="#000080">;  </font>Flag <font color="#FF0000"><b>unit as </b></font><font color="#800000">'unloaded'</font><font color="#000080">; </font>check return code

        MOV    ES<font color="#000080">:[</font>OvrHeader<font color="#000080">.</font>LoadSeg<font color="#000080">], </font><font color="#800000">0
        </font>NEG    AX
        JC     <font color="#000080">@@</font><font color="#800000">3

        </font>CALL   CopyUnitToXms
        JC     <font color="#000080">@@</font><font color="#800000">3

        </font>POP    CX
        LOOP   <font color="#000080">@@</font><font color="#800000">2

</font><font color="#000080">@@</font><font color="#800000">3</font><font color="#000080">:    </font>MOV    SP<font color="#000080">, </font>BP
        POP    BP
        RETN
OvrXMSLoad ENDP

OvrInitXMS PROC

<font color="#000080">;  </font>Make sure the <font color="#FF0000"><b>file</b></font><font color="#800000">'s been opened

        </font><font color="#FF0000"><b>XOR    </b></font>AX<font color="#000080">, </font>AX
        CMP    AX<font color="#000080">, [</font>OvrDOSHandle<font color="#000080">]
        </font>JNE    <font color="#000080">@@</font><font color="#800000">1
        </font>DEC    AX                      <font color="#000080">; </font>ovrError
        JMP    <font color="#000080">@@</font><font color="#800000">5

</font><font color="#000080">;  </font>Check presence <font color="#FF0000"><b>of </b></font>XMS driver

<font color="#000080">@@</font><font color="#800000">1</font><font color="#000080">:    </font>MOV    AX<font color="#000080">, </font><font color="#800000">4300</font>h
        INT    <font color="#800000">2</font>Fh
        CMP    AL<font color="#000080">, </font><font color="#800000">80</font>h
        JE     <font color="#000080">@@</font><font color="#800000">2
        </font>MOV    AX<font color="#000080">, </font>ovrNoXmsDriver
        JMP    <font color="#000080">@@</font><font color="#800000">5

</font><font color="#000080">;  </font>Get XMS driver<font color="#800000">'s entry point

</font><font color="#000080">@@</font><font color="#800000">2</font><font color="#000080">:    </font>MOV    AX<font color="#000080">, </font><font color="#800000">4310</font>h
        INT    <font color="#800000">2</font>Fh
        MOV    Word Ptr <font color="#000080">[</font>XmsDriver<font color="#000080">], </font>BX
        MOV    Word Ptr <font color="#000080">[</font>XmsDriver<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>ES
        CALL   AllocateXms
        JNZ    <font color="#000080">@@</font><font color="#800000">3
        </font>MOV    AX<font color="#000080">, </font>ovrNoXMSMemory
        JMP    <font color="#000080">@@</font><font color="#800000">5

</font><font color="#000080">;  </font>Load the overlay into XMS

<font color="#000080">@@</font><font color="#800000">3</font><font color="#000080">:    </font>CALL   OvrXmsLoad
        JNC    <font color="#000080">@@</font><font color="#800000">4

</font><font color="#000080">;  </font>An error occurred<font color="#000080">.  </font>Release handle <font color="#FF0000"><b>and </b></font>XMS memory

        MOV    DX<font color="#000080">, [</font>OvrXmsHandle<font color="#000080">]
        </font>MOV    AH<font color="#000080">, </font><font color="#800000">10
        </font>CALL   <font color="#000080">[</font>XmsDriver<font color="#000080">]
        </font>MOV    AX<font color="#000080">, </font>ovrIOError
        JMP    <font color="#000080">@@</font><font color="#800000">5

</font><font color="#000080">;  </font>Close <font color="#FF0000"><b>file

</b></font><font color="#000080">@@</font><font color="#800000">4</font><font color="#000080">:    </font>MOV    BX<font color="#000080">, [</font>OvrDOSHandle<font color="#000080">]
        </font>MOV    AH<font color="#000080">, </font><font color="#800000">3E</font>h
        INT    <font color="#800000">21</font>h

<font color="#000080">;  </font>OvrReadBuf <font color="#000080">:= </font>XmsReadFunc

        MOV    Word Ptr <font color="#000080">[</font>OvrReadBuf<font color="#000080">], </font>Offset XmsReadFunc
        MOV    Word Ptr <font color="#000080">[</font>OvrReadBuf<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>CS

<font color="#000080">;  </font>ExitSave <font color="#000080">:= </font>ExitProc
<font color="#000080">;  </font>ExitProc <font color="#000080">:= </font>OvrXmsExit

        LES    AX<font color="#000080">, [</font>ExitProc<font color="#000080">]
        </font>MOV    Word Ptr <font color="#000080">[</font>ExitSave<font color="#000080">], </font>AX
        MOV    Word Ptr <font color="#000080">[</font>ExitSave<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>ES
        MOV    Word Ptr <font color="#000080">[</font>ExitProc<font color="#000080">], </font>Offset OvrXmsExit
        MOV    Word Ptr <font color="#000080">[</font>ExitProc<font color="#000080">+</font><font color="#800000">2</font><font color="#000080">], </font>CS

<font color="#000080">;  </font>Return result <font color="#FF0000"><b>of </b></font>initialisation

        <font color="#FF0000"><b>XOR    </b></font>AX<font color="#000080">, </font>AX
<font color="#000080">@@</font><font color="#800000">5</font><font color="#000080">:    </font>MOV    <font color="#000080">[</font>OvrResult<font color="#000080">], </font>AX
        RETF
OvrInitXMS ENDP

Code       ENDS
           <font color="#FF0000"><b>END
</b></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0047.PAS">Original</a><b>]</b></p></body>
</html>
