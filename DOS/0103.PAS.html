<html>
<head><title> "DOS Environment handling" by ROBERT B. CLARK</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0103.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ ENVIRON.PAS                                            Revision 1.00 }
{ Written 4 Nov 1994 by Robert B. Clark &lt;rclark@iquest.net&gt;            }
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }
{ A collection of DOS environment routines for Turbo Pascal v4.0.      }
{ Requires DOS v3.0+.  Tested on 486/P5 MS-DOS 5/6.22/NW 3.11          }
{                                                                      }
{ Donated to the public domain 17 Jan 96 by Robert B. Clark.           }
{ May be included in SWAG if so desired.                               }
{                                                                      }
{ WARNING:  High-ASCII line-drawing characters are used in the Shell() }
{           function near the end of this listing. Use the appropriate }
{           emulation for your printer if you print this code.         }
{                                                                      }
{ Last updated: 04 Apr 95                                              }
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }

</i></font><font color="#FF0000"><b>UNIT </b></font>Environ<font color="#000080">;  </font><font color="#008000"><i>{ SEE DEMO AT THE BOTTOM ! }
{$B+ Boolean short-circuit
  D- No debug information
  S- No stack overflow checking
  R- Range checking off
  V- VAR string length checking off
  I- I/O checking off }

</i></font><font color="#FF0000"><b>INTERFACE

Uses </b></font>Dos
<font color="#008000"><i>{$IFDEF UseLib} </i></font><font color="#000080">,</font>Files    <font color="#008000"><i>{ For FNStrip(), MAXPATHLEN and fileSpecType }
{$ENDIF}        </i></font><font color="#000080">;

</font><font color="#008000"><i>{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;Start personal lib interface&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }
{$IFNDEF UseLib   Definitions from my FILES.TPU unit }

</i></font><font color="#FF0000"><b>CONST </b></font>MAXPATHLEN   <font color="#000080">= </font><font color="#800000">64</font><font color="#000080">;
</font><font color="#FF0000"><b>TYPE  </b></font>fileSpecType <font color="#000080">= </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font>MAXPATHLEN<font color="#000080">];

</font><font color="#008000"><i>{$ENDIF}
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;End personal lib functions&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }

</i></font><font color="#FF0000"><b>CONST </b></font>MAX_EVAR_LEN  <font color="#000080">= </font><font color="#800000">127</font><font color="#000080">;      </font><font color="#008000"><i>{ Maximum environment variable length }
      </i></font>MAX_EVAR_BLEN <font color="#000080">= </font><font color="#800000">32768</font><font color="#000080">;    </font><font color="#008000"><i>{ Maximum size of environment block }

</i></font><font color="#FF0000"><b>TYPE </b></font>evarType    <font color="#000080">= </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font>MAX_EVAR_LEN<font color="#000080">];
     </font>envSizeType <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">32768</font><font color="#000080">;
     </font>MCBType     <font color="#000080">= </font><font color="#FF0000"><b>record
         </b></font>BlockID   <font color="#000080">: </font>byte<font color="#000080">;
         </font>OwnerPSP  <font color="#000080">: </font>word<font color="#000080">;
         </font>ParentPSP <font color="#000080">: </font>word<font color="#000080">;
         </font>BlockSize <font color="#000080">: </font>longint<font color="#000080">;
         </font>OwnerName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">8</font><font color="#000080">];
         </font>MCB_Seg   <font color="#000080">: </font>word<font color="#000080">;
         </font>MCB_Ofs   <font color="#000080">: </font>word
     <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR   </b></font>MASTER_MCB      <font color="#000080">: </font>MCBType<font color="#000080">;
      </font>MASTER_ENVSEG<font color="#000080">,
      </font>CURRENT_ENVSEG  <font color="#000080">: </font>word<font color="#000080">;
      </font>COMSPEC         <font color="#000080">: </font>evarType<font color="#000080">;      </font><font color="#008000"><i>{ Value of COMSPEC evar }
      </i></font>PROGRAMNAME     <font color="#000080">: </font>fileSpecType<font color="#000080">;  </font><font color="#008000"><i>{ Name of executing program }
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }

</i></font><font color="#FF0000"><b>FUNCTION  </b></font>EnvSize<font color="#000080">(</font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>envSizeType<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>MaxEnvSize<font color="#000080">(</font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>envSizeType<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>GetEnv<font color="#000080">(</font>evar<font color="#000080">:</font>evarType<font color="#000080">; </font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>evarType<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>DelEnv<font color="#000080">(</font>evar<font color="#000080">:</font>evarType<font color="#000080">; </font>envSeg<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>FUNCTION  </b></font>GetFirstMCB<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>InitMCBType<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">: </font>MCBType<font color="#000080">);
</font><font color="#FF0000"><b>PROCEDURE </b></font>ReadMCB<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">: </font>MCBType<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>last<font color="#000080">, </font>root<font color="#000080">: </font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>PROCEDURE </b></font>FindRootEnv<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">: </font>MCBType<font color="#000080">);
</font><font color="#FF0000"><b>FUNCTION  </b></font>PutEnv<font color="#000080">(</font>evar<font color="#000080">,</font>value<font color="#000080">: </font>evarType<font color="#000080">; </font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>PROCEDURE </b></font>AllocateBlock<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>blockSize<font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>segment<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>FUNCTION  </b></font>DeallocateBlock<font color="#000080">(</font>segment<font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>Shell<font color="#000080">(</font>prompt<font color="#000080">: </font>evarType<font color="#000080">): </font>integer<font color="#000080">;

</font><font color="#008000"><i>{$IFNDEF UseLib   Normally in Files.TPU }
</i></font><font color="#FF0000"><b>FUNCTION </b></font>FNStrip<font color="#000080">(</font>s<font color="#000080">: </font>fileSpecType<font color="#000080">; </font>specifier<font color="#000080">: </font>byte<font color="#000080">): </font>fileSpecType<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }

</i></font><font color="#FF0000"><b>IMPLEMENTATION

</b></font><font color="#008000"><i>{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;Start personal lib implementation&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }
{$IFNDEF UseLib   Functions from my FILES.TPU unit }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>FNStrip<font color="#000080">(</font>s<font color="#000080">: </font>fileSpecType<font color="#000080">; </font>specifier<font color="#000080">: </font>byte<font color="#000080">): </font>fileSpecType<font color="#000080">;
</font><font color="#008000"><i>{ Extracts (strips) specific portions of a fully-qualified filename.
  The specifier is the sum of the desired portions:

                       Bit
                     76543210               Dec
                     .......x  Extension     1
                     ......x.  Basename      2
                     .....x..  Path          4
                     ....x...  Disk letter   8

  A specifier of 0 is same as a specifier of 15 (all parts returned). }

</i></font><font color="#FF0000"><b>var </b></font>j<font color="#000080">,</font>len<font color="#000080">,</font>lastSlash<font color="#000080">, </font>lastDot<font color="#000080">: </font>integer<font color="#000080">;
    </font>disk<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
    </font>path<font color="#000080">,</font>temp<font color="#000080">: </font>fileSpecType<font color="#000080">;
    </font>baseName<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">8</font><font color="#000080">];
    </font>ext<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];

</font><font color="#FF0000"><b>begin
   </b></font>disk<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">; </font>path<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">; </font>baseName<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
   </font>ext<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">; </font>temp<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
   </font>specifier<font color="#000080">:=</font>specifier <font color="#FF0000"><b>and </b></font><font color="#800000">$0f</font><font color="#000080">;       </font><font color="#008000"><i>{ Strip high bits }
   {TrueName(s);}                      { Canonize filespec }
   </i></font>len<font color="#000080">:=</font>Length<font color="#000080">(</font>s<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>specifier<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>specifier<font color="#000080">=</font><font color="#800000">15</font><font color="#000080">) </font><font color="#FF0000"><b>then   </b></font><font color="#008000"><i>{ Return full name }
   </i></font><font color="#FF0000"><b>begin
      </b></font>FNStrip<font color="#000080">:=</font>s<font color="#000080">;
      </font>exit
   <font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>lastSlash<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>lastDot<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>j<font color="#000080">:=</font>len<font color="#000080">;
   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>lastSlash<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>j<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>do  </b></font><font color="#008000"><i>{ Get lastSlash &amp; lastDot indices }
   </i></font><font color="#FF0000"><b>begin
      if </b></font>s<font color="#000080">[</font>j<font color="#000080">]=</font><font color="#800000">'\' </font><font color="#FF0000"><b>then </b></font>lastSlash<font color="#000080">:=</font>j<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>lastDot<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>s<font color="#000080">[</font>j<font color="#000080">]=</font><font color="#800000">'.'</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>lastDot<font color="#000080">:=</font>j<font color="#000080">;
      </font>dec<font color="#000080">(</font>j<font color="#000080">)
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>len<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>s<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">':'</font><font color="#000080">,</font><font color="#800000">'\'</font><font color="#000080">]) </font><font color="#FF0000"><b>then </b></font>disk<font color="#000080">:=</font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]+</font>s<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>lastSlash<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
   begin
      if </b></font><font color="#000080">(</font>disk<font color="#000080">&lt;&gt;</font><font color="#800000">''</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>j<font color="#000080">:=</font><font color="#800000">3 </font><font color="#FF0000"><b>else </b></font>j<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
      </font>path<font color="#000080">:=</font>Copy<font color="#000080">(</font>s<font color="#000080">,</font>j<font color="#000080">,</font>lastSlash<font color="#000080">-</font>j<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">)
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>lastDot <font color="#000080">&gt; </font>lastSlash<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>j<font color="#000080">:=</font>lastDot<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>else </b></font>j<font color="#000080">:=</font>len<font color="#000080">;
   </font>baseName<font color="#000080">:=</font>Copy<font color="#000080">(</font>s<font color="#000080">,</font>lastSlash<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">,</font>j<font color="#000080">-</font>lastSlash<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>lastDot<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>ext<font color="#000080">:=</font>Copy<font color="#000080">(</font>s<font color="#000080">,</font>lastDot<font color="#000080">,</font>len<font color="#000080">-</font>lastDot<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>specifier <font color="#FF0000"><b>and </b></font><font color="#800000">8</font><font color="#000080">) &gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>temp<font color="#000080">:=</font>temp<font color="#000080">+</font>disk<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>specifier <font color="#FF0000"><b>and </b></font><font color="#800000">4</font><font color="#000080">) &gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>temp<font color="#000080">:=</font>temp<font color="#000080">+</font>path<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>specifier <font color="#FF0000"><b>and </b></font><font color="#800000">2</font><font color="#000080">) &gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>temp<font color="#000080">:=</font>temp<font color="#000080">+</font>baseName<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>specifier <font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">) &gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>temp<font color="#000080">:=</font>temp<font color="#000080">+</font>ext<font color="#000080">;

   </font>FNStrip<font color="#000080">:=</font>temp
<font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{FNStrip}

{$ENDIF}
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;End personal lib implementation&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }

</i></font><font color="#FF0000"><b>FUNCTION </b></font>EnvSize<font color="#000080">(</font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>envSizeType<font color="#000080">;
</font><font color="#008000"><i>{ Returns current size of environment segment 'envSeg' NOT INCL 2nd 00.}
</i></font><font color="#FF0000"><b>var </b></font>i<font color="#000080">: </font>envSizeType<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>i<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>Mem<font color="#000080">[</font>envSeg<font color="#000080">:</font>i<font color="#000080">] &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Mem<font color="#000080">[</font>envSeg<font color="#000080">:</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and
      </b></font><font color="#000080">(</font>i<font color="#000080">&lt;</font>MAX_EVAR_BLEN<font color="#000080">) </font><font color="#FF0000"><b>do </b></font>Inc<font color="#000080">(</font>i<font color="#000080">);
   </font>EnvSize<font color="#000080">:=</font>i<font color="#000080">+</font><font color="#800000">1
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{EnvSize}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>MaxEnvSize<font color="#000080">(</font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>envSizeType<font color="#000080">;
</font><font color="#008000"><i>{ Returns maximum size of environment segment 'envSeg' by reading the
  word at offset 03 in its preceding MCB paragraph. }
</i></font><font color="#FF0000"><b>begin
   </b></font>MaxEnvSize<font color="#000080">:=</font>MemW<font color="#000080">[</font>envSeg<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">:</font><font color="#800000">$003</font><font color="#000080">]*</font><font color="#800000">16  </font><font color="#008000"><i>{ size in bytes }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{MaxEnvSize}


</i></font><font color="#FF0000"><b>type </b></font>pType<font color="#000080">=^</font>char<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>IncPtr<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">: </font>pType<font color="#000080">);         </font><font color="#008000"><i>{ Increment evar char pointer }
</i></font><font color="#FF0000"><b>begin
   </b></font>p<font color="#000080">:=</font>Ptr<font color="#000080">(</font>seg<font color="#000080">(</font>p<font color="#000080">^),</font>ofs<font color="#000080">(</font>p<font color="#000080">^)+</font><font color="#800000">1</font><font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>function </b></font>MatchEvar<font color="#000080">(</font>evar<font color="#000080">: </font>evarType<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>p<font color="#000080">: </font>pType<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ Returns true if &quot;evar&quot; matches environment string data exactly (case-
  sensitive). If found, p points to the '=' char after the evar name. }
</i></font><font color="#FF0000"><b>var </b></font>i<font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
   for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>evar<font color="#000080">) </font><font color="#FF0000"><b>do
   begin
      if </b></font>p<font color="#000080">^ &lt;&gt; </font>evar<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>then    </b></font><font color="#008000"><i>{ Mismatch; exit and return false }
      </i></font><font color="#FF0000"><b>begin
         </b></font>MatchEvar<font color="#000080">:=</font>false<font color="#000080">;
         </font>exit
      <font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>IncPtr<font color="#000080">(</font>p<font color="#000080">)               </font><font color="#008000"><i>{ OK so far; increment pointer }
   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>MatchEvar<font color="#000080">:=</font>p<font color="#000080">^=</font><font color="#800000">'='          </font><font color="#008000"><i>{ True if p points to '=' }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{MatchEvar}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>GetEnv<font color="#000080">(</font>evar<font color="#000080">:</font>evarType<font color="#000080">; </font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>evarType<font color="#000080">;
</font><font color="#008000"><i>{ Returns value of environment string 'evar' in the 'envSeg' segment.
  If 'evar' does not exist, returns an empty string. Note that the match
  is case-sensitive in order to accomodate the infamous &quot;windir&quot;
  environment string. }

</i></font><font color="#FF0000"><b>var </b></font>done <font color="#000080">: </font>boolean<font color="#000080">;
    </font>p    <font color="#000080">: </font>pType<font color="#000080">;
    </font>i    <font color="#000080">: </font>integer<font color="#000080">;
    </font>s    <font color="#000080">: </font>evarType<font color="#000080">;

</font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{GetEnv}
   </i></font>p<font color="#000080">:=</font>ptr<font color="#000080">(</font>envSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);                    </font><font color="#008000"><i>{ Point to start of evar block }
   </i></font>i<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>done<font color="#000080">:=</font>false<font color="#000080">; </font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#0</font><font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>p<font color="#000080">^ &lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>and not </b></font>done <font color="#FF0000"><b>do   </b></font><font color="#008000"><i>{ while not EOBlock }
   </i></font><font color="#FF0000"><b>begin
      if </b></font>MatchEvar<font color="#000080">(</font>evar<font color="#000080">,</font>p<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
         </b></font>IncPtr<font color="#000080">(</font>p<font color="#000080">);                          </font><font color="#008000"><i>{ Skip past '=' char }
         </i></font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>p<font color="#000080">^ &lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>i<font color="#000080">&lt;</font>MAX_EVAR_LEN<font color="#000080">) </font><font color="#FF0000"><b>do
         begin                               </b></font><font color="#008000"><i>{ Read chars into s until }
            </i></font>Inc<font color="#000080">(</font>i<font color="#000080">);                          </font><font color="#008000"><i>{ end of ASCIIZ string }
            </i></font>s<font color="#000080">[</font>i<font color="#000080">]:=</font>p<font color="#000080">^;
            </font>IncPtr<font color="#000080">(</font>p<font color="#000080">)
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>chr<font color="#000080">(</font>i<font color="#000080">);              </font><font color="#008000"><i>{ Store string length byte }
         </i></font>done<font color="#000080">:=</font>true                 <font color="#008000"><i>{ Exit condition--we're done! }
      </i></font><font color="#FF0000"><b>end else
      begin
         while </b></font><font color="#000080">(</font>p<font color="#000080">^ &lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>do    </b></font><font color="#008000"><i>{ No match; skip to end of ASCIIZ }
            </i></font>IncPtr<font color="#000080">(</font>p<font color="#000080">);
         </font>IncPtr<font color="#000080">(</font>p<font color="#000080">)                  </font><font color="#008000"><i>{ Advance pointer to next string }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{while}
   </i></font>GetEnv <font color="#000080">:= </font>s
<font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{GetEnv}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>DelEnv<font color="#000080">(</font>evar<font color="#000080">:</font>evarType<font color="#000080">; </font>envSeg<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#008000"><i>{ Removes environment variable 'evar' from environment table at
 'envSeg'. }

</i></font><font color="#FF0000"><b>var </b></font>found     <font color="#000080">: </font>boolean<font color="#000080">;
    </font>p         <font color="#000080">: </font>pType<font color="#000080">;
    </font>i         <font color="#000080">: </font>integer<font color="#000080">;
    </font>s         <font color="#000080">: </font>evarType<font color="#000080">;
    </font>b0<font color="#000080">,</font>b1<font color="#000080">,</font>len <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{DelEnv}
   </i></font>p<font color="#000080">:=</font>ptr<font color="#000080">(</font>envSeg<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);                    </font><font color="#008000"><i>{ Point to start of evar table }
   </i></font>i<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">; </font>found<font color="#000080">:=</font>false<font color="#000080">; </font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#0</font><font color="#000080">;

   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>p<font color="#000080">^ &lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>and not </b></font>found <font color="#FF0000"><b>do
   begin
      if </b></font>MatchEvar<font color="#000080">(</font>evar<font color="#000080">,</font>p<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
         </b></font>b1<font color="#000080">:=</font>ofs<font color="#000080">(</font>p<font color="#000080">^)-</font>length<font color="#000080">(</font>evar<font color="#000080">);  </font><font color="#008000"><i>{ First byte of evar (dest)}
         </i></font><font color="#FF0000"><b>while</b></font><font color="#000080">(</font>p<font color="#000080">^ &lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>do
            </b></font>IncPtr<font color="#000080">(</font>p<font color="#000080">);
         </font>IncPtr<font color="#000080">(</font>p<font color="#000080">);
         </font>b0<font color="#000080">:=</font>ofs<font color="#000080">(</font>p<font color="#000080">^);               </font><font color="#008000"><i>{ Next evar (start) }
         </i></font>len<font color="#000080">:=</font>EnvSize<font color="#000080">(</font>envSeg<font color="#000080">)-</font>b0<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">; </font><font color="#008000"><i>{ Length of region }
         </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>len<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
            </b></font>Move<font color="#000080">(</font>Mem<font color="#000080">[</font>envSeg<font color="#000080">:</font>b0<font color="#000080">],</font>Mem<font color="#000080">[</font>envSeg<font color="#000080">:</font>b1<font color="#000080">],</font>len<font color="#000080">)
         </font><font color="#FF0000"><b>end
         else begin
            </b></font>FillChar<font color="#000080">(</font>Mem<font color="#000080">[</font>envSeg<font color="#000080">:</font>b1<font color="#000080">],</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">)
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
         </font>found<font color="#000080">:=</font>true
      <font color="#FF0000"><b>end else
      begin
         while </b></font><font color="#000080">(</font>p<font color="#000080">^ &lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>do    </b></font><font color="#008000"><i>{ No match; skip to end of ASCIIZ }
            </i></font>IncPtr<font color="#000080">(</font>p<font color="#000080">);
         </font>IncPtr<font color="#000080">(</font>p<font color="#000080">)                  </font><font color="#008000"><i>{ Advance pointer to next string }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{while}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{DelEnv}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>GetFirstMCB<font color="#000080">: </font>word<font color="#000080">;
</font><font color="#008000"><i>{ Get segment address of first MCB using the undocumented DOS
  Interrupt 21/52 Get List of Lists. }
</i></font><font color="#FF0000"><b>var </b></font>r<font color="#000080">: </font>Registers<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>r<font color="#000080">.</font>AH<font color="#000080">:=</font><font color="#800000">$52</font><font color="#000080">;
   </font>MsDos<font color="#000080">(</font>r<font color="#000080">);   </font><font color="#008000"><i>{ Get List of Lists in ES:BX; 1st MCB seg is at [BX-2] }
   </i></font>GetFirstMCB<font color="#000080">:=</font>MemW<font color="#000080">[</font>r<font color="#000080">.</font>ES<font color="#000080">:</font>r<font color="#000080">.</font>BX<font color="#000080">-</font><font color="#800000">2</font><font color="#000080">]
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{GetFirstMCB}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>InitMCBType<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">: </font>MCBType<font color="#000080">);
</font><font color="#008000"><i>{ Resets MCB record data to zero; segment to that of the first MCB }
</i></font><font color="#FF0000"><b>begin
   with </b></font>mcb <font color="#FF0000"><b>do begin
      </b></font>MCB_Seg <font color="#000080">:= </font>GetFirstMCB<font color="#000080">;
      </font>MCB_Ofs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>BlockID <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>OwnerPSP<font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>ParentPSP<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font>BlockSize<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font>OwnerName<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{InitMCBType}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ReadMCB<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">: </font>MCBType<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>last<font color="#000080">, </font>root<font color="#000080">: </font>boolean<font color="#000080">);
</font><font color="#008000"><i>{ Collects info about the MCB pointed to by mcb_seg:mcb_ofs.
  'last' will be true if this is the last MCB in the chain;
  'root' will be true if this MCB's owner is the same as the PSP owner.}

</i></font><font color="#FF0000"><b>var </b></font>p <font color="#000080">: ^</font>MCBType<font color="#000080">;
    </font>i <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{ReadMCB}
   </i></font>p<font color="#000080">:=</font>Ptr<font color="#000080">(</font>seg<font color="#000080">(</font>mcb<font color="#000080">),</font>ofs<font color="#000080">(</font>mcb<font color="#000080">));
   </font><font color="#FF0000"><b>with </b></font>mcb <font color="#FF0000"><b>do
   begin
      </b></font>blockID  <font color="#000080">:= </font>Mem<font color="#000080">[</font>MCB_Seg<font color="#000080">:</font>MCB_Ofs<font color="#000080">];     </font><font color="#008000"><i>{ Block type = 'M' or 'Z' }
      </i></font>p<font color="#000080">^.</font>ownerPSP<font color="#000080">:=</font>MemW<font color="#000080">[</font>MCB_Seg<font color="#000080">:</font>MCB_Ofs<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]; </font><font color="#008000"><i>{ PSP segment of MCB owner }
      </i></font>parentPSP<font color="#000080">:= </font>MemW<font color="#000080">[</font>ownerPSP<font color="#000080">:</font><font color="#800000">$0016</font><font color="#000080">];     </font><font color="#008000"><i>{ Parent/self PSP segment }
      </i></font>blockSize<font color="#000080">:= </font>MemW<font color="#000080">[</font>MCB_Seg<font color="#000080">:</font>MCB_Ofs<font color="#000080">+</font><font color="#800000">3</font><font color="#000080">];  </font><font color="#008000"><i>{ Size of MCB in paragraphs}

      </i></font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">$08 </font><font color="#FF0000"><b>to </b></font><font color="#800000">$0f </font><font color="#FF0000"><b>do </b></font>ownerName<font color="#000080">[</font>i<font color="#000080">-</font><font color="#800000">7</font><font color="#000080">]:=</font>Chr<font color="#000080">(</font>Mem<font color="#000080">[</font>MCB_Seg<font color="#000080">:</font>MCB_Ofs<font color="#000080">+</font>i<font color="#000080">]);
      </font>ownerName<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>chr<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">);            </font><font color="#008000"><i>{ DOS v4.0+ }

      </i></font>last <font color="#000080">:= </font>blockID <font color="#000080">&lt;&gt; </font><font color="#800000">$4D</font><font color="#000080">;          </font><font color="#008000"><i>{ True if this is the last MCB }
      </i></font>root <font color="#000080">:= (</font>parentPSP <font color="#000080">= </font>ownerPSP<font color="#000080">)   </font><font color="#008000"><i>{ True if this is the root MCB }
   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{with}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ReadMCB}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>FindRootEnv<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">: </font>MCBType<font color="#000080">);
</font><font color="#008000"><i>{ Walks the MCB chain until root environment is found (MCB owner =
  parent_id). Returns the segment of that process' environment in the
  MCB record. }

</i></font><font color="#FF0000"><b>var </b></font>last<font color="#000080">,</font>root <font color="#000080">: </font>boolean<font color="#000080">;
    </font>offset    <font color="#000080">: </font>longint<font color="#000080">;
    </font>block     <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>InitMCBType<font color="#000080">(</font>mcb<font color="#000080">);
   </font>block<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>repeat
      </b></font>ReadMCB<font color="#000080">(</font>mcb<font color="#000080">,</font>last<font color="#000080">,</font>root<font color="#000080">);
      </font>Inc<font color="#000080">(</font>block<font color="#000080">);
      </font><font color="#FF0000"><b>if not </b></font>root <font color="#FF0000"><b>then
      begin
        </b></font>offset <font color="#000080">:= </font>mcb<font color="#000080">.</font>MCB_Ofs<font color="#000080">+</font><font color="#800000">16</font><font color="#000080">+(</font>mcb<font color="#000080">.</font>BlockSize<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">);
        </font>mcb<font color="#000080">.</font>MCB_Ofs <font color="#000080">:= </font>offset <font color="#FF0000"><b>mod </b></font><font color="#800000">$10000</font><font color="#000080">;
        </font>mcb<font color="#000080">.</font>MCB_Seg <font color="#000080">:= </font>mcb<font color="#000080">.</font>MCB_Seg <font color="#000080">+ (</font>offset <font color="#FF0000"><b>div </b></font><font color="#800000">$10000</font><font color="#000080">)
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>until </b></font>root <font color="#FF0000"><b>or </b></font><font color="#000080">(</font>block<font color="#000080">&gt;</font><font color="#800000">100</font><font color="#000080">)  </font><font color="#008000"><i>{ Til root found or 100 blocks examined }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{FindRootEnv}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>PutEnv<font color="#000080">(</font>evar<font color="#000080">,</font>value<font color="#000080">: </font>evarType<font color="#000080">; </font>envSeg<font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ Put environment variable 'evar' into environment segment 'envSeg'
  and give it the value 'value'. If 'value' is null, effect is same as
  if DelEnv() was called. Returns true if successful. }

</i></font><font color="#FF0000"><b>var </b></font>len<font color="#000080">, </font>origLen<font color="#000080">, </font>i     <font color="#000080">: </font>integer<font color="#000080">;
    </font>maxSize<font color="#000080">, </font>currentSize<font color="#000080">: </font>envSizeType<font color="#000080">;
    </font>s<font color="#000080">: </font>evarType<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>s<font color="#000080">:=</font>evar<font color="#000080">+</font><font color="#800000">'='</font><font color="#000080">+</font>value<font color="#000080">+</font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)+</font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);   </font><font color="#008000"><i>{ Make evar string }
   </i></font>len<font color="#000080">:=</font>length<font color="#000080">(</font>s<font color="#000080">);                    </font><font color="#008000"><i>{ Length includes terminal 0000 }
   </i></font>origLen<font color="#000080">:=</font>length<font color="#000080">(</font>GetEnv<font color="#000080">(</font>evar<font color="#000080">,</font>envSeg<font color="#000080">))+</font>length<font color="#000080">(</font>evar<font color="#000080">)+</font><font color="#800000">2</font><font color="#000080">;
   </font>currentSize<font color="#000080">:=</font>EnvSize<font color="#000080">(</font>envSeg<font color="#000080">);
   </font>maxSize<font color="#000080">:=</font>MaxEnvSize<font color="#000080">(</font>envSeg<font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>currentSize<font color="#000080">-</font>origLen<font color="#000080">+</font>len <font color="#000080">&gt; </font>maxSize<font color="#000080">) </font><font color="#FF0000"><b>then
   begin
      </b></font>PutEnv<font color="#000080">:=</font>false<font color="#000080">;                </font><font color="#008000"><i>{ Insufficient space }
      </i></font>exit
   <font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>DelEnv<font color="#000080">(</font>evar<font color="#000080">,</font>envSeg<font color="#000080">);             </font><font color="#008000"><i>{ Delete evar if exists }
   </i></font><font color="#FF0000"><b>if </b></font>value<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]=</font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin    </b></font><font color="#008000"><i>{ Empty evar value string }
      </i></font>PutEnv<font color="#000080">:=</font>true<font color="#000080">;                 </font><font color="#008000"><i>{ Same as calling DelEnv() }
      </i></font>exit
   <font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>currentSize<font color="#000080">:=</font>EnvSize<font color="#000080">(</font>envSeg<font color="#000080">);

   </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>length<font color="#000080">(</font>s<font color="#000080">) </font><font color="#FF0000"><b>do      </b></font><font color="#008000"><i>{ Write string to environment }
      </i></font>Mem<font color="#000080">[</font>envSeg<font color="#000080">:</font>currentSize<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">+</font>i<font color="#000080">] :=</font>ord<font color="#000080">(</font>s<font color="#000080">[</font>i<font color="#000080">]);
   </font>PutEnv<font color="#000080">:=</font>true
<font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{PutEnv}


</i></font><font color="#FF0000"><b>function </b></font>GetProgramName<font color="#000080">: </font>fileSpecType<font color="#000080">;
</font><font color="#008000"><i>{ Returns fully-qualified filespec of the currently-executing program.
  This function should be called before any PutEnv() operations.
  Req. DOS v3.0+ }

</i></font><font color="#FF0000"><b>var </b></font>envSeg<font color="#000080">: </font>word<font color="#000080">;
    </font>p<font color="#000080">: ^</font>char<font color="#000080">;
    </font>i<font color="#000080">: </font>integer<font color="#000080">;
    </font>s<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>envSeg<font color="#000080">:=</font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$002C</font><font color="#000080">];    </font><font color="#008000"><i>{ PSP:002C == environment segment }
   </i></font>p<font color="#000080">:=</font>Ptr<font color="#000080">(</font>envSeg<font color="#000080">,</font>EnvSize<font color="#000080">(</font>envSeg<font color="#000080">)+</font><font color="#800000">3</font><font color="#000080">); </font><font color="#008000"><i>{ Points to 1st char of filename }
   </i></font>i<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;                             
   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font>p<font color="#000080">^ &lt;&gt; </font>chr<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>i<font color="#000080">&lt;</font>MAXPATHLEN<font color="#000080">) </font><font color="#FF0000"><b>do   </b></font><font color="#008000"><i>{ Read filename chars }
   </i></font><font color="#FF0000"><b>begin
      </b></font>Inc<font color="#000080">(</font>i<font color="#000080">);
      </font>s<font color="#000080">[</font>i<font color="#000080">]:=</font>p<font color="#000080">^;
      </font>p<font color="#000080">:=</font>Ptr<font color="#000080">(</font>seg<font color="#000080">(</font>p<font color="#000080">^),</font>ofs<font color="#000080">(</font>p<font color="#000080">^)+</font><font color="#800000">1</font><font color="#000080">)
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font>chr<font color="#000080">(</font>i<font color="#000080">);
   </font>GetProgramName<font color="#000080">:=</font>s
<font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{GetProgramName}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>AllocateBlock<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>blockSize<font color="#000080">: </font>longint<font color="#000080">;
                       </font><font color="#FF0000"><b>var </b></font>segment<font color="#000080">: </font>word<font color="#000080">);
</font><font color="#008000"><i>{ Allocates 'blockSize' bytes (rounded up to nearest paragraph) of
  memory. If there is insufficient free memory available, ALL free
  memory will be appropriated. The returned value 'segment' will be the
  initial segment of the allocated block. }

</i></font><font color="#FF0000"><b>var </b></font>regs<font color="#000080">: </font>Registers<font color="#000080">;
    </font>para<font color="#000080">: </font>longint<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>para <font color="#000080">:= </font>blockSize <font color="#FF0000"><b>div </b></font><font color="#800000">16</font><font color="#000080">;     </font><font color="#008000"><i>{ Requested paragraphs of memory }
   </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>blockSize <font color="#FF0000"><b>mod </b></font><font color="#800000">16</font><font color="#000080">) &gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>para<font color="#000080">:=</font>para<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>with </b></font>regs <font color="#FF0000"><b>do
   begin
      </b></font>AH <font color="#000080">:= </font><font color="#800000">$48</font><font color="#000080">;    </font><font color="#008000"><i>{ Int 21/48 - Allocate Memory  }
      </i></font>BX <font color="#000080">:= </font>para<font color="#000080">;   </font><font color="#008000"><i>{ Returns NC if ok, AX=segment; otherwise CY }
      </i></font>MsDos<font color="#000080">(</font>regs<font color="#000080">);  </font><font color="#008000"><i>{ If CY, AX=7 MCB destroyed, 8=insuff memory }
      </i></font>para<font color="#000080">:=</font>BX<font color="#000080">;     </font><font color="#008000"><i>{ BX=largest available block }
      </i></font>blockSize<font color="#000080">:=</font>para<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">;   </font><font color="#008000"><i>{ Return adjusted block size in bytes }
      </i></font><font color="#FF0000"><b>if </b></font>Flags <font color="#FF0000"><b>and </b></font>FCarry <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then  </b></font><font color="#008000"><i>{ Allocation error }
         </i></font>AllocateBlock<font color="#000080">(</font>blockSize<font color="#000080">,</font>segment<font color="#000080">)
      </font><font color="#FF0000"><b>else
      begin
         </b></font>segment<font color="#000080">:=</font>AX    <font color="#008000"><i>{ Segment of allocated memory block }
      </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{AllocateBlock}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>DeallocateBlock<font color="#000080">(</font>segment<font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#008000"><i>{ Releases a block of memory reserved by Int 21/48 to the DOS pool.
  Returns true if no error. }

</i></font><font color="#FF0000"><b>var </b></font>regs<font color="#000080">: </font>Registers<font color="#000080">;

</font><font color="#FF0000"><b>begin
   with </b></font>regs <font color="#FF0000"><b>do
   begin
      </b></font>AH <font color="#000080">:= </font><font color="#800000">$49</font><font color="#000080">;      </font><font color="#008000"><i>{ Int 21/49 - Release Memory  }
      </i></font>ES <font color="#000080">:= </font>segment<font color="#000080">;  </font><font color="#008000"><i>{ Returns NC if ok, otherwise CY set and   }
      </i></font>MsDos<font color="#000080">(</font>regs<font color="#000080">);    </font><font color="#008000"><i>{ AX=7 MCB destroyed, 9=invalid MCB address }
   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>DeallocateBlock<font color="#000080">:=</font><font color="#FF0000"><b>not </b></font><font color="#000080">(</font>regs<font color="#000080">.</font>Flags <font color="#FF0000"><b>and </b></font>FCarry <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{DeallocateBlock}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>Shell<font color="#000080">(</font>prompt<font color="#000080">: </font>evarType<font color="#000080">): </font>integer<font color="#000080">;
</font><font color="#008000"><i>{ Invokes an OS command shell with custom prompt string.  In order to
  make enough room for a custom prompt evar, a new environment block for
  this process is created, assigned to the current PSP, and is then
  inherited by the child COMSPEC process.  If the prompt is null, the
  default prompt &quot;[progname] $p$g&quot; will be used.

  Returns the DOS error code from the Exec function:

              0 = No error
              2 = File not found
              3 = Path not found
              5 = Access denied
              6 = Invalid handle
              8 = Not enough memory
             10 = Invalid environment
             11 = Invalid format
             18 = No more files
}
</i></font><font color="#FF0000"><b>var </b></font>ShellEnvSeg        <font color="#000080">: </font>word<font color="#000080">;
    </font>len                <font color="#000080">: </font>envSizeType<font color="#000080">;
    </font>bytesRequested     <font color="#000080">: </font>longint<font color="#000080">;
    </font>rcode              <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
   if </b></font>prompt<font color="#000080">=</font><font color="#800000">'' </font><font color="#FF0000"><b>then
      </b></font>prompt<font color="#000080">:=</font><font color="#800000">'['</font><font color="#000080">+</font>FNStrip<font color="#000080">(</font>PROGRAMNAME<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">)+</font><font color="#800000">'] ' </font><font color="#000080">+
         </font>GetEnv<font color="#000080">(</font><font color="#800000">'PROMPT'</font><font color="#000080">,</font>CURRENT_ENVSEG<font color="#000080">);
   </font>ShellEnvSeg<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>COMSPEC<font color="#000080">&lt;&gt;</font><font color="#800000">'' </font><font color="#FF0000"><b>then
   begin
      </b></font>len <font color="#000080">:= </font>EnvSize<font color="#000080">(</font>CURRENT_ENVSEG<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">;
      </font>bytesRequested <font color="#000080">:= </font>len <font color="#000080">+ </font>Length<font color="#000080">(</font>prompt<font color="#000080">)+</font><font color="#800000">8</font><font color="#000080">;
      </font>AllocateBlock<font color="#000080">(</font>bytesRequested<font color="#000080">,</font>ShellEnvSeg<font color="#000080">);
      </font>Move<font color="#000080">(</font>Mem<font color="#000080">[</font>CURRENT_ENVSEG<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">], </font>Mem<font color="#000080">[</font>ShellEnvSeg<font color="#000080">:</font><font color="#800000">0</font><font color="#000080">], </font>len<font color="#000080">);
      </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$002c</font><font color="#000080">] := </font>ShellEnvSeg<font color="#000080">;
      </font><font color="#FF0000"><b>if not </b></font>PutEnv<font color="#000080">(</font><font color="#800000">'PROMPT'</font><font color="#000080">,</font>prompt<font color="#000080">,</font>ShellEnvSeg<font color="#000080">) </font><font color="#FF0000"><b>then
         </b></font>writeln<font color="#000080">(</font><font color="#800000">#10#13#7'*** Insufficient environment space '</font><font color="#000080">,
            </font><font color="#800000">'for custom prompt!'</font><font color="#000080">);

      </font>writeln<font color="#000080">;
               </font><font color="#008000"><i>{  Yes, this is ugly.  Sorry. :-) }
</i></font>writeln<font color="#000080">(
</font><font color="#800000">'&Eacute;&Iacute;&Iacute;&micro; DOS Shell &AElig;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&raquo;'</font><font color="#000080">);
</font>writeln<font color="#000080">(
</font><font color="#800000">'&ordm;                                                                    &ordm;'</font><font color="#000080">);
</font>writeln<font color="#000080">(
</font><font color="#800000">'&ordm;    You are in a temporary DOS Shell.  Do not load any resident     &ordm;'</font><font color="#000080">);
</font>writeln<font color="#000080">(
</font><font color="#800000">'&ordm;   programs (such as PRINT or DOSKEY) while you are in this shell.  &ordm;'</font><font color="#000080">);
</font>writeln<font color="#000080">(
</font><font color="#800000">'&ordm;                                                                    &ordm;'</font><font color="#000080">);
</font>writeln<font color="#000080">(
</font><font color="#800000">'&ordm;       When done, type EXIT&Ugrave; to return to your application.        &ordm;'</font><font color="#000080">);
</font>writeln<font color="#000080">(
</font><font color="#800000">'&ordm;                                                                    &ordm;'</font><font color="#000080">);
</font>writeln<font color="#000080">(
</font><font color="#800000">'&Egrave;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&Iacute;&frac14;'</font><font color="#000080">);

      </font>Exec<font color="#000080">(</font>COMSPEC<font color="#000080">,</font><font color="#800000">''</font><font color="#000080">); </font>rcode<font color="#000080">:=</font>DosError<font color="#000080">;       </font><font color="#008000"><i>{ Needs 64k to load }
      </i></font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$002C</font><font color="#000080">]:=</font>CURRENT_ENVSEG<font color="#000080">;   </font><font color="#008000"><i>{ Restore original env }

      </i></font><font color="#FF0000"><b>if not </b></font>DeAllocateBlock<font color="#000080">(</font>ShellEnvSeg<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
         </b></font>writeln<font color="#000080">(</font><font color="#800000">#7'*** Memory deallocation problem. Aborting....'</font><font color="#000080">);
         </font>halt<font color="#000080">(</font><font color="#800000">7</font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{if comspec}
   </i></font><font color="#FF0000"><b>else </b></font>rcode<font color="#000080">:=-</font><font color="#800000">1</font><font color="#000080">;
   </font>Shell<font color="#000080">:=</font>rcode
<font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Shell}
{ &Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml;&Auml; }
{
   Initialize public variables:

      MASTER_MCB        Root memory control block record
      MASTER_ENVSEG     Segment of master environment block
      CURRENT_ENVSEG    Segment of current process' environment block
      COMSPEC           String set to value of &quot;COMSPEC&quot; evar.
      PROGRAMNAME       Fully-qualified name of executing program.
}
</i></font><font color="#FF0000"><b>BEGIN
   </b></font>FindRootEnv<font color="#000080">(</font>MASTER_MCB<font color="#000080">);
   </font>MASTER_ENVSEG <font color="#000080">:= </font>MemW<font color="#000080">[</font>MASTER_MCB<font color="#000080">.</font>OwnerPSP<font color="#000080">:</font><font color="#800000">$002c</font><font color="#000080">];
   </font>CURRENT_ENVSEG <font color="#000080">:= </font>MemW<font color="#000080">[</font>PrefixSeg<font color="#000080">:</font><font color="#800000">$002C</font><font color="#000080">];
   </font>COMSPEC<font color="#000080">:=</font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">,</font>MASTER_ENVSEG<font color="#000080">);
   </font>PROGRAMNAME <font color="#000080">:= </font>GetProgramName
<font color="#FF0000"><b>END</b></font><font color="#000080">. </font><font color="#008000"><i>{unit}

{ -------------------------  DEMO ---------------------- }

(***********************************************************************
   Walk Memory Control Block chain                Version 1.00

   Demonstration of Environ.TPU (and other stuff too, I guess).
   Written Jan 17 1996 Robert B. Clark &lt;rclark@iquest.net&gt;

   Donated to the public domain; inclusion in SWAG freely permitted.

   Usage: WALKMCB [evar] [new_value]
   =================================
   If 'evar' is not specified, WALKMCB simply demonstrates how to walk
   the MCB chain.

   If 'evar' _is_ specified, WALKMCB displays the master environment
   value of 'evar' and sets the current value of 'evar' to 'new_value.'
   It then demonstrates the shell to DOS function Shell() so that you
   may verify the changed environment variable by typing SET at the
   shelled command line.

   Note that the 'evar' argument IS case-sensitive, to accomodate the
   infamous &quot;windir&quot; evar Microsoft foisted upon us.
   ********************************************************************)

</i></font><font color="#FF0000"><b>Program </b></font>WalkMCB<font color="#000080">;

</font><font color="#008000"><i>{$M 8096,0,1024}          { Stack, min heap, max heap}
{$DEFINE DispMCB}         { Display MCBs while walking }

</i></font><font color="#FF0000"><b>Uses </b></font>Dos<font color="#000080">, </font>Environ         <font color="#008000"><i>{ FOUND IN DOS.SWG ! }
{$IFDEF UseLib}   </i></font><font color="#000080">,</font>Convert<font color="#000080">,</font>Global   <font color="#008000"><i>{ Hex conversions, various }
{$ELSE}           </i></font><font color="#000080">,</font>Crt
<font color="#008000"><i>{$ENDIF}          </i></font><font color="#000080">;

</font><font color="#FF0000"><b>CONST  </b></font>CREDIT      <font color="#000080">= </font><font color="#800000">' v1.00 Written Jan 17 1996 Robert B. Clark'</font><font color="#000080">;
</font><font color="#008000"><i>(**********************************************************************)
{$IFNDEF UseLib}     { Selected functions from personal units }

(* KeyBd.TPU *)

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ClearKeybd<font color="#000080">;
</font><font color="#FF0000"><b>inline</b></font><font color="#000080">(</font><font color="#800000">$FA</font><font color="#000080">/             </font><font color="#008000"><i>{ cli               ; Disable interrupts     }
       </i></font><font color="#800000">$33</font><font color="#000080">/</font><font color="#800000">$C0</font><font color="#000080">/         </font><font color="#008000"><i>{ xor ax,ax         ; Head/tail keybuf ptrs  }
       </i></font><font color="#800000">$8E</font><font color="#000080">/</font><font color="#800000">$C0</font><font color="#000080">/         </font><font color="#008000"><i>{ mov es,ax         ; at 40:001A and 40:001C }
       </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$A0</font><font color="#000080">/</font><font color="#800000">$1A</font><font color="#000080">/</font><font color="#800000">$04</font><font color="#000080">/ </font><font color="#008000"><i>{ es mov al,b[041a] ; Head ptr in AL         }
       </i></font><font color="#800000">$26</font><font color="#000080">/</font><font color="#800000">$A2</font><font color="#000080">/</font><font color="#800000">$1C</font><font color="#000080">/</font><font color="#800000">$04</font><font color="#000080">/ </font><font color="#008000"><i>{ es mov b[041c],al ; Now tail=head          }
       </i></font><font color="#800000">$FB</font><font color="#000080">);            </font><font color="#008000"><i>{ sti               ; Reenable interrupts    }
{ClearKeybd}

(* Convert.TPU *)

</i></font><font color="#FF0000"><b>FUNCTION </b></font>HexByte<font color="#000080">(</font>b<font color="#000080">:</font>byte<font color="#000080">):</font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Converts decimal to hexadecimal byte string }
</i></font><font color="#FF0000"><b>const </b></font>hexDigits<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#000080">= </font><font color="#800000">'0123456789ABCDEF'</font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>HexByte<font color="#000080">:=</font>hexDigits<font color="#000080">[</font>b <font color="#FF0000"><b>shr </b></font><font color="#800000">4</font><font color="#000080">] + </font>hexDigits<font color="#000080">[</font>b <font color="#FF0000"><b>and </b></font><font color="#800000">$F</font><font color="#000080">]
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{HexByte}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>HexWord<font color="#000080">(</font>w<font color="#000080">:</font>word<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Converts decimal to hexadecimal word string }
</i></font><font color="#FF0000"><b>begin
  </b></font>HexWord<font color="#000080">:=</font>HexByte<font color="#000080">(</font>hi<font color="#000080">(</font>w<font color="#000080">)) + </font>HexByte<font color="#000080">(</font>lo<font color="#000080">(</font>w<font color="#000080">))
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{HexWord}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>HexDWord<font color="#000080">(</font>w<font color="#000080">:</font>longint<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#008000"><i>{ Converts decimal to hexadecimal doubleword string. }
</i></font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>w<font color="#000080">&lt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>w<font color="#000080">:=</font>w<font color="#000080">-</font><font color="#800000">$10000</font><font color="#000080">;
  </font>HexDWord<font color="#000080">:=</font>HexWord<font color="#000080">(</font>w <font color="#FF0000"><b>div </b></font><font color="#800000">65536</font><font color="#000080">)  + </font>HexWord<font color="#000080">(</font>w <font color="#FF0000"><b>mod </b></font><font color="#800000">65536</font><font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{HexDWord}

(* Global.TPU *)

</i></font><font color="#FF0000"><b>PROCEDURE </b></font>SetRedirect<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>infile<font color="#000080">,</font>outfile<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#008000"><i>{ Sets Input/Output to DOS STDIN/OUT routines. }
</i></font><font color="#FF0000"><b>begin
   </b></font>Assign<font color="#000080">(</font>Output<font color="#000080">,</font>outFile<font color="#000080">);        </font><font color="#008000"><i>{ Set up for STDOUT output }
   </i></font>Rewrite<font color="#000080">(</font>Output<font color="#000080">);
   </font>Assign<font color="#000080">(</font>Input<font color="#000080">,</font>inFile<font color="#000080">);          </font><font color="#008000"><i>{ Set up for STDIN input }
   </i></font>Reset<font color="#000080">(</font>Input<font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{SetRedirect}


</i></font><font color="#FF0000"><b>FUNCTION </b></font>CurSize<font color="#000080">:</font>word<font color="#000080">;
</font><font color="#008000"><i>{ Returns current size of cursor. The high byte is the beginning scan
  line; the low byte is the ending scan line. }
</i></font><font color="#FF0000"><b>var </b></font>regs<font color="#000080">: </font>Registers<font color="#000080">;

</font><font color="#FF0000"><b>begin
   with </b></font>regs <font color="#FF0000"><b>do           </b></font><font color="#008000"><i>{ Get current cursor size }
   </i></font><font color="#FF0000"><b>begin
      </b></font>AH<font color="#000080">:=</font><font color="#800000">$03</font><font color="#000080">;            </font><font color="#008000"><i>{ Want BIOS Int 10h/3, Read Cursor Pos/Size }
      </i></font>BH<font color="#000080">:=</font><font color="#800000">$00</font><font color="#000080">;            </font><font color="#008000"><i>{ Video page number }
      </i></font>Intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>regs<font color="#000080">);     </font><font color="#008000"><i>{ BH=page #, CX=beg/end scan line, DX=row/col}
      </i></font>CurSize<font color="#000080">:=</font>CX
   <font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{CurSize}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>Cursor_OnOff<font color="#000080">(</font><font color="#FF0000"><b>on</b></font><font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#008000"><i>{ Toggles the cursor on and off. }
</i></font><font color="#FF0000"><b>var </b></font>regs<font color="#000080">: </font>Registers<font color="#000080">;
    </font>sbeg<font color="#000080">:</font>byte<font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>sbeg<font color="#000080">:=</font>hi<font color="#000080">(</font>CurSize<font color="#000080">);                 </font><font color="#008000"><i>{ Get starting scan row }
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font><font color="#FF0000"><b>on</b></font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>sbeg<font color="#000080">:=</font>sbeg <font color="#FF0000"><b>and </b></font><font color="#800000">$df    </font><font color="#008000"><i>{ Toggle bit 5 }
  </i></font><font color="#FF0000"><b>else </b></font>sbeg<font color="#000080">:=</font>sbeg <font color="#FF0000"><b>or </b></font><font color="#800000">$20</font><font color="#000080">;

  </font><font color="#FF0000"><b>with </b></font>regs <font color="#FF0000"><b>do
  begin
    </b></font>AH<font color="#000080">:=</font><font color="#800000">$01</font><font color="#000080">;                  </font><font color="#008000"><i>{ Want BIOS Int 10h/1 Set cursor size }
    </i></font>CH<font color="#000080">:=</font>sbeg<font color="#000080">;                 </font><font color="#008000"><i>{ Beginning cursor scan line }
    </i></font>CL<font color="#000080">:=</font>lo<font color="#000080">(</font>CurSize<font color="#000080">);          </font><font color="#008000"><i>{ Ending cursor scan line }
    </i></font>Intr<font color="#000080">(</font><font color="#800000">$10</font><font color="#000080">,</font>regs<font color="#000080">)
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Cursor_OnOff}


</i></font><font color="#FF0000"><b>PROCEDURE </b></font>Pause<font color="#000080">;
</font><font color="#008000"><i>{ Simply waits for the user to press [Enter] while displaying a
  spinning cursor. Invalid keypresses cause a tone to sound.
  The keyboard buffer is cleared upon entry and exit. }

   </i></font><font color="#FF0000"><b>procedure </b></font>Tone<font color="#000080">(</font>hz<font color="#000080">,</font>duration<font color="#000080">:</font>word<font color="#000080">);
   </font><font color="#008000"><i>{ Produces tone at 'hz' frequency and of 'duration' ms }
   </i></font><font color="#FF0000"><b>begin
      </b></font>Sound<font color="#000080">(</font>hz<font color="#000080">); </font>Delay<font color="#000080">(</font>duration<font color="#000080">); </font>NoSound
   <font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Tone}

</i></font><font color="#FF0000"><b>const </b></font>cursor<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char <font color="#000080">= </font><font color="#800000">'-\|/-\|'</font><font color="#000080">;
</font><font color="#FF0000"><b>var   </b></font>okChar<font color="#000080">: </font>boolean<font color="#000080">;
           </font>c<font color="#000080">: </font>char<font color="#000080">;
       </font>i<font color="#000080">,</font>x<font color="#000080">,</font>y<font color="#000080">: </font>shortint<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>Cursor_OnOff<font color="#000080">(</font>false<font color="#000080">);
   </font>write<font color="#000080">(</font><font color="#800000">#10#13'Press Enter'#17#217' to continue... '</font><font color="#000080">);
   </font>x<font color="#000080">:=</font>WhereX<font color="#000080">; </font>y<font color="#000080">:=</font>WhereY<font color="#000080">;
   </font>ClearKeybd<font color="#000080">; </font>okChar<font color="#000080">:=</font>false<font color="#000080">;
   </font><font color="#FF0000"><b>repeat
      </b></font>inc<font color="#000080">(</font>i<font color="#000080">); </font>i<font color="#000080">:=</font>i <font color="#FF0000"><b>mod </b></font><font color="#800000">7</font><font color="#000080">;
      </font>write<font color="#000080">(</font>cursor<font color="#000080">[</font>i<font color="#000080">]); </font>gotoxy<font color="#000080">(</font>x<font color="#000080">,</font>y<font color="#000080">);
      </font>Delay<font color="#000080">(</font><font color="#800000">55</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>KeyPressed <font color="#FF0000"><b>then
      begin
         </b></font>c<font color="#000080">:=</font>ReadKey<font color="#000080">; </font><font color="#FF0000"><b>if </b></font>c<font color="#000080">=</font><font color="#800000">#0 </font><font color="#FF0000"><b>then </b></font>c<font color="#000080">:=</font>ReadKey<font color="#000080">;  </font><font color="#008000"><i>{ Toss extended byte }
         </i></font><font color="#FF0000"><b>if </b></font>c<font color="#000080">=</font>chr<font color="#000080">(</font><font color="#800000">13</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>okChar<font color="#000080">:=</font>true
         <font color="#FF0000"><b>else </b></font>Tone<font color="#000080">(</font><font color="#800000">2000</font><font color="#000080">,</font><font color="#800000">100</font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>until </b></font>okChar<font color="#000080">;
   </font>gotoxy<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>y<font color="#000080">); </font>ClrEol<font color="#000080">; </font>gotoXY<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font>y<font color="#000080">);
   </font>ClearKeybd<font color="#000080">; </font>Cursor_OnOff<font color="#000080">(</font>true<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Pause}

{$ENDIF}  (* End of unit functions from personal libs *)

(* ******************************************************************* *)
</i></font><font color="#FF0000"><b>procedure </b></font>DisplayMCB<font color="#000080">(</font>mcb<font color="#000080">: </font>MCBType<font color="#000080">; </font>block_num<font color="#000080">: </font>integer<font color="#000080">);
</font><font color="#FF0000"><b>begin
   with </b></font>mcb <font color="#FF0000"><b>do
   begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'MCB Block #'</font><font color="#000080">,</font>block_num<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">': Address '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>MCB_Seg<font color="#000080">),
         </font><font color="#800000">':'</font><font color="#000080">, </font>HexWord<font color="#000080">(</font>MCB_Ofs<font color="#000080">), </font><font color="#800000">'   Absolute: '</font><font color="#000080">,
         </font>HexDWord<font color="#000080">(</font>MCB_Seg<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">+</font>MCB_Ofs<font color="#000080">));
      </font>write<font color="#000080">(</font><font color="#800000">'   Block Type    : '</font><font color="#000080">,</font>HexByte<font color="#000080">(</font>blockID<font color="#000080">),</font><font color="#800000">'   ('</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>blockID<font color="#000080">&lt;&gt;</font><font color="#800000">$4D</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>blockID<font color="#000080">&lt;&gt;</font><font color="#800000">$5A</font><font color="#000080">) </font><font color="#FF0000"><b>then
         </b></font>writeln<font color="#000080">(</font><font color="#800000">'ERROR)'</font><font color="#000080">)
      </font><font color="#FF0000"><b>else
         </b></font>writeln<font color="#000080">(</font>chr<font color="#000080">(</font>blockID<font color="#000080">),</font><font color="#800000">')'</font><font color="#000080">);
      </font>write<font color="#000080">(</font><font color="#800000">'   PSP of Owner  : '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>ownerPSP<font color="#000080">));
      </font><font color="#FF0000"><b>if </b></font>ownerPSP<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then      </b></font>write<font color="#000080">(</font><font color="#800000">' (free)'</font><font color="#000080">)
      </font><font color="#FF0000"><b>else if </b></font>ownerPSP<font color="#000080">=</font><font color="#800000">8 </font><font color="#FF0000"><b>then </b></font>write<font color="#000080">(</font><font color="#800000">' (DOS) '</font><font color="#000080">)
      </font><font color="#FF0000"><b>else </b></font>write<font color="#000080">(</font><font color="#800000">'       '</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">' Owner: '</font><font color="#000080">,</font>ownerName<font color="#000080">);   </font><font color="#008000"><i>{ Garbage if DOS &lt;4.0 }
      </i></font>writeln<font color="#000080">(</font><font color="#800000">'   PSP PARENT_ID : '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>parentPSP<font color="#000080">));
      </font>writeln<font color="#000080">(</font><font color="#800000">'   ENVSEG        : '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>MemW<font color="#000080">[</font>ownerPSP<font color="#000080">:</font><font color="#800000">$002c</font><font color="#000080">]));
      </font>writeln<font color="#000080">(</font><font color="#800000">'   Size of MCB   : '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>blockSize<font color="#000080">),</font><font color="#800000">' paragraphs ('</font><font color="#000080">,
         </font>blockSize<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">,</font><font color="#800000">' bytes).'</font><font color="#000080">);
      </font>writeln
   <font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{DisplayMCB}


</i></font><font color="#FF0000"><b>procedure </b></font>WalkChain<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>mcb<font color="#000080">: </font>MCBType<font color="#000080">);
</font><font color="#008000"><i>{ Walks the MCB chain until block type is no longer 4D (M).}
</i></font><font color="#FF0000"><b>var </b></font>last<font color="#000080">,</font>root <font color="#000080">: </font>boolean<font color="#000080">;
    </font>offset    <font color="#000080">: </font>longint<font color="#000080">;
    </font>block     <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>InitMCBType<font color="#000080">(</font>mcb<font color="#000080">);
   </font>block<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>repeat
      </b></font>ReadMCB<font color="#000080">(</font>mcb<font color="#000080">,</font>last<font color="#000080">,</font>root<font color="#000080">);
      </font>Inc<font color="#000080">(</font>block<font color="#000080">);
</font><font color="#008000"><i>{$IFDEF DispMCB}
      </i></font>DisplayMCB<font color="#000080">(</font>mcb<font color="#000080">,</font>block<font color="#000080">);
</font><font color="#008000"><i>{$ENDIF}
      </i></font><font color="#FF0000"><b>if not </b></font>last <font color="#FF0000"><b>then
      begin
         </b></font>offset <font color="#000080">:= </font>mcb<font color="#000080">.</font>MCB_Ofs<font color="#000080">+</font><font color="#800000">16</font><font color="#000080">+(</font>mcb<font color="#000080">.</font>BlockSize<font color="#000080">*</font><font color="#800000">16</font><font color="#000080">);
         </font>mcb<font color="#000080">.</font>MCB_Ofs <font color="#000080">:= </font>offset <font color="#FF0000"><b>mod </b></font><font color="#800000">$10000</font><font color="#000080">;
         </font>mcb<font color="#000080">.</font>MCB_Seg <font color="#000080">:= </font>mcb<font color="#000080">.</font>MCB_Seg <font color="#000080">+ (</font>offset <font color="#FF0000"><b>div </b></font><font color="#800000">$10000</font><font color="#000080">)
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>until </b></font>last
<font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{WalkChain}


</i></font><font color="#FF0000"><b>procedure </b></font>Header<font color="#000080">(</font>walk<font color="#000080">:</font>boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>writeln<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>walk <font color="#FF0000"><b>then
   begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'WALK MEMORY CONTROL BLOCK CHAIN'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'==============================='</font><font color="#000080">)
   </font><font color="#FF0000"><b>end
   else begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'ENVIRONMENT MANIPULATION AND THE DOS SHELL'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'==========================================='</font><font color="#000080">)
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>writeln<font color="#000080">(</font><font color="#800000">'Current PSP (PrefixSeg) is '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>PrefixSeg<font color="#000080">));
   </font>writeln<font color="#000080">(</font><font color="#800000">'The parent PSP segment  is '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>MemW<font color="#000080">[</font>prefixSeg<font color="#000080">:</font><font color="#800000">$0016</font><font color="#000080">]));
   </font>writeln<font color="#000080">(</font><font color="#800000">'The environment segment is '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>CURRENT_ENVSEG<font color="#000080">));
   </font>writeln<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{Header}


</i></font><font color="#FF0000"><b>procedure </b></font>GetParms<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>p1<font color="#000080">,</font>p2<font color="#000080">: </font>evarType<font color="#000080">);
</font><font color="#008000"><i>{ Get command line parameters 1 and 2 }
</i></font><font color="#FF0000"><b>var </b></font>i<font color="#000080">:</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>p1<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">; </font>p2<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
   </font>p1<font color="#000080">:=</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
   </font>i<font color="#000080">:=</font><font color="#800000">2</font><font color="#000080">;
   </font><font color="#FF0000"><b>while </b></font>ParamStr<font color="#000080">(</font>i<font color="#000080">) &lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>do    </b></font><font color="#008000"><i>{ Param 2 is concatenated p2, p3, ... }
   </i></font><font color="#FF0000"><b>begin
      </b></font>p2<font color="#000080">:=</font>p2 <font color="#000080">+ </font>ParamStr<font color="#000080">(</font>i<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>ParamStr<font color="#000080">(</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">) &lt;&gt; </font><font color="#800000">'' </font><font color="#FF0000"><b>then </b></font>p2<font color="#000080">:=</font>p2<font color="#000080">+</font><font color="#800000">' '</font><font color="#000080">;
      </font>Inc<font color="#000080">(</font>i<font color="#000080">)
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#008000"><i>(**************************************************************************)
</i></font><font color="#FF0000"><b>var
    </b></font>mcb <font color="#000080">: </font>MCBType<font color="#000080">;
    </font>walk<font color="#000080">: </font>boolean<font color="#000080">;
    </font>x   <font color="#000080">: </font>integer<font color="#000080">;
    </font>evar<font color="#000080">,</font>value<font color="#000080">: </font>evarType<font color="#000080">;
    </font>prompt<font color="#000080">: </font>evarType<font color="#000080">;
    </font>infile<font color="#000080">,</font>outfile<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin </b></font><font color="#008000"><i>{main}
   </i></font>infile<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">; </font>outfile<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
   </font>SetRedirect<font color="#000080">(</font>infile<font color="#000080">,</font>outfile<font color="#000080">);  </font><font color="#008000"><i>{ Use STDIN/OUT }
   </i></font>GetParms<font color="#000080">(</font>evar<font color="#000080">,</font>value<font color="#000080">);
   </font>prompt<font color="#000080">:=</font><font color="#800000">'$e[1m['</font><font color="#000080">+</font>FNStrip<font color="#000080">(</font>PROGRAMNAME<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">)+</font><font color="#800000">'] $e[0m$p$g'</font><font color="#000080">;
   </font>walk<font color="#000080">:=</font>evar<font color="#000080">=</font><font color="#800000">''</font><font color="#000080">;
   </font>Header<font color="#000080">(</font>walk<font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font>walk <font color="#FF0000"><b>then
   begin
      </b></font>WalkChain<font color="#000080">(</font>mcb<font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'The last MCB in the chain is at '</font><font color="#000080">,
         </font>HexWord<font color="#000080">(</font>mcb<font color="#000080">.</font>MCB_Seg<font color="#000080">),</font><font color="#800000">':'</font><font color="#000080">, </font>HexWord<font color="#000080">(</font>mcb<font color="#000080">.</font>MCB_Ofs<font color="#000080">),</font><font color="#800000">'.'</font><font color="#000080">);
   </font><font color="#FF0000"><b>end
   else begin
      </b></font>writeln<font color="#000080">(</font><font color="#800000">'The master (root) Memory Control Block is at '</font><font color="#000080">,
         </font>HexWord<font color="#000080">(</font>MASTER_MCB<font color="#000080">.</font>MCB_Seg<font color="#000080">),</font><font color="#800000">':'</font><font color="#000080">,
         </font>HexWord<font color="#000080">(</font>MASTER_MCB<font color="#000080">.</font>MCB_Ofs<font color="#000080">),</font><font color="#800000">'.'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'The root environment is at '</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>MASTER_ENVSEG<font color="#000080">),
         </font><font color="#800000">':0000 and its maximum size is '</font><font color="#000080">,</font>MaxEnvSize<font color="#000080">(</font>MASTER_ENVSEG<font color="#000080">),
         </font><font color="#800000">' bytes.'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'The master environment size is '</font><font color="#000080">,
         </font>EnvSize<font color="#000080">(</font>MASTER_ENVSEG<font color="#000080">),</font><font color="#800000">' bytes.'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'Current environment ('</font><font color="#000080">,</font>HexWord<font color="#000080">(</font>CURRENT_ENVSEG<font color="#000080">),
         </font><font color="#800000">') size is '</font><font color="#000080">,</font>EnvSize<font color="#000080">(</font>CURRENT_ENVSEG<font color="#000080">),</font><font color="#800000">' bytes.'</font><font color="#000080">);

      </font>writeln<font color="#000080">(</font><font color="#800000">'Master  : '</font><font color="#000080">,</font>evar<font color="#000080">,</font><font color="#800000">'=&quot;'</font><font color="#000080">, </font>GetEnv<font color="#000080">(</font>evar<font color="#000080">,</font>MASTER_ENVSEG<font color="#000080">),</font><font color="#800000">'&quot;'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'Current : '</font><font color="#000080">,</font>evar<font color="#000080">,</font><font color="#800000">'=&quot;'</font><font color="#000080">, </font>GetEnv<font color="#000080">(</font>evar<font color="#000080">,</font>CURRENT_ENVSEG<font color="#000080">),</font><font color="#800000">'&quot;'</font><font color="#000080">);
      </font><font color="#FF0000"><b>if not </b></font>PutEnv<font color="#000080">(</font>evar<font color="#000080">,</font>value<font color="#000080">,</font>CURRENT_ENVSEG<font color="#000080">) </font><font color="#FF0000"><b>then
         </b></font>writeln<font color="#000080">(</font><font color="#800000">#10#13#7'*** Insufficient environment space!'</font><font color="#000080">);
      </font>writeln<font color="#000080">(</font><font color="#800000">'After   : '</font><font color="#000080">,</font>evar<font color="#000080">,</font><font color="#800000">'=&quot;'</font><font color="#000080">, </font>GetEnv<font color="#000080">(</font>evar<font color="#000080">,</font>CURRENT_ENVSEG<font color="#000080">),</font><font color="#800000">'&quot;'</font><font color="#000080">);

      </font>Pause<font color="#000080">;
      </font>x<font color="#000080">:=</font>Shell<font color="#000080">(</font><font color="#800000">''</font><font color="#000080">); </font><font color="#008000"><i>{prompt);}   { Try both }
      </i></font>writeln<font color="#000080">; </font>writeln<font color="#000080">(</font><font color="#800000">'Shell() returned DOS code '</font><font color="#000080">,</font>x<font color="#000080">)
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>writeln<font color="#000080">(</font>FNStrip<font color="#000080">(</font>PROGRAMNAME<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">),</font>CREDIT<font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0103.PAS">Original</a><b>]</b></p></body>
</html>
