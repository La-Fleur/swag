<html>
<head><title> "Assign New Environment" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0002.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 The following TP code assigns a new Environment to the COMMand.COM
 which is invoked by TP's EXEC Function.  In this Case, it is used
 to produce a Dos PROMPT which is different from the one in the Master
 Environment.  Control is returned when the user Types Exit ...
}

{ Reduce Retained Memory }

{$M 2048,0,0}

</i></font><font color="#FF0000"><b>Program </b></font>NewEnv<font color="#000080">;
</font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">;
</font><font color="#FF0000"><b>Type
  </b></font>String128   <font color="#000080">= </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">128</font><font color="#000080">];
</font><font color="#FF0000"><b>Const
  </b></font>NewPrompt   <font color="#000080">=
    </font><font color="#800000">'PROMPT=$e[32mType Exit to Return to The Fitness Profiler$e[0m$_$_$p$g' </font><font color="#000080">+ </font><font color="#800000">#0</font><font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>EnvironNew<font color="#000080">,
  </font>EnvironOld<font color="#000080">,
  </font>offsetN<font color="#000080">,
  </font>offsetO<font color="#000080">,
  </font>SegBytes    <font color="#000080">: </font>Word<font color="#000080">;
  </font>TextBuff    <font color="#000080">: </font>String128<font color="#000080">;
  </font>Found<font color="#000080">,
  </font>Okay        <font color="#000080">: </font>Boolean<font color="#000080">;
  </font>Reg         <font color="#000080">: </font>Registers<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>AllocateSeg<font color="#000080">( </font>BytesNeeded <font color="#000080">: </font>Word <font color="#000080">) : </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Reg<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$48</font><font color="#000080">;
  </font>Reg<font color="#000080">.</font>BX <font color="#000080">:= </font>BytesNeeded <font color="#FF0000"><b>div </b></font><font color="#800000">16</font><font color="#000080">;
  </font>MsDos<font color="#000080">( </font>Reg <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Reg<font color="#000080">.</font>Flags <font color="#FF0000"><b>and </b></font>FCarry <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>AllocateSeg <font color="#000080">:= </font><font color="#800000">0
  </font><font color="#FF0000"><b>else
    </b></font>AllocateSeg <font color="#000080">:= </font>Reg<font color="#000080">.</font>AX<font color="#000080">;
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{AllocateSeg}</i></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>DeAllocateSeg<font color="#000080">( </font>AllocSeg <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>okay <font color="#000080">: </font>Boolean <font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>Reg<font color="#000080">.</font>ES <font color="#000080">:= </font>AllocSeg<font color="#000080">;
  </font>Reg<font color="#000080">.</font>AH <font color="#000080">:= </font><font color="#800000">$49</font><font color="#000080">;
  </font>MsDos<font color="#000080">( </font>Reg <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Reg<font color="#000080">.</font>Flags <font color="#FF0000"><b>and </b></font>FCarry <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>okay <font color="#000080">:= </font>False
  <font color="#FF0000"><b>else
    </b></font>okay <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{DeAllocateSeg}</i></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>EnvReadLn<font color="#000080">( </font>EnvSeg <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Envoffset <font color="#000080">: </font>Word <font color="#000080">) : </font>String128<font color="#000080">;
</font><font color="#FF0000"><b>Var
  </b></font>tempstr <font color="#000080">: </font>String128<font color="#000080">;
  </font>loopc   <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>loopc <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>Repeat
    </b></font>inC<font color="#000080">( </font>loopc <font color="#000080">);
    </font>tempstr<font color="#000080">[</font>loopc<font color="#000080">] := </font>CHR<font color="#000080">(</font>Mem<font color="#000080">[</font>EnvSeg<font color="#000080">:</font>Envoffset<font color="#000080">]);
    </font>inC<font color="#000080">( </font>Envoffset <font color="#000080">);
  </font><font color="#FF0000"><b>Until </b></font>tempstr<font color="#000080">[</font>loopc<font color="#000080">] = </font><font color="#800000">#0</font><font color="#000080">;
  </font>tempstr<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>CHR<font color="#000080">(</font>loopc<font color="#000080">);       </font><font color="#008000"><i>{set str length}
  </i></font>EnvReadLn <font color="#000080">:= </font>tempstr
<font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ReadEnvLn}</i></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>EnvWriteLn<font color="#000080">( </font>EnvSeg <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Var </b></font>Envoffset <font color="#000080">: </font>Word<font color="#000080">;
                      </font>AsciizStr <font color="#000080">: </font><font color="#FF0000"><b>String </b></font><font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>loopc   <font color="#000080">: </font>Byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  For </b></font>loopc <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Length<font color="#000080">( </font>AsciizStr <font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>Mem<font color="#000080">[</font>EnvSeg<font color="#000080">:</font>Envoffset<font color="#000080">] := </font>orD<font color="#000080">(</font>AsciizStr<font color="#000080">[</font>loopc<font color="#000080">]);
    </font>inC<font color="#000080">( </font>Envoffset <font color="#000080">)
  </font><font color="#FF0000"><b>end
end </b></font><font color="#008000"><i>{EnvWriteLn}</i></font><font color="#000080">;

</font><font color="#FF0000"><b>begin   </b></font><font color="#008000"><i>{main}
  </i></font>WriteLn<font color="#000080">(</font><font color="#800000">#10</font><font color="#000080">,</font><font color="#800000">'NewEnv v0.0 Dec.25.91 Greg Vigneault'</font><font color="#000080">);
  </font>SegBytes <font color="#000080">:= </font><font color="#800000">1024</font><font color="#000080">;    </font><font color="#008000"><i>{ size of new environment (up to 32k)}
  </i></font>EnvironNew <font color="#000080">:= </font>AllocateSeg<font color="#000080">( </font>SegBytes <font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>EnvironNew <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin    </b></font><font color="#008000"><i>{ asked For too much memory? }
    </i></font>WriteLn<font color="#000080">(</font><font color="#800000">'Can''t allocate memory segment Bytes.'</font><font color="#000080">,</font><font color="#800000">#7</font><font color="#000080">);
    </font>Halt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>EnvironOld <font color="#000080">:= </font>MemW<font color="#000080">[ </font>PrefixSeg<font color="#000080">:</font><font color="#800000">$002c </font><font color="#000080">];   </font><font color="#008000"><i>{ current environ }
  { copy orig env, but change the PROMPT command }
  </i></font>Found <font color="#000080">:= </font>False<font color="#000080">;
  </font>offsetO <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>offsetN <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>Repeat  </b></font><font color="#008000"><i>{ copy one env Var at a time, old env to new env}
    </i></font>TextBuff <font color="#000080">:= </font>EnvReadLn<font color="#000080">( </font>EnvironOld<font color="#000080">, </font>offsetO <font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>offsetO <font color="#000080">&gt;= </font>SegBytes <font color="#FF0000"><b>then
    begin </b></font><font color="#008000"><i>{ not enough space? }
      </i></font>WriteLn<font color="#000080">(</font><font color="#800000">'not enough new Environment space'</font><font color="#000080">,</font><font color="#800000">#7</font><font color="#000080">);
      </font>DeAllocateSeg<font color="#000080">( </font>EnvironNew<font color="#000080">, </font>okay <font color="#000080">);
      </font>Halt<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">)     </font><font color="#008000"><i>{ abort to Dos }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#008000"><i>{ check For the PROMPT command String }
    </i></font><font color="#FF0000"><b>if </b></font>Pos<font color="#000080">(</font><font color="#800000">'PROMPT='</font><font color="#000080">,</font>TextBuff<font color="#000080">) = </font><font color="#800000">1 </font><font color="#FF0000"><b>then
    begin </b></font><font color="#008000"><i>{ prompt command? }
      </i></font>TextBuff <font color="#000080">:= </font>NewPrompt<font color="#000080">;          </font><font color="#008000"><i>{ set new prompt }
      </i></font>Found <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#008000"><i>{ now Write the Variable to new environ }
    </i></font>EnvWriteLn<font color="#000080">( </font>EnvironNew<font color="#000080">, </font>offsetN<font color="#000080">, </font>TextBuff <font color="#000080">);
    </font><font color="#008000"><i>{ loop Until all Variables checked/copied }
  </i></font><font color="#FF0000"><b>Until </b></font>Mem<font color="#000080">[</font>EnvironOld<font color="#000080">:</font>offsetO<font color="#000080">] = </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#008000"><i>{ if no prompt command found, create one }
  </i></font><font color="#FF0000"><b>if not </b></font>Found <font color="#FF0000"><b>then
    </b></font>EnvWriteLn<font color="#000080">( </font>EnvironNew<font color="#000080">, </font>offsetN<font color="#000080">, </font>NewPrompt <font color="#000080">);
  </font>Mem<font color="#000080">[</font>EnvironNew<font color="#000080">:</font>offsetN<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;           </font><font color="#008000"><i>{ delimit new environ}
  </i></font>MemW<font color="#000080">[ </font>PrefixSeg<font color="#000080">:</font><font color="#800000">$2c </font><font color="#000080">] := </font>EnvironNew<font color="#000080">;    </font><font color="#008000"><i>{ activate new env }
  </i></font>WriteLn<font color="#000080">( </font><font color="#800000">#10</font><font color="#000080">, </font><font color="#800000">'....Type Exit to return to normal prompt...' </font><font color="#000080">);
  </font>SwapVectors<font color="#000080">;
  </font>Exec<font color="#000080">( </font>GetEnv<font color="#000080">(</font><font color="#800000">'COMSPEC'</font><font color="#000080">),</font><font color="#800000">'/S'</font><font color="#000080">);  </font><font color="#008000"><i>{shell to Dos w/ new prompt}
  </i></font>SwapVectors<font color="#000080">;
  </font>MemW<font color="#000080">[ </font>PrefixSeg<font color="#000080">:</font><font color="#800000">$2c </font><font color="#000080">] := </font>EnvironOld<font color="#000080">;   </font><font color="#008000"><i>{ restore original env}
  </i></font>DeAllocateSeg<font color="#000080">( </font>EnvironNew<font color="#000080">, </font>okay <font color="#000080">);
  </font><font color="#FF0000"><b>if not </b></font>okay <font color="#FF0000"><b>then
    </b></font>WriteLn<font color="#000080">( </font><font color="#800000">'Could not release memory!'</font><font color="#000080">,</font><font color="#800000">#7 </font><font color="#000080">);
</font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{NewEnv}</i></font><font color="#000080">.
</font><font color="#008000"><i>(*******************************************************************)
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DOS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0002.PAS">Original</a><b>]</b></p></body>
</html>
