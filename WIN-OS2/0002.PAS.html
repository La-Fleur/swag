<html>
<head><title> "OS2CHECK.PAS" by GREGORY P. SMITH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0002.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Author : GREGORY P. SMITH

&gt; Is there any way to detect OS/2 (in a Dos box) sessions and Windows
&gt; Sessions? I'd like to throw in support For these multitaskers so I can
&gt; run an idlekey Program.

Actual code is always the best example For me..  Look at this Unit (and use
it, I think you'll like it).  Check With someone else if you want to
specifically detect winslows.  This Unit will, however, give up time to any
multitasker.
}

(* Public Domain Unit by Gregory P. Smith, No Rights Reserved *)
(* ...  This also means no guarantees  ... *)

</i></font><font color="#FF0000"><b>Unit </b></font>OS_Test<font color="#000080">; </font><font color="#008000"><i>{ DESQview, OS/2, &amp; 386 v86 machine Interfaces }

{$X+,S-,R-,F-,O-,D-,G-} { extended syntax, nothing else }

</i></font><font color="#FF0000"><b>Interface

Const
  </b></font>In_DV  <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">; </font><font color="#008000"><i>{ are we in DESQview? }
  </i></font>In_VM  <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">; </font><font color="#008000"><i>{ are we in a 386+ virtual machine? }
  </i></font>In_OS2 <font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">; </font><font color="#008000"><i>{ are we in OS/2? }

</i></font><font color="#FF0000"><b>Function  </b></font>OS2_GetVersion<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ Get OS/2 version # }
</i></font><font color="#FF0000"><b>Function  </b></font>DV_GetVersion<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ update In_DV and get version # }
</i></font><font color="#FF0000"><b>Function  </b></font>DV_Get_Video_Buffer<font color="#000080">(</font>vseg<font color="#000080">:</font>Word<font color="#000080">): </font>Word<font color="#000080">; </font><font color="#008000"><i>{ get the alt video buffer }
</i></font><font color="#FF0000"><b>Procedure </b></font>DV_Pause<font color="#000080">; </font><font color="#008000"><i>{ give up time slice }
</i></font><font color="#FF0000"><b>Procedure </b></font>MT_Pause<font color="#000080">; </font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$cd</font><font color="#000080">/</font><font color="#800000">$28</font><font color="#000080">); </font><font color="#008000"><i>{ give up time in most multitaskers }
</i></font><font color="#FF0000"><b>Procedure </b></font>KillTime<font color="#000080">; </font><font color="#008000"><i>{ Release time in any situation }
</i></font><font color="#FF0000"><b>Procedure </b></font>DV_begin_Critical<font color="#000080">; </font><font color="#008000"><i>{ don't slice away }
  </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$b8</font><font color="#000080">/</font><font color="#800000">$1b</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">/</font><font color="#800000">$cd</font><font color="#000080">/</font><font color="#800000">$15</font><font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>DV_end_Critical<font color="#000080">; </font><font color="#008000"><i>{ allow slicing again }
  </i></font><font color="#FF0000"><b>Inline</b></font><font color="#000080">(</font><font color="#800000">$b8</font><font color="#000080">/</font><font color="#800000">$1c</font><font color="#000080">/</font><font color="#800000">$10</font><font color="#000080">/</font><font color="#800000">$cd</font><font color="#000080">/</font><font color="#800000">$15</font><font color="#000080">);
</font><font color="#FF0000"><b>Procedure </b></font>DV_Sound<font color="#000080">(</font>freq<font color="#000080">,</font>dur<font color="#000080">:</font>Integer<font color="#000080">); </font><font color="#008000"><i>{ Create a Sound in the Bkg }

</i></font><font color="#FF0000"><b>Implementation

Function </b></font>OS2_GetVersion<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">MOV    AH, 30h  </font><font color="#008000"><i>{ Dos Get Version Call }
  </i></font><font color="#FF00FF">INT    21h      </font><font color="#008000"><i>{ AL = major version * 10, AH = minor version }
  </i></font><font color="#FF00FF">MOV    BH, AH   </font><font color="#008000"><i>{ save minor version }
  </i></font><font color="#FF00FF">xor    AH, AH
  MOV    CL, 10
  div    CL       </font><font color="#008000"><i>{ divide by 10 to get the major version }
  </i></font><font color="#FF00FF">MOV    AH, BH   </font><font color="#008000"><i>{ restore minor version }
  </i></font><font color="#FF00FF">XCHG   AH, AL   </font><font color="#008000"><i>{ AH = major, AL = minor }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>DV_GetVersion<font color="#000080">: </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">MOV    CX,'DE'     </font><font color="#008000"><i>{ CX+DX to 'DESQ' (invalid date) }
  </i></font><font color="#FF00FF">MOV    DX,'SQ'
  MOV    AX,02B01H   </font><font color="#008000"><i>{ Dos' set date funct. }
  </i></font><font color="#FF00FF">INT    21H         </font><font color="#008000"><i>{ call Dos }
  </i></font><font color="#FF00FF">CMP    AL,0FFH     </font><font color="#008000"><i>{ Was it invalid? }
  </i></font><font color="#FF00FF">JE     @No_dv      </font><font color="#008000"><i>{ yep, no dv }
  </i></font><font color="#FF00FF">MOV    AX,BX       </font><font color="#008000"><i>{ AH=major AL=minor }
  </i></font><font color="#FF00FF">MOV    In_DV,1     </font><font color="#008000"><i>{ Set In_DV flag }
  </i></font><font color="#FF00FF">JMP    @DvGv_x     </font><font color="#008000"><i>{ other routines }
 </i></font><font color="#FF00FF">@No_dv:
  xor    AX,AX       </font><font color="#008000"><i>{ Return 0 or no DV }
 </i></font><font color="#FF00FF">@DvGv_x:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ DV_GetVersion }

</i></font><font color="#FF0000"><b>Function </b></font>DV_Get_Video_Buffer<font color="#000080">(</font>vseg<font color="#000080">:</font>Word<font color="#000080">): </font>Word<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;
</font><font color="#FF0000"><b>Asm                      </b></font><font color="#008000"><i>{ Modified by Scott Samet April 1992 }
  </i></font><font color="#FF00FF">CALL   DV_GetVersion   </font><font color="#008000"><i>{ Returns AX=0 if not in DV }
  </i></font><font color="#FF00FF">MOV    ES,vseg         </font><font color="#008000"><i>{ Put current segment into ES }
  </i></font><font color="#FF00FF">TEST   AX,AX           </font><font color="#008000"><i>{ In DV? }
  </i></font><font color="#FF00FF">JZ     @DVGVB_X        </font><font color="#008000"><i>{ Jump if not }
  </i></font><font color="#FF00FF">MOV    AH,0FEH         </font><font color="#008000"><i>{ DV's get video buffer Function }
  </i></font><font color="#FF00FF">INT    10H             </font><font color="#008000"><i>{ Returns ES:DI of alt buffer }
 </i></font><font color="#FF00FF">@DVGVB_X:
  MOV    AX,ES           </font><font color="#008000"><i>{ Return video buffer }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ DV_Get_Video_Buffer }

</i></font><font color="#FF0000"><b>Procedure </b></font>DV_Pause<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>In_DV <font color="#FF0000"><b>then
  Asm
    </b></font><font color="#FF00FF">MOV AX, 1000h    </font><font color="#008000"><i>{ pause Function }
    </i></font><font color="#FF00FF">INT 15h
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ DV_Pause }

</i></font><font color="#FF0000"><b>Procedure </b></font>KillTime<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>In_VM <font color="#FF0000"><b>then
  Asm
    </b></font><font color="#FF00FF">MOV AX, 1680h    </font><font color="#008000"><i>{ give up VM time slice }
    </i></font><font color="#FF00FF">INT 2Fh
  </font><font color="#FF0000"><b>end
  else
  if </b></font>In_DV <font color="#FF0000"><b>then
  Asm
    </b></font><font color="#FF00FF">MOV AX, 1000h    </font><font color="#008000"><i>{ DV pause call }
    </i></font><font color="#FF00FF">INT 15h
  </font><font color="#FF0000"><b>end
  else
    </b></font>MT_Pause<font color="#000080">;      </font><font color="#008000"><i>{ Dos Idle call }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>(* Procedure DV_begin_Critical; Assembler;
Asm
  MOV AX,$101B       { DV begin critical Function }
  INT 15h
end; { DV_begin_Critical }

Procedure DV_end_Critical; Assembler;
Asm
  MOV AX,$101C       { DV end critical Function }
  INT 15h
end; { DV_end_Critical }  *)

</i></font><font color="#FF0000"><b>Procedure </b></font>DV_Sound<font color="#000080">(</font>freq<font color="#000080">,</font>dur<font color="#000080">:</font>Integer<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">; </font><font color="#008000"><i>{ Sound a tone }
</i></font><font color="#FF0000"><b>Asm
  </b></font><font color="#FF00FF">MOV   AX,1019H
  MOV   BX,freq  </font><font color="#008000"><i>{ frequency above 20 Hz }
  </i></font><font color="#FF00FF">MOV   CX,dur   </font><font color="#008000"><i>{ duration in clock ticks }
  </i></font><font color="#FF00FF">INT   15H
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ ** -- initalization -- ** }

</i></font><font color="#FF0000"><b>begin
  </b></font>DV_GetVersion<font color="#000080">; </font><font color="#008000"><i>{ discard answer.  Just update In_DV }
  </i></font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">MOV AX, 1680h
    INT 2Fh          </font><font color="#008000"><i>{ Gives up time slice in most 386+ virtual machines }
    </i></font><font color="#FF00FF">not AL           </font><font color="#008000"><i>{ AL = 00h if supported, remains 80h if not }
    </i></font><font color="#FF00FF">MOV CL, 7
    SHR AL, CL       </font><font color="#008000"><i>{ move bit 7 to bit 0 For a Boolean }
    </i></font><font color="#FF00FF">MOV In_VM, AL    </font><font color="#008000"><i>{ update the flag }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>In_OS2 <font color="#000080">:= (</font>OS2_GetVersion <font color="#000080">&gt;= </font><font color="#800000">$0100</font><font color="#000080">); </font><font color="#008000"><i>{ version 1.0 or greater }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0002.PAS">Original</a><b>]</b></p></body>
</html>
