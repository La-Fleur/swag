<html>
<head><title> "Set WINDOWS Wallpaper" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>Program </b></font>Paper<font color="#000080">;

</font><font color="#008000"><i>{$R-,I-,S-,L-,D-,G+}

</i></font><font color="#FF0000"><b>Uses
  </b></font>WinTypes<font color="#000080">,</font>WinProcs<font color="#000080">,</font>WObjects<font color="#000080">,</font>Strings<font color="#000080">;

</font><font color="#008000"><i>{ Declare undocumented Windows API call }

</i></font><font color="#FF0000"><b>Procedure </b></font>SetDeskWallpaper<font color="#000080">(</font>Name <font color="#000080">: </font>PChar<font color="#000080">);
  </font><font color="#FF0000"><b>Far</b></font><font color="#000080">; </font><font color="#FF0000"><b>External </b></font><font color="#800000">'USER' </font>Index <font color="#800000">285</font><font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>hPal <font color="#000080">: </font>HPalette<font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------}

{ --- App/Win Object declarations --- }

</i></font><font color="#FF0000"><b>Type
  </b></font>TPaperApp <font color="#000080">= </font><font color="#FF0000"><b>Object</b></font><font color="#000080">(</font>TApplication<font color="#000080">)
                </font><font color="#FF0000"><b>Procedure </b></font>InitMainWindow<font color="#000080">; </font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;
              </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font>PPaperWindow <font color="#000080">= ^</font>PaperWindow<font color="#000080">;
  </font>PaperWindow <font color="#000080">= </font><font color="#FF0000"><b>Object</b></font><font color="#000080">(</font>TWindow<font color="#000080">)
                  </font><font color="#FF0000"><b>Procedure </b></font>SetupWindow<font color="#000080">;
                    </font><font color="#FF0000"><b>Virtual</b></font><font color="#000080">;

                  </font><font color="#FF0000"><b>Procedure </b></font>WMQueryNewPalette<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Msg <font color="#000080">: </font>TMessage<font color="#000080">);
                    </font><font color="#FF0000"><b>Virtual </b></font>wm_QueryNewPalette<font color="#000080">;

                  </font><font color="#FF0000"><b>Procedure </b></font>WMPaletteChanged<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Msg <font color="#000080">: </font>TMessage<font color="#000080">);
                    </font><font color="#FF0000"><b>Virtual </b></font>wm_PaletteChanged<font color="#000080">;
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------}

{ --- App Methods --- }

</i></font><font color="#FF0000"><b>Procedure </b></font>TPaperApp<font color="#000080">.</font>InitMainWindow<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>hPrevInst <font color="#000080">= </font><font color="#800000">0
    </font><font color="#FF0000"><b>Then </b></font>MainWindow <font color="#000080">:= </font>New<font color="#000080">(</font>PPaperWindow<font color="#000080">,</font>Init<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">,</font><font color="#800000">'Paper'</font><font color="#000080">))
    </font><font color="#FF0000"><b>Else </b></font>Halt<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>End </b></font><font color="#008000"><i>{InitMainWindow}</i></font><font color="#000080">;

</font><font color="#008000"><i>{ --- Window Methods --- }

{---------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>PaperWindow<font color="#000080">.</font>SetupWindow<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>PaperStr <font color="#000080">: </font><font color="#FF0000"><b>Array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">80</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>Char<font color="#000080">;
  </font>FName <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">80</font><font color="#000080">];
  </font>DC <font color="#000080">: </font>HDC<font color="#000080">;
  </font>LogPal <font color="#000080">: </font>TLogPalette<font color="#000080">;
  </font>hOldPal <font color="#000080">: </font>HPalette<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font><font color="#008000"><i>{ Retreive filename - if none: we just fixup the palette }
  </i></font>FName <font color="#000080">:= </font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font>FName <font color="#000080">&lt;&gt; </font><font color="#800000">''
    </font><font color="#FF0000"><b>Then Begin
           </b></font><font color="#008000"><i>{ Add .BMP to filename, if necess. }
           </i></font><font color="#FF0000"><b>If </b></font>Pos<font color="#000080">(</font><font color="#800000">'.'</font><font color="#000080">,</font>FName<font color="#000080">) = </font><font color="#800000">0
             </font><font color="#FF0000"><b>Then </b></font>FName <font color="#000080">:= </font>FName <font color="#000080">+ </font><font color="#800000">'.bmp'</font><font color="#000080">;

           </font><font color="#008000"><i>{ Put string in &quot;C&quot; style }
           </i></font>StrPCopy<font color="#000080">(</font>PaperStr<font color="#000080">,</font>FName<font color="#000080">);

           </font><font color="#008000"><i>{ Make sure we keep WIN.INI apprised of our changes }
           </i></font>WriteProfileString<font color="#000080">(</font><font color="#800000">'Desktop'</font><font color="#000080">,</font><font color="#800000">'Wallpaper'</font><font color="#000080">,</font>PaperStr<font color="#000080">);

           </font><font color="#008000"><i>{ Set the wallpaper }
           </i></font>SetDeskWallpaper<font color="#000080">(</font>PaperStr<font color="#000080">);   </font><font color="#008000"><i>{ Undoc'd win call }
         </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ Invalidate the screen, even if we don't load a new wallpaper - if
    we don't do this, the &quot;transparent&quot; areas of icons will be fratzed up }
  </i></font>InvalidateRect<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#FF0000"><b>Nil</b></font><font color="#000080">,</font>False<font color="#000080">);

  </font><font color="#008000"><i>{ Create a small palette to fix the fact that loading the wallpaper
    doesn't realize the palette }

  </i></font>LogPal<font color="#000080">.</font>palVersion <font color="#000080">:= </font><font color="#800000">$0300</font><font color="#000080">;
  </font>LogPal<font color="#000080">.</font>palNumEntries <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font>LogPal<font color="#000080">.</font>palPalEntry<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">].</font>peRed <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>LogPal<font color="#000080">.</font>palPalEntry<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">].</font>peGreen <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>LogPal<font color="#000080">.</font>palPalEntry<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">].</font>peBlue <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>LogPal<font color="#000080">.</font>palPalEntry<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">].</font>peFlags <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;

  </font><font color="#008000"><i>{ Get a DC and realize our palette }
  </i></font>DC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>HWindow<font color="#000080">);

  </font>hPal <font color="#000080">:= </font>CreatePalette<font color="#000080">(</font>LogPal<font color="#000080">);
  </font>hOldPal <font color="#000080">:= </font>SelectPalette<font color="#000080">(</font>DC<font color="#000080">,</font>hPal<font color="#000080">,</font>False<font color="#000080">);

  </font>RealizePalette<font color="#000080">(</font>DC<font color="#000080">);

  </font><font color="#008000"><i>{ Close up our palette stuff }
  </i></font>SelectPalette<font color="#000080">(</font>DC<font color="#000080">,</font>hOldPal<font color="#000080">,</font>False<font color="#000080">);

  </font>DeleteObject<font color="#000080">(</font>hPal<font color="#000080">);
  </font>ReleaseDC<font color="#000080">(</font>HWindow<font color="#000080">,</font>DC<font color="#000080">);

  </font><font color="#008000"><i>{ Close ourselves automatically }
  </i></font>PostMessage<font color="#000080">(</font>HWindow<font color="#000080">,</font>wm_Close<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);

</font><font color="#FF0000"><b>End </b></font><font color="#008000"><i>{SetupWindow}</i></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>PaperWindow<font color="#000080">.</font>WMQueryNewPalette<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Msg <font color="#000080">: </font>TMessage<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>ahDC <font color="#000080">: </font>HDC<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>ahDC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>HWindow<font color="#000080">);
  </font>SelectPalette<font color="#000080">(</font>ahDC<font color="#000080">,</font>hPal<font color="#000080">,</font>False<font color="#000080">);

  </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>RealizePalette<font color="#000080">(</font>ahDC<font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">)
    </font><font color="#FF0000"><b>Then Begin
           </b></font>ReleaseDC<font color="#000080">(</font>HWindow<font color="#000080">,</font>ahDC<font color="#000080">);
           </font>InvalidateRect<font color="#000080">(</font>HWindow<font color="#000080">,</font><font color="#FF0000"><b>Nil</b></font><font color="#000080">,</font>False<font color="#000080">)
         </font><font color="#FF0000"><b>End
    Else </b></font>ReleaseDC<font color="#000080">(</font>HWindow<font color="#000080">,</font>ahDC<font color="#000080">);
</font><font color="#FF0000"><b>End </b></font><font color="#008000"><i>{WMQueryNewPalette}</i></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>PaperWindow<font color="#000080">.</font>WMPaletteChanged<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>Msg <font color="#000080">: </font>TMessage<font color="#000080">);

</font><font color="#FF0000"><b>Var
  </b></font>ahDC <font color="#000080">: </font>HDC<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  If </b></font>Msg<font color="#000080">.</font>wParam <font color="#000080">&lt;&gt; </font>HWindow
    <font color="#FF0000"><b>Then Begin
           </b></font>ahDC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>HWindow<font color="#000080">);
           </font>SelectPalette<font color="#000080">(</font>ahDC<font color="#000080">,</font>hPal<font color="#000080">,</font>False<font color="#000080">);

           </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>RealizePalette<font color="#000080">(</font>ahDC<font color="#000080">) &gt; </font><font color="#800000">0</font><font color="#000080">)
             </font><font color="#FF0000"><b>Then </b></font>InvalidateRect<font color="#000080">(</font>HWindow<font color="#000080">,</font><font color="#FF0000"><b>nil</b></font><font color="#000080">,</font>False<font color="#000080">);

           </font>ReleaseDC<font color="#000080">(</font>HWindow<font color="#000080">,</font>ahDC<font color="#000080">);
         </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End </b></font><font color="#008000"><i>{WMPaletteChanged}</i></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------}

{ --- Main --- }

</i></font><font color="#FF0000"><b>Var
  </b></font>PaperApp <font color="#000080">: </font>TPaperApp<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>CmdShow <font color="#000080">:= </font>sw_Minimize<font color="#000080">;

  </font>PaperApp<font color="#000080">.</font>Init<font color="#000080">(</font><font color="#800000">'Paper'</font><font color="#000080">);
  </font>PaperApp<font color="#000080">.</font>Run<font color="#000080">;
  </font>PaperApp<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0020.PAS">Original</a><b>]</b></p></body>
</html>
