<html>
<head><title> "Window Memory Stream" by ROBERT WARREN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
        Useful for transferring  objects which have been registered to the clipboard or any global memory situation.
        Also could be used to make a copy of any streamable object. Merely stream the object to memory and then
        re-instantiate a new object through the use of a TStream.Get. Solves the
        problem of passing objects to another program because it removes any method pointer info.

        NOTE: This works only for streams which are not larger than 64K. In order
                                to make this work for larger streams you have to ensure that your
                                writes and puts (and gets and reads...) don't straddle each 64K boundary.
                                I haven't added the pointer math to this unit yet.
}

{ Author Robert Warren CIS ID 70303,537 }

</i></font><font color="#FF0000"><b>Unit </b></font>MemStream<font color="#000080">;

</font><font color="#FF0000"><b>interface

        Uses </b></font>WinTypes<font color="#000080">,</font>WinProcs<font color="#000080">, </font>WObjects<font color="#000080">;

        </font><font color="#FF0000"><b>type

                </b></font>PMemStream <font color="#000080">= ^</font>TMemStream<font color="#000080">;
                </font>TMemStream <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TStream<font color="#000080">)

                                </font>Handle<font color="#000080">: </font>Word<font color="#000080">;
                                </font>Address<font color="#000080">: </font>Pointer<font color="#000080">;
                                </font>Size<font color="#000080">: </font>Longint<font color="#000080">;       </font><font color="#008000"><i>{ allocated size }
                                </i></font>Position<font color="#000080">: </font>Longint<font color="#000080">;   </font><font color="#008000"><i>{ current position in stream }
                                </i></font>AllocFlags<font color="#000080">: </font>LongInt<font color="#000080">; </font><font color="#008000"><i>{ flags required when allocating / reallocating }
                                </i></font>FreeMemory<font color="#000080">: </font>Boolean<font color="#000080">; </font><font color="#008000"><i>{ Flag indicating whether to free global
                                                                                                                         memory when disposing of object }

                        </i></font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>AllocSize<font color="#000080">: </font>Longint<font color="#000080">; </font>Flags<font color="#000080">: </font>LongInt<font color="#000080">; </font>FreeMem<font color="#000080">: </font>Boolean<font color="#000080">);
                        </font><font color="#FF0000"><b>constructor </b></font>InitWithHandle<font color="#000080">(</font>aHandle<font color="#000080">: </font>THandle<font color="#000080">; </font>Flags<font color="#000080">: </font>LongInt<font color="#000080">; </font>FreeMem<font color="#000080">: </font>Boolean<font color="#000080">);
                        </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>function </b></font>GetPos<font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>procedure </b></font>Grow<font color="#000080">(</font>howMuch<font color="#000080">: </font>LongInt<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>function </b></font>GetSize<font color="#000080">: </font>Longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>procedure </b></font>Read<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>procedure </b></font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>procedure </b></font>Seek<font color="#000080">(</font>Pos<font color="#000080">: </font>Longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                        </font><font color="#FF0000"><b>procedure </b></font>Truncate<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
                </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

</b></font><font color="#008000"><i>{
 creates a memory stream of given size using the flags. The FreeMem argument
 is used to determine whether to delete the global block of memory when the
 object is disposed of. Sometime you don't want to delete the block if for
 example it has been placed in the clipboard or passed using DDE.
}
</i></font><font color="#FF0000"><b>constructor </b></font>TMemStream<font color="#000080">.</font>Init<font color="#000080">(</font>AllocSize<font color="#000080">: </font>Longint<font color="#000080">; </font>Flags<font color="#000080">: </font>LongInt<font color="#000080">;</font>FreeMem<font color="#000080">: </font>Boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
 </b></font>TStream<font color="#000080">.</font>Init<font color="#000080">;
 </font>Handle<font color="#000080">:=</font>GlobalAlloc<font color="#000080">( </font>Flags<font color="#000080">, </font>AllocSize<font color="#000080">);
 </font>Address<font color="#000080">:=</font>GlobalLock<font color="#000080">(</font>Handle<font color="#000080">); </font><font color="#008000"><i>{ so much for real mode }
 </i></font>Size<font color="#000080">:=</font>AllocSize<font color="#000080">;
 </font>Position<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font>FreeMemory<font color="#000080">:= </font>FreeMem<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{
 same as above but allows for the creation of a object given an already
 allocated memory block. Perhaps some data FROM a clipboard
}
</i></font><font color="#FF0000"><b>constructor </b></font>TMemStream<font color="#000080">.</font>InitWithHandle<font color="#000080">(</font>aHandle<font color="#000080">: </font>THandle<font color="#000080">; </font>Flags<font color="#000080">: </font>LongInt<font color="#000080">;</font>FreeMem<font color="#000080">: </font>Boolean<font color="#000080">);
</font><font color="#FF0000"><b>begin
 </b></font>TStream<font color="#000080">.</font>Init<font color="#000080">;
 </font>Size<font color="#000080">:=</font>GlobalSize<font color="#000080">(</font>Handle<font color="#000080">);
 </font>Address<font color="#000080">:=</font>GlobalLock<font color="#000080">(</font>Handle<font color="#000080">);
 </font>Position<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
 </font>FreeMemory<font color="#000080">:= </font>FreeMem<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>destructor </b></font>TMemStream<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>TStream<font color="#000080">.</font>Done<font color="#000080">;
 </font>GlobalUnlock<font color="#000080">(</font>Handle<font color="#000080">);
 </font><font color="#FF0000"><b>If </b></font>FreeMemory <font color="#FF0000"><b>then </b></font>GlobalFree<font color="#000080">(</font>Handle<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TMemStream<font color="#000080">.</font>GetPos<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
        </b></font>GetPos<font color="#000080">:=</font>Position<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TMemStream<font color="#000080">.</font>GetSize<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
        </b></font>GetSize<font color="#000080">:=</font>Size<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Read<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var
 </b></font>varAddress<font color="#000080">: </font>PChar<font color="#000080">;
 </font>stAddress<font color="#000080">: </font>PChar<font color="#000080">;
 </font>i<font color="#000080">: </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>varAddress<font color="#000080">:=@</font>Buf<font color="#000080">;
 </font>stAddress<font color="#000080">:=</font>PChar<font color="#000080">(</font>MakeLong<font color="#000080">(</font>Position<font color="#000080">+</font>LoWord<font color="#000080">(</font>LongInt<font color="#000080">(</font>Address<font color="#000080">)),</font>HiWord<font color="#000080">(</font>LongInt<font color="#000080">(</font>Address<font color="#000080">))));
 </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count <font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
         </b></font>varAddress<font color="#000080">[</font>i<font color="#000080">]:=</font>stAddress<font color="#000080">[</font>i<font color="#000080">];
 </font>inc<font color="#000080">(</font>Position<font color="#000080">,</font>Count<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Grow<font color="#000080">(</font>HowMuch<font color="#000080">: </font>LongInt<font color="#000080">);
</font><font color="#FF0000"><b>begin
 </b></font>GlobalUnlock<font color="#000080">(</font>Handle<font color="#000080">);
 </font>Inc<font color="#000080">(</font>Size<font color="#000080">,</font>HowMuch<font color="#000080">);
 </font>GlobalRealloc<font color="#000080">(</font>Handle<font color="#000080">, </font>Size<font color="#000080">, </font>AllocFlags<font color="#000080">);
 </font>GlobalLock<font color="#000080">(</font>Handle<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Write<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Buf<font color="#000080">; </font>Count<font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#FF0000"><b>var
 </b></font>varAddress<font color="#000080">: </font>PChar<font color="#000080">;
 </font>stAddress<font color="#000080">: </font>PChar<font color="#000080">;
 </font>i<font color="#000080">: </font>LongInt<font color="#000080">;
 </font>growSize<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin

 if </b></font>Position <font color="#000080">+ </font>Count <font color="#000080">&gt;= </font>Size <font color="#FF0000"><b>then
         begin
                if </b></font>count <font color="#000080">&lt; </font><font color="#800000">1023
                         </font><font color="#FF0000"><b>then </b></font>growSize<font color="#000080">:=</font><font color="#800000">1024
                         </font><font color="#FF0000"><b>else </b></font>growSize<font color="#000080">:=</font>count <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;

                </font>Grow<font color="#000080">(</font>growSize<font color="#000080">);
         </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font>varAddress<font color="#000080">:=@</font>Buf<font color="#000080">;
 </font>stAddress<font color="#000080">:=</font>PChar<font color="#000080">(</font>MakeLong<font color="#000080">(</font>Position<font color="#000080">+</font>LoWord<font color="#000080">(</font>LongInt<font color="#000080">(</font>Address<font color="#000080">)),</font>HiWord<font color="#000080">(</font>LongInt<font color="#000080">(</font>Address<font color="#000080">))));
 </font><font color="#FF0000"><b>for </b></font>i<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>Count <font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
         </b></font>stAddress<font color="#000080">[</font>i<font color="#000080">]:=</font>varAddress<font color="#000080">[</font>i<font color="#000080">];
 </font>inc<font color="#000080">(</font>Position<font color="#000080">,</font>Count<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Seek<font color="#000080">(</font>Pos<font color="#000080">: </font>Longint<font color="#000080">);
</font><font color="#FF0000"><b>begin
 </b></font>Position<font color="#000080">:=</font>Pos<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TMemStream<font color="#000080">.</font>Truncate<font color="#000080">;
</font><font color="#FF0000"><b>begin
        </b></font>GlobalUnlock<font color="#000080">(</font>Handle<font color="#000080">);
        </font>GlobalReAlloc<font color="#000080">(</font>Handle<font color="#000080">,</font>Position<font color="#000080">,</font>AllocFlags<font color="#000080">);
        </font>Address<font color="#000080">:=</font>GlobalLock<font color="#000080">(</font>Handle<font color="#000080">);
        </font>Size<font color="#000080">:=</font>Position<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0019.PAS">Original</a><b>]</b></p></body>
</html>
