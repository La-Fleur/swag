<html>
<head><title> "Load Bitmaps" by ELM MORROW</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: ELM MORROW
Subj: LOADBMPS.PAS
}

{$R-}

</i></font><font color="#FF0000"><b>unit </b></font>LoadBMPs<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses </b></font>WinProcs<font color="#000080">, </font>WinTypes<font color="#000080">, </font>Strings<font color="#000080">, </font>WinDos<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>LoadBMP<font color="#000080">(</font>Name<font color="#000080">: </font>PChar<font color="#000080">; </font>Window<font color="#000080">: </font>hWnd<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>DibPal<font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>var </b></font>Width<font color="#000080">, </font>Height<font color="#000080">: </font>LongInt<font color="#000080">): </font>hBitMap<font color="#000080">;

</font><font color="#FF0000"><b>implementation

function </b></font>CreateBIPalette<font color="#000080">(</font>BI<font color="#000080">: </font>PBitMapInfoHeader<font color="#000080">): </font>HPalette<font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>ARGBQuad <font color="#000080">= </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">5000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>TRGBQuad<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>RGB<font color="#000080">: ^</font>ARGBQuad<font color="#000080">;
  </font>NumColors<font color="#000080">: </font>Word<font color="#000080">;
  </font>Pal<font color="#000080">: </font>PLogPalette<font color="#000080">;
  </font>hPal<font color="#000080">: </font>hPalette<font color="#000080">;
  </font>I<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>CreateBiPalette <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>RGB <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>BI<font color="#000080">^), </font>Ofs<font color="#000080">(</font>BI<font color="#000080">^)+</font>BI<font color="#000080">^.</font>biSize<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>BI<font color="#000080">^.</font>biBitCount<font color="#000080">&lt;</font><font color="#800000">24 </font><font color="#FF0000"><b>then
  begin
    </b></font>NumColors<font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>shl </b></font>BI<font color="#000080">^.</font>biBitCount<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>NumColors<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>GetMem<font color="#000080">(</font>Pal<font color="#000080">, </font>SizeOf<font color="#000080">(</font>PLogPalette<font color="#000080">)+</font>NumColors<font color="#000080">*</font>SizeOf<font color="#000080">(</font>TPaletteEntry<font color="#000080">));
      </font>Pal<font color="#000080">^.</font>palNumEntries <font color="#000080">:= </font>NumColors<font color="#000080">;
      </font>Pal<font color="#000080">^.</font>palVersion <font color="#000080">:= </font><font color="#800000">$300</font><font color="#000080">;
      </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>NumColors<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
      begin
        </b></font>Pal<font color="#000080">^.</font>palPalEntry<font color="#000080">[</font>I<font color="#000080">].</font>peRed <font color="#000080">:= </font>RGB<font color="#000080">^[</font>I<font color="#000080">].</font>rgbRed<font color="#000080">;
        </font>Pal<font color="#000080">^.</font>palPalEntry<font color="#000080">[</font>I<font color="#000080">].</font>peGreen <font color="#000080">:= </font>RGB<font color="#000080">^[</font>I<font color="#000080">].</font>rgbGreen<font color="#000080">;
        </font>Pal<font color="#000080">^.</font>palPalEntry<font color="#000080">[</font>I<font color="#000080">].</font>peBlue <font color="#000080">:= </font>RGB<font color="#000080">^[</font>I<font color="#000080">].</font>rgbBlue<font color="#000080">;
        </font>Pal<font color="#000080">^.</font>palPalEntry<font color="#000080">[</font>I<font color="#000080">].</font>peFlags <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>hPal <font color="#000080">:= </font>CreatePalette<font color="#000080">(</font>Pal<font color="#000080">^);
      </font>FreeMem<font color="#000080">(</font>Pal<font color="#000080">, </font>SizeOf<font color="#000080">(</font>PLogPalette<font color="#000080">) + </font>NumColors <font color="#000080">* </font>SizeOf<font color="#000080">(</font>TPaletteEntry<font color="#000080">));
      </font>CreateBiPalette <font color="#000080">:= </font>hPal<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>LoadBMP<font color="#000080">(</font>Name<font color="#000080">: </font>PChar<font color="#000080">; </font>Window<font color="#000080">: </font>hWnd<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>DibPal<font color="#000080">: </font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>var </b></font>Width<font color="#000080">, </font>Height<font color="#000080">: </font>LongInt<font color="#000080">): </font>hBitMap<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>BitMapFileHeader<font color="#000080">: </font>TBitMapFileHeader<font color="#000080">;
  </font>DibSize<font color="#000080">, </font>ReadSize<font color="#000080">, </font>ColorTableSize<font color="#000080">, </font>TempReadSize<font color="#000080">: </font>LongInt<font color="#000080">;
  </font>DIB<font color="#000080">: </font>PBitMapInfoHeader<font color="#000080">;
  </font>TempDib<font color="#000080">: </font>Pointer<font color="#000080">;
  </font>Bits<font color="#000080">: </font>Pointer<font color="#000080">;
  </font>F<font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>BitMap<font color="#000080">: </font>hBitMap<font color="#000080">;
  </font>Handle<font color="#000080">: </font>Word<font color="#000080">;
  </font>DC<font color="#000080">: </font>hDC<font color="#000080">;
  </font>OldCursor<font color="#000080">: </font>HCursor<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Assign<font color="#000080">(</font>F<font color="#000080">, </font>Name<font color="#000080">);
  </font><font color="#008000"><i>{$I-}</i></font>Reset<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);</font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>if </b></font>IOResult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>LoadBMP <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>OldCursor <font color="#000080">:= </font>SetCursor<font color="#000080">(</font>LoadCursor<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>IDC_Wait<font color="#000080">));
  </font>BlockRead<font color="#000080">(</font>F<font color="#000080">, </font>BitMapFileHeader<font color="#000080">, </font>SizeOf<font color="#000080">(</font>BitMapFileHeader<font color="#000080">));
  </font>DibSize <font color="#000080">:= </font>BitMapFileHeader<font color="#000080">.</font>bfSize <font color="#000080">- </font>BitMapFileHeader<font color="#000080">.</font>bfOffBits<font color="#000080">;
  </font>ReadSize <font color="#000080">:= </font>LongInt<font color="#000080">(</font>BitMapFileHeader<font color="#000080">.</font>bfSize<font color="#000080">) - </font>SizeOf<font color="#000080">(</font>BitMapFileHeader<font color="#000080">);
  </font>Handle <font color="#000080">:= </font>GlobalAlloc<font color="#000080">(</font>GMem_Moveable<font color="#000080">, </font>ReadSize<font color="#000080">);
  </font>DIB <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>Handle<font color="#000080">);
  </font>TempReadSize <font color="#000080">:= </font>ReadSize<font color="#000080">;
  </font>TempDib <font color="#000080">:= </font>Dib<font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>TempReadSize <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>do
  begin
    if </b></font>TempReadSize <font color="#000080">&gt; </font><font color="#800000">$8000 </font><font color="#FF0000"><b>then
    begin
      </b></font>BlockRead<font color="#000080">(</font>F<font color="#000080">, </font>TempDIB<font color="#000080">^, </font><font color="#800000">$8000</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Ofs<font color="#000080">(</font>TempDib<font color="#000080">^) = </font><font color="#800000">$8000 </font><font color="#FF0000"><b>then
         </b></font>TempDib <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>TempDib<font color="#000080">^) + </font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">)
      </font><font color="#FF0000"><b>else
         </b></font>TempDib <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>TempDib<font color="#000080">^), </font><font color="#800000">$8000</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
    else
      </b></font>BlockRead<font color="#000080">(</font>F<font color="#000080">, </font>TempDIB<font color="#000080">^, </font>TempReadSize<font color="#000080">);
    </font>Dec<font color="#000080">(</font>TempReadSize<font color="#000080">, </font><font color="#800000">$8000</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>DIB<font color="#000080">^.</font>biBitCount <font color="#000080">= </font><font color="#800000">24 </font><font color="#FF0000"><b>then
    </b></font>ColorTableSize <font color="#000080">:= </font><font color="#800000">0
  </font><font color="#FF0000"><b>else
    </b></font>ColorTableSize <font color="#000080">:= </font>LongInt<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>shl </b></font>DIB<font color="#000080">^.</font>biBitCount <font color="#000080">* </font>SizeOf<font color="#000080">(</font>TRGBQuad<font color="#000080">);
  </font>Bits <font color="#000080">:= </font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>DIB<font color="#000080">^), </font>Ofs<font color="#000080">(</font>DIB<font color="#000080">^) + </font>DIB<font color="#000080">^.</font>biSize <font color="#000080">+ </font>ColorTableSize<font color="#000080">);
  </font>Close<font color="#000080">(</font>F<font color="#000080">);
  </font>DC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>Window<font color="#000080">);
  </font>DibPal <font color="#000080">:= </font>CreateBIPalette<font color="#000080">(</font>DIB<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>DibPal <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>SelectPalette<font color="#000080">(</font>DC<font color="#000080">, </font>DibPal<font color="#000080">, </font>false<font color="#000080">);
    </font>RealizePalette<font color="#000080">(</font>DC<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>BitMap <font color="#000080">:= </font>CreateDIBitMap<font color="#000080">(</font>DC<font color="#000080">, </font>DIB<font color="#000080">^, </font>cbm_Init<font color="#000080">, </font>Bits<font color="#000080">, </font>PBitMapInfo<font color="#000080">(</font>Dib<font color="#000080">)^,
    </font>dib_RGB_Colors<font color="#000080">);
  </font>Height <font color="#000080">:= </font>DIB<font color="#000080">^.</font>biHeight<font color="#000080">;
  </font>Width <font color="#000080">:= </font>DIB<font color="#000080">^.</font>biWidth<font color="#000080">;
  </font>ReleaseDC<font color="#000080">(</font>Window<font color="#000080">, </font>DC<font color="#000080">);
  </font>GlobalUnLock<font color="#000080">(</font>Handle<font color="#000080">);
  </font>GlobalFree<font color="#000080">(</font>Handle<font color="#000080">);
  </font>LoadBMP <font color="#000080">:= </font>BitMap<font color="#000080">;
  </font>SetCursor<font color="#000080">(</font>OldCursor<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0009.PAS">Original</a><b>]</b></p></body>
</html>
