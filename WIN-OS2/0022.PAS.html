<html>
<head><title> "Extended GetDriveType" by DOUG WEGSCHEID</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
        Extended GetDriveType for Windows 3.0/3.1.

        Code ported the C in Microsoft PSS document Q105922.

        Doug Wegscheid 3/22/94.
*)

{$DEFINE TEST}        { undefine to make a unit }

{$IFDEF TEST}
</i></font><font color="#FF0000"><b>program </b></font>drivetyp<font color="#000080">;
</font><font color="#FF0000"><b>uses </b></font>wincrt<font color="#000080">, </font>windos<font color="#000080">, </font>winprocs<font color="#000080">, </font>wintypes<font color="#000080">;
</font><font color="#008000"><i>{$ELSE TEST}
</i></font><font color="#FF0000"><b>unit </b></font>drivetyp<font color="#000080">;

</font><font color="#FF0000"><b>interface
</b></font><font color="#008000"><i>{$ENDIF}

{ Return values of GetDriveTypeEx(). }
</i></font><font color="#FF0000"><b>const
 </b></font>EX_DRIVE_INVALID    <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
 </font>EX_DRIVE_REMOVABLE  <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
 </font>EX_DRIVE_FIXED      <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;
 </font>EX_DRIVE_REMOTE     <font color="#000080">= </font><font color="#800000">3</font><font color="#000080">;
 </font>EX_DRIVE_CDROM      <font color="#000080">= </font><font color="#800000">4</font><font color="#000080">;
 </font>EX_DRIVE_FLOPPY     <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">;
 </font>EX_DRIVE_RAMDISK    <font color="#000080">= </font><font color="#800000">6</font><font color="#000080">;

</font><font color="#008000"><i>{$IFNDEF TEST}
</i></font><font color="#FF0000"><b>function </b></font>GetDriveTypeEx <font color="#000080">(</font>nDrive <font color="#000080">: </font>integer<font color="#000080">) : </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>implementation
uses </b></font>windos<font color="#000080">, </font>winprocs<font color="#000080">, </font>wintypes<font color="#000080">;
</font><font color="#008000"><i>{$ENDIF}

{
 See the &quot;MS-DOS Programmer's Reference&quot; for further information
 about this structure. It is the structure returned with an IOCTL
 $0D function, $60 subfunction (get device parameters).
}
</i></font><font color="#FF0000"><b>type
 </b></font>DeviceParams <font color="#000080">= </font><font color="#FF0000"><b>record
  </b></font>bSpecFunc        <font color="#000080">: </font>byte<font color="#000080">;                </font><font color="#008000"><i>{ Special functions }
  </i></font>bDevType        <font color="#000080">: </font>byte<font color="#000080">;                </font><font color="#008000"><i>{ Device type }
  </i></font>wDevAttr        <font color="#000080">: </font>word<font color="#000080">;         </font><font color="#008000"><i>{ Device attributes }
  </i></font>wCylinders        <font color="#000080">: </font>word<font color="#000080">;                </font><font color="#008000"><i>{ Number of cylinders }
  </i></font>bMediaType        <font color="#000080">: </font>byte<font color="#000080">;                </font><font color="#008000"><i>{ Media type }
  { Beginning of BIOS parameter block (BPB) }
  </i></font>wBytesPerSec        <font color="#000080">: </font>word<font color="#000080">;                </font><font color="#008000"><i>{ Bytes per sector }
  </i></font>bSecPerClust        <font color="#000080">: </font>byte<font color="#000080">;                </font><font color="#008000"><i>{ Sectors per cluster }
  </i></font>wResSectors        <font color="#000080">: </font>word<font color="#000080">;              </font><font color="#008000"><i>{ Number of reserved sectors }
  </i></font>bFATs                <font color="#000080">: </font>byte<font color="#000080">;         </font><font color="#008000"><i>{ Number of FATs }
  </i></font>wRootDirEnts        <font color="#000080">: </font>word<font color="#000080">;             </font><font color="#008000"><i>{ Number of root-directory entries }
  </i></font>wSectors        <font color="#000080">: </font>word<font color="#000080">;         </font><font color="#008000"><i>{ Total number of sectors }
  </i></font>bMedia        <font color="#000080">: </font>byte<font color="#000080">;         </font><font color="#008000"><i>{ Media descriptor }
  </i></font>wFATsecs        <font color="#000080">: </font>word<font color="#000080">;         </font><font color="#008000"><i>{ Number of sectors per FAT }
  </i></font>wSecPerTrack        <font color="#000080">: </font>word<font color="#000080">;             </font><font color="#008000"><i>{ Number of sectors per track }
  </i></font>wHeads        <font color="#000080">: </font>word<font color="#000080">;         </font><font color="#008000"><i>{ Number of heads }
  </i></font>dwHiddenSecs        <font color="#000080">: </font>longint<font color="#000080">;             </font><font color="#008000"><i>{ Number of hidden sectors }
  </i></font>dwHugeSectors        <font color="#000080">: </font>longint<font color="#000080">;            </font><font color="#008000"><i>{ Number of sectors if wSectors == 0 }
  { End of BIOS parameter block (BPB) }
 </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>GetDeviceParameters <font color="#000080">(</font>nDrive <font color="#000080">: </font>integer<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>dp <font color="#000080">: </font>DeviceParams<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>(*
 //-----------------------------------------------------------------
 // GetDeviceParameters()
 //
 // Fills a DeviceParams struct with info about the given drive.
 // Calls DOS IOCTL Get Device Parameters (440Dh, 60h) function.
 //
 // Parameters
 //   nDrive   Drive number  0 = A, 1 = B, 2 = C, and so on.
 //   dp       A structure that will contain the drive's parameters.
 //
 // Returns TRUE if it succeeded, FALSE if it failed.
 //-----------------------------------------------------------------
*)
</i></font><font color="#FF0000"><b>var
 </b></font>r                <font color="#000080">: </font>TRegisters<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>fillchar<font color="#000080">(</font>r<font color="#000080">,</font>sizeof<font color="#000080">(</font>r<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);        </font><font color="#008000"><i>{ clean up registers to avoid GPF }
 </i></font>r<font color="#000080">.</font>ax <font color="#000080">:= </font><font color="#800000">$440d</font><font color="#000080">;                        </font><font color="#008000"><i>{ IOCTL }
 </i></font>r<font color="#000080">.</font>ch <font color="#000080">:= </font><font color="#800000">$08</font><font color="#000080">;                        </font><font color="#008000"><i>{ block device }
 </i></font>r<font color="#000080">.</font>cl <font color="#000080">:= </font><font color="#800000">$60</font><font color="#000080">;                        </font><font color="#008000"><i>{ get device parameters }
 </i></font>r<font color="#000080">.</font>bx <font color="#000080">:= </font>nDrive <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">;                </font><font color="#008000"><i>{ 1 = A:, 2 = B:, etc... }
 </i></font>r<font color="#000080">.</font>ds <font color="#000080">:= </font>seg<font color="#000080">(</font>dp<font color="#000080">); </font>r<font color="#000080">.</font>dx <font color="#000080">:= </font>ofs<font color="#000080">(</font>dp<font color="#000080">);        </font><font color="#008000"><i>{ where... }
 </i></font>msdos<font color="#000080">(</font>r<font color="#000080">);
 </font>GetDeviceParameters <font color="#000080">:= (</font>r<font color="#000080">.</font>flags <font color="#FF0000"><b>and </b></font>fCarry<font color="#000080">) = </font><font color="#800000">0
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>IsCDRomDrive <font color="#000080">(</font>nDrive <font color="#000080">: </font>integer<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#008000"><i>(*
 //-----------------------------------------------------------------
 // IsCDRomDrive()
 //
 // Determines if a drive is a CD-ROM. Calls MSCDEX and checks
 // that MSCDEX is loaded, and that MSCDEX reports the drive is a
 // CD-ROM.
 //
 // Parameters
 //    nDrive    Drive number  0 = A, 1 = B, 2 = C, and so forth.
 //
 // Returns TRUE if nDrive is a CD-ROM drive, FALSE if it isn't.
 //-----------------------------------------------------------------
*)
</i></font><font color="#FF0000"><b>var
 </b></font>r        <font color="#000080">: </font>TRegisters<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>fillchar<font color="#000080">(</font>r<font color="#000080">,</font>sizeof<font color="#000080">(</font>r<font color="#000080">),</font><font color="#800000">#0</font><font color="#000080">);        </font><font color="#008000"><i>{ clean up registers to avoid GPF and
                                  to ensure that BX = $ADAD would not
                                  be by accident }
 </i></font>r<font color="#000080">.</font>ax <font color="#000080">:= </font><font color="#800000">$150b</font><font color="#000080">;                        </font><font color="#008000"><i>{ MSCDEX installation check }
 {
   This function returns whether or not a drive letter is a CD-ROM
   drive supported by MSCDEX. If the extensions are installed, BX
   will be set to ADADh. If the drive letter is supported by
   MSCDEX, then AX is set to a non-zero value. AX is set to zero
   if the drive is not supported. One must be sure to check the
   signature word to know that MSCDEX is installed and that AX
   has not been modified by another INT 2Fh handler.
 }
 </i></font>r<font color="#000080">.</font>cx <font color="#000080">:= </font>nDrive<font color="#000080">;                </font><font color="#008000"><i>{ 0 = A:, 1 = B:, etc... }
 </i></font>intr <font color="#000080">(</font><font color="#800000">$2f</font><font color="#000080">, </font>r<font color="#000080">);                        </font><font color="#008000"><i>{ do it }
 </i></font>IsCDRomDrive <font color="#000080">:= (</font>r<font color="#000080">.</font>bx <font color="#000080">= </font><font color="#800000">$adad</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>r<font color="#000080">.</font>ax <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">)
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>(*
 //-----------------------------------------------------------------
 // GetDriveTypeEx()
 //
 // Determines the type of a drive. Calls Windows's GetDriveType
 // to determine if a drive is valid, fixed, remote, or removeable,
 // then breaks down these categories further to specific device
 // types.
 //
 // Parameters
 //    nDrive    Drive number  0 = A, 1 = B, 2 = C, etc.
 //
 // Returns one of:
 //    EX_DRIVE_INVALID         -- Drive not detected
 //    EX_DRIVE_REMOVABLE       -- Unknown removable-media type drive
 //    EX_DRIVE_FIXED           -- Hard disk drive
 //    EX_DRIVE_REMOTE          -- Remote drive on a network
 //    EX_DRIVE_CDROM           -- CD-ROM drive
 //    EX_DRIVE_FLOPPY          -- Floppy disk drive
 //    EX_DRIVE_RAMDISK         -- RAM disk
 //-----------------------------------------------------------------
*)
</i></font><font color="#FF0000"><b>function </b></font>GetDriveTypeEx <font color="#000080">(</font>nDrive <font color="#000080">: </font>Integer<font color="#000080">) : </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>var
 </b></font>dp        <font color="#000080">: </font>DeviceParams<font color="#000080">;
 </font>utype        <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
 </b></font>fillchar <font color="#000080">(</font>dp<font color="#000080">, </font>sizeof<font color="#000080">(</font>dp<font color="#000080">), </font><font color="#800000">#0</font><font color="#000080">);        </font><font color="#008000"><i>{ clear the DPB }
 </i></font>uType <font color="#000080">:= </font>GetDriveType<font color="#000080">(</font>nDrive<font color="#000080">);        </font><font color="#008000"><i>{ make a rough guess }
 </i></font><font color="#FF0000"><b>case </b></font>uType <font color="#FF0000"><b>of

  </b></font>DRIVE_REMOTE<font color="#000080">:
   </font><font color="#008000"><i>{ GetDriveType() reports CD-ROMs as Remote drives. Need
     to see if the drive is a CD-ROM or a network drive. }
   </i></font><font color="#FF0000"><b>if </b></font>IsCDRomDrive <font color="#000080">(</font>nDrive<font color="#000080">)
    </font><font color="#FF0000"><b>then </b></font>GetDriveTypeEx <font color="#000080">:= </font>EX_DRIVE_CDROM
    <font color="#FF0000"><b>else </b></font>GetDriveTypeEx <font color="#000080">:= </font>EX_DRIVE_REMOTE<font color="#000080">;

  </font>DRIVE_REMOVABLE<font color="#000080">:
   </font><font color="#008000"><i>{
     Check for a floppy disk drive. If it isn't, then we
     don't know what kind of removable media it is.
     For example, could be a Bernoulli box or something new...

     DOS 6.0 Reference says devicetype 0=320/360kb floppy,
     1=1.2Mb, 2=720kb, 3=8&quot; single density, 4=8&quot; double density,
     7=1.44Mb, 8=optical, 9=2.88Mb. Code in Q105922 didn't pick
     up bDevType=9.
   }
   </i></font><font color="#FF0000"><b>if </b></font>GetDeviceParameters <font color="#000080">(</font>nDrive<font color="#000080">, </font>dp<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>dp<font color="#000080">.</font>bDevType <font color="#FF0000"><b>in </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">7</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">])
    </font><font color="#FF0000"><b>then </b></font>GetDriveTypeEx <font color="#000080">:= </font>EX_DRIVE_FLOPPY
    <font color="#FF0000"><b>else </b></font>GetDriveTypeEx <font color="#000080">:= </font>EX_DRIVE_REMOVABLE<font color="#000080">;

  </font>DRIVE_FIXED<font color="#000080">:
   </font><font color="#008000"><i>{
     GetDeviceParameters returns a device type of 0x05 for
     hard disks. Because hard disks and RAM disks are the two
     types of fixed-media drives, we assume that any fixed-
     media drive that isn't a hard disk is a RAM disk.
   }
   </i></font><font color="#FF0000"><b>if </b></font>GetDeviceParameters <font color="#000080">(</font>nDrive<font color="#000080">, </font>dp<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>dp<font color="#000080">.</font>bDevType <font color="#000080">= </font><font color="#800000">5</font><font color="#000080">)
    </font><font color="#FF0000"><b>then </b></font>GetDriveTypeEx <font color="#000080">:= </font>EX_DRIVE_FIXED
    <font color="#FF0000"><b>else </b></font>GetDriveTypeEx <font color="#000080">:= </font>EX_DRIVE_RAMDISK<font color="#000080">;

  </font><font color="#FF0000"><b>else
   </b></font>GetDriveTypeEx <font color="#000080">:= </font>EX_DRIVE_INVALID
 <font color="#FF0000"><b>end
end</b></font><font color="#000080">;

</font><font color="#008000"><i>{$IFDEF TEST}
</i></font><font color="#FF0000"><b>var
 </b></font>i<font color="#000080">, </font>d        <font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
 for </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font><font color="#800000">25
  </font><font color="#FF0000"><b>do begin
   </b></font>d <font color="#000080">:= </font>GetDriveTypeEx<font color="#000080">(</font>i<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>d <font color="#000080">&lt;&gt; </font>EX_DRIVE_INVALID
    <font color="#FF0000"><b>then begin
     </b></font>write <font color="#000080">(</font>chr<font color="#000080">(</font>i <font color="#000080">+ </font>ord<font color="#000080">(</font><font color="#800000">'A'</font><font color="#000080">)), </font><font color="#800000">': '</font><font color="#000080">);
     </font><font color="#FF0000"><b>case </b></font>GetDriveTypeEx<font color="#000080">(</font>i<font color="#000080">) </font><font color="#FF0000"><b>of
      </b></font>EX_DRIVE_REMOVABLE<font color="#000080">:        </font>Writeln <font color="#000080">(</font><font color="#800000">'Removable'</font><font color="#000080">);
      </font>EX_DRIVE_FIXED<font color="#000080">:                </font>Writeln <font color="#000080">(</font><font color="#800000">'Harddisk'</font><font color="#000080">);
      </font>EX_DRIVE_REMOTE<font color="#000080">:                </font>Writeln <font color="#000080">(</font><font color="#800000">'Network'</font><font color="#000080">);
      </font>EX_DRIVE_CDROM<font color="#000080">:                </font>Writeln <font color="#000080">(</font><font color="#800000">'CDROM'</font><font color="#000080">);
      </font>EX_DRIVE_FLOPPY<font color="#000080">:                </font>Writeln <font color="#000080">(</font><font color="#800000">'Floppy'</font><font color="#000080">);
      </font>EX_DRIVE_RAMDISK<font color="#000080">:                </font>Writeln <font color="#000080">(</font><font color="#800000">'RAMdisk'</font><font color="#000080">)
     </font><font color="#FF0000"><b>end
    end
  end
</b></font><font color="#008000"><i>{$ENDIF}
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0022.PAS">Original</a><b>]</b></p></body>
</html>
