<html>
<head><title> "Simple Termianl emulator for WINDOWS" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0052.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
  This program demonstrates a simple terminal emulator using
  Serial Communications.  Windows provides support for the
  communications port so your program will be able to poll the
  port and send/recieve data from a remote location.

  Since this is not a program that Borland International has
  developed through normal quality channels, we do not provide
  technical support or establish bug lists for this demonstration
  program.  It is for the sole purpose of demonstrating the use
  of the available functions.
}


</i></font><font color="#FF0000"><b>Program </b></font>Terminal<font color="#000080">;

</font><font color="#FF0000"><b>uses </b></font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>WObjects<font color="#000080">, </font>Strings<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>idEdit     <font color="#000080">= </font><font color="#800000">100</font><font color="#000080">;
  </font>LineWidth  <font color="#000080">= </font><font color="#800000">80</font><font color="#000080">;  </font><font color="#008000"><i>{ Width of each line displayed.                  }
  </i></font>LineHeight <font color="#000080">= </font><font color="#800000">60</font><font color="#000080">;  </font><font color="#008000"><i>{ Number of lines that are held in memory.       }

  { The configuration string below is used to configure the modem.  }
  { It is set for communication port 2, 2400 baud, No parity, 8 data }
  { bits, 1 stop bit.                                                }

  </i></font>Config <font color="#000080">= </font><font color="#800000">'com2:24,n,8,1'</font><font color="#000080">;
  </font>CPort <font color="#000080">= </font><font color="#800000">'com2'</font><font color="#000080">;

  </font><font color="#008000"><i>{ An example of using communication port 1, 1200 baud, Even parity }
  { 7 data bits, 2 stop bits.                                        }
  {  Config = 'com1:12,e,7,2';                                       }


</i></font><font color="#FF0000"><b>type
  </b></font>TApp <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TApplication<font color="#000080">)
    </font><font color="#FF0000"><b>procedure </b></font>Idle<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>InitMainWindow<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>MessageLoop<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PBuffer <font color="#000080">= ^</font>TBuffer<font color="#000080">;
  </font>TBuffer <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TCollection<font color="#000080">)
    </font>Pos<font color="#000080">: </font>Integer<font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>AParent<font color="#000080">: </font>PWindow<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>FreeItem<font color="#000080">(</font>Item<font color="#000080">: </font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>PutChar<font color="#000080">(</font>C<font color="#000080">: </font>Char<font color="#000080">): </font>Boolean<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>PCommWindow <font color="#000080">= ^</font>TCommWindow<font color="#000080">;
  </font>TCommWindow <font color="#000080">= </font><font color="#FF0000"><b>object</b></font><font color="#000080">(</font>TWindow<font color="#000080">)
    </font>Cid<font color="#000080">: </font>Integer<font color="#000080">;
    </font>Buffer<font color="#000080">: </font>PBuffer<font color="#000080">;
    </font>FontRec<font color="#000080">: </font>TLogFont<font color="#000080">;
    </font>CharHeight<font color="#000080">: </font>Integer<font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>AParent<font color="#000080">: </font>PWindowsObject<font color="#000080">; </font>ATitle<font color="#000080">: </font>PChar<font color="#000080">);
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Error<font color="#000080">(</font>E<font color="#000080">: </font>Integer<font color="#000080">; </font>C<font color="#000080">: </font>PChar<font color="#000080">);
    </font><font color="#FF0000"><b>procedure </b></font>Paint<font color="#000080">(</font>PaintDC<font color="#000080">: </font>HDC<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>PaintInfo<font color="#000080">: </font>TPaintStruct<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>ReadChar<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>SetHeight<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>SetUpWindow<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>wmChar<font color="#000080">(</font><font color="#FF0000"><b>var Message</b></font><font color="#000080">: </font>TMessage<font color="#000080">);
      </font><font color="#FF0000"><b>virtual </b></font>wm_Char<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>wmSize<font color="#000080">(</font><font color="#FF0000"><b>var Message</b></font><font color="#000080">: </font>TMessage<font color="#000080">);
      </font><font color="#FF0000"><b>virtual </b></font>wm_Size<font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>WriteChar<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ TBuffer }
{ The Buffer is used to hold each line that is displayed in the main   }
{ window.  The constant LineHeight determines the number of lines that }
{ are stored.  The Buffer is preloaded with the LineHeight worth of    }
{ lines.                                                               }
</i></font><font color="#FF0000"><b>constructor </b></font>TBuffer<font color="#000080">.</font>Init<font color="#000080">(</font>AParent<font color="#000080">: </font>PWindow<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>P<font color="#000080">: </font>PChar<font color="#000080">;
  </font>I<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TCollection<font color="#000080">.</font>Init<font color="#000080">(</font>LineHeight <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">10</font><font color="#000080">);
  </font>GetMem<font color="#000080">(</font>P<font color="#000080">, </font>LineWidth <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
  </font>P<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;
  </font>Pos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Insert<font color="#000080">(</font>P<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>LineHeight <font color="#FF0000"><b>do
  begin
    </b></font>GetMem<font color="#000080">(</font>P<font color="#000080">, </font>LineWidth <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
    </font>P<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;
    </font>Insert<font color="#000080">(</font>P<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TBuffer<font color="#000080">.</font>FreeItem<font color="#000080">(</font>Item<font color="#000080">: </font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>FreeMem<font color="#000080">(</font>Item<font color="#000080">, </font>LineWidth <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ This procedure processes all incomming in formation from the comm }
{ port.  This procedure is called by TCommWindow.ReadChar.           }

</i></font><font color="#FF0000"><b>function </b></font>TBuffer<font color="#000080">.</font>PutChar<font color="#000080">(</font>C<font color="#000080">: </font>Char<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Width<font color="#000080">: </font>Integer<font color="#000080">;
  </font>P<font color="#000080">: </font>PChar<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>PutChar <font color="#000080">:= </font>False<font color="#000080">;
  </font><font color="#FF0000"><b>Case </b></font>C <font color="#FF0000"><b>of
    </b></font><font color="#800000">#13</font><font color="#000080">: </font>Pos <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                          </font><font color="#008000"><i>{ if a Carriage Return.  }
    </i></font><font color="#800000">#10</font><font color="#000080">:                                    </font><font color="#008000"><i>{ if a Line Feed.        }
      </i></font><font color="#FF0000"><b>begin
        </b></font>GetMem<font color="#000080">(</font>P<font color="#000080">, </font>LineWidth <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
        </font>FillChar<font color="#000080">(</font>P<font color="#000080">^, </font>LineWidth <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">' '</font><font color="#000080">);
        </font>P<font color="#000080">[</font>Pos<font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;
        </font>Insert<font color="#000080">(</font>P<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#800000">#8</font><font color="#000080">:
      </font><font color="#FF0000"><b>if </b></font>Pos <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then                       </b></font><font color="#008000"><i>{ if a Delete.           }
      </i></font><font color="#FF0000"><b>begin
        </b></font>Dec<font color="#000080">(</font>Pos<font color="#000080">);
        </font>P <font color="#000080">:= </font>At<font color="#000080">(</font>Count <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">);
        </font>P<font color="#000080">[</font>Pos<font color="#000080">] := </font><font color="#800000">' '</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#800000">#32</font><font color="#000080">..</font><font color="#800000">#128</font><font color="#000080">:                               </font><font color="#008000"><i>{ else handle all other  }
    </i></font><font color="#FF0000"><b>begin                                   </b></font><font color="#008000"><i>{ displayable characters.}
      </i></font>P <font color="#000080">:= </font>At<font color="#000080">(</font>Count <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">);
      </font>Width <font color="#000080">:= </font>StrLen<font color="#000080">(</font>P<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Width <font color="#000080">&gt; </font>LineWidth <font color="#FF0000"><b>then             </b></font><font color="#008000"><i>{ if line is to wide     }
      </i></font><font color="#FF0000"><b>begin                                 </b></font><font color="#008000"><i>{ create a new line.     }
        </i></font>Pos <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
        </font>GetMem<font color="#000080">(</font>P<font color="#000080">, </font>LineWidth <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);
        </font>P<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>C<font color="#000080">;
        </font>P<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;
        </font>Insert<font color="#000080">(</font>P<font color="#000080">);
      </font><font color="#FF0000"><b>end
      else                                   </b></font><font color="#008000"><i>{ else add character    }
      </i></font><font color="#FF0000"><b>begin                                  </b></font><font color="#008000"><i>{ to current line.      }
        </i></font>P<font color="#000080">[</font>Pos<font color="#000080">] := </font>C<font color="#000080">;
        </font>Inc<font color="#000080">(</font>Pos<font color="#000080">);
        </font>P<font color="#000080">[</font>Pos<font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Count <font color="#000080">&gt; </font>LineHeight <font color="#FF0000"><b>then                 </b></font><font color="#008000"><i>{ if more to many lines }
  </i></font><font color="#FF0000"><b>begin                                      </b></font><font color="#008000"><i>{ have been added delete}
    </i></font>AtFree<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);                               </font><font color="#008000"><i>{ current line and let  }
    </i></font>PutChar <font color="#000080">:= </font>True<font color="#000080">;                         </font><font color="#008000"><i>{ the call procedure    }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                                       </font><font color="#008000"><i>{ know to scroll up.    }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ TCommWindow }
{ The CommWindow displays the incoming and out goinging text.  Note   }
{ that the text type by the use is displayed by                      }
{ being echoed back to the ReadChar procedure.  So there is no need for }
{ wmChar to write a character to the screen.                          }
</i></font><font color="#FF0000"><b>constructor </b></font>TCommWindow<font color="#000080">.</font>Init<font color="#000080">(</font>AParent<font color="#000080">: </font>PWindowsObject<font color="#000080">; </font>ATitle<font color="#000080">: </font>PChar<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>TWindow<font color="#000080">.</font>Init<font color="#000080">(</font>AParent<font color="#000080">, </font>ATitle<font color="#000080">);
  </font>Attr<font color="#000080">.</font>Style <font color="#000080">:= </font>Attr<font color="#000080">.</font>Style <font color="#FF0000"><b>or </b></font>ws_VScroll<font color="#000080">;
  </font>Scroller <font color="#000080">:= </font>New<font color="#000080">(</font>PScroller<font color="#000080">, </font>Init<font color="#000080">(@</font>Self<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">100</font><font color="#000080">, </font><font color="#800000">100</font><font color="#000080">));
  </font>Buffer <font color="#000080">:= </font>New<font color="#000080">(</font>PBuffer<font color="#000080">, </font>Init<font color="#000080">(@</font>Self<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Close the Comm port and deallocate the Buffer.                      }
</i></font><font color="#FF0000"><b>destructor </b></font>TCommWindow<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Error<font color="#000080">(</font>CloseComm<font color="#000080">(</font>Cid<font color="#000080">), </font><font color="#800000">'Close'</font><font color="#000080">);
  </font>Dispose<font color="#000080">(</font>Buffer<font color="#000080">, </font>Done<font color="#000080">);
  </font>TWindow<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Checks for comm errors and writes any errors.                       }
</i></font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>Error<font color="#000080">(</font>E<font color="#000080">: </font>Integer<font color="#000080">; </font>C<font color="#000080">: </font>PChar<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>S<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">100</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>E <font color="#000080">&gt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
  </font>Str<font color="#000080">(</font>E<font color="#000080">, </font>S<font color="#000080">);
  </font>MessageBox<font color="#000080">(</font>GetFocus<font color="#000080">, </font>S<font color="#000080">, </font>C<font color="#000080">, </font>mb_Ok<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Redraw all the lines in the buffer by using ForEach.                }
</i></font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>Paint<font color="#000080">(</font>PaintDC<font color="#000080">: </font>HDC<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>PaintInfo<font color="#000080">: </font>TPaintStruct<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">: </font>Integer<font color="#000080">;
  </font>Font<font color="#000080">: </font>HFont<font color="#000080">;

  </font><font color="#FF0000"><b>procedure </b></font>WriteOut<font color="#000080">(</font>Item<font color="#000080">: </font>PChar<font color="#000080">); </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>begin
    </b></font>TextOut<font color="#000080">(</font>PaintDC<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>CharHeight <font color="#000080">* </font>I<font color="#000080">, </font>Item<font color="#000080">, </font>StrLen<font color="#000080">(</font>Item<font color="#000080">));
    </font>inc<font color="#000080">(</font>I<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>I <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>Font <font color="#000080">:= </font>SelectObject<font color="#000080">(</font>PaintDC<font color="#000080">, </font>CreateFontIndirect<font color="#000080">(</font>FontRec<font color="#000080">));
  </font>Buffer<font color="#000080">^.</font>ForEach<font color="#000080">(@</font>WriteOut<font color="#000080">);
  </font>DeleteObject<font color="#000080">(</font>SelectObject<font color="#000080">(</font>PaintDC<font color="#000080">, </font>Font<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Read a charecter from the comm port, if there is no error then call }
{ Buffer^.PutChar to add it to the buffer and write it to the screen. }
</i></font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>ReadChar<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Stat<font color="#000080">: </font>TComStat<font color="#000080">;
  </font>I<font color="#000080">, </font>Size<font color="#000080">: </font>Integer<font color="#000080">;
  </font>C<font color="#000080">: </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetCommError<font color="#000080">(</font>CID<font color="#000080">, </font>Stat<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Stat<font color="#000080">.</font>cbInQue <font color="#FF0000"><b>do
  begin
    </b></font>Size <font color="#000080">:= </font>ReadComm<font color="#000080">(</font>CId<font color="#000080">, @</font>C<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>Error<font color="#000080">(</font>Size<font color="#000080">, </font><font color="#800000">'Read Comm'</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>C <font color="#000080">&lt;&gt; </font><font color="#800000">#0 </font><font color="#FF0000"><b>then
    begin
      if </b></font>Buffer<font color="#000080">^.</font>PutChar<font color="#000080">(</font>C<font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>ScrollWindow<font color="#000080">(</font>HWindow<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, -</font>CharHeight<font color="#000080">, </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">, </font><font color="#FF0000"><b>Nil</b></font><font color="#000080">);
        </font>UpDateWindow<font color="#000080">(</font>HWindow<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>WriteChar<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>SetUpWindow<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>DCB<font color="#000080">: </font>TDCB<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>TWindow<font color="#000080">.</font>SetUpWindow<font color="#000080">;
  </font>SetHeight<font color="#000080">;

</font><font color="#008000"><i>{ Open for Comm2 2400 Baud, No Parity, 8 Data Bits, 1 Stop Bit }

  </i></font>BuildCommDCB<font color="#000080">(</font>Config<font color="#000080">, </font>DCB<font color="#000080">);
  </font>Cid <font color="#000080">:= </font>OpenComm<font color="#000080">(</font><font color="#800000">'COM2'</font><font color="#000080">, </font><font color="#800000">1024</font><font color="#000080">, </font><font color="#800000">1024</font><font color="#000080">);
  </font>Error<font color="#000080">(</font>Cid<font color="#000080">, </font><font color="#800000">'Open'</font><font color="#000080">);
  </font>DCB<font color="#000080">.</font>ID <font color="#000080">:= </font>CID<font color="#000080">;
  </font>Error<font color="#000080">(</font>SetCommState<font color="#000080">(</font>DCB<font color="#000080">), </font><font color="#800000">'Set Comm State'</font><font color="#000080">);
  </font>WriteComm<font color="#000080">(</font>Cid<font color="#000080">, </font><font color="#800000">'ATZ'#13#10</font><font color="#000080">, </font><font color="#800000">5</font><font color="#000080">);  </font><font color="#008000"><i>{ Send a reset to Modem. }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Call back function used only in to get record structure for fixed   }
{ width font.                                                         }
</i></font><font color="#FF0000"><b>function </b></font>GetFont<font color="#000080">(</font>LogFont<font color="#000080">: </font>PLogFont<font color="#000080">; </font>TM<font color="#000080">: </font>PTextMetric<font color="#000080">; </font>FontType<font color="#000080">: </font>Word<font color="#000080">;
  </font>P<font color="#000080">: </font>PCommWindow<font color="#000080">): </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>P<font color="#000080">^.</font>CharHeight <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>P<font color="#000080">^.</font>FontRec <font color="#000080">:= </font>LogFont<font color="#000080">^;
    </font>P<font color="#000080">^.</font>CharHeight <font color="#000080">:= </font>P<font color="#000080">^.</font>FontRec<font color="#000080">.</font>lfHeight<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Get the a fixed width font to use in the TCommWindow.  Use EnumFonts  }
{ to save work of create the FontRec by hand.                         }
{ The TScroller of the main window is also updated know that the font }
{ height is known.                                                    }

</i></font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>SetHeight<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>DC<font color="#000080">: </font>HDC<font color="#000080">;
  </font>ProcInst<font color="#000080">: </font>Pointer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>HWindow<font color="#000080">);
  </font>CharHeight <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>ProcInst <font color="#000080">:= </font>MakeProcInstance<font color="#000080">(@</font>GetFont<font color="#000080">, </font>HInstance<font color="#000080">);
  </font>EnumFonts<font color="#000080">(</font>DC<font color="#000080">, </font><font color="#800000">'Courier'</font><font color="#000080">, </font>ProcInst<font color="#000080">, @</font>Self<font color="#000080">);
  </font>FreeProcInstance<font color="#000080">(</font>ProcInst<font color="#000080">);
  </font>ReleaseDC<font color="#000080">(</font>HWindow<font color="#000080">, </font>DC<font color="#000080">);

  </font>Scroller<font color="#000080">^.</font>SetUnits<font color="#000080">(</font>CharHeight<font color="#000080">, </font>CharHeight<font color="#000080">);
  </font>Scroller<font color="#000080">^.</font>SetRange<font color="#000080">(</font>LineWidth<font color="#000080">, </font>LineHeight<font color="#000080">);
  </font>Scroller<font color="#000080">^.</font>ScrollTo<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>LineHeight<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Write the character from the pressed key to the Communication Port.   }
</i></font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>wmChar<font color="#000080">(</font><font color="#FF0000"><b>var Message</b></font><font color="#000080">: </font>TMessage<font color="#000080">);
</font><font color="#FF0000"><b>begin
  if </b></font>CID <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>Error<font color="#000080">(</font>WriteComm<font color="#000080">(</font>CId<font color="#000080">, @</font><font color="#FF0000"><b>Message</b></font><font color="#000080">.</font>wParam<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">), </font><font color="#800000">'Writing'</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>wmSize<font color="#000080">(</font><font color="#FF0000"><b>var Message</b></font><font color="#000080">: </font>TMessage<font color="#000080">);
</font><font color="#FF0000"><b>begin
  </b></font>TWindow<font color="#000080">.</font>wmSize<font color="#000080">(</font><font color="#FF0000"><b>Message</b></font><font color="#000080">);
  </font>Scroller<font color="#000080">^.</font>SetRange<font color="#000080">(</font>LineWidth<font color="#000080">, </font>LineHeight <font color="#000080">-
                    (</font><font color="#FF0000"><b>Message</b></font><font color="#000080">.</font>lParamhi <font color="#FF0000"><b>div </b></font>CharHeight<font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TCommWindow<font color="#000080">.</font>WriteChar<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>DC<font color="#000080">: </font>HDC<font color="#000080">;
  </font>Font<font color="#000080">: </font>HFont<font color="#000080">;
  </font>S<font color="#000080">: </font>PChar<font color="#000080">;
  </font>APos<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>APos <font color="#000080">:= </font>Buffer<font color="#000080">^.</font>Count <font color="#000080">- </font><font color="#800000">1</font><font color="#000080">;
  </font>S <font color="#000080">:= </font>Buffer<font color="#000080">^.</font>AT<font color="#000080">(</font>APos<font color="#000080">);
  </font>APos <font color="#000080">:= (</font>APos <font color="#000080">- </font>Scroller<font color="#000080">^.</font>YPos<font color="#000080">) * </font>CharHeight<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>APos <font color="#000080">&lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>exit<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>Hwindow <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>DC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>HWindow<font color="#000080">);
    </font>Font <font color="#000080">:= </font>SelectObject<font color="#000080">(</font>DC<font color="#000080">, </font>CreateFontIndirect<font color="#000080">(</font>FontRec<font color="#000080">));
    </font>TextOut<font color="#000080">(</font>DC<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>APos<font color="#000080">, </font>S<font color="#000080">, </font>StrLen<font color="#000080">(</font>S<font color="#000080">));
    </font>DeleteObject<font color="#000080">(</font>SelectObject<font color="#000080">(</font>DC<font color="#000080">, </font>Font<font color="#000080">));
    </font>ReleaseDC<font color="#000080">(</font>HWindow<font color="#000080">, </font>DC<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ TApp }
</i></font><font color="#FF0000"><b>procedure </b></font>TApp<font color="#000080">.</font>Idle<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Stat<font color="#000080">: </font>TComStat<font color="#000080">;
  </font>I<font color="#000080">, </font>Size<font color="#000080">: </font>Integer<font color="#000080">;
  </font>C<font color="#000080">: </font>Char<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>MainWindow <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>Nil then
    if </b></font>MainWindow<font color="#000080">^.</font>HWindow <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      </b></font>PCommWindow<font color="#000080">(</font>MainWindow<font color="#000080">)^.</font>ReadChar<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TApp<font color="#000080">.</font>InitMainWindow<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>MainWindow <font color="#000080">:= </font>New<font color="#000080">(</font>PCommWindow<font color="#000080">, </font>Init<font color="#000080">(</font><font color="#FF0000"><b>Nil</b></font><font color="#000080">, </font><font color="#800000">'Comm Test'</font><font color="#000080">));
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Add Idle loop to main message loop used for polling.               }
</i></font><font color="#FF0000"><b>procedure </b></font>TApp<font color="#000080">.</font>MessageLoop<font color="#000080">;
</font><font color="#FF0000"><b>var
  Message</b></font><font color="#000080">: </font>TMsg<font color="#000080">;
</font><font color="#FF0000"><b>begin
  while </b></font>True <font color="#FF0000"><b>do
  begin
    if </b></font>PeekMessage<font color="#000080">(</font><font color="#FF0000"><b>Message</b></font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>pm_Remove<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      if Message</b></font><font color="#000080">.</font><font color="#FF0000"><b>Message </b></font><font color="#000080">= </font>wm_Quit <font color="#FF0000"><b>then
      begin
        </b></font>Status <font color="#000080">:= </font><font color="#FF0000"><b>Message</b></font><font color="#000080">.</font>WParam<font color="#000080">;
        </font>Exit<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>if not </b></font>ProcessAppMsg<font color="#000080">(</font><font color="#FF0000"><b>Message</b></font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        </b></font>TranslateMessage<font color="#000080">(</font><font color="#FF0000"><b>Message</b></font><font color="#000080">);
        </font>DispatchMessage<font color="#000080">(</font><font color="#FF0000"><b>Message</b></font><font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end
    else
      </b></font>Idle<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>App<font color="#000080">: </font>TApp<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>App<font color="#000080">.</font>Init<font color="#000080">(</font><font color="#800000">'Comm'</font><font color="#000080">);
  </font>App<font color="#000080">.</font>Run<font color="#000080">;
  </font>App<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0052.PAS">Original</a><b>]</b></p></body>
</html>
