<html>
<head><title> "MSCDEX DLL" by P. BELOW</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{+------------------------------------------------------------
 | Unit PBCDInt
 |
 | Version: 1.0  Last modified: 02/27/95, 22:09:07
 | Author : P. Below  CIS [100113,1101]
 | Project: Common utilities
 | Description:
 |   This DLL exports a number of functions of the MSCDEX interface
 |	 for the use of other Windows programs. Was originally written
 |	 for a Visual Basic app that needed a method do detect whether
 |	 a given drive is a CD-ROM and whether it contains a CD or not.
 |
 |   Released to public domain
 +------------------------------------------------------------}
</i></font><font color="#FF0000"><b>Library </b></font>PBCDINT<font color="#000080">;

</font><font color="#FF0000"><b>Uses </b></font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>Utils<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>CD_ERROR <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">;
  </font>CD_NOTACDDRIVE <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>CD_DRIVEEMPTY <font color="#000080">= </font><font color="#800000">1</font><font color="#000080">;
  </font>CD_CDFOUND <font color="#000080">= </font><font color="#800000">2</font><font color="#000080">;

</font><font color="#008000"><i>(* returns TRUE if MSCDEX is loaded, False otherwise *)
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Is_MSCDEX_loaded<font color="#000080">: </font>BOOLEAN<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">mov AX, $1500   </font><font color="#008000"><i>(* MSCDEX installed check *)
    </i></font><font color="#FF00FF">xor BX, BX
    int $2F
    xor ax, ax      </font><font color="#008000"><i>(* set default return value to false *)
    </i></font><font color="#FF00FF">or  BX, BX      </font><font color="#008000"><i>(* returns bx &lt;&gt; 0 if MSCDEX installed *)
    </i></font><font color="#FF00FF">jz  @no_mscdex
    mov al, TRUE
  @no_mscdex:
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>(* returns -1 ( VB True ) if drive is CD-ROM, 0 otherwise. 
   drivenum = 1 for A:, 2 for B: etc. *)
</i></font><font color="#FF0000"><b>Function </b></font>CDDriveIsCD<font color="#000080">( </font>drivenum<font color="#000080">: </font>Integer<font color="#000080">): </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    ASM
      </b></font><font color="#FF00FF">mov AX, $150B </font><font color="#008000"><i>(* MSCDEX check drive function *)
      </i></font><font color="#FF00FF">mov CX, drivenum
      sub BX,BX
      int $2F
      cmp bx, $ADAD
      jne @no_cdrom
      or  AX, AX
      jz  @no_cdrom
      mov @result, $FFFF
      jmp @exit
    @no_cdrom:
      mov @result, 0
    @exit:
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;


</font><font color="#008000"><i>(* returns one of the CD_xxx constants. 
   drivenum = 1 for A:, 2 for B: etc. *)
</i></font><font color="#FF0000"><b>Function </b></font>CDDriveStatus<font color="#000080">( </font>drivenum<font color="#000080">: </font>integer <font color="#000080">): </font>integer<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Var
    </b></font>RealModeReg<font color="#000080">: </font>TRealModeReg<font color="#000080">;
    </font>dwGlobalDosBuffer<font color="#000080">: </font>LongInt<font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    If </b></font>CDDriveIsCD<font color="#000080">( </font>drivenum <font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>Then
      </b></font>CDDriveStatus <font color="#000080">:= </font>CD_NOTACDDRIVE
    <font color="#FF0000"><b>Else Begin
      </b></font>CDDriveStatus <font color="#000080">:= </font>CD_ERROR<font color="#000080">;
      </font><font color="#008000"><i>{ alloc a buffer for the MSCDEX call to put the copyright filename into.
        this has to reside in low dos memory since the function needs a real mode
        pointer in es:bx. We ignore the info put into the buffer. }
      </i></font>dwGlobalDosBuffer <font color="#000080">:= </font>GlobalDosAlloc<font color="#000080">(</font><font color="#800000">40</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>dwGlobalDosBuffer <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then Begin
        </b></font><font color="#008000"><i>{ initialize the real mode register structure }
        </i></font>FillChar<font color="#000080">(</font>RealModeReg<font color="#000080">, </font>sizeof<font color="#000080">(</font>RealModeReg<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
        </font>RealModeReg<font color="#000080">.</font>rmEAX <font color="#000080">:= </font><font color="#800000">$1502</font><font color="#000080">;
        </font>RealModeReg<font color="#000080">.</font>rmECX <font color="#000080">:= </font>Longint<font color="#000080">(</font>drivenum<font color="#000080">);
        </font>RealModeReg<font color="#000080">.</font>rmES  <font color="#000080">:= </font>HIWORD<font color="#000080">(</font>dwGlobalDosBuffer<font color="#000080">);  </font><font color="#008000"><i>{ real mode segment }
        </i></font>RealModeReg<font color="#000080">.</font>rmEBX <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;         </font><font color="#008000"><i>{ offset is zero }

        { simulate the real mode interrupt. we have to jump thru these hoops
          because loading a real mode segment value into a register in
          protected mode is a sure recipe for a GPF. }
        </i></font><font color="#FF0000"><b>if </b></font>RealInt<font color="#000080">(</font><font color="#800000">$2F</font><font color="#000080">, </font>RealModeReg<font color="#000080">) </font><font color="#FF0000"><b>then
          If </b></font><font color="#000080">(</font>LoWord<font color="#000080">(</font>RealModeReg<font color="#000080">.</font>rmCPUFlags<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#800000">1</font><font color="#000080">) = </font><font color="#800000">0 </font><font color="#FF0000"><b>Then
            </b></font><font color="#008000"><i>{ carry clear, CD drive containing a readable CD }
            </i></font>CDDriveStatus <font color="#000080">:= </font>CD_CDFOUND
          <font color="#FF0000"><b>Else
            If </b></font>LoWord<font color="#000080">( </font>RealModeReg<font color="#000080">.</font>rmEAX <font color="#000080">) = </font><font color="#800000">$F </font><font color="#FF0000"><b>Then
              </b></font><font color="#008000"><i>{ DOS error &quot;invalid drive&quot; }
              </i></font>CDDriveStatus <font color="#000080">:= </font>CD_NOTACDDRIVE
            <font color="#FF0000"><b>Else
              </b></font><font color="#008000"><i>{ normally DOS error 1Eh: read fault }
              </i></font>CDDriveStatus <font color="#000080">:= </font>CD_DRIVEEMPTY<font color="#000080">;
        </font>GlobalDosFree<font color="#000080">(</font>LOWORD<font color="#000080">(</font>dwGlobalDosBuffer<font color="#000080">));
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>(* returns the number of CD drives supported by MSCDEX *)
</i></font><font color="#FF0000"><b>Function </b></font>CDNumberOfDrives<font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    ASM
      </b></font><font color="#FF00FF">mov AX, $1500   </font><font color="#008000"><i>(* MSCDEX installed check *)
      </i></font><font color="#FF00FF">xor BX, BX
      int $2F
      mov @result, bx
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>(* returns the number of the first drive supported by MSCDEX *)
</i></font><font color="#FF0000"><b>Function </b></font>CDFirstDrive<font color="#000080">: </font>Integer<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    ASM
      </b></font><font color="#FF00FF">mov AX, $1500   </font><font color="#008000"><i>(* MSCDEX installed check *)
      </i></font><font color="#FF00FF">xor BX, BX
      int $2F
      mov @result, cx
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>exports
  </b></font>CDDriveStatus    <font color="#FF0000"><b>index </b></font><font color="#800000">1</font><font color="#000080">,
  </font>CDNumberOfDrives <font color="#FF0000"><b>index </b></font><font color="#800000">2</font><font color="#000080">,
  </font>CDFirstDrive     <font color="#FF0000"><b>index </b></font><font color="#800000">3</font><font color="#000080">,
  </font>CDDriveIsCD      <font color="#FF0000"><b>index </b></font><font color="#800000">4</font><font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font><font color="#008000"><i>(* make the fixed DLL data segment moveable *)
  </i></font>GlobalPageUnlock<font color="#000080">( </font>DSeg <font color="#000080">);
  </font>GlobalReAlloc<font color="#000080">(</font>DSeg<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>GMEM_MODIFY <font color="#FF0000"><b>or </b></font>GMEM_MOVEABLE<font color="#000080">);
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p></body>
</html>
