<html>
<head><title> "BPW: how to use ReadComm" by TIMUR KAZIMIROV</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0075.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
 CB&gt; I'm trying to write a simple terminal for Windows with Borland Pascal
7.0. CB&gt; But I don't get it to work. Does someone have a small example/source?
 CB&gt; I know how to send chars to the serial port, that's not the problem. But
 CB&gt; how to display the modem receiving queue? I guess I'll have to use
 CB&gt; ReadComm.. but how?

 CB&gt; Here's how to send characters:

 CB&gt; uses
 CB&gt;   WinProcs, WinTypes, WinCrt;
 CB&gt; var
 CB&gt;   cid: Integer;
 CB&gt;   ch: Char;
 CB&gt; begin
 CB&gt;   cid:=OpenComm('COM2:',1024,1024);
 CB&gt;   if cid&gt;=0 then
 CB&gt;   begin
 CB&gt;     repeat
 CB&gt;       if keypressed then
 CB&gt;        begin
 CB&gt;          Ch:=Readkey;
 CB&gt;          TransmitCommChar(cid,ch);
 CB&gt;        end;

 CB&gt;        { readComm ??? }

 </i></font>CB<font color="#000080">&gt;      </font><font color="#FF0000"><b>until </b></font>ch<font color="#000080">=</font><font color="#800000">#27</font><font color="#000080">;
 </font>CB<font color="#000080">&gt;      </font>CloseComm<font color="#000080">(</font>cid<font color="#000080">);
 </font>CB<font color="#000080">&gt;   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>CB<font color="#000080">&gt; </font><font color="#FF0000"><b>end</b></font><font color="#000080">.


 </font>CB<font color="#000080">&gt; </font>Cornelis

These are samples from Borland<font color="#800000">'s ObjectVision that demonstrate work with COM
</font>ports under Windows<font color="#000080">.

=== </font>Cut <font color="#000080">===
</font><font color="#FF0000"><b>function </b></font>Dial<font color="#000080">(</font>Comport<font color="#000080">, </font>Dialtype<font color="#000080">, </font>Number<font color="#000080">:</font>PChar<font color="#000080">): </font>integer<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>P<font color="#000080">, </font>Config<font color="#000080">, </font>Num<font color="#000080">: </font>PChar<font color="#000080">;
  </font>Struc<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>i<font color="#000080">: </font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Struc <font color="#000080">:= </font><font color="#800000">#0</font><font color="#000080">;
  </font>GetMem<font color="#000080">(</font>Config<font color="#000080">, </font><font color="#800000">20</font><font color="#000080">);
  </font>GetMem<font color="#000080">(</font>P<font color="#000080">, </font><font color="#800000">255</font><font color="#000080">);
  </font>Strcopy<font color="#000080">(@</font>Struc<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>Number<font color="#000080">);
  </font>Struc<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>Char<font color="#000080">(</font>StrLen<font color="#000080">(</font>Number<font color="#000080">));
  </font>Struc <font color="#000080">:= </font>Struc<font color="#000080">+</font><font color="#800000">#0</font><font color="#000080">;
  </font><font color="#008000"><i>{ Strip Routine }
  </i></font>i <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>i <font color="#000080">&lt;= </font>length<font color="#000080">(</font>Struc<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    if </b></font><font color="#000080">(((</font>Struc<font color="#000080">[</font>i<font color="#000080">] &lt; </font><font color="#800000">#48</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Struc<font color="#000080">[</font>i<font color="#000080">] &gt; </font><font color="#800000">#57</font><font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">((</font>Struc<font color="#000080">[</font>i<font color="#000080">] &lt;&gt; </font><font color="#800000">','</font><font color="#000080">))) </font><font color="#FF0000"><b>then
    begin
      </b></font>Delete<font color="#000080">(</font>Struc<font color="#000080">, </font>i<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
      </font>Dec<font color="#000080">(</font>i<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>i <font color="#000080">:= </font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>StrCopy<font color="#000080">(</font>Config<font color="#000080">, </font>Comport<font color="#000080">);
  </font>Config <font color="#000080">:= </font>StrCat<font color="#000080">(</font>Config<font color="#000080">, </font><font color="#800000">':12,n,8,1'</font><font color="#000080">);
  </font>StrLCopy<font color="#000080">(</font>P<font color="#000080">, </font>Dialtype<font color="#000080">, </font><font color="#800000">20</font><font color="#000080">);
  </font>P <font color="#000080">:= </font>StrCat<font color="#000080">(</font>P<font color="#000080">, @</font>Struc<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">]);
  </font>P <font color="#000080">:= </font>StrCat<font color="#000080">(</font>P<font color="#000080">, </font><font color="#800000">#13#10</font><font color="#000080">);
  </font>BuildCommDCB<font color="#000080">(</font>Config<font color="#000080">, </font>DCB<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>CID <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>Cid <font color="#000080">:= </font>OpenComm<font color="#000080">(</font>Comport<font color="#000080">, </font><font color="#800000">1024</font><font color="#000080">, </font><font color="#800000">1024</font><font color="#000080">);
    </font><font color="#FF0000"><b>if not</b></font><font color="#000080">(</font>CID<font color="#000080">&lt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>DCB<font color="#000080">.</font>ID <font color="#000080">:= </font>CID<font color="#000080">;
      </font>SetCommState<font color="#000080">(</font>DCB<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>WriteComm<font color="#000080">(</font>CID<font color="#000080">, </font>p<font color="#000080">, </font>StrLen<font color="#000080">(</font>P<font color="#000080">)) &lt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        </b></font>MessageBox<font color="#000080">(</font>getfocus<font color="#000080">, </font><font color="#800000">'Dial Error'</font><font color="#000080">, </font><font color="#800000">'Error'</font><font color="#000080">, </font>Mb_Ok<font color="#000080">);
        </font>Dial <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">; </font><font color="#008000"><i>{return error}
      </i></font><font color="#FF0000"><b>end
      else
        </b></font>Dial <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">; </font><font color="#008000"><i>{return no error}
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>FreeMem<font color="#000080">(</font>P<font color="#000080">, </font><font color="#800000">255</font><font color="#000080">);
  </font>FreeMem<font color="#000080">(</font>Config<font color="#000080">, </font><font color="#800000">20</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Hangup <font color="#000080">: </font>bool<font color="#000080">; </font><font color="#FF0000"><b>export</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not</b></font><font color="#000080">(</font>CID <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>WriteComm<font color="#000080">(</font>CID<font color="#000080">, </font><font color="#800000">'ATH'#13#10</font><font color="#000080">, </font><font color="#800000">5</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>CloseComm<font color="#000080">(</font>Cid<font color="#000080">) &lt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>MessageBox<font color="#000080">(</font>GetFocus<font color="#000080">, </font><font color="#800000">'Hangup Error'</font><font color="#000080">, </font><font color="#800000">'Error'</font><font color="#000080">, </font>Mb_Ok<font color="#000080">);
      </font>Hangup <font color="#000080">:= </font>bool<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">);
    </font><font color="#FF0000"><b>end
    else
    begin
      </b></font>Cid <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>Hangup <font color="#000080">:= </font>bool<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0075.PAS">Original</a><b>]</b></p></body>
</html>
