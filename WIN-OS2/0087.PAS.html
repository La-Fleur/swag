<html>
<head><title> "Access Long Filename" by DUNCAN MURDOCH</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0087.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>lfn<font color="#000080">;

</font><font color="#008000"><i>{
 This unit allows a Windows 3.x program to access Windows 95
 long file names.  Use the LFNFindFirst and LFNFindNext like
 you would use the corresponding ones for normal file names.
 The only two differences you should note:

   1.  The path is a standard Pascal string, not asciiz.
   2.  These are functions, they return an error code value.
       Codes are standard except 99: o/s not lfn capable.

 Constants LFNAble and WinVersion are available for the
 host application to consult.  The major version is held
 in the low-order byte with the minor version in the
 high-order byte of WinVersion.

 Be sure to LFNFindClose when you have completed the operation.

 credits:
   Duncan Murdoch - assembler code for LFNFindFirst, LFNFindNext
                    and LFNFindClose.
   Michael Feltz  - logic to check windows version and return error
                    if long file names are not supported, conversion
                    to a Pascal unit.
  }


</i></font><font color="#FF0000"><b>Interface

uses </b></font>winprocs<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TLFNSearchRec <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>attr         <font color="#000080">: </font>longint<font color="#000080">;                      
    </font>creation     <font color="#000080">: </font>comp<font color="#000080">;                     
    </font>lastaccess   <font color="#000080">: </font>comp<font color="#000080">;                   
    </font>lastmod      <font color="#000080">: </font>comp<font color="#000080">;             
    </font>highfilesize <font color="#000080">: </font>longint<font color="#000080">;              
    </font>lowfilesize  <font color="#000080">: </font>longint<font color="#000080">;               
    </font>reserved     <font color="#000080">: </font>comp<font color="#000080">;                     
    </font>name         <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">259</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;        
    </font>shortname    <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">13</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;    
    </font>handle       <font color="#000080">: </font>word<font color="#000080">;                       
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;                                   

</font><font color="#FF0000"><b>const                                    
  </b></font>faReadOnly      <font color="#000080">=  </font><font color="#800000">$01</font><font color="#000080">;
  </font>faHidden        <font color="#000080">=  </font><font color="#800000">$02</font><font color="#000080">;
  </font>faSysFile       <font color="#000080">=  </font><font color="#800000">$04</font><font color="#000080">;                
  </font>faVolumeID      <font color="#000080">=  </font><font color="#800000">$08</font><font color="#000080">;
  </font>faDirectory     <font color="#000080">=  </font><font color="#800000">$10</font><font color="#000080">;                
  </font>faArchive       <font color="#000080">=  </font><font color="#800000">$20</font><font color="#000080">;                
  </font>faAnyFile       <font color="#000080">=  </font><font color="#800000">$3F</font><font color="#000080">;
  </font>LFNAble        <font color="#000080">: </font>Boolean <font color="#000080">= </font>True<font color="#000080">;   </font><font color="#008000"><i>{is oper sys long file name able?}
  </i></font>WinVersion     <font color="#000080">: </font>Word <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;         </font><font color="#008000"><i>{windows version}

</i></font><font color="#FF0000"><b>function </b></font>LFNFindFirst <font color="#000080">(</font>filespec<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font>attr<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font>TLFNSearchRec<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>LFNFindNext  <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font>TLFNSearchRec<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>LFNFindClose <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font>TLFNSearchRec<font color="#000080">):</font>integer<font color="#000080">;

</font><font color="#FF0000"><b>Implementation

function </b></font>LFNFindFirst<font color="#000080">(</font>filespec<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font>attr<font color="#000080">:</font>word<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font>TLFNSearchRec<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  If </b></font>LFNAble <font color="#FF0000"><b>then
  begin
    </b></font>filespec <font color="#000080">:= </font>filespec <font color="#000080">+ </font><font color="#800000">#0</font><font color="#000080">;
    </font>S<font color="#000080">.</font>attr <font color="#000080">:= </font>attr<font color="#000080">;                                                        
    </font><font color="#FF0000"><b>asm                                                                    
      </b></font><font color="#FF00FF">push ds                                                              
      push ss                                                              
      pop ds                                                               
      lea dx,filespec+1
      les di,S
      mov ax,$714e                                                         
      mov cx,attr                                                          
      mov si,0
      int $21                                                              
      les di,S
      mov word ptr es:[di+TLFNSearchRec.handle], ax
      jc @1                                                                
      xor ax,ax                                                            
    @1:                                                                    
      mov @result,ax                                                       
      pop ds                                                               
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{asm}                                                                   
  </i></font><font color="#FF0000"><b>end    </b></font><font color="#008000"><i>{if}
  </i></font><font color="#FF0000"><b>else
    </b></font>LFNFindFirst <font color="#000080">:= </font><font color="#800000">99</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;     </font><font color="#008000"><i>{function}
                                                 
</i></font><font color="#FF0000"><b>function </b></font>LFNFindNext<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font>TLFNSearchRec<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  If </b></font>LFNAble <font color="#FF0000"><b>then
  asm                                            
    </b></font><font color="#FF00FF">mov ax,$714f
    mov si,0                                     
    les di,S                                     
    mov bx,word ptr es:[di+TLFNSearchRec.Handle]
    int $21                                      
    jc @1
    xor ax,ax                                    
  @1:                                            
    mov @result,ax                               
  </font><font color="#FF0000"><b>end  </b></font><font color="#008000"><i>{asm}
  </i></font><font color="#FF0000"><b>else
    </b></font>LFNFindNext <font color="#000080">:= </font><font color="#800000">99</font><font color="#000080">;                                          
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;   </font><font color="#008000"><i>{function}                                             
                                                 
</i></font><font color="#FF0000"><b>function </b></font>LFNFindClose<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font>TLFNSearchRec<font color="#000080">):</font>integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  If </b></font>LFNAble <font color="#FF0000"><b>then
  asm                                            
    </b></font><font color="#FF00FF">mov ax,$71a1                                 
    les di,S                                     
    mov bx,word ptr es:[di+TLFNSearchRec.Handle]    
    int $21                                      
    jc @1
    xor ax,ax                                                            
  @1:                                                                    
    mov @result,ax
  </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{asm}
  </i></font><font color="#FF0000"><b>else
    </b></font>LFNFindClose <font color="#000080">:= </font><font color="#800000">99</font><font color="#000080">;                                                                   
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{function}

</i></font><font color="#FF0000"><b>begin
  </b></font>WinVersion <font color="#000080">:= </font>LoWord<font color="#000080">(</font>GetVersion<font color="#000080">);
  </font><font color="#FF0000"><b>If </b></font><font color="#000080">((</font>Lo<font color="#000080">(</font>WinVersion<font color="#000080">) =  </font><font color="#800000">3</font><font color="#000080">)  </font><font color="#FF0000"><b>and                    </b></font><font color="#008000"><i>{windows 95 first}
      </i></font><font color="#000080">(</font>Hi<font color="#000080">(</font>WinVersion<font color="#000080">) &lt; </font><font color="#800000">95</font><font color="#000080">)) </font><font color="#FF0000"><b>or                     </b></font><font color="#008000"><i>{version is 3.95 }
      </i></font><font color="#000080">(</font>Lo<font color="#000080">(</font>WinVersion<font color="#000080">) &lt;  </font><font color="#800000">3</font><font color="#000080">)  </font><font color="#FF0000"><b>then </b></font>LFNAble <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.  </font><font color="#008000"><i>{unit}                                                                        


</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0087.PAS">Original</a><b>]</b></p></body>
</html>
