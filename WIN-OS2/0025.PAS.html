<html>
<head><title> "New EXE Headers" by MICHAEL VINCZE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0025.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
In article 767298319@stimpy.cs.iastate.edu, james@cs.iastate.edu (James N. Potts) writes:
&gt;I know that if you place {$D string} in a program, the string will be placed
&gt;into the executable.  Is there an easy way to find this information, or do
&gt;you have to do a search through the file?

There are a few ways.  Screen savers use this information, so one way
to do it is to rename your file *.scr, place it in the windows directory,
and then look at it from the control panel as you are selecting a screen
saver.  Yeach!  Another way is to use a file dumper (?) such as
TDUMP by Borland or EXEHDR by Microsoft.  These programs will give you
the pertinent information.  TDUMP by the way comes with BP 7.0.

Programmaticly you can obtain the string through the new executable
file header information.  The string you are interested in is the
first entry in the nonresident-name table.  If you do not specify
{$D string} then this string will be the file name (like myfile.EXE).

A few days ago I posted how to do certain things with the new executable
file header.  You may want to look back a few days on your news reader
to get some insight.  But don't dispare.  I will give some clues here.

The first thing to do is to read the new EXE file format found
in the Borland or Micrsoft help files.  For Borland it can
be found under the &quot;File Formats&quot; topic.

Next you should get the EXE header types.  This can be obtained
at ftp.microsoft.com (filename: newexe12.zip).  I have
included a Pascal version at the end of this missive.

Now in your program you need to do the following:

  1.  Determine if the file is of the new EXE type.
  2.  Get the address of the non-resident name table.
  3.  Read the first string in the non-resident name table.

Later in this missive you will find a function that does step 1.
Below are the steps
*)

</i></font><font color="#FF0000"><b>uses
  </b></font>WinCrt<font color="#000080">,
  </font>WinTypes<font color="#000080">,
  </font>WinProcs<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>fn<font color="#000080">: </font>PChar <font color="#000080">= </font><font color="#800000">'c:\bp\myprog\myprog.exe'</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>DosHdr           <font color="#000080">: </font>IMAGE_DOS_HEADER<font color="#000080">;
  </font>NewHdr           <font color="#000080">: </font>IMAGE_NEW_HEADER<font color="#000080">;
  </font>ModuleDescription<font color="#000080">: </font>rsrc_string<font color="#000080">;
  </font>Filehandle       <font color="#000080">: </font>Integer<font color="#000080">;
  </font>ofs              <font color="#000080">: </font>TOFSTRUCT<font color="#000080">;

</font><font color="#FF0000"><b>label
  </b></font>Return<font color="#000080">;

</font><font color="#FF0000"><b>begin
if not </b></font>IsNewExe <font color="#000080">(</font>fn<font color="#000080">, </font>DosHdr<font color="#000080">, </font>NewHdr<font color="#000080">) </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

</font>FillChar <font color="#000080">(</font>ofs<font color="#000080">, </font>sizeof <font color="#000080">(</font>TOFSTRUCT<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>if </b></font>OpenFile <font color="#000080">(</font>fn<font color="#000080">, </font>ofs<font color="#000080">, </font>OF_EXIST <font color="#FF0000"><b>or </b></font>OF_READ<font color="#000080">) = -</font><font color="#800000">1 </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

</font>FileHandle <font color="#000080">:= </font>OpenFile <font color="#000080">(</font>fn<font color="#000080">, </font>ofs<font color="#000080">, </font>OF_REOPEN <font color="#FF0000"><b>or </b></font>OF_READ<font color="#000080">);
</font><font color="#FF0000"><b>if </b></font>FileHandle <font color="#000080">= -</font><font color="#800000">1 </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

</font><font color="#008000"><i>{ goto location of non-resident name table }
</i></font>_llseek <font color="#000080">(</font>FileHandle<font color="#000080">, </font>DosHdr<font color="#000080">.</font>e_lfanew <font color="#000080">+ </font>NewHdr<font color="#000080">.</font>ne_nrestab<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

</font><font color="#008000"><i>{ read length of string (in first entry of the non-resident name table) }
</i></font>_lread <font color="#000080">(</font>FileHandle<font color="#000080">, @</font>ModuleDescription<font color="#000080">.</font>rs_len<font color="#000080">, </font>sizeof <font color="#000080">(</font>Byte<font color="#000080">));

</font><font color="#008000"><i>{ allocate space for string }
</i></font>GetMem <font color="#000080">(</font>ModuleDescription<font color="#000080">.</font>rs_string<font color="#000080">, </font>ModuleDescription<font color="#000080">.</font>rs_len <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);

</font><font color="#008000"><i>{ read module description string }
</i></font>_lread <font color="#000080">(</font>FileHandle<font color="#000080">, @</font>ModuleDescription<font color="#000080">.</font>rs_string<font color="#000080">, </font>ModuleDescription<font color="#000080">.</font>rs_len<font color="#000080">);

</font><font color="#008000"><i>{ tag null termination onto string }
</i></font>ModuleDescription<font color="#000080">.</font>rs_string<font color="#000080">[</font>ModuleDescription<font color="#000080">.</font>rs_len<font color="#000080">] := </font><font color="#800000">#0</font><font color="#000080">;

</font><font color="#008000"><i>{ write results }
</i></font>writeln <font color="#000080">(</font>fn<font color="#000080">, </font><font color="#800000">' Module Description: '</font><font color="#000080">, </font>ModuleDescription<font color="#000080">.</font>rs_string<font color="#000080">);

</font><font color="#008000"><i>{ dispose of string }
</i></font>FreeMem <font color="#000080">(</font>ModuleDescription<font color="#000080">.</font>rs_string<font color="#000080">, </font>ModuleDescription<font color="#000080">.</font>rs_len <font color="#000080">+ </font><font color="#800000">1</font><font color="#000080">);

</font>Return<font color="#000080">:
</font><font color="#008000"><i>{ close file }
</i></font>_lclose <font color="#000080">(</font>FileHandle<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.


</font>Note that the above code <font color="#FF0000"><b>is </b></font>only good <font color="#FF0000"><b>for </b></font>finding the first <font color="#FF0000"><b>string
in </b></font>the non<font color="#000080">-</font>resident name table <font color="#FF0000"><b>as </b></font>the rest <font color="#FF0000"><b>of </b></font>the table also includes
index numbers <font color="#FF0000"><b>as </b></font>wll <font color="#FF0000"><b>as </b></font>the <font color="#FF0000"><b>string </b></font>length <font color="#FF0000"><b>and </b></font>the <font color="#FF0000"><b>string</b></font><font color="#000080">.  </font>This code
has also <font color="#FF0000"><b>not </b></font>been tested<font color="#000080">.

</font>I hope you get some mileage from it<font color="#000080">.

-</font>Michael Vincze
vincze<font color="#000080">@</font>lobby<font color="#000080">.</font>ti<font color="#000080">.</font>com

<font color="#000080">---------- </font>NEW EXE HEADER TYPES <font color="#000080">----------

</font><font color="#FF0000"><b>type
  </b></font>IMAGE_DOS_HEADER <font color="#000080">= </font><font color="#FF0000"><b>record     </b></font><font color="#008000"><i>{ DOS 1, 2, 3 .EXE header     }
    </i></font>e_magic   <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Magic number                      }
    </i></font>e_cblp    <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Words on last page of file        }
    </i></font>e_cp      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Pages in file                     }
    </i></font>e_crlc    <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Relocations                       }
    </i></font>e_cparhdr <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Size of header in paragraphs      }
    </i></font>e_minalloc<font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Minimum extra paragraphs needed   }
    </i></font>e_maxalloc<font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Maximum extra paragraphs needed   }
    </i></font>e_ss      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Initial (relative) SS value       }
    </i></font>e_sp      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Initial SP value                  }
    </i></font>e_csum    <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Checksum                          }
    </i></font>e_ip      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Initial IP value                  }
    </i></font>e_cs      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Initial (relative) CS value       }
    </i></font>e_lfarlc  <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ File address of relocation table  }
    </i></font>e_ovno    <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Overlay number                    }
    </i></font>e_res     <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Word<font color="#000080">;  </font><font color="#008000"><i>{ Reserved words        }
    </i></font>e_oemid   <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ OEM identifier (for e_oeminfo)    }
    </i></font>e_oeminfo <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ OEM information; e_oemid specific }
    </i></font>e_res2    <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">9</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Word<font color="#000080">;  </font><font color="#008000"><i>{ Reserved words        }
    </i></font>e_lfanew  <font color="#000080">: </font>Longint<font color="#000080">;  </font><font color="#008000"><i>{ File address of new exe header    }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>IMAGE_DOS_SIGNATURE    <font color="#000080">= </font><font color="#800000">$00005A4D</font><font color="#000080">; </font><font color="#008000"><i>{ MZ    }
  </i></font>IMAGE_OS2_SIGNATURE    <font color="#000080">= </font><font color="#800000">$0000454E</font><font color="#000080">; </font><font color="#008000"><i>{ NE    }
  </i></font>IMAGE_OS2_SIGNATURE_LE <font color="#000080">= </font><font color="#800000">$00005A4D</font><font color="#000080">; </font><font color="#008000"><i>{ LE    }
  </i></font>IMAGE_NT_SIGNATURE     <font color="#000080">= </font><font color="#800000">$00004550</font><font color="#000080">; </font><font color="#008000"><i>{ PE00  }

</i></font><font color="#FF0000"><b>type
  </b></font>IMAGE_NEW_HEADER <font color="#000080">= </font><font color="#FF0000"><b>record </b></font><font color="#008000"><i>{ New .EXE header                       }
    </i></font>ne_magic      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Magic number NE_MAGIC               }
    </i></font>ne_ver        <font color="#000080">: </font>Byte<font color="#000080">;     </font><font color="#008000"><i>{ Version number                      }
    </i></font>ne_rev        <font color="#000080">: </font>Byte<font color="#000080">;     </font><font color="#008000"><i>{ Revision number                     }
    </i></font>ne_enttab     <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Offset of Entry Table               }
    </i></font>ne_cbenttab   <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Number of bytes in Entry Table      }
    </i></font>ne_crc        <font color="#000080">: </font>Longint<font color="#000080">;  </font><font color="#008000"><i>{ Checksum of whole file              }
    </i></font>ne_flags      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Flag word                           }
    </i></font>ne_autodata   <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Automatic data segment number       }
    </i></font>ne_heap       <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Initial heap allocation             }
    </i></font>ne_stack      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Initial stack allocation            }
    </i></font>ne_csip       <font color="#000080">: </font>Longint<font color="#000080">;  </font><font color="#008000"><i>{ Initial CS:IP setting               }
    </i></font>ne_sssp       <font color="#000080">: </font>Longint<font color="#000080">;  </font><font color="#008000"><i>{ Initial SS:SP setting               }
    </i></font>ne_cseg       <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Count of file segments              }
    </i></font>ne_cmod       <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Entries in Module Reference Table   }
    </i></font>ne_cbnrestab  <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Size of non-resident name table     }
    </i></font>ne_segtab     <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Offset of Segment Table             }
    </i></font>ne_rsrctab    <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Offset of Resource Table            }
    </i></font>ne_restab     <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Offset of resident name table       }
    </i></font>ne_modtab     <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Offset of Module Reference Table    }
    </i></font>ne_imptab     <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Offset of Imported Names Table      }
    </i></font>ne_nrestab    <font color="#000080">: </font>Longint<font color="#000080">;  </font><font color="#008000"><i>{ Offset of Non-resident Names Table  }
    </i></font>ne_cmovent    <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Count of movable ent                }
    </i></font>ne_align      <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Segment alignment shift count       }
    </i></font>ne_cres       <font color="#000080">: </font>Word<font color="#000080">;     </font><font color="#008000"><i>{ Count of resource entries           }
    </i></font>ne_exetyp     <font color="#000080">: </font>Byte<font color="#000080">;     </font><font color="#008000"><i>{ Target operating system             }
    </i></font>ne_flagsothers<font color="#000080">: </font>Byte<font color="#000080">;     </font><font color="#008000"><i>{ Other .EXE flags                    }
    </i></font>ne_res        <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">7</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Byte<font color="#000080">; </font><font color="#008000"><i>{ Pad structure to 64 bytes }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const </b></font><font color="#008000"><i>{ Format of ne_exetyp (target operating system) }
  </i></font>NE_UNKNOWN <font color="#000080">= </font><font color="#800000">$0</font><font color="#000080">;  </font><font color="#008000"><i>{ Unknown (any &quot;new-format&quot; OS) }
  </i></font>NE_OS2     <font color="#000080">= </font><font color="#800000">$1</font><font color="#000080">;  </font><font color="#008000"><i>{ Microsoft/IBM OS/2            }
  </i></font>NE_WINDOWS <font color="#000080">= </font><font color="#800000">$2</font><font color="#000080">;  </font><font color="#008000"><i>{ Microsoft Windows             }
  </i></font>NE_DOS4    <font color="#000080">= </font><font color="#800000">$3</font><font color="#000080">;  </font><font color="#008000"><i>{ Microsoft MS-DOS 4.x          }
  </i></font>NE_DEV386  <font color="#000080">= </font><font color="#800000">$4</font><font color="#000080">;  </font><font color="#008000"><i>{ Microsoft Windows 386         }

</i></font><font color="#FF0000"><b>const </b></font><font color="#008000"><i>{ Format of IMAGE_NEW_HEADER.ne_flags                     }
  </i></font>NENOTP         <font color="#000080">= </font><font color="#800000">$8000</font><font color="#000080">; </font><font color="#008000"><i>{ Not a process                       }
  </i></font>NEIERR         <font color="#000080">= </font><font color="#800000">$2000</font><font color="#000080">; </font><font color="#008000"><i>{ Errors in image                     }
  </i></font>NEBOUND        <font color="#000080">= </font><font color="#800000">$0800</font><font color="#000080">; </font><font color="#008000"><i>{ Bound as family app                 }
  </i></font>NEAPPTYP       <font color="#000080">= </font><font color="#800000">$0700</font><font color="#000080">; </font><font color="#008000"><i>{ Application type mask               }
  </i></font>NENOTWINCOMPAT <font color="#000080">= </font><font color="#800000">$0100</font><font color="#000080">; </font><font color="#008000"><i>{ Not compatible with P.M. Windowing  }
  </i></font>NEWINCOMPAT    <font color="#000080">= </font><font color="#800000">$0200</font><font color="#000080">; </font><font color="#008000"><i>{ Compatible with P.M.                }
  </i></font>NEWINAPI       <font color="#000080">= </font><font color="#800000">$0300</font><font color="#000080">; </font><font color="#008000"><i>{ Uses P.M. Windowing API             }
  </i></font>NEFLTP         <font color="#000080">= </font><font color="#800000">$0080</font><font color="#000080">; </font><font color="#008000"><i>{ Floating-point instructions         }
  </i></font>NEI386         <font color="#000080">= </font><font color="#800000">$0040</font><font color="#000080">; </font><font color="#008000"><i>{ 386 instructions                    }
  </i></font>NEI286         <font color="#000080">= </font><font color="#800000">$0020</font><font color="#000080">; </font><font color="#008000"><i>{ 286 instructions                    }
  </i></font>NEI086         <font color="#000080">= </font><font color="#800000">$0010</font><font color="#000080">; </font><font color="#008000"><i>{ 8086 instructions                   }
  </i></font>NEPROT         <font color="#000080">= </font><font color="#800000">$0008</font><font color="#000080">; </font><font color="#008000"><i>{ Runs in protected mode only         }
  </i></font>NEPPLI         <font color="#000080">= </font><font color="#800000">$0004</font><font color="#000080">; </font><font color="#008000"><i>{ Per-Process Library Initialization  }
  </i></font>NEINST         <font color="#000080">= </font><font color="#800000">$0002</font><font color="#000080">; </font><font color="#008000"><i>{ Instance data                       }
  </i></font>NESOLO         <font color="#000080">= </font><font color="#800000">$0001</font><font color="#000080">; </font><font color="#008000"><i>{ Solo data                           }

</i></font><font color="#FF0000"><b>type
  </b></font>new_seg <font color="#000080">= </font><font color="#FF0000"><b>record  </b></font><font color="#008000"><i>{ New .EXE segment table entry        }
    </i></font>ns_sector  <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ File sector of start of segment }
    </i></font>ns_cbseg   <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ Number of bytes in file         }
    </i></font>ns_flags   <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ Attribute flags                 }
    </i></font>ns_minalloc<font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ Minimum allocation in bytes     }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>const </b></font><font color="#008000"><i>{ Format of new_seg.nsflags                                                 }
  </i></font>NSCODE    <font color="#000080">= </font><font color="#800000">$0000</font><font color="#000080">;  </font><font color="#008000"><i>{ Code segment                                              }
  </i></font>NSDATA    <font color="#000080">= </font><font color="#800000">$0001</font><font color="#000080">;  </font><font color="#008000"><i>{ Data segment                                              }
  </i></font>NSLOADED  <font color="#000080">= </font><font color="#800000">$0004</font><font color="#000080">;  </font><font color="#008000"><i>{ ns_sector field contains memory addr                      }
  </i></font>NSTYPE    <font color="#000080">= </font><font color="#800000">$0007</font><font color="#000080">;  </font><font color="#008000"><i>{ Segment type mask                                         }
  </i></font>NSITER    <font color="#000080">= </font><font color="#800000">$0008</font><font color="#000080">;  </font><font color="#008000"><i>{ Iterated segment flag                                     }
  </i></font>NSMOVE    <font color="#000080">= </font><font color="#800000">$0010</font><font color="#000080">;  </font><font color="#008000"><i>{ Movable segment flag                                      }
  </i></font>NSSHARED  <font color="#000080">= </font><font color="#800000">$0020</font><font color="#000080">;  </font><font color="#008000"><i>{ Shared segment flag                                       }
  </i></font>NSPRELOAD <font color="#000080">= </font><font color="#800000">$0040</font><font color="#000080">;  </font><font color="#008000"><i>{ Preload segment flag                                      }
  </i></font>NSEXRD    <font color="#000080">= </font><font color="#800000">$0080</font><font color="#000080">;  </font><font color="#008000"><i>{ Execute-only (code segment), or  read-only (data segment) }
  </i></font>NSRELOC   <font color="#000080">= </font><font color="#800000">$0100</font><font color="#000080">;  </font><font color="#008000"><i>{ Segment has relocations                                   }
  </i></font>NSCONFORM <font color="#000080">= </font><font color="#800000">$0200</font><font color="#000080">;  </font><font color="#008000"><i>{ Conforming segment                                        }
  </i></font>NSDISCARD <font color="#000080">= </font><font color="#800000">$1000</font><font color="#000080">;  </font><font color="#008000"><i>{ Segment is discardable                                    }
  </i></font>NS32BIT   <font color="#000080">= </font><font color="#800000">$2000</font><font color="#000080">;  </font><font color="#008000"><i>{ 32-bit code segment                                       }
  </i></font>HSHUGE    <font color="#000080">= </font><font color="#800000">$4000</font><font color="#000080">;  </font><font color="#008000"><i>{ Huge memory segment                                       }
  </i></font>NSEXPDOWN <font color="#000080">= </font><font color="#800000">$0200</font><font color="#000080">;  </font><font color="#008000"><i>{ Data segment is expand down                               }

(*
#define NSDPL   0x0C00    /* I/O privilege level (286 DPL bits) */
#define SHIFTDPL  10    /* Left shift count for */
#define NSPURE    NSSHARED  /* For compatibility */
#define NSALIGN 9 /* Segment data aligned on 512 byte boundaries */
*)

</i></font><font color="#FF0000"><b>type
  </b></font>new_rlcinfo <font color="#000080">= </font><font color="#FF0000"><b>record  </b></font><font color="#008000"><i>{ Relocation info                       }
    </i></font>nr_nreloc<font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ number of relocation items that follow  }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>new_rlc <font color="#000080">= </font><font color="#FF0000"><b>record  </b></font><font color="#008000"><i>{ Relocation item }
    </i></font>nr_stype<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#008000"><i>{ Source type     }
    </i></font>nr_flags<font color="#000080">: </font>Byte<font color="#000080">; </font><font color="#008000"><i>{ Flag byte       }
    </i></font>nr_soff <font color="#000080">: </font>Word<font color="#000080">; </font><font color="#008000"><i>{ Source offset   }
    </i></font><font color="#FF0000"><b>case </b></font>Integer <font color="#FF0000"><b>of
      </b></font><font color="#800000">0</font><font color="#000080">: (</font>nr_segno <font color="#000080">: </font>Byte<font color="#000080">;  </font><font color="#008000"><i>{ Target segment number             } { internal reference      }
          </i></font>nr_res   <font color="#000080">: </font>Byte<font color="#000080">;  </font><font color="#008000"><i>{ Reserved                          }
          </i></font>nr_entry <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#008000"><i>{ Target Entry Table offset         }
      </i></font><font color="#800000">1</font><font color="#000080">: (</font>nr_mod   <font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ Index into Module Reference Table } { import                  }
          </i></font>nr_proc  <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#008000"><i>{ Procedure ordinal or name offset  }
      </i></font><font color="#800000">2</font><font color="#000080">: (</font>nr_ostype<font color="#000080">: </font>Word<font color="#000080">;  </font><font color="#008000"><i>{ OSFIXUP type                      } { operating system fixup  }
          </i></font>nr_osres <font color="#000080">: </font>Word<font color="#000080">); </font><font color="#008000"><i>{ Reserved                          }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Resource type or name string
}
</i></font><font color="#FF0000"><b>type
  </b></font>rsrc_string <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>rs_len   <font color="#000080">: </font>Byte<font color="#000080">;  </font><font color="#008000"><i>{ number of bytes in string }
    </i></font>rs_string<font color="#000080">: </font>PChar<font color="#000080">; </font><font color="#008000"><i>{ text of string            }
    </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;


---------- </font>IsNewExe<font color="#000080">() </font><font color="#FF0000"><b>function </b></font><font color="#000080">----------

</font>Below <font color="#FF0000"><b>is </b></font>the code <font color="#FF0000"><b>to </b></font>determine <font color="#FF0000"><b>if </b></font>the <font color="#FF0000"><b>file is of </b></font>the new EXE <font color="#FF0000"><b>type</b></font><font color="#000080">.
</font>Note how DosHdr <font color="#FF0000"><b>and </b></font>NewHdr are passed by reference <font color="#FF0000"><b>and not </b></font>by value<font color="#000080">.
</font>This <font color="#FF0000"><b>is </b></font>so values <font color="#FF0000"><b>for </b></font>DosHdr <font color="#FF0000"><b>and </b></font>NewHdr can be used by other
functions called by the main <font color="#FF0000"><b>program</b></font><font color="#000080">.  </font>Also note the extensive use
<font color="#FF0000"><b>of </b></font>the OpenFile<font color="#000080">(), </font>_lread<font color="#000080">(), </font>_llseek<font color="#000080">(), </font><font color="#FF0000"><b>and </b></font>_lclose<font color="#000080">() </font>functions<font color="#000080">.

  </font><font color="#FF0000"><b>function </b></font>IsNewExe <font color="#000080">(</font>fn<font color="#000080">: </font>PChar<font color="#000080">;
                     </font><font color="#FF0000"><b>var </b></font>DosHdr<font color="#000080">: </font>IMAGE_DOS_HEADER<font color="#000080">;
                     </font><font color="#FF0000"><b>var </b></font>NewHdr<font color="#000080">: </font>IMAGE_NEW_HEADER<font color="#000080">): </font>Boolean<font color="#000080">;
  </font><font color="#FF0000"><b>label
    </b></font>Return<font color="#000080">;
  </font><font color="#FF0000"><b>var
    </b></font>Filehandle<font color="#000080">: </font>Integer<font color="#000080">;
    </font>BytesRead <font color="#000080">: </font>Integer<font color="#000080">;
    </font>ofs       <font color="#000080">: </font>TOFSTRUCT<font color="#000080">;
  </font><font color="#FF0000"><b>begin
  </b></font>IsNewExe <font color="#000080">:= </font>False<font color="#000080">;

  </font>FillChar <font color="#000080">(</font>ofs<font color="#000080">, </font>sizeof <font color="#000080">(</font>TOFSTRUCT<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>OpenFile <font color="#000080">(</font>fn<font color="#000080">, </font>ofs<font color="#000080">, </font>OF_EXIST <font color="#FF0000"><b>or </b></font>OF_READ<font color="#000080">) = -</font><font color="#800000">1 </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font>FileHandle <font color="#000080">:= </font>OpenFile <font color="#000080">(</font>fn<font color="#000080">, </font>ofs<font color="#000080">, </font>OF_REOPEN <font color="#FF0000"><b>or </b></font>OF_READ<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>FileHandle <font color="#000080">= -</font><font color="#800000">1 </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font>FillChar <font color="#000080">(</font>DosHdr<font color="#000080">, </font>sizeof <font color="#000080">(</font>IMAGE_DOS_HEADER<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font>FillChar <font color="#000080">(</font>NewHdr<font color="#000080">, </font>sizeof <font color="#000080">(</font>IMAGE_NEW_HEADER<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);

  </font><font color="#008000"><i>{ read MS-DOS header }
  </i></font>BytesRead <font color="#000080">:= </font>_lread <font color="#000080">(</font>FileHandle<font color="#000080">, @</font>DosHdr<font color="#000080">, </font>sizeof <font color="#000080">(</font>IMAGE_DOS_HEADER<font color="#000080">));

  </font><font color="#008000"><i>{ test for bytes read }
  </i></font><font color="#FF0000"><b>if </b></font>BytesRead <font color="#000080">&lt;&gt; </font>sizeof <font color="#000080">(</font>IMAGE_DOS_HEADER<font color="#000080">) </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font><font color="#008000"><i>{ test for magic number MZ }
  </i></font><font color="#FF0000"><b>if </b></font>DosHdr<font color="#000080">.</font>e_magic <font color="#000080">&lt;&gt; </font>IMAGE_DOS_SIGNATURE <font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font><font color="#008000"><i>{ test for address of new exe header }
  </i></font><font color="#FF0000"><b>if </b></font>DosHdr<font color="#000080">.</font>e_lfanew <font color="#000080">&lt;= </font><font color="#800000">0 </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font><font color="#008000"><i>{ fast forward to Windows header }
  </i></font><font color="#FF0000"><b>if </b></font>_llseek <font color="#000080">(</font>FileHandle<font color="#000080">, </font>DosHdr<font color="#000080">.</font>e_lfanew<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">) = -</font><font color="#800000">1 </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font><font color="#008000"><i>{ read new exe header }
  </i></font>BytesRead <font color="#000080">:= </font>_lread <font color="#000080">(</font>FileHandle<font color="#000080">, @</font>NewHdr<font color="#000080">, </font>sizeof <font color="#000080">(</font>IMAGE_NEW_HEADER<font color="#000080">));

  </font><font color="#008000"><i>{ test for bytes read }
  </i></font><font color="#FF0000"><b>if </b></font>BytesRead <font color="#000080">&lt;&gt; </font>sizeof <font color="#000080">(</font>IMAGE_NEW_HEADER<font color="#000080">) </font><font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font><font color="#008000"><i>{ test for signature NE }
  </i></font><font color="#FF0000"><b>if </b></font>NewHdr<font color="#000080">.</font>ne_magic <font color="#000080">&lt;&gt; </font>IMAGE_OS2_SIGNATURE <font color="#FF0000"><b>then goto </b></font>Return<font color="#000080">;

  </font><font color="#008000"><i>{ passed the test }
  </i></font>IsNewExe <font color="#000080">:= </font>True<font color="#000080">;

  </font>Return<font color="#000080">:
  </font><font color="#008000"><i>{ close file }
  </i></font>_lclose <font color="#000080">(</font>FileHandle<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0025.PAS">Original</a><b>]</b></p></body>
</html>
