<html>
<head><title> "4 GB Data - 32 Bit! / Windows" by WIM SMIT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{ I made a small ASM-routine for accessing 4 GB data in 4 instructions: }

</i></font><font color="#FF0000"><b>PROGRAM </b></font>test32<font color="#000080">; </font><font color="#008000"><i>{Works for TPW1.5}
{$R-}
{Wim Smit 4-9-1994
Thanx to Jimmy Athens!}
</i></font><font color="#FF0000"><b>USES </b></font>WinTypes<font color="#000080">,</font>WinProcs<font color="#000080">,</font>WinCrt<font color="#000080">;
</font><font color="#FF0000"><b>TYPE
    </b></font>word_array <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">0</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>WORD<font color="#000080">;
    </font>Pword_array <font color="#000080">= ^</font>word_array<font color="#000080">;

</font><font color="#FF0000"><b>VAR </b></font>P<font color="#000080">:</font>PWORD_Array<font color="#000080">;
    </font>H<font color="#000080">:</font>THandle<font color="#000080">;
    </font>sub1<font color="#000080">,</font>sub2<font color="#000080">, 
    </font>segt<font color="#000080">: </font>WORD<font color="#000080">;
    </font>i<font color="#000080">,
    </font>ofst<font color="#000080">: </font>LONGINT<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
</b></font>WRITELN<font color="#000080">(</font><font color="#800000">'BEGIN'</font><font color="#000080">);

</font>h <font color="#000080">:= </font>GlobalAlloc<font color="#000080">(</font>GMEM_MOVEABLE <font color="#FF0000"><b>OR </b></font>GMEM_SHARE<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">*</font><font color="#800000">70000</font><font color="#000080">);
</font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>h <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>THEN
    </b></font>Halt<font color="#000080">;
</font>P <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>h<font color="#000080">);
</font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>P <font color="#000080">= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">) </font><font color="#FF0000"><b>THEN
    </b></font>Halt<font color="#000080">;

</font>segt <font color="#000080">:= </font>SEG<font color="#000080">(</font>p<font color="#000080">^);
</font><font color="#FF0000"><b>FOR </b></font>i <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">69999 </font><font color="#FF0000"><b>DO           </b></font><font color="#008000"><i>{fill the words with their index}
    </i></font><font color="#FF0000"><b>BEGIN
    ASM
        </b></font><font color="#FF00FF">mov es,segt
        db 66h                   </font><font color="#008000"><i>{66h for 386 opcode}              
        </i></font><font color="#FF00FF">mov bx, WORD(i)          </font><font color="#008000"><i>{WORD() to fool Pascal}
        </i></font><font color="#FF00FF">db 66h
        shl bx,1                 </font><font color="#008000"><i>{ebx times 2: WORDs}
        </i></font><font color="#FF00FF">db 66h
        mov ax, WORD(i)
        db 26h
        db 67h
        db 89h
        db 03h                   </font><font color="#008000"><i>{these produce: mov  es:[ebx],ax}
    </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{asm}
    </i></font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{i}
{Now test it by reading the words:}
</i></font><font color="#FF0000"><b>FOR </b></font>i <font color="#000080">:= </font><font color="#800000">32762 </font><font color="#FF0000"><b>to </b></font><font color="#800000">32770 </font><font color="#FF0000"><b>DO       </b></font><font color="#008000"><i>{read over a segment-boundary}
    </i></font><font color="#FF0000"><b>BEGIN
    ASM
        </b></font><font color="#FF00FF">mov es,segt
        db 66h
        mov bx, WORD(i)          </font><font color="#008000"><i>{= mov ebx, i}
        </i></font><font color="#FF00FF">db 66h
        shl bx,1                 </font><font color="#008000"><i>{times 2: we're indexing WORDs}
        </i></font><font color="#FF00FF">db 26h
        db 67h
        db 8bh
        db 03h                   </font><font color="#008000"><i>{= mov ax, es:[ebx]}
        </i></font><font color="#FF00FF">mov sub2, ax
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{asm}
    </i></font>sub1 <font color="#000080">:= </font>p<font color="#000080">^[</font>i<font color="#000080">];
    </font>WRITELN<font color="#000080">(</font>i<font color="#000080">:</font><font color="#800000">3</font><font color="#000080">,</font><font color="#800000">':'</font><font color="#000080">,</font>sub2<font color="#000080">,</font><font color="#800000">' '</font><font color="#000080">,</font>sub1<font color="#000080">);
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;</font><font color="#008000"><i>{i}

</i></font>GlobalUnlock<font color="#000080">(</font>h<font color="#000080">);
</font>GlobalFree<font color="#000080">(</font>h<font color="#000080">);
</font>WRITELN<font color="#000080">(</font><font color="#800000">'DONE'</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.

</font><font color="#008000"><i>{
Run the program and see the difference:
BEGIN
32762:32762 32762
32763:32763 32763
32764:32764 32764
32765:32765 32765
32766:32766 32766
32767:32767 32767
32768:32768 0      &lt;-Here 16 bit index will wraparound to p^[0]!
32769:32769 1
32770:32770 2
DONE

Thus, by choosing the right db's, one can access huge arrays of bytes,
words and longints etc.
Isn't that great?
OK, it needs a 386 or better, but don't we all have that?
}</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0044.PAS">Original</a><b>]</b></p></body>
</html>
