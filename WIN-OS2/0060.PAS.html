<html>
<head><title> "Complete Metafile Discussion" by ZWEITZE DE VRIES</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0060.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: ZWEITZE@ET.TUDelft.NL (Zweitze de Vries)

&gt;Metafiles made in BP won't import into Word for Windows, while
&gt;CorelDraw accepts the files. Does anyone know what's causing
&gt;this problem?

Yes. There is not one Metafile format, there are three (!)
(excluding NT formats). The original is meant for internal
usage, like fast painting. Later this original was saved to
file to enable graphics exchange. This gave problems,
because of different mapping modes, and device resolutions.
Still, MS wanted to encourage exchange, so two new metafile
formats were developed, metafile to clipboard and the
placeable metafile (which is saved to file).

Word only accepts clipboard and placeable metafiles.
A placeable metafile is an original metafile with a 22 byte
header, which is called the placeable metafile header.
This 22 byte record is documented in your online help topic
'Metafile format'. The record type def is not implemented
in BP, so you've got to type it yourself. (Or use my copy
below)

Hereby I supply my metafile output code. There are two
entry points, which make the metafile go to clipboard or
file. In case of file, a common dialog is displayed.


{*****************************************************************************}
{*                   Werkgroep Elektrotechnisch Practicum                    *}
{*                       Faculteit der Elektrotechniek                       *}
{*                       Technische Universiteit Delft                       *}
{*****************************************************************************}
{*                               project : CATE                              *}
{* program      :  cateshell (werktitel)             date     :  Oct 1994    *}
{* filename   :  APPCHILD.PAS                     version  :  0.61           *}
{* author     :  Z.A. de Vries                    compiler :  BPW 7.0        *}
{* description:  Performs basic MDI child window handling                    *}
{*****************************************************************************}

</i></font><font color="#FF0000"><b>uses
  </b></font>CommDlg<font color="#000080">, </font>WinProcs<font color="#000080">, </font>WinTypes<font color="#000080">, </font>Objects<font color="#000080">, </font>OWindows<font color="#000080">, </font>Strings<font color="#000080">, </font>Win31<font color="#000080">;

</font><font color="#008000"><i>{...}

{ Not found in runtime libs, this structure is the header of a so-called
  Placeable metafile. A Placeable metafile is a standard metafile with 
  this 22byte header. This header is documented in the online help under 
  'Metafile Format' }
</i></font><font color="#FF0000"><b>type
  </b></font>PPlaceableMF <font color="#000080">= ^</font>TPlaceableMF<font color="#000080">;
  </font>TPlaceableMF <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>Key<font color="#000080">:      </font>LongInt<font color="#000080">;
    </font>hMF<font color="#000080">:      </font>THandle<font color="#000080">;
    </font>BBox<font color="#000080">:     </font>TRect<font color="#000080">;
    </font>Inch<font color="#000080">:     </font>Integer<font color="#000080">;
    </font>Reserved<font color="#000080">: </font>LongInt<font color="#000080">;
    </font>Checksum<font color="#000080">: </font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TChildWndBase<font color="#000080">.</font>MetafileToFile<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>szNewName<font color="#000080">: </font>PChar<font color="#000080">;
  </font>szFilter<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">100</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>szExt<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>Char<font color="#000080">;
  </font>pFilter<font color="#000080">: </font>PChar<font color="#000080">;
  </font>SaveRec<font color="#000080">: </font>TOpenFileName<font color="#000080">;
  </font>wmfFile<font color="#000080">: </font>PBufStream<font color="#000080">;
  </font>wmfHeader<font color="#000080">: </font>TPlaceableMF<font color="#000080">;
  </font>hMetafile<font color="#000080">: </font>THandle<font color="#000080">;
  </font>pMetafile<font color="#000080">: </font>PMetaHeader<font color="#000080">;
  </font>ScrnDC<font color="#000080">: </font>HDC<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetMem<font color="#000080">(</font>szNewName<font color="#000080">, </font>fsCompleteName<font color="#000080">);    </font><font color="#008000"><i>{ const fsCompleteName = 144 }

  </i></font>FillChar<font color="#000080">(</font>szFilter<font color="#000080">, </font>SizeOf<font color="#000080">(</font>szFilter<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font>StrCopy<font color="#000080">(</font>szFilter<font color="#000080">, </font><font color="#800000">'Windows Metafiles (*.WMF)'</font><font color="#000080">);
  </font>pFilter <font color="#000080">:= </font>StrEnd<font color="#000080">(</font>szFilter<font color="#000080">);
  </font>Inc<font color="#000080">(</font>pFilter<font color="#000080">);
  </font>pFilter <font color="#000080">:= </font>StrECopy<font color="#000080">(</font>pFilter<font color="#000080">, </font><font color="#800000">'*.WMF'</font><font color="#000080">);
  </font>Inc<font color="#000080">(</font>pFilter<font color="#000080">);
  </font>pFilter <font color="#000080">:= </font>StrECopy<font color="#000080">(</font>pFilter<font color="#000080">, </font><font color="#800000">'All files (*.*)'</font><font color="#000080">);
  </font>Inc<font color="#000080">(</font>pFilter<font color="#000080">);
  </font>StrCopy<font color="#000080">(</font>pFilter<font color="#000080">, </font><font color="#800000">'*.*'</font><font color="#000080">);

  </font>StrCopy<font color="#000080">(</font>szNewName<font color="#000080">, </font><font color="#800000">'*.WMF'</font><font color="#000080">);
  </font>FillChar<font color="#000080">(</font>SaveRec<font color="#000080">, </font>SizeOf<font color="#000080">(</font>SaveRec<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>with </b></font>SaveRec
    <font color="#FF0000"><b>do begin
      </b></font>hwndOwner     <font color="#000080">:= </font>Application<font color="#000080">^.</font>MainWindow<font color="#000080">^.</font>hWindow<font color="#000080">;
      </font>lStructSize   <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>SaveRec<font color="#000080">);
      </font>lpstrFile     <font color="#000080">:= </font>szNewName<font color="#000080">;
      </font>nMaxFile      <font color="#000080">:= </font>fsCompleteName<font color="#000080">;
      </font>Flags         <font color="#000080">:= </font>ofn_NoReadOnlyReturn <font color="#FF0000"><b>or </b></font>ofn_OverwritePrompt <font color="#FF0000"><b>or
                       </b></font>ofn_PathMustExist <font color="#FF0000"><b>or </b></font>ofn_ShowHelp <font color="#FF0000"><b>or </b></font>ofn_HideReadOnly<font color="#000080">;
      </font>lpstrDefExt   <font color="#000080">:= </font><font color="#800000">'WMF'</font><font color="#000080">;
      </font>lpstrFilter   <font color="#000080">:= </font>szFilter<font color="#000080">;
      </font>nFilterIndex  <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>GetSaveFileName<font color="#000080">(</font>SaveRec<font color="#000080">)
    </font><font color="#FF0000"><b>then begin
      </b></font>ScrnDC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>hWindow<font color="#000080">);
      </font><font color="#FF0000"><b>with </b></font>wmfHeader
        <font color="#FF0000"><b>do begin
          </b></font>Key <font color="#000080">:= </font><font color="#800000">$9AC6CDD7</font><font color="#000080">;
          </font>hMF <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font>GetClientRect<font color="#000080">(</font>hWindow<font color="#000080">, </font>BBox<font color="#000080">);
          </font>Inch <font color="#000080">:= (</font>GetDeviceCaps<font color="#000080">(</font>ScrnDC<font color="#000080">, </font>LogPixelsX<font color="#000080">) +
                   </font>GetDeviceCaps<font color="#000080">(</font>ScrnDC<font color="#000080">, </font>LogPixelsY<font color="#000080">)) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">;
          </font>Reserved <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
          </font>Checksum <font color="#000080">:= </font><font color="#800000">$9AC6 </font><font color="#FF0000"><b>xor </b></font><font color="#800000">$CDD7 </font><font color="#FF0000"><b>xor </b></font>BBox<font color="#000080">.</font>Right <font color="#FF0000"><b>xor </b></font>BBox<font color="#000080">.</font>Bottom <font color="#FF0000"><b>xor </b></font>Inch<font color="#000080">;
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>ReleaseDC<font color="#000080">(</font>hWindow<font color="#000080">, </font>ScrnDC<font color="#000080">);

      </font>hMetafile <font color="#000080">:= </font>DrawMetafile<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">);

      </font>wmfFile <font color="#000080">:= </font>new<font color="#000080">(</font>PBufStream<font color="#000080">, </font>Init<font color="#000080">(</font>szNewName<font color="#000080">, </font>stCreate<font color="#000080">, </font><font color="#800000">2048</font><font color="#000080">));
      </font>wmfFile<font color="#000080">^.</font>Write<font color="#000080">(</font>wmfHeader<font color="#000080">, </font>SizeOf<font color="#000080">(</font>wmfHeader<font color="#000080">));
      </font>pMetafile <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>hMetafile<font color="#000080">);
      </font>wmfFile<font color="#000080">^.</font>Write<font color="#000080">(</font>pMetafile<font color="#000080">^, </font>pMetafile<font color="#000080">^.</font>mtSize <font color="#000080">* </font><font color="#800000">2</font><font color="#000080">);
      </font>GlobalUnlock<font color="#000080">(</font>hMetaFile<font color="#000080">);
      </font>wmfFile<font color="#000080">^.</font>Done<font color="#000080">;

      </font>DeleteMetafile<font color="#000080">(</font>hMetafile<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>FreeMem<font color="#000080">(</font>szNewName<font color="#000080">, </font>fsCompleteName<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TChildWndBase<font color="#000080">.</font>MetafileToClipboard<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>HiMetricPerInch <font color="#000080">= </font><font color="#800000">2540</font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>hMetafile<font color="#000080">, </font>hMetafileClipboardHeader<font color="#000080">: </font>THandle<font color="#000080">;
  </font>pMetafileClipboardHeader<font color="#000080">: </font>PMetafilePict<font color="#000080">;
  </font>rcWindow<font color="#000080">: </font>TRect<font color="#000080">;
  </font>RefDC<font color="#000080">: </font>HDC<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if not </b></font>OpenClipboard<font color="#000080">(</font>hWindow<font color="#000080">)
    </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font>EmptyClipboard<font color="#000080">;

  </font>hMetafile <font color="#000080">:= </font>DrawMetafile<font color="#000080">(</font><font color="#FF0000"><b>nil</b></font><font color="#000080">);

  </font>hMetafileClipboardHeader <font color="#000080">:=
          </font>GlobalAlloc<font color="#000080">(</font>gmem_DDEShare<font color="#000080">, </font>SizeOf<font color="#000080">(</font>TMetaFilePict<font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>hMetafile <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>hMetafileClipboardHeader <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">)
    </font><font color="#FF0000"><b>then begin
      </b></font>CloseClipboard<font color="#000080">;
      </font><font color="#FF0000"><b>if </b></font>hMetafile <font color="#000080">&lt;&gt; </font><font color="#800000">0
        </font><font color="#FF0000"><b>then </b></font>GlobalFree<font color="#000080">(</font>hMetafile<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>hMetafileClipboardHeader <font color="#000080">&lt;&gt; </font><font color="#800000">0
        </font><font color="#FF0000"><b>then </b></font>GlobalFree<font color="#000080">(</font>hMetafileClipboardHeader<font color="#000080">);
      </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>pMetafileClipboardHeader <font color="#000080">:=
          </font>PMetaFilePict<font color="#000080">(</font>GlobalLock<font color="#000080">(</font>hMetafileClipboardHeader<font color="#000080">));
  </font><font color="#FF0000"><b>with </b></font>pMetafileClipboardHeader<font color="#000080">^
    </font><font color="#FF0000"><b>do begin
      </b></font>mm   <font color="#000080">:= </font>mm_Anisotropic<font color="#000080">;
      </font>hMF  <font color="#000080">:= </font>hMetafile<font color="#000080">;
      </font>GetClientRect<font color="#000080">(</font>hWindow<font color="#000080">, </font>rcWindow<font color="#000080">);  </font><font color="#008000"><i>{ Size is window size }
      </i></font><font color="#FF0000"><b>with </b></font>rcWindow
        <font color="#FF0000"><b>do begin
          </b></font>RefDC <font color="#000080">:= </font>GetDC<font color="#000080">(</font>hWindow<font color="#000080">);
          </font>xExt <font color="#000080">:= </font>MulDiv<font color="#000080">(</font>Right <font color="#000080">- </font>Left<font color="#000080">, </font>HiMetricPerInch<font color="#000080">,
                         </font>GetDeviceCaps<font color="#000080">(</font>RefDC<font color="#000080">, </font>LogPixelsX<font color="#000080">));
          </font>yExt <font color="#000080">:= </font>MulDiv<font color="#000080">(</font>Bottom <font color="#000080">- </font>Top<font color="#000080">, </font>HiMetricPerInch<font color="#000080">,
                         </font>GetDeviceCaps<font color="#000080">(</font>RefDC<font color="#000080">, </font>LogPixelsY<font color="#000080">));
          </font>ReleaseDC<font color="#000080">(</font>hWindow<font color="#000080">, </font>RefDC<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>GlobalUnlock<font color="#000080">(</font>hMetafileClipboardHeader<font color="#000080">);
  </font>SetClipboardData<font color="#000080">(</font>cf_MetafilePict<font color="#000080">, </font>hMetafileClipboardHeader<font color="#000080">);
  </font>CloseClipboard<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>function </b></font>TChildWndBase<font color="#000080">.</font>DrawMetafile<font color="#000080">(</font>szOutput<font color="#000080">: </font>PChar<font color="#000080">): </font>THandle<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>MetaDC      <font color="#000080">: </font>HDC<font color="#000080">;
  </font>PaintStruct <font color="#000080">: </font>TPaintstruct<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>MetaDC <font color="#000080">:= </font>CreateMetaFile<font color="#000080">(</font>szOutput<font color="#000080">);
  </font>SetMapMode<font color="#000080">(</font>MetaDC<font color="#000080">, </font>mm_anisotropic<font color="#000080">);
  </font>SetWindowOrg<font color="#000080">(</font>MetaDC<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);

  </font><font color="#FF0000"><b>with </b></font>PaintStruct
    <font color="#FF0000"><b>do begin
      </b></font>hdc    <font color="#000080">:= </font>MetaDC<font color="#000080">;
      </font>fErase <font color="#000080">:= </font>false<font color="#000080">;
      </font>GetClientRect<font color="#000080">(</font>hWindow<font color="#000080">, </font>rcPaint<font color="#000080">);
      </font><font color="#FF0000"><b>with </b></font>rcPaint
        <font color="#FF0000"><b>do begin
                   </b></font><font color="#008000"><i>{ Its size is exact the same as the window size }
          </i></font>SetWindowExt<font color="#000080">(</font>MetaDC<font color="#000080">, </font>Right <font color="#000080">- </font>Left<font color="#000080">, </font>Bottom <font color="#000080">- </font>Top<font color="#000080">);

                   </font><font color="#008000"><i>{ Setup a clipping rectangle }
          </i></font>IntersectClipRect<font color="#000080">(</font>MetaDC<font color="#000080">, </font>Left<font color="#000080">, </font>Top<font color="#000080">, </font>Right<font color="#000080">, </font>Bottom<font color="#000080">);

                   </font><font color="#008000"><i>{ Setup the background color of the metafile 
                     which is the same as the window background }
          </i></font>SelectObject<font color="#000080">(</font>MetaDC<font color="#000080">, </font>GetClassWord<font color="#000080">(</font>hWindow<font color="#000080">, </font>gcw_hbrBackground<font color="#000080">));
          </font>PatBlt<font color="#000080">(</font>MetaDC<font color="#000080">, </font>Left<font color="#000080">, </font>Top<font color="#000080">, </font>Right<font color="#000080">, </font>Bottom<font color="#000080">, </font>PatCopy<font color="#000080">);
          </font>SelectObject<font color="#000080">(</font>MetaDC<font color="#000080">, </font>GetStockObject<font color="#000080">(</font>Hollow_Brush<font color="#000080">));
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>DrawContents<font color="#000080">(</font>MetaDC<font color="#000080">, </font>PaintStruct<font color="#000080">); 
       </font><font color="#008000"><i>{ DrawContents does the actual drawing. It is also called by
         my painting and printing handlers. DrawContents assumes it
         is working in MM_TEXT mode, when the output is going to a
         metafile, the actual mapping mode is MM_ANISOTROPIC, but
         resembling MM_TEXT on any device. }

  </i></font>DrawMetafile <font color="#000080">:= </font>CloseMetaFile<font color="#000080">(</font>MetaDC<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0060.PAS">Original</a><b>]</b></p></body>
</html>
