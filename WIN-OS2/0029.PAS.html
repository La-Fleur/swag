<html>
<head><title> "objects > 64K" by SWAG SUPPORT TEAM</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0029.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#FF0000"><b>unit </b></font>BigArray<font color="#000080">;

</font><font color="#008000"><i>{ This unit contains an objects that allows for the creation of
  arrays larger than 64K.                                       }

</i></font><font color="#FF0000"><b>interface

</b></font><font color="#008000"><i>{ The ifdefs allow compiling under windows or protected mode }

{$ifdef windows}
</i></font><font color="#FF0000"><b>uses </b></font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>WinAPI<font color="#000080">;
</font><font color="#008000"><i>{$else}
</i></font><font color="#FF0000"><b>uses </b></font>WinAPI<font color="#000080">;
</font><font color="#008000"><i>{$endif}

</i></font><font color="#FF0000"><b>const
  </b></font>SegSize <font color="#000080">= </font><font color="#800000">65536</font><font color="#000080">;                  </font><font color="#008000"><i>{ Size of a selector }

{ Our BigArray object will allow us to allocate large chucks of memory
  (&gt;64k) and index our way through the items }
</i></font><font color="#FF0000"><b>type
  </b></font>PBigArray <font color="#000080">= ^</font>TBigArray<font color="#000080">;
  </font>TBigArray <font color="#000080">= </font><font color="#FF0000"><b>object
    </b></font>MemStart <font color="#000080">: </font>THandle<font color="#000080">;
    </font>MemOffset <font color="#000080">: </font>longint<font color="#000080">;
    </font>MemSize <font color="#000080">: </font>longint<font color="#000080">;
    </font>MaxItems <font color="#000080">: </font>longint<font color="#000080">;
    </font>ItemSize <font color="#000080">: </font>longint<font color="#000080">;
    </font><font color="#FF0000"><b>constructor </b></font>Init<font color="#000080">(</font>NoItems <font color="#000080">: </font>longint<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
    </font><font color="#FF0000"><b>destructor </b></font>Done<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>PutData<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Item<font color="#000080">; </font>Index <font color="#000080">: </font>longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>GetData<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Item<font color="#000080">; </font>Index <font color="#000080">: </font>longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>procedure </b></font>Resize<font color="#000080">(</font>NoItems <font color="#000080">: </font>longint<font color="#000080">); </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>GetMeMSize <font color="#000080">: </font>longint<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

constructor </b></font>TBigArray<font color="#000080">.</font>Init<font color="#000080">(</font>NoItems <font color="#000080">: </font>longint<font color="#000080">; </font>Size <font color="#000080">: </font>Word<font color="#000080">);
</font><font color="#008000"><i>{ Determine the size of the memory we need, allocate using the
  GlobalAlloc() routine, and initialize the fields }
</i></font><font color="#FF0000"><b>begin
  </b></font>MaxItems <font color="#000080">:= </font>NoItems<font color="#000080">;
  </font>ItemSize <font color="#000080">:= </font>Size<font color="#000080">;
  </font><font color="#008000"><i>{ compute memory size }
  </i></font>MemSize <font color="#000080">:= </font>MaxItems <font color="#000080">* </font>ItemSize<font color="#000080">;
  </font><font color="#008000"><i>{ allocate the memory }
  </i></font>MemStart <font color="#000080">:= </font>GlobalAlloc<font color="#000080">(</font>gmem_Moveable<font color="#000080">, </font>MemSize<font color="#000080">);
  </font><font color="#008000"><i>{ any error? }
  </i></font><font color="#FF0000"><b>if </b></font>MemStart <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>RunError<font color="#000080">(</font><font color="#800000">203</font><font color="#000080">);

  </font>MemOffset <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>TBigArray<font color="#000080">.</font>Done<font color="#000080">;
</font><font color="#008000"><i>{ Free up the memory }
</i></font><font color="#FF0000"><b>begin
  </b></font>GlobalFree<font color="#000080">(</font>MemStart<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TBigArray<font color="#000080">.</font>PutData<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Item<font color="#000080">; </font>Index <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#008000"><i>{ Put the item in the allocated memory }
</i></font><font color="#FF0000"><b>var
  </b></font>Sel<font color="#000080">, </font>Off <font color="#000080">: </font>word<font color="#000080">;
  </font>P <font color="#000080">: </font>pointer<font color="#000080">;
  </font>FinishIt <font color="#000080">: </font>boolean<font color="#000080">;
  </font>TempItemSize <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Index <font color="#000080">&gt;= </font>MaxItems <font color="#FF0000"><b>then
    </b></font>RunError<font color="#000080">(</font><font color="#800000">201</font><font color="#000080">);

  </font>inc<font color="#000080">(</font>MemOffset<font color="#000080">, </font>ItemSize<font color="#000080">);

  </font><font color="#008000"><i>{ compute index into memory }
  </i></font>Index <font color="#000080">:= </font>Index <font color="#000080">* </font>ItemSize<font color="#000080">;
  </font><font color="#008000"><i>{ determine the starting selector to access }
  </i></font>Sel <font color="#000080">:= (</font>Index <font color="#FF0000"><b>div </b></font>SegSize<font color="#000080">) * </font>SelectorInc <font color="#000080">+ </font>MemStart<font color="#000080">;
  </font><font color="#008000"><i>{ determine the offset into that selector }
  </i></font>Off <font color="#000080">:= </font>Index <font color="#FF0000"><b>mod </b></font>SegSize<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>SegSize <font color="#000080">- </font>Off<font color="#000080">) &lt; </font>ItemSize <font color="#FF0000"><b>then begin
    </b></font>TempItemSize <font color="#000080">:= </font>SegSize <font color="#000080">- </font>Off<font color="#000080">;
    </font>FinishIt <font color="#000080">:= </font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else begin
    </b></font>TempItemSize <font color="#000080">:= </font>ItemSize<font color="#000080">;
    </font>FinishIt <font color="#000080">:= </font>false<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ lock the memory - this only applies to windows }
  </i></font>GlobalLock<font color="#000080">(</font>Sel<font color="#000080">);

  </font><font color="#008000"><i>{ get the pointer value }
  </i></font>P <font color="#000080">:= </font>ptr<font color="#000080">(</font>Sel<font color="#000080">, </font>Off<font color="#000080">);

  </font><font color="#008000"><i>{ move the data into memory }
  </i></font>Move<font color="#000080">(</font>Item<font color="#000080">, </font>P<font color="#000080">^, </font>TempItemSize<font color="#000080">);

  </font><font color="#008000"><i>{ unlock the memory - this only applies to windows }
  </i></font>GlobalUnLock<font color="#000080">(</font>Sel<font color="#000080">);

  </font><font color="#FF0000"><b>if </b></font>FinishIt <font color="#FF0000"><b>then begin
    </b></font>Sel <font color="#000080">:= </font>Sel <font color="#000080">+ </font>SelectorInc<font color="#000080">;
    </font>Off <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#008000"><i>{ lock the memory - this only applies to windows }
    </i></font>GlobalLock<font color="#000080">(</font>Sel<font color="#000080">);

    </font><font color="#008000"><i>{ get the pointer value }
    </i></font>P <font color="#000080">:= </font>ptr<font color="#000080">(</font>Sel<font color="#000080">, </font>Off<font color="#000080">);

    </font><font color="#008000"><i>{ move the data into memory }
    </i></font>Move<font color="#000080">(</font>Item<font color="#000080">, </font>P<font color="#000080">^, </font>TempItemSize<font color="#000080">);

    </font><font color="#008000"><i>{ unlock the memory - this only applies to windows }
    </i></font>GlobalUnLock<font color="#000080">(</font>Sel<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TBigArray<font color="#000080">.</font>GetData<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>Item<font color="#000080">; </font>Index <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#008000"><i>{ Get the item out of memory }
</i></font><font color="#FF0000"><b>var
  </b></font>Sel<font color="#000080">, </font>Off <font color="#000080">: </font>word<font color="#000080">;
  </font>P <font color="#000080">: </font>pointer<font color="#000080">;
  </font>FinishIt <font color="#000080">: </font>boolean<font color="#000080">;
  </font>TempItemSize <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Index <font color="#000080">&gt;= </font>MaxItems <font color="#FF0000"><b>then
    </b></font>RunError<font color="#000080">(</font><font color="#800000">201</font><font color="#000080">);

  </font><font color="#008000"><i>{ compute index into memory }
  </i></font>Index <font color="#000080">:= </font>Index <font color="#000080">* </font>ItemSize<font color="#000080">;
  </font><font color="#008000"><i>{ determine the starting selector to access }
  </i></font>Sel <font color="#000080">:= (</font>Index <font color="#FF0000"><b>div </b></font>SegSize<font color="#000080">) * </font>SelectorInc <font color="#000080">+ </font>MemStart<font color="#000080">;
  </font><font color="#008000"><i>{ determine the offset into that selector }
  </i></font>Off <font color="#000080">:= </font>Index <font color="#FF0000"><b>mod </b></font>SegSize<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>SegSize <font color="#000080">- </font>Off<font color="#000080">) &lt; </font>ItemSize <font color="#FF0000"><b>then begin
    </b></font>TempItemSize <font color="#000080">:= </font>SegSize <font color="#000080">- </font>Off<font color="#000080">;
    </font>FinishIt <font color="#000080">:= </font>true<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else begin
    </b></font>TempItemSize <font color="#000080">:= </font>ItemSize<font color="#000080">;
    </font>FinishIt <font color="#000080">:= </font>false<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ lock the memory - this only applies to windows }
  </i></font>GlobalLock<font color="#000080">(</font>Sel<font color="#000080">);

  </font><font color="#008000"><i>{ get the pointer value }
  </i></font>P <font color="#000080">:= </font>ptr<font color="#000080">(</font>Sel<font color="#000080">, </font>Off<font color="#000080">);

  </font><font color="#008000"><i>{ move the data from memory to the field }
  </i></font>Move<font color="#000080">(</font>P<font color="#000080">^, </font>Item<font color="#000080">, </font>TempItemSize<font color="#000080">);

  </font><font color="#008000"><i>{ unlock the memory - this only applies to windows }
  </i></font>GlobalUnLock<font color="#000080">(</font>Sel<font color="#000080">);

  </font><font color="#FF0000"><b>if </b></font>FinishIt <font color="#FF0000"><b>then begin
    </b></font>Sel <font color="#000080">:= </font>Sel <font color="#000080">+ </font>SelectorInc<font color="#000080">;
    </font>Off <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#008000"><i>{ lock the memory - this only applies to windows }
    </i></font>GlobalLock<font color="#000080">(</font>Sel<font color="#000080">);

    </font><font color="#008000"><i>{ get the pointer value }
    </i></font>P <font color="#000080">:= </font>ptr<font color="#000080">(</font>Sel<font color="#000080">, </font>Off<font color="#000080">);

    </font><font color="#008000"><i>{ move the data into memory }
    </i></font>Move<font color="#000080">(</font>Item<font color="#000080">, </font>P<font color="#000080">^, </font>TempItemSize<font color="#000080">);

    </font><font color="#008000"><i>{ unlock the memory - this only applies to windows }
    </i></font>GlobalUnLock<font color="#000080">(</font>Sel<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>dec<font color="#000080">(</font>MemOffset<font color="#000080">, </font>ItemSize<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>TBigArray<font color="#000080">.</font>Resize<font color="#000080">(</font>NoItems <font color="#000080">: </font>longint<font color="#000080">);
</font><font color="#008000"><i>{ With a call to GlobalReAlloc() we can resize the array with out
  loosing any data.  Here we also reinitialize the fields }
</i></font><font color="#FF0000"><b>var
  </b></font>TempMem <font color="#000080">: </font>THandle<font color="#000080">;
</font><font color="#FF0000"><b>begin

  </b></font>MaxItems <font color="#000080">:= </font>NoItems<font color="#000080">;
  </font><font color="#008000"><i>{ compute new memory size }
  </i></font>MemSize <font color="#000080">:= </font>MaxItems <font color="#000080">* </font>ItemSize<font color="#000080">;
  </font><font color="#008000"><i>{ resize the memory allocated }
  </i></font>TempMem <font color="#000080">:= </font>GlobalReAlloc<font color="#000080">(</font>MemStart<font color="#000080">, </font>MemSize<font color="#000080">, </font>gmem_Moveable<font color="#000080">);
  </font><font color="#008000"><i>{ any errors? }
  </i></font><font color="#FF0000"><b>if </b></font>TempMem <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>RunError<font color="#000080">(</font><font color="#800000">203</font><font color="#000080">);

  </font>MemStart <font color="#000080">:= </font>TempMem<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TBigArray<font color="#000080">.</font>GetMemSize <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#008000"><i>{ returns the current number of bytes allocated for the array }
</i></font><font color="#FF0000"><b>begin
  </b></font>GetMemSize <font color="#000080">:= </font>MemSize<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{------------------------    DEMO PROGRAM  --------------------- }

</i></font><font color="#FF0000"><b>program </b></font>TestBigArray<font color="#000080">;

</font><font color="#008000"><i>{$ifdef Windows}
</i></font><font color="#FF0000"><b>uses </b></font>WinDos<font color="#000080">, </font>WinCrt<font color="#000080">, </font>WinTypes<font color="#000080">, </font>WinProcs<font color="#000080">, </font>BigArray<font color="#000080">;
</font><font color="#008000"><i>{$else}
</i></font><font color="#FF0000"><b>uses </b></font>Dos<font color="#000080">, </font>Crt<font color="#000080">, </font>WinAPI<font color="#000080">, </font>BigArray<font color="#000080">;
</font><font color="#008000"><i>{$endif}

</i></font><font color="#FF0000"><b>const
  </b></font>elnum <font color="#000080">= </font><font color="#800000">2000</font><font color="#000080">;
</font><font color="#FF0000"><b>type
  </b></font>TRec <font color="#000080">= </font><font color="#FF0000"><b>record
    </b></font>i <font color="#000080">: </font>integer<font color="#000080">;
    </font>r <font color="#000080">: </font>real<font color="#000080">;
    </font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
    </font>a <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">3000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>Rec <font color="#000080">: </font>TRec<font color="#000080">;
  </font>BArray <font color="#000080">: </font>PBigArray<font color="#000080">;
  </font>X <font color="#000080">: </font>longint<font color="#000080">;
</font><font color="#FF0000"><b>begin

  </b></font>clrscr<font color="#000080">;

  </font>writeln<font color="#000080">(</font><font color="#800000">'memory available = '</font><font color="#000080">, </font>memavail<font color="#000080">);

  </font>new<font color="#000080">(</font>BArray<font color="#000080">, </font>Init<font color="#000080">(</font>elnum<font color="#000080">, </font>SizeOf<font color="#000080">(</font>TRec<font color="#000080">)));

  </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>elnum<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do begin
    </b></font>Rec<font color="#000080">.</font>i <font color="#000080">:= </font>x<font color="#000080">;
    </font>BArray<font color="#000080">^.</font>PutData<font color="#000080">(</font>Rec<font color="#000080">, </font>x<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#FF0000"><b>for </b></font>x <font color="#000080">:= </font>elnum<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>downto </b></font><font color="#800000">0 </font><font color="#FF0000"><b>do begin
    </b></font>BArray<font color="#000080">^.</font>GetData<font color="#000080">(</font>Rec<font color="#000080">, </font>x<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>x <font color="#000080">&lt;&gt; </font>Rec<font color="#000080">.</font>i <font color="#FF0000"><b>then
      </b></font>writeln<font color="#000080">(</font>Rec<font color="#000080">.</font>i<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font>writeln<font color="#000080">(</font><font color="#800000">'first size of mem for array = '</font><font color="#000080">, </font>BArray<font color="#000080">^.</font>GetMemSize<font color="#000080">);

</font><font color="#008000"><i>{  BArray^.Resize(20000);

  for x := 10000 to 19999 do begin
    Rec.i := x;
    BArray^.PutData(Rec, x);
  end;

  for x := 19999 downto 0 do begin
    BArray^.GetData(Rec, x);
    writeln(Rec.i);
  end;

  writeln('second size of mem for array = ', BArray^.GetMemSize);
}
  </i></font>dispose<font color="#000080">(</font>BArray<font color="#000080">, </font>Done<font color="#000080">);
  </font>readln<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to WIN-OS2 SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0029.PAS">Original</a><b>]</b></p></body>
</html>
