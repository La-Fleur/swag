<html>
<head><title> "Setting Bit Flags in ASM" by DON PAULSEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to NUMBERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0042.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
Date:   02-05-95
From:   DON PAULSEN


        This unit provides routines to manipulate individual bits
        in memory, including test, set, clear, and toggle.  You may
        also count the number of bits set with NumFlagsSet, and get
        a &quot;picture&quot; of them with the function FlagString.

        All the routines are in the interface section to provide
        complete low-level control of your own data space used for
        flags.  Usually the oFlags object will be most convenient.
        Just initialize the object with the number of flags required,
        and it will allocate sufficient memory on the heap and clear
        them to zero.
*)


</i></font><font color="#FF0000"><b>UNIT </b></font>DpFlags<font color="#000080">;

</font><font color="#008000"><i>{$A+,B-,D-,E-,F-,G-,I-,L-,N-,O-,R-,S-,V-,X-}
{$IFDEF VER70} {$P-,Q-,T-,Y-} {$ENDIF}

(*
    File(s)         DPFLAGS.PAS
    Unit(s)         None
    Compiler        Turbo Pascal v6.0+
    Author          Don Paulsen
    v1.00 Date       7-01-92
    Last Change     11-12-93
    Version         1.11
*)

{ Flags are numbered from left to right (low memory to high memory),
  starting with 0, to a maximum of 65520.  If the flags object isn't used,
  use the System.FillChar routine to set or clear all the flags at once.
  The memory for storing the flags can be allocated in the data segment
  or on the heap.

  Here are two methods for declaring an array for the flags (not needed if
  the oFlags object is used):

    CONST
       cMaxFlagNumber = 50;
       cNumberOfFlags = 51;

    VAR
       flags_A : array [0..(cMaxFlagNumber div 8)] of byte;
       flags_B : array [0..(cNumberOfFlags - 1) div 8] of byte;

  Note that since the first flag is flag 0, cNumberOfFlags is always 1 greater
  than cMaxFlagNumber. }


</i></font><font color="#FF0000"><b>INTERFACE

PROCEDURE </b></font>SetFlag     <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>PROCEDURE </b></font>ClearFlag   <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>PROCEDURE </b></font>ToggleFlag  <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>FUNCTION  </b></font>FlagIsSet   <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum <font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>NumFlagsSet <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>numFlags<font color="#000080">: </font>word<font color="#000080">): </font>word<font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION  </b></font>FlagString  <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>numFlags<font color="#000080">: </font>word<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>TYPE
    </b></font>tFlags <font color="#000080">= ^</font>oFlags<font color="#000080">;
    </font>oFlags <font color="#000080">= </font><font color="#FF0000"><b>OBJECT
               CONSTRUCTOR </b></font>Init <font color="#000080">(</font>numberOfFlags<font color="#000080">: </font>word<font color="#000080">);
               </font><font color="#FF0000"><b>PROCEDURE   </b></font>ClearAllFlags<font color="#000080">;
               </font><font color="#FF0000"><b>PROCEDURE   </b></font>SetAllFlags<font color="#000080">;
               </font><font color="#FF0000"><b>PROCEDURE   </b></font>SetFlag    <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">);
               </font><font color="#FF0000"><b>PROCEDURE   </b></font>ClearFlag  <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">);
               </font><font color="#FF0000"><b>PROCEDURE   </b></font>ToggleFlag <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">);
               </font><font color="#FF0000"><b>FUNCTION    </b></font>FlagIsSet  <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">;
               </font><font color="#FF0000"><b>FUNCTION    </b></font>NumFlagsSet <font color="#000080">: </font>word<font color="#000080">;
               </font><font color="#FF0000"><b>FUNCTION    </b></font>FlagString  <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
               </font><font color="#FF0000"><b>DESTRUCTOR  </b></font>Done<font color="#000080">;
             </font><font color="#FF0000"><b>PRIVATE
                </b></font>flags    <font color="#000080">: </font>pointer<font color="#000080">;
                </font>numFlags <font color="#000080">: </font>word<font color="#000080">;
             </font><font color="#FF0000"><b>END</b></font><font color="#000080">;


</font><font color="#FF0000"><b>IMPLEMENTATION

</b></font><font color="#008000"><i>{=======================================================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>SetFlag <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum<font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">les     di, flags
    mov     cx, flagNum
    mov     bx, cx
    shr     bx, 1
    shr     bx, 1
    shr     bx, 1
    and     cl, 7
    mov     al, 80h
    shr     al, cl
    or      es:[di][bx], al
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{=========================================================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ClearFlag <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum<font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">les     di, flags
    mov     cx, flagNum
    mov     bx, cx
    shr     bx, 1
    shr     bx, 1
    shr     bx, 1
    and     cl, 7
    mov     al, 7Fh
    ror     al, cl
    and     es:[di][bx], al
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{==========================================================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>ToggleFlag <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum<font color="#000080">: </font>word<font color="#000080">); </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">les     di, flags
    mov     cx, flagNum
    mov     bx, cx
    shr     bx, 1
    shr     bx, 1
    shr     bx, 1
    and     cl, 7
    mov     al, 80h
    shr     al, cl
    xor     es:[di][bx], al
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{=================================================================}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>FlagIsSet <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>flagNum<font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">les     di, flags
    mov     cx, flagNum
    mov     bx, cx
    shr     bx, 1
    shr     bx, 1
    shr     bx, 1
    and     cl, 7
    inc     cx
    mov     al, es:[di][bx]
    rol     al, cl
    and     al, 1
@done:
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{=================================================================}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>NumFlagsSet <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>numFlags<font color="#000080">: </font>word<font color="#000080">): </font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">push    ds
    cld
    lds     si, flags
    xor     bx, bx
    mov     cx, numFlags
    mov     dx, cx
    xor     di, di
    shr     cx, 1
    shr     cx, 1
    shr     cx, 1
    jcxz    @remainder
@byte8:
    lodsb
    shl     al, 1;  adc     bx, di
    shl     al, 1;  adc     bx, di
    shl     al, 1;  adc     bx, di
    shl     al, 1;  adc     bx, di
    shl     al, 1;  adc     bx, di
    shl     al, 1;  adc     bx, di
    shl     al, 1;  adc     bx, di
    shl     al, 1;  adc     bx, di
    loop    @byte8
@remainder:
    mov     cx, dx
    and     cx, 7
    jz      @done
    lodsb
@bit:
    shl     al, 1
    adc     bx, di
    loop    @bit
@done:
    mov     ax, bx
    pop     ds
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{==================================================================}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>FlagString <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>flags<font color="#000080">; </font>numFlags<font color="#000080">: </font>word<font color="#000080">): </font><font color="#FF0000"><b>string</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Returns a string of 0's &amp; 1's showing the flags.  Note that at most 255
  flags can shown in a string.  Returns nul if numFlags is 0 or greater
  than 255. }

</i></font><font color="#FF0000"><b>ASM
    </b></font><font color="#FF00FF">push    ds
    cld
    lds     si, flags
    les     di, @result
    mov     cx, numflags
    or      ch, ch
    jz      @ok
    xor     cx, cx
@ok:
    mov     al, cl
    stosb                   </font><font color="#008000"><i>{ length of string }
    </i></font><font color="#FF00FF">jcxz    @done
    mov     dx, cx
    push    dx              </font><font color="#008000"><i>{ save number of flags }
    </i></font><font color="#FF00FF">mov     ah, '0'
    shr     dl, 1
    shr     dl, 1
    shr     dl, 1
    jz      @remainder
@byte8:                     </font><font color="#008000"><i>{ do 8 bits at a time }
    </i></font><font color="#FF00FF">lodsb
    mov     bl, al
    mov     cl, 8
@bit8:
    mov     al, ah          </font><font color="#008000"><i>{ ah = '0' }
    </i></font><font color="#FF00FF">shl     bl, 1
    adc     al, dh          </font><font color="#008000"><i>{ dh = 0 }
    </i></font><font color="#FF00FF">stosb
    loop    @bit8
    dec     dl
    jnz     @byte8

@remainder:                 </font><font color="#008000"><i>{ do remaining (numFlags mod 8) bits }
    </i></font><font color="#FF00FF">pop     dx
    mov     cx, dx
    and     cl, 7           </font><font color="#008000"><i>{ 0 &lt;= cx &lt;= 7 (number of flags in partial byte) }
    </i></font><font color="#FF00FF">jz      @done
    lodsb                   </font><font color="#008000"><i>{ last byte containing flags  }
    </i></font><font color="#FF00FF">mov     bl, al
@bit:
    mov     al, ah          </font><font color="#008000"><i>{ ah = '0' }
    </i></font><font color="#FF00FF">shl     bl, 1
    adc     al, dh          </font><font color="#008000"><i>{ dh = 0 }
    </i></font><font color="#FF00FF">stosb
    loop    @bit
@done:
    pop     ds
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{=============================================}
</i></font><font color="#FF0000"><b>CONSTRUCTOR </b></font>oFlags<font color="#000080">.</font>Init <font color="#000080">(</font>numberOfFlags<font color="#000080">: </font>word<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
    if </b></font>numberOfFlags <font color="#000080">&gt; </font><font color="#800000">65520 </font><font color="#FF0000"><b>then </b></font>FAIL<font color="#000080">;
    </font>numFlags<font color="#000080">:= </font>numberOfFlags<font color="#000080">;
    </font>GetMem <font color="#000080">(</font>flags<font color="#000080">, (</font>numFlags <font color="#000080">+ </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">8</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>flags <font color="#000080">= </font><font color="#FF0000"><b>nil then </b></font>FAIL<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{==============================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>oFlags<font color="#000080">.</font>ClearAllFlags<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
    </b></font>FillChar <font color="#000080">(</font>flags<font color="#000080">^, (</font>numFlags <font color="#000080">+ </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">#0</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{============================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>oFlags<font color="#000080">.</font>SetAllFlags<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
    </b></font>FillChar <font color="#000080">(</font>flags<font color="#000080">^, (</font>numFlags <font color="#000080">+ </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">8</font><font color="#000080">, </font><font color="#800000">#1</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{========================================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>oFlags<font color="#000080">.</font>SetFlag <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
    </b></font>DpFlags<font color="#000080">.</font>SetFlag <font color="#000080">(</font>flags<font color="#000080">^, </font>flagNum<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{==========================================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>oFlags<font color="#000080">.</font>ClearFlag <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
    </b></font>DpFlags<font color="#000080">.</font>ClearFlag <font color="#000080">(</font>flags<font color="#000080">^, </font>flagNum<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{===========================================}
</i></font><font color="#FF0000"><b>PROCEDURE </b></font>oFlags<font color="#000080">.</font>ToggleFlag <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">);

</font><font color="#FF0000"><b>BEGIN
    </b></font>DpFlags<font color="#000080">.</font>ToggleFlag <font color="#000080">(</font>flags<font color="#000080">^, </font>flagNum<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{==================================================}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>oFlags<font color="#000080">.</font>FlagIsSet <font color="#000080">(</font>flagNum<font color="#000080">: </font>word<font color="#000080">): </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
    </b></font>FlagIsSet<font color="#000080">:= </font>DpFlags<font color="#000080">.</font>FlagIsSet <font color="#000080">(</font>flags<font color="#000080">^, </font>flagNum<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{=================================}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>oFlags<font color="#000080">.</font>NumFlagsSet<font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
    </b></font>NumFlagsSet<font color="#000080">:= </font>DpFlags<font color="#000080">.</font>NumFlagsSet <font color="#000080">(</font>flags<font color="#000080">^, </font>numFlags<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{==================================}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>oFlags<font color="#000080">.</font>FlagString<font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>VAR
    </b></font>w <font color="#000080">: </font>word<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
    </b></font>w<font color="#000080">:= </font>numFlags<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>w <font color="#000080">&gt; </font><font color="#800000">255 </font><font color="#FF0000"><b>then </b></font>w<font color="#000080">:= </font><font color="#800000">255</font><font color="#000080">;
    </font>FlagString<font color="#000080">:= </font>DpFlags<font color="#000080">.</font>FlagString <font color="#000080">(</font>flags<font color="#000080">^, </font>w<font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#008000"><i>{======================}
</i></font><font color="#FF0000"><b>DESTRUCTOR </b></font>oFlags<font color="#000080">.</font>Done<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
    if </b></font>flags <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>FreeMem <font color="#000080">(</font>flags<font color="#000080">, (</font>numFlags <font color="#000080">+ </font><font color="#800000">7</font><font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">8</font><font color="#000080">);
</font><font color="#FF0000"><b>END</b></font><font color="#000080">;

</font><font color="#FF0000"><b>END</b></font><font color="#000080">.        </font><font color="#008000"><i>{ Unit DpFlags }

</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to NUMBERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0042.PAS">Original</a><b>]</b></p></body>
</html>
