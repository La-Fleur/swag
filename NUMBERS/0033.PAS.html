<html>
<head><title> "More Get/Set Bits" by ROBERT ROTHENBURG</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to NUMBERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0033.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Robert Rothenburg

Here's some routines I wrote while playing around with some compression
algorithms.  Since they're written in Pascal, they're probably not too
fast but they work.


Of course they're need some tweaking.
}
(* NoFrills Bit-Input/Output Routines                        *)
(* Insert &quot;n&quot; bits of data into a Buffer or Pull &quot;n&quot; bits of *)
(* data from a buffer.  Useful for Compression routines      *)


</i></font><font color="#FF0000"><b>unit </b></font>BitIO<font color="#000080">;

</font><font color="#FF0000"><b>interface

const
  </b></font>BufferSize <font color="#000080">= </font><font color="#800000">32767</font><font color="#000080">;        </font><font color="#008000"><i>(* Adjust as appropriate *)

</i></font><font color="#FF0000"><b>type
  </b></font>Buffer  <font color="#000080">= </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>BufferSize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>BufPtr  <font color="#000080">= ^</font>Buffer<font color="#000080">;
  </font>BuffRec <font color="#000080">= </font><font color="#FF0000"><b>record  </b></font><font color="#008000"><i>(* This was used for I/O by some *)
    </i></font>Block <font color="#000080">: </font>BufPtr<font color="#000080">; </font><font color="#008000"><i>(* other units involved with the *)
    </i></font>Size<font color="#000080">,           </font><font color="#008000"><i>(* compression stuff. Not so     *)
    </i></font>Ptr   <font color="#000080">: </font>word<font color="#000080">;   </font><font color="#008000"><i>(* Important?                    *)
    </i></font>Loc   <font color="#000080">: </font>byte
  <font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>InBuffer<font color="#000080">,
  </font>OutBuffer <font color="#000080">: </font>BuffRec<font color="#000080">;
  </font>InFile<font color="#000080">,
  </font>OutFile   <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>InitBuffer<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>x <font color="#000080">: </font>BuffRec<font color="#000080">);        </font><font color="#008000"><i>(* Initialize a buffer *)
</i></font><font color="#FF0000"><b>procedure </b></font>GetBits<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>b <font color="#000080">: </font>word<font color="#000080">; </font>num <font color="#000080">: </font>byte<font color="#000080">);  </font><font color="#008000"><i>(* Get num bits from   *)
                                              (* InBuffer            *)
</i></font><font color="#FF0000"><b>procedure </b></font>PutBits<font color="#000080">(</font>b <font color="#000080">: </font>word<font color="#000080">; </font>num <font color="#000080">: </font>byte<font color="#000080">);      </font><font color="#008000"><i>(* Put num bits into   *)
                                              (* OutBuffer           *)
</i></font><font color="#FF0000"><b>function </b></font>Log2<font color="#000080">(</font>x <font color="#000080">: </font>word<font color="#000080">) : </font>byte<font color="#000080">;               </font><font color="#008000"><i>(* Self-explanatory... *)

</i></font><font color="#FF0000"><b>implementation

const
  </b></font>Power <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">17</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>longint <font color="#000080">=
    (</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">4</font><font color="#000080">,</font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">16</font><font color="#000080">,</font><font color="#800000">32</font><font color="#000080">,</font><font color="#800000">64</font><font color="#000080">,</font><font color="#800000">128</font><font color="#000080">,</font><font color="#800000">256</font><font color="#000080">,</font><font color="#800000">512</font><font color="#000080">,</font><font color="#800000">1024</font><font color="#000080">,</font><font color="#800000">2048</font><font color="#000080">,</font><font color="#800000">4096</font><font color="#000080">,</font><font color="#800000">8192</font><font color="#000080">,</font><font color="#800000">16384</font><font color="#000080">,</font><font color="#800000">32768</font><font color="#000080">,</font><font color="#800000">65536</font><font color="#000080">);

</font><font color="#FF0000"><b>procedure </b></font>InitBuffer<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>x <font color="#000080">: </font>BuffRec<font color="#000080">);
</font><font color="#FF0000"><b>begin
  with </b></font>x <font color="#FF0000"><b>do
  begin
    </b></font>Loc  <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
    </font>Ptr  <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>Size <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font>New<font color="#000080">(</font>Block<font color="#000080">);
    </font>FillChar<font color="#000080">(</font>Block<font color="#000080">^, </font>BufferSize<font color="#000080">, </font><font color="#800000">#0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>GetBits<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>b <font color="#000080">: </font>word<font color="#000080">; </font>num <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Size <font color="#000080">: </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
  with </b></font>InBuffer <font color="#FF0000"><b>do
  begin
    </b></font>b <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>repeat
      </b></font>b <font color="#000080">:= (</font>b <font color="#FF0000"><b>SHL </b></font><font color="#800000">1</font><font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Block<font color="#000080">^[</font>Ptr<font color="#000080">] </font><font color="#FF0000"><b>AND </b></font>Power<font color="#000080">[</font>Loc<font color="#000080">]) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        </b></font>b <font color="#000080">:= </font>b <font color="#FF0000"><b>OR </b></font><font color="#800000">1</font><font color="#000080">;
      </font>dec<font color="#000080">(</font>Loc<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>Loc <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        </b></font>Loc <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
        </font>inc<font color="#000080">(</font>Ptr<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font>dec<font color="#000080">(</font>num<font color="#000080">);
    </font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>num <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>PutBits<font color="#000080">(</font>b <font color="#000080">: </font>word<font color="#000080">; </font>num <font color="#000080">: </font>byte<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  with </b></font>OutBuffer <font color="#FF0000"><b>do
  repeat
    if </b></font>Loc <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>inc<font color="#000080">(</font>Ptr<font color="#000080">);
      </font>Loc <font color="#000080">:= </font><font color="#800000">8</font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>b <font color="#FF0000"><b>AND </b></font>Power<font color="#000080">[</font>num<font color="#000080">]) &lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
    begin
      </b></font>Block<font color="#000080">^[</font>Ptr<font color="#000080">] := </font>Block<font color="#000080">^[</font>Ptr<font color="#000080">] </font><font color="#FF0000"><b>OR </b></font>Power<font color="#000080">[</font>Loc<font color="#000080">];
      </font>dec<font color="#000080">(</font>Loc<font color="#000080">);
    </font><font color="#FF0000"><b>end
    else
      </b></font>dec<font color="#000080">(</font>Loc<font color="#000080">);
    </font>dec<font color="#000080">(</font>num<font color="#000080">)
  </font><font color="#FF0000"><b>until </b></font>num <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">;
  </font>OutBuffer<font color="#000080">.</font>Size <font color="#000080">:= </font>succ<font color="#000080">(</font>OutBuffer<font color="#000080">.</font>Ptr<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>Log2<font color="#000080">(</font>x <font color="#000080">: </font>word<font color="#000080">) : </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>i <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>i <font color="#000080">:= </font><font color="#800000">17</font><font color="#000080">;
  </font><font color="#FF0000"><b>while </b></font>x<font color="#000080">&lt;</font>Power<font color="#000080">[</font>i<font color="#000080">] </font><font color="#FF0000"><b>do
    </b></font>dec<font color="#000080">(</font>i<font color="#000080">);
  </font>Log2 <font color="#000080">:= </font>i<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to NUMBERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0033.PAS">Original</a><b>]</b></p></body>
</html>
