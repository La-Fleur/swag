<html>
<head><title> "Extended to Real Converter" by ERWINK@XS1.XS4ALL.NL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to NUMBERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0071.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
:&gt;I am looking for a routine that can convert the Extended
:&gt;type to and from a real type without the need to use
:&gt;$N+,$E+ in TP. I have got to read a file containing

:In the back of the TP 6.0 and BP 7.0 manuals, it lists the data format for
:the Extended and Real data types. Conversion should be relatively easy from
:Real to Extended, just a few shifts, as the extended mantissa /exponent
:parts are both larger than the corresponding ones for the Real data type.
:For the same reason, conversion to extended from real will be tricky, as the
:value may not be within the range of a real.

: If I remember correctly, the extended type has a 63-bit mantissa, 1 sign
: bit, and a 16-bit exponent. The real type has an 8-bit exponent, 1 sign bit,
: and a 39-bit mantissa.

From: erwink@xs1.xs4all.nl (erwink)

Seems to work. Here is the result of this hard work:
}

</i></font><font color="#FF0000"><b>unit </b></font>convert<font color="#000080">;
</font><font color="#008000"><i>{ converts extended type to real without coprocessor support
  or emulation (so can be compiled with $N-,$E-).
  Extended is represented by an array of 10 bytes.
}


</i></font><font color="#FF0000"><b>Interface

   type
      </b></font>b10 <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">10</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;

   </font><font color="#FF0000"><b>function </b></font>Extended2Real<font color="#000080">(</font>x<font color="#000080">:</font>b10<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>r<font color="#000080">:</font>real<font color="#000080">) : </font>boolean<font color="#000080">;
     </font><font color="#008000"><i>{ converts 10 byte array containing an extended to a real }
     { returns TRUE if ok, FALSE if overflow }
   </i></font><font color="#FF0000"><b>procedure </b></font>Real2Extended<font color="#000080">(</font>r<font color="#000080">:</font>real<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>x<font color="#000080">:</font>b10<font color="#000080">);
     </font><font color="#008000"><i>{ converts real to 10 byte array containing an extended }


</i></font><font color="#FF0000"><b>implementation

const
 </b></font>signmask <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">$80</font><font color="#000080">;
 </font>not_signmask <font color="#000080">: </font>byte <font color="#000080">= </font><font color="#800000">$7F</font><font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>b2 <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
  </font>ff <font color="#000080">= </font><font color="#FF0000"><b>record
          case </b></font>integer <font color="#FF0000"><b>of
             </b></font><font color="#800000">1 </font><font color="#000080">: (</font>r <font color="#000080">: </font>real<font color="#000080">);
             </font><font color="#800000">2 </font><font color="#000080">: (</font>a <font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">);
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>function </b></font>Extended2Real<font color="#000080">(</font>x <font color="#000080">: </font>b10<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>r <font color="#000080">: </font>real<font color="#000080">) : </font>boolean<font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>exp2 <font color="#000080">: </font>b2<font color="#000080">;
  </font>exponent <font color="#000080">: </font>integer<font color="#000080">;
  </font>sign <font color="#000080">: </font>boolean<font color="#000080">;
  </font>i <font color="#000080">: </font>boolean<font color="#000080">;
  </font>m <font color="#000080">: </font>ff<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font><font color="#008000"><i>{ extract sign bit and clear it }
   </i></font>sign <font color="#000080">:= (</font>x<font color="#000080">[</font><font color="#800000">10</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font>signmask<font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">;
   </font>x<font color="#000080">[</font><font color="#800000">10</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">10</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font>not_signmask<font color="#000080">;

   </font><font color="#008000"><i>{ extract exponent }
   </i></font>exp2<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">9</font><font color="#000080">];
   </font>exp2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">10</font><font color="#000080">];
   </font>exponent <font color="#000080">:= </font>integer<font color="#000080">(</font>exp2<font color="#000080">)-</font><font color="#800000">16383</font><font color="#000080">;

   </font><font color="#008000"><i>{ extract this funny number i and clear it }
   </i></font>i <font color="#000080">:= (</font>x<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font>signmask<font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">;
   </font>x<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font>not_signmask<font color="#000080">;

   </font><font color="#008000"><i>{ if i is not set then we had a denormalized number so
     return 0 }
   </i></font><font color="#FF0000"><b>if not </b></font>i <font color="#FF0000"><b>then begin
      </b></font>r <font color="#000080">:= </font><font color="#800000">0.0</font><font color="#000080">;
      </font>Extended2Real <font color="#000080">:= </font>true<font color="#000080">;
      </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#008000"><i>{ extract mantissa }
   </i></font>m<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">];
   </font>m<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">5</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">];
   </font>m<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">];
   </font>m<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">5</font><font color="#000080">];
   </font>m<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>x<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];

   </font><font color="#008000"><i>{ plug in exponent }
   </i></font>exponent <font color="#000080">:= </font>exponent <font color="#000080">+</font><font color="#800000">129</font><font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>exponent <font color="#000080">&gt; </font><font color="#800000">255</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
     </b></font>Extended2Real <font color="#000080">:= </font>false<font color="#000080">;
     </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>exponent <font color="#000080">&lt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
       </b></font><font color="#008000"><i>{ underflow }
       </i></font>r <font color="#000080">:= </font><font color="#800000">0.0</font><font color="#000080">;
       </font>Extended2Real <font color="#000080">:= </font>True<font color="#000080">;
       </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>m<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>exponent<font color="#000080">;

   </font><font color="#008000"><i>{ set sign bit }
   </i></font><font color="#FF0000"><b>if </b></font>sign <font color="#FF0000"><b>then
      </b></font>m<font color="#000080">.</font>r <font color="#000080">:= -</font>m<font color="#000080">.</font>r<font color="#000080">;

   </font>r <font color="#000080">:= </font>m<font color="#000080">.</font>r<font color="#000080">;
   </font>Extended2Real <font color="#000080">:= </font>true<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>real2extended<font color="#000080">(</font>r <font color="#000080">: </font>real<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>x <font color="#000080">: </font>b10<font color="#000080">);

</font><font color="#FF0000"><b>var
   </b></font>sign <font color="#000080">: </font>boolean<font color="#000080">;
   </font>rr <font color="#000080">: </font>ff <font color="#FF0000"><b>absolute </b></font>r<font color="#000080">;
   </font>exp2 <font color="#000080">: </font>b2<font color="#000080">;
   </font>exponent <font color="#000080">: </font>integer<font color="#000080">;
   </font>i <font color="#000080">: </font>integer<font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font><font color="#008000"><i>{ treat 0 specially }
   </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>r<font color="#000080">=</font><font color="#800000">0.0</font><font color="#000080">) </font><font color="#FF0000"><b>then begin
       for </b></font>i <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">10 </font><font color="#FF0000"><b>do
          </b></font>x<font color="#000080">[</font>i<font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
       </font>exit<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#008000"><i>{ extract sign bit and set it }
   </i></font>sign <font color="#000080">:= (</font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font>signmask<font color="#000080">) &lt;&gt; </font><font color="#800000">0</font><font color="#000080">;
   </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">] := </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font>signmask<font color="#000080">;

   </font><font color="#008000"><i>{ copy mantissa }
   </i></font>x<font color="#000080">[</font><font color="#800000">8</font><font color="#000080">] := </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">];
   </font>x<font color="#000080">[</font><font color="#800000">7</font><font color="#000080">] := </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">5</font><font color="#000080">];
   </font>x<font color="#000080">[</font><font color="#800000">6</font><font color="#000080">] := </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">];
   </font>x<font color="#000080">[</font><font color="#800000">5</font><font color="#000080">] := </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">];
   </font>x<font color="#000080">[</font><font color="#800000">4</font><font color="#000080">] := </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
   </font>x<font color="#000080">[</font><font color="#800000">3</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
   </font>x<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
   </font>x<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;

   </font><font color="#008000"><i>{ copy exponent }
   </i></font>exp2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font><font color="#800000">0</font><font color="#000080">;
   </font>exp2<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] := </font>rr<font color="#000080">.</font>a<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">];
   </font>exponent <font color="#000080">:= </font>integer<font color="#000080">(</font>exp2<font color="#000080">)+</font><font color="#800000">16254</font><font color="#000080">;
   </font>exp2 <font color="#000080">:= </font>b2<font color="#000080">(</font>exponent<font color="#000080">);

   </font><font color="#008000"><i>{ plug in sign bit }
   </i></font>exp2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>exp2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>and </b></font>not_signmask<font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>sign <font color="#FF0000"><b>then
      </b></font>exp2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] := </font>exp2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">] </font><font color="#FF0000"><b>or </b></font>signmask<font color="#000080">;

   </font>x<font color="#000080">[</font><font color="#800000">10</font><font color="#000080">] := </font>exp2<font color="#000080">[</font><font color="#800000">2</font><font color="#000080">];
   </font>x<font color="#000080">[</font><font color="#800000">9</font><font color="#000080">] := </font>exp2<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">];
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to NUMBERS SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0071.PAS">Original</a><b>]</b></p></body>
</html>
