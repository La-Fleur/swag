<html>
<head><title> "Text files in pascal." by ITAI HANDLER</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0064.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{ unit for reading text files up to 512K very quickly! }
{ Do whatever you like to this code, but please credit me somehow! }
{ by Itai Handler, FidoNet 2:406/120. }

</i></font><font color="#FF0000"><b>Unit </b></font>FastText<font color="#000080">;

</font><font color="#FF0000"><b>Interface

const
  </b></font>Text_Eof <font color="#000080">: </font>Boolean <font color="#000080">= </font>true<font color="#000080">;
  </font>NoMem    <font color="#000080">: </font>Boolean <font color="#000080">= </font>false<font color="#000080">;

</font><font color="#FF0000"><b>Function  </b></font>Text_Load <font color="#000080">(</font>FN<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Boolean<font color="#000080">;  </font><font color="#008000"><i>{ init memory and read the file }
</i></font><font color="#FF0000"><b>Procedure </b></font>Text_ReadLine <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">);   </font><font color="#008000"><i>{ get line from text }
</i></font><font color="#FF0000"><b>Procedure </b></font>Text_GoBack <font color="#000080">(</font>L<font color="#000080">:</font>Word<font color="#000080">);           </font><font color="#008000"><i>{ updates pointer to L lines back }
</i></font><font color="#FF0000"><b>Function  </b></font>Text_Lines<font color="#000080">:</font>LongInt<font color="#000080">;             </font><font color="#008000"><i>{ calculate how many lines in file }
</i></font><font color="#FF0000"><b>Procedure </b></font>Text_Reset<font color="#000080">;                     </font><font color="#008000"><i>{ reset file &amp; seek to start }
</i></font><font color="#FF0000"><b>Procedure </b></font>Text_Dispose<font color="#000080">;                   </font><font color="#008000"><i>{ free memory }

</i></font><font color="#FF0000"><b>Implementation

Type
  </b></font>BufType<font color="#000080">=</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">64000</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;

</font><font color="#FF0000"><b>Const
  </b></font>PUsed<font color="#000080">:</font>Byte<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;                         </font><font color="#008000"><i>{ # of pointers currently in use }

</i></font><font color="#FF0000"><b>Var
  </b></font>P<font color="#000080">:</font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font><font color="#000080">^</font>BufType<font color="#000080">;            </font><font color="#008000"><i>{ array of 8 pointers (512kb) }
  </i></font>TextSize<font color="#000080">:</font>LongInt<font color="#000080">;                     </font><font color="#008000"><i>{ size of the text file in bytes }
  </i></font>PSeek<font color="#000080">:</font>LongInt<font color="#000080">;
  </font>PCur<font color="#000080">:</font>LongInt<font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Text_Load <font color="#000080">(</font>FN<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font>Boolean<font color="#000080">; </font><font color="#008000"><i>{ init memory and read the file }
  </i></font><font color="#FF0000"><b>Var
    </b></font>FB<font color="#000080">:</font><font color="#FF0000"><b>File of </b></font>Byte<font color="#000080">;
    </font>NumRead<font color="#000080">:</font>Word<font color="#000080">;
    </font>F<font color="#000080">:</font><font color="#FF0000"><b>File</b></font><font color="#000080">;
    </font>B<font color="#000080">:</font>LongInt<font color="#000080">;
    </font>FM<font color="#000080">:</font>Byte<font color="#000080">;
    </font>Tmp<font color="#000080">:</font>LongInt<font color="#000080">;

  </font><font color="#FF0000"><b>Begin
    </b></font>FM<font color="#000080">:=</font>FileMode<font color="#000080">;
    </font>filemode<font color="#000080">:=</font><font color="#800000">64</font><font color="#000080">;
    </font>Text_Load<font color="#000080">:=</font>false<font color="#000080">;
    </font>NoMem<font color="#000080">:=</font>false<font color="#000080">;
    </font>Assign<font color="#000080">(</font>fb<font color="#000080">, </font>FN<font color="#000080">);
    </font>Reset<font color="#000080">(</font>fb<font color="#000080">);
    </font>TextSize<font color="#000080">:=</font>FileSize<font color="#000080">(</font>fb<font color="#000080">);
    </font>Close<font color="#000080">(</font>Fb<font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>MaxAvail<font color="#000080">&gt;=</font>TextSize <font color="#FF0000"><b>then
      Begin
        </b></font>Text_Load<font color="#000080">:=</font>true<font color="#000080">;
        </font><font color="#FF0000"><b>For </b></font>B<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font><font color="#800000">8 </font><font color="#FF0000"><b>do if </b></font>TextSize <font color="#000080">&gt; (( </font>Pred<font color="#000080">(</font>B<font color="#000080">) )*</font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>then
          Begin
            If </b></font>B<font color="#000080">*</font><font color="#800000">64000</font><font color="#000080">&gt;</font>TextSize <font color="#FF0000"><b>then </b></font>Tmp<font color="#000080">:=(</font>TextSize <font color="#FF0000"><b>mod </b></font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>else
              </b></font>Tmp<font color="#000080">:=</font><font color="#800000">64000</font><font color="#000080">;
            </font>GetMem<font color="#000080">(</font>P<font color="#000080">[</font>B<font color="#000080">],</font>Tmp<font color="#000080">);
            </font>Inc<font color="#000080">(</font>PUsed<font color="#000080">);
          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font>Assign<font color="#000080">(</font>f<font color="#000080">, </font>FN<font color="#000080">);
        </font>Reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
        </font><font color="#FF0000"><b>For </b></font>B<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>PUsed <font color="#FF0000"><b>do
          Begin
            If </b></font>B<font color="#000080">*</font><font color="#800000">64000</font><font color="#000080">&gt;</font>TextSize <font color="#FF0000"><b>then </b></font>Tmp<font color="#000080">:=(</font>TextSize <font color="#FF0000"><b>mod </b></font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>else
              </b></font>Tmp<font color="#000080">:=</font><font color="#800000">64000</font><font color="#000080">;
            </font>BlockRead<font color="#000080">(</font>F<font color="#000080">,</font>P<font color="#000080">[</font>B<font color="#000080">]^,</font>Tmp<font color="#000080">,</font>NumRead<font color="#000080">);
            </font><font color="#008000"><i>{If NumRead&lt;&gt;Tmp then Text_Load:=false;}
          </i></font><font color="#FF0000"><b>End</b></font><font color="#000080">;
        </font>Close<font color="#000080">(</font>F<font color="#000080">);
      </font><font color="#FF0000"><b>End else </b></font>NoMem<font color="#000080">:=</font>true<font color="#000080">;
    </font>FileMode<font color="#000080">:=</font>FM<font color="#000080">;
  </font>PSeek<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
  </font>PCur<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
  </font>Text_Eof<font color="#000080">:=</font>false<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Text_ReadLine <font color="#000080">(</font><font color="#FF0000"><b>var </b></font>S<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">); </font><font color="#008000"><i>{ get line from text }
  </i></font><font color="#FF0000"><b>Var
    </b></font>W<font color="#000080">:</font>Word<font color="#000080">;
    </font>B<font color="#000080">:</font>LongInt<font color="#000080">;
    </font>TS<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">;
    </font>Tmp<font color="#000080">:</font>LongInt<font color="#000080">;
  </font><font color="#FF0000"><b>Begin
  </b></font>TS<font color="#000080">:=</font><font color="#800000">''</font><font color="#000080">;
    </font><font color="#FF0000"><b>If Not </b></font>Text_Eof <font color="#FF0000"><b>then
      Begin
      While </b></font><font color="#000080">(</font>PUsed<font color="#000080">&gt;=</font>PCur<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Length<font color="#000080">(</font>TS<font color="#000080">)&lt;=</font><font color="#800000">255</font><font color="#000080">) </font><font color="#FF0000"><b>and
       </b></font><font color="#000080">(</font>P<font color="#000080">[</font>PCur<font color="#000080">]^[</font>PSeek<font color="#000080">]&lt;&gt;</font><font color="#800000">#13</font><font color="#000080">) </font><font color="#008000"><i>{and (P[PCur]^[PSeek]&lt;&gt;#10)} </i></font><font color="#FF0000"><b>do
          Begin
            </b></font>TS<font color="#000080">:=</font>TS<font color="#000080">+</font>P<font color="#000080">[</font>PCur<font color="#000080">]^[</font>PSeek<font color="#000080">];
            </font>Inc<font color="#000080">(</font>PSeek<font color="#000080">);
            </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>PSeek<font color="#000080">&gt;</font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PCur<font color="#000080">&lt;</font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>then
              Begin
                </b></font>PSeek<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
                </font>Inc<font color="#000080">(</font>PCur<font color="#000080">);
              </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>P<font color="#000080">[</font>PCur<font color="#000080">]^[</font>PSeek<font color="#000080">]=</font><font color="#800000">#13</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PUsed<font color="#000080">&gt;=</font>PCur<font color="#000080">) </font><font color="#FF0000"><b>then
          begin
            </b></font>Inc<font color="#000080">(</font>PSeek<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
            </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>PSeek<font color="#000080">&gt;</font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PCur<font color="#000080">&lt;</font><font color="#800000">8</font><font color="#000080">) </font><font color="#FF0000"><b>then
              Begin
                </b></font>PSeek<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
                </font>Inc<font color="#000080">(</font>PCur<font color="#000080">);
              </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>PCur<font color="#000080">&gt;</font>PUsed<font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>Pred<font color="#000080">(</font>PCur<font color="#000080">)*</font><font color="#800000">64000</font><font color="#000080">+</font>PSeek<font color="#000080">&gt;</font>TextSize<font color="#000080">) </font><font color="#FF0000"><b>then
        </b></font>Text_Eof<font color="#000080">:=</font>true<font color="#000080">;
    </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>S<font color="#000080">:=</font>TS<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Text_GoBack <font color="#000080">(</font>L<font color="#000080">:</font>Word<font color="#000080">);
</font><font color="#FF0000"><b>Var
  </b></font>Cnt  <font color="#000080">: </font>Word<font color="#000080">;
</font><font color="#FF0000"><b>Begin
  </b></font>Cnt<font color="#000080">:=</font>L<font color="#000080">;
  </font><font color="#FF0000"><b>If </b></font>Cnt<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then
  Begin
    If </b></font>PSeek<font color="#000080">&gt;</font><font color="#800000">2 </font><font color="#FF0000"><b>then </b></font>Dec<font color="#000080">(</font>PSeek<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">) </font><font color="#FF0000"><b>else
      If </b></font>PCur<font color="#000080">&gt;</font><font color="#800000">1 </font><font color="#FF0000"><b>then Begin </b></font>Dec<font color="#000080">(</font>PCur<font color="#000080">); </font>PSeek<font color="#000080">:=</font><font color="#800000">64000</font><font color="#000080">-</font>PSeek<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">; </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>Repeat
      </b></font>Dec<font color="#000080">(</font>Cnt<font color="#000080">);
         </font><font color="#FF0000"><b>Repeat
           If </b></font>PSeek<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>Dec<font color="#000080">(</font>PSeek<font color="#000080">);
           </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>PSeek<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PCur<font color="#000080">&gt;</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
             Begin
               </b></font>PSeek<font color="#000080">:=</font><font color="#800000">64000</font><font color="#000080">;
               </font>Dec<font color="#000080">(</font>PCur<font color="#000080">);
             </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
           </font><font color="#FF0000"><b>If </b></font>PSeek<font color="#000080">=</font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>PSeek<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
         </font><font color="#FF0000"><b>Until </b></font><font color="#000080">((</font>PSeek<font color="#000080">=</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PCur<font color="#000080">=</font><font color="#800000">1</font><font color="#000080">)) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>P<font color="#000080">[</font>PCur<font color="#000080">]^[</font>PSeek<font color="#000080">]=</font><font color="#800000">#13</font><font color="#000080">)
    </font><font color="#FF0000"><b>Until </b></font>Cnt<font color="#000080">=</font><font color="#800000">0</font><font color="#000080">;
    </font><font color="#FF0000"><b>If not </b></font><font color="#000080">((</font>PSeek<font color="#000080">=</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>PCur<font color="#000080">=</font><font color="#800000">1</font><font color="#000080">)) </font><font color="#FF0000"><b>Then </b></font>Inc<font color="#000080">(</font>PSeek<font color="#000080">,</font><font color="#800000">2</font><font color="#000080">);
    </font><font color="#FF0000"><b>If </b></font>PSeek<font color="#000080">&gt;</font><font color="#800000">64000 </font><font color="#FF0000"><b>then </b></font>PSeek<font color="#000080">:=</font>PSeek<font color="#000080">-</font><font color="#800000">64000</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
  </font>Text_Eof<font color="#000080">:=</font>false<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Function </b></font>Text_Lines<font color="#000080">:</font>LongInt<font color="#000080">;
</font><font color="#008000"><i>(* Asm procedure was made by Arie Vayner on the 9/2/95 *)
  </i></font><font color="#FF0000"><b>Var
    </b></font>W<font color="#000080">:</font>Word<font color="#000080">;
    </font>B<font color="#000080">:</font>LongInt<font color="#000080">;
    </font>L<font color="#000080">:</font>Word<font color="#000080">;
    </font>Tmp<font color="#000080">:</font>Word<font color="#000080">;
    </font>O<font color="#000080">:</font>Word<font color="#000080">;
    </font>S<font color="#000080">:</font>Word<font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    </b></font>L<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
    </font><font color="#FF0000"><b>For </b></font>B<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>PUsed <font color="#FF0000"><b>do
      Begin
        If </b></font>B<font color="#000080">*</font><font color="#800000">64000</font><font color="#000080">&gt;</font>TextSize <font color="#FF0000"><b>then </b></font>Tmp<font color="#000080">:=(</font>TextSize <font color="#FF0000"><b>mod </b></font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>else
          </b></font>Tmp<font color="#000080">:=</font><font color="#800000">64000</font><font color="#000080">;
        </font>O<font color="#000080">:=</font>Ofs<font color="#000080">(</font>P<font color="#000080">[</font>B<font color="#000080">]^);
        </font>S<font color="#000080">:=</font>Seg<font color="#000080">(</font>P<font color="#000080">[</font>B<font color="#000080">]^);
        </font><font color="#FF0000"><b>Asm
          </b></font><font color="#FF00FF">Push DS
          Mov DS,S
          XOR DX,DX
          MOV CX,TMP
          MOV SI,O
          CLD
        @MAINLOOP:
          LODSB
          CMP AL,10
          JE @FOUND_ONE
          LOOP @MAINLOOP
          JMP @EXITLOOP
        @FOUND_ONE:
          INC DX
          LOOP @MAINLOOP
        @EXITLOOP:
          MOV AX,DX
          MOV TMP,AX
          POP DS
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
        </font>Inc<font color="#000080">(</font>L<font color="#000080">,</font>TMP<font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font>Text_Lines<font color="#000080">:=</font>L<font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Text_Reset<font color="#000080">;                   </font><font color="#008000"><i>{ reset file &amp; seek to start }
</i></font><font color="#FF0000"><b>Begin
  </b></font>Text_Eof<font color="#000080">:=</font>false<font color="#000080">;
  </font>PCur<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
  </font>PSeek<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Text_Dispose<font color="#000080">;                 </font><font color="#008000"><i>{ free memory }
  </i></font><font color="#FF0000"><b>Var
    </b></font>B<font color="#000080">:</font>LongInt<font color="#000080">;
    </font>Tmp<font color="#000080">:</font>LongInt<font color="#000080">;
  </font><font color="#FF0000"><b>Begin
    For </b></font>B<font color="#000080">:=</font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>PUsed <font color="#FF0000"><b>do if </b></font>TextSize <font color="#000080">&gt; (</font>B<font color="#000080">*</font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>then
      Begin
        If </b></font>B<font color="#000080">*</font><font color="#800000">64000</font><font color="#000080">&gt;</font>TextSize <font color="#FF0000"><b>then </b></font>Tmp<font color="#000080">:=(</font>TextSize <font color="#FF0000"><b>mod </b></font><font color="#800000">64000</font><font color="#000080">) </font><font color="#FF0000"><b>else
          </b></font>Tmp<font color="#000080">:=</font><font color="#800000">64000</font><font color="#000080">;
        </font>FreeMem<font color="#000080">(</font>P<font color="#000080">[</font>B<font color="#000080">],</font>Tmp<font color="#000080">);
      </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
    </font>PUsed<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0064.PAS">Original</a><b>]</b></p></body>
</html>
