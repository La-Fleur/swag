<html>
<head><title> "Seek and FilePos for file of type Text" by AITOR GONZALEX</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#008000"><i>{Aitor Gonzalez was kind enough to post a chunk of code which included the following
fragment which I reworked.  Someone out there might just be looking of the Text
equivalents of Seek and FilePos; here they are
}
</i></font><font color="#FF0000"><b>program </b></font>TestSeekAndFilePos<font color="#000080">(</font>input<font color="#000080">,</font>output<font color="#000080">);
</font><font color="#FF0000"><b>uses
   </b></font>DOS<font color="#000080">;

   </font><font color="#FF0000"><b>procedure </b></font>TextFileSeek<font color="#000080">(
  </font><font color="#FF0000"><b>var </b></font>F                        <font color="#000080">: </font>Text<font color="#000080">;
      </font>L                        <font color="#000080">: </font>LongInt
      <font color="#000080">);
   </font><font color="#008000"><i>{ Seek byte L in text file F:
   The following code is from    Arne de Bruijn,       1994;
   with modifications by         Aitor Gomez Gonzalez, Feb 19, 1996;
   and reformatting by           F. Li,                Feb 20, 1996.
   } </i></font><font color="#FF0000"><b>begin
      </b></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>Mode<font color="#000080">:=</font>fmInOut<font color="#000080">;         </font><font color="#008000"><i>{ Set to binary mode
                                              The (@F)^ part is to let TP 'forget' the type of the structure, so
                                              you can type-caste it to everything (note that with and without (@X)^
                                              can give a different value, longint(bytevar) gives the same value as
                                              bytevar, while longint((@bytevar)^) gives the same as longint
                                              absolute Bytevar (i.e. all 4 bytes in a longint are readed from
                                              memory instead of 3 filled with zeros)) }
      </i></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>RecSize<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;            </font><font color="#008000"><i>{ Set record size to 1 (byte size record)
                                              L:=(FilePos(File((@F)^))-TextRec(F).BufEnd)+TextRec(F).BufPos;
                                              Get the fileposition, subtract the already read buffer, and add the
                                              position in that buffer }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>Mode<font color="#000080">:=</font>fmInput<font color="#000080">;             </font><font color="#008000"><i>{ Set back to text mode }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufSize<font color="#000080">:=</font>SizeOf<font color="#000080">(</font>TextBuf<font color="#000080">);  </font><font color="#008000"><i>{ BufSize overwritten by RecSize }
                                            { Doesn't work with SetTextBuf! }
      </i></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>Mode<font color="#000080">:=</font>fmInOut<font color="#000080">;         </font><font color="#008000"><i>{ Set to binary mode }
      </i></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>RecSize<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;            </font><font color="#008000"><i>{ Set record size to 1 (a byte)}
      </i></font>Seek<font color="#000080">(</font><font color="#FF0000"><b>File</b></font><font color="#000080">((@</font>F<font color="#000080">)^),</font>L<font color="#000080">);                  </font><font color="#008000"><i>{ Do the seek }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>Mode<font color="#000080">:=</font>fmInput<font color="#000080">;             </font><font color="#008000"><i>{ Set back to text mode }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufSize<font color="#000080">:=</font>SizeOf<font color="#000080">(</font>TextBuf<font color="#000080">);  </font><font color="#008000"><i>{ Doesn't work with SetTextBuf! }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufPos<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;                 </font><font color="#008000"><i>{ Reset buffer counters }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufEnd<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
       </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ TextFileSeek }</i></font><font color="#000080">;

   </font><font color="#FF0000"><b>function </b></font>TextFilePos<font color="#000080">(
  </font><font color="#FF0000"><b>var </b></font>F                        <font color="#000080">: </font>Text
       <font color="#000080">)                       : </font>LongInt<font color="#000080">;
   </font><font color="#FF0000"><b>var
      </b></font>P                        <font color="#000080">: </font>longint<font color="#000080">;
   </font><font color="#008000"><i>{ Pretend that F is not a text file and return FilePos(F):
   The above code was &quot;b...&quot; by  F. Li,                Feb 20, 1996
   to create the following code:
   N.B. The modifier denies any knowledge of how the code works! -
        hence ...code was &quot;b...&quot; (butchered? buggered?...)
   } </i></font><font color="#FF0000"><b>begin
      </b></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>Mode<font color="#000080">:=</font>fmInOut<font color="#000080">;         </font><font color="#008000"><i>{ Set to binary mode
                                              The (@F)^ part is to let TP 'forget' the type of the structure, so
                                              you can type-caste it to everything (note that with and without (@X)^
                                              can give a different value, longint(bytevar) gives the same value as
                                              bytevar, while longint((@bytevar)^) gives the same as longint
                                              absolute Bytevar (i.e. all 4 bytes in a longint are readed from
                                              memory instead of 3 filled with zeros)) }
      </i></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>RecSize<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;            </font><font color="#008000"><i>{ Set record size to 1 (byte size record)
                                              L:=(FilePos(File((@F)^))-TextRec(F).BufEnd)+TextRec(F).BufPos;
                                              Get the fileposition, subtract the already read buffer, and add the
                                              position in that buffer }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>Mode<font color="#000080">:=</font>fmInput<font color="#000080">;             </font><font color="#008000"><i>{ Set back to text mode }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufSize<font color="#000080">:=</font>SizeOf<font color="#000080">(</font>TextBuf<font color="#000080">);  </font><font color="#008000"><i>{ BufSize overwritten by RecSize }
                                            { Doesn't work with SetTextBuf! }
      </i></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>Mode<font color="#000080">:=</font>fmInOut<font color="#000080">;         </font><font color="#008000"><i>{ Set to binary mode }
      </i></font>FileRec<font color="#000080">((@</font>F<font color="#000080">)^).</font>RecSize<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;            </font><font color="#008000"><i>{ Set record size to 1 (a byte)}
      </i></font>P<font color="#000080">:=</font>FilePos<font color="#000080">(</font><font color="#FF0000"><b>File</b></font><font color="#000080">((@</font>F<font color="#000080">)^));
      </font>TextFilePos<font color="#000080">:=</font>P<font color="#000080">-</font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufEnd<font color="#000080">+</font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufPos<font color="#000080">;
                                            </font><font color="#008000"><i>{ Do the FilePos }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>Mode<font color="#000080">:=</font>fmInput<font color="#000080">;             </font><font color="#008000"><i>{ Set back to text mode }
      </i></font>TextRec<font color="#000080">(</font>F<font color="#000080">).</font>BufSize<font color="#000080">:=</font>SizeOf<font color="#000080">(</font>TextBuf<font color="#000080">);  </font><font color="#008000"><i>{ Doesn't work with SetTextBuf! }
       </i></font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ TextFilePos }</i></font><font color="#000080">;

</font><font color="#FF0000"><b>var
   </b></font>i                           <font color="#000080">: </font>integer<font color="#000080">;
   </font>Line                        <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
   </font>LineNumber                  <font color="#000080">: </font>integer<font color="#000080">;
   </font>MyFile                      <font color="#000080">: </font>text<font color="#000080">;
   </font>Position                    <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">99</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>longint<font color="#000080">;
</font><font color="#008000"><i>{ Test Seek and Pos for TextFile } </i></font><font color="#FF0000"><b>begin
   </b></font>Assign<font color="#000080">(</font>MyFile<font color="#000080">,</font><font color="#800000">'SeekPos.Pas'</font><font color="#000080">);
   </font>Reset<font color="#000080">(</font>MyFile<font color="#000080">);
   </font>LineNumber<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>while not </b></font>EOF<font color="#000080">(</font>MyFile<font color="#000080">) </font><font color="#FF0000"><b>do begin
      </b></font>Inc<font color="#000080">(</font>LineNumber<font color="#000080">);
      </font>Position<font color="#000080">[</font>LineNumber<font color="#000080">]:=</font>TextFilePos<font color="#000080">(</font>MyFile<font color="#000080">);
      </font>ReadLn<font color="#000080">(</font>MyFile<font color="#000080">,</font>Line<font color="#000080">);
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>i<font color="#000080">:=</font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>while </b></font>i <font color="#000080">&lt;= </font>LineNumber <font color="#FF0000"><b>do begin
      </b></font>TextFileSeek<font color="#000080">(</font>MyFile<font color="#000080">,</font>Position<font color="#000080">[</font>i<font color="#000080">]);
      </font>ReadLn<font color="#000080">(</font>MyFile<font color="#000080">,</font>Line<font color="#000080">);
      </font>WriteLn<font color="#000080">(</font>Output<font color="#000080">,</font>Line<font color="#000080">);
      </font>Inc<font color="#000080">(</font>i<font color="#000080">); </font>Inc<font color="#000080">(</font>i<font color="#000080">);
       </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Close<font color="#000080">(</font>MyFile<font color="#000080">);
    </font><font color="#FF0000"><b>end </b></font><font color="#008000"><i>{ TestSeekAndFilePos }</i></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0073.PAS">Original</a><b>]</b></p></body>
</html>
