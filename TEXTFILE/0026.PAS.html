<html>
<head><title> "Reading File Backwards" by LARS FOSDAL</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
   Fast driver for backwards reading...  Aha!
   This is the way to do it.

   Below you will find the source of a &quot;tail&quot; program.
   I wrote it because I needed to check the status of some log files,
   and I didn't want to go through the entire file every time, as the
   files could grow quite large.

   It is currently limited to 255 chars per line, but that
   can easily be fixed (see the Limit const).

   Although it's not an exact solution to your problem, it will show you
   how to do &quot;backwards&quot; reading.
}

</i></font><font color="#FF0000"><b>PROGRAM </b></font>Tail<font color="#000080">;
</font><font color="#008000"><i>{
  Shows the tailing lines of a text file.

  Syntax: TAIL [d:\path]filespec.ext [-&lt;lines&gt;]
          Default number of lines is 10.

          &quot;TAIL filename -20&quot; will show the 20 last lines

  Written by Lars Fosdal, 1993 
  Released to the Public Domain by Lars Fosdal, 1993
}

</i></font><font color="#FF0000"><b>USES
  </b></font>DOS<font color="#000080">, </font>Objects<font color="#000080">, </font>Strings<font color="#000080">;

</font><font color="#FF0000"><b>CONST
  </b></font>MaxBufSize <font color="#000080">= </font><font color="#800000">32000</font><font color="#000080">;
</font><font color="#FF0000"><b>TYPE
  </b></font>pBuffer <font color="#000080">= ^</font>TBuffer<font color="#000080">;
  </font>TBuffer <font color="#000080">= </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>MaxBufSize<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Char<font color="#000080">;

  </font>pRawStrCollection <font color="#000080">= ^</font>TRawStrCollection<font color="#000080">;
  </font>TRawStrCollection <font color="#000080">= </font><font color="#FF0000"><b>OBJECT</b></font><font color="#000080">(</font>TCollection<font color="#000080">)
    </font><font color="#FF0000"><b>PROCEDURE </b></font>FreeItem<font color="#000080">(</font>Item<font color="#000080">:</font>Pointer<font color="#000080">); </font><font color="#FF0000"><b>VIRTUAL</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  
</font><font color="#FF0000"><b>PROCEDURE </b></font>TRawStrCollection<font color="#000080">.</font>FreeItem<font color="#000080">(</font>Item<font color="#000080">:</font>Pointer<font color="#000080">);
</font><font color="#FF0000"><b>BEGIN
  IF </b></font>Item<font color="#000080">&lt;&gt;</font><font color="#FF0000"><b>nil
  THEN </b></font>StrDispose<font color="#000080">(</font>pChar<font color="#000080">(</font>Item<font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{PROC TRawStrCollection.FreeItem}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>ShowTail<font color="#000080">(</font>FileName<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font>n<font color="#000080">:</font>Integer<font color="#000080">):</font>Integer<font color="#000080">;
  </font><font color="#FF0000"><b>PROCEDURE </b></font>DumpLine<font color="#000080">(</font>p<font color="#000080">:</font>pChar<font color="#000080">); </font><font color="#FF0000"><b>FAR</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>BEGIN
    IF </b></font>p<font color="#000080">^=</font><font color="#800000">#255
    </font><font color="#FF0000"><b>THEN </b></font>Writeln
    <font color="#FF0000"><b>ELSE </b></font>Writeln<font color="#000080">(</font>p<font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>CONST
  </b></font>Limit <font color="#000080">= </font><font color="#800000">255</font><font color="#000080">;  
</font><font color="#FF0000"><b>VAR
  </b></font>lines   <font color="#000080">: </font>pRawStrCollection<font color="#000080">;
  </font>fm      <font color="#000080">: </font>Byte<font color="#000080">;
  </font>f       <font color="#000080">: </font><font color="#FF0000"><b>File</b></font><font color="#000080">;
  </font>fs<font color="#000080">,</font>fp   <font color="#000080">: </font>LongInt<font color="#000080">;
  </font>MaxRead <font color="#000080">: </font>Word<font color="#000080">;
  </font>Buf     <font color="#000080">: </font>pBuffer<font color="#000080">;
  </font>lc<font color="#000080">,</font>ix<font color="#000080">,</font>ex <font color="#000080">: </font>Integer<font color="#000080">;
  </font>sp      <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>Limit<font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Char<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>lines<font color="#000080">:=</font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>fm<font color="#000080">:=</font>FileMode<font color="#000080">;
  </font>FileMode<font color="#000080">:=</font><font color="#800000">$40</font><font color="#000080">; </font><font color="#008000"><i>{Read-only, deny none}
  </i></font>Assign<font color="#000080">(</font>f<font color="#000080">, </font>FileName<font color="#000080">);
  </font>Reset<font color="#000080">(</font>f<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
  </font>lc<font color="#000080">:=</font>IOResult<font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>lc<font color="#000080">=</font><font color="#800000">0
  </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>New<font color="#000080">(</font>Buf<font color="#000080">);
   
    </font>fs<font color="#000080">:=</font>FileSize<font color="#000080">(</font>f<font color="#000080">); </font><font color="#008000"><i>{First, let's find out how much to read}
    </i></font>fp<font color="#000080">:=</font>fs<font color="#000080">-</font>MaxBufSize<font color="#000080">;
    </font><font color="#FF0000"><b>IF </b></font>fp<font color="#000080">&lt;</font><font color="#800000">0
    </font><font color="#FF0000"><b>THEN </b></font>fp<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
    
    </font>Seek<font color="#000080">(</font>f<font color="#000080">,</font>fp<font color="#000080">); </font><font color="#008000"><i>{Then, read it}
    </i></font>BlockRead<font color="#000080">(</font>f<font color="#000080">, </font>Buf<font color="#000080">^, </font>MaxBufSize<font color="#000080">, </font>MaxRead<font color="#000080">);
    </font>Close<font color="#000080">(</font>f<font color="#000080">);
    
    </font><font color="#FF0000"><b>IF </b></font>MaxRead<font color="#000080">&gt;</font><font color="#800000">0
    </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>New<font color="#000080">(</font>Lines<font color="#000080">, </font>Init<font color="#000080">(</font>n<font color="#000080">,</font><font color="#800000">10</font><font color="#000080">));
      </font>ix<font color="#000080">:=</font>MaxRead<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">;

      </font><font color="#FF0000"><b>IF </b></font>Buf<font color="#000080">^[</font>ix<font color="#000080">]=^</font>J <font color="#FF0000"><b>THEN </b></font>Dec<font color="#000080">(</font>ix<font color="#000080">);
      </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>ix<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Buf<font color="#000080">^[</font>ix<font color="#000080">]=^</font>M<font color="#000080">) </font><font color="#FF0000"><b>THEN </b></font>Dec<font color="#000080">(</font>ix<font color="#000080">); </font><font color="#008000"><i>{Skip trailing line break}

      </i></font><font color="#FF0000"><b>WHILE </b></font><font color="#000080">(</font>lc<font color="#000080">&lt;</font>n<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>ix<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">)
      </font><font color="#FF0000"><b>DO BEGIN
        </b></font>ex<font color="#000080">:=</font>ix<font color="#000080">;
        </font>FillChar<font color="#000080">(</font>sp<font color="#000080">, </font>SizeOf<font color="#000080">(</font>sp<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
        
        </font><font color="#FF0000"><b>WHILE </b></font><font color="#000080">(</font>ix<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and not </b></font><font color="#000080">(</font>Buf<font color="#000080">^[</font>ix<font color="#000080">] =^</font>J<font color="#000080">)
        </font><font color="#FF0000"><b>DO </b></font>Dec<font color="#000080">(</font>ix<font color="#000080">);
        
        </font><font color="#FF0000"><b>IF </b></font>ex<font color="#000080">-</font>ix<font color="#000080">&lt;=</font>Limit <font color="#008000"><i>{If no break was found within limit, it's no txt file}
        </i></font><font color="#FF0000"><b>THEN BEGIN
          IF </b></font>ix<font color="#000080">=</font>ex
          <font color="#FF0000"><b>THEN </b></font>sp<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:=</font><font color="#800000">#255 </font><font color="#008000"><i>{Pad empty lines to avoid zero-length pchar}
          </i></font><font color="#FF0000"><b>ELSE </b></font>StrLCopy<font color="#000080">(</font>sp<font color="#000080">, @</font>Buf<font color="#000080">^[</font>ix<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">], </font>ex<font color="#000080">-</font>ix<font color="#000080">);
          </font>Inc<font color="#000080">(</font>lc<font color="#000080">);

          </font>Lines<font color="#000080">^.</font>AtInsert<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">, </font>StrNew<font color="#000080">(</font>sp<font color="#000080">));

          </font>Dec<font color="#000080">(</font>ix<font color="#000080">);
          </font><font color="#FF0000"><b>WHILE </b></font><font color="#000080">(</font>ix<font color="#000080">&gt;</font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Buf<font color="#000080">^[</font>ix<font color="#000080">] =^</font>M<font color="#000080">)
          </font><font color="#FF0000"><b>DO </b></font>Dec<font color="#000080">(</font>ix<font color="#000080">);
        </font><font color="#FF0000"><b>END
        ELSE BEGIN
          </b></font>Writeln<font color="#000080">(</font><font color="#800000">'&quot;'</font><font color="#000080">,</font>FileName<font color="#000080">,</font><font color="#800000">'&quot; doesn''t seem to be a text file'</font><font color="#000080">);
          </font>ix<font color="#000080">:=-</font><font color="#800000">1</font><font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

      </font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{lc&lt;n and ix&gt;0}
    </i></font><font color="#FF0000"><b>END </b></font><font color="#008000"><i>{Maxread&gt;0}
    </i></font><font color="#FF0000"><b>ELSE </b></font>Lines<font color="#000080">:=</font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
    </font>Dispose<font color="#000080">(</font>Buf<font color="#000080">);
  </font><font color="#FF0000"><b>END
  ELSE </b></font>lc<font color="#000080">:=-</font>lc<font color="#000080">;

  </font><font color="#FF0000"><b>IF </b></font>Lines<font color="#000080">&lt;&gt;</font><font color="#FF0000"><b>nil
  THEN BEGIN
    </b></font>Lines<font color="#000080">^.</font>ForEach<font color="#000080">(@</font>DumpLine<font color="#000080">);
    </font>Dispose<font color="#000080">(</font>Lines<font color="#000080">, </font>Done<font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;

  </font>ShowTail<font color="#000080">:=</font>lc<font color="#000080">;
  </font>FileMode<font color="#000080">:=</font>fm<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{FUNC ShowTail}

</i></font><font color="#FF0000"><b>TYPE
  </b></font>CharSet <font color="#000080">= </font><font color="#FF0000"><b>Set of </b></font>Char<font color="#000080">;

</font><font color="#FF0000"><b>FUNCTION </b></font>StripAll<font color="#000080">(</font><font color="#FF0000"><b>CONST </b></font>Exclude<font color="#000080">:</font>CharSet<font color="#000080">; </font>S<font color="#000080">:</font><font color="#FF0000"><b>String</b></font><font color="#000080">):</font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>VAR
  </b></font>ix <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  </b></font>ix<font color="#000080">:=</font>Length<font color="#000080">(</font>S<font color="#000080">);
  </font><font color="#FF0000"><b>WHILE </b></font>ix<font color="#000080">&gt;</font><font color="#800000">0
  </font><font color="#FF0000"><b>DO BEGIN
    IF </b></font>S<font color="#000080">[</font>ix<font color="#000080">] </font><font color="#FF0000"><b>in </b></font>Exclude
    <font color="#FF0000"><b>THEN </b></font>Delete<font color="#000080">(</font>S<font color="#000080">, </font>ix<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font>Dec<font color="#000080">(</font>ix<font color="#000080">);
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>StripAll<font color="#000080">:=</font>S<font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{FUNC StripAll}  
  
</i></font><font color="#FF0000"><b>VAR
  </b></font>r <font color="#000080">: </font>Integer<font color="#000080">;
  </font>l <font color="#000080">: </font>Integer<font color="#000080">;
  </font>e <font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>BEGIN
  IF </b></font><font color="#000080">(</font>ParamCount<font color="#000080">&lt;</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>ParamCount<font color="#000080">&gt;</font><font color="#800000">2</font><font color="#000080">)
  </font><font color="#FF0000"><b>THEN BEGIN
    </b></font>Writeln<font color="#000080">(</font><font color="#800000">'TAIL v.1.0 - PD 1993 Lars Fosdal'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'  TAIL [d:\path]filename.ext [-n]'</font><font color="#000080">);
    </font>Writeln<font color="#000080">(</font><font color="#800000">'  Default is 10 lines'</font><font color="#000080">);
  </font><font color="#FF0000"><b>END
  ELSE BEGIN
    IF </b></font>ParamCount<font color="#000080">=</font><font color="#800000">2
    </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Val<font color="#000080">(</font>StripAll<font color="#000080">([</font><font color="#800000">'/'</font><font color="#000080">,</font><font color="#800000">'-'</font><font color="#000080">], </font>ParamStr<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">)), </font>l<font color="#000080">, </font>e<font color="#000080">);
      </font><font color="#FF0000"><b>IF </b></font>e<font color="#000080">&lt;&gt;</font><font color="#800000">0
      </font><font color="#FF0000"><b>THEN </b></font>l<font color="#000080">:=</font><font color="#800000">10
    </font><font color="#FF0000"><b>END
    ELSE </b></font>l<font color="#000080">:=</font><font color="#800000">10</font><font color="#000080">;

    </font>r<font color="#000080">:=</font>ShowTail<font color="#000080">(</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">), </font>l<font color="#000080">);
    </font><font color="#FF0000"><b>IF </b></font>r<font color="#000080">&lt;</font><font color="#800000">0
    </font><font color="#FF0000"><b>THEN BEGIN
      </b></font>Writeln<font color="#000080">(</font><font color="#800000">'Couldn''t open &quot;'</font><font color="#000080">,</font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">),</font><font color="#800000">'&quot;!  (Error '</font><font color="#000080">, -</font>r<font color="#000080">,</font><font color="#800000">')'</font><font color="#000080">);
      </font>Halt<font color="#000080">(</font>Word<font color="#000080">(-</font>r<font color="#000080">));
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0026.PAS">Original</a><b>]</b></p></body>
</html>
