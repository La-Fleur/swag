<html>
<head><title> "Reading a Text File" by DON BURGESS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0030.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
After much trial and error, and finding some helpful code from the SWAG
support team (thanks!) this is what I came up with.  It can handle text
files up to 750,000 bytes and does basically what I'm looking for, but
the scrolling isn't as smooth as it should be.  Also, the lines of
text are limited to 79 characters...  (The source code can probably be
streamlined a lot too, like I said, I'm fairly new at this...)
}

 </i></font><font color="#FF0000"><b>Program </b></font>Reader<font color="#000080">;

 </font><font color="#FF0000"><b>uses </b></font>Crt<font color="#000080">, </font>Dos<font color="#000080">;

</font><font color="#008000"><i>{$R-,S- }

</i></font><font color="#FF0000"><b>Procedure </b></font>GetFileMode<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Asm
           </b></font><font color="#FF00FF">CLC
           CMP    ES:[DI].TextRec.Mode, fmInput
           JE     @1
           MOV    [InOutRes], 104         </font><font color="#008000"><i>{ 'File not opened For reading' }
           </i></font><font color="#FF00FF">xor    AX, AX                  </font><font color="#008000"><i>{ Zero out Function result }
           </i></font><font color="#FF00FF">xor    DX, DX
           STC
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ GetFileMode }

</i></font><font color="#FF0000"><b>Function </b></font>TextFilePos<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Asm
        </b></font><font color="#FF00FF">LES    DI, f
        CALL   GetFileMode
        JC     @1

        xor    CX, CX                  </font><font color="#008000"><i>{ Get position of File Pointer }
        </i></font><font color="#FF00FF">xor    DX, DX
        MOV    BX, ES:[DI].TextRec.handle
        MOV    AX, 4201h
        inT    21h                     </font><font color="#008000"><i>{ offset := offset-Bufend+BufPos }
                                </i></font><font color="#FF00FF">xor    BX, BX
        SUB    AX, ES:[DI].TextRec.Bufend
        SBB    DX, BX
        ADD    AX, ES:[DI].TextRec.BufPos
        ADC    DX, BX
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextFilePos }


</i></font><font color="#FF0000"><b>Function </b></font>TextFileSize<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Asm
            </b></font><font color="#FF00FF">LES    DI, f
            CALL   GetFileMode
            JC     @1

            xor    CX, CX                  </font><font color="#008000"><i>{ Get position of File Pointer }
    </i></font><font color="#FF00FF">xor    DX, DX
    MOV    BX, ES:[DI].TextRec.handle
    MOV    AX, 4201h
            inT    21h
    PUSH   DX                      </font><font color="#008000"><i>{ Save current offset on the stack }
            </i></font><font color="#FF00FF">PUSH   AX
    xor    DX, DX                  </font><font color="#008000"><i>{ Move File Pointer to Eof }
    </i></font><font color="#FF00FF">MOV    AX, 4202h
    inT    21h
    POP    SI
    POP    CX
            PUSH   DX                      </font><font color="#008000"><i>{ Save Eof position }
    </i></font><font color="#FF00FF">PUSH   AX
    MOV    DX, SI                  </font><font color="#008000"><i>{ Restore old offset }
    </i></font><font color="#FF00FF">MOV    AX, 4200h
    inT    21h
    POP    AX                      </font><font color="#008000"><i>{ Return result}
    </i></font><font color="#FF00FF">POP    DX
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextFileSize }

</i></font><font color="#FF0000"><b>Procedure </b></font>TextSeek<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">; </font>n <font color="#000080">: </font>LongInt<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>Asm
    </b></font><font color="#FF00FF">LES    DI, f
          CALL   GetFileMode
    JC     @2

    MOV    CX, Word Ptr n+2        </font><font color="#008000"><i>{ Move File Pointer }
    </i></font><font color="#FF00FF">MOV    DX, Word Ptr n
    MOV    BX, ES:[DI].TextRec.Handle
          MOV    AX, 4200h
          inT    21h
          JNC    @1                      </font><font color="#008000"><i>{ Carry flag = reading past Eof }
          </i></font><font color="#FF00FF">MOV    [InOutRes], AX
          JMP    @2

                           </font><font color="#008000"><i>{ Force read next time }
</i></font><font color="#FF00FF">@1:  MOV    AX, ES:[DI].TextRec.Bufend
                       MOV    ES:[DI].TextRec.BufPos, AX
@2:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextSeek }
    {end TextUtil }


  </i></font><font color="#FF0000"><b>Procedure </b></font>HideCursor<font color="#000080">;  </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov      ah,$01  </font><font color="#008000"><i>{ Function number }
    </i></font><font color="#FF00FF">mov      ch,$20
    mov      cl,$00
    Int      $10     </font><font color="#008000"><i>{ Call BIOS }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ HideCursor }


  </i></font><font color="#FF0000"><b>Procedure </b></font>RestoreCursor<font color="#000080">;  </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
    </b></font><font color="#FF00FF">mov      ah,$01  </font><font color="#008000"><i>{ Function number }
    </i></font><font color="#FF00FF">mov      ch,$06  </font><font color="#008000"><i>{ Starting scan line }
    </i></font><font color="#FF00FF">mov      cl,$07  </font><font color="#008000"><i>{ Ending scan line }
    </i></font><font color="#FF00FF">int      $10     </font><font color="#008000"><i>{ Call BIOS }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">; </font><font color="#008000"><i>{ RestoreCursor }


 </i></font><font color="#FF0000"><b>Var
     </b></font>TxtFile <font color="#000080">: </font>text<font color="#000080">;
     </font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">[</font><font color="#800000">79</font><font color="#000080">];
     </font>Cee <font color="#000080">: </font>CHAR<font color="#000080">;

 </font><font color="#FF0000"><b>Label </b></font>RWLoop<font color="#000080">, </font>Final<font color="#000080">, </font>FileSizeError<font color="#000080">, </font>WrongKey<font color="#000080">, </font>NoParamError<font color="#000080">;

 </font><font color="#FF0000"><b>Var
    </b></font>Size <font color="#000080">: </font>Longint<font color="#000080">;
    </font>YY<font color="#000080">, </font>GG<font color="#000080">, </font>Counter <font color="#000080">: </font>LongInt<font color="#000080">;
    </font>LineNumArray <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">15000</font><font color="#000080">] </font><font color="#FF0000"><b>Of </b></font>LongInt<font color="#000080">;
    </font>MyText <font color="#000080">: </font><font color="#FF0000"><b>Array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">23</font><font color="#000080">] </font><font color="#FF0000"><b>Of String</b></font><font color="#000080">[</font><font color="#800000">79</font><font color="#000080">];
    </font>InstructStr <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">79</font><font color="#000080">];
    </font>OrigColor<font color="#000080">, </font>ColorSwitch <font color="#000080">: </font>Integer<font color="#000080">;
    </font>LineNo <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">5</font><font color="#000080">];
 </font><font color="#FF0000"><b>Begin
   </b></font>OrigColor <font color="#000080">:= </font>TextAttr<font color="#000080">;
   </font>TextColor<font color="#000080">(</font><font color="#800000">11</font><font color="#000080">);
   </font>TextBackground<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
   </font>InstructStr <font color="#000080">:= </font><font color="#800000">'Scroll (^) up - (v) down - (Page up/down) - (Home) - (End) - (ESC) Quit'</font><font color="#000080">;
   </font><font color="#FF0000"><b>If </b></font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">) = </font><font color="#800000">'' </font><font color="#FF0000"><b>Then GoTo </b></font>NoParamError<font color="#000080">;
   </font>Assign<font color="#000080">(</font>TxtFile<font color="#000080">, </font>ParamStr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">)); </font><font color="#008000"><i>{'TEXTFILE.DOC';}
   </i></font>Reset<font color="#000080">(</font>TxtFile<font color="#000080">);
   </font>Counter <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
   </font>ClrScr<font color="#000080">;
   </font>HideCursor<font color="#000080">;
   </font><font color="#FF0000"><b>If </b></font><font color="#000080">(</font>TextFileSize<font color="#000080">(</font>TxtFile<font color="#000080">)) &gt;= </font><font color="#800000">750000 </font><font color="#FF0000"><b>Then GoTo </b></font>FileSizeError<font color="#000080">;
   </font><font color="#FF0000"><b>While Not </b></font>EOF<font color="#000080">(</font>TxtFile<font color="#000080">) </font><font color="#FF0000"><b>Do
     Begin
       </b></font>Inc<font color="#000080">(</font>Counter<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
       </font>LineNumArray<font color="#000080">[</font>Counter<font color="#000080">] := </font>TextFilePos<font color="#000080">(</font>TxtFile<font color="#000080">);
       </font>ReadLn<font color="#000080">(</font>TxtFile<font color="#000080">);
     </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
   </font>Inc<font color="#000080">(</font>Counter<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
   </font>YY<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;


   </font>RWLoop<font color="#000080">:
     </font><font color="#FF0000"><b>For </b></font>GG<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">+</font>YY <font color="#FF0000"><b>TO </b></font><font color="#800000">23</font><font color="#000080">+</font>YY <font color="#FF0000"><b>DO
       Begin
         </b></font>TextSeek<font color="#000080">(</font>TxtFile<font color="#000080">,</font>LineNumArray<font color="#000080">[</font>GG<font color="#000080">]);
         </font>ReadLn<font color="#000080">(</font>TxtFile<font color="#000080">,</font>S<font color="#000080">);
         </font>MyText<font color="#000080">[</font>GG<font color="#000080">-</font>YY<font color="#000080">]:=</font>S<font color="#000080">;
       </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
     </font>GoToXY<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
     </font>ColorSwitch <font color="#000080">:= </font>TextAttr<font color="#000080">;
     </font>Str<font color="#000080">(</font>yy<font color="#000080">+</font><font color="#800000">23</font><font color="#000080">:</font><font color="#800000">5</font><font color="#000080">,</font>LineNo<font color="#000080">);

     </font><font color="#FF0000"><b>Repeat Until </b></font>Port<font color="#000080">[</font><font color="#800000">$3DA</font><font color="#000080">] </font><font color="#FF0000"><b>And </b></font><font color="#800000">8 </font><font color="#000080">= </font><font color="#800000">8</font><font color="#000080">; </font><font color="#008000"><i>{ Wait For Vertical retrace }

     </i></font><font color="#FF0000"><b>For </b></font>GG<font color="#000080">:=</font><font color="#800000">0 </font><font color="#FF0000"><b>TO </b></font><font color="#800000">23 </font><font color="#FF0000"><b>DO
       Begin
         </b></font>ClrEOL<font color="#000080">;
         </font>WriteLn<font color="#000080">(</font>MyText<font color="#000080">[</font>GG<font color="#000080">]);
       </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
     </font>GoToXY<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">);
     </font>TextColor<font color="#000080">(</font><font color="#800000">14</font><font color="#000080">);
     </font>Write<font color="#000080">(</font>LineNo<font color="#000080">);
     </font>GoToXY<font color="#000080">(</font><font color="#800000">8</font><font color="#000080">,</font><font color="#800000">25</font><font color="#000080">);
     </font>TextColor<font color="#000080">(</font><font color="#800000">15</font><font color="#000080">);
     </font>Write<font color="#000080">(</font>InstructStr<font color="#000080">);
     </font>TextAttr<font color="#000080">:=</font>ColorSwitch<font color="#000080">;

     </font>Delay<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">);
   </font>WrongKey<font color="#000080">:
     </font><font color="#FF0000"><b>Repeat
     Until </b></font>KeyPressed<font color="#000080">;
     </font>Cee <font color="#000080">:= </font>ReadKey<font color="#000080">;

     </font><font color="#FF0000"><b>If </b></font>Cee<font color="#000080">=</font>Chr<font color="#000080">(</font><font color="#800000">27</font><font color="#000080">) </font><font color="#FF0000"><b>Then GoTo </b></font>Final
     <font color="#FF0000"><b>Else If </b></font>Cee<font color="#000080">=</font>Chr<font color="#000080">(</font><font color="#800000">72</font><font color="#000080">) </font><font color="#FF0000"><b>Then   </b></font><font color="#008000"><i>{UP ARROW}
       </i></font><font color="#FF0000"><b>Begin
         If </b></font>YY<font color="#000080">&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>Then </b></font>Dec<font color="#000080">(</font>YY<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
         </font><font color="#FF0000"><b>GoTo </b></font>RWLoop<font color="#000080">;
       </font><font color="#FF0000"><b>End
     Else If </b></font>Cee<font color="#000080">=</font>Chr<font color="#000080">(</font><font color="#800000">80</font><font color="#000080">) </font><font color="#FF0000"><b>Then  </b></font><font color="#008000"><i>{DOWN ARROW}
       </i></font><font color="#FF0000"><b>Begin
         </b></font>Inc<font color="#000080">(</font>YY<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
         </font><font color="#FF0000"><b>If </b></font>YY<font color="#000080">&gt;=</font>Counter<font color="#000080">-</font><font color="#800000">23 </font><font color="#FF0000"><b>Then </b></font>YY<font color="#000080">:= </font>Counter<font color="#000080">-</font><font color="#800000">24</font><font color="#000080">;
         </font><font color="#FF0000"><b>GoTo </b></font>RWLoop<font color="#000080">;
       </font><font color="#FF0000"><b>End
     Else If </b></font>Cee<font color="#000080">=</font>Chr<font color="#000080">(</font><font color="#800000">73</font><font color="#000080">) </font><font color="#FF0000"><b>Then </b></font><font color="#008000"><i>{PAGE UP}
       </i></font><font color="#FF0000"><b>Begin
         </b></font>YY<font color="#000080">:=</font>YY<font color="#000080">-</font><font color="#800000">24</font><font color="#000080">;
         </font><font color="#FF0000"><b>If </b></font>YY<font color="#000080">&lt;</font><font color="#800000">1 </font><font color="#FF0000"><b>Then </b></font>YY<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
         </font><font color="#FF0000"><b>GoTo </b></font>RWLoop<font color="#000080">;
       </font><font color="#FF0000"><b>End
     Else If </b></font>Cee<font color="#000080">=</font>Chr<font color="#000080">(</font><font color="#800000">81</font><font color="#000080">) </font><font color="#FF0000"><b>Then </b></font><font color="#008000"><i>{PAGEDOWN}
       </i></font><font color="#FF0000"><b>Begin
         </b></font>YY<font color="#000080">:= </font>YY<font color="#000080">+</font><font color="#800000">24</font><font color="#000080">;
         </font><font color="#FF0000"><b>If </b></font>YY<font color="#000080">&gt;=</font>Counter<font color="#000080">-</font><font color="#800000">23 </font><font color="#FF0000"><b>Then </b></font>YY<font color="#000080">:= </font>Counter<font color="#000080">-</font><font color="#800000">24</font><font color="#000080">;
         </font><font color="#FF0000"><b>GoTo </b></font>RWLoop<font color="#000080">;
       </font><font color="#FF0000"><b>End
     Else If </b></font>Cee<font color="#000080">=</font>Chr<font color="#000080">(</font><font color="#800000">71</font><font color="#000080">) </font><font color="#FF0000"><b>Then  </b></font><font color="#008000"><i>{HOME}
       </i></font><font color="#FF0000"><b>Begin
         </b></font>YY<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
         </font><font color="#FF0000"><b>GoTo </b></font>RWLoop<font color="#000080">;
       </font><font color="#FF0000"><b>End
     Else If </b></font>Cee<font color="#000080">=</font>Chr<font color="#000080">(</font><font color="#800000">79</font><font color="#000080">) </font><font color="#FF0000"><b>Then  </b></font><font color="#008000"><i>{End}
       </i></font><font color="#FF0000"><b>Begin
         </b></font>YY<font color="#000080">:= </font>Counter<font color="#000080">-</font><font color="#800000">24</font><font color="#000080">;
         </font><font color="#FF0000"><b>GoTo </b></font>RWLoop<font color="#000080">;
       </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>GoTo </b></font>WrongKey<font color="#000080">;

  </font>FileSizeError<font color="#000080">:
    </font>WriteLn<font color="#000080">;
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'ERROR...'</font><font color="#000080">);
    </font>WriteLn<font color="#000080">;
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'File Size Larger Than 750,000'</font><font color="#000080">);
    </font><font color="#FF0000"><b>GoTo </b></font>Final<font color="#000080">;

  </font>NoParamError<font color="#000080">:
    </font>WriteLn<font color="#000080">;
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'ERROR...'</font><font color="#000080">);
    </font>WriteLn<font color="#000080">;
    </font>WriteLn<font color="#000080">(</font><font color="#800000">'Command line syntax is Reader C:\TextFile.txt'</font><font color="#000080">);
    </font><font color="#FF0000"><b>GoTo </b></font>Final<font color="#000080">;

  </font>Final<font color="#000080">:
    </font>Close<font color="#000080">(</font>TxtFile<font color="#000080">);
    </font>TextAttr <font color="#000080">:= </font>OrigColor<font color="#000080">;
    </font>RestoreCursor<font color="#000080">;
    </font>ClrScr<font color="#000080">;
 </font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0030.PAS">Original</a><b>]</b></p></body>
</html>
