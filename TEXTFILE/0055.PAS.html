<html>
<head><title> "Accessing Large Text Files" by MARK OUELLET</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0055.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{$A+,B-,D-,E+,F+,G+,I-,L-,N+,O+,P-,Q-,R-,S-,T-,V-,X-,Y-}
{$M 16384,0,655360}
(*
 The problem is as follows:

  Q. How to randomly access Large text files, such as tagline files,
    in an efficient way.

  A. By using an index file which is just a structured file of which
    each record is a longint giving us the offset of that line.

    The structure can be simple: File of LongInt;
    Or a bit more:
     OneTagLine = record
     offset : longint;   {Offset where tag begins in text file}
     NumOfLines : byte;  {Number of lines in this particular tag}
     end;


    Ex:
     to get Line # 233
      Get Record #233 from the Index file.
      That value is the offset in the text file
      where line 233 begins

 To detect changes in the Text file I reserve the first record, record #0,
 to conatin the size of the text file at the time of creation of the index.

 By checking both the cration date/time of the text file and Record #0
 of the index, the program can then determine wether it needs to recreate
 the index or not.

*)
</i></font><font color="#FF0000"><b>program </b></font>TxtRandR<font color="#000080">; </font><font color="#008000"><i>{Random access to text files}
</i></font><font color="#FF0000"><b>uses </b></font>dos<font color="#000080">;

 </font><font color="#FF0000"><b>type
  </b></font>IndexFile <font color="#000080">= </font><font color="#FF0000"><b>file of </b></font>longint<font color="#000080">;

 </font><font color="#FF0000"><b>var
  </b></font>Index <font color="#000080">: </font>IndexFile<font color="#000080">;
  </font>IndexName <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>N <font color="#000080">: </font>namestr<font color="#000080">;
  </font>E <font color="#000080">: </font>extstr<font color="#000080">;
  </font>D <font color="#000080">: </font>dirstr<font color="#000080">;
  </font>Tags  <font color="#000080">: </font>text<font color="#000080">;
  </font>Line   <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
  </font>LineNmbr <font color="#000080">: </font>word<font color="#000080">;
  </font>LineOfs <font color="#000080">: </font>longint<font color="#000080">;

 </font><font color="#FF0000"><b>function </b></font>TextFileSize<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">):</font>longint<font color="#000080">;

  </font><font color="#FF0000"><b>var
   </b></font>OldRecSize <font color="#000080">: </font>word<font color="#000080">;
   </font>OldMode <font color="#000080">: </font>word<font color="#000080">;
   </font>Temp <font color="#000080">: </font>longint<font color="#000080">;

  </font><font color="#FF0000"><b>begin
   with </b></font>filerec<font color="#000080">(</font>F<font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>OldMode <font color="#000080">:= </font>mode<font color="#000080">;
    </font>mode <font color="#000080">:= </font>fminout<font color="#000080">;
    </font>OldRecSize <font color="#000080">:= </font>recsize<font color="#000080">;
    </font>recsize <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Temp <font color="#000080">:= </font>filesize<font color="#000080">(</font><font color="#FF0000"><b>file</b></font><font color="#000080">(</font>F<font color="#000080">));
   </font><font color="#FF0000"><b>with </b></font>filerec<font color="#000080">(</font>F<font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>mode <font color="#000080">:= </font>OldMode<font color="#000080">;
    </font>recsize <font color="#000080">:= </font>OldRecSize<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>TextFileSize <font color="#000080">:= </font>Temp<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>function </b></font>TextFilePos<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">):</font>longint<font color="#000080">;

  </font><font color="#FF0000"><b>var
   </b></font>OldRecSize <font color="#000080">: </font>word<font color="#000080">;
   </font>OldMode <font color="#000080">: </font>word<font color="#000080">;
   </font>Temp <font color="#000080">: </font>longint<font color="#000080">;

  </font><font color="#FF0000"><b>begin
   with </b></font>filerec<font color="#000080">(</font>F<font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>OldMode <font color="#000080">:= </font>mode<font color="#000080">;
    </font>mode <font color="#000080">:= </font>fminout<font color="#000080">;
    </font>OldRecSize <font color="#000080">:= </font>recsize<font color="#000080">;
    </font>recsize <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Temp <font color="#000080">:= </font>filepos<font color="#000080">(</font><font color="#FF0000"><b>file</b></font><font color="#000080">(</font>F<font color="#000080">));
   </font><font color="#FF0000"><b>with </b></font>filerec<font color="#000080">(</font>F<font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>mode <font color="#000080">:= </font>OldMode<font color="#000080">;
    </font>recsize <font color="#000080">:= </font>OldRecSize<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>TextFilePos <font color="#000080">:= </font>Temp <font color="#000080">- </font>OldRecSize <font color="#000080">+ </font>textrec<font color="#000080">(</font>F<font color="#000080">).</font>bufpos<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>CheckIndex<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>T<font color="#000080">:</font>text<font color="#000080">; </font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>IndexFile<font color="#000080">);

  </font><font color="#FF0000"><b>var
   </b></font>Temp <font color="#000080">: </font>longint<font color="#000080">;

  </font><font color="#FF0000"><b>begin
   </b></font>Seek<font color="#000080">(</font>F<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>FileSize<font color="#000080">(</font>F<font color="#000080">)=</font><font color="#800000">0 </font><font color="#FF0000"><b>then
    </b></font>temp <font color="#000080">:= </font><font color="#800000">0
   </font><font color="#FF0000"><b>else
    </b></font>Read<font color="#000080">(</font>F<font color="#000080">, </font>Temp<font color="#000080">);
   </font><font color="#FF0000"><b>if </b></font>Temp <font color="#000080">&lt;&gt; </font>TextFileSize<font color="#000080">(</font>T<font color="#000080">) </font><font color="#FF0000"><b>then begin
    </b></font><font color="#008000"><i>{
     Stored Size is different than that of text file
     so rebuild the index file
    }
    </i></font>Seek<font color="#000080">(</font>F<font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
    </font>Temp <font color="#000080">:= </font>TextFileSize<font color="#000080">(</font>T<font color="#000080">);
    </font>write<font color="#000080">(</font>F<font color="#000080">, </font>Temp<font color="#000080">);
    </font><font color="#FF0000"><b>while not </b></font>eof<font color="#000080">(</font>T<font color="#000080">) </font><font color="#FF0000"><b>do begin
     </b></font>Temp <font color="#000080">:= </font>TextFilePos<font color="#000080">(</font>T<font color="#000080">);
     </font>write<font color="#000080">(</font>F<font color="#000080">, </font>Temp<font color="#000080">);
     </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>eof<font color="#000080">(</font>T<font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>eoln<font color="#000080">(</font>T<font color="#000080">)) </font><font color="#FF0000"><b>do
      </b></font>read<font color="#000080">(</font>T<font color="#000080">, </font>Line<font color="#000080">);
     </font>readln<font color="#000080">(</font>T<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>Truncate<font color="#000080">(</font>F<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

 </font><font color="#FF0000"><b>procedure </b></font>SeekTextFile<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>T<font color="#000080">; </font>FPos<font color="#000080">:</font>longint<font color="#000080">);

  </font><font color="#FF0000"><b>var
   </b></font>OldRecSize <font color="#000080">: </font>word<font color="#000080">;
   </font>OldMode <font color="#000080">: </font>word<font color="#000080">;
   </font>Temp <font color="#000080">: </font>longint<font color="#000080">;
   </font>TBuffer <font color="#000080">: </font>pointer<font color="#000080">;
   </font>BytesRead <font color="#000080">: </font>word<font color="#000080">;

  </font><font color="#FF0000"><b>begin
   with </b></font>filerec<font color="#000080">(</font>T<font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>OldMode <font color="#000080">:= </font>mode<font color="#000080">;
    </font>mode <font color="#000080">:= </font>fminout<font color="#000080">;
    </font>OldRecSize <font color="#000080">:= </font>recsize<font color="#000080">;
    </font>recsize <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>Seek<font color="#000080">(</font><font color="#FF0000"><b>File</b></font><font color="#000080">(</font>T<font color="#000080">), (</font>FPos <font color="#FF0000"><b>div </b></font>OldRecSize<font color="#000080">) * </font>OldRecSize<font color="#000080">);
   </font>TBuffer <font color="#000080">:= </font>textrec<font color="#000080">(</font>T<font color="#000080">).</font>bufptr<font color="#000080">;
   </font>blockread<font color="#000080">(</font><font color="#FF0000"><b>File</b></font><font color="#000080">(</font>T<font color="#000080">), </font>TBuffer<font color="#000080">^, </font>OldRecSize<font color="#000080">, </font>BytesRead<font color="#000080">);
   </font><font color="#FF0000"><b>with </b></font>filerec<font color="#000080">(</font>T<font color="#000080">) </font><font color="#FF0000"><b>do begin
    </b></font>mode <font color="#000080">:= </font>OldMode<font color="#000080">;
    </font>recsize <font color="#000080">:= </font>OldRecSize<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>textrec<font color="#000080">(</font>T<font color="#000080">).</font>bufpos <font color="#000080">:= </font>FPos <font color="#FF0000"><b>mod </b></font>OldRecSize<font color="#000080">;
   </font>textrec<font color="#000080">(</font>T<font color="#000080">).</font>bufend <font color="#000080">:= </font>BytesRead<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
 </b></font>assign<font color="#000080">(</font>Tags<font color="#000080">, </font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
 </font>reset<font color="#000080">(</font>Tags<font color="#000080">);
 </font>fsplit<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">), </font>D<font color="#000080">, </font>N<font color="#000080">, </font>E<font color="#000080">);
 </font>IndexName <font color="#000080">:= </font>D <font color="#000080">+ </font>N <font color="#000080">+ </font><font color="#800000">'.idx'</font><font color="#000080">;
 </font>assign<font color="#000080">(</font>Index<font color="#000080">, </font>IndexName<font color="#000080">);
 </font><font color="#008000"><i>{$I-}
 </i></font>reset<font color="#000080">(</font>Index<font color="#000080">);
 </font><font color="#008000"><i>{$I+}
 </i></font><font color="#FF0000"><b>if </b></font>ioresult<font color="#000080">&lt;&gt;</font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
  </b></font>rewrite<font color="#000080">(</font>Index<font color="#000080">);
  </font>LineOfs <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>write<font color="#000080">(</font>Index<font color="#000080">, </font>LineOfs<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>CheckIndex<font color="#000080">(</font>Tags<font color="#000080">, </font>Index<font color="#000080">);
 </font>val<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">2</font><font color="#000080">), </font>LineNmbr<font color="#000080">, </font>LineNmbr<font color="#000080">);
 </font>Seek<font color="#000080">(</font>Index<font color="#000080">, </font>LineNmbr<font color="#000080">);
 </font>Read<font color="#000080">(</font>Index<font color="#000080">, </font>LineOfs<font color="#000080">);
 </font>SeekTextFile<font color="#000080">(</font>Tags<font color="#000080">, </font>LineOfs<font color="#000080">);
 </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>Eof<font color="#000080">(</font>Tags<font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>Eoln<font color="#000080">(</font>Tags<font color="#000080">)) </font><font color="#FF0000"><b>do begin
  </b></font>read<font color="#000080">(</font>Tags<font color="#000080">, </font>Line<font color="#000080">);
  </font>write<font color="#000080">(</font>Line<font color="#000080">);
 </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>readln<font color="#000080">(</font>Tags<font color="#000080">);
 </font>writeln<font color="#000080">;
 </font>close<font color="#000080">(</font>Tags<font color="#000080">);
 </font>close<font color="#000080">(</font>Index<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0055.PAS">Original</a><b>]</b></p></body>
</html>
