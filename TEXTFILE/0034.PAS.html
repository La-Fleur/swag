<html>
<head><title> "Positioning Text File" by WILBERT VAN LEIJEN</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0034.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code>
<font color="#FF0000"><b>Unit </b></font>TextUtil<font color="#000080">;
</font><font color="#008000"><i>{ Written by Wilbert Van.Leijen and posted in the Pascal Echo }

</i></font><font color="#FF0000"><b>Interface

Function </b></font>TextFilePos<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Function </b></font>TextFileSize<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">;
</font><font color="#FF0000"><b>Procedure </b></font>TextSeek<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">; </font>n <font color="#000080">: </font>LongInt<font color="#000080">);

</font><font color="#FF0000"><b>Implementation
uses </b></font>Dos<font color="#000080">;

</font><font color="#008000"><i>{$R-,S- }

</i></font><font color="#FF0000"><b>Procedure </b></font>GetFileMode<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">CLC
        CMP    ES:[DI].TextRec.Mode, fmInput
        JE     @1
        MOV    [InOutRes], 104         </font><font color="#008000"><i>{ 'File not opened for reading' }
        </i></font><font color="#FF00FF">XOR    AX, AX                  </font><font color="#008000"><i>{ Zero out function result }
        </i></font><font color="#FF00FF">XOR    DX, DX
        STC
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ GetFileMode }

</i></font><font color="#FF0000"><b>Function </b></font>TextFilePos<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">LES    DI, f
        CALL   GetFileMode
        JC     @1

        XOR    CX, CX                  </font><font color="#008000"><i>{ Get position of file pointer }
        </i></font><font color="#FF00FF">XOR    DX, DX
        MOV    BX, ES:[DI].TextRec.handle
        MOV    AX, 4201h
        INT    21h                     </font><font color="#008000"><i>{ offset := offset-BufEnd+BufPos }
        </i></font><font color="#FF00FF">XOR    BX, BX
        SUB    AX, ES:[DI].TextRec.BufEnd
        SBB    DX, BX
        ADD    AX, ES:[DI].TextRec.BufPos
        ADC    DX, BX
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextFilePos }


</i></font><font color="#FF0000"><b>Function </b></font>TextFileSize<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">) : </font>LongInt<font color="#000080">; </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">LES    DI, f
        CALL   GetFileMode
        JC     @1
        XOR    CX, CX                  </font><font color="#008000"><i>{ Get position of file pointer }
        </i></font><font color="#FF00FF">XOR    DX, DX
        MOV    BX, ES:[DI].TextRec.handle
        MOV    AX, 4201h
        INT    21h
        PUSH   DX                      </font><font color="#008000"><i>{ Save current offset on the stack }
        </i></font><font color="#FF00FF">PUSH   AX
        XOR    DX, DX                  </font><font color="#008000"><i>{ Move file pointer to EOF }
        </i></font><font color="#FF00FF">MOV    AX, 4202h
        INT    21h
        POP    SI
        POP    CX
        PUSH   DX                      </font><font color="#008000"><i>{ Save EOF position }
        </i></font><font color="#FF00FF">PUSH   AX
        MOV    DX, SI                  </font><font color="#008000"><i>{ Restore old offset }
        </i></font><font color="#FF00FF">MOV    AX, 4200h
        INT    21h
        POP    AX                      </font><font color="#008000"><i>{ Return result}
        </i></font><font color="#FF00FF">POP    DX
@1:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextFileSize }

</i></font><font color="#FF0000"><b>Procedure </b></font>TextSeek<font color="#000080">(</font><font color="#FF0000"><b>Var </b></font>f <font color="#000080">: </font>Text<font color="#000080">; </font>n <font color="#000080">: </font>LongInt<font color="#000080">); </font><font color="#FF0000"><b>Assembler</b></font><font color="#000080">;

</font><font color="#FF0000"><b>ASM
        </b></font><font color="#FF00FF">LES    DI, f
        CALL   GetFileMode
        JC     @2

        MOV    CX, Word Ptr n+2        </font><font color="#008000"><i>{ Move file pointer }
        </i></font><font color="#FF00FF">MOV    DX, Word Ptr n
        MOV    BX, ES:[DI].TextRec.Handle
        MOV    AX, 4200h
        INT    21h
        JNC    @1                      </font><font color="#008000"><i>{ Carry flag = reading past EOF }
        </i></font><font color="#FF00FF">MOV    [InOutRes], AX
        JMP    @2


        </font><font color="#008000"><i>{ Force read next time }
</i></font><font color="#FF00FF">@1:     MOV    AX, ES:[DI].TextRec.BufEnd
        MOV    ES:[DI].TextRec.BufPos, AX
@2:
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;  </font><font color="#008000"><i>{ TextSeek }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.  </font><font color="#008000"><i>{ TextUtil }

</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0034.PAS">Original</a><b>]</b></p></body>
</html>
