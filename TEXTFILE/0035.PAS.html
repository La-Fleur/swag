<html>
<head><title> "Linking text file w/com.." by KIMMO FREDRIKSON</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0035.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{

     This is not related to the original topic &quot;.. w/exe!!&quot;, but
     if somebody is interested, at least I found this one a bit
     excited piece of code. It makes an executable com-file from
     your text and you can easily extend it to the limits you
     need. Just remember that you can't call any pascal routines,
     you have to write it in pure assembler. (would .80xxx have been
     a better area..?) Anyway, here it is:

 --!clip!-- { Code by Kimmo Fredrikson }

  {$A+,D-,G-,I-,R-,S-}

  </i></font><font color="#FF0000"><b>program </b></font>txt2com<font color="#000080">;

  </font><font color="#FF0000"><b>var
    </b></font>src                 <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
    </font>dst                 <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
    </font>buff                <font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">2047</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
    </font>bytesRead           <font color="#000080">: </font>word<font color="#000080">;
    </font>bytesWritten        <font color="#000080">: </font>word<font color="#000080">;
    </font>fSize               <font color="#000080">: </font>word<font color="#000080">;


  </font><font color="#FF0000"><b>function </b></font>t2c<font color="#000080">: </font>word<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>asm
        </b></font><font color="#FF00FF">jmp     @tail           </font><font color="#008000"><i>{ 2 bytes }

  </i></font><font color="#FF00FF">@head:mov     ax, 0003h       </font><font color="#008000"><i>{ -- here starts the code part of }
        </i></font><font color="#FF00FF">int     10h             </font><font color="#008000"><i>{    the txt-show-proggie.. }

        </i></font><font color="#FF00FF">mov     cx, word ptr [@tail+100h-2]     </font><font color="#008000"><i>{ length of text }
        </i></font><font color="#FF00FF">lea     si, [@tail+100h-2+2]            </font><font color="#008000"><i>{ address of txt }

  </i></font><font color="#FF00FF">@nxtC:mov     dl, [si]        </font><font color="#008000"><i>{ read a character to dl }
        </i></font><font color="#FF00FF">mov     ah, 2
        int     21h
        inc     si
        loop    @nxtC

        mov     ax, 4c00h
        int     21h             </font><font color="#008000"><i>{ terminate, back to dos }

  </i></font><font color="#FF00FF">@tail:mov     ax, offset [@tail]              </font><font color="#008000"><i>{ length of t2c }
        </i></font><font color="#FF00FF">sub     ax, offset [@head] </font><font color="#008000"><i>{ this returns the length of the  }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;                     </font><font color="#008000"><i>{ assembler code when called within this pascal }
                                                { program }
  </i></font><font color="#FF0000"><b>begin
    if </b></font>paramCount <font color="#000080">&lt;&gt; </font><font color="#800000">2 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">;
    </font>assign <font color="#000080">(</font>src<font color="#000080">, </font>paramStr <font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
    </font>assign <font color="#000080">(</font>dst<font color="#000080">, </font>paramStr <font color="#000080">(</font><font color="#800000">2</font><font color="#000080">));
    </font>reset <font color="#000080">(</font>src<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>ioResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>fileSize <font color="#000080">(</font>src<font color="#000080">) &gt; </font><font color="#800000">64000 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">;
    </font>fSize <font color="#000080">:= </font>fileSize <font color="#000080">(</font>src<font color="#000080">) - </font><font color="#800000">1</font><font color="#000080">;                </font><font color="#008000"><i>{ get rid of the ctrl-z }
    </i></font>reWrite <font color="#000080">(</font>dst<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>ioResult <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>halt<font color="#000080">;
    </font>blockWrite <font color="#000080">(</font>dst<font color="#000080">, </font>pointer <font color="#000080">(</font>longint <font color="#000080">(@</font>t2c<font color="#000080">) + </font><font color="#800000">2</font><font color="#000080">)^, </font>t2c<font color="#000080">);  </font><font color="#008000"><i>{ the code }
    </i></font>blockWrite <font color="#000080">(</font>dst<font color="#000080">, </font>fSize<font color="#000080">, </font><font color="#800000">2</font><font color="#000080">);                  </font><font color="#008000"><i>{ the length of text }
    </i></font><font color="#FF0000"><b>repeat
      </b></font>blockRead <font color="#000080">(</font>src<font color="#000080">, </font>buff<font color="#000080">, </font><font color="#800000">2048</font><font color="#000080">, </font>bytesRead<font color="#000080">);
      </font>blockWrite <font color="#000080">(</font>dst<font color="#000080">, </font>buff<font color="#000080">, </font>bytesRead<font color="#000080">, </font>bytesWritten<font color="#000080">);     </font><font color="#008000"><i>{ the text }
    </i></font><font color="#FF0000"><b>until </b></font><font color="#000080">(</font>bytesRead <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>or </b></font><font color="#000080">(</font>bytesWritten <font color="#000080">&lt;&gt; </font>bytesRead<font color="#000080">);
    </font>close <font color="#000080">(</font>src<font color="#000080">);
    </font>close <font color="#000080">(</font>dst<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0035.PAS">Original</a><b>]</b></p></body>
</html>
