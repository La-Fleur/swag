<html>
<head><title> "Text File Objects" by WIM VAN DER VEGT</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0037.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
Here's a piece of code I wrote last year which does what wasn't
uploaded. It allows text files converted to obj format to be linked in
and being accessed as 'normal' turbo pascal text files. The 'object'
text files support reset, read, readln eof, eoln and close file
commands.

What you need to write in your program is a obj_find function which
translates filenames into pointers or returns NIL to indicate an
external file. Use Assign_text procedure instead. A sample of how to
use it is supplied in the second program/unit. Only the two linked in
files will be fetched from memory, any other name supplied will be
fetched from disk as usual.

The first unit can be the same for all projects, the second one is
project depended, because one will be using different files.

Question about this, ask them!

}
{---------------------------------------------------------}
{  Project : Object linked textfiles                      }
{  By      : Ir.G.W. van der Vegt                         }
{---------------------------------------------------------}
{  Datum .tijd  Revisie                                   }
{  930914.2200  Creatie.                                  }
{  930915.2200  Support for Settextbuffer. Bufptr used    }
{               again for addressing &amp; pointer advancing  }
{               adjusted.                                 }
{---------------------------------------------------------}
{  Usage : Convert textfile to obj with turbo's BINOBJ    }
{          Add them to a unit as show in this sample      }
{          Create a custom filename to func address       }
{          converter as show in My_getp. This function    }
{          should return NIL if the requested file isn't  }
{          linked in. Use Obj_assign to get assign the    }
{          filevar. Reset, Read, Readln &amp; Close are       }
{          allowed. If a file isn't found it's searched on}
{          disk. Pathnames are stripped when searching for}
{          linked-in files.                               }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Unit </b></font>Obj_01<font color="#000080">;

</font><font color="#FF0000"><b>INTERFACE

Type
  </b></font>Obj_find <font color="#000080">= </font><font color="#FF0000"><b>Function</b></font><font color="#000080">(</font>fn <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>Var
  </b></font>Obj_getp <font color="#000080">: </font>Obj_find<font color="#000080">;

</font><font color="#FF0000"><b>Procedure </b></font>Obj_Assign<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>tpl <font color="#000080">: </font>Text<font color="#000080">;</font>fn <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;</font>decoder <font color="#000080">: </font>Obj_find<font color="#000080">);

</font><font color="#FF0000"><b>IMPLEMENTATION

Uses
  </b></font>Dos<font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------------}
{----To simplyfy addressing inside the buffer, the segment}
{    of the pointer to the text in memmory is incremented }
{    instead of using the old Longint typecast trick      }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Const
  </b></font>para <font color="#000080">= </font><font color="#800000">16</font><font color="#000080">;

</font><font color="#FF0000"><b>Type
  </b></font>obj_user    <font color="#000080">= </font><font color="#FF0000"><b>Record
                  </b></font>base<font color="#000080">,
                  </font>curr    <font color="#000080">: </font>Pointer<font color="#000080">;
                  </font>dummy   <font color="#000080">: </font><font color="#FF0000"><b>ARRAY</b></font><font color="#000080">[</font><font color="#800000">1</font><font color="#000080">..</font><font color="#800000">8</font><font color="#000080">] </font><font color="#FF0000"><b>OF </b></font>Byte<font color="#000080">;
                </font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------------}
{----Ignore    handler                                    }
{---------------------------------------------------------}
{$F+}
</i></font><font color="#FF0000"><b>Function </b></font>Obj_ignore<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>f <font color="#000080">: </font>textrec<font color="#000080">) : </font>Integer<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Obj_ignore<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of Obj_ignore}
{$F-}

{---------------------------------------------------------}
{----Inoutfunc handler                                    }
{---------------------------------------------------------}
{$F+}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>Obj_input<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>f <font color="#000080">: </font>textrec<font color="#000080">) : </font>INTEGER<font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>p <font color="#000080">: </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  WITH </b></font>Textrec<font color="#000080">(</font>f<font color="#000080">) </font><font color="#FF0000"><b>DO
    BEGIN
    </b></font><font color="#008000"><i>{----Advance Pointer obj_size paragraphs}
      </i></font>p<font color="#000080">:=</font>Ptr<font color="#000080">(</font>Seg<font color="#000080">(</font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>curr<font color="#000080">^)+(</font>bufsize <font color="#FF0000"><b>DIV </b></font>para<font color="#000080">),
             </font>Ofs<font color="#000080">(</font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>curr<font color="#000080">^));
      </font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>curr<font color="#000080">:=</font>p<font color="#000080">;
      </font>Move<font color="#000080">(</font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>curr<font color="#000080">^,</font>bufptr<font color="#000080">^,(</font>bufsize <font color="#FF0000"><b>DIV </b></font>para<font color="#000080">)*</font>para<font color="#000080">);
      </font>bufpos   <font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font>bufend   <font color="#000080">:=(</font>bufsize <font color="#FF0000"><b>DIV </b></font>para<font color="#000080">)*</font>para<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>obj_input<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{of obj_input}
{$F-}
{---------------------------------------------------------}
{----Open func handler                                    }
{---------------------------------------------------------}
{$F+}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>obj_open<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>f <font color="#000080">: </font>textrec<font color="#000080">) : </font>INTEGER<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN
  WITH </b></font>Textrec<font color="#000080">(</font>f<font color="#000080">) </font><font color="#FF0000"><b>DO
    BEGIN
      </b></font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>curr<font color="#000080">:=</font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>base<font color="#000080">;
      </font>Move<font color="#000080">(</font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>base<font color="#000080">^,</font>bufptr<font color="#000080">^,(</font>bufsize <font color="#FF0000"><b>DIV </b></font>para<font color="#000080">)*</font>para<font color="#000080">);
      </font>bufpos   <font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
      </font>bufend   <font color="#000080">:=(</font>bufsize <font color="#FF0000"><b>DIV </b></font>para<font color="#000080">)*</font>para<font color="#000080">;
    </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
  </font>obj_open<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{of obj_open}
{$F-}
{---------------------------------------------------------}
{----Assign a link-in file or disk file                   }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>Obj_Assign<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>tpl <font color="#000080">: </font>Text<font color="#000080">;</font>fn <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;</font>decoder <font color="#000080">: </font>Obj_find<font color="#000080">);

</font><font color="#FF0000"><b>VAR
  </b></font>tplp    <font color="#000080">: </font>POINTER<font color="#000080">;
  </font>i       <font color="#000080">: </font>Byte<font color="#000080">;

</font><font color="#FF0000"><b>BEGIN

  If </b></font><font color="#000080">(</font>Addr<font color="#000080">(</font>decoder<font color="#000080">)=</font><font color="#FF0000"><b>NIL</b></font><font color="#000080">)
    </font><font color="#FF0000"><b>THEN </b></font>tplp<font color="#000080">:=</font><font color="#FF0000"><b>NIL
    ELSE </b></font>tplp<font color="#000080">:=</font>Decoder<font color="#000080">(</font>fn<font color="#000080">);

  </font><font color="#FF0000"><b>IF </b></font><font color="#000080">(</font>tplp<font color="#000080">&lt;&gt;</font><font color="#FF0000"><b>NIL</b></font><font color="#000080">)
    </font><font color="#FF0000"><b>THEN
      WITH </b></font>Textrec<font color="#000080">(</font>tpl<font color="#000080">) </font><font color="#FF0000"><b>DO
        BEGIN
          </b></font>handle   <font color="#000080">:=</font><font color="#800000">$ffff</font><font color="#000080">;
          </font>mode     <font color="#000080">:=</font>fmclosed<font color="#000080">; </font><font color="#008000"><i>{fminput}
          </i></font>bufsize  <font color="#000080">:=</font>SIZEOF<font color="#000080">(</font>textbuf<font color="#000080">);
          </font>bufpos   <font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
          </font>bufptr   <font color="#000080">:=@</font>buffer<font color="#000080">;

          </font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>base<font color="#000080">:=</font>tplp<font color="#000080">;
          </font>obj_user<font color="#000080">(</font>userdata<font color="#000080">).</font>curr<font color="#000080">:=</font>tplp<font color="#000080">;

          </font>openfunc <font color="#000080">:=@</font>obj_open<font color="#000080">;
          </font>inoutfunc<font color="#000080">:=@</font>obj_input<font color="#000080">;
          </font>flushfunc<font color="#000080">:=@</font>obj_ignore<font color="#000080">;
          </font>closefunc<font color="#000080">:=@</font>obj_ignore<font color="#000080">;

          </font>i<font color="#000080">:=</font><font color="#800000">0</font><font color="#000080">;
          </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>i<font color="#000080">&lt;</font>Length<font color="#000080">(</font>fn<font color="#000080">)) </font><font color="#FF0000"><b>AND </b></font><font color="#000080">(</font>i<font color="#000080">&lt;</font>Sizeof<font color="#000080">(</font>name<font color="#000080">)) </font><font color="#FF0000"><b>DO
            Begin
              </b></font>name<font color="#000080">[</font>i<font color="#000080">]:=</font>Upcase<font color="#000080">(</font>fn<font color="#000080">[</font>i<font color="#000080">+</font><font color="#800000">1</font><font color="#000080">]);
              </font>Inc<font color="#000080">(</font>i<font color="#000080">);
            </font><font color="#FF0000"><b>End</b></font><font color="#000080">;
          </font>name<font color="#000080">[</font>i<font color="#000080">]  :=</font><font color="#800000">#00</font><font color="#000080">;
        </font><font color="#FF0000"><b>END
      ELSE </b></font>Assign<font color="#000080">(</font>tpl<font color="#000080">,</font>Fexpand<font color="#000080">(</font>fn<font color="#000080">));
</font><font color="#FF0000"><b>END</b></font><font color="#000080">; </font><font color="#008000"><i>{of obj_open}

</i></font><font color="#FF0000"><b>END</b></font><font color="#000080">.


---------------&lt;</font>source part II<font color="#000080">, </font><font color="#FF0000"><b>to </b></font>link <font color="#FF0000"><b>in </b></font>your text files<font color="#000080">.

</font><font color="#008000"><i>{---------------------------------------------------------}
{  Project : Object linked textfiles                      }
{  Unit    : Sample program                               }
{  By      : Ir.G.W. van der Vegt                         }
{---------------------------------------------------------}
{  Datum .tijd  Revisie                                   }
{  930914.2200  Creatie.                                  }
{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Unit </b></font>Objtext<font color="#000080">;

</font><font color="#FF0000"><b>Interface

Procedure </b></font>Assign_text<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>tpl <font color="#000080">: </font>Text<font color="#000080">;</font>fn <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);

</font><font color="#FF0000"><b>Implementation

</b></font><font color="#008000"><i>{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Uses
  </b></font>Dos<font color="#000080">,
  </font>Obj_01<font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------------}
{----SAMPLE Get_obj Function}
{$L SAMPLE_d.obj}
{$L SAMPLE_m.obj}

{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>FUNCTION </b></font>SAMPLE_D  <font color="#000080">: </font>Byte <font color="#000080">; </font><font color="#FF0000"><b>External</b></font><font color="#000080">;
</font><font color="#FF0000"><b>FUNCTION </b></font>SAMPLE_M  <font color="#000080">: </font>Byte <font color="#000080">; </font><font color="#FF0000"><b>External</b></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------------}
{$F+}
</i></font><font color="#FF0000"><b>FUNCTION </b></font>My_getp<font color="#000080">(</font>fn <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">) : </font>Pointer<font color="#000080">;

</font><font color="#FF0000"><b>VAR
  </b></font>name <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">[</font><font color="#800000">12</font><font color="#000080">];
  </font>d    <font color="#000080">: </font>dirstr<font color="#000080">;
  </font>n    <font color="#000080">: </font>namestr<font color="#000080">;
  </font>e    <font color="#000080">: </font>extstr<font color="#000080">;

</font><font color="#FF0000"><b>Begin
  </b></font>Fsplit<font color="#000080">(</font>Fexpand<font color="#000080">(</font>fn<font color="#000080">),</font>d<font color="#000080">,</font>n<font color="#000080">,</font>e<font color="#000080">);

  </font>My_getp<font color="#000080">:=</font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;

  </font>name<font color="#000080">:=</font>Strip<font color="#000080">(</font>Upcasestr<font color="#000080">(</font>n<font color="#000080">+</font>e<font color="#000080">),</font>true<font color="#000080">,</font>true<font color="#000080">);

          </font><font color="#008000"><i>{12345678.123}
  </i></font><font color="#FF0000"><b>IF </b></font>name<font color="#000080">=  </font><font color="#800000">'SAMPLE.D' </font><font color="#FF0000"><b>THEN </b></font>My_getp<font color="#000080">:=  @</font>Sample_d<font color="#000080">;
  </font><font color="#FF0000"><b>IF </b></font>name<font color="#000080">=  </font><font color="#800000">'SAMPLE.M' </font><font color="#FF0000"><b>THEN </b></font>My_getp<font color="#000080">:=  @</font>Sample_m<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">; </font><font color="#008000"><i>{of My_getp}

{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Procedure </b></font>Assign_text<font color="#000080">(</font><font color="#FF0000"><b>VAR </b></font>tpl <font color="#000080">: </font>Text<font color="#000080">;</font>fn <font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">);

</font><font color="#FF0000"><b>Begin
  </b></font>Obj_assign<font color="#000080">(</font>tpl<font color="#000080">,</font>fn<font color="#000080">,</font>Obj_find<font color="#000080">(</font>Assign_decoder<font color="#000080">));
</font><font color="#FF0000"><b>End</b></font><font color="#000080">;

</font><font color="#008000"><i>{---------------------------------------------------------}


{---------------------------------------------------------}

</i></font><font color="#FF0000"><b>Begin
  </b></font>Assign_decoder<font color="#000080">:=@</font>My_getp<font color="#000080">;
</font><font color="#FF0000"><b>End</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0037.PAS">Original</a><b>]</b></p></body>
</html>
