<html>
<head><title> "Faster READLN" by JOSE CAMPIONE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
  I have been exploring a faster way to read lines from text
   files. This one seems to be 30% faster than readln even with
   a full settextbuffer of $FFFF. However, it only works for
   files smaller than 64K ($FFF1) and all lines, including the
   last one, must end in the CR/LF word (readln recognizes the
   EOF (01Ah) char also as an end of line). Please repost any
   improvements. }

   </i></font><font color="#FF0000"><b>program </b></font>readtext<font color="#000080">;

   </font><font color="#FF0000"><b>Uses </b></font>CRT<font color="#000080">;

   </font><font color="#FF0000"><b>const 
     </b></font>maxsize <font color="#000080">= </font><font color="#800000">$FFF0</font><font color="#000080">;
   
   </font><font color="#FF0000"><b>type
     </b></font>barr    <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font>maxsize<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
     </font>ptrbarr <font color="#000080">= ^</font>barr<font color="#000080">;

   </font><font color="#FF0000"><b>var
     </b></font>f <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
     </font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
     </font>p <font color="#000080">: </font>longint<font color="#000080">;
     </font>fsiz <font color="#000080">: </font>longint<font color="#000080">;
     </font>fbuf <font color="#000080">: </font>ptrbarr<font color="#000080">;
   
   </font><font color="#FF0000"><b>function </b></font>pos13<font color="#000080">(</font>pnt<font color="#000080">:</font>pointer<font color="#000080">): </font>word<font color="#000080">; </font><font color="#FF0000"><b>assembler</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>asm
     </b></font><font color="#FF00FF">les di,[pnt]              </font><font color="#008000"><i>{load pointer in es:di}
     </i></font><font color="#FF00FF">mov cx,$00FF              </font><font color="#008000"><i>{load maximum size to scan in cx}
     </i></font><font color="#FF00FF">mov bx,cx                 </font><font color="#008000"><i>{save maximum size to scan in bx}
     </i></font><font color="#FF00FF">mov al,$0D                </font><font color="#008000"><i>{load in al byte to match = 0Dh}
     </i></font><font color="#FF00FF">cld                       </font><font color="#008000"><i>{increment di}
     </i></font><font color="#FF00FF">repne scasb               </font><font color="#008000"><i>{search loop}
     </i></font><font color="#FF00FF">je  @found                </font><font color="#008000"><i>{jump if found}
     </i></font><font color="#FF00FF">mov ax,0                  </font><font color="#008000"><i>{if not found report result = 0}
     </i></font><font color="#FF00FF">jmp @fin                  </font><font color="#008000"><i>{goto end}
     </i></font><font color="#FF00FF">@found:                   </font><font color="#008000"><i>{if found...}
     </i></font><font color="#FF00FF">sub bx,cx                 </font><font color="#008000"><i>{get position matched}
     </i></font><font color="#FF00FF">mov ax,bx                 </font><font color="#008000"><i>{report result = position matched}
     </i></font><font color="#FF00FF">@fin:
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   
   </font><font color="#FF0000"><b>procedure </b></font>readx<font color="#000080">(</font>fbuf<font color="#000080">:</font>ptrbarr<font color="#000080">;</font><font color="#FF0000"><b>var </b></font>s<font color="#000080">:</font><font color="#FF0000"><b>string</b></font><font color="#000080">;</font><font color="#FF0000"><b>var </b></font>p<font color="#000080">:</font>longint<font color="#000080">);
   </font><font color="#FF0000"><b>var
     </b></font>q <font color="#000080">: </font>word<font color="#000080">;
     </font>b <font color="#000080">: </font>ptrbarr<font color="#000080">;
   </font><font color="#FF0000"><b>begin
     </b></font>b<font color="#000080">:= </font>addr<font color="#000080">(</font>fbuf<font color="#000080">^[</font>p<font color="#000080">]);       </font><font color="#008000"><i>{point to first byte in remaining block}
     </i></font>q<font color="#000080">:= </font>pos13<font color="#000080">(</font>b<font color="#000080">);             </font><font color="#008000"><i>{get position of first $0D occurence}
     </i></font>move<font color="#000080">(</font>b<font color="#000080">^,</font>s<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">],</font>pred<font color="#000080">(</font>q<font color="#000080">));    </font><font color="#008000"><i>{transfer preceeding bytes to string}
     </i></font>s<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">]:= </font>char<font color="#000080">(</font>pred<font color="#000080">(</font>q<font color="#000080">));     </font><font color="#008000"><i>{assign size byte to Pascal string}
     </i></font>inc<font color="#000080">(</font>p<font color="#000080">,</font>succ<font color="#000080">(</font>q<font color="#000080">));           </font><font color="#008000"><i>{adjust pointer skipping 1 byte ($0A)}
   </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font><font color="#FF0000"><b>begin
     </b></font>ClrScr<font color="#000080">;
     </font><font color="#FF0000"><b>if </b></font>paramcount <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        BEGIN
        </b></font>writeLn<font color="#000080">( </font><font color="#800000">'Enter FILENAME on commandline'</font><font color="#000080">);
        </font>halt<font color="#000080">;
        </font><font color="#FF0000"><b>END</b></font><font color="#000080">;
     </font>assign<font color="#000080">(</font>f<font color="#000080">,</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">));
     </font>reset<font color="#000080">(</font>f<font color="#000080">,</font><font color="#800000">1</font><font color="#000080">);
     </font>fsiz<font color="#000080">:= </font>filesize<font color="#000080">(</font>f<font color="#000080">);
     </font><font color="#FF0000"><b>if </b></font>fsiz <font color="#000080">&gt; </font>maxsize <font color="#FF0000"><b>then </b></font>halt<font color="#000080">;
     </font>getmem<font color="#000080">(</font>fbuf<font color="#000080">,</font>fsiz<font color="#000080">);
     </font>blockread<font color="#000080">(</font>f<font color="#000080">,</font>fbuf<font color="#000080">^,</font>fsiz<font color="#000080">);
     </font>close<font color="#000080">(</font>f<font color="#000080">);
     </font>p <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;                   </font><font color="#008000"><i>{initialize pointer to position in fbuf^}
     </i></font><font color="#FF0000"><b>while </b></font>p <font color="#000080">&lt; </font>fsiz <font color="#FF0000"><b>do begin
       </b></font>readx<font color="#000080">(</font>fbuf<font color="#000080">,</font>s<font color="#000080">,</font>p<font color="#000080">);
       </font>writeln<font color="#000080">(</font>s<font color="#000080">);
     </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
     </font>dispose<font color="#000080">(</font>fbuf<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0036.PAS">Original</a><b>]</b></p></body>
</html>
