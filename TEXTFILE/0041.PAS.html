<html>
<head><title> "Binary Text File Access" by TODD FISKE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0041.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>{
From: tfiske@delphi.com (Todd Fiske)

I've got a huge unit that I've put together over the years that does this,
but I'm not really ready to part with it. I'm happy to trade some tips
though.

The easiest way to start is with text files under 64K, for which you don't
have to worry about lines crossing the buffer boundary. Get the size of the
file, then allocate an array on the heap of that size and blockread the file
into it. Then use a function that reads from the current position up to the
next CR and/or LF and returns all of that as a string. Here's a simple
example of this:

{------------------------------------------------}
{- bintext.pas - binary text file example       -}
{- Todd Fiske (tfiske@delphi.com) - 09/28/1994  -}
{------------------------------------------------}
</i></font><font color="#FF0000"><b>program </b></font>bintext<font color="#000080">;

</font><font color="#FF0000"><b>uses
   </b></font>dos<font color="#000080">;

</font><font color="#FF0000"><b>const
   </b></font>CR <font color="#000080">= </font><font color="#800000">#13</font><font color="#000080">;
   </font>LF <font color="#000080">= </font><font color="#800000">#10</font><font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------}
{- input structure definition &amp; base routines   -}
{------------------------------------------------}
</i></font><font color="#FF0000"><b>type
   </b></font>big_array <font color="#000080">= </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">65519</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>byte<font color="#000080">;
   </font>big_ptr <font color="#000080">= ^</font>big_array<font color="#000080">;
   </font>input_buffer <font color="#000080">= </font><font color="#FF0000"><b>record
      </b></font>data <font color="#000080">: </font>big_ptr<font color="#000080">;
      </font>size <font color="#000080">: </font>word<font color="#000080">;
      </font>curr <font color="#000080">: </font>word<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font>input_ptr <font color="#000080">= ^</font>input_buffer<font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>start_input<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>i <font color="#000080">: </font>input_ptr<font color="#000080">; </font>size <font color="#000080">: </font>word<font color="#000080">);
</font><font color="#FF0000"><b>begin
   if </b></font>i <font color="#000080">= </font><font color="#FF0000"><b>nil then begin
      </b></font>new<font color="#000080">(</font>i<font color="#000080">);                          </font><font color="#008000"><i>{ create structure }
      </i></font>i<font color="#000080">^.</font>size <font color="#000080">:= </font>size<font color="#000080">;
      </font>GetMem<font color="#000080">(</font>i<font color="#000080">^.</font>data<font color="#000080">, </font>i<font color="#000080">^.</font>size<font color="#000080">);        </font><font color="#008000"><i>{ create array (could test MemAvail) }
      </i></font>fillchar<font color="#000080">(</font>i<font color="#000080">^.</font>data<font color="#000080">^, </font>i<font color="#000080">^.</font>size<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">);  </font><font color="#008000"><i>{ initialize }
      </i></font>i<font color="#000080">^.</font>curr <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>stop_input<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>i <font color="#000080">: </font>input_ptr<font color="#000080">);
</font><font color="#FF0000"><b>begin
   if </b></font>i <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then begin
      </b></font>FreeMem<font color="#000080">(</font>i<font color="#000080">^.</font>data<font color="#000080">, </font>i<font color="#000080">^.</font>size<font color="#000080">);       </font><font color="#008000"><i>{ done with array }
      </i></font>dispose<font color="#000080">(</font>i<font color="#000080">);                      </font><font color="#008000"><i>{ done with structure }
      </i></font>i <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>load_input<font color="#000080">(</font>i <font color="#000080">: </font>input_ptr<font color="#000080">; </font>s <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">);
</font><font color="#FF0000"><b>var
   </b></font>f <font color="#000080">: </font><font color="#FF0000"><b>file</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>assign<font color="#000080">(</font>f<font color="#000080">, </font>s<font color="#000080">);                       </font><font color="#008000"><i>{ set filename }
   </i></font>reset<font color="#000080">(</font>f<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">);                        </font><font color="#008000"><i>{ open with record length 1 }
   </i></font>blockread<font color="#000080">(</font>f<font color="#000080">, </font>i<font color="#000080">^.</font>data<font color="#000080">^, </font>i<font color="#000080">^.</font>size<font color="#000080">);    </font><font color="#008000"><i>{ read in file - should test IOResult }
   </i></font>close<font color="#000080">(</font>f<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------}
{- low level access routines                    -}
{------------------------------------------------}
</i></font><font color="#FF0000"><b>function </b></font>curr_char<font color="#000080">(</font>i <font color="#000080">: </font>input_ptr<font color="#000080">) : </font>char<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>curr_char <font color="#000080">:= </font>char<font color="#000080">(</font>i<font color="#000080">^.</font>data<font color="#000080">^[</font>i<font color="#000080">^.</font>curr<font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>procedure </b></font>next_char<font color="#000080">(</font>i <font color="#000080">: </font>input_ptr<font color="#000080">);
</font><font color="#FF0000"><b>begin
   </b></font>inc<font color="#000080">(</font>i<font color="#000080">^.</font>curr<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>curr_pos<font color="#000080">(</font>i <font color="#000080">: </font>input_ptr<font color="#000080">) : </font>word<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>curr_pos <font color="#000080">:= </font>i<font color="#000080">^.</font>curr<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>end_of_input<font color="#000080">(</font>i <font color="#000080">: </font>input_ptr<font color="#000080">) : </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>end_of_input <font color="#000080">:= </font>i<font color="#000080">^.</font>curr <font color="#000080">&gt;= </font>i<font color="#000080">^.</font>size<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------}
{- medium level access                          -}
{------------------------------------------------}
</i></font><font color="#FF0000"><b>function </b></font>get_line<font color="#000080">(</font>i <font color="#000080">: </font>input_ptr<font color="#000080">) : </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
   </b></font>w   <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;
   </font>stt <font color="#000080">: </font>word<font color="#000080">;
   </font>len <font color="#000080">: </font>byte<font color="#000080">;
</font><font color="#FF0000"><b>begin
   </b></font>stt <font color="#000080">:= </font>curr_pos<font color="#000080">(</font>i<font color="#000080">);
   </font><font color="#FF0000"><b>while </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font><font color="#000080">(</font>curr_char<font color="#000080">(</font>i<font color="#000080">) </font><font color="#FF0000"><b>in </b></font><font color="#000080">[</font>CR<font color="#000080">, </font>LF<font color="#000080">])) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>end_of_input<font color="#000080">(</font>i<font color="#000080">)) </font><font color="#FF0000"><b>do
      </b></font>next_char<font color="#000080">(</font>i<font color="#000080">);
   </font><font color="#008000"><i>{- testing for both CR and LF here allows reading of Unix files -}

   </i></font>len <font color="#000080">:= </font>curr_pos<font color="#000080">(</font>i<font color="#000080">) - </font>stt<font color="#000080">;           </font><font color="#008000"><i>{ determine length read }
   </i></font>move<font color="#000080">(</font>i<font color="#000080">^.</font>data<font color="#000080">^[</font>stt<font color="#000080">], </font>w<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">], </font>len<font color="#000080">);     </font><font color="#008000"><i>{ copy into work string }
   </i></font>w<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>char<font color="#000080">(</font>len<font color="#000080">);                  </font><font color="#008000"><i>{ set work string length }

   </i></font><font color="#FF0000"><b>if </b></font>curr_char<font color="#000080">(</font>i<font color="#000080">) = </font>CR <font color="#FF0000"><b>then </b></font>next_char<font color="#000080">(</font>i<font color="#000080">);  </font><font color="#008000"><i>{ skip line-end chars }
   </i></font><font color="#FF0000"><b>if </b></font>curr_char<font color="#000080">(</font>i<font color="#000080">) = </font>LF <font color="#FF0000"><b>then </b></font>next_char<font color="#000080">(</font>i<font color="#000080">);

   </font>get_line <font color="#000080">:= </font>w<font color="#000080">;                      </font><font color="#008000"><i>{ return work string }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{------------------------------------------------}
{- main program                                 -}
{------------------------------------------------}
</i></font><font color="#FF0000"><b>var
   </b></font>sr   <font color="#000080">: </font>SearchRec<font color="#000080">;
   </font>i    <font color="#000080">: </font>input_ptr<font color="#000080">;
   </font>line <font color="#000080">: </font><font color="#FF0000"><b>string</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
   </b></font>writeln<font color="#000080">;
   </font>writeln<font color="#000080">(</font><font color="#800000">'BinText - binary textfile example'</font><font color="#000080">);

   </font><font color="#FF0000"><b>if </b></font>paramcount <font color="#000080">= </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin        </b></font><font color="#008000"><i>{ check command line }
      </i></font>writeln<font color="#000080">;
      </font>writeln<font color="#000080">(</font><font color="#800000">'usage: bintext &lt;filename&gt;'</font><font color="#000080">);
      </font>halt<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>FindFirst<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">), </font>AnyFile<font color="#000080">, </font>sr<font color="#000080">); </font><font color="#008000"><i>{ test input file }
   </i></font><font color="#FF0000"><b>if </b></font>DOSError <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then begin
      </b></font>writeln<font color="#000080">(</font>paramstr<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">), </font><font color="#800000">' not found'</font><font color="#000080">);
      </font>halt<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
   </font><font color="#FF0000"><b>if </b></font>sr<font color="#000080">.</font>size <font color="#000080">&gt; </font><font color="#800000">65520 </font><font color="#FF0000"><b>then begin
      </b></font>writeln<font color="#000080">(</font>sr<font color="#000080">.</font>name<font color="#000080">, </font><font color="#800000">' : '</font><font color="#000080">, </font>sr<font color="#000080">.</font>size<font color="#000080">, </font><font color="#800000">' bytes - too big (65520 bytes max)'</font><font color="#000080">);
      </font>halt<font color="#000080">;
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>i <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;                           </font><font color="#008000"><i>{ load, read, and close }
   </i></font>start_input<font color="#000080">(</font>i<font color="#000080">, </font>sr<font color="#000080">.</font>size<font color="#000080">);
   </font>load_input<font color="#000080">(</font>i<font color="#000080">, </font>sr<font color="#000080">.</font>name<font color="#000080">);

   </font><font color="#FF0000"><b>while not </b></font>end_of_input<font color="#000080">(</font>i<font color="#000080">) </font><font color="#FF0000"><b>do begin
      </b></font>line <font color="#000080">:= </font>get_line<font color="#000080">(</font>i<font color="#000080">);
      </font>writeln<font color="#000080">(</font>line<font color="#000080">);
   </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

   </font>stop_input<font color="#000080">(</font>i<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font><font color="#008000"><i>{------------------------------------------------}
{- eof                                          -}
{------------------------------------------------}

{
This array-of-char file handling can be very flexible. I've included routines
in my own to do things like skip whitespace, skip while in a particular groups
of characters, skip until in a group of characters, get-while and get-until
routines, etc. Another thing you can do is save the byte start position of each
line, and jump right to that line by setting i^.curr. What's more, the same
basic methods work on binary files as well.
}
</i></font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to TEXTFILE SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0041.PAS">Original</a><b>]</b></p></body>
</html>
